{% extends "base.html" %}

{% block title %}Detalhes do Veículo - {{ veiculo.placa }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-car me-2"></i>Detalhes do Veículo</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.veiculos') }}">Veículos</a></li>
                    <li class="breadcrumb-item active">{{ veiculo.placa }}</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('main.veiculos') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>

    <!-- Informações do Veículo -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Informações do Veículo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Placa:</strong> {{ veiculo.placa }}</p>
                            <p><strong>Marca:</strong> {{ veiculo.marca }}</p>
                            <p><strong>Modelo:</strong> {{ veiculo.modelo }}</p>
                            <p><strong>Ano:</strong> {{ veiculo.ano or '-' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Tipo:</strong> {{ veiculo.tipo }}</p>
                            <p><strong>Status:</strong> 
                                {% if veiculo.status == 'Disponível' %}
                                    <span class="badge bg-success">{{ veiculo.status }}</span>
                                {% elif veiculo.status == 'Em uso' %}
                                    <span class="badge bg-warning">{{ veiculo.status }}</span>
                                {% elif veiculo.status == 'Manutenção' %}
                                    <span class="badge bg-info">{{ veiculo.status }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ veiculo.status }}</span>
                                {% endif %}
                            </p>
                            {% if veiculo.data_proxima_manutencao %}
                            <p><strong>Próx. Manutenção:</strong> {{ veiculo.data_proxima_manutencao.strftime('%d/%m/%Y') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPIs -->
        <div class="col-md-4">
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-0">{{ kpis.total_usos }}</h3>
                            <p class="mb-0">Total de Usos</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h3 class="mb-0">R$ {{ '{:,.2f}'.format(kpis.custo_total) }}</h3>
                            <p class="mb-0">Custo Total</p>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-0">{{ kpis.total_custos }}</h3>
                            <p class="mb-0">Registros de Custo</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs para Uso e Custo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="veiculoTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="uso-tab" data-bs-toggle="tab" data-bs-target="#uso" type="button" role="tab">
                                <i class="fas fa-road me-2"></i>Registros de Uso
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="custo-tab" data-bs-toggle="tab" data-bs-target="#custo" type="button" role="tab">
                                <i class="fas fa-dollar-sign me-2"></i>Registros de Custo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="grafico-tab" data-bs-toggle="tab" data-bs-target="#grafico" type="button" role="tab">
                                <i class="fas fa-chart-pie me-2"></i>Análise de Uso
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="veiculoTabsContent">
                        <!-- Tab de Uso -->
                        <div class="tab-pane fade show active" id="uso" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Histórico de Uso do Veículo</h6>
                                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#novoUsoModal">
                                    <i class="fas fa-plus me-2"></i>Novo Uso
                                </button>
                            </div>
                            
                            {% if usos %}
                            <div class="table-responsive">
                                <table class="table table-striped" id="usoTable">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Funcionário</th>
                                            <th>Obra</th>
                                            <th>KM Inicial</th>
                                            <th>KM Final</th>
                                            <th>Horários</th>
                                            <th>Finalidade</th>
                                            <th>Observações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for uso in usos %}
                                        <tr>
                                            <td>{{ uso.data_uso.strftime('%d/%m/%Y') }}</td>
                                            <td>{{ uso.funcionario.nome if uso.funcionario else '-' }}</td>
                                            <td>{{ uso.obra.nome if uso.obra else '-' }}</td>
                                            <td>{{ uso.km_inicial or '-' }}</td>
                                            <td>{{ uso.km_final or '-' }}</td>
                                            <td>
                                                {% if uso.horario_saida and uso.horario_chegada %}
                                                    {{ uso.horario_saida.strftime('%H:%M') }} - {{ uso.horario_chegada.strftime('%H:%M') }}
                                                {% elif uso.horario_saida %}
                                                    Saída: {{ uso.horario_saida.strftime('%H:%M') }}
                                                {% elif uso.horario_chegada %}
                                                    Chegada: {{ uso.horario_chegada.strftime('%H:%M') }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>{{ uso.finalidade or '-' }}</td>
                                            <td>{{ uso.observacoes or '-' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-road fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Nenhum registro de uso encontrado</p>
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novoUsoModal">
                                    <i class="fas fa-plus me-2"></i>Registrar Primeiro Uso
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Tab de Custo -->
                        <div class="tab-pane fade" id="custo" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Histórico de Custos do Veículo</h6>
                                <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#novoCustoModal">
                                    <i class="fas fa-plus me-2"></i>Novo Custo
                                </button>
                            </div>
                            
                            {% if custos %}
                            <div class="table-responsive">
                                <table class="table table-striped" id="custoTable">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Valor</th>
                                            <th>Tipo</th>
                                            <th>Obra</th>
                                            <th>Fornecedor</th>
                                            <th>Descrição</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for custo in custos %}
                                        <tr>
                                            <td>{{ custo.data_custo.strftime('%d/%m/%Y') }}</td>
                                            <td>R$ {{ '{:,.2f}'.format(custo.valor) }}</td>
                                            <td>{{ custo.tipo_custo.title() }}</td>
                                            <td>{{ custo.obra.nome if custo.obra else '-' }}</td>
                                            <td>{{ custo.fornecedor or '-' }}</td>
                                            <td>{{ custo.descricao or '-' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-dollar-sign fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Nenhum registro de custo encontrado</p>
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#novoCustoModal">
                                    <i class="fas fa-plus me-2"></i>Registrar Primeiro Custo
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Tab de Gráficos -->
                        <div class="tab-pane fade" id="grafico" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-pie me-2"></i>Distribuição de Uso por Obra
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if grafico_uso_obras.total > 0 %}
                                                <div class="text-center">
                                                    <canvas id="usoObraChart" width="400" height="400"></canvas>
                                                </div>
                                                <div class="mt-3">
                                                    <p class="text-muted text-center mb-0">
                                                        <small>Total de {{ grafico_uso_obras.total }} uso(s) registrado(s)</small>
                                                    </p>
                                                </div>
                                            {% else %}
                                                <div class="text-center py-4">
                                                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                                                    <p class="text-muted">Nenhum uso registrado para gerar gráficos</p>
                                                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novoUsoModal">
                                                        <i class="fas fa-plus me-2"></i>Registrar Primeiro Uso
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-info-circle me-2"></i>Estatísticas de Uso
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if grafico_uso_obras.total > 0 %}
                                                <div class="row">
                                                    {% for i in range(grafico_uso_obras.labels|length) %}
                                                    <div class="col-12 mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold">{{ grafico_uso_obras.labels[i] }}:</span>
                                                            <span class="badge bg-primary">{{ grafico_uso_obras.data[i] }} uso(s)</span>
                                                        </div>
                                                        <div class="progress" style="height: 6px;">
                                                            <div class="progress-bar" role="progressbar" 
                                                                 style="width: {{ (grafico_uso_obras.data[i] / grafico_uso_obras.total * 100)|round(1) }}%"></div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <p class="text-muted text-center">Registre usos para ver estatísticas detalhadas</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Uso -->
<div class="modal fade" id="novoUsoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-road"></i> 
                    Novo Uso - {{ veiculo.placa }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.novo_uso_veiculo_direto') }}">
                <input type="hidden" name="veiculo_id" value="{{ veiculo.id }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="funcionario_id" class="form-label">Funcionário *</label>
                                <select class="form-select" name="funcionario_id" required>
                                    <option value="">Selecione...</option>
                                    {% for funcionario in funcionarios %}
                                    <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="obra_id" class="form-label">Obra *</label>
                                <select class="form-select" name="obra_id" required>
                                    <option value="">Selecione...</option>
                                    {% for obra in obras %}
                                    <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_uso" class="form-label">Data de Uso *</label>
                                <input type="date" class="form-control" name="data_uso" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="finalidade" class="form-label">Finalidade</label>
                                <input type="text" class="form-control" name="finalidade" 
                                       placeholder="Ex: Transporte para obra X">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="km_inicial" class="form-label">KM Inicial</label>
                                <input type="number" class="form-control" name="km_inicial" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="km_final" class="form-label">KM Final</label>
                                <input type="number" class="form-control" name="km_final" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horario_saida" class="form-label">Horário de Saída</label>
                                <input type="time" class="form-control" name="horario_saida">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horario_chegada" class="form-label">Horário de Chegada</label>
                                <input type="time" class="form-control" name="horario_chegada">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Registrar Uso</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Novo Custo -->
<div class="modal fade" id="novoCustoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-dollar-sign"></i> 
                    Novo Custo - {{ veiculo.placa }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.novo_custo_veiculo') }}">
                <input type="hidden" name="veiculo_id" value="{{ veiculo.id }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_custo" class="form-label">Data *</label>
                                <input type="date" class="form-control" name="data_custo" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="valor" class="form-label">Valor (R$) *</label>
                                <input type="number" class="form-control" name="valor" 
                                       step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_custo" class="form-label">Tipo de Custo *</label>
                                <select class="form-select" name="tipo_custo" required>
                                    <option value="">Selecione...</option>
                                    <option value="combustivel">Combustível</option>
                                    <option value="manutencao">Manutenção</option>
                                    <option value="seguro">Seguro</option>
                                    <option value="multa">Multa</option>
                                    <option value="lavagem">Lavagem</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="obra_id" class="form-label">Obra *</label>
                                <select class="form-select" name="obra_id" required>
                                    <option value="">Selecione...</option>
                                    {% for obra in obras %}
                                    <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fornecedor" class="form-label">Fornecedor</label>
                        <input type="text" class="form-control" name="fornecedor" 
                               placeholder="Ex: Auto Posto Silva">
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" name="descricao" rows="3" 
                                  placeholder="Detalhes do custo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Registrar Custo</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar DataTables
    if ($('#usoTable tbody tr').length > 0) {
        $('#usoTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
            },
            order: [[0, 'desc']],
            pageLength: 10
        });
    }
    
    if ($('#custoTable tbody tr').length > 0) {
        $('#custoTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
            },
            order: [[0, 'desc']],
            pageLength: 10
        });
    }
    
    // Configurar data padrão para hoje nos modais
    const hoje = new Date().toISOString().split('T')[0];
    $('input[name="data_uso"]').val(hoje);
    $('input[name="data_custo"]').val(hoje);
    
    // Criar gráfico de pizza de uso por obra
    {% if grafico_uso_obras.total > 0 %}
    const ctx = document.getElementById('usoObraChart');
    if (ctx) {
        const usoObraChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: {{ grafico_uso_obras.labels | tojson }},
                datasets: [{
                    data: {{ grafico_uso_obras.data | tojson }},
                    backgroundColor: [
                        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                        '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                    ],
                    borderWidth: 2,
                    borderColor: '#212529'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            color: '#fff'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' uso(s) (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}