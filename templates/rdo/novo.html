{% extends "base_completo.html" %}

{% block title %}Novo RDO - Sistema de Gest√£o Empresarial{% endblock %}

{% block extra_css %}
<style>
/* === ARQUITETURA DE MAESTRIA DIGITAL - RDO SYSTEM === */
.rdo-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.rdo-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.rdo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.rdo-header {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 16px 16px 0 0;
    position: relative;
    overflow: hidden;
}

.rdo-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
    opacity: 0.3;
}

.form-section {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.form-section:last-child {
    border-bottom: none;
}

.form-control, .form-select {
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
}

.form-control:focus, .form-select:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.15);
    transform: translateY(-1px);
}

.btn-primary {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    border: none;
    border-radius: 8px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.3);
    background: linear-gradient(135deg, #20c997 0%, #198754 100%);
}

.btn-outline-secondary {
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    background: #f8f9fa;
    border-color: #198754;
    color: #198754;
    transform: translateY(-1px);
}

.services-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    min-height: 200px;
    border: 2px dashed rgba(25, 135, 84, 0.2);
    transition: all 0.3s ease;
}

.service-card {
    background: white;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.service-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.progress {
    height: 8px;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.progress-bar {
    border-radius: 6px;
    transition: width 0.6s ease;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.alert {
    border: none;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
}

.alert-success {
    background: linear-gradient(135deg, rgba(25, 135, 84, 0.1) 0%, rgba(32, 201, 151, 0.05) 100%);
    color: #198754;
    border-left: 4px solid #198754;
}

.alert-warning {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
    color: #856404;
    border-left: 4px solid #ffc107;
}

.alert-info {
    background: linear-gradient(135deg, rgba(13, 202, 240, 0.1) 0%, rgba(13, 202, 240, 0.05) 100%);
    color: #055160;
    border-left: 4px solid #0dcaf0;
}

/* === RESPONSIVIDADE === */
@media (max-width: 768px) {
    .rdo-container {
        padding: 1rem 0;
    }
    
    .rdo-header {
        padding: 1rem;
    }
    
    .form-section {
        padding: 1rem;
    }
    
    .btn-primary, .btn-outline-secondary {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="rdo-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- === HEADER PRINCIPAL === -->
                <div class="rdo-card mb-4">
                    <div class="rdo-header">
                        <div class="d-flex justify-content-between align-items-center position-relative">
                            <div>
                                <h1 class="mb-1">
                                    <i class="fas fa-clipboard-list me-2"></i>
                                    Relat√≥rio Di√°rio de Obra (RDO)
                                </h1>
                                <p class="mb-0 opacity-75">Sistema moderno e intuitivo para registro de atividades di√°rias</p>
                            </div>
                            <div class="text-end">
                                <a href="{{ url_for('main.rdos') }}" class="btn btn-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Voltar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === FORMUL√ÅRIO PRINCIPAL === -->
                <form id="formNovoRDO" method="POST" class="needs-validation" novalidate>
                    <div class="rdo-card">
                        <!-- === INFORMA√á√ïES B√ÅSICAS === -->
                        <div class="form-section">
                            <h5 class="text-success mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Informa√ß√µes B√°sicas
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="obra_id" class="form-label fw-bold">
                                        <i class="fas fa-building text-primary me-1"></i>
                                        Obra
                                    </label>
                                    <select class="form-select" id="obra_id" name="obra_id" required onchange="carregarDadosObra()">
                                        <option value="">Selecione uma obra...</option>
                                        {% for obra in obras %}
                                            <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione uma obra.
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <label for="data_relatorio" class="form-label fw-bold">
                                        <i class="fas fa-calendar text-warning me-1"></i>
                                        Data do Relat√≥rio
                                    </label>
                                    <input type="date" class="form-control" id="data_relatorio" name="data_relatorio" 
                                           value="{{ data_hoje }}" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe a data.
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <label for="local" class="form-label fw-bold">
                                        <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                        Local
                                    </label>
                                    <select class="form-select" id="local" name="local" required>
                                        <option value="">Selecione...</option>
                                        <option value="Campo">Campo</option>
                                        <option value="Oficina">Oficina</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione o local.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="observacoes_gerais" class="form-label fw-bold">
                                    <i class="fas fa-comment text-info me-1"></i>
                                    Observa√ß√µes Gerais
                                </label>
                                <textarea class="form-control" id="observacoes_gerais" name="observacoes_gerais" 
                                          rows="3" placeholder="Descreva observa√ß√µes importantes, problemas encontrados, entregas recebidas, etc."></textarea>
                            </div>
                        </div>

                        <!-- === SE√á√ÉO DE SERVI√áOS === -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="text-success mb-0">
                                    <i class="fas fa-cogs me-2"></i>
                                    Servi√ßos e Atividades
                                </h5>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="carregarUltimoRDO()">
                                    <i class="fas fa-history me-1"></i>
                                    Testar √öltimo RDO
                                </button>
                            </div>
                            
                            <!-- Container para Servi√ßos -->
                            <div id="servicos-container" class="services-container">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-tools fa-3x mb-3 opacity-50"></i>
                                    <p class="mb-0">Selecione uma obra acima para carregar os servi√ßos dispon√≠veis</p>
                                </div>
                            </div>
                        </div>

                        <!-- === BOT√ïES DE A√á√ÉO === -->
                        <div class="form-section text-center">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-save me-2"></i>
                                Salvar RDO
                            </button>
                            <a href="{{ url_for('main.rdos') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// === SISTEMA RDO - ARQUITETURA DE MAESTRIA DIGITAL ===
console.log('üéØ Sistema RDO com Maestria Digital iniciado');

// === CONFIGURA√á√ïES GLOBAIS ===
const RDO_CONFIG = {
    API_BASE: '/api',
    DEBUGGING: true,
    ANIMATION_DURATION: 300
};

// === FUN√á√ïES DE OBSERVABILIDADE ===
function logSystem(level, message, data = null) {
    if (!RDO_CONFIG.DEBUGGING) return;
    
    const timestamp = new Date().toISOString();
    const prefix = {
        'info': 'üîç',
        'success': '‚úÖ', 
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå',
        'debug': 'üõ†Ô∏è'
    }[level] || 'üìù';
    
    console.log(`${prefix} [${timestamp}] ${message}`);
    if (data) console.log('üìä Dados:', data);
}

// === FUN√á√ÉO PRINCIPAL - CARREGAR DADOS DA OBRA ===
async function carregarDadosObra() {
    const obraSelect = document.getElementById('obra_id');
    const obraId = obraSelect.value;
    
    if (!obraId) {
        limparServicos();
        return;
    }
    
    logSystem('info', `Carregando dados da obra ${obraId}`);
    exibirCarregamento();
    
    try {
        const response = await fetch(`${RDO_CONFIG.API_BASE}/ultimo-rdo-dados/${obraId}`);
        const data = await response.json();
        
        logSystem('success', 'Dados da obra carregados com sucesso', data);
        
        if (data.success) {
            if (data.primeira_rdo && data.ultima_rdo) {
                logSystem('info', 'Primeira RDO da obra - inicializando com 0%');
                renderizarPrimeiraRDO(data.ultima_rdo);
            } else if (data.ultima_rdo) {
                logSystem('info', `RDO existente encontrado: ${data.ultima_rdo.numero_rdo}`);
                renderizarRDOExistente(data.ultima_rdo);
            } else {
                logSystem('warning', 'Nenhum dado de RDO encontrado');
                exibirMensagemVazia();
            }
        } else {
            throw new Error(data.error || 'Erro desconhecido na API');
        }
        
    } catch (error) {
        logSystem('error', 'Falha ao carregar dados da obra', error);
        exibirErro('Erro ao carregar dados da obra. Tente novamente.');
    }
}

// === FUN√á√ÉO PARA TESTAR √öLTIMO RDO ===
function carregarUltimoRDO() {
    const obraId = document.getElementById('obra_id').value;
    
    if (!obraId) {
        alert('‚ö†Ô∏è Selecione uma obra primeiro para testar o √∫ltimo RDO');
        return;
    }
    
    logSystem('info', 'Testando carregamento do √∫ltimo RDO');
    carregarDadosObra();
}

// === RENDERIZA√á√ÉO - PRIMEIRA RDO ===
function renderizarPrimeiraRDO(rdoData) {
    const container = document.getElementById('servicos-container');
    
    let html = `
        <div class="alert alert-warning">
            <div class="d-flex align-items-center">
                <i class="fas fa-star fa-2x text-warning me-3"></i>
                <div>
                    <h6 class="mb-1 fw-bold">üÜï Primeira RDO desta Obra</h6>
                    <p class="mb-0">Todos os servi√ßos iniciam com 0% de conclus√£o</p>
                </div>
            </div>
        </div>
    `;
    
    if (rdoData.servicos && rdoData.servicos.length > 0) {
        html += `
            <h6 class="text-success mb-3">
                <i class="fas fa-list-check me-2"></i>
                Servi√ßos Dispon√≠veis (${rdoData.servicos.length})
            </h6>
        `;
        
        rdoData.servicos.forEach(servico => {
            html += renderizarCardServico(servico, true);
        });
        
        html += `
            <div class="alert alert-info mt-3">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Dica:</strong> Ajuste os percentuais conforme o progresso real da obra.
            </div>
        `;
    } else {
        html += renderizarMensagemSemServicos();
    }
    
    container.innerHTML = html;
    logSystem('success', 'Primeira RDO renderizada com sucesso');
}

// === RENDERIZA√á√ÉO - RDO EXISTENTE ===
function renderizarRDOExistente(rdoData) {
    const container = document.getElementById('servicos-container');
    
    let html = `
        <div class="alert alert-success">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                <div>
                    <h6 class="mb-1 fw-bold">‚úÖ Dados Carregados do √öltimo RDO</h6>
                    <p class="mb-0">RDO: <strong>${rdoData.numero_rdo}</strong> ‚Ä¢ Data: ${rdoData.data_relatorio}</p>
                </div>
            </div>
        </div>
    `;
    
    if (rdoData.servicos && rdoData.servicos.length > 0) {
        html += `
            <h6 class="text-success mb-3">
                <i class="fas fa-cogs me-2"></i>
                Servi√ßos com Progresso (${rdoData.servicos.length})
            </h6>
        `;
        
        rdoData.servicos.forEach(servico => {
            html += renderizarCardServico(servico, false);
        });
    } else {
        html += renderizarMensagemSemServicos();
    }
    
    container.innerHTML = html;
    logSystem('success', 'RDO existente renderizado com sucesso');
}

// === RENDERIZA√á√ÉO - CARD DE SERVI√áO ===
function renderizarCardServico(servico, isPrimeiraRDO = false) {
    const progressoMedio = calcularProgressoMedio(servico.subatividades);
    const corCategoria = obterCorCategoria(servico.categoria);
    
    let html = `
        <div class="service-card" data-servico-id="${servico.id}">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 fw-bold">${servico.nome}</h6>
                        <span class="badge ${corCategoria}">${servico.categoria}</span>
                    </div>
                    <div class="text-end">
                        <div class="progress" style="width: 120px; height: 8px;">
                            <div class="progress-bar ${obterCorProgress(progressoMedio)}" 
                                 style="width: ${progressoMedio}%"></div>
                        </div>
                        <small class="text-muted">${progressoMedio.toFixed(1)}% conclu√≠do</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
    `;
    
    if (servico.subatividades && servico.subatividades.length > 0) {
        html += '<div class="row">';
        servico.subatividades.forEach((sub, index) => {
            const percentual = isPrimeiraRDO ? 0 : (sub.percentual || 0);
            const inputId = `sub_${servico.id}_${sub.id || index}_percentual`;
            const inputName = `subatividade[${servico.id}][${sub.id || index}][percentual]`;
            
            html += `
                <div class="col-md-6 mb-3">
                    <label for="${inputId}" class="form-label small fw-medium">${sub.nome}</label>
                    <div class="input-group input-group-sm">
                        <input type="number" 
                               id="${inputId}"
                               name="${inputName}" 
                               class="form-control subatividade-input" 
                               value="${percentual}" 
                               min="0" 
                               max="100" 
                               step="0.1"
                               data-servico-id="${servico.id}"
                               data-sub-id="${sub.id || index}"
                               onchange="atualizarProgressoServico(${servico.id})">
                        <span class="input-group-text">%</span>
                    </div>
                    <input type="hidden" name="subatividade[${servico.id}][${sub.id || index}][nome]" value="${sub.nome}">
                    <input type="hidden" name="subatividade[${servico.id}][${sub.id || index}][descricao]" value="${sub.descricao || ''}">
                </div>
            `;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted mb-0"><i class="fas fa-info-circle me-1"></i>Nenhuma subatividade cadastrada</p>';
    }
    
    html += '</div></div>';
    return html;
}

// === FUN√á√ïES AUXILIARES ===
function calcularProgressoMedio(subatividades) {
    if (!subatividades || subatividades.length === 0) return 0;
    
    const total = subatividades.reduce((acc, sub) => acc + (sub.percentual || 0), 0);
    return total / subatividades.length;
}

function obterCorCategoria(categoria) {
    const cores = {
        'Estrutural': 'bg-primary text-white',
        'Acabamento': 'bg-success text-white', 
        'Cobertura': 'bg-info text-white',
        'Instala√ß√µes': 'bg-warning text-dark',
        'Funda√ß√£o': 'bg-dark text-white',
        'Soldagem': 'bg-danger text-white'
    };
    return cores[categoria] || 'bg-secondary text-white';
}

function obterCorProgress(percentual) {
    if (percentual >= 100) return 'bg-success';
    if (percentual >= 75) return 'bg-info';
    if (percentual >= 50) return 'bg-warning';
    if (percentual >= 25) return 'bg-secondary';
    return 'bg-light';
}

// === ATUALIZA√á√ÉO DIN√ÇMICA DE PROGRESSO ===
function atualizarProgressoServico(servicoId) {
    const servicoCard = document.querySelector(`[data-servico-id="${servicoId}"]`);
    if (!servicoCard) return;
    
    const inputs = servicoCard.querySelectorAll('.subatividade-input');
    let totalProgress = 0;
    let validInputs = 0;
    
    inputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        if (value >= 0 && value <= 100) {
            totalProgress += value;
            validInputs++;
        }
    });
    
    const progressoMedio = validInputs > 0 ? (totalProgress / validInputs) : 0;
    
    // Atualizar barra de progresso
    const progressBar = servicoCard.querySelector('.progress-bar');
    const progressText = servicoCard.querySelector('.text-muted');
    
    if (progressBar && progressText) {
        progressBar.style.width = `${progressoMedio}%`;
        progressBar.className = `progress-bar ${obterCorProgress(progressoMedio)}`;
        progressText.textContent = `${progressoMedio.toFixed(1)}% conclu√≠do`;
    }
    
    logSystem('debug', `Progresso atualizado para servi√ßo ${servicoId}: ${progressoMedio.toFixed(1)}%`);
}

// === COLETA DE DADOS DO FORMUL√ÅRIO ===
function coletarDadosSubatividades() {
    const subatividades = [];
    const inputs = document.querySelectorAll('.subatividade-input');
    
    inputs.forEach(input => {
        const servicoId = input.dataset.servicoId;
        const subId = input.dataset.subId;
        const nome = document.querySelector(`input[name="subatividade[${servicoId}][${subId}][nome]"]`)?.value || '';
        const descricao = document.querySelector(`input[name="subatividade[${servicoId}][${subId}][descricao]"]`)?.value || '';
        const percentual = parseFloat(input.value) || 0;
        
        if (nome && percentual >= 0) {
            subatividades.push({
                servico_id: servicoId,
                subatividade_id: subId,
                nome: nome,
                descricao: descricao,
                percentual: percentual
            });
        }
    });
    
    return subatividades;
}

// === ESTADOS DA INTERFACE ===
function exibirCarregamento() {
    const container = document.getElementById('servicos-container');
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="loading-spinner mb-3"></div>
            <p class="text-muted mb-0">Carregando dados da obra...</p>
        </div>
    `;
}

function limparServicos() {
    const container = document.getElementById('servicos-container');
    container.innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-tools fa-3x mb-3 opacity-50"></i>
            <p class="mb-0">Selecione uma obra acima para carregar os servi√ßos dispon√≠veis</p>
        </div>
    `;
}

function exibirMensagemVazia() {
    const container = document.getElementById('servicos-container');
    container.innerHTML = `
        <div class="alert alert-info">
            <div class="text-center py-3">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h6>Primeira RDO desta Obra</h6>
                <p class="mb-0">N√£o h√° registros anteriores para carregar</p>
            </div>
        </div>
    `;
}

function renderizarMensagemSemServicos() {
    return `
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">Nenhum servi√ßo cadastrado</h6>
            <p class="text-muted">Cadastre servi√ßos para esta obra primeiro</p>
            <a href="/servicos" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Cadastrar Servi√ßos
            </a>
        </div>
    `;
}

function exibirErro(mensagem) {
    const container = document.getElementById('servicos-container');
    container.innerHTML = `
        <div class="alert alert-danger">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                <div>
                    <h6 class="mb-1 fw-bold">Erro no Sistema</h6>
                    <p class="mb-0">${mensagem}</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-outline-danger" onclick="location.reload()">
                    <i class="fas fa-redo me-1"></i>Tentar Novamente
                </button>
            </div>
        </div>
    `;
}

// === SUBMISS√ÉO DO FORMUL√ÅRIO ===
async function submeterFormularioRDO(event) {
    event.preventDefault();
    
    const form = document.getElementById('formNovoRDO');
    const formData = new FormData(form);
    
    // Valida√ß√£o b√°sica
    const obraId = formData.get('obra_id');
    const dataRelatorio = formData.get('data_relatorio');
    const local = formData.get('local');
    
    if (!obraId || !dataRelatorio || !local) {
        alert('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios');
        return;
    }
    
    logSystem('info', 'Iniciando submiss√£o do formul√°rio RDO', {
        obra_id: obraId,
        data: dataRelatorio,
        local: local
    });
    
    // Mostrar indicador de carregamento
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="loading-spinner me-2"></div>Salvando RDO...';
    
    try {
        const response = await fetch('/rdo/criar', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.text(); // Pode ser JSON ou redirect
        
        if (response.ok) {
            logSystem('success', 'RDO salvo com sucesso');
            
            // Mostrar mensagem de sucesso
            alert('‚úÖ RDO criado com sucesso!');
            
            // Redirecionar para lista de RDOs
            window.location.href = '/rdos';
        } else {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
    } catch (error) {
        logSystem('error', 'Falha ao salvar RDO', error);
        alert(`‚ùå Erro ao salvar RDO: ${error.message}`);
        
        // Restaurar bot√£o
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// === VALIDA√á√ÉO DE FORMUL√ÅRIO ===
function validarFormulario() {
    const form = document.getElementById('formNovoRDO');
    const inputs = form.querySelectorAll('input[required], select[required]');
    let valid = true;
    
    inputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            valid = false;
        } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        }
    });
    
    return valid;
}

// === INICIALIZA√á√ÉO ===
document.addEventListener('DOMContentLoaded', function() {
    logSystem('success', 'Sistema RDO com Maestria Digital carregado com sucesso');
    
    // Configurar evento de submiss√£o
    const form = document.getElementById('formNovoRDO');
    form.addEventListener('submit', submeterFormularioRDO);
    
    // Configurar valida√ß√£o em tempo real
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('blur', validarFormulario);
        input.addEventListener('change', validarFormulario);
    });
    
    // Auto-carregar dados se obra j√° estiver selecionada
    const obraSelect = document.getElementById('obra_id');
    if (obraSelect.value) {
        carregarDadosObra();
    }
});
</script>
{% endblock %}