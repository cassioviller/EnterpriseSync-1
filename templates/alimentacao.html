{% extends "base.html" %}

{% block title %}Alimenta√ß√£o - SIGE{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-utensils"></i> Controle de Alimenta√ß√£o
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#alimentacaoModal">
                <i class="fas fa-plus"></i> Novo Registro
            </button>
        </div>
    </div>
</div>

<!-- Filtros R√°pidos por Per√≠odo -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <h6 class="mb-0 me-3">
                        <i class="fas fa-filter"></i> Filtros R√°pidos:
                    </h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="filtrarPeriodo('hoje')">
                        <i class="fas fa-calendar-day"></i> Hoje
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="filtrarPeriodo('semana')">
                        <i class="fas fa-calendar-week"></i> Esta Semana
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="filtrarPeriodo('mes')">
                        <i class="fas fa-calendar-month"></i> Este M√™s
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="limparFiltros()">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                    <div class="ms-auto">
                        <input type="date" class="form-control form-control-sm d-inline-block" style="width: auto;" id="dataInicio" placeholder="Data In√≠cio">
                        <span class="mx-2">at√©</span>
                        <input type="date" class="form-control form-control-sm d-inline-block" style="width: auto;" id="dataFim" placeholder="Data Fim">
                        <button class="btn btn-primary btn-sm ms-2" onclick="filtrarPorDatas()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumo -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Total do M√™s</h5>
                        <h3 class="mb-0">R$ {{ '{:,.2f}'.format(registros|sum(attribute='valor') or 0) }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-calendar-month fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Registros Hoje</h5>
                        <h3 class="mb-0">{{ registros|selectattr('data', 'equalto', date.today())|list|length }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">M√©dia Di√°ria</h5>
                        <h3 class="mb-0">R$ {{ '{:,.2f}'.format((registros|sum(attribute='valor') or 0) / 30) }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Funcion√°rios</h5>
                        <h3 class="mb-0">{{ registros|map(attribute='funcionario_id')|unique|list|length }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Registros -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-history"></i> Registros de Alimenta√ß√£o
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="alimentacaoTable">
                <thead>
                    <tr>
                        <th>Funcion√°rio</th>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Obra</th>
                        <th>Restaurante</th>
                        <th>Observa√ß√µes</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in registros %}
                    <tr id="registro-{{ registro.id }}" data-registro-id="{{ registro.id }}">
                        <td class="funcionario-cell">
                            <div class="d-flex align-items-center view-mode">
                                <div class="avatar-sm me-2">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 12px;">
                                        {{ registro.funcionario.nome[:2].upper() if registro.funcionario else '?' }}
                                    </div>
                                </div>
                                <strong>{{ registro.funcionario.nome if registro.funcionario else 'Nome n√£o encontrado' }}</strong>
                            </div>
                            <select class="form-select form-select-sm edit-mode d-none" name="funcionario_id">
                                {% for func in funcionarios %}
                                <option value="{{ func.id }}" {% if func.id == registro.funcionario_id %}selected{% endif %}>
                                    {{ func.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="data-cell">
                            <span class="view-mode">{{ registro.data.strftime('%d/%m/%Y') }}</span>
                            <input type="date" class="form-control form-control-sm edit-mode d-none" 
                                   value="{{ registro.data.strftime('%Y-%m-%d') }}" name="data">
                        </td>
                        <td class="tipo-cell">
                            <span class="view-mode">
                                {% if registro.tipo == 'cafe' %}
                                    <span class="badge bg-warning">Caf√© da Manh√£</span>
                                {% elif registro.tipo == 'almoco' %}
                                    <span class="badge bg-success">Almo√ßo</span>
                                {% elif registro.tipo == 'jantar' %}
                                    <span class="badge bg-primary">Jantar</span>
                                {% else %}
                                    <span class="badge bg-secondary">Lanche</span>
                                {% endif %}
                            </span>
                            <select class="form-select form-select-sm edit-mode d-none" name="tipo">
                                <option value="cafe" {% if registro.tipo == 'cafe' %}selected{% endif %}>Caf√© da Manh√£</option>
                                <option value="almoco" {% if registro.tipo == 'almoco' %}selected{% endif %}>Almo√ßo</option>
                                <option value="jantar" {% if registro.tipo == 'jantar' %}selected{% endif %}>Jantar</option>
                                <option value="lanche" {% if registro.tipo == 'lanche' %}selected{% endif %}>Lanche</option>
                            </select>
                        </td>
                        <td class="valor-cell">
                            <span class="view-mode">R$ {{ '{:,.2f}'.format(registro.valor) }}</span>
                            <input type="number" step="0.01" class="form-control form-control-sm edit-mode d-none" 
                                   value="{{ registro.valor }}" name="valor" min="0">
                        </td>
                        <td class="obra-cell">
                            <span class="view-mode">{{ registro.obra_ref.nome if registro.obra_ref else '-' }}</span>
                            <select class="form-select form-select-sm edit-mode d-none" name="obra_id">
                                <option value="">Selecione uma obra</option>
                                {% for obra in obras %}
                                <option value="{{ obra.id }}" {% if obra.id == registro.obra_id %}selected{% endif %}>
                                    {{ obra.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="restaurante-cell">
                            <span class="view-mode">{{ registro.restaurante_ref.nome if registro.restaurante_ref else '-' }}</span>
                            <select class="form-select form-select-sm edit-mode d-none" name="restaurante_id">
                                <option value="">Selecione um restaurante</option>
                                {% for rest in restaurantes %}
                                <option value="{{ rest.id }}" {% if rest.id == registro.restaurante_id %}selected{% endif %}>
                                    {{ rest.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="observacoes-cell">
                            <span class="view-mode">{{ registro.observacoes or '-' }}</span>
                            <input type="text" class="form-control form-control-sm edit-mode d-none" 
                                   value="{{ registro.observacoes or '' }}" name="observacoes" 
                                   placeholder="Observa√ß√µes">
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-editar" onclick="editarRegistroInline({{ registro.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success btn-salvar d-none" onclick="salvarEdicao({{ registro.id }})">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-cancelar d-none" onclick="cancelarEdicao({{ registro.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="excluirRegistro({{ registro.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Registro de Alimenta√ß√£o - Redesenhado -->
<div class="modal fade" id="alimentacaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-utensils me-2"></i>
                    <span id="modalTitle">Novo Lan√ßamento de Alimenta√ß√£o</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.nova_alimentacao') }}" id="alimentacaoForm">
                <div class="modal-body p-4">
                    <!-- Se√ß√£o 1: Dados B√°sicos -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                Informa√ß√µes B√°sicas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="lancamentoPeriodo">
                                        <label class="form-check-label fw-bold" for="lancamentoPeriodo">
                                            <i class="fas fa-calendar-week me-1"></i> Lan√ßamento por Per√≠odo
                                        </label>
                                        <small class="text-muted d-block">Marque para lan√ßar em m√∫ltiplos dias consecutivos</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data √önica -->
                            <div class="row" id="dataUnica">
                                <div class="col-md-4 mb-3">
                                    <label for="data" class="form-label fw-bold">Data *</label>
                                    <input type="date" class="form-control form-control-lg" id="data" name="data" required>
                                </div>
                            </div>
                            
                            <!-- Per√≠odo -->
                            <div class="row" id="dataPeriodo" style="display: none;">
                                <div class="col-md-6 mb-3">
                                    <label for="data_inicio" class="form-label fw-bold">Data Inicial *</label>
                                    <input type="date" class="form-control form-control-lg" id="data_inicio" name="data_inicio">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="data_fim" class="form-label fw-bold">Data Final *</label>
                                    <input type="date" class="form-control form-control-lg" id="data_fim" name="data_fim">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tipo" class="form-label fw-bold">Tipo de Refei√ß√£o *</label>
                                    <select class="form-select form-select-lg" id="tipo" name="tipo" required>
                                        <option value="">Selecione...</option>
                                        <option value="cafe">‚òï Caf√© da Manh√£</option>
                                        <option value="almoco">üçΩÔ∏è Almo√ßo</option>
                                        <option value="lanche">ü•™ Lanche</option>
                                        <option value="jantar">üåô Jantar</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="valor" class="form-label fw-bold">Valor por Pessoa *</label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-success text-white">R$</span>
                                        <input type="number" class="form-control" id="valor" name="valor" 
                                               step="0.01" min="0" placeholder="0,00" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Se√ß√£o 2: Sele√ß√£o de Funcion√°rios -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-users me-2 text-primary"></i>
                                Funcion√°rios
                            </h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selecionarTodos">
                                <label class="form-check-label fw-bold" for="selecionarTodos">
                                    Selecionar Todos
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="buscaFuncionarios" 
                                           placeholder="Digite para filtrar funcion√°rios...">
                                </div>
                            </div>
                            
                            <div id="funcionariosList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="row" id="funcionariosGrid">
                                    {% for funcionario in funcionarios %}
                                    <div class="col-md-6 mb-2 funcionario-item" data-nome="{{ funcionario.nome.lower() }}">
                                        <div class="form-check">
                                            <input class="form-check-input funcionario-checkbox" type="checkbox" 
                                                   value="{{ funcionario.id }}" id="func_{{ funcionario.id }}">
                                            <label class="form-check-label d-flex align-items-center" 
                                                   for="func_{{ funcionario.id }}">
                                                <div class="rounded-circle bg-primary text-white me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ funcionario.nome.split()[0][0] }}{{ funcionario.nome.split()[-1][0] if funcionario.nome.split()|length > 1 else '' }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ funcionario.nome }}</div>
                                                    <small class="text-muted">{{ funcionario.funcao.nome if funcionario.funcao else 'Sem fun√ß√£o' }}</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="mt-3 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Funcion√°rios Selecionados:</span>
                                    <span class="badge bg-primary fs-6" id="contadorSelecionados">0</span>
                                </div>
                                <div class="mt-2">
                                    <span class="fw-bold">Valor Total:</span>
                                    <span class="text-success fw-bold fs-5" id="valorTotal">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Se√ß√£o 3: Detalhes Adicionais -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-building me-2 text-primary"></i>
                                Obra e Restaurante
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="obra_id" class="form-label fw-bold">Obra *</label>
                                    <select class="form-select" id="obra_id" name="obra_id" required>
                                        <option value="">Selecione uma obra...</option>
                                        {% for obra in obras %}
                                        <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                        Obrigat√≥rio para controle de custos e KPIs
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="restaurante_id" class="form-label fw-bold">Restaurante *</label>
                                    <select class="form-select" id="restaurante_id" name="restaurante_id" required>
                                        <option value="">Selecione um restaurante...</option>
                                        {% for restaurante in restaurantes %}
                                        <option value="{{ restaurante.id }}">{{ restaurante.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                        Obrigat√≥rio para identifica√ß√£o do fornecedor
                                    </small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="observacoes" class="form-label fw-bold">Observa√ß√µes</label>
                                <textarea class="form-control" id="observacoes" name="observacoes" 
                                          rows="3" placeholder="Informa√ß√µes adicionais sobre o lan√ßamento..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer bg-light p-3">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-success btn-lg" id="btnSalvar" disabled>
                        <i class="fas fa-save me-2"></i>Salvar Lan√ßamentos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar DataTable com filtros
    $('#alimentacaoTable').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
        },
        order: [[1, 'desc']],
        pageLength: 25,
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
    
    // Configurar data padr√£o
    document.getElementById('data').valueAsDate = new Date();
    
    // Configurar altern√¢ncia entre data √∫nica e per√≠odo
    setupPeriodoToggle();
    
    // Event listeners para sele√ß√£o m√∫ltipla
    setupMultiSelectionFunctionality();
});

function setupPeriodoToggle() {
    const togglePeriodo = document.getElementById('lancamentoPeriodo');
    const dataUnica = document.getElementById('dataUnica');
    const dataPeriodo = document.getElementById('dataPeriodo');
    const dataInput = document.getElementById('data');
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');
    
    togglePeriodo.addEventListener('change', function() {
        if (this.checked) {
            // Modo per√≠odo
            dataUnica.style.display = 'none';
            dataPeriodo.style.display = 'block';
            
            // Remover obrigatoriedade da data √∫nica e adicionar no per√≠odo
            dataInput.removeAttribute('required');
            dataInicioInput.setAttribute('required', '');
            dataFimInput.setAttribute('required', '');
            
            // Configurar valores padr√£o
            const hoje = new Date().toISOString().split('T')[0];
            const proximaSemana = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            dataInicioInput.value = hoje;
            dataFimInput.value = proximaSemana;
        } else {
            // Modo data √∫nica
            dataUnica.style.display = 'block';
            dataPeriodo.style.display = 'none';
            
            // Remover obrigatoriedade do per√≠odo e adicionar na data √∫nica
            dataInput.setAttribute('required', '');
            dataInicioInput.removeAttribute('required');
            dataFimInput.removeAttribute('required');
            
            // Limpar valores do per√≠odo
            dataInicioInput.value = '';
            dataFimInput.value = '';
        }
    });
}

function setupMultiSelectionFunctionality() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox');
    const selecionarTodos = document.getElementById('selecionarTodos');
    const contadorSelecionados = document.getElementById('contadorSelecionados');
    const valorTotal = document.getElementById('valorTotal');
    const btnSalvar = document.getElementById('btnSalvar');
    const valorInput = document.getElementById('valor');
    const buscaInput = document.getElementById('buscaFuncionarios');
    
    // Atualizar contadores e totais
    function atualizarContadores() {
        const selecionados = document.querySelectorAll('.funcionario-checkbox:checked');
        const count = selecionados.length;
        const valorUnitario = parseFloat(valorInput.value) || 0;
        
        // Calcular total considerando per√≠odo
        const isPeriodo = document.getElementById('lancamentoPeriodo').checked;
        let diasPeriodo = 1;
        
        if (isPeriodo) {
            const dataInicio = document.getElementById('data_inicio').value;
            const dataFim = document.getElementById('data_fim').value;
            
            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                diasPeriodo = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;
            }
        }
        
        const total = count * valorUnitario * diasPeriodo;
        
        contadorSelecionados.textContent = count;
        valorTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        
        if (isPeriodo && diasPeriodo > 1) {
            valorTotal.innerHTML += `<br><small class="text-muted">(${count} funcion√°rios √ó ${diasPeriodo} dias)</small>`;
        }
        
        // Habilitar/desabilitar bot√£o salvar
        const obraId = document.getElementById('obra_id').value;
        const restauranteId = document.getElementById('restaurante_id').value;
        btnSalvar.disabled = count === 0 || valorUnitario === 0 || !obraId || !restauranteId;
        
        // Atualizar checkbox "Selecionar Todos"
        selecionarTodos.indeterminate = count > 0 && count < checkboxes.length;
        selecionarTodos.checked = count === checkboxes.length;
    }
    
    // Event listener para checkboxes individuais
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', atualizarContadores);
    });
    
    // Event listener para "Selecionar Todos"
    selecionarTodos.addEventListener('change', function() {
        const isChecked = this.checked;
        const visibleCheckboxes = document.querySelectorAll('.funcionario-item:not([style*="display: none"]) .funcionario-checkbox');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        
        atualizarContadores();
    });
    
    // Event listener para mudan√ßa no valor
    valorInput.addEventListener('input', atualizarContadores);
    
    // Event listeners para dropdowns obrigat√≥rios
    document.getElementById('obra_id').addEventListener('change', atualizarContadores);
    document.getElementById('restaurante_id').addEventListener('change', atualizarContadores);
}

// Filtros r√°pidos por per√≠odo
function filtrarPeriodo(periodo) {
    let hoje = new Date();
    let dataInicio, dataFim = hoje;
    
    switch(periodo) {
        case 'hoje':
            dataInicio = hoje;
            break;
        case 'semana':
            dataInicio = new Date(hoje);
            dataInicio.setDate(hoje.getDate() - hoje.getDay());
            break;
        case 'mes':
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            break;
    }
    
    document.getElementById('dataInicio').value = dataInicio.toISOString().split('T')[0];
    document.getElementById('dataFim').value = dataFim.toISOString().split('T')[0];
    filtrarPorDatas();
}

function filtrarPorDatas() {
    let dataInicio = document.getElementById('dataInicio').value;
    let dataFim = document.getElementById('dataFim').value;
    
    if (!dataInicio || !dataFim) {
        alert('Selecione as datas de in√≠cio e fim');
        return;
    }
    
    // Aplicar filtro na tabela
    let table = $('#alimentacaoTable').DataTable();
    
    // Filtro customizado por data
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        let dataRegistro = data[1]; // Coluna da data
        let [dia, mes, ano] = dataRegistro.split('/');
        let dataComp = new Date(ano, mes - 1, dia);
        let inicio = new Date(dataInicio);
        let fim = new Date(dataFim);
        
        return dataComp >= inicio && dataComp <= fim;
    });
    
    table.draw();
    
    // Remover filtro ap√≥s aplicar
    $.fn.dataTable.ext.search.pop();
}

function limparFiltros() {
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    let table = $('#alimentacaoTable').DataTable();
    table.search('').columns().search('').draw();
}

// Sistema de edi√ß√£o inline
let registroOriginal = {};

function editarRegistroInline(registroId) {
    const row = document.querySelector(`#registro-${registroId}`);
    
    // Salvar dados originais
    registroOriginal[registroId] = {
        funcionario_id: row.querySelector('[name="funcionario_id"]').value,
        data: row.querySelector('[name="data"]').value,
        tipo: row.querySelector('[name="tipo"]').value,
        valor: row.querySelector('[name="valor"]').value,
        obra_id: row.querySelector('[name="obra_id"]').value,
        restaurante_id: row.querySelector('[name="restaurante_id"]').value,
        observacoes: row.querySelector('[name="observacoes"]').value
    };
    
    // Alternar para modo edi√ß√£o
    row.querySelectorAll('.view-mode').forEach(el => el.classList.add('d-none'));
    row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('d-none'));
    
    // Alternar bot√µes
    row.querySelector('.btn-editar').classList.add('d-none');
    row.querySelector('.btn-salvar').classList.remove('d-none');
    row.querySelector('.btn-cancelar').classList.remove('d-none');
    
    // Adicionar classe visual
    row.classList.add('table-warning');
}

function cancelarEdicao(registroId) {
    const row = document.querySelector(`#registro-${registroId}`);
    
    // Restaurar valores originais
    if (registroOriginal[registroId]) {
        Object.keys(registroOriginal[registroId]).forEach(field => {
            const input = row.querySelector(`[name="${field}"]`);
            if (input) {
                input.value = registroOriginal[registroId][field];
            }
        });
    }
    
    // Voltar ao modo visualiza√ß√£o
    voltarModoVisualizacao(registroId);
}

function voltarModoVisualizacao(registroId) {
    const row = document.querySelector(`#registro-${registroId}`);
    
    // Alternar para modo visualiza√ß√£o
    row.querySelectorAll('.view-mode').forEach(el => el.classList.remove('d-none'));
    row.querySelectorAll('.edit-mode').forEach(el => el.classList.add('d-none'));
    
    // Alternar bot√µes
    row.querySelector('.btn-editar').classList.remove('d-none');
    row.querySelector('.btn-salvar').classList.add('d-none');
    row.querySelector('.btn-cancelar').classList.add('d-none');
    
    // Remover classe visual
    row.classList.remove('table-warning');
}

function salvarEdicao(registroId) {
    const row = document.querySelector(`#registro-${registroId}`);
    
    // Coletar dados do formul√°rio
    const formData = {
        funcionario_id: row.querySelector('[name="funcionario_id"]').value,
        data: row.querySelector('[name="data"]').value,
        tipo: row.querySelector('[name="tipo"]').value,
        valor: parseFloat(row.querySelector('[name="valor"]').value),
        obra_id: row.querySelector('[name="obra_id"]').value || null,
        restaurante_id: row.querySelector('[name="restaurante_id"]').value || null,
        observacoes: row.querySelector('[name="observacoes"]').value
    };
    
    // Valida√ß√µes b√°sicas
    if (!formData.funcionario_id || !formData.data || !formData.tipo || !formData.valor) {
        alert('Preencha todos os campos obrigat√≥rios: Funcion√°rio, Data, Tipo e Valor');
        return;
    }
    
    if (formData.valor <= 0) {
        alert('O valor deve ser maior que zero');
        return;
    }
    
    // Desabilitar bot√µes durante salvamento
    const btnSalvar = row.querySelector('.btn-salvar');
    const btnCancelar = row.querySelector('.btn-cancelar');
    btnSalvar.disabled = true;
    btnCancelar.disabled = true;
    btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Enviar dados via AJAX
    fetch(`/alimentacao/editar/${registroId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar interface com novos dados
            atualizarVisualizacaoRegistro(registroId, data.registro);
            voltarModoVisualizacao(registroId);
            
            // Mostrar mensagem de sucesso
            mostrarToast('Registro atualizado com sucesso!', 'success');
        } else {
            throw new Error(data.message || 'Erro ao salvar');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar registro: ' + error.message);
    })
    .finally(() => {
        // Reabilitar bot√µes
        btnSalvar.disabled = false;
        btnCancelar.disabled = false;
        btnSalvar.innerHTML = '<i class="fas fa-save"></i>';
    });
}

function atualizarVisualizacaoRegistro(registroId, dadosAtualizados) {
    const row = document.querySelector(`#registro-${registroId}`);
    
    // Atualizar campos de visualiza√ß√£o
    const funcionarioCell = row.querySelector('.funcionario-cell .view-mode strong');
    if (funcionarioCell) {
        funcionarioCell.textContent = dadosAtualizados.funcionario_nome;
    }
    
    const dataCell = row.querySelector('.data-cell .view-mode');
    if (dataCell) {
        dataCell.textContent = dadosAtualizados.data_formatada;
    }
    
    const tipoCell = row.querySelector('.tipo-cell .view-mode');
    if (tipoCell) {
        const tipoMap = {
            'cafe': '<span class="badge bg-warning">Caf√© da Manh√£</span>',
            'almoco': '<span class="badge bg-success">Almo√ßo</span>',
            'jantar': '<span class="badge bg-primary">Jantar</span>',
            'lanche': '<span class="badge bg-secondary">Lanche</span>'
        };
        tipoCell.innerHTML = tipoMap[dadosAtualizados.tipo] || '<span class="badge bg-secondary">Lanche</span>';
    }
    
    const valorCell = row.querySelector('.valor-cell .view-mode');
    if (valorCell) {
        valorCell.textContent = `R$ ${parseFloat(dadosAtualizados.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    }
    
    const obraCell = row.querySelector('.obra-cell .view-mode');
    if (obraCell) {
        obraCell.textContent = dadosAtualizados.obra_nome || '-';
    }
    
    const restauranteCell = row.querySelector('.restaurante-cell .view-mode');
    if (restauranteCell) {
        restauranteCell.textContent = dadosAtualizados.restaurante_nome || '-';
    }
    
    const observacoesCell = row.querySelector('.observacoes-cell .view-mode');
    if (observacoesCell) {
        observacoesCell.textContent = dadosAtualizados.observacoes || '-';
    }
}

function mostrarToast(message, type = 'info') {
    // Criar toast simples
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function excluirRegistro(registroId) {
    if (!confirm('Tem certeza que deseja excluir este registro?')) {
        return;
    }
    
    fetch(`/alimentacao/excluir/${registroId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`#registro-${registroId}`).remove();
            mostrarToast('Registro exclu√≠do com sucesso!', 'success');
        } else {
            throw new Error(data.message || 'Erro ao excluir');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao excluir registro: ' + error.message);
    });
    
    // Event listeners para mudan√ßas nas datas do per√≠odo
    document.getElementById('data_inicio').addEventListener('change', atualizarContadores);
    document.getElementById('data_fim').addEventListener('change', atualizarContadores);
    
    // Funcionalidade de busca
    buscaInput.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const funcionarios = document.querySelectorAll('.funcionario-item');
        
        funcionarios.forEach(item => {
            const nome = item.getAttribute('data-nome');
            if (nome.includes(termo)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        
        // Atualizar "Selecionar Todos" considerando apenas vis√≠veis
        atualizarContadores();
    });
    
    // Reset form quando modal √© fechado
    $('#alimentacaoModal').on('hidden.bs.modal', function() {
        document.getElementById('alimentacaoForm').reset();
        checkboxes.forEach(checkbox => checkbox.checked = false);
        atualizarContadores();
        buscaInput.value = '';
        
        // Mostrar todos os funcion√°rios
        document.querySelectorAll('.funcionario-item').forEach(item => {
            item.style.display = '';
        });
    });
}

// Interceptar submit do formul√°rio para enviar funcion√°rios selecionados
document.getElementById('alimentacaoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btnSalvar = document.getElementById('btnSalvar');
    
    // Desabilitar bot√£o durante envio
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
    
    fetch("{{ url_for('main.nova_alimentacao') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar modal e recarregar p√°gina
            $('#alimentacaoModal').modal('hide');
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar registros');
    })
    .finally(() => {
        // Reabilitar bot√£o
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Lan√ßamentos';
    });
});

// Fun√ß√£o para editar registro
function editarRegistro(id) {
    fetch(`/alimentacao/${id}/editar`)
        .then(response => response.json())
        .then(data => {
            // Preencher modal com dados do registro
            document.getElementById('modalTitle').textContent = 'Editar Registro de Alimenta√ß√£o';
            document.getElementById('data').value = data.data;
            document.getElementById('tipo').value = data.tipo;
            document.getElementById('valor').value = data.valor;
            document.getElementById('obra_id').value = data.obra_id;
            document.getElementById('restaurante_id').value = data.restaurante_id;
            document.getElementById('observacoes').value = data.observacoes;
            
            // Selecionar apenas o funcion√°rio espec√≠fico
            document.querySelectorAll('.funcionario-checkbox').forEach(checkbox => {
                checkbox.checked = checkbox.value == data.funcionario_id;
                checkbox.disabled = checkbox.value != data.funcionario_id;
            });
            
            // Atualizar URL do formul√°rio para edi√ß√£o
            document.getElementById('alimentacaoForm').action = `/alimentacao/${id}/editar`;
            
            // Mostrar modal
            $('#alimentacaoModal').modal('show');
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados para edi√ß√£o');
        });
}

// Fun√ß√£o para excluir registro  
function excluirRegistro(id) {
    if (confirm('Tem certeza que deseja excluir este registro?')) {
        fetch(`/alimentacao/${id}/excluir`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir registro');
        });
    }
}

// Reset form quando abrir modal para novo registro
$('#alimentacaoModal').on('show.bs.modal', function() {
    // Se n√£o est√° editando, resetar para novo registro
    if (document.getElementById('modalTitle').textContent.includes('Novo')) {
        document.getElementById('alimentacaoForm').action = "{{ url_for('main.nova_alimentacao') }}";
        
        // Habilitar todos os checkboxes
        document.querySelectorAll('.funcionario-checkbox').forEach(checkbox => {
            checkbox.disabled = false;
        });
    }
});

// Handler para formul√°rio de alimenta√ß√£o
document.getElementById('alimentacaoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selecionados = document.querySelectorAll('.funcionario-checkbox:checked');
    const formData = new FormData(this);
    
    // Remover funcionario_id do FormData se existir
    formData.delete('funcionario_id');
    
    // Adicionar cada funcion√°rio selecionado
    selecionados.forEach(checkbox => {
        formData.append('funcionarios_ids[]', checkbox.value);
    });
    
    // Enviar via fetch
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            $('#alimentacaoModal').modal('hide');
            location.reload();
        } else {
            alert(data.message || 'Erro ao salvar registros de alimenta√ß√£o');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar registros de alimenta√ß√£o');
    });
});

function editarRegistro(id) {
    // Implementar edi√ß√£o
    alert('Funcionalidade de edi√ß√£o ser√° implementada na pr√≥xima vers√£o');
}

function excluirRegistro(id) {
    if (confirm('Tem certeza que deseja excluir este registro?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/alimentacao/' + id + '/excluir';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}
