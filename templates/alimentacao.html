{% extends "base.html" %}

{% block title %}Alimentação - SIGE{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-utensils"></i> Controle de Alimentação
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#alimentacaoModal">
                <i class="fas fa-plus"></i> Novo Registro
            </button>
        </div>
    </div>
</div>

<!-- Resumo -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Total do Mês</h5>
                        <h3 class="mb-0">R$ {{ '{:,.2f}'.format(registros|sum(attribute='valor') or 0) }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-calendar-month fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Registros Hoje</h5>
                        <h3 class="mb-0">{{ registros|selectattr('data', 'equalto', date.today())|list|length }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Média Diária</h5>
                        <h3 class="mb-0">R$ {{ '{:,.2f}'.format((registros|sum(attribute='valor') or 0) / 30) }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">Funcionários</h5>
                        <h3 class="mb-0">{{ registros|map(attribute='funcionario_id')|unique|list|length }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Rápidos -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-filter"></i> Filtros Rápidos
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Período:</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm filtro-periodo" data-periodo="hoje">Hoje</button>
                    <button type="button" class="btn btn-outline-primary btn-sm filtro-periodo" data-periodo="semana">Semana</button>
                    <button type="button" class="btn btn-outline-primary btn-sm filtro-periodo" data-periodo="mes">Mês</button>
                    <button type="button" class="btn btn-outline-primary btn-sm filtro-periodo" data-periodo="todos">Todos</button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Data Início:</label>
                <input type="date" class="form-control form-control-sm" id="dataInicio" value="{{ request.args.get('data_inicio', '') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Data Fim:</label>
                <input type="date" class="form-control form-control-sm" id="dataFim" value="{{ request.args.get('data_fim', '') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Funcionário:</label>
                <select class="form-select form-select-sm" id="filtroFuncionario">
                    <option value="">Todos os funcionários</option>
                    {% for funcionario in funcionarios %}
                    <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-primary btn-sm" onclick="aplicarFiltros()">
                    <i class="fas fa-search"></i> Aplicar Filtros
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="limparFiltros()">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Registros -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-history"></i> Registros de Alimentação
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="alimentacaoTable">
                <thead>
                    <tr>
                        <th>Funcionário</th>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Obra</th>
                        <th>Restaurante</th>
                        <th>Observações</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in registros %}
                    <tr id="registro-{{ registro.id }}" data-registro-id="{{ registro.id }}">
                        <td class="funcionario-nome">
                            <strong>{{ registro.funcionario_ref.nome if registro.funcionario_ref else 'Funcionário não encontrado' }}</strong>
                            <br><small class="text-muted">ID: {{ registro.funcionario_id }}</small>
                        </td>
                        <td class="data-registro">{{ registro.data.strftime('%d/%m/%Y') }}</td>
                        <td class="tipo-refeicao">
                            {% if registro.tipo == 'cafe' %}
                                <span class="badge bg-warning">Café da Manhã</span>
                            {% elif registro.tipo == 'almoco' %}
                                <span class="badge bg-success">Almoço</span>
                            {% elif registro.tipo == 'jantar' %}
                                <span class="badge bg-primary">Jantar</span>
                            {% else %}
                                <span class="badge bg-secondary">Lanche</span>
                            {% endif %}
                        </td>
                        <td class="valor-registro">R$ {{ '{:,.2f}'.format(registro.valor) }}</td>
                        <td class="obra-nome">{{ registro.obra_ref.nome if registro.obra_ref else '-' }}</td>
                        <td>{{ registro.restaurante_ref.nome if registro.restaurante_ref else '-' }}</td>
                        <td class="observacoes-registro">{{ registro.observacoes or '-' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-editar" data-id="{{ registro.id }}" onclick="editarRegistroInline({{ registro.id }})" title="Editar inline">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="excluirRegistro({{ registro.id }})" title="Excluir registro">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Registro de Alimentação - Redesenhado -->
<div class="modal fade" id="alimentacaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-utensils me-2"></i>
                    <span id="modalTitle">Novo Lançamento de Alimentação</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.nova_alimentacao') }}" id="alimentacaoForm">
                <div class="modal-body p-4">
                    <!-- Seção 1: Dados Básicos -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                Informações Básicas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="lancamentoPeriodo">
                                        <label class="form-check-label fw-bold" for="lancamentoPeriodo">
                                            <i class="fas fa-calendar-week me-1"></i> Lançamento por Período
                                        </label>
                                        <small class="text-muted d-block">Marque para lançar em múltiplos dias consecutivos</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Única -->
                            <div class="row" id="dataUnica">
                                <div class="col-md-4 mb-3">
                                    <label for="data" class="form-label fw-bold">Data *</label>
                                    <input type="date" class="form-control form-control-lg" id="data" name="data" required>
                                </div>
                            </div>
                            
                            <!-- Período -->
                            <div class="row" id="dataPeriodo" style="display: none;">
                                <div class="col-md-6 mb-3">
                                    <label for="data_inicio" class="form-label fw-bold">Data Inicial *</label>
                                    <input type="date" class="form-control form-control-lg" id="data_inicio" name="data_inicio">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="data_fim" class="form-label fw-bold">Data Final *</label>
                                    <input type="date" class="form-control form-control-lg" id="data_fim" name="data_fim">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tipo" class="form-label fw-bold">Tipo de Refeição *</label>
                                    <select class="form-select form-select-lg" id="tipo" name="tipo" required>
                                        <option value="">Selecione...</option>
                                        <option value="cafe">☕ Café da Manhã</option>
                                        <option value="almoco">🍽️ Almoço</option>
                                        <option value="lanche">🥪 Lanche</option>
                                        <option value="jantar">🌙 Jantar</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="valor" class="form-label fw-bold">Valor por Pessoa *</label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-success text-white">R$</span>
                                        <input type="number" class="form-control" id="valor" name="valor" 
                                               step="0.01" min="0" placeholder="0,00" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção 2: Seleção de Funcionários -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-users me-2 text-primary"></i>
                                Funcionários
                            </h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selecionarTodos">
                                <label class="form-check-label fw-bold" for="selecionarTodos">
                                    Selecionar Todos
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="buscaFuncionarios" 
                                           placeholder="Digite para filtrar funcionários...">
                                </div>
                            </div>
                            
                            <div id="funcionariosList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="row" id="funcionariosGrid">
                                    {% for funcionario in funcionarios %}
                                    <div class="col-md-6 mb-2 funcionario-item" data-nome="{{ funcionario.nome.lower() }}">
                                        <div class="form-check">
                                            <input class="form-check-input funcionario-checkbox" type="checkbox" 
                                                   value="{{ funcionario.id }}" id="func_{{ funcionario.id }}">
                                            <label class="form-check-label d-flex align-items-center" 
                                                   for="func_{{ funcionario.id }}">
                                                <div class="rounded-circle bg-primary text-white me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ funcionario.nome.split()[0][0] }}{{ funcionario.nome.split()[-1][0] if funcionario.nome.split()|length > 1 else '' }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ funcionario.nome }}</div>
                                                    <small class="text-muted">{{ funcionario.funcao.nome if funcionario.funcao else 'Sem função' }}</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="mt-3 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Funcionários Selecionados:</span>
                                    <span class="badge bg-primary fs-6" id="contadorSelecionados">0</span>
                                </div>
                                <div class="mt-2">
                                    <span class="fw-bold">Valor Total:</span>
                                    <span class="text-success fw-bold fs-5" id="valorTotal">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção 3: Detalhes Adicionais -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-building me-2 text-primary"></i>
                                Obra e Restaurante
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="obra_id" class="form-label fw-bold">Obra *</label>
                                    <select class="form-select" id="obra_id" name="obra_id" required>
                                        <option value="">Selecione uma obra...</option>
                                        {% for obra in obras %}
                                        <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                        Obrigatório para controle de custos e KPIs
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="restaurante_id" class="form-label fw-bold">Restaurante *</label>
                                    <select class="form-select" id="restaurante_id" name="restaurante_id" required>
                                        <option value="">Selecione um restaurante...</option>
                                        {% for restaurante in restaurantes %}
                                        <option value="{{ restaurante.id }}">{{ restaurante.nome }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                        Obrigatório para identificação do fornecedor
                                    </small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="observacoes" class="form-label fw-bold">Observações</label>
                                <textarea class="form-control" id="observacoes" name="observacoes" 
                                          rows="3" placeholder="Informações adicionais sobre o lançamento..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer bg-light p-3">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-success btn-lg" id="btnSalvar" disabled>
                        <i class="fas fa-save me-2"></i>Salvar Lançamentos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar DataTable
    $('#alimentacaoTable').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
        },
        order: [[1, 'desc']],
        pageLength: 25,
        responsive: true
    });
    
    // Configurar data padrão
    document.getElementById('data').valueAsDate = new Date();
    
    // Configurar alternância entre data única e período
    setupPeriodoToggle();
    
    // Event listeners para seleção múltipla
    setupMultiSelectionFunctionality();
});

function setupPeriodoToggle() {
    const togglePeriodo = document.getElementById('lancamentoPeriodo');
    const dataUnica = document.getElementById('dataUnica');
    const dataPeriodo = document.getElementById('dataPeriodo');
    const dataInput = document.getElementById('data');
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');
    
    togglePeriodo.addEventListener('change', function() {
        if (this.checked) {
            // Modo período
            dataUnica.style.display = 'none';
            dataPeriodo.style.display = 'block';
            
            // Remover obrigatoriedade da data única e adicionar no período
            dataInput.removeAttribute('required');
            dataInicioInput.setAttribute('required', '');
            dataFimInput.setAttribute('required', '');
            
            // Configurar valores padrão
            const hoje = new Date().toISOString().split('T')[0];
            const proximaSemana = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            dataInicioInput.value = hoje;
            dataFimInput.value = proximaSemana;
        } else {
            // Modo data única
            dataUnica.style.display = 'block';
            dataPeriodo.style.display = 'none';
            
            // Remover obrigatoriedade do período e adicionar na data única
            dataInput.setAttribute('required', '');
            dataInicioInput.removeAttribute('required');
            dataFimInput.removeAttribute('required');
            
            // Limpar valores do período
            dataInicioInput.value = '';
            dataFimInput.value = '';
        }
    });
}

function setupMultiSelectionFunctionality() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox');
    const selecionarTodos = document.getElementById('selecionarTodos');
    const contadorSelecionados = document.getElementById('contadorSelecionados');
    const valorTotal = document.getElementById('valorTotal');
    const btnSalvar = document.getElementById('btnSalvar');
    const valorInput = document.getElementById('valor');
    const buscaInput = document.getElementById('buscaFuncionarios');
    
    // Atualizar contadores e totais
    function atualizarContadores() {
        const selecionados = document.querySelectorAll('.funcionario-checkbox:checked');
        const count = selecionados.length;
        const valorUnitario = parseFloat(valorInput.value) || 0;
        
        // Calcular total considerando período
        const isPeriodo = document.getElementById('lancamentoPeriodo').checked;
        let diasPeriodo = 1;
        
        if (isPeriodo) {
            const dataInicio = document.getElementById('data_inicio').value;
            const dataFim = document.getElementById('data_fim').value;
            
            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                diasPeriodo = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;
            }
        }
        
        const total = count * valorUnitario * diasPeriodo;
        
        contadorSelecionados.textContent = count;
        valorTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        
        if (isPeriodo && diasPeriodo > 1) {
            valorTotal.innerHTML += `<br><small class="text-muted">(${count} funcionários × ${diasPeriodo} dias)</small>`;
        }
        
        // Habilitar/desabilitar botão salvar
        const obraId = document.getElementById('obra_id').value;
        const restauranteId = document.getElementById('restaurante_id').value;
        btnSalvar.disabled = count === 0 || valorUnitario === 0 || !obraId || !restauranteId;
        
        // Atualizar checkbox "Selecionar Todos"
        selecionarTodos.indeterminate = count > 0 && count < checkboxes.length;
        selecionarTodos.checked = count === checkboxes.length;
    }
    
    // Event listener para checkboxes individuais
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', atualizarContadores);
    });
    
    // Event listener para "Selecionar Todos"
    selecionarTodos.addEventListener('change', function() {
        const isChecked = this.checked;
        const visibleCheckboxes = document.querySelectorAll('.funcionario-item:not([style*="display: none"]) .funcionario-checkbox');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        
        atualizarContadores();
    });
    
    // Event listener para mudança no valor
    valorInput.addEventListener('input', atualizarContadores);
    
    // Event listeners para mudança na obra e restaurante
    document.getElementById('obra_id').addEventListener('change', atualizarContadores);
    document.getElementById('restaurante_id').addEventListener('change', atualizarContadores);
    
    // Event listener para busca de funcionários
    buscaInput.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const items = document.querySelectorAll('.funcionario-item');
        
        items.forEach(item => {
            const nome = item.dataset.nome;
            if (nome.includes(termo)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Inicializar contadores
    atualizarContadores();
}

// ================== FILTROS RÁPIDOS ==================
function aplicarFiltros() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const funcionarioId = document.getElementById('filtroFuncionario').value;
    
    const params = new URLSearchParams();
    if (dataInicio) params.append('data_inicio', dataInicio);
    if (dataFim) params.append('data_fim', dataFim);
    if (funcionarioId) params.append('funcionario_id', funcionarioId);
    
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

function limparFiltros() {
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('filtroFuncionario').value = '';
    document.querySelectorAll('.filtro-periodo').forEach(b => b.classList.remove('active'));
    window.location.href = window.location.pathname;
}

// Filtros de período
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.filtro-periodo').forEach(btn => {
        btn.addEventListener('click', function() {
            const periodo = this.dataset.periodo;
            const hoje = new Date();
            let dataInicio, dataFim;

            switch(periodo) {
                case 'hoje':
                    dataInicio = dataFim = hoje.toISOString().split('T')[0];
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoje.setDate(hoje.getDate() - hoje.getDay()));
                    const fimSemana = new Date(hoje.setDate(inicioSemana.getDate() + 6));
                    dataInicio = inicioSemana.toISOString().split('T')[0];
                    dataFim = fimSemana.toISOString().split('T')[0];
                    break;
                case 'mes':
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                    dataFim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                case 'todos':
                    dataInicio = dataFim = '';
                    break;
            }

            document.getElementById('dataInicio').value = dataInicio;
            document.getElementById('dataFim').value = dataFim;
            
            // Marcar botão ativo
            document.querySelectorAll('.filtro-periodo').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
});

// ================== EDIÇÃO INLINE ==================
let registroEditandoId = null;
let dadosOriginais = {};

function editarRegistroInline(id) {
    if (registroEditandoId && registroEditandoId !== id) {
        cancelarEdicao(registroEditandoId);
    }
    
    registroEditandoId = id;
    const row = document.getElementById(`registro-${id}`);
    
    // Salvar dados originais
    dadosOriginais[id] = {
        data: row.querySelector('.data-registro').textContent,
        tipo: row.querySelector('.tipo-refeicao .badge').textContent,
        valor: row.querySelector('.valor-registro').textContent,
        observacoes: row.querySelector('.observacoes-registro').textContent
    };
    
    // Converter células em campos editáveis
    converterParaEdicao(row, id);
}

function converterParaEdicao(row, id) {
    // Data
    const dataCell = row.querySelector('.data-registro');
    const dataAtual = dataCell.textContent.split('/').reverse().join('-'); // DD/MM/YYYY -> YYYY-MM-DD
    dataCell.innerHTML = `<input type="date" class="form-control form-control-sm" value="${dataAtual}" id="edit-data-${id}">`;
    
    // Tipo
    const tipoCell = row.querySelector('.tipo-refeicao');
    const tipoAtual = tipoCell.querySelector('.badge').textContent.toLowerCase();
    let tipoValue = '';
    if (tipoAtual.includes('café')) tipoValue = 'cafe';
    else if (tipoAtual.includes('almoço')) tipoValue = 'almoco';
    else if (tipoAtual.includes('jantar')) tipoValue = 'jantar';
    else tipoValue = 'lanche';
    
    tipoCell.innerHTML = `
        <select class="form-select form-select-sm" id="edit-tipo-${id}">
            <option value="cafe" ${tipoValue === 'cafe' ? 'selected' : ''}>Café da Manhã</option>
            <option value="almoco" ${tipoValue === 'almoco' ? 'selected' : ''}>Almoço</option>
            <option value="lanche" ${tipoValue === 'lanche' ? 'selected' : ''}>Lanche</option>
            <option value="jantar" ${tipoValue === 'jantar' ? 'selected' : ''}>Jantar</option>
        </select>
    `;
    
    // Valor
    const valorCell = row.querySelector('.valor-registro');
    const valorAtual = valorCell.textContent.replace('R$ ', '').replace(',', '.');
    valorCell.innerHTML = `<input type="number" class="form-control form-control-sm" step="0.01" value="${valorAtual}" id="edit-valor-${id}">`;
    
    // Observações
    const obsCell = row.querySelector('.observacoes-registro');
    const obsAtual = obsCell.textContent === '-' ? '' : obsCell.textContent;
    obsCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${obsAtual}" id="edit-obs-${id}" placeholder="Observações">`;
    
    // Botões de ação
    const actionsCell = row.querySelector('td:last-child');
    actionsCell.innerHTML = `
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success" onclick="salvarEdicao(${id})">
                <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-secondary" onclick="cancelarEdicao(${id})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
}

function salvarEdicao(id) {
    const row = document.getElementById(`registro-${id}`);
    
    const dados = {
        data: document.getElementById(`edit-data-${id}`).value,
        tipo: document.getElementById(`edit-tipo-${id}`).value,
        valor: document.getElementById(`edit-valor-${id}`).value,
        observacoes: document.getElementById(`edit-obs-${id}`).value
    };
    
    // Enviar para o servidor
    fetch(`/alimentacao/editar/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar a linha com os novos dados
            atualizarLinhaTabela(row, dados);
            registroEditandoId = null;
            delete dadosOriginais[id];
            
            // Mostrar mensagem de sucesso
            showToast('Registro atualizado com sucesso!', 'success');
        } else {
            showToast('Erro ao atualizar registro: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro de conexão', 'error');
    });
}

function cancelarEdicao(id) {
    const row = document.getElementById(`registro-${id}`);
    const original = dadosOriginais[id];
    
    if (original) {
        // Restaurar dados originais
        row.querySelector('.data-registro').textContent = original.data;
        row.querySelector('.tipo-refeicao').innerHTML = obterBadgeTipo(original.tipo);
        row.querySelector('.valor-registro').textContent = original.valor;
        row.querySelector('.observacoes-registro').textContent = original.observacoes;
        
        // Restaurar botões
        row.querySelector('td:last-child').innerHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary btn-editar" onclick="editarRegistroInline(${id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="excluirRegistro(${id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }
    
    registroEditandoId = null;
    delete dadosOriginais[id];
}

function atualizarLinhaTabela(row, dados) {
    // Data
    const dataFormatada = new Date(dados.data).toLocaleDateString('pt-BR');
    row.querySelector('.data-registro').textContent = dataFormatada;
    
    // Tipo
    row.querySelector('.tipo-refeicao').innerHTML = obterBadgeTipo(dados.tipo);
    
    // Valor
    const valorFormatado = parseFloat(dados.valor).toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    row.querySelector('.valor-registro').textContent = valorFormatado;
    
    // Observações
    row.querySelector('.observacoes-registro').textContent = dados.observacoes || '-';
    
    // Restaurar botões
    row.querySelector('td:last-child').innerHTML = `
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-editar" onclick="editarRegistroInline(${row.dataset.registroId})">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="excluirRegistro(${row.dataset.registroId})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
}

function obterBadgeTipo(tipo) {
    if (typeof tipo === 'string') {
        if (tipo.includes('Café')) return '<span class="badge bg-warning">Café da Manhã</span>';
        if (tipo.includes('Almoço')) return '<span class="badge bg-success">Almoço</span>';
        if (tipo.includes('Jantar')) return '<span class="badge bg-primary">Jantar</span>';
        return '<span class="badge bg-secondary">Lanche</span>';
    }
    
    const badges = {
        'cafe': '<span class="badge bg-warning">Café da Manhã</span>',
        'almoco': '<span class="badge bg-success">Almoço</span>',
        'jantar': '<span class="badge bg-primary">Jantar</span>',
        'lanche': '<span class="badge bg-secondary">Lanche</span>'
    };
    return badges[tipo] || '<span class="badge bg-secondary">Lanche</span>';
}

function excluirRegistro(id) {
    if (confirm('Tem certeza que deseja excluir este registro?')) {
        fetch(`/alimentacao/excluir/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`registro-${id}`).remove();
                showToast('Registro excluído com sucesso!', 'success');
            } else {
                showToast('Erro ao excluir registro: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro de conexão', 'error');
        });
    }
}

function showToast(message, type = 'info') {
    // Criar toast simples
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Interceptar submit do formulário para enviar funcionários selecionados
document.getElementById('alimentacaoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btnSalvar = document.getElementById('btnSalvar');
    
    // Desabilitar botão durante envio
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
    
    fetch("{{ url_for('main.nova_alimentacao') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar modal e recarregar página
            $('#alimentacaoModal').modal('hide');
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar registros');
    })
    .finally(() => {
        // Reabilitar botão
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Lançamentos';
    });
});

// ================== EDIÇÃO INLINE ==================
function editarRegistroInline(id) {
    const row = document.getElementById(`registro-${id}`);
    if (!row) return;
    
    // Pegar dados originais
    const originalData = {
        data: row.querySelector('.data-registro').textContent,
        funcionario: row.querySelector('.funcionario-nome').textContent.trim().split('\n')[0],
        tipo: row.querySelector('.tipo-refeicao .badge').textContent,
        valor: row.querySelector('.valor-registro').textContent.replace('R$ ', '').replace(',', '.'),
        obra: row.querySelector('.obra-nome').textContent,
        observacoes: row.querySelector('.observacoes-registro').textContent
    };
    
    // Substituir células por inputs
    row.innerHTML = `
        <td>
            <strong>${originalData.funcionario}</strong>
            <br><small class="text-muted">Editando...</small>
        </td>
        <td>
            <input type="date" class="form-control form-control-sm" value="${convertDateToInput(originalData.data)}" id="edit-data-${id}">
        </td>
        <td>
            <select class="form-select form-select-sm" id="edit-tipo-${id}">
                <option value="cafe" ${getTipoFromBadge(originalData.tipo) === 'cafe' ? 'selected' : ''}>Café da Manhã</option>
                <option value="almoco" ${getTipoFromBadge(originalData.tipo) === 'almoco' ? 'selected' : ''}>Almoço</option>
                <option value="jantar" ${getTipoFromBadge(originalData.tipo) === 'jantar' ? 'selected' : ''}>Jantar</option>
                <option value="lanche" ${getTipoFromBadge(originalData.tipo) === 'lanche' ? 'selected' : ''}>Lanche</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" step="0.01" value="${originalData.valor}" id="edit-valor-${id}" placeholder="0.00">
        </td>
        <td>${originalData.obra}</td>
        <td>-</td>
        <td>
            <input type="text" class="form-control form-control-sm" value="${originalData.observacoes === '-' ? '' : originalData.observacoes}" id="edit-obs-${id}" placeholder="Observações">
        </td>
        <td>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-success" onclick="salvarEdicaoInline(${id})" title="Salvar alterações">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-secondary" onclick="cancelarEdicaoInline(${id})" title="Cancelar edição">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
    `;
}

function getTipoFromBadge(badgeText) {
    const tipos = {
        'Café da Manhã': 'cafe',
        'Almoço': 'almoco', 
        'Jantar': 'jantar',
        'Lanche': 'lanche'
    };
    return tipos[badgeText] || 'almoco';
}

function convertDateToInput(dateStr) {
    // Converter de dd/mm/yyyy para yyyy-mm-dd
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    }
    return dateStr;
}

function salvarEdicaoInline(id) {
    const data = document.getElementById(`edit-data-${id}`).value;
    const tipo = document.getElementById(`edit-tipo-${id}`).value;
    const valor = document.getElementById(`edit-valor-${id}`).value;
    const observacoes = document.getElementById(`edit-obs-${id}`).value;
    
    // Validações básicas
    if (!data || !valor) {
        showToast('Preencha todos os campos obrigatórios', 'error');
        return;
    }
    
    // Enviar dados
    const formData = new FormData();
    formData.append('data', data);
    formData.append('tipo', tipo);
    formData.append('valor', valor);
    formData.append('observacoes', observacoes);
    
    fetch(`/alimentacao/${id}/editar`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Registro atualizado com sucesso!', 'success');
            // Recarregar a página após 1 segundo
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Erro ao salvar: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro de conexão', 'error');
    });
}

function cancelarEdicaoInline(id) {
    // Recarregar página para cancelar edição
    location.reload();
}

function excluirRegistro(id) {
    if (confirm('Tem certeza que deseja excluir este registro?')) {
        fetch(`/alimentacao/${id}/excluir`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Registro excluído com sucesso!', 'success');
                document.getElementById(`registro-${id}`).remove();
            } else {
                showToast('Erro ao excluir: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro de conexão', 'error');
        });
    }
}

// ================== FILTROS RÁPIDOS ==================
function aplicarFiltros() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const funcionarioId = document.getElementById('filtroFuncionario').value;
    
    // Construir URL com parâmetros
    let url = '/alimentacao?';
    const params = [];
    
    if (dataInicio) params.push(`data_inicio=${dataInicio}`);
    if (dataFim) params.push(`data_fim=${dataFim}`);
    if (funcionarioId) params.push(`funcionario_id=${funcionarioId}`);
    
    url += params.join('&');
    window.location.href = url;
}

function limparFiltros() {
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('filtroFuncionario').value = '';
    window.location.href = '/alimentacao';
}

// Filtros por período
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para botões de período
    document.querySelectorAll('.filtro-periodo').forEach(btn => {
        btn.addEventListener('click', function() {
            const periodo = this.getAttribute('data-periodo');
            const hoje = new Date();
            let dataInicio, dataFim;
            
            // Remover active de outros botões
            document.querySelectorAll('.filtro-periodo').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            switch(periodo) {
                case 'hoje':
                    dataInicio = dataFim = hoje.toISOString().split('T')[0];
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoje);
                    inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                    dataInicio = inicioSemana.toISOString().split('T')[0];
                    dataFim = hoje.toISOString().split('T')[0];
                    break;
                case 'mes':
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                    dataFim = hoje.toISOString().split('T')[0];
                    break;
                case 'todos':
                    dataInicio = dataFim = '';
                    break;
            }
            
            // Atualizar campos
            document.getElementById('dataInicio').value = dataInicio;
            document.getElementById('dataFim').value = dataFim;
            
            // Aplicar filtro automaticamente
            if (periodo !== 'todos') {
                aplicarFiltros();
            } else {
                limparFiltros();
            }
        });
    });
    
    console.log('✅ Sistema de filtros e edição inline carregado');
});
</script>

{% endblock %}
