{% extends "base.html" %}
{% block title %}Nova Proposta - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus me-2"></i> Nova Proposta Comercial</h5>
        </div>
        <div class="card-body">
            <form method="POST" id="formNovaProposta">
                <div class="row">
                    <!-- Dados do Cliente -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Dados do Cliente</h6>
                        <div class="mb-3">
                            <label class="form-label">Nome do Cliente *</label>
                            <input type="text" class="form-control" name="cliente_nome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="cliente_email" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" name="cliente_telefone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">CPF/CNPJ</label>
                                    <input type="text" class="form-control" name="cliente_cpf_cnpj">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dados da Obra -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Dados da Obra</h6>
                        <div class="mb-3">
                            <label class="form-label">Endereço da Obra *</label>
                            <textarea class="form-control" name="endereco_obra" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição da Obra *</label>
                            <textarea class="form-control" name="descricao_obra" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Área Total (m²)</label>
                                    <input type="number" class="form-control" name="area_total_m2" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Prazo (dias)</label>
                                    <input type="number" class="form-control" name="prazo_execucao" value="30">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seleção de Template -->
                <hr>
                <div class="mb-4">
                    <h6 class="text-primary mb-3">Template de Proposta</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Selecionar Template (opcional)</label>
                                <select class="form-select" id="templateSelect" onchange="carregarTemplate()">
                                    <option value="">Criar proposta do zero</option>
                                    {% for template in templates %}
                                    <option value="{{ template.id }}" 
                                            data-categoria="{{ template.categoria }}"
                                            data-prazo="{{ template.prazo_entrega_dias }}">
                                        {{ template.nome }} ({{ template.categoria }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="templateInfo" class="alert alert-info" style="display: none;">
                                <h6 class="mb-2">Template Selecionado:</h6>
                                <p class="mb-1"><strong>Nome:</strong> <span id="templateNome"></span></p>
                                <p class="mb-1"><strong>Categoria:</strong> <span id="templateCategoria"></span></p>
                                <p class="mb-0"><strong>Prazo Padrão:</strong> <span id="templatePrazo"></span> dias</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="carregarTemplate()" id="btnCarregarTemplate" disabled>
                            <i class="fas fa-download"></i> Carregar Serviços do Template
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="limparServicos()">
                            <i class="fas fa-broom"></i> Limpar Todos os Serviços
                        </button>
                    </div>
                </div>

                <!-- Serviços -->
                <h6 class="text-primary mb-3">Serviços</h6>
                <div id="servicosContainer">
                    <div class="servico-item border rounded p-3 mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Descrição do Serviço</label>
                                    <input type="text" class="form-control servico-descricao" 
                                           placeholder="Ex: Estrutura metálica">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control servico-quantidade" 
                                           step="0.01" onchange="calcularServico(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Unidade</label>
                                    <select class="form-select servico-unidade">
                                        <option value="m²">m²</option>
                                        <option value="m³">m³</option>
                                        <option value="un">Unidade</option>
                                        <option value="kg">kg</option>
                                        <option value="t">Tonelada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Valor Unitário</label>
                                    <input type="number" class="form-control servico-valor-unitario" 
                                           step="0.01" onchange="calcularServico(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Total</label>
                                    <input type="text" class="form-control servico-total" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control servico-observacoes" rows="2"></textarea>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="adicionarServico()">
                        <i class="fas fa-plus"></i> Adicionar Serviço
                    </button>
                    <div class="text-end">
                        <h5>Total da Proposta: <span id="totalProposta">R$ 0,00</span></h5>
                    </div>
                </div>

                <!-- Campos Adicionais da Proposta -->
                <hr>
                <h6 class="text-primary mb-3">Detalhes da Proposta</h6>
                
                <div class="row">
                    <!-- Itens Inclusos -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Itens Inclusos</label>
                            <textarea class="form-control" name="itens_inclusos" rows="4" 
                                      placeholder="Ex: Material, Mão de obra, Projeto, etc."></textarea>
                        </div>
                    </div>
                    
                    <!-- Itens Exclusos -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Itens Exclusos</label>
                            <textarea class="form-control" name="itens_exclusos" rows="4" 
                                      placeholder="Ex: Fundação, Instalações elétricas, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Condições -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Condições</label>
                            <textarea class="form-control" name="condicoes" rows="3" 
                                      placeholder="Ex: Terreno nivelado, acesso facilitado, etc."></textarea>
                        </div>
                    </div>
                    
                    <!-- Condições de Pagamento -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Condições de Pagamento</label>
                            <textarea class="form-control" name="condicoes_pagamento" rows="3" 
                                      placeholder="Ex: 30% entrada, 70% na entrega"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Garantias -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Garantias</label>
                            <textarea class="form-control" name="garantias" rows="3" 
                                      placeholder="Ex: 1 ano contra defeitos de fabricação"></textarea>
                        </div>
                    </div>
                    
                    <!-- Prazo e Validade -->
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Prazo Entrega (dias)</label>
                                    <input type="number" class="form-control" name="prazo_entrega_dias" value="90">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Validade (dias)</label>
                                    <input type="number" class="form-control" name="validade_dias" value="7">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">% Nota Fiscal</label>
                            <input type="number" class="form-control" name="percentual_nota_fiscal" 
                                   step="0.1" value="13.5">
                        </div>
                    </div>
                </div>

                <!-- Valor Manual (alternativo) -->
                <div class="mb-3">
                    <label class="form-label">Valor Total Manual (opcional)</label>
                    <input type="number" class="form-control" name="valor_proposta" 
                           step="0.01" placeholder="Use este campo se não detalhar os serviços">
                </div>

                <input type="hidden" name="servicos_json" id="servicosJson">

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('main.propostas') }}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-success">Criar Proposta</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function adicionarServico() {
    const container = document.getElementById('servicosContainer');
    const novoServico = container.firstElementChild.cloneNode(true);
    
    // Limpar valores
    novoServico.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.type !== 'hidden') field.value = '';
    });
    
    container.appendChild(novoServico);
}

function removerServico(btn) {
    const container = document.getElementById('servicosContainer');
    if (container.children.length > 1) {
        btn.closest('.servico-item').remove();
        calcularTotal();
    }
}

function calcularServico(input) {
    const servicoItem = input.closest('.servico-item');
    const quantidade = parseFloat(servicoItem.querySelector('.servico-quantidade').value) || 0;
    const valorUnitario = parseFloat(servicoItem.querySelector('.servico-valor-unitario').value) || 0;
    const total = quantidade * valorUnitario;
    
    servicoItem.querySelector('.servico-total').value = 'R$ ' + total.toFixed(2).replace('.', ',');
    calcularTotal();
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.servico-item').forEach(item => {
        const quantidade = parseFloat(item.querySelector('.servico-quantidade').value) || 0;
        const valorUnitario = parseFloat(item.querySelector('.servico-valor-unitario').value) || 0;
        total += quantidade * valorUnitario;
    });
    
    document.getElementById('totalProposta').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    document.querySelector('input[name="valor_proposta"]').value = total.toFixed(2);
}

function coletarServicos() {
    const servicos = [];
    document.querySelectorAll('.servico-item').forEach(item => {
        const descricao = item.querySelector('.servico-descricao').value;
        const quantidade = item.querySelector('.servico-quantidade').value;
        const valorUnitario = item.querySelector('.servico-valor-unitario').value;
        
        if (descricao && quantidade && valorUnitario) {
            servicos.push({
                descricao: descricao,
                quantidade: parseFloat(quantidade),
                unidade: item.querySelector('.servico-unidade').value,
                valor_unitario: parseFloat(valorUnitario),
                observacoes: item.querySelector('.servico-observacoes').value
            });
        }
    });
    
    document.getElementById('servicosJson').value = JSON.stringify(servicos);
}

document.getElementById('formNovaProposta').addEventListener('submit', function(e) {
    coletarServicos();
});

// Funções para templates
function carregarTemplate() {
    const select = document.getElementById('templateSelect');
    const templateId = select.value;
    const btnCarregar = document.getElementById('btnCarregarTemplate');
    const info = document.getElementById('templateInfo');
    
    if (!templateId) {
        info.style.display = 'none';
        btnCarregar.disabled = true;
        return;
    }
    
    // Mostrar informações do template
    const option = select.selectedOptions[0];
    document.getElementById('templateNome').textContent = option.text.split(' (')[0];
    document.getElementById('templateCategoria').textContent = option.dataset.categoria;
    document.getElementById('templatePrazo').textContent = option.dataset.prazo;
    info.style.display = 'block';
    btnCarregar.disabled = false;
    
    // Carregar serviços do template
    carregarServicosTemplate(templateId);
}

function carregarServicosTemplate(templateId) {
    fetch(`/propostas/api/template/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Limpar serviços existentes
                limparServicos();
                
                // Carregar serviços do template
                const itens = data.template.itens_padrao || [];
                if (itens.length > 0) {
                    itens.forEach((item, index) => {
                        if (index > 0) {
                            adicionarServico();
                        }
                        
                        const servicoItems = document.querySelectorAll('.servico-item');
                        const servicoAtual = servicoItems[index];
                        
                        servicoAtual.querySelector('.servico-descricao').value = item.descricao;
                        servicoAtual.querySelector('.servico-quantidade').value = item.quantidade;
                        servicoAtual.querySelector('.servico-unidade').value = item.unidade;
                        servicoAtual.querySelector('.servico-valor-unitario').value = item.preco_unitario;
                        
                        calcularServico(servicoAtual.querySelector('.servico-quantidade'));
                    });
                    
                    // Carregar campos adicionais do template
                    const template = data.template;
                    
                    // Atualizar prazo se disponível
                    if (template.prazo_entrega_dias) {
                        document.querySelector('input[name="prazo_entrega_dias"]').value = template.prazo_entrega_dias;
                    }
                    
                    // Carregar itens inclusos
                    if (template.itens_inclusos) {
                        document.querySelector('textarea[name="itens_inclusos"]').value = template.itens_inclusos;
                    }
                    
                    // Carregar itens exclusos
                    if (template.itens_exclusos) {
                        document.querySelector('textarea[name="itens_exclusos"]').value = template.itens_exclusos;
                    }
                    
                    // Carregar condições
                    if (template.condicoes) {
                        document.querySelector('textarea[name="condicoes"]').value = template.condicoes;
                    }
                    
                    // Carregar condições de pagamento
                    if (template.condicoes_pagamento) {
                        document.querySelector('textarea[name="condicoes_pagamento"]').value = template.condicoes_pagamento;
                    }
                    
                    // Carregar garantias
                    if (template.garantias) {
                        document.querySelector('textarea[name="garantias"]').value = template.garantias;
                    }
                    
                    // Carregar validade
                    if (template.validade_dias) {
                        document.querySelector('input[name="validade_dias"]').value = template.validade_dias;
                    }
                    
                    // Carregar percentual nota fiscal
                    if (template.percentual_nota_fiscal) {
                        document.querySelector('input[name="percentual_nota_fiscal"]').value = template.percentual_nota_fiscal;
                    }
                    
                    alert(`Template "${template.nome}" carregado com ${itens.length} serviços e campos preenchidos!`);
                } else {
                    alert('Template carregado mas não possui serviços cadastrados.');
                }
            } else {
                alert('Erro ao carregar template: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar template.');
        });
}

function limparServicos() {
    const container = document.getElementById('servicosContainer');
    container.innerHTML = `
        <div class="servico-item border rounded p-3 mb-3">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Descrição do Serviço</label>
                        <input type="text" class="form-control servico-descricao" 
                               placeholder="Ex: Estrutura metálica">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control servico-quantidade" 
                               step="0.01" onchange="calcularServico(this)">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Unidade</label>
                        <select class="form-select servico-unidade">
                            <option value="m²">m²</option>
                            <option value="m³">m³</option>
                            <option value="un">Unidade</option>
                            <option value="kg">kg</option>
                            <option value="t">Tonelada</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Valor Unitário</label>
                        <input type="number" class="form-control servico-valor-unitario" 
                               step="0.01" onchange="calcularServico(this)">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <input type="text" class="form-control servico-total" readonly>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Observações</label>
                <textarea class="form-control servico-observacoes" rows="2"></textarea>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
    `;
    calcularTotal();
}
</script>
{% endblock %}