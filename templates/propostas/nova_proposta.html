{% extends "base.html" %}
{% block title %}Nova Proposta - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i> Nova Proposta Comercial</h5>
                    {% if config_empresa %}
                    <small class="text-muted">{{ config_empresa.nome_empresa }}</small>
                    {% else %}
                    <small class="text-warning">⚠️ Configure os dados da empresa em <a href="{{ url_for('configuracoes.empresa') }}">Configurações</a></small>
                    {% endif %}
                </div>
                <a href="{{ url_for('configuracoes.empresa') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-cog me-1"></i> Configurar Empresa
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('propostas.criar_proposta') }}" id="formNovaProposta">
                <div class="row">
                    <!-- Dados do Cliente -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Dados do Cliente</h6>
                        <div class="mb-3">
                            <label class="form-label">Nome do Cliente *</label>
                            <input type="text" class="form-control" name="cliente_nome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="cliente_email">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" name="cliente_telefone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">CPF/CNPJ</label>
                                    <input type="text" class="form-control" name="cliente_cpf_cnpj">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dados da Obra -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Dados da Obra</h6>
                        <div class="mb-3">
                            <label class="form-label">Número da Proposta *</label>
                            <input type="text" class="form-control" name="numero_proposta" placeholder="Ex: 001.25" required>
                            <small class="text-muted">Defina um número único para esta proposta</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assunto da Proposta</label>
                            <input type="text" class="form-control" name="assunto" placeholder="Ex: Estrutura Metálica Residencial">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Objeto/Descrição da Obra</label>
                            <textarea class="form-control" name="objeto" rows="3" placeholder="Descreva os serviços a serem executados..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Endereço da Obra</label>
                            <textarea class="form-control" name="endereco_obra" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Área Total (m²)</label>
                                    <input type="number" class="form-control" name="area_total_m2" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Prazo (dias)</label>
                                    <input type="number" class="form-control" name="prazo_execucao" value="30">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seleção de Template -->
                <hr>
                <div class="mb-4">
                    <h6 class="text-primary mb-3">Template de Proposta</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Selecionar Template (opcional)</label>
                                <select class="form-select" id="templateSelect" onchange="carregarTemplate()">
                                    <option value="">Criar proposta do zero</option>
                                    {% for template in templates %}
                                    <option value="{{ template.id }}" 
                                            data-categoria="{{ template.categoria }}"
                                            data-prazo="{{ template.prazo_entrega_dias }}">
                                        {{ template.nome }} ({{ template.categoria }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="templateInfo" class="alert alert-info" style="display: none;">
                                <h6 class="mb-2">Template Selecionado:</h6>
                                <p class="mb-1"><strong>Nome:</strong> <span id="templateNome"></span></p>
                                <p class="mb-1"><strong>Categoria:</strong> <span id="templateCategoria"></span></p>
                                <p class="mb-0"><strong>Prazo Padrão:</strong> <span id="templatePrazo"></span> dias</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="carregarTemplate()" id="btnCarregarTemplate" disabled>
                            <i class="fas fa-download"></i> Carregar Serviços do Template
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="limparServicos()">
                            <i class="fas fa-broom"></i> Limpar Todos os Serviços
                        </button>
                    </div>
                </div>

                <!-- Serviços -->
                <h6 class="text-primary mb-3">Serviços</h6>
                <div id="servicosContainer">
                    <div class="servico-item border rounded p-3 mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Descrição do Serviço</label>
                                    <input type="text" class="form-control servico-descricao" 
                                           name="item_descricao" placeholder="Ex: Estrutura metálica">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control servico-quantidade" 
                                           name="item_quantidade" step="0.01" onchange="calcularServico(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Unidade</label>
                                    <select class="form-select servico-unidade" name="item_unidade">
                                        <option value="m²">m²</option>
                                        <option value="m³">m³</option>
                                        <option value="un">Unidade</option>
                                        <option value="kg">kg</option>
                                        <option value="t">Tonelada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Valor Unitário</label>
                                    <input type="number" class="form-control servico-valor-unitario" 
                                           name="item_preco" step="0.01" onchange="calcularServico(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Total</label>
                                    <input type="text" class="form-control servico-total" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control servico-observacoes" rows="2"></textarea>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="adicionarServico()">
                        <i class="fas fa-plus"></i> Adicionar Serviço
                    </button>
                    <div class="text-end">
                        <h5>Total da Proposta: <span id="totalProposta">R$ 0,00</span></h5>
                    </div>
                </div>

                <!-- Campos Adicionais da Proposta -->
                <hr>
                <h6 class="text-primary mb-3">Detalhes da Proposta</h6>
                
                <!-- Seletor de Template -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-primary mb-0">Pré-carregar Campos do Template</h6>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="seletorTemplate" style="width: 300px;">
                                    <option value="">Selecione um template para pré-carregar...</option>
                                    {% for template in templates %}
                                    <option value="{{ template.id }}">{{ template.nome }} ({{ template.categoria }})</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary" onclick="carregarTemplate()">
                                    <i class="fas fa-download me-1"></i> Carregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Itens Inclusos -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Itens Inclusos no Fornecimento</label>
                            <textarea class="form-control" name="itens_inclusos" id="itensInclusos" rows="5" 
                                      placeholder="Mão de obra para execução dos serviços; Todos os equipamentos de segurança necessários; Transporte e alimentação da equipe">{{ padrao_itens_inclusos or '' }}</textarea>
                            <small class="text-muted">Separe os itens com ponto e vírgula (;) ou vírgula (,)</small>
                        </div>
                    </div>
                    
                    <!-- Itens Exclusos -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Itens Exclusos do Fornecimento</label>
                            <textarea class="form-control" name="itens_exclusos" id="itensExclusos" rows="5" 
                                      placeholder="Projeto e execução de qualquer obra civil; Fornecimento de local para armazenagem; Pintura final">{{ padrao_itens_exclusos or '' }}</textarea>
                            <small class="text-muted">Separe os itens com ponto e vírgula (;) ou vírgula (,)</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Condições -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Considerações Gerais</label>
                            <textarea class="form-control" name="condicoes" id="condicoes" rows="4" 
                                      placeholder="Proposta válida por X dias; Valores não incluem impostos; Execução conforme normas técnicas">{{ padrao_condicoes or '' }}</textarea>
                        </div>
                    </div>
                    
                    <!-- Condições de Pagamento -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Condições de Pagamento</label>
                            <textarea class="form-control" name="condicoes_pagamento" id="condicoesPagamento" rows="4" 
                                      placeholder="10% entrada; 45% compra dos perfis; 35% montagem; 10% conclusão">{{ padrao_condicoes_pagamento or '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Garantias -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Garantias</label>
                            <textarea class="form-control" name="garantias" id="garantias" rows="3" 
                                      placeholder="12 meses contra defeitos de fabricação conforme NBR 8800">{{ padrao_garantias or '' }}</textarea>
                        </div>
                    </div>
                    
                    <!-- Prazo e Validade -->
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Prazo Entrega (dias)</label>
                                    <input type="number" class="form-control" name="prazo_entrega_dias" id="prazoEntrega" value="{{ padrao_prazo_entrega or 90 }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Validade (dias)</label>
                                    <input type="number" class="form-control" name="validade_dias" id="validadeDias" value="{{ padrao_validade or 7 }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOVOS CAMPOS EDITÁVEIS - PRIMEIRA E SEGUNDA PÁGINA DO PDF -->
                <hr class="my-4">
                <h6 class="text-primary mb-3">Conteúdo da Carta de Apresentação (Página 1)</h6>
                
                <div class="row">
                    <!-- Abertura da carta -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Abertura da Carta</label>
                            <textarea class="form-control" name="carta_abertura" id="cartaAbertura" rows="4" 
                                      placeholder="Prezado(a) cliente, apresentamos nossa proposta comercial...">Prezado(a) cliente,

Apresentamos nossa proposta comercial para o fornecimento e montagem de estrutura metálica conforme solicitação.</textarea>
                        </div>
                    </div>
                    
                    <!-- Apresentação da empresa -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Apresentação da Empresa</label>
                            <textarea class="form-control" name="apresentacao_empresa" id="apresentacaoEmpresa" rows="4" 
                                      placeholder="A Estruturas do Vale atua há X anos no mercado...">A Estruturas do Vale atua no mercado de estruturas metálicas com tradição em qualidade e pontualidade, oferecendo soluções completas em engenharia estrutural.</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Descrição do projeto -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Descrição do Projeto</label>
                            <textarea class="form-control" name="descricao_projeto" id="descricaoProjeto" rows="4" 
                                      placeholder="O projeto contempla a execução de...">O projeto contempla a execução de estrutura metálica conforme projeto anexo, incluindo todos os detalhes construtivos e especificações técnicas necessárias.</textarea>
                        </div>
                    </div>
                    
                    <!-- Fechamento da carta -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fechamento da Carta</label>
                            <textarea class="form-control" name="carta_fechamento" id="cartaFechamento" rows="4" 
                                      placeholder="Permanecemos à disposição para esclarecimentos...">Permanecemos à disposição para esclarecimentos adicionais e aguardamos sua aprovação.

Atenciosamente,
Equipe Estruturas do Vale</textarea>
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <h6 class="text-primary mb-3">Conteúdo Técnico das Seções (Páginas 3-9)</h6>
                
                <div class="row">
                    <!-- Seção 1: Especificações Técnicas -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">1. Especificações Técnicas</label>
                            <textarea class="form-control" name="secao_especificacoes" id="secaoEspecificacoes" rows="5" 
                                      placeholder="Estrutura em aço carbono conforme NBR 8800...">• Estrutura em aço carbono ASTM A36 ou similar
• Soldas executadas conforme AWS D1.1
• Parafusos de alta resistência ASTM A325
• Tratamento superficial: jateamento SA 2½
• Pintura de proteção: primer + esmalte sintético</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 2: Materiais e Componentes -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">2. Materiais e Componentes</label>
                            <textarea class="form-control" name="secao_materiais" id="secaoMateriais" rows="5" 
                                      placeholder="Perfis laminados, chapas, conectores...">• Perfis laminados conforme catálogo Gerdau
• Chapas de aço carbono SAE 1020
• Conectores e parafusos galvanizados
• Eletrodos AWS E70XX para soldagem
• Tintas e primers de primeira qualidade</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 3: Processo de Fabricação -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">3. Processo de Fabricação</label>
                            <textarea class="form-control" name="secao_fabricacao" id="secaoFabricacao" rows="5" 
                                      placeholder="Corte, dobra, soldagem e montagem...">• Corte em guilhotina e plasma CNC
• Dobra em prensa hidráulica
• Soldagem com processo MIG/MAG
• Montagem e pré-montagem em fábrica
• Controle de qualidade em todas as etapas</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 4: Logística e Transporte -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">4. Logística e Transporte</label>
                            <textarea class="form-control" name="secao_logistica" id="secaoLogistica" rows="5" 
                                      placeholder="Transporte especializado, equipamentos...">• Transporte com veículos especializados
• Equipamentos de movimentação (Munck)
• Cronograma de entregas programadas
• Armazenamento temporário se necessário
• Coordenação com cronograma da obra</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 5: Montagem e Instalação -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">5. Montagem e Instalação</label>
                            <textarea class="form-control" name="secao_montagem" id="secaoMontagem" rows="5" 
                                      placeholder="Equipe especializada, equipamentos de içamento...">• Equipe técnica especializada
• Equipamentos de içamento adequados
• Procedimentos de segurança rigorosos
• Supervisão técnica permanente
• Relatórios diários de progresso</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 6: Controle de Qualidade -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">6. Controle de Qualidade</label>
                            <textarea class="form-control" name="secao_qualidade" id="secaoQualidade" rows="5" 
                                      placeholder="Inspeções, testes, certificações...">• Inspeção dimensional rigorosa
• Testes de soldagem conforme norma
• Verificação de prumo e nível
• Documentação fotográfica completa
• Certificados de conformidade</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 7: Segurança e Meio Ambiente -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">7. Segurança e Meio Ambiente</label>
                            <textarea class="form-control" name="secao_seguranca" id="secaoSeguranca" rows="5" 
                                      placeholder="EPIs, procedimentos de segurança...">• Fornecimento de EPIs completos
• Procedimentos de segurança rigorosos
• Gestão de resíduos responsável
• Treinamentos de segurança da equipe
• Cumprimento das NRs aplicáveis</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 8: Assistência Técnica -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">8. Assistência Técnica</label>
                            <textarea class="form-control" name="secao_assistencia" id="secaoAssistencia" rows="5" 
                                      placeholder="Suporte pós-entrega, manutenção...">• Suporte técnico pós-entrega
• Manual de manutenção detalhado
• Atendimento para dúvidas técnicas
• Garantia de 12 meses
• Visitas de acompanhamento</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 9: Considerações Finais -->
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">9. Considerações Finais</label>
                            <textarea class="form-control" name="secao_consideracoes" id="secaoConsideracoes" rows="4" 
                                      placeholder="Agradecimentos, disponibilidade para esclarecimentos...">Agradecemos a oportunidade de apresentar nossa proposta e reafirmamos nosso compromisso com a qualidade e pontualidade na execução dos serviços. Nossa equipe permanece à disposição para esclarecimentos adicionais e adequações que se fizerem necessárias.</textarea>
                        </div>
                    </div>
                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Validade (dias)</label>
                                    <input type="number" class="form-control" name="validade_dias" id="validade" value="{{ padrao_validade or 7 }}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">% Nota Fiscal</label>
                            <input type="number" class="form-control" name="percentual_nota_fiscal" id="percentualNF"
                                   step="0.1" value="{{ padrao_percentual_nf or 13.5 }}">
                        </div>
                    </div>
                </div>

                <!-- Valor Manual (alternativo) -->
                <div class="mb-3">
                    <label class="form-label">Valor Total Manual (opcional)</label>
                    <input type="number" class="form-control" name="valor_proposta" 
                           step="0.01" placeholder="Use este campo se não detalhar os serviços">
                </div>

                <input type="hidden" name="servicos_json" id="servicosJson">

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('propostas.index') }}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-success">Criar Proposta</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function adicionarServico() {
    const container = document.getElementById('servicosContainer');
    const novoServico = container.firstElementChild.cloneNode(true);
    
    // Limpar valores e garantir que os campos tenham os nomes corretos
    novoServico.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.type !== 'hidden') field.value = '';
        
        // Garantir que os campos tenham os nomes corretos
        if (field.classList.contains('servico-descricao')) {
            field.name = 'item_descricao';
        } else if (field.classList.contains('servico-quantidade')) {
            field.name = 'item_quantidade';
        } else if (field.classList.contains('servico-unidade')) {
            field.name = 'item_unidade';
        } else if (field.classList.contains('servico-valor-unitario')) {
            field.name = 'item_preco';
        }
    });
    
    container.appendChild(novoServico);
}

function removerServico(btn) {
    const container = document.getElementById('servicosContainer');
    if (container.children.length > 1) {
        btn.closest('.servico-item').remove();
        calcularTotal();
    }
}

function calcularServico(input) {
    const servicoItem = input.closest('.servico-item');
    const quantidade = parseFloat(servicoItem.querySelector('.servico-quantidade').value) || 0;
    const valorUnitario = parseFloat(servicoItem.querySelector('.servico-valor-unitario').value) || 0;
    const total = quantidade * valorUnitario;
    
    servicoItem.querySelector('.servico-total').value = 'R$ ' + total.toFixed(2).replace('.', ',');
    calcularTotal();
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.servico-item').forEach(item => {
        const quantidade = parseFloat(item.querySelector('.servico-quantidade').value) || 0;
        const valorUnitario = parseFloat(item.querySelector('.servico-valor-unitario').value) || 0;
        total += quantidade * valorUnitario;
    });
    
    document.getElementById('totalProposta').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    document.querySelector('input[name="valor_proposta"]').value = total.toFixed(2);
}

function coletarServicos() {
    const servicos = [];
    document.querySelectorAll('.servico-item').forEach(item => {
        const descricao = item.querySelector('.servico-descricao').value;
        const quantidade = item.querySelector('.servico-quantidade').value;
        const valorUnitario = item.querySelector('.servico-valor-unitario').value;
        
        if (descricao && quantidade && valorUnitario) {
            servicos.push({
                descricao: descricao,
                quantidade: parseFloat(quantidade),
                unidade: item.querySelector('.servico-unidade').value,
                valor_unitario: parseFloat(valorUnitario),
                observacoes: item.querySelector('.servico-observacoes').value
            });
        }
    });
    
    document.getElementById('servicosJson').value = JSON.stringify(servicos);
}

document.getElementById('formNovaProposta').addEventListener('submit', function(e) {
    coletarServicos();
});

// Função para carregar template
function carregarTemplate() {
    const select = document.getElementById('seletorTemplate');
    const templateId = select.value;
    
    if (!templateId) {
        alert('Selecione um template primeiro.');
        return;
    }
    
    fetch(`/propostas/api/template/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Carregar campos do template
                document.getElementById('itensInclusos').value = data.itens_inclusos || '';
                document.getElementById('itensExclusos').value = data.itens_exclusos || '';
                document.getElementById('condicoes').value = data.condicoes || '';
                document.getElementById('condicoesPagamento').value = data.condicoes_pagamento || '';
                document.getElementById('garantias').value = data.garantias || '';
                document.getElementById('prazoEntrega').value = data.prazo_entrega_dias || 90;
                document.getElementById('validade').value = data.validade_dias || 7;
                document.getElementById('percentualNF').value = data.percentual_nota_fiscal || 13.5;
                
                alert(`Template "${data.nome}" carregado com sucesso!`);
            } else {
                alert('Erro ao carregar template: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar template.');
        });
}

function carregarServicosTemplate(templateId) {
    fetch(`/propostas/api/template/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Limpar serviços existentes
                limparServicos();
                
                // Carregar serviços do template
                const itens = data.template.itens_padrao || [];
                if (itens.length > 0) {
                    itens.forEach((item, index) => {
                        if (index > 0) {
                            adicionarServico();
                        }
                        
                        const servicoItems = document.querySelectorAll('.servico-item');
                        const servicoAtual = servicoItems[index];
                        
                        servicoAtual.querySelector('.servico-descricao').value = item.descricao;
                        servicoAtual.querySelector('.servico-quantidade').value = item.quantidade;
                        servicoAtual.querySelector('.servico-unidade').value = item.unidade;
                        servicoAtual.querySelector('.servico-valor-unitario').value = item.preco_unitario;
                        
                        calcularServico(servicoAtual.querySelector('.servico-quantidade'));
                    });
                    
                    // Recalcular total após carregar todos os serviços
                    calcularTotal();
                    
                    // Carregar campos adicionais do template
                    const template = data.template;
                    
                    // Carregar dados da empresa se disponível (prioridade)
                    {% if config_empresa %}
                    const configEmpresa = {
                        prazo_entrega_padrao: {{ config_empresa.prazo_entrega_padrao or 'null' }},
                        validade_padrao: {{ config_empresa.validade_padrao or 'null' }},
                        percentual_nota_fiscal_padrao: {{ config_empresa.percentual_nota_fiscal_padrao or 'null' }},
                        itens_inclusos_padrao: `{{ config_empresa.itens_inclusos_padrao or '' }}`,
                        itens_exclusos_padrao: `{{ config_empresa.itens_exclusos_padrao or '' }}`,
                        condicoes_padrao: `{{ config_empresa.condicoes_padrao or '' }}`,
                        condicoes_pagamento_padrao: `{{ config_empresa.condicoes_pagamento_padrao or '' }}`,
                        garantias_padrao: `{{ config_empresa.garantias_padrao or '' }}`
                    };
                    {% endif %}
                    
                    // Atualizar prazo (template ou config empresa)
                    const prazo = template.prazo_entrega_dias || {% if config_empresa %}configEmpresa.prazo_entrega_padrao{% else %}90{% endif %};
                    if (prazo) {
                        document.querySelector('input[name="prazo_entrega_dias"]').value = prazo;
                    }
                    
                    // Carregar itens inclusos (template ou config empresa)
                    const itensInclusos = template.itens_inclusos || {% if config_empresa %}`${configEmpresa.itens_inclusos_padrao}`{% else %}''{% endif %};
                    if (itensInclusos) {
                        document.querySelector('textarea[name="itens_inclusos"]').value = itensInclusos;
                    }
                    
                    // Carregar itens exclusos (template ou config empresa)
                    const itensExclusos = template.itens_exclusos || {% if config_empresa %}`${configEmpresa.itens_exclusos_padrao}`{% else %}''{% endif %};
                    if (itensExclusos) {
                        document.querySelector('textarea[name="itens_exclusos"]').value = itensExclusos;
                    }
                    
                    // Carregar condições (template ou config empresa)
                    const condicoes = template.condicoes || {% if config_empresa %}`${configEmpresa.condicoes_padrao}`{% else %}''{% endif %};
                    if (condicoes) {
                        document.querySelector('textarea[name="condicoes"]').value = condicoes;
                    }
                    
                    // Carregar condições de pagamento (template ou config empresa)
                    const condicoesPagamento = template.condicoes_pagamento || {% if config_empresa %}`${configEmpresa.condicoes_pagamento_padrao}`{% else %}''{% endif %};
                    if (condicoesPagamento) {
                        document.querySelector('textarea[name="condicoes_pagamento"]').value = condicoesPagamento;
                    }
                    
                    // Carregar garantias (template ou config empresa)
                    const garantias = template.garantias || {% if config_empresa %}`${configEmpresa.garantias_padrao}`{% else %}''{% endif %};
                    if (garantias) {
                        document.querySelector('textarea[name="garantias"]').value = garantias;
                    }
                    
                    // Carregar validade (template ou config empresa)
                    const validade = template.validade_dias || {% if config_empresa %}configEmpresa.validade_padrao{% else %}7{% endif %};
                    if (validade) {
                        document.querySelector('input[name="validade_dias"]').value = validade;
                    }
                    
                    // Carregar percentual nota fiscal (template ou config empresa)
                    const percentualNF = template.percentual_nota_fiscal || {% if config_empresa %}configEmpresa.percentual_nota_fiscal_padrao{% else %}13.5{% endif %};
                    if (percentualNF) {
                        document.querySelector('input[name="percentual_nota_fiscal"]').value = percentualNF;
                    }
                    
                    alert(`Template "${template.nome}" carregado com ${itens.length} serviços e campos preenchidos!`);
                } else {
                    alert('Template carregado mas não possui serviços cadastrados.');
                }
            } else {
                alert('Erro ao carregar template: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar template.');
        });
}

function limparServicos() {
    const container = document.getElementById('servicosContainer');
    container.innerHTML = `
        <div class="servico-item border rounded p-3 mb-3">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Descrição do Serviço</label>
                        <input type="text" class="form-control servico-descricao" 
                               placeholder="Ex: Estrutura metálica">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control servico-quantidade" 
                               name="item_quantidade" step="0.01" onchange="calcularServico(this)">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Unidade</label>
                        <select class="form-select servico-unidade" name="item_unidade">
                            <option value="m²">m²</option>
                            <option value="m³">m³</option>
                            <option value="un">Unidade</option>
                            <option value="kg">kg</option>
                            <option value="t">Tonelada</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Valor Unitário</label>
                        <input type="number" class="form-control servico-valor-unitario" 
                               name="item_preco" step="0.01" onchange="calcularServico(this)">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <input type="text" class="form-control servico-total" readonly>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Observações</label>
                <textarea class="form-control servico-observacoes" rows="2"></textarea>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
    `;
    calcularTotal();
}
</script>
{% endblock %}