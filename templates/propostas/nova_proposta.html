{% extends "base_light.html" %}
{% block title %}Nova Proposta - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i> Nova Proposta Comercial</h5>
                    {% if config_empresa %}
                    <small class="text-muted">{{ config_empresa.nome_empresa }}</small>
                    {% else %}
                    <small class="text-warning">⚠️ Configure os dados da empresa em <a href="{{ url_for('configuracoes.empresa') }}">Configurações</a></small>
                    {% endif %}
                </div>
                <a href="{{ url_for('configuracoes.empresa') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-cog me-1"></i> Configurar Empresa
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('propostas.criar_proposta') }}" id="formNovaProposta">
                <div class="row">
                    <!-- Dados do Cliente -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Dados do Cliente</h6>
                        <div class="mb-3">
                            <label class="form-label">Nome do Cliente *</label>
                            <input type="text" class="form-control" name="cliente_nome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="cliente_email">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" name="cliente_telefone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">CPF/CNPJ</label>
                                    <input type="text" class="form-control" name="cliente_cpf_cnpj">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dados da Obra -->
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Dados da Obra</h6>
                        <div class="mb-3">
                            <label class="form-label">Número da Proposta *</label>
                            <input type="text" class="form-control" name="numero_proposta" placeholder="Ex: 001.25" required>
                            <small class="text-muted">Defina um número único para esta proposta</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assunto da Proposta</label>
                            <input type="text" class="form-control" name="assunto" placeholder="Ex: Estrutura Metálica Residencial">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Objeto/Descrição da Obra</label>
                            <textarea class="form-control" name="objeto" rows="3" placeholder="Descreva os serviços a serem executados..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Endereço da Obra</label>
                            <textarea class="form-control" name="endereco_obra" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Área Total (m²)</label>
                                    <input type="number" class="form-control" name="area_total_m2" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Prazo (dias)</label>
                                    <input type="number" class="form-control" name="prazo_execucao" value="30">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pré-carregar Template -->
                <hr>
                <div class="mb-4">
                    <h6 class="text-primary mb-3">Pré-carregar Template</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <select class="form-select" id="seletorTemplate">
                                <option value="">Selecione um template para pré-carregar...</option>
                                {% for template in templates %}
                                <option value="{{ template.id }}">{{ template.nome }} ({{ template.categoria }})</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Total de templates disponíveis: {{ templates|length }}</small>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary w-100" onclick="carregarTemplateMultiplo()">
                                <i class="fas fa-download me-1"></i> Pré-carregar Template
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Serviços Organizados por Template -->
                <h6 class="text-primary mb-3">Serviços</h6>
                <div id="templatesCarregados"></div>
                
                <!-- Serviços Adicionais -->
                <div class="mt-4">
                    <h6 class="text-secondary mb-3">Serviços Adicionais</h6>
                    <div id="servicosContainer">
                    <div class="servico-item border rounded p-3 mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Descrição do Serviço</label>
                                    <input type="text" class="form-control servico-descricao" 
                                           name="item_descricao" placeholder="Ex: Estrutura metálica">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control servico-quantidade" 
                                           name="item_quantidade" step="0.01" onchange="calcularServico(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Unidade</label>
                                    <select class="form-select servico-unidade" name="item_unidade">
                                        <option value="m²">m²</option>
                                        <option value="m³">m³</option>
                                        <option value="un">Unidade</option>
                                        <option value="kg">kg</option>
                                        <option value="t">Tonelada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Valor Unitário</label>
                                    <input type="number" class="form-control servico-valor-unitario" 
                                           name="item_preco" step="0.01" onchange="calcularServico(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Total</label>
                                    <input type="text" class="form-control servico-total" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control servico-observacoes" rows="2"></textarea>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="adicionarServico()">
                        <i class="fas fa-plus"></i> Adicionar Serviço
                    </button>
                    <div class="text-end">
                        <h5>Total da Proposta: <span id="totalProposta">R$ 0,00</span></h5>
                    </div>
                </div>



                <hr class="my-4">
                <h6 class="text-primary mb-3">Conteúdo Técnico das Seções (Páginas 3-9)</h6>
                
                <div class="row">
                    <!-- Seção 1: Especificações Técnicas -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">1. Especificações Técnicas</label>
                            <textarea class="form-control" name="secao_especificacoes" id="secaoEspecificacoes" rows="5" 
                                      placeholder="Estrutura em aço carbono conforme NBR 8800...">• Estrutura em aço carbono ASTM A36 ou similar
• Soldas executadas conforme AWS D1.1
• Parafusos de alta resistência ASTM A325
• Tratamento superficial: jateamento SA 2½
• Pintura de proteção: primer + esmalte sintético</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 2: Materiais e Componentes -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">2. Materiais e Componentes</label>
                            <textarea class="form-control" name="secao_materiais" id="secaoMateriais" rows="5" 
                                      placeholder="Perfis laminados, chapas, conectores...">• Perfis laminados conforme catálogo Gerdau
• Chapas de aço carbono SAE 1020
• Conectores e parafusos galvanizados
• Eletrodos AWS E70XX para soldagem
• Tintas e primers de primeira qualidade</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 3: Processo de Fabricação -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">3. Processo de Fabricação</label>
                            <textarea class="form-control" name="secao_fabricacao" id="secaoFabricacao" rows="5" 
                                      placeholder="Corte, dobra, soldagem e montagem...">• Corte em guilhotina e plasma CNC
• Dobra em prensa hidráulica
• Soldagem com processo MIG/MAG
• Montagem e pré-montagem em fábrica
• Controle de qualidade em todas as etapas</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 4: Logística e Transporte -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">4. Logística e Transporte</label>
                            <textarea class="form-control" name="secao_logistica" id="secaoLogistica" rows="5" 
                                      placeholder="Transporte especializado, equipamentos...">• Transporte com veículos especializados
• Equipamentos de movimentação (Munck)
• Cronograma de entregas programadas
• Armazenamento temporário se necessário
• Coordenação com cronograma da obra</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 5: Montagem e Instalação -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">5. Montagem e Instalação</label>
                            <textarea class="form-control" name="secao_montagem" id="secaoMontagem" rows="5" 
                                      placeholder="Equipe especializada, equipamentos de içamento...">• Equipe técnica especializada
• Equipamentos de içamento adequados
• Procedimentos de segurança rigorosos
• Supervisão técnica permanente
• Relatórios diários de progresso</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 6: Controle de Qualidade -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">6. Controle de Qualidade</label>
                            <textarea class="form-control" name="secao_qualidade" id="secaoQualidade" rows="5" 
                                      placeholder="Inspeções, testes, certificações...">• Inspeção dimensional rigorosa
• Testes de soldagem conforme norma
• Verificação de prumo e nível
• Documentação fotográfica completa
• Certificados de conformidade</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 7: Segurança e Meio Ambiente -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">7. Segurança e Meio Ambiente</label>
                            <textarea class="form-control" name="secao_seguranca" id="secaoSeguranca" rows="5" 
                                      placeholder="EPIs, procedimentos de segurança...">• Fornecimento de EPIs completos
• Procedimentos de segurança rigorosos
• Gestão de resíduos responsável
• Treinamentos de segurança da equipe
• Cumprimento das NRs aplicáveis</textarea>
                        </div>
                    </div>
                    
                    <!-- Seção 8: Assistência Técnica -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">8. Assistência Técnica</label>
                            <textarea class="form-control" name="secao_assistencia" id="secaoAssistencia" rows="5" 
                                      placeholder="Suporte pós-entrega, manutenção...">• Suporte técnico pós-entrega
• Manual de manutenção detalhado
• Atendimento para dúvidas técnicas
• Garantia de 12 meses
• Visitas de acompanhamento</textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Seção 9: Considerações Finais -->
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">9. Considerações Finais</label>
                            <textarea class="form-control" name="secao_consideracoes" id="secaoConsideracoes" rows="4" 
                                      placeholder="Agradecimentos, disponibilidade para esclarecimentos...">Agradecemos a oportunidade de apresentar nossa proposta e reafirmamos nosso compromisso com a qualidade e pontualidade na execução dos serviços. Nossa equipe permanece à disposição para esclarecimentos adicionais e adequações que se fizerem necessárias.</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">% Nota Fiscal</label>
                            <input type="number" class="form-control" name="percentual_nota_fiscal" id="percentualNF"
                                   step="0.1" value="{{ padrao_percentual_nf or 13.5 }}">
                        </div>
                    </div>
                </div>

                <!-- Valor Manual (alternativo) -->
                <div class="mb-3">
                    <label class="form-label">Valor Total Manual (opcional)</label>
                    <input type="number" class="form-control" name="valor_proposta" 
                           step="0.01" placeholder="Use este campo se não detalhar os serviços">
                </div>

                <input type="hidden" name="servicos_json" id="servicosJson">

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('propostas.index') }}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-success">Criar Proposta</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function adicionarServico() {
    const container = document.getElementById('servicosContainer');
    const novoServico = container.firstElementChild.cloneNode(true);
    
    // Limpar valores e garantir que os campos tenham os nomes corretos
    novoServico.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.type !== 'hidden') field.value = '';
        
        // Garantir que os campos tenham os nomes corretos
        if (field.classList.contains('servico-descricao')) {
            field.name = 'item_descricao';
        } else if (field.classList.contains('servico-quantidade')) {
            field.name = 'item_quantidade';
        } else if (field.classList.contains('servico-unidade')) {
            field.name = 'item_unidade';
        } else if (field.classList.contains('servico-valor-unitario')) {
            field.name = 'item_preco';
        }
    });
    
    container.appendChild(novoServico);
}

function removerServico(btn) {
    const container = document.getElementById('servicosContainer');
    if (container.children.length > 1) {
        btn.closest('.servico-item').remove();
        calcularTotal();
    }
}

function calcularServico(input) {
    const servicoItem = input.closest('.servico-item');
    const quantidade = parseFloat(servicoItem.querySelector('.servico-quantidade').value) || 0;
    const valorUnitario = parseFloat(servicoItem.querySelector('.servico-valor-unitario').value) || 0;
    const total = quantidade * valorUnitario;
    
    servicoItem.querySelector('.servico-total').value = 'R$ ' + total.toFixed(2).replace('.', ',');
    calcularTotal();
}

function calcularTotal() {
    // Chamar a função de atualização geral que considera templates + serviços adicionais
    atualizarTotalGeral();
}

function coletarServicos() {
    const servicos = [];
    document.querySelectorAll('.servico-item').forEach(item => {
        const descricao = item.querySelector('.servico-descricao').value;
        const quantidade = item.querySelector('.servico-quantidade').value;
        const valorUnitario = item.querySelector('.servico-valor-unitario').value;
        
        if (descricao && quantidade && valorUnitario) {
            servicos.push({
                descricao: descricao,
                quantidade: parseFloat(quantidade),
                unidade: item.querySelector('.servico-unidade').value,
                valor_unitario: parseFloat(valorUnitario),
                observacoes: item.querySelector('.servico-observacoes').value
            });
        }
    });
    
    document.getElementById('servicosJson').value = JSON.stringify(servicos);
}

document.getElementById('formNovaProposta').addEventListener('submit', function(e) {
    coletarServicos();
});

// Sistema de carregamento múltiplo de templates
let templatesCarregadosData = [];

function carregarTemplateMultiplo() {
    const select = document.getElementById('seletorTemplate');
    const templateId = select.value;
    
    if (!templateId) {
        alert('Selecione um template primeiro!');
        return;
    }
    
    console.log('=== CARREGANDO TEMPLATE MÚLTIPLO ===');
    console.log('Elemento select encontrado:', select);
    console.log('Template ID selecionado:', templateId);
    console.log('Selected index:', select ? select.selectedIndex : 'N/A');
    console.log('Total de options no select:', select ? select.options.length : 'N/A');
    
    // Debug de todas as opções
    if (select) {
        console.log('=== DEBUG TODAS AS OPÇÕES ===');
        for (let i = 0; i < select.options.length; i++) {
            const option = select.options[i];
            console.log(`Option ${i}: value="${option.value}", text="${option.text}", selected=${option.selected}`);
        }
        
        // Verificar se há uma opção selecionada
        const selectedOption = select.options[select.selectedIndex];
        console.log('Opção selecionada:', selectedOption);
        console.log('Valor da opção selecionada:', selectedOption ? selectedOption.value : 'N/A');
    }
    
    if (!templateId || templateId === '') {
        console.error('ERRO: Nenhum template selecionado');
        console.error('Valor recebido:', `"${templateId}"`);
        alert('Selecione um template primeiro.');
        return;
    }
    
    const url = `/propostas/api/template/${templateId}`;
    console.log('URL da requisição:', url);
    
    fetch(url)
        .then(response => {
            console.log('Status da resposta:', response.status);
            console.log('Headers da resposta:', response.headers);
            console.log('URL final:', response.url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.text(); // Primeiro como texto para debug
        })
        .then(text => {
            console.log('Resposta bruta (texto):', text);
            
            try {
                const data = JSON.parse(text);
                console.log('Dados do template parseados:', data);
                
                // Verificar se template já foi carregado
                if (templatesCarregadosData.find(t => t.id == templateId)) {
                    alert('Este template já foi carregado!');
                    return;
                }
                
                if (data && data.id) {
                    // Adicionar template aos carregados
                    templatesCarregadosData.push(data);
                    
                    // Criar tabela para este template
                    criarTabelaTemplate(data);
                    
                    // Atualizar totais
                    atualizarTotalGeral();
                    
                    // Reset select
                    document.getElementById('seletorTemplate').value = '';
                    
                    alert(`✅ Template "${data.nome}" carregado!\n\n` +
                          `🔧 Serviços: ${data.itens_padrao ? data.itens_padrao.length : 0}\n` +
                          `📊 Templates carregados: ${templatesCarregadosData.length}\n\n` +
                          `Você pode carregar mais templates!`);
                    
                } else {
                    alert('Erro: Dados do template inválidos');
                }
            } catch (parseError) {
                console.error('Erro ao fazer parse do JSON:', parseError);
                console.error('Texto recebido:', text);
                alert(`Erro ao processar resposta: ${parseError.message}`);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            alert(`Erro: ${error.message}`);
        });
}

// Função para criar tabela de template com edição inline
function criarTabelaTemplate(template) {
    const container = document.getElementById('templatesCarregados');
    
    // Calcular subtotal do template
    let subtotal = 0;
    if (template.itens_padrao) {
        template.itens_padrao.forEach(item => {
            subtotal += (item.quantidade || 0) * (item.preco_unitario || 0);
        });
    }
    
    const templateDiv = document.createElement('div');
    templateDiv.className = 'template-carregado border rounded p-3 mb-4';
    templateDiv.dataset.templateId = template.id;
    
    let itensHtml = '';
    if (template.itens_padrao && template.itens_padrao.length > 0) {
        template.itens_padrao.forEach((item, index) => {
            const total = (item.quantidade || 0) * (item.preco_unitario || 0);
            itensHtml += `
                <tr>
                    <td>
                        <input type="text" 
                               class="form-control form-control-sm" 
                               value="${item.descricao}" 
                               onchange="atualizarItemTemplate(${template.id}, ${index}, 'descricao', this.value)"
                               placeholder="Descrição do serviço">
                    </td>
                    <td class="text-center">
                        <input type="number" 
                               class="form-control form-control-sm text-center template-quantidade" 
                               value="${item.quantidade}" 
                               min="0" 
                               step="0.1"
                               data-template-id="${template.id}" 
                               data-item-index="${index}"
                               onchange="atualizarItemTemplate(${template.id}, ${index}, 'quantidade', this.value)"
                               style="width: 80px; margin: 0 auto;">
                    </td>
                    <td class="text-center">
                        <select class="form-select form-select-sm" 
                                onchange="atualizarItemTemplate(${template.id}, ${index}, 'unidade', this.value)"
                                style="width: 80px; margin: 0 auto;">
                            <option value="m²" ${item.unidade === 'm²' ? 'selected' : ''}>m²</option>
                            <option value="m" ${item.unidade === 'm' ? 'selected' : ''}>m</option>
                            <option value="un" ${item.unidade === 'un' ? 'selected' : ''}>un</option>
                            <option value="kg" ${item.unidade === 'kg' ? 'selected' : ''}>kg</option>
                            <option value="h" ${item.unidade === 'h' ? 'selected' : ''}>h</option>
                        </select>
                    </td>
                    <td class="text-end">
                        <input type="number" 
                               class="form-control form-control-sm text-end template-preco" 
                               value="${(item.preco_unitario || 0).toFixed(2)}" 
                               min="0" 
                               step="0.01"
                               data-template-id="${template.id}" 
                               data-item-index="${index}"
                               onchange="atualizarItemTemplate(${template.id}, ${index}, 'preco_unitario', this.value)"
                               style="width: 120px; margin-left: auto;">
                    </td>
                    <td class="text-end">
                        <strong id="total-item-${template.id}-${index}">R$ ${total.toFixed(2)}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerItemTemplate(${template.id}, ${index})" title="Remover item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    templateDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-primary mb-0">${template.nome}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerTemplate(${template.id})">
                <i class="fas fa-trash"></i> Remover Template
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Descrição</th>
                        <th class="text-center">Qtd</th>
                        <th class="text-center">Unidade</th>
                        <th class="text-end">Valor Unit.</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody id="tbody-template-${template.id}">
                    ${itensHtml}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-center py-2">
                            <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="adicionarItemTemplate(${template.id})">
                                <i class="fas fa-plus"></i> Adicionar Item
                            </button>
                        </td>
                    </tr>
                    <tr class="table-warning">
                        <th colspan="4" class="text-end">Subtotal ${template.nome}:</th>
                        <th class="text-end" id="subtotal-template-${template.id}">R$ ${subtotal.toFixed(2)}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    container.appendChild(templateDiv);
    
    // Scroll para ver o template adicionado
    templateDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function removerTemplate(templateId) {
    // Remover do array
    templatesCarregadosData = templatesCarregadosData.filter(t => t.id != templateId);
    
    // Remover da interface
    const templateDiv = document.querySelector(`[data-template-id="${templateId}"]`);
    if (templateDiv) {
        templateDiv.remove();
    }
    
    // Atualizar total
    atualizarTotalGeral();
    
    alert('Template removido com sucesso!');
}

// Função para atualizar item específico de template
function atualizarItemTemplate(templateId, itemIndex, campo, valor) {
    console.log(`Atualizando template ${templateId}, item ${itemIndex}, campo ${campo} = ${valor}`);
    
    // Encontrar o template no array
    const template = templatesCarregadosData.find(t => t.id == templateId);
    if (!template || !template.itens_padrao || !template.itens_padrao[itemIndex]) {
        console.error('Template ou item não encontrado');
        return;
    }
    
    // Atualizar o valor no array
    const valorNumerico = parseFloat(valor) || 0;
    template.itens_padrao[itemIndex][campo] = valorNumerico;
    
    // Recalcular total do item
    const item = template.itens_padrao[itemIndex];
    const novoTotal = (item.quantidade || 0) * (item.preco_unitario || 0);
    
    // Atualizar total do item na interface
    const totalElement = document.getElementById(`total-item-${templateId}-${itemIndex}`);
    if (totalElement) {
        totalElement.textContent = `R$ ${novoTotal.toFixed(2)}`;
    }
    
    // Recalcular subtotal do template
    let novoSubtotal = 0;
    template.itens_padrao.forEach(item => {
        novoSubtotal += (item.quantidade || 0) * (item.preco_unitario || 0);
    });
    
    // Atualizar subtotal na interface
    const subtotalElement = document.getElementById(`subtotal-template-${templateId}`);
    if (subtotalElement) {
        subtotalElement.textContent = `R$ ${novoSubtotal.toFixed(2)}`;
    }
    
    // Atualizar total geral
    atualizarTotalGeral();
    
    console.log(`Item atualizado: ${campo} = ${valorNumerico}, novo total do item: R$ ${novoTotal.toFixed(2)}, novo subtotal do template: R$ ${novoSubtotal.toFixed(2)}`);
}

// Função para adicionar novo item a um template
function adicionarItemTemplate(templateId) {
    const template = templatesCarregadosData.find(t => t.id == templateId);
    if (!template) {
        console.error('Template não encontrado:', templateId);
        return;
    }
    
    // Criar novo item padrão
    const novoItem = {
        descricao: 'Novo serviço',
        quantidade: 1,
        unidade: 'm²',
        preco_unitario: 0
    };
    
    // Adicionar ao array do template
    if (!template.itens_padrao) {
        template.itens_padrao = [];
    }
    template.itens_padrao.push(novoItem);
    
    const novoIndex = template.itens_padrao.length - 1;
    
    // Adicionar linha na tabela
    const tbody = document.getElementById(`tbody-template-${templateId}`);
    if (tbody) {
        const novaLinha = document.createElement('tr');
        novaLinha.innerHTML = `
            <td>
                <input type="text" 
                       class="form-control form-control-sm" 
                       value="${novoItem.descricao}" 
                       onchange="atualizarItemTemplate(${templateId}, ${novoIndex}, 'descricao', this.value)"
                       placeholder="Descrição do serviço">
            </td>
            <td class="text-center">
                <input type="number" 
                       class="form-control form-control-sm text-center template-quantidade" 
                       value="${novoItem.quantidade}" 
                       min="0" 
                       step="0.1"
                       data-template-id="${templateId}" 
                       data-item-index="${novoIndex}"
                       onchange="atualizarItemTemplate(${templateId}, ${novoIndex}, 'quantidade', this.value)"
                       style="width: 80px; margin: 0 auto;">
            </td>
            <td class="text-center">
                <select class="form-select form-select-sm" 
                        onchange="atualizarItemTemplate(${templateId}, ${novoIndex}, 'unidade', this.value)"
                        style="width: 80px; margin: 0 auto;">
                    <option value="m²" selected>m²</option>
                    <option value="m">m</option>
                    <option value="un">un</option>
                    <option value="kg">kg</option>
                    <option value="h">h</option>
                </select>
            </td>
            <td class="text-end">
                <input type="number" 
                       class="form-control form-control-sm text-end template-preco" 
                       value="${novoItem.preco_unitario.toFixed(2)}" 
                       min="0" 
                       step="0.01"
                       data-template-id="${templateId}" 
                       data-item-index="${novoIndex}"
                       onchange="atualizarItemTemplate(${templateId}, ${novoIndex}, 'preco_unitario', this.value)"
                       style="width: 120px; margin-left: auto;">
            </td>
            <td class="text-end">
                <strong id="total-item-${templateId}-${novoIndex}">R$ 0,00</strong>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerItemTemplate(${templateId}, ${novoIndex})" title="Remover item">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(novaLinha);
    }
    
    // Atualizar totais
    atualizarTotalGeral();
    
    console.log(`Novo item adicionado ao template ${templateId}, index ${novoIndex}`);
}

// Função para remover item de um template
function removerItemTemplate(templateId, itemIndex) {
    const template = templatesCarregadosData.find(t => t.id == templateId);
    if (!template || !template.itens_padrao) {
        console.error('Template ou itens não encontrados');
        return;
    }
    
    // Confirmar remoção
    if (confirm('Tem certeza que deseja remover este item?')) {
        // Remover do array
        template.itens_padrao.splice(itemIndex, 1);
        
        // Recriar a tabela completamente para reindexar
        recriarTabelaTemplate(templateId);
        
        // Atualizar totais
        atualizarTotalGeral();
        
        console.log(`Item ${itemIndex} removido do template ${templateId}`);
    }
}

// Função para recriar tabela após remoção de item
function recriarTabelaTemplate(templateId) {
    const template = templatesCarregadosData.find(t => t.id == templateId);
    if (!template) return;
    
    // Encontrar o tbody da tabela
    const tbody = document.getElementById(`tbody-template-${templateId}`);
    if (!tbody) return;
    
    // Limpar tbody
    tbody.innerHTML = '';
    
    // Recriar todas as linhas com índices corretos
    if (template.itens_padrao && template.itens_padrao.length > 0) {
        template.itens_padrao.forEach((item, index) => {
            const total = (item.quantidade || 0) * (item.preco_unitario || 0);
            
            const novaLinha = document.createElement('tr');
            novaLinha.innerHTML = `
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           value="${item.descricao}" 
                           onchange="atualizarItemTemplate(${templateId}, ${index}, 'descricao', this.value)"
                           placeholder="Descrição do serviço">
                </td>
                <td class="text-center">
                    <input type="number" 
                           class="form-control form-control-sm text-center template-quantidade" 
                           value="${item.quantidade}" 
                           min="0" 
                           step="0.1"
                           data-template-id="${templateId}" 
                           data-item-index="${index}"
                           onchange="atualizarItemTemplate(${templateId}, ${index}, 'quantidade', this.value)"
                           style="width: 80px; margin: 0 auto;">
                </td>
                <td class="text-center">
                    <select class="form-select form-select-sm" 
                            onchange="atualizarItemTemplate(${templateId}, ${index}, 'unidade', this.value)"
                            style="width: 80px; margin: 0 auto;">
                        <option value="m²" ${item.unidade === 'm²' ? 'selected' : ''}>m²</option>
                        <option value="m" ${item.unidade === 'm' ? 'selected' : ''}>m</option>
                        <option value="un" ${item.unidade === 'un' ? 'selected' : ''}>un</option>
                        <option value="kg" ${item.unidade === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="h" ${item.unidade === 'h' ? 'selected' : ''}>h</option>
                    </select>
                </td>
                <td class="text-end">
                    <input type="number" 
                           class="form-control form-control-sm text-end template-preco" 
                           value="${(item.preco_unitario || 0).toFixed(2)}" 
                           min="0" 
                           step="0.01"
                           data-template-id="${templateId}" 
                           data-item-index="${index}"
                           onchange="atualizarItemTemplate(${templateId}, ${index}, 'preco_unitario', this.value)"
                           style="width: 120px; margin-left: auto;">
                </td>
                <td class="text-end">
                    <strong id="total-item-${templateId}-${index}">R$ ${total.toFixed(2)}</strong>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerItemTemplate(${templateId}, ${index})" title="Remover item">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(novaLinha);
        });
    }
    
    // Atualizar subtotal
    let novoSubtotal = 0;
    template.itens_padrao.forEach(item => {
        novoSubtotal += (item.quantidade || 0) * (item.preco_unitario || 0);
    });
    
    const subtotalElement = document.getElementById(`subtotal-template-${templateId}`);
    if (subtotalElement) {
        subtotalElement.textContent = `R$ ${novoSubtotal.toFixed(2)}`;
    }
}

function atualizarTotalGeral() {
    let totalTemplates = 0;
    let totalServicos = 0;
    
    // Somar todos os templates carregados
    templatesCarregadosData.forEach(template => {
        if (template.itens_padrao) {
            template.itens_padrao.forEach(item => {
                totalTemplates += (item.quantidade || 0) * (item.preco_unitario || 0);
            });
        }
    });
    
    // Somar serviços adicionais
    document.querySelectorAll('#servicosContainer .servico-item').forEach(item => {
        const quantidade = parseFloat(item.querySelector('.servico-quantidade').value) || 0;
        const valorUnitario = parseFloat(item.querySelector('.servico-valor-unitario').value) || 0;
        totalServicos += quantidade * valorUnitario;
    });
    
    const totalGeral = totalTemplates + totalServicos;
    
    // Atualizar display do total
    document.getElementById('totalProposta').textContent = 'R$ ' + totalGeral.toFixed(2).replace('.', ',');
    
    // Atualizar input hidden para o formulário
    const inputValor = document.querySelector('input[name="valor_proposta"]');
    if (inputValor) {
        inputValor.value = totalGeral.toFixed(2);
    }
    
    console.log(`Totais: Templates R$ ${totalTemplates.toFixed(2)} + Serviços R$ ${totalServicos.toFixed(2)} = Total R$ ${totalGeral.toFixed(2)}`);
}

function carregarTemplateDebug() {
    console.log('=== FUNÇÃO DEBUG ESPECÍFICA ===');
    
    // Tentar múltiplas formas de obter o elemento
    const select1 = document.getElementById('seletorTemplate');
    const select2 = document.querySelector('#seletorTemplate');
    const select3 = document.querySelector('select');
    
    console.log('getElementById:', select1);
    console.log('querySelector id:', select2);
    console.log('querySelector select:', select3);
    
    const select = select1 || select2 || select3;
    
    if (!select) {
        alert('ERRO CRÍTICO: Nenhum seletor encontrado na página!');
        return;
    }
    
    console.log('Seletor encontrado:', select);
    console.log('Valor atual:', select.value);
    console.log('Index selecionado:', select.selectedIndex);
    
    // Forçar a obtenção do valor através do index
    const selectedOption = select.options[select.selectedIndex];
    const valorForcado = selectedOption ? selectedOption.value : '';
    
    console.log('Valor forçado:', valorForcado);
    
    if (!valorForcado || valorForcado === '') {
        alert('Selecione um template na lista primeiro!');
        return;
    }
    
    // Chamar a função original com o valor correto
    console.log('Chamando carregarTemplate com valor:', valorForcado);
    carregarTemplateComValor(valorForcado);
}

function carregarTemplateComValor(templateId) {
    console.log('=== CARREGANDO TEMPLATE COM VALOR ESPECÍFICO ===');
    console.log('Template ID recebido:', templateId);
    
    const url = `/propostas/api/template/${templateId}`;
    console.log('URL da requisição:', url);
    
    fetch(url)
        .then(response => {
            console.log('Status da resposta:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            
            if (data && data.id) {
                console.log('=== PREENCHENDO CAMPOS DO FORMULÁRIO ===');
                
                // Mapear apenas campos que existem nesta página
                const campos = [
                    { name: 'prazo_execucao', value: data.prazo_entrega_dias },
                    { name: 'percentual_nota_fiscal', value: data.percentual_nota_fiscal }
                ];
                
                let camposPreenchidos = 0;
                campos.forEach(campo => {
                    const elemento = document.querySelector(`[name="${campo.name}"]`);
                    console.log(`Procurando campo [name="${campo.name}"]:`, elemento ? 'ENCONTRADO' : 'NÃO ENCONTRADO');
                    
                    if (elemento && campo.value) {
                        elemento.value = campo.value;
                        camposPreenchidos++;
                        console.log(`✅ Campo ${campo.name} preenchido com:`, campo.value);
                    }
                });
                
                console.log('=== CAMPOS DISPONÍVEIS NESTA PÁGINA ===');
                console.log('Esta página tem apenas campos básicos:');
                console.log('- Dados do cliente');
                console.log('- Serviços/itens');
                console.log('- Valores');
                console.log('Campos como itens_inclusos, condições, etc. estão em outras páginas do sistema.');
                
                // Preencher itens de serviços
                if (data.itens_padrao && data.itens_padrao.length > 0) {
                    console.log('=== PREENCHENDO SERVIÇOS DO TEMPLATE ===');
                    
                    // Limpar serviços existentes primeiro
                    const container = document.getElementById('servicosContainer');
                    container.innerHTML = '';
                    
                    // Adicionar cada item do template
                    data.itens_padrao.forEach((item, index) => {
                        console.log(`Adicionando serviço ${index + 1}:`, item);
                        
                        // Criar elemento de serviço
                        const servicoDiv = document.createElement('div');
                        servicoDiv.className = 'servico-item border rounded p-3 mb-3';
                        servicoDiv.innerHTML = `
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Descrição do Serviço</label>
                                        <input type="text" class="form-control servico-descricao" 
                                               name="item_descricao" value="${item.descricao || ''}" 
                                               placeholder="Ex: Estrutura metálica">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Quantidade</label>
                                        <input type="number" class="form-control servico-quantidade" 
                                               name="item_quantidade" value="${item.quantidade || ''}" 
                                               step="0.01" onchange="calcularServico(this)">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Unidade</label>
                                        <select class="form-select servico-unidade" name="item_unidade">
                                            <option value="m²" ${item.unidade === 'm²' ? 'selected' : ''}>m²</option>
                                            <option value="m³" ${item.unidade === 'm³' ? 'selected' : ''}>m³</option>
                                            <option value="un" ${item.unidade === 'un' ? 'selected' : ''}>Unidade</option>
                                            <option value="kg" ${item.unidade === 'kg' ? 'selected' : ''}>kg</option>
                                            <option value="t" ${item.unidade === 't' ? 'selected' : ''}>Tonelada</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Valor Unitário</label>
                                        <input type="number" class="form-control servico-valor-unitario" 
                                               name="item_preco" value="${item.preco_unitario || ''}" 
                                               step="0.01" onchange="calcularServico(this)">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label class="form-label">Total</label>
                                        <input type="text" class="form-control servico-total" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Observações</label>
                                <textarea class="form-control servico-observacoes" rows="2"></textarea>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        `;
                        
                        container.appendChild(servicoDiv);
                        
                        // Calcular total do serviço
                        const quantidadeInput = servicoDiv.querySelector('.servico-quantidade');
                        calcularServico(quantidadeInput);
                    });
                    
                    // Calcular total geral
                    calcularTotal();
                    
                    console.log(`✅ ${data.itens_padrao.length} serviços adicionados do template`);
                }
                
                console.log(`Total de campos preenchidos: ${camposPreenchidos}`);
                console.log(`Total de serviços adicionados: ${data.itens_padrao ? data.itens_padrao.length : 0}`);
                
                // Calcular valor total atual
                let valorTotal = 0;
                document.querySelectorAll('.servico-item').forEach(item => {
                    const quantidade = parseFloat(item.querySelector('.servico-quantidade').value) || 0;
                    const valorUnitario = parseFloat(item.querySelector('.servico-valor-unitario').value) || 0;
                    valorTotal += quantidade * valorUnitario;
                });
                
                alert(`✅ Template "${data.nome}" carregado com sucesso!\n\n` +
                      `🔧 Serviços adicionados: ${data.itens_padrao ? data.itens_padrao.length : 0}\n` +
                      `📋 Campos preenchidos: ${camposPreenchidos}\n\n` +
                      `O formulário está pronto para edição!\n` +
                      `Total calculado automaticamente: R$ ${valorTotal.toFixed(2)}`);
                
                // Scroll para o topo para ver os serviços carregados
                document.getElementById('servicosContainer').scrollIntoView({ behavior: 'smooth' });
                
            } else {
                alert('Erro: Dados do template inválidos');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert(`Erro: ${error.message}`);
        });
}

function carregarServicosTemplate(templateId) {
    fetch(`/propostas/api/template/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Limpar serviços existentes
                limparServicos();
                
                // Carregar serviços do template
                const itens = data.template.itens_padrao || [];
                if (itens.length > 0) {
                    itens.forEach((item, index) => {
                        if (index > 0) {
                            adicionarServico();
                        }
                        
                        const servicoItems = document.querySelectorAll('.servico-item');
                        const servicoAtual = servicoItems[index];
                        
                        servicoAtual.querySelector('.servico-descricao').value = item.descricao;
                        servicoAtual.querySelector('.servico-quantidade').value = item.quantidade;
                        servicoAtual.querySelector('.servico-unidade').value = item.unidade;
                        servicoAtual.querySelector('.servico-valor-unitario').value = item.preco_unitario;
                        
                        calcularServico(servicoAtual.querySelector('.servico-quantidade'));
                    });
                    
                    // Recalcular total após carregar todos os serviços
                    calcularTotal();
                    
                    // Carregar campos adicionais do template
                    const template = data.template;
                    
                    // Carregar dados da empresa se disponível (prioridade)
                    {% if config_empresa %}
                    const configEmpresa = {
                        prazo_entrega_padrao: {{ config_empresa.prazo_entrega_padrao or 'null' }},
                        validade_padrao: {{ config_empresa.validade_padrao or 'null' }},
                        percentual_nota_fiscal_padrao: {{ config_empresa.percentual_nota_fiscal_padrao or 'null' }},
                        itens_inclusos_padrao: `{{ config_empresa.itens_inclusos_padrao or '' }}`,
                        itens_exclusos_padrao: `{{ config_empresa.itens_exclusos_padrao or '' }}`,
                        condicoes_padrao: `{{ config_empresa.condicoes_padrao or '' }}`,
                        condicoes_pagamento_padrao: `{{ config_empresa.condicoes_pagamento_padrao or '' }}`,
                        garantias_padrao: `{{ config_empresa.garantias_padrao or '' }}`
                    };
                    {% endif %}
                    
                    // Atualizar prazo (template ou config empresa)
                    const prazo = template.prazo_entrega_dias || {% if config_empresa %}configEmpresa.prazo_entrega_padrao{% else %}90{% endif %};
                    if (prazo) {
                        document.querySelector('input[name="prazo_entrega_dias"]').value = prazo;
                    }
                    
                    // Carregar itens inclusos (template ou config empresa)
                    const itensInclusos = template.itens_inclusos || {% if config_empresa %}`${configEmpresa.itens_inclusos_padrao}`{% else %}''{% endif %};
                    if (itensInclusos) {
                        document.querySelector('textarea[name="itens_inclusos"]').value = itensInclusos;
                    }
                    
                    // Carregar itens exclusos (template ou config empresa)
                    const itensExclusos = template.itens_exclusos || {% if config_empresa %}`${configEmpresa.itens_exclusos_padrao}`{% else %}''{% endif %};
                    if (itensExclusos) {
                        document.querySelector('textarea[name="itens_exclusos"]').value = itensExclusos;
                    }
                    
                    // Carregar condições (template ou config empresa)
                    const condicoes = template.condicoes || {% if config_empresa %}`${configEmpresa.condicoes_padrao}`{% else %}''{% endif %};
                    if (condicoes) {
                        document.querySelector('textarea[name="condicoes"]').value = condicoes;
                    }
                    
                    // Carregar condições de pagamento (template ou config empresa)
                    const condicoesPagamento = template.condicoes_pagamento || {% if config_empresa %}`${configEmpresa.condicoes_pagamento_padrao}`{% else %}''{% endif %};
                    if (condicoesPagamento) {
                        document.querySelector('textarea[name="condicoes_pagamento"]').value = condicoesPagamento;
                    }
                    
                    // Carregar garantias (template ou config empresa)
                    const garantias = template.garantias || {% if config_empresa %}`${configEmpresa.garantias_padrao}`{% else %}''{% endif %};
                    if (garantias) {
                        document.querySelector('textarea[name="garantias"]').value = garantias;
                    }
                    
                    // Carregar validade (template ou config empresa)
                    const validade = template.validade_dias || {% if config_empresa %}configEmpresa.validade_padrao{% else %}7{% endif %};
                    if (validade) {
                        document.querySelector('input[name="validade_dias"]').value = validade;
                    }
                    
                    // Carregar percentual nota fiscal (template ou config empresa)
                    const percentualNF = template.percentual_nota_fiscal || {% if config_empresa %}configEmpresa.percentual_nota_fiscal_padrao{% else %}13.5{% endif %};
                    if (percentualNF) {
                        document.querySelector('input[name="percentual_nota_fiscal"]').value = percentualNF;
                    }
                    
                    alert(`Template "${template.nome}" carregado com ${itens.length} serviços e campos preenchidos!`);
                } else {
                    alert('Template carregado mas não possui serviços cadastrados.');
                }
            } else {
                alert('Erro ao carregar template: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar template.');
        });
}

function limparServicos() {
    const container = document.getElementById('servicosContainer');
    container.innerHTML = `
        <div class="servico-item border rounded p-3 mb-3">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Descrição do Serviço</label>
                        <input type="text" class="form-control servico-descricao" 
                               placeholder="Ex: Estrutura metálica">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control servico-quantidade" 
                               name="item_quantidade" step="0.01" onchange="calcularServico(this)">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Unidade</label>
                        <select class="form-select servico-unidade" name="item_unidade">
                            <option value="m²">m²</option>
                            <option value="m³">m³</option>
                            <option value="un">Unidade</option>
                            <option value="kg">kg</option>
                            <option value="t">Tonelada</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Valor Unitário</label>
                        <input type="number" class="form-control servico-valor-unitario" 
                               name="item_preco" step="0.01" onchange="calcularServico(this)">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <input type="text" class="form-control servico-total" readonly>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Observações</label>
                <textarea class="form-control servico-observacoes" rows="2"></textarea>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerServico(this)">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
    `;
    calcularTotal();
}
</script>
{% endblock %}