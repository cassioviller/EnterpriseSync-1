{% extends "base_completo.html" %}
{% block title %}Proposta {{ proposta.numero }} - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-file-contract me-2"></i> {{ proposta.numero }} - {{ proposta.cliente_nome }}</h2>
            <p class="text-muted mb-0">{{ proposta.titulo or 'Sem título' }}</p>
        </div>
        <div class="btn-group">
            {% if proposta.status == 'rascunho' or proposta.status == 'RASCUNHO' %}
            <button class="btn btn-success" onclick="alterarStatus('enviada')">
                <i class="fas fa-paper-plane me-1"></i> Enviar
            </button>
            <a href="{{ url_for('propostas.editar', id=proposta.id) }}" class="btn btn-primary">
                <i class="fas fa-edit me-1"></i> Editar
            </a>
            {% elif proposta.status == 'enviada' or proposta.status == 'ENVIADA' %}
            <button class="btn btn-warning" onclick="alterarStatus('em_analise')">
                <i class="fas fa-clock me-1"></i> Em Análise
            </button>
            {% elif proposta.status == 'em_analise' or proposta.status == 'EM_ANALISE' %}
            <button class="btn btn-success" onclick="alterarStatus('aprovada')">
                <i class="fas fa-check me-1"></i> Aprovar
            </button>
            <button class="btn btn-danger" onclick="alterarStatus('rejeitada')">
                <i class="fas fa-times me-1"></i> Rejeitar
            </button>
            {% endif %}
            
            <a href="{{ url_for('propostas.gerar_pdf', id=proposta.id) }}" class="btn btn-success" target="_blank">
                <i class="fas fa-file-pdf me-1"></i> Gerar PDF
            </a>
            
            <button class="btn btn-danger" onclick="excluirProposta()">
                <i class="fas fa-trash me-1"></i> Excluir
            </button>
            
            <a href="{{ url_for('propostas.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Informações Gerais -->
        <div class="col-md-8">
            <!-- Arquivos de Referência -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>Arquivos de Referência</h5>
                    <button class="btn btn-light btn-sm" onclick="document.getElementById('uploadInput').click()">
                        <i class="fas fa-upload me-1"></i> Adicionar Arquivos
                    </button>
                </div>
                <div class="card-body">
                    <form id="uploadForm" style="display: none;">
                        <input type="file" id="uploadInput" name="arquivos" multiple 
                               accept=".pdf,.dwg,.dxf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xlsx,.xls"
                               onchange="uploadArquivos()">
                    </form>
                    
                    <div id="listaArquivos">
                        {% if arquivos %}
                        <div class="row">
                            {% for arquivo in arquivos %}
                            <div class="col-md-6 mb-3" id="arquivo-{{ arquivo.id }}">
                                <div class="card h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3">
                                                {% if arquivo.categoria == 'imagem' %}
                                                <i class="fas fa-image fa-2x text-success"></i>
                                                {% elif arquivo.categoria == 'pdf' %}
                                                <i class="fas fa-file-pdf fa-2x text-danger"></i>
                                                {% elif arquivo.categoria == 'dwg' %}
                                                <i class="fas fa-drafting-compass fa-2x text-primary"></i>
                                                {% else %}
                                                <i class="fas fa-file fa-2x text-secondary"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ arquivo.nome_original }}</h6>
                                                <small class="text-muted">
                                                    {{ (arquivo.tamanho_bytes / 1024) | round(2) }} KB
                                                    {% if arquivo.enviado_em %}
                                                    • {{ arquivo.enviado_em.strftime('%d/%m/%Y %H:%M') }}
                                                    {% endif %}
                                                </small>
                                                <div class="mt-2">
                                                    <a href="{{ url_for('propostas.download_arquivo', arquivo_id=arquivo.id) }}" 
                                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                                        <i class="fas fa-download"></i> Baixar
                                                    </a>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="deletarArquivo({{ arquivo.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-folder-open fa-3x mb-2"></i><br>
                            Nenhum arquivo anexado. Clique em "Adicionar Arquivos" para enviar PDFs, imagens ou arquivos DWG.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Detalhes da Proposta</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Cliente</h6>
                            <p><strong>{{ proposta.cliente_nome }}</strong></p>
                            <p>{{ proposta.cliente_email }}</p>
                            {% if proposta.cliente_telefone %}
                            <p>{{ proposta.cliente_telefone }}</p>
                            {% endif %}
                            {% if proposta.cliente_cpf_cnpj %}
                            <p>CPF/CNPJ: {{ proposta.cliente_cpf_cnpj }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Obra</h6>
                            <p><strong>Endereço:</strong><br>{{ proposta.endereco_obra }}</p>
                            <p><strong>Descrição:</strong><br>{{ proposta.descricao_obra }}</p>
                            {% if proposta.area_total_m2 %}
                            <p><strong>Área:</strong> {{ proposta.area_total_m2 }} m²</p>
                            {% endif %}
                            {% if proposta.prazo_execucao %}
                            <p><strong>Prazo:</strong> {{ proposta.prazo_execucao }} dias</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabelas de Serviços por Template (igual ao Portal do Cliente) -->
            {% if proposta.templates_organizados %}
                {% for template_info in proposta.templates_organizados %}
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-list-alt"></i> {{ template_info.template_nome }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px; text-align: center;">Item</th>
                                        <th style="min-width: 120px;">Descrição</th>
                                        <th style="width: 60px; text-align: center;">Qtd</th>
                                        <th style="width: 50px; text-align: center;">Un.</th>
                                        <th style="width: 100px; text-align: right;">Preço Unit.</th>
                                        <th style="width: 100px; text-align: right;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for categoria, itens_categoria in template_info.categorias %}
                                        {% if categoria and categoria != 'Serviços' %}
                                        <tr class="table-secondary">
                                            <td colspan="6" class="fw-bold">{{ categoria }}</td>
                                        </tr>
                                        {% endif %}
                                        {% for item in itens_categoria %}
                                        <tr>
                                            <td class="text-center fw-bold">{{ item.item_numero }}</td>
                                            <td style="word-break: break-word;">{{ item.descricao }}</td>
                                            <td class="text-center">{{ "{:,.1f}".format(item.quantidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                            <td class="text-center">{{ item.unidade }}</td>
                                            <td class="text-end">R$ {{ "{:,.2f}".format(item.preco_unitario).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                            <td class="text-end fw-bold text-success">R$ {{ "{:,.2f}".format(item.subtotal).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-info">
                                    <tr class="fw-bold">
                                        <td colspan="5" class="text-end fs-6 py-2">SUBTOTAL:</td>
                                        <td class="text-end fs-6 py-2">R$ {{ "{:,.2f}".format(template_info.subtotal).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Total Geral -->
                <div class="card mb-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none;">
                    <div class="card-body text-center py-4">
                        <h4 class="mb-2" style="font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Valor Total da Proposta</h4>
                        <div style="font-size: 2.5rem; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                            R$ {{ "{:,.2f}".format(total_geral or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Serviços (formato antigo - mantido para compatibilidade) -->
            {% if proposta.servicos %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Serviços</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Qtd</th>
                                    <th>Unidade</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for servico in proposta.servicos %}
                                <tr>
                                    <td>
                                        {{ servico.descricao_servico }}
                                        {% if servico.observacoes %}
                                        <br><small class="text-muted">{{ servico.observacoes }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ servico.quantidade }}</td>
                                    <td>{{ servico.unidade }}</td>
                                    <td>R$ {{ "%.2f"|format(servico.valor_unitario) }}</td>
                                    <td>R$ {{ "%.2f"|format(servico.valor_total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <th colspan="4">Total</th>
                                    <th>R$ {{ "%.2f"|format(proposta.valor_total) }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Logs -->
            {% if proposta.logs %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Histórico</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for log in proposta.logs|reverse %}
                        <div class="timeline-item">
                            <div class="timeline-marker 
                                {% if log.acao == 'aprovada' %}bg-success
                                {% elif log.acao == 'rejeitada' %}bg-danger
                                {% elif log.acao == 'enviada' %}bg-warning
                                {% else %}bg-info{% endif %}">
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">{{ log.acao.title() }}</h6>
                                <p class="mb-1">{{ log.criado_em.strftime('%d/%m/%Y %H:%M') if log.criado_em else '-' }}</p>
                                {% if log.observacoes %}
                                <p class="mb-0 text-muted">{{ log.observacoes }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Status e Informações -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Status</h5>
                </div>
                <div class="card-body">
                    {% set status_class = {
                        'Rascunho': 'secondary',
                        'Enviada': 'warning',
                        'Aprovada': 'success',
                        'Rejeitada': 'danger',
                        'Expirada': 'dark'
                    } %}
                    <span class="badge bg-{{ status_class.get(proposta.status, 'secondary') }} fs-6">
                        {{ proposta.status }}
                    </span>
                    
                    <hr>
                    
                    <p><strong>Valor:</strong><br>R$ {{ "%.2f"|format(proposta.valor_total) }}</p>
                    {% if proposta.criado_em %}
                    <p><strong>Criada em:</strong><br>{{ proposta.criado_em.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                    
                    {% if proposta.data_envio %}
                    <p><strong>Enviada em:</strong><br>{{ proposta.data_envio.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                    
                    {% if proposta.data_resposta %}
                    <p><strong>Respondida em:</strong><br>{{ proposta.data_resposta.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                    
                    {% if proposta.data_expiracao %}
                    <p><strong>Expira em:</strong><br>{{ proposta.data_expiracao.strftime('%d/%m/%Y') }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Portal do Cliente -->
            {% if proposta.token_cliente %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-link me-2"></i>Portal do Cliente</h5>
                </div>
                <div class="card-body">
                    {% if proposta.status == 'rascunho' %}
                    <div class="alert alert-warning py-2 px-3 mb-3 small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Atenção:</strong> Esta proposta está em rascunho. O cliente verá o conteúdo atual.
                    </div>
                    {% endif %}
                    <p class="small text-muted mb-2">Link para o cliente visualizar e aprovar a proposta:</p>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" 
                               value="{{ url_for('propostas.portal_cliente', token=proposta.token_cliente, _external=True) }}" 
                               id="linkPortalCliente" readonly>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copiarLinkPortal(this)">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                    </div>
                    {% if proposta.data_resposta_cliente %}
                    <div class="mt-3">
                        <p class="small text-muted mb-1">Resposta do cliente em:</p>
                        <p class="small mb-1">{{ proposta.data_resposta_cliente.strftime('%d/%m/%Y às %H:%M') }}</p>
                        {% if proposta.observacoes_cliente %}
                        <p class="small">{{ proposta.observacoes_cliente }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Credenciais do Cliente -->
            {% if proposta.login_cliente %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Acesso do Cliente</h5>
                </div>
                <div class="card-body">
                    {% if proposta.token_cliente %}
                    <p><strong>Token de Acesso:</strong><br>
                        <small class="text-muted">{{ proposta.token_cliente[:20] }}...</small>
                    </p>
                    {% endif %}
                    
                    {% if proposta.observacoes_cliente %}
                    <hr>
                    <p><strong>Observações do Cliente:</strong><br>{{ proposta.observacoes_cliente }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.timeline-content {
    padding-left: 15px;
}

/* SweetAlert2 - Fundo transparente para ver a proposta */
.swal2-container {
    background-color: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(3px);
}

.swal2-popup {
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function alterarStatus(novoStatus) {
    Swal.fire({
        title: 'Alterar Status',
        html: `
            <p>Deseja alterar o status para <strong>${novoStatus.toUpperCase()}</strong>?</p>
            <textarea id="motivoStatus" class="form-control mt-3" placeholder="Motivo (opcional)" rows="3"></textarea>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirmar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        backdrop: 'rgba(0, 0, 0, 0.4)',
        customClass: {
            container: 'backdrop-blur'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const motivo = document.getElementById('motivoStatus').value;
            
            fetch(`/propostas/{{ proposta.id }}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: novoStatus,
                    motivo: motivo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: data.message
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao alterar status da proposta'
                });
            });
        }
    });
}

function copiarLinkPortal(btn) {
    const linkInput = document.getElementById('linkPortalCliente');
    if (linkInput) {
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // Para mobile
        
        navigator.clipboard.writeText(linkInput.value).then(() => {
            // Feedback visual
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(err => {
            alert('Erro ao copiar link: ' + err);
        });
    }
}

function excluirProposta() {
    Swal.fire({
        title: 'Excluir Proposta',
        html: `
            <p>Tem certeza que deseja <strong>EXCLUIR PERMANENTEMENTE</strong> esta proposta?</p>
            <p class="text-danger"><strong>Esta ação não pode ser desfeita!</strong></p>
            <textarea id="motivoExclusao" class="form-control mt-3" placeholder="Motivo da exclusão (opcional)" rows="3"></textarea>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        backdrop: 'rgba(0, 0, 0, 0.4)'
    }).then((result) => {
        if (result.isConfirmed) {
            // Criar formulário e enviar POST para deletar
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/propostas/deletar/{{ proposta.id }}';
            
            const motivo = document.getElementById('motivoExclusao').value;
            if (motivo) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'motivo';
                input.value = motivo;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function uploadArquivos() {
    const input = document.getElementById('uploadInput');
    const files = input.files;
    
    if (files.length === 0) return;
    
    // Mostrar loading
    Swal.fire({
        title: 'Enviando arquivos...',
        html: `Fazendo upload de ${files.length} arquivo(s)`,
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('arquivos', files[i]);
    }
    
    fetch('/propostas/{{ proposta.id }}/upload-arquivo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: data.message
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao fazer upload dos arquivos'
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao fazer upload dos arquivos'
        });
    });
}

function deletarArquivo(arquivoId) {
    Swal.fire({
        title: 'Excluir Arquivo',
        text: 'Tem certeza que deseja excluir este arquivo?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/propostas/arquivo/${arquivoId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remover card do arquivo da interface
                    const arquivoCard = document.getElementById(`arquivo-${arquivoId}`);
                    if (arquivoCard) {
                        arquivoCard.remove();
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Arquivo excluído!',
                        text: data.message,
                        timer: 2000
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao excluir arquivo'
                });
            });
        }
    });
}
</script>
{% endblock %}