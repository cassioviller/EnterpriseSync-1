{% extends "base_completo.html" %}

{% block title %}Ponto Facial{% endblock %}

{% block content %}
<div class="ponto-facial-container">
    {% if funcionarios_com_foto == 0 %}
    <div class="d-flex align-items-center justify-content-center h-100">
        <div class="text-center p-4">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
            <h4>Nenhum funcionário com foto</h4>
            <p class="mb-3">Cadastre fotos dos funcionários para usar o reconhecimento facial.</p>
            <a href="{{ url_for('funcionario.lista') }}" class="btn btn-primary">
                <i class="fas fa-users me-2"></i>Cadastrar Fotos
            </a>
        </div>
    </div>
    {% else %}
    
    <div class="row g-3 h-100">
        <div class="col-lg-7 d-flex flex-column">
            <div class="camera-section flex-grow-1 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <a href="{{ url_for('ponto.index') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="text-center">
                        <span id="horario-atual" class="fs-3 fw-bold text-primary">--:--:--</span>
                        <small id="data-atual" class="d-block text-muted">--/--/----</small>
                    </div>
                    <span class="badge bg-info">{{ funcionarios_com_foto }} <i class="fas fa-user"></i></span>
                </div>
                
                <div class="video-container flex-grow-1 position-relative bg-dark rounded-3 overflow-hidden mb-2">
                    <video id="video-preview" autoplay playsinline muted></video>
                    <div id="camera-overlay" class="camera-overlay">
                        <div class="text-center text-white">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p class="mb-0 small">Identificando...</p>
                        </div>
                    </div>
                    <canvas id="canvas-capture" style="display: none;"></canvas>
                </div>
                
                <div id="resultado-container"></div>
            </div>
        </div>
        
        <div class="col-lg-5 d-flex flex-column">
            <div class="controls-section flex-grow-1 d-flex flex-column">
                <div class="mb-2">
                    <select class="form-select form-select-sm" id="obra_id">
                        <option value="">Obra (opcional)</option>
                        {% for obra in obras %}
                        <option value="{{ obra.id }}">{{ obra.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="tipo-ponto-grid mb-2">
                    <button type="button" class="btn-tipo entrada active" data-tipo="entrada">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Entrada</span>
                    </button>
                    <button type="button" class="btn-tipo almoco" data-tipo="almoco_saida">
                        <i class="fas fa-utensils"></i>
                        <span>Almoço</span>
                    </button>
                    <button type="button" class="btn-tipo retorno" data-tipo="almoco_retorno">
                        <i class="fas fa-undo"></i>
                        <span>Retorno</span>
                    </button>
                    <button type="button" class="btn-tipo saida" data-tipo="saida">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Saída</span>
                    </button>
                </div>
                <input type="hidden" id="tipo_ponto" value="entrada">
                
                <button id="btn-registrar" class="btn btn-success btn-lg w-100 py-3 mb-2">
                    <i class="fas fa-camera me-2"></i>
                    Tirar Foto e Registrar
                </button>
                
                <div class="historico-section flex-grow-1 overflow-auto">
                    <div class="small text-muted mb-1">
                        <i class="fas fa-history me-1"></i>Últimos registros
                    </div>
                    <div id="lista-registros" class="registros-lista">
                        <div class="text-center text-muted py-3 small">
                            <i class="fas fa-clock d-block mb-1"></i>
                            Nenhum registro
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
html, body {
    overflow: hidden !important;
    height: 100vh !important;
}

.main-content, .container-fluid, main {
    height: calc(100vh - 56px) !important;
    overflow: hidden !important;
    padding-bottom: 0 !important;
}

.ponto-facial-container {
    height: 100%;
    max-height: calc(100vh - 60px);
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ponto-facial-container > .row {
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

.video-container {
    min-height: 150px;
    max-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
}

.camera-overlay.show {
    display: flex !important;
}

.tipo-ponto-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.btn-tipo {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 0.5rem;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-tipo i {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.btn-tipo span {
    font-size: 0.75rem;
    font-weight: 600;
}

.btn-tipo.entrada { border-color: #0d6efd; color: #0d6efd; }
.btn-tipo.almoco { border-color: #fd7e14; color: #fd7e14; }
.btn-tipo.retorno { border-color: #198754; color: #198754; }
.btn-tipo.saida { border-color: #dc3545; color: #dc3545; }

.btn-tipo.active.entrada { background: #0d6efd; color: white; }
.btn-tipo.active.almoco { background: #fd7e14; color: white; }
.btn-tipo.active.retorno { background: #198754; color: white; }
.btn-tipo.active.saida { background: #dc3545; color: white; }

.btn-tipo:hover:not(.active) {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.registros-lista {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.5rem;
    max-height: 100%;
    overflow-y: auto;
}

.registro-item {
    background: white;
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.375rem;
    font-size: 0.8rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
}

#resultado-container .alert {
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    font-size: 0.9rem;
}

#btn-registrar {
    font-size: 1.1rem;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
}

#btn-registrar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4);
}

@media (max-width: 991.98px) {
    html, body {
        overflow: auto !important;
        height: auto !important;
    }
    
    .main-content, .container-fluid, main {
        height: auto !important;
        overflow: auto !important;
    }
    
    .ponto-facial-container {
        height: auto;
        min-height: calc(100vh - 70px);
    }
    
    .video-container {
        height: 40vh;
        min-height: 250px;
    }
    
    .tipo-ponto-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .btn-tipo {
        padding: 0.5rem 0.25rem;
    }
    
    .btn-tipo i {
        font-size: 1rem;
    }
    
    .btn-tipo span {
        font-size: 0.65rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('video-preview');
    const canvas = document.getElementById('canvas-capture');
    const btnRegistrar = document.getElementById('btn-registrar');
    const cameraOverlay = document.getElementById('camera-overlay');
    const resultadoContainer = document.getElementById('resultado-container');
    const listaRegistros = document.getElementById('lista-registros');
    const horarioAtual = document.getElementById('horario-atual');
    const dataAtual = document.getElementById('data-atual');
    const tipoPontoInput = document.getElementById('tipo_ponto');
    
    let stream = null;
    let registrosRealizados = [];
    
    function atualizarHorario() {
        const agora = new Date();
        horarioAtual.textContent = agora.toLocaleTimeString('pt-BR');
        dataAtual.textContent = agora.toLocaleDateString('pt-BR');
    }
    setInterval(atualizarHorario, 1000);
    atualizarHorario();
    
    async function iniciarCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) {
            console.error('Erro ao acessar câmera:', err);
            resultadoContainer.innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Câmera:</strong> ${err.message}
                </div>
            `;
        }
    }
    
    function capturarFoto() {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.setTransform(-1, 0, 0, 1, canvas.width, 0);
        ctx.drawImage(video, 0, 0);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.8);
    }
    
    document.querySelectorAll('.btn-tipo').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            tipoPontoInput.value = this.dataset.tipo;
        });
    });
    
    async function registrarPonto() {
        const fotoBase64 = capturarFoto();
        const obraId = document.getElementById('obra_id').value;
        const tipoPonto = tipoPontoInput.value;
        
        cameraOverlay.classList.add('show');
        btnRegistrar.disabled = true;
        resultadoContainer.innerHTML = '';
        
        try {
            const response = await fetch('/ponto/api/identificar-e-registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    foto_base64: fotoBase64,
                    obra_id: obraId || null,
                    tipo_ponto: tipoPonto
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultadoContainer.innerHTML = `
                    <div class="alert alert-success d-flex align-items-center py-2">
                        <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                        <div>
                            <strong>${data.funcionario_nome}</strong>
                            <small class="d-block">${data.tipo_registrado} - ${data.hora}</small>
                        </div>
                    </div>
                `;
                
                adicionarRegistro({
                    nome: data.funcionario_nome,
                    codigo: data.funcionario_codigo,
                    tipo: data.tipo_registrado,
                    hora: data.hora
                });
                
                setTimeout(() => { resultadoContainer.innerHTML = ''; }, 4000);
            } else {
                resultadoContainer.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="fas fa-times-circle me-2"></i>${data.message}
                    </div>
                `;
            }
        } catch (err) {
            resultadoContainer.innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>Erro: ${err.message}
                </div>
            `;
        } finally {
            cameraOverlay.classList.remove('show');
            btnRegistrar.disabled = false;
        }
    }
    
    function adicionarRegistro(registro) {
        registrosRealizados.unshift(registro);
        
        if (registrosRealizados.length === 1) {
            listaRegistros.innerHTML = '';
        }
        
        const tipoClass = {
            'entrada': 'text-primary',
            'saída para almoço': 'text-warning',
            'retorno do almoço': 'text-success',
            'saída': 'text-danger'
        };
        
        const cls = tipoClass[registro.tipo] || 'text-secondary';
        
        const item = document.createElement('div');
        item.className = 'registro-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
            <div>
                <strong class="${cls}">${registro.nome}</strong>
                <small class="text-muted d-block">${registro.codigo}</small>
            </div>
            <div class="text-end">
                <span class="badge bg-light text-dark">${registro.tipo}</span>
                <small class="text-muted d-block">${registro.hora}</small>
            </div>
        `;
        
        listaRegistros.insertBefore(item, listaRegistros.firstChild);
        
        if (registrosRealizados.length > 5) {
            listaRegistros.removeChild(listaRegistros.lastChild);
        }
    }
    
    btnRegistrar.addEventListener('click', registrarPonto);
    iniciarCamera();
});
</script>
{% endblock %}
