{% extends "base_completo.html" %}

{% block title %}Ponto Facial{% endblock %}

{% block content %}
<div class="ponto-facial-page">
    {% if funcionarios_com_foto == 0 %}
    <div class="empty-state">
        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
        <h4>Nenhum funcionário com foto</h4>
        <p class="mb-3">Cadastre fotos dos funcionários para usar o reconhecimento facial.</p>
        <a href="{{ url_for('funcionario.lista') }}" class="btn btn-primary">
            <i class="fas fa-users me-2"></i>Cadastrar Fotos
        </a>
    </div>
    {% else %}
    
    <div class="header-bar">
        <a href="{{ url_for('ponto.index') }}" class="btn btn-sm btn-outline-light">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="time-display">
            <span id="horario-atual" class="time">--:--:--</span>
            <span id="data-atual" class="date">--/--/----</span>
        </div>
        <div class="cache-status">
            <span id="cache-badge" class="badge bg-secondary" title="Clique para gerar cache" onclick="gerarCache()">
                <i class="fas fa-database"></i> <span id="cache-count">?</span>
            </span>
        </div>
    </div>
    
    <div class="main-area">
        <div class="camera-wrapper">
            <video id="video-preview" autoplay playsinline muted></video>
            <div id="camera-overlay" class="overlay-loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <span>Identificando...</span>
            </div>
            <canvas id="canvas-capture"></canvas>
        </div>
        
        <div id="resultado-container" class="resultado-area"></div>
    </div>
    
    <div class="controls-area">
        <select class="form-select form-select-sm mb-2" id="obra_id">
            <option value="">Obra (opcional)</option>
            {% for obra in obras %}
            <option value="{{ obra.id }}">{{ obra.nome }}</option>
            {% endfor %}
        </select>
        
        <div class="tipo-buttons">
            <button type="button" class="tipo-btn entrada active" data-tipo="entrada">
                <i class="fas fa-sign-in-alt"></i> Entrada
            </button>
            <button type="button" class="tipo-btn almoco" data-tipo="almoco_saida">
                <i class="fas fa-utensils"></i> Almoço
            </button>
            <button type="button" class="tipo-btn retorno" data-tipo="almoco_retorno">
                <i class="fas fa-undo"></i> Retorno
            </button>
            <button type="button" class="tipo-btn saida" data-tipo="saida">
                <i class="fas fa-sign-out-alt"></i> Saída
            </button>
        </div>
        <input type="hidden" id="tipo_ponto" value="entrada">
        
        <button id="btn-registrar" class="btn-registrar">
            <i class="fas fa-camera"></i> REGISTRAR PONTO
        </button>
    </div>
    
    {% endif %}
</div>

<style>
.ponto-facial-page {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    z-index: 9999;
}

.empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    padding: 20px;
}

.header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(0,0,0,0.3);
}

.time-display {
    text-align: center;
    color: white;
}

.time-display .time {
    display: block;
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
}

.time-display .date {
    font-size: 0.85rem;
    opacity: 0.8;
}

.cache-status .badge {
    cursor: pointer;
    padding: 6px 10px;
    font-size: 0.8rem;
    transition: transform 0.2s;
}

.cache-status .badge:hover {
    transform: scale(1.1);
}

.main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    min-height: 0;
}

.camera-wrapper {
    position: relative;
    width: 100%;
    max-width: 480px;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.camera-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.camera-wrapper canvas {
    display: none;
}

.overlay-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    gap: 10px;
}

.overlay-loading.show {
    display: flex;
}

.resultado-area {
    width: 100%;
    max-width: 480px;
    margin-top: 10px;
}

.resultado-area .alert {
    margin: 0;
    border-radius: 8px;
}

.controls-area {
    padding: 15px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px 20px 0 0;
}

.tipo-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}

.tipo-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: 600;
    transition: all 0.2s;
    gap: 3px;
}

.tipo-btn i {
    font-size: 1.1rem;
}

.tipo-btn.entrada { border-color: #0d6efd; color: #0d6efd; }
.tipo-btn.almoco { border-color: #fd7e14; color: #fd7e14; }
.tipo-btn.retorno { border-color: #198754; color: #198754; }
.tipo-btn.saida { border-color: #dc3545; color: #dc3545; }

.tipo-btn.active.entrada { background: #0d6efd; color: white; }
.tipo-btn.active.almoco { background: #fd7e14; color: white; }
.tipo-btn.active.retorno { background: #198754; color: white; }
.tipo-btn.active.saida { background: #dc3545; color: white; }

.btn-registrar {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #198754, #157347);
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-registrar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.5);
}

.btn-registrar:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

@media (min-width: 768px) {
    .controls-area {
        max-width: 500px;
        margin: 0 auto;
        border-radius: 20px;
        margin-bottom: 20px;
    }
    
    .camera-wrapper {
        max-width: 400px;
    }
    
    .tipo-btn {
        padding: 12px 8px;
        font-size: 0.8rem;
    }
}

@media (max-height: 600px) {
    .camera-wrapper {
        max-width: 320px;
    }
    
    .header-bar {
        padding: 5px 10px;
    }
    
    .time-display .time {
        font-size: 1.3rem;
    }
    
    .controls-area {
        padding: 10px;
    }
    
    .tipo-btn {
        padding: 6px 3px;
    }
    
    .btn-registrar {
        padding: 12px;
        font-size: 1rem;
    }
}
</style>

<script>
async function verificarCache() {
    try {
        const response = await fetch('/ponto/api/cache/status');
        const data = await response.json();
        const badge = document.getElementById('cache-badge');
        const count = document.getElementById('cache-count');
        
        if (data.disponivel) {
            badge.className = 'badge bg-success';
            badge.title = `Cache OK: ${data.total_embeddings} funcionários. Clique para regenerar.`;
            count.textContent = data.total_embeddings;
        } else {
            badge.className = 'badge bg-warning text-dark';
            badge.title = 'Cache não disponível. Clique para gerar.';
            count.textContent = '!';
        }
    } catch (err) {
        console.error('Erro ao verificar cache:', err);
    }
}

async function gerarCache() {
    const badge = document.getElementById('cache-badge');
    const count = document.getElementById('cache-count');
    
    if (!confirm('Gerar cache de embeddings faciais? Isso pode levar alguns minutos.')) {
        return;
    }
    
    badge.className = 'badge bg-info';
    count.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch('/ponto/api/cache/gerar', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            badge.className = 'badge bg-success';
            count.textContent = data.processados;
            alert(`Cache gerado! ${data.processados} funcionários processados.`);
        } else {
            badge.className = 'badge bg-danger';
            count.textContent = '!';
            alert('Erro: ' + data.message);
        }
    } catch (err) {
        badge.className = 'badge bg-danger';
        count.textContent = '!';
        alert('Erro ao gerar cache: ' + err.message);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    verificarCache();
    
    const video = document.getElementById('video-preview');
    const canvas = document.getElementById('canvas-capture');
    const btnRegistrar = document.getElementById('btn-registrar');
    const cameraOverlay = document.getElementById('camera-overlay');
    const resultadoContainer = document.getElementById('resultado-container');
    const horarioAtual = document.getElementById('horario-atual');
    const dataAtual = document.getElementById('data-atual');
    const tipoPontoInput = document.getElementById('tipo_ponto');
    
    function atualizarHorario() {
        const agora = new Date();
        horarioAtual.textContent = agora.toLocaleTimeString('pt-BR');
        dataAtual.textContent = agora.toLocaleDateString('pt-BR');
    }
    setInterval(atualizarHorario, 1000);
    atualizarHorario();
    
    async function iniciarCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) {
            console.error('Erro câmera:', err);
            resultadoContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Câmera não disponível: ${err.message}
                </div>
            `;
        }
    }
    
    function capturarFoto() {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.setTransform(-1, 0, 0, 1, canvas.width, 0);
        ctx.drawImage(video, 0, 0);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.8);
    }
    
    document.querySelectorAll('.tipo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            tipoPontoInput.value = this.dataset.tipo;
        });
    });
    
    async function registrarPonto() {
        const fotoBase64 = capturarFoto();
        const obraId = document.getElementById('obra_id').value;
        const tipoPonto = tipoPontoInput.value;
        
        cameraOverlay.classList.add('show');
        btnRegistrar.disabled = true;
        resultadoContainer.innerHTML = '';
        
        try {
            const response = await fetch('/ponto/api/identificar-e-registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    foto_base64: fotoBase64,
                    obra_id: obraId || null,
                    tipo_ponto: tipoPonto
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultadoContainer.innerHTML = `
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <strong>${data.funcionario_nome}</strong>
                            <div>${data.tipo_registrado} - ${data.hora}</div>
                        </div>
                    </div>
                `;
                setTimeout(() => { resultadoContainer.innerHTML = ''; }, 5000);
            } else {
                resultadoContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>${data.message}
                    </div>
                `;
            }
        } catch (err) {
            resultadoContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Erro: ${err.message}
                </div>
            `;
        } finally {
            cameraOverlay.classList.remove('show');
            btnRegistrar.disabled = false;
        }
    }
    
    btnRegistrar.addEventListener('click', registrarPonto);
    iniciarCamera();
});
</script>
{% endblock %}
