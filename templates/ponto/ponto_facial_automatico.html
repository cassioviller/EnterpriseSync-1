{% extends "base_completo.html" %}

{% block title %}Ponto Facial{% endblock %}

{% block content %}
<div class="ponto-facial-page">
    {% if funcionarios_com_foto == 0 %}
    <div class="empty-state">
        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
        <h4>Nenhum funcionário com foto</h4>
        <p class="mb-3">Cadastre fotos dos funcionários para usar o reconhecimento facial.</p>
        <a href="{{ url_for('funcionario.lista') }}" class="btn btn-primary">
            <i class="fas fa-users me-2"></i>Cadastrar Fotos
        </a>
    </div>
    {% else %}
    
    <div class="header-bar">
        <a href="{{ url_for('ponto.index') }}" class="btn btn-sm btn-outline-light">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="time-display">
            <span id="horario-atual" class="time">--:--:--</span>
            <span id="data-atual" class="date">--/--/----</span>
        </div>
        <button type="button" 
                id="btn-cache-status" 
                class="btn btn-sm btn-secondary"
                onclick="abrirModalCache()"
                title="Clique para gerenciar cache">
            <i class="fas fa-database"></i>
            <span id="cache-badge-text">Verificando...</span>
        </button>
    </div>
    
    <!-- Modal de Gerenciamento de Cache -->
    <div class="modal fade" id="modalCache" tabindex="-1" aria-labelledby="modalCacheLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalCacheLabel">
                        <i class="fas fa-database"></i> Gerenciamento de Cache Facial
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- Status do Cache -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Status Atual</h6>
                        </div>
                        <div class="card-body" id="cache-status-detalhado">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="mt-2 text-muted">Carregando informações...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ações -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-cog"></i> Ações</h6>
                        </div>
                        <div class="card-body">
                            <button type="button" 
                                    id="btn-gerar-cache-modal" 
                                    class="btn btn-success w-100 btn-lg">
                                <i class="fas fa-sync"></i> Gerar/Atualizar Cache
                            </button>
                            
                            <div id="progress-cache" style="display: none;" class="mt-3">
                                <div class="progress" style="height: 25px;">
                                    <div id="progress-cache-bar" 
                                         class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                         role="progressbar" 
                                         style="width: 0%;">
                                        0%
                                    </div>
                                </div>
                                <small id="progress-cache-text" class="text-muted d-block text-center mt-2">
                                    Processando...
                                </small>
                            </div>
                            
                            <div id="resultado-cache" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- Informações -->
                    <div class="alert alert-info mt-3 mb-0">
                        <strong><i class="fas fa-lightbulb"></i> O que é o Cache?</strong><br>
                        <small>
                            O cache armazena "impressões digitais" faciais pré-calculadas de todos os funcionários.
                            Isso acelera o reconhecimento de <strong>10-15 segundos</strong> para <strong>2-5 segundos</strong>!
                        </small>
                    </div>
                    
                    <div class="alert alert-warning mt-2 mb-0">
                        <strong><i class="fas fa-exclamation-triangle"></i> Quando atualizar?</strong><br>
                        <small>
                            • Sempre que adicionar ou remover fotos de funcionários<br>
                            • Quando cadastrar novos funcionários<br>
                            • Se o reconhecimento estiver demorando muito
                        </small>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-area">
        <div class="camera-wrapper">
            <video id="video-preview" autoplay playsinline muted></video>
            <div id="camera-overlay" class="overlay-loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <span>Identificando...</span>
            </div>
            <canvas id="canvas-capture"></canvas>
        </div>
        
        <div id="resultado-container" class="resultado-area"></div>
    </div>
    
    <div class="controls-area">
        <select class="form-select form-select-sm mb-2" id="obra_id">
            <option value="">Obra (opcional)</option>
            {% for obra in obras %}
            <option value="{{ obra.id }}">{{ obra.nome }}</option>
            {% endfor %}
        </select>
        
        <div class="tipo-buttons">
            <button type="button" class="tipo-btn entrada active" data-tipo="entrada">
                <i class="fas fa-sign-in-alt"></i> Entrada
            </button>
            <button type="button" class="tipo-btn almoco" data-tipo="almoco_saida">
                <i class="fas fa-utensils"></i> Almoço
            </button>
            <button type="button" class="tipo-btn retorno" data-tipo="almoco_retorno">
                <i class="fas fa-undo"></i> Retorno
            </button>
            <button type="button" class="tipo-btn saida" data-tipo="saida">
                <i class="fas fa-sign-out-alt"></i> Saída
            </button>
        </div>
        <input type="hidden" id="tipo_ponto" value="entrada">
        
        <button id="btn-registrar" class="btn-registrar">
            <i class="fas fa-camera"></i> REGISTRAR PONTO
        </button>
    </div>
    
    {% endif %}
</div>

<style>
.ponto-facial-page {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    z-index: 9999;
}

.empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    padding: 20px;
}

.header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(0,0,0,0.3);
}

.time-display {
    text-align: center;
    color: white;
}

.time-display .time {
    display: block;
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
}

.time-display .date {
    font-size: 0.85rem;
    opacity: 0.8;
}

#btn-cache-status {
    border-radius: 20px;
    padding: 6px 12px;
    font-weight: 600;
    font-size: 0.8rem;
    transition: transform 0.2s, box-shadow 0.2s;
}

#btn-cache-status:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    min-height: 0;
}

.camera-wrapper {
    position: relative;
    width: 100%;
    max-width: 480px;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.camera-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.camera-wrapper canvas {
    display: none;
}

.overlay-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    gap: 10px;
}

.overlay-loading.show {
    display: flex;
}

.resultado-area {
    width: 100%;
    max-width: 480px;
    margin-top: 10px;
}

.resultado-area .alert {
    margin: 0;
    border-radius: 8px;
}

.controls-area {
    padding: 15px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px 20px 0 0;
}

.tipo-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}

.tipo-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: 600;
    transition: all 0.2s;
    gap: 3px;
}

.tipo-btn i {
    font-size: 1.1rem;
}

.tipo-btn.entrada { border-color: #0d6efd; color: #0d6efd; }
.tipo-btn.almoco { border-color: #fd7e14; color: #fd7e14; }
.tipo-btn.retorno { border-color: #198754; color: #198754; }
.tipo-btn.saida { border-color: #dc3545; color: #dc3545; }

.tipo-btn.active.entrada { background: #0d6efd; color: white; }
.tipo-btn.active.almoco { background: #fd7e14; color: white; }
.tipo-btn.active.retorno { background: #198754; color: white; }
.tipo-btn.active.saida { background: #dc3545; color: white; }

.btn-registrar {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #198754, #157347);
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-registrar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.5);
}

.btn-registrar:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

@media (min-width: 768px) {
    .controls-area {
        max-width: 500px;
        margin: 0 auto;
        border-radius: 20px;
        margin-bottom: 20px;
    }
    
    .camera-wrapper {
        max-width: 400px;
    }
    
    .tipo-btn {
        padding: 12px 8px;
        font-size: 0.8rem;
    }
}

@media (max-height: 600px) {
    .camera-wrapper {
        max-width: 320px;
    }
    
    .header-bar {
        padding: 5px 10px;
    }
    
    .time-display .time {
        font-size: 1.3rem;
    }
    
    .controls-area {
        padding: 10px;
    }
    
    .tipo-btn {
        padding: 6px 3px;
    }
    
    .btn-registrar {
        padding: 12px;
        font-size: 1rem;
    }
}
</style>

<script>
// ============================================================
// SISTEMA DE GERENCIAMENTO DE CACHE FACIAL
// ============================================================

let cacheStatus = null;
let modalCacheInstance = null;

// Abrir modal de cache
function abrirModalCache() {
    if (!modalCacheInstance) {
        modalCacheInstance = new bootstrap.Modal(document.getElementById('modalCache'));
    }
    modalCacheInstance.show();
    verificarStatusCacheDetalhado();
}

// Verificar status do cache (badge no header)
async function verificarStatusCacheBadge() {
    try {
        const response = await fetch('/ponto/api/cache/status');
        const data = await response.json();
        
        const btnCache = document.getElementById('btn-cache-status');
        const badgeText = document.getElementById('cache-badge-text');
        
        if (data.disponivel) {
            const total = data.total_embeddings || 0;
            btnCache.className = 'btn btn-sm btn-success';
            badgeText.innerHTML = `<i class="fas fa-check-circle"></i> ${total} Func.`;
            btnCache.title = `Cache ativo com ${total} funcionários - Clique para gerenciar`;
            cacheStatus = data;
        } else {
            btnCache.className = 'btn btn-sm btn-warning';
            badgeText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sem Cache';
            btnCache.title = 'Cache não disponível - Clique para gerar';
            cacheStatus = null;
        }
        
    } catch (error) {
        console.error('Erro ao verificar cache:', error);
        const btnCache = document.getElementById('btn-cache-status');
        const badgeText = document.getElementById('cache-badge-text');
        btnCache.className = 'btn btn-sm btn-danger';
        badgeText.innerHTML = '<i class="fas fa-times-circle"></i> Erro';
        btnCache.title = 'Erro ao verificar cache';
    }
}

// Verificar status detalhado (dentro do modal)
async function verificarStatusCacheDetalhado() {
    const statusDiv = document.getElementById('cache-status-detalhado');
    
    try {
        const response = await fetch('/ponto/api/cache/status');
        const data = await response.json();
        
        if (data.disponivel) {
            const geradoEm = data.gerado_em || 'Não informado';
            const totalEmb = data.total_embeddings || 0;
            const totalFotos = data.total_fotos || 0;
            const modelo = data.modelo || 'SFace';
            
            let funcionariosHtml = '';
            if (data.funcionarios && data.funcionarios.length > 0) {
                funcionariosHtml = `
                    <hr>
                    <h6>Funcionários no Cache:</h6>
                    <ul class="mb-0">
                        ${data.funcionarios.map(f => `<li>${f.nome} (${f.fotos} fotos)</li>`).join('')}
                    </ul>
                `;
            }
            
            statusDiv.innerHTML = `
                <div class="alert alert-success mb-0">
                    <h5><i class="fas fa-check-circle"></i> Cache Ativo</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Funcionários:</strong> ${totalEmb}</p>
                            <p class="mb-1"><strong>Total de fotos:</strong> ${totalFotos}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Modelo:</strong> ${modelo}</p>
                            <p class="mb-0"><strong>Gerado em:</strong> ${geradoEm}</p>
                        </div>
                    </div>
                    ${funcionariosHtml}
                </div>
            `;
            
            cacheStatus = data;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <h5><i class="fas fa-exclamation-triangle"></i> Cache Não Disponível</h5>
                    <hr>
                    <p class="mb-0">${data.message || 'Cache não foi gerado ainda.'}</p>
                    <p class="mt-2 mb-0"><strong>Impacto:</strong> Reconhecimento facial pode demorar 10-15 segundos.</p>
                </div>
            `;
            
            cacheStatus = null;
        }
        
    } catch (error) {
        console.error('Erro ao verificar cache:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-danger mb-0">
                <h5><i class="fas fa-times-circle"></i> Erro ao Verificar Cache</h5>
                <hr>
                <p class="mb-0">Não foi possível obter informações do cache.</p>
            </div>
        `;
    }
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    // Verificar status do cache ao carregar
    verificarStatusCacheBadge();
    
    // Atualizar a cada 30 segundos
    setInterval(verificarStatusCacheBadge, 30000);
    
    // Configurar botão de gerar cache no modal
    const btnGerarCache = document.getElementById('btn-gerar-cache-modal');
    if (btnGerarCache) {
        btnGerarCache.addEventListener('click', async function() {
            const btn = this;
            const progressDiv = document.getElementById('progress-cache');
            const progressBar = document.getElementById('progress-cache-bar');
            const progressText = document.getElementById('progress-cache-text');
            const resultadoDiv = document.getElementById('resultado-cache');
            
            // Desabilitar botão
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            progressDiv.style.display = 'block';
            resultadoDiv.style.display = 'none';
            
            // Simular progresso
            let progresso = 0;
            const intervalo = setInterval(() => {
                progresso += 5;
                if (progresso <= 90) {
                    progressBar.style.width = progresso + '%';
                    progressBar.textContent = progresso + '%';
                    progressText.textContent = `Processando embeddings faciais... ${progresso}%`;
                }
            }, 500);
            
            try {
                const response = await fetch('/ponto/api/cache/gerar', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                clearInterval(intervalo);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = 'Concluído!';
                
                if (data.success) {
                    resultadoDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Cache Gerado com Sucesso!</h5>
                            <hr>
                            <p class="mb-1"><strong>Funcionários processados:</strong> ${data.processados}/${data.total}</p>
                            ${data.erros > 0 ? `<p class="mb-0 text-warning"><strong>Erros:</strong> ${data.erros} funcionário(s) não puderam ser processados</p>` : ''}
                        </div>
                    `;
                    
                    // Atualizar badge e status detalhado
                    verificarStatusCacheBadge();
                    verificarStatusCacheDetalhado();
                } else {
                    resultadoDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-times-circle"></i> Erro ao Gerar Cache</h5>
                            <hr>
                            <p class="mb-0">${data.message || 'Erro desconhecido'}</p>
                        </div>
                    `;
                }
                
                resultadoDiv.style.display = 'block';
                
            } catch (error) {
                clearInterval(intervalo);
                console.error('Erro ao gerar cache:', error);
                
                resultadoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-times-circle"></i> Erro de Conexão</h5>
                        <hr>
                        <p class="mb-0">Não foi possível comunicar com o servidor: ${error.message}</p>
                    </div>
                `;
                resultadoDiv.style.display = 'block';
                
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Gerar/Atualizar Cache';
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            }
        });
    }
    
    // Restante da inicialização da página
    
    const video = document.getElementById('video-preview');
    const canvas = document.getElementById('canvas-capture');
    const btnRegistrar = document.getElementById('btn-registrar');
    const cameraOverlay = document.getElementById('camera-overlay');
    const resultadoContainer = document.getElementById('resultado-container');
    const horarioAtual = document.getElementById('horario-atual');
    const dataAtual = document.getElementById('data-atual');
    const tipoPontoInput = document.getElementById('tipo_ponto');
    
    function atualizarHorario() {
        const agora = new Date();
        horarioAtual.textContent = agora.toLocaleTimeString('pt-BR');
        dataAtual.textContent = agora.toLocaleDateString('pt-BR');
    }
    setInterval(atualizarHorario, 1000);
    atualizarHorario();
    
    async function iniciarCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) {
            console.error('Erro câmera:', err);
            resultadoContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Câmera não disponível: ${err.message}
                </div>
            `;
        }
    }
    
    function capturarFoto() {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.setTransform(-1, 0, 0, 1, canvas.width, 0);
        ctx.drawImage(video, 0, 0);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.8);
    }
    
    document.querySelectorAll('.tipo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            tipoPontoInput.value = this.dataset.tipo;
        });
    });
    
    async function obterLocalizacao() {
        return new Promise((resolve) => {
            if (!navigator.geolocation) {
                console.log('Geolocalização não suportada');
                resolve({ latitude: null, longitude: null });
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                },
                (error) => {
                    console.log('Erro ao obter localização:', error.message);
                    resolve({ latitude: null, longitude: null });
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        });
    }
    
    async function registrarPonto() {
        const fotoBase64 = capturarFoto();
        const obraId = document.getElementById('obra_id').value;
        const tipoPonto = tipoPontoInput.value;
        
        cameraOverlay.classList.add('show');
        btnRegistrar.disabled = true;
        resultadoContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Obtendo localização...</div>';
        
        // Capturar localização GPS
        const { latitude, longitude } = await obterLocalizacao();
        
        resultadoContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Identificando...</div>';
        
        try {
            const response = await fetch('/ponto/api/identificar-e-registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    foto_base64: fotoBase64,
                    obra_id: obraId || null,
                    tipo_ponto: tipoPonto,
                    latitude: latitude,
                    longitude: longitude
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                let distanciaInfo = '';
                if (data.distancia_obra !== undefined && data.distancia_obra !== null) {
                    distanciaInfo = ` (${Math.round(data.distancia_obra)}m da obra)`;
                }
                let tempoInfo = data.tempo_processamento ? ` em ${data.tempo_processamento}s` : '';
                resultadoContainer.innerHTML = `
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <strong>${data.funcionario_nome}</strong>
                            <div>${data.tipo_registrado} - ${data.hora}${distanciaInfo}</div>
                            <small class="text-muted">Identificado${tempoInfo}</small>
                        </div>
                    </div>
                `;
                setTimeout(() => { resultadoContainer.innerHTML = ''; }, 5000);
            } else {
                resultadoContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>${data.message}
                    </div>
                `;
            }
        } catch (err) {
            resultadoContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Erro: ${err.message}
                </div>
            `;
        } finally {
            cameraOverlay.classList.remove('show');
            btnRegistrar.disabled = false;
        }
    }
    
    btnRegistrar.addEventListener('click', registrarPonto);
    iniciarCamera();
});
</script>
{% endblock %}
