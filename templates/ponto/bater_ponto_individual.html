{% extends "base_completo.html" %}

{% block title %}Bater Ponto - {{ funcionario.nome }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <a href="{{ url_for('ponto.index') }}" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-body text-center p-4">
                    {% if funcionario.foto_base64 %}
                    <img src="{{ funcionario.foto_base64 }}" 
                         alt="{{ funcionario.nome }}" 
                         class="rounded-circle mb-3"
                         style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3"
                         style="width: 150px; height: 150px; font-size: 60px;">
                        {{ funcionario.nome[0].upper() }}
                    </div>
                    {% endif %}
                    
                    <h3 class="mb-1">{{ funcionario.nome }}</h3>
                    <p class="text-muted mb-4">{{ funcionario.codigo }}</p>
                    
                    <div class="alert alert-info mb-4">
                        <h4 id="horario-atual" class="mb-0">{{ agora.strftime('%H:%M:%S') }}</h4>
                        <small>{{ hoje.strftime('%d/%m/%Y') }}</small>
                    </div>
                    
                    {% if registro_hoje %}
                    <div class="alert alert-secondary mb-4">
                        <h6 class="mb-2">Registro de Hoje:</h6>
                        <div class="row text-start">
                            {% if registro_hoje.hora_entrada %}
                            <div class="col-6">
                                <small class="text-muted">Entrada</small>
                                <div><strong>{{ registro_hoje.hora_entrada.strftime('%H:%M') }}</strong></div>
                            </div>
                            {% endif %}
                            {% if registro_hoje.hora_almoco_saida %}
                            <div class="col-6">
                                <small class="text-muted">Almoço Saída</small>
                                <div><strong>{{ registro_hoje.hora_almoco_saida.strftime('%H:%M') }}</strong></div>
                            </div>
                            {% endif %}
                            {% if registro_hoje.hora_almoco_retorno %}
                            <div class="col-6 mt-2">
                                <small class="text-muted">Almoço Retorno</small>
                                <div><strong>{{ registro_hoje.hora_almoco_retorno.strftime('%H:%M') }}</strong></div>
                            </div>
                            {% endif %}
                            {% if registro_hoje.hora_saida %}
                            <div class="col-6 mt-2">
                                <small class="text-muted">Saída</small>
                                <div><strong>{{ registro_hoje.hora_saida.strftime('%H:%M') }}</strong></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <form id="form-ponto" method="POST">
                        <div class="mb-4">
                            <label for="obra_id" class="form-label">
                                <i class="fas fa-building me-2"></i>
                                Selecione a Obra
                            </label>
                            <select class="form-select form-select-lg" id="obra_id" name="obra_id" required>
                                <option value="">Escolha uma obra...</option>
                                {% for obra in obras %}
                                <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-clock me-2"></i>
                                Tipo de Registro <small class="text-muted">(pré-selecionado por horário)</small>
                            </label>
                            
                            {% if registro_hoje and registro_hoje.hora_entrada and registro_hoje.hora_almoco_saida and registro_hoje.hora_almoco_retorno and registro_hoje.hora_saida %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Jornada completa registrada!
                            </div>
                            {% else %}
                            <div class="row g-2">
                                <div class="col-6">
                                    <button type="button" class="btn btn-tipo-ponto w-100 py-3 {{ 'btn-primary' if tipo_sugerido == 'entrada' else 'btn-outline-primary' }} {{ 'disabled opacity-50' if registro_hoje and registro_hoje.hora_entrada else '' }}" 
                                            data-tipo="entrada" 
                                            {{ 'disabled' if registro_hoje and registro_hoje.hora_entrada else '' }}>
                                        <i class="fas fa-sign-in-alt d-block mb-1" style="font-size: 1.5rem;"></i>
                                        <span class="fw-bold">Entrada</span>
                                        <br><small class="text-muted">00:00 - 11:30</small>
                                        {% if registro_hoje and registro_hoje.hora_entrada %}
                                        <br><span class="badge bg-success mt-1">{{ registro_hoje.hora_entrada.strftime('%H:%M') }}</span>
                                        {% endif %}
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-tipo-ponto w-100 py-3 {{ 'btn-warning' if tipo_sugerido == 'almoco_saida' else 'btn-outline-warning' }} {{ 'disabled opacity-50' if registro_hoje and registro_hoje.hora_almoco_saida else '' }}" 
                                            data-tipo="almoco_saida"
                                            {{ 'disabled' if registro_hoje and registro_hoje.hora_almoco_saida else '' }}>
                                        <i class="fas fa-utensils d-block mb-1" style="font-size: 1.5rem;"></i>
                                        <span class="fw-bold">Almoço</span>
                                        <br><small class="text-muted">11:31 - 12:30</small>
                                        {% if registro_hoje and registro_hoje.hora_almoco_saida %}
                                        <br><span class="badge bg-success mt-1">{{ registro_hoje.hora_almoco_saida.strftime('%H:%M') }}</span>
                                        {% endif %}
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-tipo-ponto w-100 py-3 {{ 'btn-success' if tipo_sugerido == 'almoco_retorno' else 'btn-outline-success' }} {{ 'disabled opacity-50' if registro_hoje and registro_hoje.hora_almoco_retorno else '' }}" 
                                            data-tipo="almoco_retorno"
                                            {{ 'disabled' if registro_hoje and registro_hoje.hora_almoco_retorno else '' }}>
                                        <i class="fas fa-undo d-block mb-1" style="font-size: 1.5rem;"></i>
                                        <span class="fw-bold">Retorno</span>
                                        <br><small class="text-muted">12:31 - 14:00</small>
                                        {% if registro_hoje and registro_hoje.hora_almoco_retorno %}
                                        <br><span class="badge bg-success mt-1">{{ registro_hoje.hora_almoco_retorno.strftime('%H:%M') }}</span>
                                        {% endif %}
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-tipo-ponto w-100 py-3 {{ 'btn-danger' if tipo_sugerido == 'saida' else 'btn-outline-danger' }} {{ 'disabled opacity-50' if registro_hoje and registro_hoje.hora_saida else '' }}" 
                                            data-tipo="saida"
                                            {{ 'disabled' if registro_hoje and registro_hoje.hora_saida else '' }}>
                                        <i class="fas fa-sign-out-alt d-block mb-1" style="font-size: 1.5rem;"></i>
                                        <span class="fw-bold">Saída</span>
                                        <br><small class="text-muted">14:01 - 23:59</small>
                                        {% if registro_hoje and registro_hoje.hora_saida %}
                                        <br><span class="badge bg-success mt-1">{{ registro_hoje.hora_saida.strftime('%H:%M') }}</span>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="tipo_ponto" name="tipo_ponto" value="{{ tipo_sugerido }}">
                            {% endif %}
                        </div>
                        
                        {% if not registro_hoje or not registro_hoje.hora_saida %}
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="btn-bater-ponto">
                                <i class="fas fa-fingerprint me-2"></i>
                                Confirmar Ponto
                            </button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Atualizar relógio
function atualizarRelogio() {
    const agora = new Date();
    const horas = String(agora.getHours()).padStart(2, '0');
    const minutos = String(agora.getMinutes()).padStart(2, '0');
    const segundos = String(agora.getSeconds()).padStart(2, '0');
    document.getElementById('horario-atual').textContent = `${horas}:${minutos}:${segundos}`;
}

setInterval(atualizarRelogio, 1000);

// Selecionar tipo de ponto (manual)
document.querySelectorAll('.btn-tipo-ponto:not([disabled])').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remover seleção de todos os botões não desabilitados
        document.querySelectorAll('.btn-tipo-ponto:not([disabled])').forEach(b => {
            // Resetar para outline
            b.classList.remove('btn-primary', 'btn-warning', 'btn-success', 'btn-danger');
            if (b.dataset.tipo === 'entrada') b.classList.add('btn-outline-primary');
            if (b.dataset.tipo === 'almoco_saida') b.classList.add('btn-outline-warning');
            if (b.dataset.tipo === 'almoco_retorno') b.classList.add('btn-outline-success');
            if (b.dataset.tipo === 'saida') b.classList.add('btn-outline-danger');
        });
        
        // Aplicar seleção ao botão clicado
        this.classList.remove('btn-outline-primary', 'btn-outline-warning', 'btn-outline-success', 'btn-outline-danger');
        if (this.dataset.tipo === 'entrada') this.classList.add('btn-primary');
        if (this.dataset.tipo === 'almoco_saida') this.classList.add('btn-warning');
        if (this.dataset.tipo === 'almoco_retorno') this.classList.add('btn-success');
        if (this.dataset.tipo === 'saida') this.classList.add('btn-danger');
        
        document.getElementById('tipo_ponto').value = this.dataset.tipo;
    });
});

// Enviar formulário via AJAX
document.getElementById('form-ponto').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const obraId = document.getElementById('obra_id').value;
    const tipoPonto = document.getElementById('tipo_ponto').value;
    
    if (!obraId) {
        alert('Por favor, selecione uma obra!');
        return;
    }
    
    const btnSubmit = document.getElementById('btn-bater-ponto');
    btnSubmit.disabled = true;
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registrando...';
    
    try {
        const response = await fetch('{{ url_for("ponto.api_bater_ponto") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                funcionario_id: {{ funcionario.id }},
                obra_id: parseInt(obraId),
                tipo_ponto: tipoPonto,
                latitude: null,
                longitude: null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Ponto registrado com sucesso!');
            window.location.reload();
        } else {
            alert('Erro: ' + data.error);
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Confirmar Ponto';
        }
    } catch (error) {
        alert('Erro ao registrar ponto: ' + error.message);
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Confirmar Ponto';
    }
});
</script>
{% endblock %}
