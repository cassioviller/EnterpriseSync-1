{% extends "base_completo.html" %}

{% block title %}Dashboard - SIGE{% endblock %}

{% block content %}

<!-- Botão Flutuante Mobile -->
<div class="floating-action d-lg-none">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickActionModal">
        <i class="fas fa-plus"></i>
    </button>
</div>

<!-- Modal de Ações Rápidas Mobile -->
<div class="modal fade" id="quickActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ações Rápidas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.funcionarios') }}" class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i> Gerenciar Funcionários
                    </a>
                    <a href="{{ url_for('main.obras') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-hammer me-2"></i> Ver Obras
                    </a>
                    <a href="/funcionario/rdo/consolidado" class="btn btn-outline-info">
                        <i class="fas fa-clipboard-list me-2"></i> RDOs
                    </a>
                    <a href="/ponto" class="btn btn-outline-warning">
                        <i class="fas fa-clock me-2"></i> Controle de Ponto
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Correção de alinhamento para botões do header */
.header-btn {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0.5rem 1rem !important;
    min-height: 38px !important;
    white-space: nowrap !important;
    vertical-align: middle !important;
}

.header-btn i {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 16px !important;
    height: 16px !important;
    margin-right: 0.5rem !important;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    vertical-align: middle !important;
    line-height: 1 !important;
}

.header-btn span {
    display: inline-flex !important;
    align-items: center !important;
    height: 16px !important;
    line-height: 16px !important;
    vertical-align: middle !important;
    margin: 0 !important;
}

/* Correção específica para btn-group */
.btn-group .header-btn {
    border-radius: 0 !important;
}

.btn-group .header-btn:first-child {
    border-top-left-radius: 0.375rem !important;
    border-bottom-left-radius: 0.375rem !important;
}

.btn-group .header-btn:last-child {
    border-top-right-radius: 0.375rem !important;
    border-bottom-right-radius: 0.375rem !important;
}

/* Garantir alinhamento em qualquer dispositivo */
@media (max-width: 768px) {
    .header-btn {
        min-height: 36px !important;
        padding: 0.4rem 0.8rem !important;
    }
}

/* Correção global para todos os ícones e textos desalinhados */
.card-title i,
.btn i,
.nav-link i,
.dropdown-item i {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 16px !important;
    height: 16px !important;
    margin-right: 0.5rem !important;
    vertical-align: middle !important;
    line-height: 1 !important;
}

/* Correção para elementos de formulário */
.form-label,
.btn span,
.card-title,
.nav-link span {
    display: inline-flex !important;
    align-items: center !important;
    vertical-align: middle !important;
    line-height: 1.4 !important;
}

/* Correção específica para tema escuro */
html[data-bs-theme="dark"] .header-btn {
    color: inherit !important;
}

html[data-bs-theme="dark"] .header-btn i {
    color: inherit !important;
}

/* Correção para navbar e outros componentes */
.navbar-nav .nav-link {
    display: inline-flex !important;
    align-items: center !important;
    padding: 0.5rem 1rem !important;
}

.card-header .card-title {
    display: inline-flex !important;
    align-items: center !important;
    margin-bottom: 0 !important;
}

/* Estilo para títulos de seção */
.section-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    color: white !important;
    padding: 12px 20px;
    border-radius: 8px;
    margin-top: 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-header h4 {
    margin: 0;
    font-weight: 600;
    color: white !important;
}

.section-header i {
    margin-right: 8px;
    color: white !important;
}
</style>

<div class="container-fluid">
    <!-- Header simplificado -->
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="h3 mb-0">Dashboard SIGE</h1>
        </div>
    </div>

    <!-- Filtros de Data Globais -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-calendar"></i> Filtros de Data
            </h5>
        </div>
        <div class="card-body">
            <form id="filtroFormDashboard" method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Data Inicial</label>
                    <input type="date" name="data_inicio" class="form-control" id="data_inicio_dash"
                           value="{{ data_inicio.strftime('%Y-%m-%d') if data_inicio else '2025-07-01' }}" 
                           onchange="aplicarFiltrosDashboard()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Final</label>
                    <input type="date" name="data_fim" class="form-control" id="data_fim_dash"
                           value="{{ data_fim.strftime('%Y-%m-%d') if data_fim else '2025-07-31' }}"
                           onchange="aplicarFiltrosDashboard()">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter"></i> Aplicar Filtro
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="setDateRangeDashboard('mes_atual')">Mês Atual</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="setDateRangeDashboard('ultimo_mes')">Último Mês</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="setDateRangeDashboard('ultimos_3_meses')">3 Meses</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="setDateRangeDashboard('ano_atual')">Ano Atual</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="section-header">
        <h4><i class="fas fa-dollar-sign"></i> Financeiro e Custos</h4>
    </div>

    <!-- Custos Detalhados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie"></i> Custos Detalhados do Período
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-utensils fa-2x text-warning mb-2"></i>
                                <h6>Alimentação</h6>
                                <h5 class="text-warning">R$ {{ '{:,.2f}'.format(custos_detalhados.alimentacao).replace(',', '.') }}</h5>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-car fa-2x text-info mb-2"></i>
                                <h6>Transporte</h6>
                                <h5 class="text-info">R$ {{ '{:,.2f}'.format(custos_detalhados.transporte).replace(',', '.') }}</h5>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-users fa-2x text-success mb-2"></i>
                                <h6>Mão de Obra</h6>
                                <h5 class="text-success">R$ {{ '{:,.2f}'.format(custos_detalhados.mao_obra).replace(',', '.') }}</h5>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                <h6>Faltas Justificadas</h6>
                                <h5 class="text-warning">{{ custos_detalhados.faltas_justificadas_qtd if custos_detalhados.faltas_justificadas_qtd is defined else 0 }} dias</h5>
                                <small class="text-muted">R$ {{ '{:,.2f}'.format(custos_detalhados.faltas_justificadas if custos_detalhados.faltas_justificadas is defined else 0).replace(',', '.') }}</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-cogs fa-2x text-secondary mb-2"></i>
                                <h6>Outros</h6>
                                <h5 class="text-secondary">R$ {{ '{:,.2f}'.format(custos_detalhados.outros).replace(',', '.') }}</h5>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-calculator fa-2x text-primary mb-2"></i>
                                <h6>Total</h6>
                                <h5 class="text-primary">R$ {{ '{:,.2f}'.format(custos_detalhados.total).replace(',', '.') }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos de Custos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> Custos por Obra
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="custosObraChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt"></i> Custos Recentes
                    </h5>
                </div>
                <div class="card-body">
                    {% if custos_recentes %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Obra</th>
                                        <th>Custo Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for custo in custos_recentes %}
                                    <tr>
                                        <td>{{ custo.nome }}</td>
                                        <td>R$ {{ '{:,.2f}'.format(custo.total_custo) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Nenhum custo registrado.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

    <!-- 📈 VISÃO GERAL - KPIs Principais -->
    <div class="section-header">
        <h4><i class="fas fa-chart-line"></i> Visão Geral</h4>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Funcionários Ativos</h5>
                            <h2 class="mb-0">{{ total_funcionarios }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Obras Ativas</h5>
                            <h2 class="mb-0">{{ total_obras }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-hard-hat fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Veículos</h5>
                            <h2 class="mb-0">{{ total_veiculos }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-truck fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Custos do Período</h5>
                            <h2 class="mb-0">R$ {{ '{:,.2f}'.format(custos_mes).replace(',', '.') }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda linha de KPIs - Margem -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card {% if margem_percentual >= 0 %}bg-success{% else %}bg-danger{% endif %} text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Margem de Lucro</h5>
                            <h2 class="mb-0">{{ margem_percentual }}%</h2>
                            <small>Sobre R$ {{ '{:,.2f}'.format(valor_contrato_total).replace(',', '.') }}</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-percentage fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0 text-success">Eficiência Geral</h5>
                            <h2 class="mb-0">{{ eficiencia_geral }}%</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-line fa-2x text-success opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0 text-primary">Produtividade</h5>
                            <h2 class="mb-0">{{ produtividade_obra }}%</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-tasks fa-2x text-primary opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0 text-warning">Veículos Disponíveis</h5>
                            <h2 class="mb-0">{{ veiculos_disponiveis }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-car fa-2x text-warning opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📋 PROPOSTAS COMERCIAIS -->

    <div class="section-header">
        <h4><i class="fas fa-users"></i> Recursos Humanos</h4>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie"></i> Funcionários por Departamento
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="funcionariosDeptChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-plus"></i> Funcionários Recentes
                    </h5>
                </div>
                <div class="card-body">
                    {% if funcionarios_recentes %}
                        <div class="list-group list-group-flush">
                            {% for func in funcionarios_recentes %}
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ func.nome }}</strong>
                                        <br>
                                        <small class="text-muted">{{ func.cargo }}</small>
                                    </div>
                                    <small class="text-muted">
                                        {{ func.data_admissao.strftime('%d/%m/%Y') if func.data_admissao else 'N/A' }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Nenhum funcionário recente.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 🏗️ OBRAS E RDO -->

    <div class="section-header">
        <h4><i class="fas fa-hard-hat"></i> Obras e RDO</h4>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks"></i> Progresso das Obras
                    </h5>
                    <small class="text-muted">Baseado no último RDO</small>
                </div>
                <div class="card-body">
                    {% if obras_ativas %}
                        <div class="row">
                        {% for obra in obras_ativas %}
                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded h-100">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ obra.nome }}</h6>
                                            <div class="d-flex gap-3">
                                                {% if obra.data_ultimo_rdo %}
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-day"></i> 
                                                    Último RDO: {{ obra.data_ultimo_rdo.strftime('%d/%m/%Y') }}
                                                </small>
                                                {% endif %}
                                                {% if obra.total_subatividades > 0 %}
                                                <small class="text-muted">
                                                    <i class="fas fa-tasks"></i> 
                                                    {{ obra.total_subatividades }} atividades
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <h5 class="mb-0 
                                                {% if obra.progresso_atual >= 80 %}text-success
                                                {% elif obra.progresso_atual >= 50 %}text-warning
                                                {% elif obra.progresso_atual >= 25 %}text-info
                                                {% else %}text-secondary
                                                {% endif %}">
                                                {{ obra.progresso_atual }}%
                                            </h5>
                                        </div>
                                    </div>
                                    
                                    <!-- Barra de Progresso -->
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar 
                                            {% if obra.progresso_atual >= 80 %}bg-success
                                            {% elif obra.progresso_atual >= 50 %}bg-warning
                                            {% elif obra.progresso_atual >= 25 %}bg-info
                                            {% else %}bg-secondary
                                            {% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ obra.progresso_atual }}%"
                                            aria-valuenow="{{ obra.progresso_atual }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                    
                                    <!-- Status da obra -->
                                    <div class="mt-2 d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if obra.progresso_atual == 0 %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-clock"></i> Sem RDO registrado
                                            </span>
                                            {% elif obra.progresso_atual < 25 %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-play"></i> Iniciada
                                            </span>
                                            {% elif obra.progresso_atual < 50 %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-cogs"></i> Em desenvolvimento
                                            </span>
                                            {% elif obra.progresso_atual < 80 %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-forward"></i> Avançada
                                            </span>
                                            {% elif obra.progresso_atual < 100 %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle"></i> Quase concluída
                                            </span>
                                            {% else %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-trophy"></i> Concluída
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <a href="/funcionario/rdo/consolidado?obra_id={{ obra.id }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> Ver RDOs
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-hard-hat fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Nenhuma obra ativa</h6>
                            <p class="text-muted mb-0">Cadastre obras para acompanhar o progresso</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <div class="section-header">
        <h4><i class="fas fa-file-contract"></i> Propostas Comerciais</h4>
    </div>

    <!-- Métricas Detalhadas de Propostas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <!-- Resumo de Propostas -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-3">Propostas por Status</h6>
                                    <div class="mb-2">
                                        <span class="badge bg-success">Aprovadas: {{ propostas_aprovadas }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge bg-primary">Enviadas: {{ propostas_enviadas }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge bg-secondary">Rascunho: {{ propostas_rascunho }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge bg-danger">Rejeitadas: {{ propostas_rejeitadas }}</span>
                                    </div>
                                    <div>
                                        <span class="badge bg-warning">Expiradas: {{ propostas_expiradas }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Comercial -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="text-muted mb-3 text-center">Performance Comercial</h6>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small>Taxa de Conversão:</small>
                                        <strong class="text-success">{{ taxa_conversao }}%</strong>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small>Valor Médio:</small>
                                        <strong>R$ {{ '{:,.2f}'.format(valor_medio).replace(',', '.') }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small>Tempo Resp. Médio:</small>
                                        <strong>{{ tempo_resposta_medio }} dias</strong>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small>Propostas/Mês:</small>
                                        <strong class="text-primary">{{ propostas_por_mes }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Templates Mais Utilizados -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="text-muted mb-3 text-center">Templates Populares</h6>
                                    {% if templates_populares and templates_populares|length > 0 %}
                                        {% for template in templates_populares[:3] %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small>{{ template.nome }}:</small>
                                            <span class="badge bg-primary">{{ template.uso }}x</span>
                                        </div>
                                        {% endfor %}
                                        {% if outros_templates > 0 %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small>Outros:</small>
                                            <span class="badge bg-warning">{{ outros_templates }}x</span>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                    <p class="text-muted text-center mb-0">Nenhum template usado</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Portal do Cliente - Métricas -->
                        <div class="col-md-3">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="text-muted mb-3 text-center">Portal do Cliente</h6>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small>Acessos Únicos:</small>
                                        <strong class="text-info">{{ acessos_unicos }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small>Tempo Médio:</small>
                                        <strong>{{ tempo_medio_portal }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small>Feedbacks:</small>
                                        <span class="badge bg-success">{{ feedbacks_positivos }} positivos</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small>Downloads PDF:</small>
                                        <strong class="text-secondary">{{ downloads_pdf }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos de Propostas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie"></i> Status de Propostas
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="propostasStatusChart" width="300" height="150"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area"></i> Evolução de Propostas (Últimos 6 Meses)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="evolucaoPropostasChart" width="600" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 👥 RECURSOS HUMANOS -->
    <!-- 💰 FINANCEIRO E CUSTOS -->

<script>
// Função específica para filtros do dashboard
function setDateRangeDashboard(period) {
    const today = new Date();
    let startDate, endDate = today;
    
    switch(period) {
        case 'mes_atual':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = today;
            break;
        case 'ultimo_mes':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'ultimos_3_meses':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            endDate = today;
            break;
        case 'ano_atual':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = today;
            break;
        default:
            return;
    }
    
    // Formatar datas para yyyy-mm-dd
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    // Atualizar campos específicos do dashboard
    const dataInicioInput = document.getElementById('data_inicio_dash');
    const dataFimInput = document.getElementById('data_fim_dash');
    
    if (dataInicioInput) {
        dataInicioInput.value = formatDate(startDate);
        console.log('Data inicial definida:', formatDate(startDate));
    }
    if (dataFimInput) {
        dataFimInput.value = formatDate(endDate);
        console.log('Data final definida:', formatDate(endDate));
    }
    
    // Auto-aplicar filtros após definir as datas
    setTimeout(() => {
        aplicarFiltrosDashboard();
    }, 100);
}

// Função para aplicar filtros do dashboard
function aplicarFiltrosDashboard() {
    const form = document.getElementById('filtroFormDashboard');
    if (form) {
        console.log('🔄 Aplicando filtros do dashboard...');
        
        const dataInicio = form.querySelector('input[name="data_inicio"]').value;
        const dataFim = form.querySelector('input[name="data_fim"]').value;
        
        console.log('Período selecionado:', dataInicio, 'até', dataFim);
        
        form.submit();
    } else {
        console.error('❌ Formulário de filtros não encontrado');
    }
}

// Gráficos
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de funcionários por departamento usando ChartConfigs
    const ctxFuncionarios = document.getElementById('funcionariosDeptChart').getContext('2d');
    const funcionariosLabels = [{% for dept in funcionarios_dept %}'{{ dept.nome }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const funcionariosData = [{% for dept in funcionarios_dept %}{{ dept.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    if (typeof ChartConfigs !== 'undefined') {
        const funcionariosConfig = ChartConfigs.funcionariosPorDepartamento(funcionariosLabels, funcionariosData);
        new Chart(ctxFuncionarios, funcionariosConfig);
    } else {
        // Fallback se ChartConfigs não estiver disponível
        new Chart(ctxFuncionarios, {
            type: 'doughnut',
            data: {
                labels: funcionariosLabels,
                datasets: [{
                    data: funcionariosData,
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6610f2', '#fd7e14', '#20c997', '#e83e8c'],
                    borderWidth: 2,
                    borderColor: '#212529'
                }]
            },
            options: {
                responsive: true,
                cutout: '50%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map(function(label, i) {
                                        const style = {
                                            backgroundColor: data.datasets[0].backgroundColor[i],
                                            borderColor: data.datasets[0].borderColor
                                        };
                                        return {
                                            text: label + ' (' + data.datasets[0].data[i] + ')',
                                            fillStyle: style.backgroundColor,
                                            strokeStyle: style.borderColor,
                                            lineWidth: 2,
                                            pointStyle: 'circle',
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} funcionários (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de custos por obra
    const ctxCustos = document.getElementById('custosObraChart').getContext('2d');
    new Chart(ctxCustos, {
        type: 'bar',
        data: {
            labels: [{% for custo in custos_recentes %}'{{ custo.nome }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Custo Total (R$)',
                data: [{% for custo in custos_recentes %}{{ custo.total_custo }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            }
        }
    });
    
    // Gráfico de Status de Propostas (com valores dinâmicos)
    const ctxPropostasStatus = document.getElementById('propostasStatusChart').getContext('2d');
    new Chart(ctxPropostasStatus, {
        type: 'doughnut',
        data: {
            labels: ['Aprovadas', 'Enviadas', 'Rascunho', 'Rejeitadas', 'Expiradas'],
            datasets: [{
                data: [{{ propostas_aprovadas }}, {{ propostas_enviadas }}, {{ propostas_rascunho }}, {{ propostas_rejeitadas }}, {{ propostas_expiradas }}],
                backgroundColor: [
                    '#198754', // Verde - Aprovadas
                    '#0d6efd', // Azul - Enviadas  
                    '#6c757d', // Cinza - Rascunho
                    '#dc3545', // Vermelho - Rejeitadas
                    '#ffc107'  // Amarelo - Expiradas
                ],
                borderWidth: 2,
                borderColor: '#212529'
            }]
        },
        options: {
            responsive: true,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} propostas (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Gráfico de Evolução de Propostas
    const ctxEvolucaoPropostas = document.getElementById('evolucaoPropostasChart').getContext('2d');
    new Chart(ctxEvolucaoPropostas, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
            datasets: [{
                label: 'Propostas Criadas',
                data: [12, 19, 15, 25, 22, 30],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Propostas Aprovadas',
                data: [8, 13, 10, 17, 15, 20],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
});
</script>
{% endblock %}

{% block scripts %}
{% endblock %}
