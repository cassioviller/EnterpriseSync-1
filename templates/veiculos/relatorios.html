{% extends "base_completo.html" %}

{% block title %}Relatórios de Veículos - SIGE{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-chart-bar me-2 text-success"></i>
                        Relatórios de Veículos
                    </h2>
                    <p class="text-muted mb-0">Análise consolidada da frota</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('main.exportar_relatorio_veiculos') }}?data_inicio={{ data_inicio }}&data_fim={{ data_fim }}" 
                       class="btn btn-success" target="_blank">
                        <i class="fas fa-file-pdf me-1"></i> Exportar PDF
                    </a>
                    <a href="{{ url_for('main.lancamentos_veiculos') }}" class="btn btn-outline-primary">
                        <i class="fas fa-clipboard-list me-1"></i> Lançamentos
                    </a>
                    <a href="{{ url_for('main.veiculos') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtro de Período -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data Início</label>
                            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Fim</label>
                            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}" required>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync me-1"></i> Atualizar Relatório
                            </button>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="text-muted small">
                                Período: <strong>{{ (data_fim | strptime('%Y-%m-%d') - data_inicio | strptime('%Y-%m-%d')).days + 1 }} dias</strong>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Consolidados da Frota -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-1">{{ "{:,.0f}".format(consolidado.total_km_frota) }}</h3>
                            <p class="mb-0">KM Totais</p>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-route fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-1">R$ {{ "{:,.2f}".format(consolidado.total_custos_frota) }}</h3>
                            <p class="mb-0">Custos Totais</p>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-money-bill fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-1">{{ consolidado.total_usos_frota }}</h3>
                            <p class="mb-0">Total de Usos</p>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-list fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-1">R$ {{ "{:.2f}".format(consolidado.media_custo_por_km) }}</h3>
                            <p class="mb-0">Custo por KM</p>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-calculator fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Destaques -->
    {% if consolidado.veiculo_mais_usado and consolidado.veiculo_mais_caro %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Veículo Mais Utilizado
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="mb-1">{{ consolidado.veiculo_mais_usado.veiculo.placa }}</h5>
                            <p class="text-muted mb-1">{{ consolidado.veiculo_mais_usado.veiculo.marca }} {{ consolidado.veiculo_mais_usado.veiculo.modelo }}</p>
                            <div class="row g-2">
                                <div class="col-6">
                                    <strong>{{ "{:,.0f}".format(consolidado.veiculo_mais_usado.total_km) }} km</strong>
                                    <br><small class="text-muted">Percorridos</small>
                                </div>
                                <div class="col-6">
                                    <strong>{{ consolidado.veiculo_mais_usado.total_usos }} usos</strong>
                                    <br><small class="text-muted">Registrados</small>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-car fa-3x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Veículo Mais Caro
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="mb-1">{{ consolidado.veiculo_mais_caro.veiculo.placa }}</h5>
                            <p class="text-muted mb-1">{{ consolidado.veiculo_mais_caro.veiculo.marca }} {{ consolidado.veiculo_mais_caro.veiculo.modelo }}</p>
                            <div class="row g-2">
                                <div class="col-6">
                                    <strong>R$ {{ "{:.2f}".format(consolidado.veiculo_mais_caro.total_custos) }}</strong>
                                    <br><small class="text-muted">Custos</small>
                                </div>
                                <div class="col-6">
                                    <strong>R$ {{ "{:.2f}".format(consolidado.veiculo_mais_caro.custo_por_km) }}</strong>
                                    <br><small class="text-muted">Por KM</small>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-truck fa-3x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Relatório Detalhado por Veículo -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Relatório Detalhado por Veículo
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tabelaRelatorio">
                    <thead class="table-light">
                        <tr>
                            <th>Veículo</th>
                            <th class="text-center">Total KM</th>
                            <th class="text-center">Total Usos</th>
                            <th class="text-center">Total Horas</th>
                            <th class="text-end">Total Custos</th>
                            <th class="text-end">Custo/KM</th>
                            <th class="text-center">Média KM/Uso</th>
                            <th class="text-center">Eficiência</th>
                            <th>Principais Custos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in relatorio_veiculos %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        {% if item.veiculo.status == 'Disponível' %}
                                            <i class="fas fa-check-circle text-success fa-lg"></i>
                                        {% elif item.veiculo.status == 'Em uso' %}
                                            <i class="fas fa-road text-primary fa-lg"></i>
                                        {% else %}
                                            <i class="fas fa-wrench text-warning fa-lg"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>{{ item.veiculo.placa }}</strong><br>
                                        <small class="text-muted">{{ item.veiculo.marca }} {{ item.veiculo.modelo }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <strong>{{ "{:,.0f}".format(item.total_km) }}</strong>
                                <br><small class="text-muted">km</small>
                            </td>
                            <td class="text-center">
                                <strong>{{ item.total_usos }}</strong>
                                <br><small class="text-muted">vezes</small>
                            </td>
                            <td class="text-center">
                                <strong>{{ "{:.1f}".format(item.total_horas) }}</strong>
                                <br><small class="text-muted">horas</small>
                            </td>
                            <td class="text-end">
                                <strong>R$ {{ "{:,.2f}".format(item.total_custos) }}</strong>
                            </td>
                            <td class="text-end">
                                {% if item.custo_por_km > 0 %}
                                    <strong>R$ {{ "{:.2f}".format(item.custo_por_km) }}</strong>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.media_km_por_uso > 0 %}
                                    <strong>{{ "{:.1f}".format(item.media_km_por_uso) }}</strong>
                                    <br><small class="text-muted">km/uso</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.total_km > 0 and item.dias_periodo > 0 %}
                                    {% set km_por_dia = item.total_km / item.dias_periodo %}
                                    {% if km_por_dia >= 50 %}
                                        <span class="badge bg-success">Alta</span>
                                    {% elif km_por_dia >= 20 %}
                                        <span class="badge bg-warning text-dark">Média</span>
                                    {% else %}
                                        <span class="badge bg-danger">Baixa</span>
                                    {% endif %}
                                    <br><small class="text-muted">{{ "{:.1f}".format(km_por_dia) }} km/dia</small>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.custos_por_tipo %}
                                    {% for tipo, valor in item.custos_por_tipo.items() %}
                                        {% if loop.index <= 2 %}
                                            <div class="small">
                                                <strong>{{ tipo.title() }}:</strong> R$ {{ "{:.2f}".format(valor) }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    {% if item.custos_por_tipo|length > 2 %}
                                        <div class="small text-muted">
                                            +{{ item.custos_por_tipo|length - 2 }} tipos
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Nenhum custo</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                                <p class="text-muted">Nenhum dado encontrado para o período selecionado.</p>
                                <a href="{{ url_for('main.veiculos') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i> Registrar Primeiro Uso
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    {% if relatorio_veiculos %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Distribuição de KM por Veículo
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="graficoKmPorVeiculo" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Custos por Veículo
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="graficoCustosPorVeiculo" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Dados para os gráficos
const dadosRelatorio = [
    {% for item in relatorio_veiculos %}
    {
        veiculo: "{{ item.veiculo.placa }}",
        totalKm: {{ item.total_km }},
        totalCustos: {{ item.total_custos }},
        totalUsos: {{ item.total_usos }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Configuração do Chart.js
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 12;

// Gráfico de KM por Veículo
const ctxKm = document.getElementById('graficoKmPorVeiculo');
if (ctxKm && dadosRelatorio.length > 0) {
    new Chart(ctxKm, {
        type: 'doughnut',
        data: {
            labels: dadosRelatorio.map(d => d.veiculo),
            datasets: [{
                data: dadosRelatorio.map(d => d.totalKm),
                backgroundColor: [
                    '#198754', '#0d6efd', '#fd7e14', '#dc3545', '#6f42c1',
                    '#20c997', '#ffc107', '#d63384', '#495057', '#6c757d'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${context.formattedValue} km (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Custos por Veículo
const ctxCustos = document.getElementById('graficoCustosPorVeiculo');
if (ctxCustos && dadosRelatorio.length > 0) {
    new Chart(ctxCustos, {
        type: 'bar',
        data: {
            labels: dadosRelatorio.map(d => d.veiculo),
            datasets: [{
                label: 'Custos (R$)',
                data: dadosRelatorio.map(d => d.totalCustos),
                backgroundColor: 'rgba(25, 135, 84, 0.8)',
                borderColor: 'rgba(25, 135, 84, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Custos: R$ ${context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                        }
                    }
                }
            }
        }
    });
}

// DataTable para a tabela de relatórios
$(document).ready(function() {
    if ($('#tabelaRelatorio tbody tr').length > 1) {
        $('#tabelaRelatorio').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
            },
            pageLength: 25,
            order: [[1, 'desc']], // Ordenar por KM Total decrescente
            columnDefs: [
                { targets: [1, 2, 3, 4, 5, 6, 7], className: 'text-center' }
            ]
        });
    }
});
</script>
{% endblock %}