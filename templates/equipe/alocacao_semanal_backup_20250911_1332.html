{% extends "base_completo.html" %}

{% block title %}üìã Gest√£o de Equipe - Semana {{ monday.strftime('%d/%m') }}{% endblock %}

{% block head_content %}
<!-- Sortable.js para drag & drop - carregamento garantido -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" defer></script>

<style>
/* Estilo espec√≠fico para drag & drop mantendo padr√£o SIGE */
.obra-draggable {
    cursor: grab;
    transition: all 0.2s ease;
}

.obra-draggable:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.2) !important;
}

.obra-draggable:active {
    cursor: grabbing;
    transform: scale(1.02);
}

.obra-draggable.dragging {
    opacity: 0.6;
    transform: rotate(3deg);
}

.day-drop-zone {
    min-height: 300px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background: #fafafa;
    transition: all 0.3s ease;
}

.day-drop-zone.drag-over {
    background: #d4edda;
    border-color: #198754;
    border-style: solid;
}

.allocated-work {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.allocated-work:hover {
    background: linear-gradient(135deg, #157347 0%, #0f5132 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

.employee-count-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ffc107;
    color: #856404;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.week-stats {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.stat-box {
    text-align: center;
    padding: 10px;
    background: rgba(255,255,255,0.15);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.stat-number {
    display: block;
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Loading states */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loading-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
}

.custom-toast {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    padding: 16px;
    margin-bottom: 10px;
    border-left: 4px solid #198754;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* Vista Mensal Styles */
.calendar-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-day {
    background: white;
    min-height: 100px;
    padding: 8px;
    position: relative;
    border: 1px solid transparent;
    transition: all 0.2s ease;
}

.calendar-day:hover {
    border-color: #198754;
    background: #f8f9fa;
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: #6c757d;
}

.calendar-day.today {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
}

.calendar-day-number {
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 0.9rem;
}

.calendar-allocation {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border-radius: 4px;
    padding: 2px 4px;
    margin-bottom: 2px;
    font-size: 0.7rem;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    cursor: pointer;
}

.calendar-allocation:hover {
    background: linear-gradient(135deg, #157347 0%, #0f5132 100%);
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    font-weight: bold;
    text-align: center;
    padding: 12px 0;
}

.calendar-weekday {
    padding: 8px;
    font-size: 0.9rem;
}

.month-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: white;
    border-radius: 12px 12px 0 0;
    border-bottom: 1px solid #dee2e6;
}

.month-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #495057;
}

.nav-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.nav-btn:hover {
    background: #198754;
    color: white;
    border-color: #198754;
}

/* Responsividade mobile */
@media (max-width: 768px) {
    .day-drop-zone {
        min-height: 200px;
    }
    
    .week-stats .row {
        text-align: center;
    }
    
    .allocated-work {
        font-size: 0.9rem;
        padding: 8px;
    }
    
    .calendar-day {
        min-height: 80px;
        padding: 4px;
    }
    
    .calendar-allocation {
        font-size: 0.6rem;
        padding: 1px 2px;
    }
    
    .month-navigation {
        padding: 12px;
    }
    
    .month-title {
        font-size: 1rem;
    }
}

/* Weekly Planner Styles */
.planner-grid {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
}

.planner-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 12px 8px;
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid #dee2e6;
    font-size: 0.9rem;
    color: #495057;
}

.planner-row {
    border-bottom: 1px solid #f1f3f4;
}

.planner-cell {
    min-height: 120px;
    padding: 8px;
    border-right: 1px solid #f1f3f4;
    position: relative;
}

.planner-cell:last-child {
    border-right: none;
}

.obra-info {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border-radius: 6px;
    padding: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 4px;
}

.servico-card {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    border-radius: 4px;
    padding: 6px 8px;
    margin-bottom: 4px;
    font-size: 0.75rem;
    cursor: grab;
    transition: all 0.2s ease;
    position: relative;
}

.servico-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
}

.servico-card:active {
    cursor: grabbing;
}

.servico-card.dragging {
    opacity: 0.6;
    transform: rotate(2deg);
}

.servico-responsavel {
    font-size: 0.65rem;
    opacity: 0.9;
    margin-top: 2px;
}

.servico-catalog-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 6px;
    cursor: grab;
    transition: all 0.2s ease;
}

.servico-catalog-item:hover {
    border-color: #17a2b8;
    box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
}

.servico-catalog-item.dragging {
    opacity: 0.6;
}

.servico-nome {
    font-weight: 600;
    font-size: 0.8rem;
    color: #495057;
    margin-bottom: 2px;
}

.servico-categoria {
    font-size: 0.7rem;
    color: #6c757d;
}

.drop-zone-planner {
    min-height: 100px;
    border: 2px dashed #dee2e6;
    border-radius: 6px;
    background: #fafafa;
    padding: 4px;
    transition: all 0.3s ease;
}

.drop-zone-planner.drag-over {
    border-color: #17a2b8;
    background: rgba(23, 162, 184, 0.1);
    border-style: solid;
}

.drop-zone-planner.has-content {
    border-style: solid;
    border-color: #28a745;
}

.planner-empty-state {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-size: 0.8rem;
}

/* Responsividade do planner */
@media (max-width: 768px) {
    .modal-dialog.modal-xl {
        max-width: 95%;
    }
    
    .planner-cell {
        min-height: 80px;
        padding: 4px;
    }
    
    .servico-card {
        font-size: 0.7rem;
        padding: 4px 6px;
    }
    
    .planner-header {
        padding: 8px 4px;
        font-size: 0.8rem;
    }
}

/* Estilos de conflitos */
.conflict-detected {
    border: 2px solid #dc3545 !important;
    background: rgba(220, 53, 69, 0.1) !important;
}

.conflict-work {
    border-left: 4px solid #dc3545 !important;
    position: relative;
}

.conflict-work::before {
    content: "‚ö†Ô∏è";
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.7rem;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.overload-work {
    border: 2px solid #ffc107 !important;
    background: rgba(255, 193, 7, 0.1) !important;
}

.overload-work::before {
    content: "‚ö°";
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.7rem;
    background: #ffc107;
    color: #856404;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumbs -->
    <div class="breadcrumb-container mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">üè† SIGE</a></li>
                <li class="breadcrumb-item"><a href="/equipe">üë• Gest√£o de Equipe</a></li>
                <li class="breadcrumb-item active" aria-current="page">üìã Aloca√ß√£o Semanal</li>
            </ol>
        </nav>
    </div>
    <!-- Header com estat√≠sticas -->
    <div class="week-stats">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h3 class="mb-2">üìã Gest√£o de Equipe - Canteiro Inteligente</h3>
                <div class="d-flex align-items-center flex-wrap">
                    <div class="me-3 mb-2">
                        <select class="form-select form-select-sm" id="obra-filter" onchange="applyObraFilter(this.value)" style="min-width: 200px;">
                            <option value="">üèóÔ∏è Todas as obras</option>
                            {% for obra in obras %}
                            <option value="{{ obra.id }}">{{ obra.codigo }} - {{ obra.nome[:20] }}{% if obra.nome|length > 20 %}...{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="me-3 mb-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="show-conflicts" onchange="toggleConflictDetection(this.checked)">
                            <label class="form-check-label" for="show-conflicts" style="font-size: 0.9rem; color: white;">
                                ‚ö†Ô∏è Detectar conflitos
                            </label>
                        </div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-light text-dark me-1" id="filter-status">Mostrando todas</span>
                        <span class="badge bg-warning text-dark" id="conflict-count" style="display: none;">0 conflitos</span>
                        <span class="badge bg-success text-white me-1" id="sync-indicator" style="display: none;">
                            <i class="fas fa-check-circle me-1"></i>Sincronizado
                        </span>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-light" onclick="navigateWeek(-1)">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <button class="btn btn-light" onclick="goToToday()">
                    <i class="fas fa-calendar-day"></i> Hoje
                </button>
                <button class="btn btn-light" onclick="navigateWeek(1)">
                    Pr√≥xima <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number">{{ stats.total_obras }}</span>
                    <span class="stat-label">Obras Ativas</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number">{{ stats.total_alocacoes_semana }}</span>
                    <span class="stat-label">Aloca√ß√µes</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number">{{ stats.funcionarios_alocados }}</span>
                    <span class="stat-label">Funcion√°rios</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <span class="stat-number">{{ monday.strftime('%d/%m') }} - {{ friday.strftime('%d/%m') }}</span>
                    <span class="stat-label">Semana Atual</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar: Obras Dispon√≠veis -->
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-hammer text-primary me-2"></i>
                        Obras Dispon√≠veis
                    </h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    <div id="obras-source" class="obras-list">
                        {% for obra in obras %}
                        <div class="card obra-draggable mb-2" 
                             data-obra-id="{{ obra.id }}"
                             data-obra-nome="{{ obra.nome }}"
                             data-obra-codigo="{{ obra.codigo }}">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-1">{{ obra.codigo }}</h6>
                                <small class="text-muted">{{ obra.nome[:30] }}{% if obra.nome|length > 30 %}...{% endif %}</small>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not obras %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle mb-2"></i><br>
                            <small>Nenhuma obra ativa encontrada</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Grade Semanal -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calendar-week text-primary me-2"></i>
                            Grade Semanal
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary active" onclick="switchView('week')">
                                <i class="fas fa-calendar-week"></i> Semanal
                            </button>
                            <button class="btn btn-outline-primary" onclick="switchView('month')">
                                <i class="fas fa-calendar-alt"></i> Mensal
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Vista Semanal -->
                    <div class="row" id="weekly-view">
                        {% set weekdays = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'] %}
                        {% for day_index in range(5) %}
                        <div class="col">
                            <div class="mb-2">
                                <h6 class="text-center mb-3">
                                    <strong>{{ weekdays[day_index] }}</strong><br>
                                    <small class="text-muted">{{ week_grid[day_index]['date_str'] }}</small>
                                </h6>
                            </div>
                            
                            <div class="day-drop-zone" 
                                 data-day="{{ day_index }}"
                                 data-date="{{ week_grid[day_index]['date'].strftime('%Y-%m-%d') }}">
                                
                                <div class="allocated-works" data-day="{{ day_index }}">
                                    {% for allocation in week_grid[day_index]['allocations'] %}
                                    <div class="allocated-work" 
                                         data-allocation-id="{{ allocation.id }}"
                                         onclick="openEmployeeAllocation({{ allocation.id }})">
                                        
                                        <div class="fw-bold">{{ allocation.obra.codigo }}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.9;">
                                            {{ allocation.turno_inicio.strftime('%H:%M') if allocation.turno_inicio else '08:00' }} - 
                                            {{ allocation.turno_fim.strftime('%H:%M') if allocation.turno_fim else '17:00' }}
                                        </div>
                                        
                                        {% if allocation.funcionarios_count > 0 %}
                                        <div class="employee-count-badge">{{ allocation.funcionarios_count }}</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                {% if not week_grid[day_index]['allocations'] %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-hand-point-left mb-2"></i><br>
                                    <small>Arraste obras aqui</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Vista Mensal -->
                    <div class="d-none" id="monthly-view">
                        <div id="calendar-container">
                            <!-- Calendar ser√° gerado dinamicamente via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√µes de a√ß√£o r√°pida -->
    <div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;">
        <div class="btn-group-vertical">
            <button class="btn btn-info btn-lg rounded-circle mb-2" 
                    onclick="exportToExcel('allocation')" 
                    title="Exportar Aloca√ß√µes"
                    style="width: 56px; height: 56px;">
                <i class="fas fa-file-excel"></i>
            </button>
            <button class="btn btn-primary btn-lg rounded-circle mb-2" 
                    onclick="refreshWeek()" 
                    title="Atualizar"
                    style="width: 56px; height: 56px;">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-success btn-lg rounded-circle" 
                    onclick="openWeeklyPlanner()" 
                    title="Weekly Planner"
                    style="width: 56px; height: 56px;">
                <i class="fas fa-tasks"></i>
            </button>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <div>Processando aloca√ß√£o...</div>
    </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<!-- Weekly Planner Modal -->
<div class="modal fade" id="weeklyPlannerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #198754 0%, #157347 100%); color: white;">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>
                    Weekly Planner - Planejamento Lean Construction
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Sidebar: Cat√°logo de Servi√ßos -->
                        <div class="col-md-3" style="background: #f8f9fa; border-right: 1px solid #dee2e6;">
                            <div class="p-3">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-tools text-primary me-2"></i>
                                    Cat√°logo de Servi√ßos
                                </h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-sm" 
                                           placeholder="Buscar servi√ßos..." 
                                           id="servicos-search"
                                           onkeyup="filterServices(this.value)">
                                </div>
                                <div id="servicos-catalog" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Servi√ßos carregados dinamicamente -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Planner Grid -->
                        <div class="col-md-9">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0">
                                        <i class="fas fa-calendar-week text-primary me-2"></i>
                                        Planejamento da Semana
                                    </h6>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="syncPlannerWithAllocations()">
                                            <i class="fas fa-sync me-1"></i> Sincronizar
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="clearAllPlanning()">
                                            <i class="fas fa-trash me-1"></i> Limpar
                                        </button>
                                        <button class="btn btn-success" onclick="savePlannerData()">
                                            <i class="fas fa-save me-1"></i> Salvar Planejamento
                                        </button>
                                    </div>
                                    <div class="mt-2" id="sync-status" style="display: none;">
                                        <span class="badge bg-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="sync-message">Verificando sincroniza√ß√£o...</span>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="planner-grid">
                                    <div class="row">
                                        <div class="col-2">
                                            <div class="planner-header">Obra</div>
                                        </div>
                                        <div class="col-2">
                                            <div class="planner-header">Segunda</div>
                                        </div>
                                        <div class="col-2">
                                            <div class="planner-header">Ter√ßa</div>
                                        </div>
                                        <div class="col-2">
                                            <div class="planner-header">Quarta</div>
                                        </div>
                                        <div class="col-2">
                                            <div class="planner-header">Quinta</div>
                                        </div>
                                        <div class="col-2">
                                            <div class="planner-header">Sexta</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Linhas do planner -->
                                    <div id="planner-rows">
                                        <!-- Gerado dinamicamente com base nas obras alocadas -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Fechar
                </button>
                <button type="button" class="btn btn-warning" onclick="exportToExcel('planner')">
                    <i class="fas fa-file-excel me-1"></i> Exportar Planejamento
                </button>
                <button type="button" class="btn btn-success" onclick="savePlannerData()">
                    <i class="fas fa-save me-1"></i> Salvar Planejamento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ===================================
// SISTEMA DRAG & DROP - PADR√ÉO SIGE
// ===================================

let currentWeekStart = '{{ monday.strftime("%Y-%m-%d") }}';
let currentView = 'week';

// Garantir que Sortable.js carregue antes de inicializar
function waitForSortable() {
    if (typeof Sortable !== 'undefined') {
        initializeDragAndDrop();
        console.log('üöÄ Sistema EQUIPE inicializado - Padr√£o SIGE');
    } else {
        setTimeout(waitForSortable, 100);
    }
}

document.addEventListener('DOMContentLoaded', waitForSortable);

function initializeDragAndDrop() {
    // Obras source - sidebar
    const obrasSource = document.getElementById('obras-source');
    if (obrasSource) {
        new Sortable(obrasSource, {
            group: {
                name: 'obras',
                pull: 'clone',
                put: false
            },
            sort: false,
            animation: 150,
            ghostClass: 'obra-draggable',
            chosenClass: 'dragging',
            onStart: function(evt) {
                console.log('üü¢ Drag iniciado:', evt.item.dataset.obraNome);
                showLoadingOverlay();
            }
        });
    }

    // Drop zones - dias da semana
    document.querySelectorAll('.allocated-works').forEach(dayContainer => {
        new Sortable(dayContainer, {
            group: {
                name: 'obras',
                pull: false,
                put: true
            },
            animation: 200,
            ghostClass: 'allocated-work',
            onAdd: function(evt) {
                const obraElement = evt.item;
                const dayDate = evt.to.closest('.day-drop-zone').dataset.date;
                const obraId = obraElement.dataset.obraId;
                
                console.log(`üü° Drop: ${obraElement.dataset.obraNome} ‚Üí ${dayDate}`);
                createAllocation(obraId, dayDate, obraElement);
            },
            onRemove: function(evt) {
                const allocationId = evt.item.dataset.allocationId;
                if (allocationId) {
                    console.log('üî¥ Removendo aloca√ß√£o:', allocationId);
                    deleteAllocation(allocationId);
                }
            }
        });
    });

    // Drop zones visual feedback
    document.querySelectorAll('.day-drop-zone').forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', function(e) {
            this.classList.remove('drag-over');
        });
    });
}

// ===================================
// API CALLS
// ===================================

async function createAllocation(obraId, dataAlocacao, elemento) {
    try {
        // FASE 3: Valida√ß√µes robustas antes de enviar para API
        const validation = validateAllocation(obraId, dataAlocacao);
        
        if (!validation.isValid) {
            showValidationErrors(validation.errors);
            elemento.remove();
            hideLoadingOverlay();
            return;
        }
        
        // Verificar se j√° existe aloca√ß√£o para esta obra neste dia
        const existingAllocation = document.querySelector(
            `[data-date="${dataAlocacao}"] .allocated-work[data-obra-id="${obraId}"]`
        );
        
        if (existingAllocation) {
            showValidationErrors(['Esta obra j√° est√° alocada para este dia']);
            elemento.remove();
            hideLoadingOverlay();
            return;
        }
        
        const response = await fetch('/equipe/api/allocations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                obra_id: parseInt(obraId),
                data_alocacao: dataAlocacao,
                turno_inicio: '08:00',
                turno_fim: '17:00',
                nota: ''
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            // Transformar em obra alocada
            elemento.className = 'allocated-work';
            elemento.dataset.allocationId = result.id;
            elemento.dataset.obraId = obraId; // Manter para valida√ß√µes futuras
            elemento.onclick = () => openEmployeeAllocation(result.id);
            elemento.innerHTML = `
                <div class="fw-bold">${elemento.dataset.obraCodigo || elemento.dataset.obraNome}</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">08:00 - 17:00</div>
                <div class="employee-count-badge" style="display: none;">0</div>
            `;
            
            console.log('‚úÖ Aloca√ß√£o criada:', result.id);
            showToast('Obra alocada com sucesso! Configure funcion√°rios.', 'success');
            
            // FASE 3: Atualizar indicador de sincroniza√ß√£o
            updateSyncIndicator();
            
        } else {
            throw new Error(result.error || 'Erro ao criar aloca√ß√£o');
        }
    } catch (error) {
        console.error('‚ùå Erro create allocation:', error);
        
        // FASE 3: Mensagem de erro melhorada
        if (error.message.includes('Constraint')) {
            showValidationErrors(['Esta obra j√° est√° alocada para este per√≠odo']);
        } else if (error.message.includes('Network')) {
            showValidationErrors(['Erro de conex√£o. Verifique sua internet e tente novamente.']);
        } else {
            showValidationErrors([error.message || 'Erro inesperado ao criar aloca√ß√£o']);
        }
        
        elemento.remove();
    } finally {
        hideLoadingOverlay();
    }
}

async function deleteAllocation(allocationId) {
    try {
        const response = await fetch(`/equipe/api/allocations/${allocationId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            console.log('‚úÖ Aloca√ß√£o removida:', allocationId);
            showToast('Obra removida da semana', 'info');
        } else {
            const result = await response.json();
            throw new Error(result.error || 'Erro ao remover aloca√ß√£o');
        }
    } catch (error) {
        console.error('‚ùå Erro delete allocation:', error);
        showToast(error.message, 'error');
    }
}

// ===================================
// NAVEGA√á√ÉO E UTILIT√ÅRIOS
// ===================================

function navigateWeek(direction) {
    const currentDate = new Date(currentWeekStart);
    currentDate.setDate(currentDate.getDate() + (direction * 7));
    
    const newWeekStart = currentDate.toISOString().split('T')[0];
    window.location.href = `/equipe/alocacao?week=${newWeekStart}`;
}

function goToToday() {
    window.location.href = '/equipe/alocacao';
}

function refreshWeek() {
    showLoadingOverlay();
    window.location.reload();
}

function openEmployeeAllocation(allocationId) {
    window.location.href = `/equipe/funcionarios/${allocationId}`;
}

function switchView(view) {
    currentView = view;
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('btn-primary', 'active');
        btn.classList.add('btn-outline-primary');
    });
    
    if (view === 'week') {
        document.querySelector('.btn-group .btn:first-child').classList.remove('btn-outline-primary');
        document.querySelector('.btn-group .btn:first-child').classList.add('btn-primary', 'active');
        
        // Mostrar vista semanal
        document.getElementById('weekly-view').classList.remove('d-none');
        document.getElementById('monthly-view').classList.add('d-none');
        
        console.log('üóìÔ∏è Switched to weekly view');
        
    } else if (view === 'month') {
        document.querySelector('.btn-group .btn:last-child').classList.remove('btn-outline-primary');
        document.querySelector('.btn-group .btn:last-child').classList.add('btn-primary', 'active');
        
        // Mostrar vista mensal
        document.getElementById('weekly-view').classList.add('d-none');
        document.getElementById('monthly-view').classList.remove('d-none');
        
        // Gerar calend√°rio mensal se ainda n√£o foi gerado
        generateMonthlyCalendar();
        
        console.log('üìÖ Switched to monthly view');
        showToast('Vista mensal carregada!', 'success');
    }
}

function openWeeklyPlanner() {
    // Abrir modal do Weekly Planner
    const modal = new bootstrap.Modal(document.getElementById('weeklyPlannerModal'));
    modal.show();
    
    // Inicializar planner quando modal abrir
    setTimeout(() => {
        initializeWeeklyPlanner();
    }, 300);
    
    console.log('üìã Opening Weekly Planner');
}

// ===================================
// FEEDBACK VISUAL
// ===================================

function showLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    const colors = {
        'success': '#198754',
        'error': '#dc3545',
        'info': '#17a2b8',
        'warning': '#ffc107'
    };
    
    toast.className = 'custom-toast';
    toast.style.borderLeftColor = colors[type] || colors.info;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2" 
               style="color: ${colors[type] || colors.info}"></i>
            <span>${message}</span>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Haptic feedback para dispositivos m√≥veis
function hapticFeedback(type = 'impact') {
    if (navigator.vibrate) {
        const patterns = {
            'impact': [10],
            'success': [10, 50, 10],
            'error': [100, 30, 100]
        };
        navigator.vibrate(patterns[type] || patterns.impact);
    }
}

// ===================================
// VISTA MENSAL - IMPLEMENTA√á√ÉO COMPLETA
// ===================================

let currentMonth = new Date('{{ monday.strftime("%Y-%m-%d") }}');
let monthlyAllocations = {};

async function generateMonthlyCalendar() {
    showLoadingOverlay();
    
    try {
        // Buscar aloca√ß√µes do m√™s
        await loadMonthlyAllocations();
        
        // Gerar HTML do calend√°rio
        renderMonthlyCalendar();
        
        console.log('üìÖ Monthly calendar generated for:', currentMonth.toISOString().substring(0,7));
        
    } catch (error) {
        console.error('‚ùå Erro generating monthly calendar:', error);
        showToast('Erro ao carregar vista mensal', 'error');
    } finally {
        hideLoadingOverlay();
    }
}

async function loadMonthlyAllocations() {
    const monthKey = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
    
    try {
        const response = await fetch(`/equipe/api/allocations?month=${monthKey}`);
        const data = await response.json();
        
        if (response.ok) {
            monthlyAllocations = data.allocations_by_date || {};
            console.log('üìä Monthly allocations loaded:', Object.keys(monthlyAllocations).length + ' days');
        } else {
            throw new Error(data.error || 'Erro ao buscar aloca√ß√µes mensais');
        }
    } catch (error) {
        console.error('‚ùå Load monthly allocations error:', error);
        // Usar dados mockados temporariamente
        monthlyAllocations = {};
    }
}

function renderMonthlyCalendar() {
    const container = document.getElementById('calendar-container');
    const today = new Date();
    
    // Calcular primeiro e √∫ltimo dia do m√™s
    const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
    
    // Calcular dias do calend√°rio (incluindo dias de outros meses)
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay() + (firstDay.getDay() === 0 ? -6 : 1)); // Segunda-feira
    
    const endDate = new Date(lastDay);
    const remainingDays = 7 - ((lastDay.getDay() + 6) % 7) - 1;
    endDate.setDate(endDate.getDate() + remainingDays);
    
    // Nomes dos meses
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    
    // HTML do calend√°rio
    let html = `
        <div class="calendar-container">
            <div class="month-navigation">
                <button class="nav-btn" onclick="navigateMonth(-1)">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <h4 class="month-title">
                    ${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}
                </h4>
                <button class="nav-btn" onclick="navigateMonth(1)">
                    Pr√≥ximo <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="calendar-header">
                <div class="calendar-weekday">Seg</div>
                <div class="calendar-weekday">Ter</div>
                <div class="calendar-weekday">Qua</div>
                <div class="calendar-weekday">Qui</div>
                <div class="calendar-weekday">Sex</div>
                <div class="calendar-weekday">S√°b</div>
                <div class="calendar-weekday">Dom</div>
            </div>
            
            <div class="calendar-grid">
    `;
    
    // Gerar cada dia do calend√°rio
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        const dateKey = currentDate.toISOString().split('T')[0];
        const isCurrentMonth = currentDate.getMonth() === currentMonth.getMonth();
        const isToday = currentDate.toDateString() === today.toDateString();
        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
        
        let dayClass = 'calendar-day';
        if (!isCurrentMonth) dayClass += ' other-month';
        if (isToday) dayClass += ' today';
        
        // Aloca√ß√µes do dia
        const dayAllocations = monthlyAllocations[dateKey] || [];
        let allocationsHtml = '';
        
        dayAllocations.slice(0, 3).forEach(allocation => {
            allocationsHtml += `
                <div class="calendar-allocation" 
                     onclick="openEmployeeAllocation(${allocation.id})"
                     title="${allocation.obra.nome} - ${allocation.funcionarios_count} funcion√°rios">
                    ${allocation.obra.codigo}
                    ${allocation.funcionarios_count > 0 ? ` (${allocation.funcionarios_count})` : ''}
                </div>
            `;
        });
        
        if (dayAllocations.length > 3) {
            allocationsHtml += `<div class="calendar-allocation" style="background: #6c757d;">+${dayAllocations.length - 3} mais</div>`;
        }
        
        html += `
            <div class="${dayClass}" 
                 data-date="${dateKey}"
                 ${!isWeekend && isCurrentMonth ? 'onclick="openDayDetail(\'' + dateKey + '\')"' : ''}
                 ${!isWeekend && isCurrentMonth ? 'style="cursor: pointer;"' : ''}>
                <div class="calendar-day-number">${currentDate.getDate()}</div>
                ${allocationsHtml}
            </div>
        `;
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function navigateMonth(direction) {
    currentMonth.setMonth(currentMonth.getMonth() + direction);
    generateMonthlyCalendar();
    
    console.log('üìÖ Navigated to month:', currentMonth.getFullYear() + '-' + (currentMonth.getMonth() + 1));
}

function openDayDetail(dateKey) {
    // Navegar para a vista semanal do dia selecionado
    const selectedDate = new Date(dateKey);
    const monday = new Date(selectedDate);
    monday.setDate(selectedDate.getDate() - selectedDate.getDay() + 1);
    
    const weekStart = monday.toISOString().split('T')[0];
    window.location.href = `/equipe/alocacao?week=${weekStart}`;
}

// ===================================
// WEEKLY PLANNER - IMPLEMENTA√á√ÉO COMPLETA
// ===================================

let plannerData = {};
let servicosCatalog = [];

async function initializeWeeklyPlanner() {
    showLoadingOverlay();
    
    try {
        // Carregar cat√°logo de servi√ßos e dados do planner
        await Promise.all([
            loadServicesCatalog(),
            loadPlannerData(),
            generatePlannerGrid()
        ]);
        
        // Inicializar drag & drop do planner
        initializePlannerDragDrop();
        
        console.log('üìã Weekly Planner initialized successfully');
        
    } catch (error) {
        console.error('‚ùå Error initializing planner:', error);
        showToast('Erro ao inicializar Weekly Planner', 'error');
    } finally {
        hideLoadingOverlay();
    }
}

async function loadServicesCatalog() {
    try {
        const response = await fetch('/api/servicos');
        const data = await response.json();
        
        if (response.ok) {
            servicosCatalog = data.servicos || [];
            renderServicesCatalog();
            console.log('üìä Services catalog loaded:', servicosCatalog.length + ' services');
        } else {
            throw new Error(data.error || 'Erro ao carregar cat√°logo de servi√ßos');
        }
    } catch (error) {
        console.error('‚ùå Load services catalog error:', error);
        // Usar dados mockados para demonstra√ß√£o
        servicosCatalog = [
            { id: 1, nome: 'Funda√ß√£o', categoria: 'Estrutural' },
            { id: 2, nome: 'Alvenaria', categoria: 'Veda√ß√£o' },
            { id: 3, nome: 'Cobertura', categoria: 'Estrutural' },
            { id: 4, nome: 'El√©trica', categoria: 'Instala√ß√µes' },
            { id: 5, nome: 'Hidr√°ulica', categoria: 'Instala√ß√µes' },
            { id: 6, nome: 'Pintura', categoria: 'Acabamento' },
            { id: 7, nome: 'Cer√¢mica', categoria: 'Acabamento' }
        ];
        renderServicesCatalog();
    }
}

function renderServicesCatalog() {
    const container = document.getElementById('servicos-catalog');
    
    let html = '';
    servicosCatalog.forEach(servico => {
        html += `
            <div class="servico-catalog-item" 
                 data-servico-id="${servico.id}"
                 data-servico-nome="${servico.nome}"
                 data-servico-categoria="${servico.categoria || ''}">
                <div class="servico-nome">${servico.nome}</div>
                <div class="servico-categoria">${servico.categoria || 'Sem categoria'}</div>
            </div>
        `;
    });
    
    if (servicosCatalog.length === 0) {
        html = '<div class="text-center text-muted py-3"><i class="fas fa-info-circle mb-2"></i><br><small>Nenhum servi√ßo encontrado</small></div>';
    }
    
    container.innerHTML = html;
}

function filterServices(searchTerm) {
    const items = document.querySelectorAll('.servico-catalog-item');
    
    items.forEach(item => {
        const nome = item.querySelector('.servico-nome').textContent.toLowerCase();
        const categoria = item.querySelector('.servico-categoria').textContent.toLowerCase();
        
        if (nome.includes(searchTerm.toLowerCase()) || categoria.includes(searchTerm.toLowerCase())) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

async function loadPlannerData() {
    try {
        const weekStart = currentWeekStart;
        const response = await fetch(`/equipe/api/planner?week=${weekStart}`);
        const data = await response.json();
        
        if (response.ok) {
            plannerData = data.planner || {};
            console.log('üìã Planner data loaded for week:', weekStart);
        } else {
            console.log('‚ÑπÔ∏è No existing planner data, starting fresh');
            plannerData = {};
        }
    } catch (error) {
        console.error('‚ùå Load planner data error:', error);
        plannerData = {};
    }
}

function generatePlannerGrid() {
    const container = document.getElementById('planner-rows');
    const obrasAlocadas = getObrasAlocadasSemana();
    
    let html = '';
    
    if (obrasAlocadas.length === 0) {
        html = `
            <div class="planner-empty-state">
                <i class="fas fa-info-circle mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
                <br>Nenhuma obra alocada nesta semana
                <br><small>Aloque obras primeiro para usar o planner</small>
            </div>
        `;
    } else {
        obrasAlocadas.forEach(obra => {
            html += `
                <div class="planner-row row" data-obra-id="${obra.id}">
                    <div class="col-2 planner-cell">
                        <div class="obra-info">
                            ${obra.codigo || obra.nome}
                        </div>
                    </div>
            `;
            
            // Colunas para cada dia da semana
            for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                const dayKey = `${obra.id}-${dayIndex}`;
                const dayServices = plannerData[dayKey] || [];
                
                html += `
                    <div class="col-2 planner-cell">
                        <div class="drop-zone-planner ${dayServices.length > 0 ? 'has-content' : ''}" 
                             data-obra-id="${obra.id}" 
                             data-day="${dayIndex}">
                `;
                
                dayServices.forEach(service => {
                    html += `
                        <div class="servico-card" 
                             data-service-id="${service.id}"
                             data-service-nome="${service.nome}">
                            <div>${service.nome}</div>
                            ${service.responsavel ? `<div class="servico-responsavel">üë§ ${service.responsavel}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
        });
    }
    
    container.innerHTML = html;
    console.log('üèóÔ∏è Planner grid generated for', obrasAlocadas.length, 'obras');
}

function getObrasAlocadasSemana() {
    // Extrair obras √∫nicas das aloca√ß√µes da semana atual
    const obras = [];
    const obrasSet = new Set();
    
    document.querySelectorAll('.allocated-work').forEach(element => {
        const obraElement = element.closest('[data-obra-id]');
        if (obraElement && !obrasSet.has(obraElement.dataset.obraId)) {
            obrasSet.add(obraElement.dataset.obraId);
            obras.push({
                id: obraElement.dataset.obraId,
                codigo: obraElement.dataset.obraCodigo || element.querySelector('.fw-bold').textContent,
                nome: obraElement.dataset.obraNome || element.querySelector('.fw-bold').textContent
            });
        }
    });
    
    // Se n√£o encontrou obras no DOM, usar dados das obras dispon√≠veis
    if (obras.length === 0) {
        document.querySelectorAll('.obra-draggable').forEach(element => {
            if (!obrasSet.has(element.dataset.obraId)) {
                obrasSet.add(element.dataset.obraId);
                obras.push({
                    id: element.dataset.obraId,
                    codigo: element.dataset.obraCodigo,
                    nome: element.dataset.obraNome
                });
            }
        });
    }
    
    return obras.slice(0, 5); // M√°ximo 5 obras para n√£o sobrecarregar
}

function initializePlannerDragDrop() {
    // Cat√°logo de servi√ßos (source)
    const catalogContainer = document.getElementById('servicos-catalog');
    if (catalogContainer) {
        new Sortable(catalogContainer, {
            group: {
                name: 'planner-services',
                pull: 'clone',
                put: false
            },
            sort: false,
            animation: 150,
            ghostClass: 'servico-catalog-item',
            chosenClass: 'dragging'
        });
    }
    
    // Drop zones do planner
    document.querySelectorAll('.drop-zone-planner').forEach(zone => {
        new Sortable(zone, {
            group: {
                name: 'planner-services',
                pull: true,
                put: true
            },
            animation: 200,
            ghostClass: 'servico-card',
            chosenClass: 'dragging',
            onAdd: function(evt) {
                const serviceElement = evt.item;
                const obraId = evt.to.dataset.obraId;
                const dayIndex = evt.to.dataset.day;
                
                // Transformar em servi√ßo planejado
                if (serviceElement.classList.contains('servico-catalog-item')) {
                    const servicoNome = serviceElement.dataset.servicoNome;
                    const servicoId = serviceElement.dataset.servicoId;
                    
                    serviceElement.className = 'servico-card';
                    serviceElement.innerHTML = `
                        <div>${servicoNome}</div>
                        <div class="servico-responsavel">üë§ Definir respons√°vel</div>
                    `;
                    serviceElement.dataset.serviceId = servicoId;
                    serviceElement.dataset.serviceNome = servicoNome;
                    
                    // Adicionar click para editar respons√°vel
                    serviceElement.onclick = () => editServiceResponsible(serviceElement);
                }
                
                // Atualizar dados do planner
                updatePlannerData();
                
                // Visual feedback
                evt.to.classList.add('has-content');
                showToast(`${serviceElement.dataset.serviceNome} adicionado ao planejamento`, 'success');
                hapticFeedback('success');
                
                console.log(`üìã Service added: ${serviceElement.dataset.serviceNome} ‚Üí Obra ${obraId}, Day ${dayIndex}`);
            },
            onRemove: function(evt) {
                // Atualizar dados do planner
                updatePlannerData();
                
                // Verificar se zone ficou vazia
                if (evt.from.children.length === 0) {
                    evt.from.classList.remove('has-content');
                }
                
                console.log(`üìã Service removed from planner`);
            }
        });
    });
}

function editServiceResponsible(serviceElement) {
    const currentResponsible = serviceElement.querySelector('.servico-responsavel')?.textContent.replace('üë§ ', '') || 'Definir respons√°vel';
    
    const newResponsible = prompt('Definir respons√°vel pelo servi√ßo:', currentResponsible === 'Definir respons√°vel' ? '' : currentResponsible);
    
    if (newResponsible !== null) {
        const responsavelElement = serviceElement.querySelector('.servico-responsavel');
        if (responsavelElement) {
            responsavelElement.textContent = `üë§ ${newResponsible || 'Definir respons√°vel'}`;
        }
        
        updatePlannerData();
        showToast('Respons√°vel atualizado', 'success');
    }
}

function updatePlannerData() {
    plannerData = {};
    
    document.querySelectorAll('.drop-zone-planner').forEach(zone => {
        const obraId = zone.dataset.obraId;
        const dayIndex = zone.dataset.day;
        const dayKey = `${obraId}-${dayIndex}`;
        
        const services = [];
        zone.querySelectorAll('.servico-card').forEach(card => {
            const responsavelElement = card.querySelector('.servico-responsavel');
            const responsavel = responsavelElement ? responsavelElement.textContent.replace('üë§ ', '') : '';
            
            services.push({
                id: card.dataset.serviceId,
                nome: card.dataset.serviceNome,
                responsavel: responsavel === 'Definir respons√°vel' ? '' : responsavel
            });
        });
        
        if (services.length > 0) {
            plannerData[dayKey] = services;
        }
    });
}

async function savePlannerData() {
    showLoadingOverlay();
    
    try {
        updatePlannerData();
        
        const response = await fetch('/equipe/api/planner', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                week: currentWeekStart,
                planner_data: plannerData
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Planejamento salvo com sucesso!', 'success');
            console.log('‚úÖ Planner data saved');
            hapticFeedback('success');
        } else {
            throw new Error(result.error || 'Erro ao salvar planejamento');
        }
    } catch (error) {
        console.error('‚ùå Save planner error:', error);
        showToast('Erro ao salvar planejamento', 'error');
        hapticFeedback('error');
    } finally {
        hideLoadingOverlay();
    }
}

function clearAllPlanning() {
    if (!confirm('Tem certeza que deseja limpar todo o planejamento da semana?')) {
        return;
    }
    
    document.querySelectorAll('.drop-zone-planner').forEach(zone => {
        zone.innerHTML = '';
        zone.classList.remove('has-content');
    });
    
    plannerData = {};
    showToast('Planejamento limpo', 'info');
    
    console.log('üóëÔ∏è All planning cleared');
}

// ===================================
// FILTROS E DETEC√á√ÉO DE CONFLITOS
// ===================================

function applyObraFilter(obraId) {
    const filterStatus = document.getElementById('filter-status');
    
    if (!obraId) {
        // Mostrar todas as obras
        document.querySelectorAll('.obra-draggable, .allocated-work').forEach(element => {
            element.style.display = 'block';
        });
        
        document.querySelectorAll('.day-drop-zone').forEach(zone => {
            zone.style.display = 'block';
        });
        
        filterStatus.textContent = 'Mostrando todas';
        filterStatus.className = 'badge bg-light text-dark me-1';
        
        console.log('üîç Filter cleared - showing all obras');
        
    } else {
        // Filtrar por obra espec√≠fica
        let visibleCount = 0;
        
        // Filtrar obras dispon√≠veis
        document.querySelectorAll('.obra-draggable').forEach(element => {
            if (element.dataset.obraId === obraId) {
                element.style.display = 'block';
                visibleCount++;
            } else {
                element.style.display = 'none';
            }
        });
        
        // Filtrar aloca√ß√µes
        document.querySelectorAll('.allocated-work').forEach(element => {
            const parentZone = element.closest('.day-drop-zone');
            const allocations = parentZone.querySelectorAll('.allocated-work');
            let hasVisibleAllocations = false;
            
            allocations.forEach(allocation => {
                // Precisamos identificar a obra da aloca√ß√£o (isso pode precisar ser melhorado)
                const obraTexto = allocation.querySelector('.fw-bold').textContent;
                const matchingObra = document.querySelector(`.obra-draggable[data-obra-codigo="${obraTexto}"], .obra-draggable[data-obra-nome*="${obraTexto}"]`);
                
                if (matchingObra && matchingObra.dataset.obraId === obraId) {
                    allocation.style.display = 'block';
                    hasVisibleAllocations = true;
                } else {
                    allocation.style.display = 'none';
                }
            });
            
            // Mostrar/ocultar a zona baseado se tem aloca√ß√µes vis√≠veis
            parentZone.style.display = hasVisibleAllocations ? 'block' : 'none';
        });
        
        const selectedOption = document.querySelector(`#obra-filter option[value="${obraId}"]`);
        const obraNome = selectedOption ? selectedOption.textContent : 'Obra selecionada';
        
        filterStatus.textContent = `Filtrando: ${obraNome}`;
        filterStatus.className = 'badge bg-primary text-white me-1';
        
        console.log(`üîç Filter applied: Obra ${obraId} - ${visibleCount} items visible`);
    }
    
    // Re-executar detec√ß√£o de conflitos se estiver ativa
    const conflictToggle = document.getElementById('show-conflicts');
    if (conflictToggle && conflictToggle.checked) {
        detectConflicts();
    }
}

function toggleConflictDetection(enabled) {
    const conflictCount = document.getElementById('conflict-count');
    
    if (enabled) {
        detectConflicts();
        conflictCount.style.display = 'inline-block';
        showToast('Detec√ß√£o de conflitos ativada', 'info');
        console.log('‚ö†Ô∏è Conflict detection enabled');
    } else {
        clearConflictHighlights();
        conflictCount.style.display = 'none';
        showToast('Detec√ß√£o de conflitos desativada', 'info');
        console.log('‚úÖ Conflict detection disabled');
    }
}

function detectConflicts() {
    clearConflictHighlights();
    let conflictCount = 0;
    
    // Detectar funcion√°rios alocados em m√∫ltiplas obras no mesmo dia
    const funcionariosPorDia = {};
    
    // Coletar todas as aloca√ß√µes por dia
    document.querySelectorAll('.allocated-work').forEach(allocation => {
        const dayZone = allocation.closest('.day-drop-zone');
        const dayIndex = dayZone.dataset.day;
        const dateStr = dayZone.dataset.date;
        
        if (!funcionariosPorDia[dateStr]) {
            funcionariosPorDia[dateStr] = {};
        }
        
        // Para cada obra, contar funcion√°rios (isso √© uma aproxima√ß√£o)
        const funcionariosBadge = allocation.querySelector('.employee-count-badge');
        const funcionariosCount = funcionariosBadge ? parseInt(funcionariosBadge.textContent) : 0;
        const obraCodigo = allocation.querySelector('.fw-bold').textContent;
        
        if (funcionariosCount > 0) {
            if (!funcionariosPorDia[dateStr][obraCodigo]) {
                funcionariosPorDia[dateStr][obraCodigo] = 0;
            }
            funcionariosPorDia[dateStr][obraCodigo] += funcionariosCount;
        }
    });
    
    // Detectar conflitos de hor√°rio (obras simult√¢neas no mesmo dia)
    Object.keys(funcionariosPorDia).forEach(date => {
        const obrasNoDia = Object.keys(funcionariosPorDia[date]);
        if (obrasNoDia.length > 1) {
            // M√∫ltiplas obras no mesmo dia - potencial conflito
            const dayZone = document.querySelector(`[data-date="${date}"]`);
            if (dayZone) {
                dayZone.classList.add('conflict-detected');
                dayZone.querySelectorAll('.allocated-work').forEach(work => {
                    work.classList.add('conflict-work');
                    
                    // Adicionar tooltip de conflito
                    work.title = `‚ö†Ô∏è Conflito: ${obrasNoDia.length} obras neste dia`;
                });
                conflictCount++;
            }
        }
    });
    
    // Detectar sobrecarga de funcion√°rios (mais de 8h/dia)
    document.querySelectorAll('.allocated-work').forEach(allocation => {
        const funcionariosBadge = allocation.querySelector('.employee-count-badge');
        const funcionariosCount = funcionariosBadge ? parseInt(funcionariosBadge.textContent) : 0;
        
        // Se uma obra tem muitos funcion√°rios, pode ser sobrecarga
        if (funcionariosCount > 10) {
            allocation.classList.add('overload-work');
            allocation.title = `‚ö†Ô∏è Poss√≠vel sobrecarga: ${funcionariosCount} funcion√°rios`;
            conflictCount++;
        }
    });
    
    // Atualizar contador de conflitos
    const conflictCountElement = document.getElementById('conflict-count');
    if (conflictCountElement) {
        conflictCountElement.textContent = `${conflictCount} conflito${conflictCount !== 1 ? 's' : ''}`;
        conflictCountElement.className = conflictCount > 0 ? 'badge bg-danger text-white' : 'badge bg-success text-white';
    }
    
    if (conflictCount > 0) {
        showToast(`${conflictCount} conflito${conflictCount !== 1 ? 's' : ''} detectado${conflictCount !== 1 ? 's' : ''}`, 'warning');
    } else {
        showToast('Nenhum conflito detectado', 'success');
    }
    
    console.log(`‚ö†Ô∏è Conflict detection completed: ${conflictCount} conflicts found`);
}

function clearConflictHighlights() {
    // Remover todas as classes de conflito
    document.querySelectorAll('.conflict-detected, .conflict-work, .overload-work').forEach(element => {
        element.classList.remove('conflict-detected', 'conflict-work', 'overload-work');
        element.removeAttribute('title');
    });
    
    console.log('‚úÖ Conflict highlights cleared');
}

// ===================================
// SINCRONIZA√á√ÉO E INTEGRA√á√ÉO - FASE 3
// ===================================

function syncPlannerWithAllocations() {
    const syncStatus = document.getElementById('sync-status');
    const syncMessage = document.getElementById('sync-message');
    const syncIndicator = document.getElementById('sync-indicator');
    
    syncStatus.style.display = 'block';
    syncMessage.textContent = 'Sincronizando com aloca√ß√µes...';
    
    showLoadingOverlay();
    
    try {
        let syncedCount = 0;
        let divergenceCount = 0;
        
        // Obter todas as obras alocadas na semana
        const obrasAlocadas = getObrasAlocadasSemana();
        
        // Para cada obra alocada, verificar se h√° planejamento correspondente
        obrasAlocadas.forEach(obra => {
            for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                const dayKey = `${obra.id}-${dayIndex}`;
                const plannedServices = plannerData[dayKey] || [];
                
                // Verificar se h√° aloca√ß√£o sem planejamento
                const hasAllocation = checkAllocationForDay(obra.id, dayIndex);
                
                if (hasAllocation && plannedServices.length === 0) {
                    // Criar planejamento b√°sico baseado na aloca√ß√£o
                    const basicService = {
                        id: 'auto-sync',
                        nome: 'Atividades gerais',
                        responsavel: 'A definir'
                    };
                    
                    plannerData[dayKey] = [basicService];
                    syncedCount++;
                    
                    console.log(`üìã Auto-synced: Obra ${obra.codigo} ‚Üí Day ${dayIndex}`);
                    
                } else if (!hasAllocation && plannedServices.length > 0) {
                    // Diverg√™ncia: h√° planejamento sem aloca√ß√£o
                    divergenceCount++;
                    console.log(`‚ö†Ô∏è Divergence: Planning without allocation - Obra ${obra.codigo}, Day ${dayIndex}`);
                }
            }
        });
        
        // Re-gerar o grid do planner com dados sincronizados
        generatePlannerGrid();
        initializePlannerDragDrop();
        
        // Atualizar status de sincroniza√ß√£o
        if (divergenceCount > 0) {
            syncMessage.textContent = `${syncedCount} sincronizados, ${divergenceCount} diverg√™ncias`;
            syncStatus.querySelector('.badge').className = 'badge bg-warning text-dark';
            syncIndicator.style.display = 'none';
            
            showToast(`Sincroniza√ß√£o parcial: ${divergenceCount} diverg√™ncias encontradas`, 'warning');
            
        } else {
            syncMessage.textContent = `${syncedCount} itens sincronizados com sucesso`;
            syncStatus.querySelector('.badge').className = 'badge bg-success text-white';
            syncIndicator.style.display = 'inline-block';
            
            showToast('Planejamento sincronizado com aloca√ß√µes', 'success');
        }
        
        // Esconder status ap√≥s 5 segundos
        setTimeout(() => {
            syncStatus.style.display = 'none';
        }, 5000);
        
        console.log(`üîÑ Sync completed: ${syncedCount} synced, ${divergenceCount} divergences`);
        hapticFeedback('success');
        
    } catch (error) {
        console.error('‚ùå Sync error:', error);
        syncMessage.textContent = 'Erro na sincroniza√ß√£o';
        syncStatus.querySelector('.badge').className = 'badge bg-danger text-white';
        
        showToast('Erro ao sincronizar planejamento', 'error');
        hapticFeedback('error');
        
    } finally {
        hideLoadingOverlay();
    }
}

function checkAllocationForDay(obraId, dayIndex) {
    // Verificar se h√° uma aloca√ß√£o para essa obra neste dia
    const dayZones = document.querySelectorAll(`[data-day="${dayIndex}"]`);
    
    for (let zone of dayZones) {
        const allocatedWorks = zone.querySelectorAll('.allocated-work');
        for (let work of allocatedWorks) {
            const obraTexto = work.querySelector('.fw-bold')?.textContent;
            const matchingObra = document.querySelector(`.obra-draggable[data-obra-codigo="${obraTexto}"]`);
            
            if (matchingObra && matchingObra.dataset.obraId === obraId) {
                return true;
            }
        }
    }
    
    return false;
}

// ===================================
// EXPORTA√á√ÉO PARA EXCEL - FASE 3
// ===================================

function exportToExcel(type = 'allocation') {
    showLoadingOverlay();
    
    try {
        let data = [];
        let filename = '';
        
        if (type === 'allocation') {
            data = generateAllocationExportData();
            filename = `Alocacao_Semanal_${currentWeekStart}.xlsx`;
        } else if (type === 'planner') {
            data = generatePlannerExportData();
            filename = `Planejamento_Semanal_${currentWeekStart}.xlsx`;
        }
        
        // Criar workbook usando uma biblioteca de Excel (seria necess√°rio incluir)
        downloadExcelFile(data, filename);
        
        showToast(`Arquivo ${filename} exportado com sucesso!`, 'success');
        console.log(`üìä Excel exported: ${filename}`);
        
    } catch (error) {
        console.error('‚ùå Export error:', error);
        showToast('Erro ao exportar arquivo Excel', 'error');
    } finally {
        hideLoadingOverlay();
    }
}

function generateAllocationExportData() {
    const data = [];
    
    // Header
    data.push(['Obra', 'C√≥digo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'Total Funcion√°rios']);
    
    // Data rows
    const obrasAlocadas = getObrasAlocadasSemana();
    
    obrasAlocadas.forEach(obra => {
        const row = [obra.nome, obra.codigo];
        let totalFuncionarios = 0;
        
        // Para cada dia da semana
        for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
            let dayInfo = '-';
            let funcionariosCount = 0;
            
            // Buscar aloca√ß√£o para este dia
            const dayZone = document.querySelector(`[data-day="${dayIndex}"]`);
            if (dayZone) {
                const allocatedWorks = dayZone.querySelectorAll('.allocated-work');
                
                allocatedWorks.forEach(work => {
                    const obraTexto = work.querySelector('.fw-bold').textContent;
                    if (obraTexto === obra.codigo) {
                        const badge = work.querySelector('.employee-count-badge');
                        funcionariosCount = badge ? parseInt(badge.textContent) : 0;
                        
                        const timeText = work.textContent.match(/\d{2}:\d{2} - \d{2}:\d{2}/);
                        const timeInfo = timeText ? timeText[0] : '08:00 - 17:00';
                        
                        dayInfo = `${funcionariosCount} funcion√°rios (${timeInfo})`;
                        totalFuncionarios += funcionariosCount;
                    }
                });
            }
            
            row.push(dayInfo);
        }
        
        row.push(totalFuncionarios);
        data.push(row);
    });
    
    return data;
}

function generatePlannerExportData() {
    const data = [];
    
    // Header
    data.push(['Obra', 'C√≥digo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta']);
    
    // Data rows
    const obrasAlocadas = getObrasAlocadasSemana();
    
    obrasAlocadas.forEach(obra => {
        const row = [obra.nome, obra.codigo];
        
        // Para cada dia da semana
        for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
            const dayKey = `${obra.id}-${dayIndex}`;
            const services = plannerData[dayKey] || [];
            
            let dayServices = '';
            if (services.length > 0) {
                dayServices = services.map(service => {
                    let serviceText = service.nome;
                    if (service.responsavel && service.responsavel !== 'Definir respons√°vel') {
                        serviceText += ` (${service.responsavel})`;
                    }
                    return serviceText;
                }).join('; ');
            } else {
                dayServices = '-';
            }
            
            row.push(dayServices);
        }
        
        data.push(row);
    });
    
    return data;
}

function downloadExcelFile(data, filename) {
    // Converter dados para CSV como fallback (seria necess√°rio library para Excel real)
    const csvContent = data.map(row => 
        row.map(cell => `"${cell}"`).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename.replace('.xlsx', '.csv'));
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// ===================================
// VALIDA√á√ïES E FEEDBACK MELHORADO - FASE 3
// ===================================

function validateAllocation(obraId, dataAlocacao) {
    const errors = [];
    
    // Validar se obra existe
    if (!obraId || isNaN(parseInt(obraId))) {
        errors.push('Obra inv√°lida selecionada');
    }
    
    // Validar data
    const date = new Date(dataAlocacao);
    if (isNaN(date.getTime())) {
        errors.push('Data de aloca√ß√£o inv√°lida');
    }
    
    // Validar se n√£o √© fim de semana
    const dayOfWeek = date.getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        errors.push('N√£o √© poss√≠vel alocar em finais de semana');
    }
    
    // Validar se n√£o √© data passada (mais de 1 semana)
    const today = new Date();
    const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
    if (date < weekAgo) {
        errors.push('N√£o √© poss√≠vel alocar em datas muito anteriores');
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}

function showValidationErrors(errors) {
    const errorContainer = document.createElement('div');
    errorContainer.className = 'alert alert-danger alert-dismissible fade show';
    errorContainer.style.position = 'fixed';
    errorContainer.style.top = '20px';
    errorContainer.style.right = '20px';
    errorContainer.style.zIndex = '2000';
    errorContainer.style.maxWidth = '400px';
    
    let errorHtml = '<h6><i class="fas fa-exclamation-triangle me-2"></i>Erros encontrados:</h6><ul class="mb-0">';
    errors.forEach(error => {
        errorHtml += `<li>${error}</li>`;
    });
    errorHtml += '</ul>';
    errorHtml += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    errorContainer.innerHTML = errorHtml;
    document.body.appendChild(errorContainer);
    
    // Auto remove ap√≥s 10 segundos
    setTimeout(() => {
        if (errorContainer.parentNode) {
            errorContainer.remove();
        }
    }, 10000);
}

// ===================================
// BREADCRUMBS E NAVEGA√á√ÉO - FASE 3
// ===================================

function updateBreadcrumbs(currentPage = 'alocacao') {
    const breadcrumbContainer = document.querySelector('.breadcrumb-container');
    if (!breadcrumbContainer) return;
    
    const breadcrumbs = {
        'alocacao': [
            { name: 'SIGE', url: '/' },
            { name: 'Gest√£o de Equipe', url: '/equipe' },
            { name: 'Aloca√ß√£o Semanal', active: true }
        ],
        'funcionarios': [
            { name: 'SIGE', url: '/' },
            { name: 'Gest√£o de Equipe', url: '/equipe' },
            { name: 'Aloca√ß√£o Semanal', url: '/equipe/alocacao' },
            { name: 'Funcion√°rios', active: true }
        ],
        'planner': [
            { name: 'SIGE', url: '/' },
            { name: 'Gest√£o de Equipe', url: '/equipe' },
            { name: 'Aloca√ß√£o Semanal', url: '/equipe/alocacao' },
            { name: 'Weekly Planner', active: true }
        ]
    };
    
    const currentBreadcrumbs = breadcrumbs[currentPage] || breadcrumbs.alocacao;
    
    let breadcrumbHtml = '<nav aria-label="breadcrumb"><ol class="breadcrumb mb-0">';
    
    currentBreadcrumbs.forEach((item, index) => {
        if (item.active) {
            breadcrumbHtml += `<li class="breadcrumb-item active" aria-current="page">${item.name}</li>`;
        } else {
            breadcrumbHtml += `<li class="breadcrumb-item"><a href="${item.url}">${item.name}</a></li>`;
        }
    });
    
    breadcrumbHtml += '</ol></nav>';
    breadcrumbContainer.innerHTML = breadcrumbHtml;
}

function updateSyncIndicator() {
    const syncIndicator = document.getElementById('sync-indicator');
    const obrasAlocadas = getObrasAlocadasSemana();
    
    let hasPlanning = false;
    obrasAlocadas.forEach(obra => {
        for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
            const dayKey = `${obra.id}-${dayIndex}`;
            if (plannerData[dayKey] && plannerData[dayKey].length > 0) {
                hasPlanning = true;
                break;
            }
        }
    });
    
    if (hasPlanning) {
        syncIndicator.style.display = 'inline-block';
        syncIndicator.className = 'badge bg-success text-white me-1';
        syncIndicator.innerHTML = '<i class="fas fa-check-circle me-1"></i>Sincronizado';
    } else if (obrasAlocadas.length > 0) {
        syncIndicator.style.display = 'inline-block';
        syncIndicator.className = 'badge bg-warning text-dark me-1';
        syncIndicator.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Sem planejamento';
    } else {
        syncIndicator.style.display = 'none';
    }
}

// ===================================
// OTIMIZA√á√ÉO DE PERFORMANCE - FASE 3
// ===================================

// Lazy loading para funcionalidades pesadas
function lazyLoadFeatures() {
    // Pr√©-carregar dados em background
    setTimeout(() => {
        if (!servicosCatalog.length) {
            loadServicesCatalog().catch(console.error);
        }
    }, 2000);
    
    // Otimizar drag & drop para dispositivos m√≥veis
    if (window.innerWidth <= 768) {
        // Reduzir anima√ß√µes em dispositivos m√≥veis
        document.documentElement.style.setProperty('--animation-duration', '0.1s');
    }
}

// Debounce para filtros
let filterTimeout;
function debouncedFilter(callback, delay = 300) {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(callback, delay);
}

// Inicializa√ß√£o otimizada
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar recursos cr√≠ticos primeiro
    waitForSortable();
    
    // Carregar funcionalidades n√£o-cr√≠ticas depois
    setTimeout(lazyLoadFeatures, 1000);
    
    // Atualizar indicadores periodicamente
    setInterval(updateSyncIndicator, 30000); // A cada 30 segundos
});

console.log('üîß EQUIPE System initialized - SIGE Pattern Compliant - FASE 3 COMPLETA');
console.log('üìä Features: ‚úÖ Vista Mensal ‚úÖ Weekly Planner ‚úÖ Filtros ‚úÖ Exporta√ß√£o ‚úÖ Valida√ß√µes ‚úÖ Sincroniza√ß√£o');
</script>
{% endblock %}