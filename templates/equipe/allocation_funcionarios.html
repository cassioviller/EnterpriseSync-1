{% extends "base_completo.html" %}

{% block title %}üë• Funcion√°rios - {{ allocation.obra.codigo }} ({{ allocation.data_alocacao.strftime('%d/%m') }}){% endblock %}

{% block head_content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" defer></script>

<style>
/* Estilo espec√≠fico para drag & drop funcion√°rios - Padr√£o SIGE */
.funcionario-card {
    cursor: grab;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.funcionario-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.2) !important;
    border-color: #198754;
}

.funcionario-card:active {
    cursor: grabbing;
    transform: scale(1.02);
}

.funcionario-card.dragging {
    opacity: 0.6;
    transform: rotate(2deg);
}

.funcionario-card.funcionario-alocado {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: #198754;
}

.funcionario-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3);
}

.funcionario-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.drop-zone-available {
    min-height: 400px;
    border: 2px dashed #17a2b8;
    border-radius: 12px;
    background: rgba(23, 162, 184, 0.05);
    transition: all 0.3s ease;
}

.drop-zone-allocated {
    min-height: 400px;
    border: 2px dashed #198754;
    border-radius: 12px;
    background: rgba(25, 135, 84, 0.05);
    transition: all 0.3s ease;
}

.drop-zone-available.drag-over {
    background: rgba(23, 162, 184, 0.1);
    border-style: solid;
    box-shadow: inset 0 0 20px rgba(23, 162, 184, 0.1);
}

.drop-zone-allocated.drag-over {
    background: rgba(25, 135, 84, 0.1);
    border-style: solid;
    box-shadow: inset 0 0 20px rgba(25, 135, 84, 0.1);
}

.turno-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(25, 135, 84, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: bold;
}

.papel-badge {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: #ffc107;
    color: #856404;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: bold;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

.allocation-header {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.2);
}

.meta-badge {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    margin-right: 8px;
    backdrop-filter: blur(10px);
}

.success-animation {
    animation: pulseSuccess 0.6s ease;
}

@keyframes pulseSuccess {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
}

.removing-animation {
    animation: slideOut 0.4s ease forwards;
}

@keyframes slideOut {
    to {
        transform: translateX(-100%);
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
    }
}

/* Loading states */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loading-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
}

.custom-toast {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    padding: 16px;
    margin-bottom: 10px;
    border-left: 4px solid #198754;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Responsividade */
@media (max-width: 768px) {
    .funcionario-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .drop-zone-available,
    .drop-zone-allocated {
        min-height: 300px;
    }
    
    .allocation-header {
        padding: 16px;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header da obra/dia -->
    <div class="allocation-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="mb-2">üèóÔ∏è {{ allocation.obra.nome }}</h3>
                <div class="d-flex flex-wrap">
                    <span class="meta-badge">
                        <i class="fas fa-calendar me-1"></i>
                        {{ allocation.data_alocacao.strftime('%A, %d/%m/%Y') }}
                    </span>
                    <span class="meta-badge">
                        <i class="fas fa-clock me-1"></i>
                        {{ allocation.turno_inicio.strftime('%H:%M') if allocation.turno_inicio else '08:00' }} - 
                        {{ allocation.turno_fim.strftime('%H:%M') if allocation.turno_fim else '17:00' }}
                    </span>
                    <span class="meta-badge">
                        <i class="fas fa-users me-1"></i>
                        {{ funcionarios_alocados|length }} funcion√°rios alocados
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light" onclick="voltarCalendario()">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar ao Calend√°rio
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Funcion√°rios Dispon√≠veis -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white;">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        Funcion√°rios Dispon√≠veis ({{ funcionarios_disponiveis|length }})
                    </h5>
                </div>
                <div class="card-body p-2">
                    <div class="drop-zone-available" id="funcionarios-disponiveis">
                        {% if funcionarios_disponiveis %}
                            {% for funcionario in funcionarios_disponiveis %}
                            <div class="card funcionario-card mb-2" 
                                 data-funcionario-id="{{ funcionario.id }}"
                                 data-funcionario-nome="{{ funcionario.nome }}"
                                 data-funcionario-funcao="{{ funcionario.funcao }}">
                                <div class="card-body p-3 position-relative">
                                    <div class="d-flex align-items-center">
                                        <div class="funcionario-avatar me-3">
                                            {% if funcionario.foto_base64 %}
                                                <img src="data:image/jpeg;base64,{{ funcionario.foto_base64 }}" alt="{{ funcionario.nome }}">
                                            {% else %}
                                                {{ funcionario.nome[0].upper() }}
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1">{{ funcionario.nome }}</h6>
                                            <div class="d-flex flex-wrap">
                                                <span class="badge bg-secondary me-1">
                                                    {{ funcionario.funcao or 'Fun√ß√£o n√£o informada' }}
                                                </span>
                                                {% if funcionario.codigo %}
                                                <span class="badge bg-primary">
                                                    #{{ funcionario.codigo }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-user-sleeping"></i>
                                <h5>Todos Ocupados</h5>
                                <p class="text-muted">Todos os funcion√°rios j√° est√£o alocados neste dia</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Funcion√°rios Alocados -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header" style="background: linear-gradient(135deg, #198754 0%, #28a745 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-check me-2"></i>
                            Alocados Nesta Obra ({{ funcionarios_alocados|length }})
                        </h5>
                        {% if funcionarios_alocados %}
                        <button class="btn btn-sm btn-light" onclick="limparTodasAlocacoes()" title="Limpar todas as aloca√ß√µes">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="drop-zone-allocated" id="funcionarios-alocados">
                        {% if funcionarios_alocados %}
                            {% for allocation_employee in funcionarios_alocados %}
                            <div class="card funcionario-card funcionario-alocado mb-2" 
                                 data-allocation-employee-id="{{ allocation_employee.id }}"
                                 data-funcionario-id="{{ allocation_employee.funcionario.id }}"
                                 data-funcionario-nome="{{ allocation_employee.funcionario.nome }}">
                                <div class="card-body p-3 position-relative">
                                    <div class="d-flex align-items-center">
                                        <div class="funcionario-avatar me-3">
                                            {% if allocation_employee.funcionario.foto_base64 %}
                                                <img src="data:image/jpeg;base64,{{ allocation_employee.funcionario.foto_base64 }}" alt="{{ allocation_employee.funcionario.nome }}">
                                            {% else %}
                                                {{ allocation_employee.funcionario.nome[0].upper() }}
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1">{{ allocation_employee.funcionario.nome }}</h6>
                                            <div class="d-flex flex-wrap">
                                                <span class="badge bg-success me-1">
                                                    {{ allocation_employee.funcionario.funcao or 'Fun√ß√£o n√£o informada' }}
                                                </span>
                                                {% if allocation_employee.papel %}
                                                <span class="badge bg-warning text-dark">
                                                    {{ allocation_employee.papel }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Badge do turno -->
                                    <div class="turno-badge">
                                        {{ allocation_employee.turno_inicio.strftime('%H:%M') if allocation_employee.turno_inicio else '08:00' }}-{{ allocation_employee.turno_fim.strftime('%H:%M') if allocation_employee.turno_fim else '17:00' }}
                                    </div>
                                    
                                    {% if allocation_employee.papel %}
                                    <div class="papel-badge">
                                        {{ allocation_employee.papel }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-hand-point-left"></i>
                                <h5>Ningu√©m Alocado</h5>
                                <p class="text-muted">Arraste funcion√°rios da esquerda para alocar nesta obra</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- A√ß√µes r√°pidas -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="voltarCalendario()">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar ao Calend√°rio
                </button>
                {% if funcionarios_alocados %}
                <button class="btn btn-danger" onclick="limparTodasAlocacoes()">
                    <i class="fas fa-trash-alt me-2"></i>
                    Limpar Todas Aloca√ß√µes
                </button>
                {% endif %}
                <button class="btn btn-primary" onclick="salvarAlteracoes()" disabled>
                    <i class="fas fa-save me-2"></i>
                    Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Processando...</span>
        </div>
        <div>Processando aloca√ß√£o de funcion√°rio...</div>
    </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
// ===================================
// DRILL-DOWN FUNCION√ÅRIOS - PADR√ÉO SIGE
// ===================================

let allocationId = {{ allocation.id }};
let pendingChanges = false;

// Garantir que Sortable.js carregue antes de inicializar
function waitForSortable() {
    if (typeof Sortable !== 'undefined') {
        initializeFuncionariosDragDrop();
        console.log('üë• Sistema funcion√°rios inicializado - Padr√£o SIGE - Allocation #' + allocationId);
    } else {
        setTimeout(waitForSortable, 100);
    }
}

document.addEventListener('DOMContentLoaded', waitForSortable);

function initializeFuncionariosDragDrop() {
    // Lista de funcion√°rios dispon√≠veis
    const disponiveis = document.getElementById('funcionarios-disponiveis');
    if (disponiveis) {
        new Sortable(disponiveis, {
            group: {
                name: 'funcionarios',
                pull: 'clone',
                put: true
            },
            animation: 200,
            ghostClass: 'funcionario-card',
            chosenClass: 'dragging',
            onStart: function(evt) {
                console.log('üü¢ Drag funcion√°rio:', evt.item.dataset.funcionarioNome);
                showLoadingOverlay();
                hapticFeedback('impact');
            },
            onEnd: function(evt) {
                hideLoadingOverlay();
            }
        });
    }

    // Lista de funcion√°rios alocados
    const alocados = document.getElementById('funcionarios-alocados');
    if (alocados) {
        new Sortable(alocados, {
            group: {
                name: 'funcionarios',
                pull: true,
                put: true
            },
            animation: 200,
            ghostClass: 'funcionario-card',
            chosenClass: 'dragging',
            onAdd: function(evt) {
                const funcionarioElement = evt.item;
                const funcionarioId = funcionarioElement.dataset.funcionarioId;
                const funcionarioNome = funcionarioElement.dataset.funcionarioNome;
                
                console.log(`üü° Alocar: ${funcionarioNome} ‚Üí Obra`);
                alocarFuncionario(funcionarioId, funcionarioElement);
            },
            onRemove: function(evt) {
                const funcionarioElement = evt.item;
                const allocationEmployeeId = funcionarioElement.dataset.allocationEmployeeId;
                
                if (allocationEmployeeId) {
                    console.log('üî¥ Desalocar funcion√°rio:', allocationEmployeeId);
                    desalocarFuncionario(allocationEmployeeId, funcionarioElement);
                }
            }
        });
    }

    // Visual feedback para drop zones
    [disponiveis, alocados].forEach(zone => {
        if (zone) {
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            
            zone.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            
            zone.addEventListener('drop', function(e) {
                this.classList.remove('drag-over');
            });
        }
    });
}

// ===================================
// API CALLS FUNCION√ÅRIOS
// ===================================

async function alocarFuncionario(funcionarioId, elemento) {
    try {
        const response = await fetch('/equipe/api/allocation-employees', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                allocation_id: allocationId,
                funcionario_id: parseInt(funcionarioId),
                turno_inicio: '{{ allocation.turno_inicio.strftime("%H:%M") if allocation.turno_inicio else "08:00" }}',
                turno_fim: '{{ allocation.turno_fim.strftime("%H:%M") if allocation.turno_fim else "17:00" }}',
                papel: '',
                observacao: ''
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            // Transformar elemento para alocado
            elemento.classList.add('funcionario-alocado');
            elemento.dataset.allocationEmployeeId = result.id;
            
            // Adicionar badges visuais
            const cardBody = elemento.querySelector('.card-body');
            
            // Turno badge
            const turnoInfo = document.createElement('div');
            turnoInfo.className = 'turno-badge';
            turnoInfo.textContent = '{{ allocation.turno_inicio.strftime("%H:%M") if allocation.turno_inicio else "08:00" }}-{{ allocation.turno_fim.strftime("%H:%M") if allocation.turno_fim else "17:00" }}';
            cardBody.appendChild(turnoInfo);
            
            // Anima√ß√£o de sucesso
            elemento.classList.add('success-animation');
            setTimeout(() => elemento.classList.remove('success-animation'), 600);
            
            console.log('‚úÖ Funcion√°rio alocado:', result.id);
            showToast(`${elemento.dataset.funcionarioNome} alocado com sucesso!`, 'success');
            hapticFeedback('success');
            
            updateSaveButton(true);
            
        } else {
            throw new Error(result.error || 'Erro ao alocar funcion√°rio');
        }
    } catch (error) {
        console.error('‚ùå Erro alocar funcion√°rio:', error);
        showToast(error.message, 'error');
        hapticFeedback('error');
        
        // Mover de volta para dispon√≠veis
        document.getElementById('funcionarios-disponiveis').appendChild(elemento);
    }
}

async function desalocarFuncionario(allocationEmployeeId, elemento) {
    try {
        const response = await fetch(`/equipe/api/allocation-employees/${allocationEmployeeId}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        
        if (response.ok) {
            // Transformar elemento para dispon√≠vel
            elemento.classList.remove('funcionario-alocado');
            delete elemento.dataset.allocationEmployeeId;
            
            // Remover badges
            const turnoInfo = elemento.querySelector('.turno-badge');
            const papelBadge = elemento.querySelector('.papel-badge');
            if (turnoInfo) turnoInfo.remove();
            if (papelBadge) papelBadge.remove();
            
            console.log('‚úÖ Funcion√°rio desalocado:', allocationEmployeeId);
            showToast(`${elemento.dataset.funcionarioNome} removido da obra`, 'info');
            hapticFeedback('impact');
            
            updateSaveButton(true);
            
        } else {
            throw new Error(result.error || 'Erro ao desalocar funcion√°rio');
        }
    } catch (error) {
        console.error('‚ùå Erro desalocar funcion√°rio:', error);
        showToast(error.message, 'error');
        hapticFeedback('error');
        
        // Mover de volta para alocados
        document.getElementById('funcionarios-alocados').appendChild(elemento);
    }
}

// ===================================
// A√á√ïES DO USU√ÅRIO
// ===================================

function voltarCalendario() {
    window.location.href = '/equipe/alocacao';
}

function limparTodasAlocacoes() {
    if (!confirm('Tem certeza que deseja remover todos os funcion√°rios desta obra?')) {
        return;
    }
    
    showLoadingOverlay();
    
    const alocados = document.querySelectorAll('#funcionarios-alocados .funcionario-alocado');
    let promises = [];
    
    alocados.forEach(elemento => {
        const allocationEmployeeId = elemento.dataset.allocationEmployeeId;
        if (allocationEmployeeId) {
            promises.push(
                fetch(`/equipe/api/allocation-employees/${allocationEmployeeId}`, {
                    method: 'DELETE'
                })
            );
        }
    });
    
    Promise.all(promises).then(() => {
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }).catch(error => {
        console.error('Erro ao limpar aloca√ß√µes:', error);
        showToast('Erro ao limpar algumas aloca√ß√µes', 'error');
        hideLoadingOverlay();
    });
}

function salvarAlteracoes() {
    showToast('Altera√ß√µes salvas em tempo real!', 'success');
    updateSaveButton(false);
}

function updateSaveButton(hasChanges = true) {
    const saveBtn = document.querySelector('.btn-primary[onclick="salvarAlteracoes()"]');
    if (saveBtn) {
        saveBtn.disabled = !hasChanges;
        pendingChanges = hasChanges;
    }
}

// ===================================
// UTILIDADES E FEEDBACK
// ===================================

function showLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    const colors = {
        'success': '#198754',
        'error': '#dc3545',
        'info': '#17a2b8',
        'warning': '#ffc107'
    };
    
    toast.className = 'custom-toast';
    toast.style.borderLeftColor = colors[type] || colors.info;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2" 
               style="color: ${colors[type] || colors.info}"></i>
            <span>${message}</span>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function hapticFeedback(type = 'impact') {
    if (navigator.vibrate) {
        const patterns = {
            'impact': [10],
            'success': [10, 50, 10],
            'error': [100, 30, 100]
        };
        navigator.vibrate(patterns[type] || patterns.impact);
    }
}

// Confirma√ß√£o antes de sair com mudan√ßas n√£o salvas
window.addEventListener('beforeunload', function(e) {
    if (pendingChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

console.log('üîß Funcion√°rios Drill-down System initialized - SIGE Pattern Compliant');
</script>
{% endblock %}