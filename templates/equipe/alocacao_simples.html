{% extends "base_completo.html" %}

{% block title %}Gest√£o de Equipe - FASE 2{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3>üìã Gest√£o de Equipe - FASE 2 CORRE√á√ïES</h3>
    <p class="text-muted">Implementa√ß√£o gradual - "FUNCIONA PRIMEIRO, OTIMIZA DEPOIS"</p>
    
    <!-- STATUS DE DEBUG -->
    <div class="alert alert-info" id="status-debug">
        <strong>Status:</strong> Carregando sistema...
    </div>
    
    <div class="row">
        <!-- SIDEBAR: OBRAS -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>üèóÔ∏è Obras Dispon√≠veis</h5>
                    <small id="obras-count">Carregando...</small>
                </div>
                <div class="card-body">
                    <div id="obras-list" style="min-height: 300px;">
                        <div class="text-center text-muted p-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Carregando obras...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GRID SEMANAL -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5>üìÖ Semana - FASE 2</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- SEGUNDA -->
                        <div class="col">
                            <h6 class="text-center">Segunda</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="0" 
                                 id="day-0">
                                <small class="text-muted">Drop zone Segunda</small>
                            </div>
                        </div>
                        
                        <!-- TER√áA -->
                        <div class="col">
                            <h6 class="text-center">Ter√ßa</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="1" 
                                 id="day-1">
                                <small class="text-muted">Drop zone Ter√ßa</small>
                            </div>
                        </div>
                        
                        <!-- QUARTA -->
                        <div class="col">
                            <h6 class="text-center">Quarta</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="2" 
                                 id="day-2">
                                <small class="text-muted">Drop zone Quarta</small>
                            </div>
                        </div>
                        
                        <!-- QUINTA -->
                        <div class="col">
                            <h6 class="text-center">Quinta</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="3" 
                                 id="day-3">
                                <small class="text-muted">Drop zone Quinta</small>
                            </div>
                        </div>
                        
                        <!-- SEXTA -->
                        <div class="col">
                            <h6 class="text-center">Sexta</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="4" 
                                 id="day-4">
                                <small class="text-muted">Drop zone Sexta</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PAINEL DE DEBUG MELHORADO -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>üîç FASE 2 - DEBUG E TESTE</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-info w-100" onclick="testarAPI()">
                        üîç Testar API B√°sica
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="testarObras()">
                        üèóÔ∏è Testar Carregamento Obras
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" onclick="testarDragDrop()">
                        üéØ Testar Drag & Drop
                    </button>
                </div>
            </div>
            
            <!-- √ÅREA DE RESULTADOS -->
            <div class="mt-3">
                <h6>Resultados dos Testes:</h6>
                <div id="debug-results" class="border rounded p-3" style="background: #f8f9fa; min-height: 100px; font-family: monospace; font-size: 0.9rem;">
                    Clique nos bot√µes acima para testar...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SortableJS - CDN confi√°vel -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// CLASSE FASE 2 - FOCO EM DEBUG E CORRE√á√ïES
class EquipeFase2 {
    constructor() {
        this.obras = [];
        this.debugArea = document.getElementById('debug-results');
        this.statusArea = document.getElementById('status-debug');
        
        this.log('=== INICIANDO FASE 2 ===');
        this.init();
    }
    
    log(message) {
        console.log(message);
        if (this.debugArea) {
            this.debugArea.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
            this.debugArea.scrollTop = this.debugArea.scrollHeight;
        }
    }
    
    updateStatus(message, type = 'info') {
        if (this.statusArea) {
            this.statusArea.className = `alert alert-${type}`;
            this.statusArea.innerHTML = `<strong>Status:</strong> ${message}`;
        }
    }
    
    async init() {
        try {
            this.log('Verificando se SortableJS carregou...');
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå ERRO: SortableJS n√£o carregou!');
                this.updateStatus('SortableJS n√£o carregou', 'danger');
                return;
            }
            this.log('‚úÖ SortableJS carregado com sucesso');
            
            this.updateStatus('Sistema inicializado - pronto para testes', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na inicializa√ß√£o: ${error.message}`);
            this.updateStatus(`Erro: ${error.message}`, 'danger');
        }
    }
    
    // TESTE 1: API B√ÅSICA
    async testarAPI() {
        this.log('=== TESTANDO API B√ÅSICA ===');
        
        try {
            // Teste 1: API sem autentica√ß√£o
            this.log('Testando /equipe/debug/test-direct...');
            const response1 = await fetch('/equipe/debug/test-direct');
            const data1 = await response1.json();
            this.log(`‚úÖ API direta: ${JSON.stringify(data1)}`);
            
            // Teste 2: API com autentica√ß√£o
            this.log('Testando /equipe/debug/obras-count...');
            const response2 = await fetch('/equipe/debug/obras-count');
            const data2 = await response2.json();
            this.log(`‚úÖ API obras: ${JSON.stringify(data2)}`);
            
            this.updateStatus('APIs funcionando corretamente', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na API: ${error.message}`);
            this.updateStatus(`Erro na API: ${error.message}`, 'danger');
        }
    }
    
    // TESTE 2: CARREGAMENTO DE OBRAS
    async testarObras() {
        this.log('=== TESTANDO CARREGAMENTO DE OBRAS ===');
        
        try {
            const response = await fetch('/equipe/api/obras-simples');
            const result = await response.json();
            
            this.log(`Response status: ${response.status}`);
            this.log(`Response data: ${JSON.stringify(result)}`);
            
            if (result.success && result.data) {
                this.obras = result.data;
                this.log(`‚úÖ ${this.obras.length} obras carregadas`);
                this.renderObras();
                this.updateStatus(`${this.obras.length} obras carregadas`, 'success');
            } else {
                this.log(`‚ùå Erro no resultado: ${result.error || 'Dados inv√°lidos'}`);
                this.updateStatus(`Erro: ${result.error || 'Dados inv√°lidos'}`, 'warning');
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO ao carregar obras: ${error.message}`);
            this.updateStatus(`Erro ao carregar obras: ${error.message}`, 'danger');
        }
    }
    
    renderObras() {
        const container = document.getElementById('obras-list');
        const countElement = document.getElementById('obras-count');
        
        if (!container) {
            this.log('‚ùå Container obras-list n√£o encontrado');
            return;
        }
        
        container.innerHTML = '';
        countElement.textContent = `${this.obras.length} obras encontradas`;
        
        this.obras.forEach((obra, index) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 obra-draggable';
            div.dataset.obraId = obra.id;
            div.style.cursor = 'grab';
            div.innerHTML = `
                <div class="card-body p-2">
                    <h6 class="card-title mb-1 text-primary">${obra.codigo}</h6>
                    <small class="text-muted">${obra.nome}</small>
                </div>
            `;
            container.appendChild(div);
        });
        
        this.log(`‚úÖ ${this.obras.length} obras renderizadas no DOM`);
        
        // Configurar drag & drop ap√≥s renderizar
        this.setupDragDrop();
    }
    
    // TESTE 3: DRAG & DROP
    testarDragDrop() {
        this.log('=== TESTANDO DRAG & DROP ===');
        
        try {
            // Verificar se SortableJS est√° dispon√≠vel
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå SortableJS n√£o est√° carregado');
                this.updateStatus('SortableJS n√£o carregado', 'danger');
                return;
            }
            
            // Testar se obras est√£o carregadas
            if (this.obras.length === 0) {
                this.log('‚ö†Ô∏è Nenhuma obra carregada. Execute "Testar Carregamento Obras" primeiro');
                this.updateStatus('Carregue obras primeiro', 'warning');
                return;
            }
            
            this.setupDragDrop();
            this.log('‚úÖ Drag & Drop configurado com sucesso');
            this.updateStatus('Drag & Drop ativo - arraste obras para os dias', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO no Drag & Drop: ${error.message}`);
            this.updateStatus(`Erro no Drag & Drop: ${error.message}`, 'danger');
        }
    }
    
    setupDragDrop() {
        this.log('Configurando SortableJS...');
        
        try {
            // Lista de obras (source)
            const obrasList = document.getElementById('obras-list');
            if (obrasList && !obrasList.sortableInstance) {
                obrasList.sortableInstance = Sortable.create(obrasList, {
                    group: {
                        name: 'obras',
                        pull: 'clone',
                        put: false
                    },
                    sort: false,
                    animation: 150,
                    onStart: (evt) => {
                        this.log(`üéØ Arrastando obra: ${evt.item.dataset.obraId}`);
                    }
                });
            }
            
            // Drop zones (dias da semana)
            for (let i = 0; i < 5; i++) {
                const dayElement = document.getElementById(`day-${i}`);
                if (dayElement && !dayElement.sortableInstance) {
                    dayElement.sortableInstance = Sortable.create(dayElement, {
                        group: 'obras',
                        animation: 150,
                        onAdd: (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][i];
                            this.log(`‚úÖ Obra ${obraId} adicionada ao ${dayName}!`);
                            this.updateStatus(`Obra adicionada ao ${dayName}`, 'success');
                            
                            // Limpar placeholder
                            if (dayElement.querySelector('.text-muted')) {
                                const placeholder = dayElement.querySelector('.text-muted');
                                if (placeholder.textContent.includes('Drop zone')) {
                                    placeholder.remove();
                                }
                            }
                        },
                        onRemove: (evt) => {
                            this.log(`üì§ Obra removida do dia ${i}`);
                        }
                    });
                }
            }
            
            this.log('‚úÖ Todas as drop zones configuradas');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao configurar SortableJS: ${error.message}`);
            throw error;
        }
    }
}

// ===================================
// FUN√á√ïES GLOBAIS PARA OS BOT√ïES
// ===================================

function testarAPI() {
    if (window.equipeFase2) {
        window.equipeFase2.testarAPI();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarObras() {
    if (window.equipeFase2) {
        window.equipeFase2.testarObras();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarDragDrop() {
    if (window.equipeFase2) {
        window.equipeFase2.testarDragDrop();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

// ===================================
// INICIALIZA√á√ÉO AUTOM√ÅTICA
// ===================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM loaded - Inicializando FASE 2...');
    window.equipeFase2 = new EquipeFase2();
});

console.log('üìú Script FASE 2 carregado - Aguardando DOM...');
</script>
{% endblock %}