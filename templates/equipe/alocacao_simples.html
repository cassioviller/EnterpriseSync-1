{% extends "base_completo.html" %}

{% block title %}Gest√£o de Equipe - FASE 2{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3>üìã Gest√£o de Equipe - FASE 2 CORRE√á√ïES</h3>
    <p class="text-muted">Implementa√ß√£o gradual - "FUNCIONA PRIMEIRO, OTIMIZA DEPOIS"</p>
    
    <!-- STATUS DE DEBUG -->
    <div class="alert alert-info" id="status-debug">
        <strong>Status:</strong> Carregando sistema...
    </div>
    
    <!-- BARRA HORIZONTAL DE OBRAS OTIMIZADA PARA TABLETS -->
    <div class="card mb-3 obras-horizontal-card">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <!-- PESQUISA E INFORMA√á√ïES -->
                <div class="col-md-3 col-lg-2">
                    <!-- T√çTULO E CONTADOR -->
                    <div class="obras-header mb-2">
                        <h6 class="mb-1 fw-bold text-primary">üèóÔ∏è Obras</h6>
                        <small id="obras-count" class="text-muted">Carregando...</small>
                    </div>
                    
                    <!-- CAMPO DE PESQUISA COMPACTO -->
                    <div class="search-container-horizontal">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text search-icon-horizontal">
                                <i class="fas fa-search"></i>
                            </span>
                            <input 
                                type="text" 
                                id="search-obras" 
                                class="form-control search-input-horizontal" 
                                placeholder="Buscar obras..."
                                autocomplete="off"
                            >
                            <button class="btn btn-outline-secondary clear-search-horizontal" type="button" id="clear-search" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- CONTADOR DE RESULTADOS DA PESQUISA -->
                        <div id="search-results-info" class="search-results-info-horizontal mt-1" style="display: none;">
                            <small class="text-muted">
                                <span id="filtered-count">0</span>/<span id="total-count">0</span>
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- OBRAS EM SCROLL HORIZONTAL -->
                <div class="col-md-9 col-lg-10">
                    <div class="obras-horizontal-container">
                        <div id="obras-list" class="obras-horizontal-list">
                            <div class="text-center text-muted p-4">
                                <div class="spinner-border spinner-border-sm me-2"></div>
                                Carregando obras...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CALEND√ÅRIO SEMANAL EXPANDIDO -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <!-- CABE√áALHO COM NAVEGA√á√ÉO -->
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">üìÖ Gest√£o Semanal</h5>
                            <small id="week-title" class="text-muted">Carregando semana...</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" id="btn-prev-week" onclick="window.equipeFase2.navegarSemana(-1)">
                                <i class="fas fa-chevron-left"></i> Semana Anterior
                            </button>
                            <button class="btn btn-outline-secondary" id="btn-current-week" onclick="window.equipeFase2.irParaSemanaAtual()">
                                Hoje
                            </button>
                            <button class="btn btn-outline-primary" id="btn-next-week" onclick="window.equipeFase2.navegarSemana(1)">
                                Pr√≥xima Semana <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- INDICADOR DE CARREGAMENTO -->
                <div id="week-loading" class="card-body text-center" style="display: none;">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Carregando semana...</span>
                </div>
                
                <div class="card-body weekly-grid-container" id="weekly-grid">
                    <div class="row weekly-grid">
                        <!-- DOMINGO -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-0">
                                <div class="fw-bold">Domingo</div>
                                <small class="date-display text-muted" id="date-day-0">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="0" 
                                 id="day-0"
                                 role="region"
                                 aria-label="Zona para obras de domingo"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- SEGUNDA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-1">
                                <div class="fw-bold">Segunda</div>
                                <small class="date-display text-muted" id="date-day-1">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="1" 
                                 id="day-1"
                                 role="region"
                                 aria-label="Zona para obras de segunda-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- TER√áA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-2">
                                <div class="fw-bold">Ter√ßa</div>
                                <small class="date-display text-muted" id="date-day-2">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="2" 
                                 id="day-2"
                                 role="region"
                                 aria-label="Zona para obras de ter√ßa-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- QUARTA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-3">
                                <div class="fw-bold">Quarta</div>
                                <small class="date-display text-muted" id="date-day-3">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="3" 
                                 id="day-3"
                                 role="region"
                                 aria-label="Zona para obras de quarta-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- QUINTA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-4">
                                <div class="fw-bold">Quinta</div>
                                <small class="date-display text-muted" id="date-day-4">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="4" 
                                 id="day-4"
                                 role="region"
                                 aria-label="Zona para obras de quinta-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- SEXTA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-5">
                                <div class="fw-bold">Sexta</div>
                                <small class="date-display text-muted" id="date-day-5">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="5" 
                                 id="day-5"
                                 role="region"
                                 aria-label="Zona para obras de sexta-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- S√ÅBADO -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-6">
                                <div class="fw-bold">S√°bado</div>
                                <small class="date-display text-muted" id="date-day-6">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="6" 
                                 id="day-6"
                                 role="region"
                                 aria-label="Zona para obras de s√°bado"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PAINEL DE DEBUG MELHORADO - Minimalista -->
    <div class="card mt-4 debug-panel" style="display: none;" id="debug-panel">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üîç Ferramentas de Desenvolvimento</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('debug-panel').style.display='none'">
                    ‚úï Fechar
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-info w-100" onclick="testarAPI()">
                        üîç Testar API B√°sica
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="testarObras()">
                        üèóÔ∏è Recarregar Obras
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" onclick="testarDragDrop()">
                        üéØ Reconfigurar Drag & Drop
                    </button>
                </div>
            </div>
            
            <!-- √ÅREA DE RESULTADOS -->
            <div class="mt-3">
                <h6>Resultados dos Testes:</h6>
                <div id="debug-results" class="border rounded p-3" style="background: #f8f9fa; min-height: 100px; font-family: monospace; font-size: 0.9rem;">
                    Clique nos bot√µes acima para testar...
                </div>
            </div>
        </div>
    </div>
    
    <!-- BOT√ÉO PARA MOSTRAR DEBUG (apenas para desenvolvimento) -->
    <div class="position-fixed" style="bottom: 20px; left: 20px; z-index: 1000;">
        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('debug-panel').style.display='block'" title="Mostrar ferramentas de desenvolvimento">
            üîß
        </button>
    </div>

    <!-- MODAL DE FUNCION√ÅRIOS -->
    <div class="modal fade" id="funcionariosModal" tabindex="-1" aria-labelledby="funcionariosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <!-- HEADER -->
                <div class="modal-header">
                    <h5 class="modal-title" id="funcionariosModalLabel">
                        <i class="fas fa-users me-2"></i>
                        <span id="modal-title-text">Carregando funcion√°rios...</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body">
                    <!-- LOADING STATE -->
                    <div id="modal-loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-muted">Carregando dados...</p>
                    </div>

                    <!-- CONTENT -->
                    <div id="modal-content" style="display: none;">
                        <!-- FUNCION√ÅRIOS ALOCADOS -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="mb-0 fw-bold">
                                    <i class="fas fa-user-check text-success me-2"></i>
                                    Funcion√°rios Alocados
                                </h6>
                                <span class="badge bg-success ms-2" id="allocated-count">0</span>
                            </div>
                            
                            <div id="funcionarios-alocados-list">
                                <div class="text-muted text-center py-3">
                                    <i class="fas fa-user-slash fa-2x mb-2"></i>
                                    <p>Nenhum funcion√°rio alocado ainda</p>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- ADICIONAR FUNCION√ÅRIO -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-user-plus text-primary me-2"></i>
                                Adicionar Funcion√°rio
                            </h6>
                            
                            <div class="row">
                                <!-- SELE√á√ÉO DE FUNCION√ÅRIO -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Funcion√°rio</label>
                                    <select class="form-select" id="select-funcionario">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>
                                
                                <!-- HOR√ÅRIO IN√çCIO -->
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">In√≠cio</label>
                                    <input type="time" class="form-control" id="input-turno-inicio" value="08:00">
                                </div>
                                
                                <!-- HOR√ÅRIO FIM -->
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Fim</label>
                                    <input type="time" class="form-control" id="input-turno-fim" value="17:00">
                                </div>
                                
                                <!-- PAPEL/FUN√á√ÉO -->
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Papel/Fun√ß√£o</label>
                                    <input type="text" class="form-control" id="input-papel" placeholder="Ex: L√≠der, Ajudante">
                                </div>
                                
                                <!-- BOT√ÉO ADICIONAR -->
                                <div class="col-md-1 mb-3">
                                    <label class="form-label d-block">&nbsp;</label>
                                    <button type="button" class="btn btn-success w-100" id="btn-add-funcionario">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- FUNCION√ÅRIOS DISPON√çVEIS -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="mb-0 fw-bold">
                                    <i class="fas fa-users text-info me-2"></i>
                                    Funcion√°rios Dispon√≠veis
                                </h6>
                                <span class="badge bg-info ms-2" id="available-count">0</span>
                            </div>
                            
                            <div id="funcionarios-disponiveis-list" class="row g-2">
                                <!-- Cards de funcion√°rios dispon√≠veis ser√£o inseridos aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- ERROR STATE -->
                    <div id="modal-error" class="text-center py-4" style="display: none;">
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <h6>Erro ao carregar dados</h6>
                            <p class="text-muted" id="modal-error-message"></p>
                            <button class="btn btn-outline-primary" onclick="window.equipeFase2.reloadModal()">
                                <i class="fas fa-refresh me-1"></i>
                                Tentar Novamente
                            </button>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Fechar
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-refresh-modal" onclick="window.equipeFase2.reloadModal()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FontAwesome for navigation icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Custom styles for calendar navigation -->
<style>
    .day-header {
        border-bottom: 2px solid transparent;
        padding-bottom: 8px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }
    
    .day-header.text-primary {
        border-bottom-color: #007bff;
        background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        border-radius: 8px;
        padding: 8px;
    }
    
    .drop-zone {
        transition: all 0.3s ease;
        border: 2px dashed #dee2e6 !important;
    }
    
    .drop-zone:hover {
        border-color: #007bff !important;
        background-color: #f8f9ff !important;
    }
    
    .drop-zone.drag-over {
        border-color: #28a745 !important;
        background-color: #f8fff8 !important;
        transform: scale(1.02);
    }
    
    .obra-draggable {
        transition: all 0.2s ease;
        cursor: grab;
    }
    
    .obra-draggable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .obra-draggable:active {
        cursor: grabbing;
        transform: rotate(3deg);
    }
    
    .allocation-item {
        transition: all 0.2s ease;
    }
    
    .allocation-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .btn-group .btn {
        transition: all 0.2s ease;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-1px);
    }
    
    #week-loading {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .week-nav-header {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-bottom: 1px solid #dee2e6;
    }
    
    .current-week-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        margin-left: 8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* ===================================
       MODAL DE FUNCION√ÅRIOS - ESTILOS
       =================================== */
    
    .funcionario-alocado-card {
        background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    
    .funcionario-alocado-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
    }
    
    .funcionario-disponivel-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .funcionario-disponivel-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        border-color: #007bff;
    }
    
    .funcionario-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
        margin: 0 auto 8px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .funcionario-info {
        margin-left: 12px;
        flex: 1;
    }
    
    .funcionario-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .funcionario-details {
        color: #666;
        font-size: 0.9em;
    }
    
    .funcionario-actions {
        margin-left: auto;
        display: flex;
        gap: 4px;
    }
    
    .btn-remove-funcionario {
        padding: 4px 8px;
        font-size: 0.8em;
        border-radius: 4px;
    }
    
    .modal-xl {
        max-width: 1200px;
    }
    
    .empty-state {
        color: #6c757d;
        text-align: center;
        padding: 24px;
    }
    
    .empty-state i {
        opacity: 0.5;
        margin-bottom: 12px;
    }
    
    .allocation-item-clickable {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .allocation-item-clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .allocation-item-clickable::after {
        content: 'üë•';
        position: absolute;
        top: 4px;
        right: 8px;
        font-size: 12px;
        opacity: 0.7;
    }
    
    .funcionario-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: inherit;
    }
    
    /* ===================================
       MELHORIAS DE UX - SISTEMAS NOVOS
       =================================== */
    
    /* TOAST SYSTEM MELHORADO */
    .custom-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px 16px;
        min-width: 280px;
        transform: translateX(350px);
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }
    
    .custom-toast.show {
        transform: translateX(0);
    }
    
    .custom-toast.toast-success {
        border-left-color: #28a745;
    }
    
    .custom-toast.toast-error {
        border-left-color: #dc3545;
    }
    
    .custom-toast.toast-warning {
        border-left-color: #ffc107;
    }
    
    .custom-toast.toast-loading {
        border-left-color: #17a2b8;
    }
    
    .toast-content {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .toast-icon {
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .toast-message {
        font-weight: 500;
        color: #333;
    }
    
    /* LOADING ELEGANTE PARA OPERA√á√ïES */
    .operation-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        z-index: 100;
        transition: opacity 0.3s ease;
    }
    
    .operation-loading-overlay.fade-out {
        opacity: 0;
    }
    
    .operation-loading-content {
        text-align: center;
        color: #007bff;
        font-weight: 500;
    }
    
    .spinner-elegant {
        width: 32px;
        height: 32px;
        border: 3px solid #e3f2fd;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* CONTADOR DE OBRAS POR DIA */
    .day-counter {
        margin-top: 4px;
        text-align: center;
    }
    
    .day-counter .badge {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    /* INDICADORES DE CAPACIDADE */
    .drop-zone.capacity-low {
        border-color: #28a745 !important;
        background-color: #f8fff8 !important;
    }
    
    .drop-zone.capacity-medium {
        border-color: #ffc107 !important;
        background-color: #fffdf8 !important;
    }
    
    .drop-zone.capacity-high {
        border-color: #fd7e14 !important;
        background-color: #fff8f5 !important;
    }
    
    .drop-zone.capacity-full {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
    }
    
    /* ESTADOS DE DRAG & DROP APRIMORADOS */
    .drop-zone-active {
        border-color: #007bff !important;
        background-color: #f8f9ff !important;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }
    
    .drop-zone-invalid {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .obra-draggable.dragging {
        opacity: 0.8;
        transform: rotate(5deg) scale(1.05);
        z-index: 1000;
    }
    
    /* MODAL DE CONFIRMA√á√ÉO DE REMO√á√ÉO */
    .removal-confirmation-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .removal-confirmation-modal.show {
        opacity: 1;
    }
    
    .removal-confirmation-content {
        background: white;
        border-radius: 8px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }
    
    .removal-confirmation-modal.show .removal-confirmation-content {
        transform: scale(1);
    }
    
    .confirmation-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: flex-end;
    }
    
    .confirmation-buttons .btn {
        min-width: 100px;
    }
    
    /* TOOLTIPS APRIMORADOS */
    .obra-tooltip {
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        max-width: 250px;
        word-wrap: break-word;
    }
    
    .obra-tooltip.show {
        opacity: 1;
    }
    
    .obra-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
    
    /* RESPONSIVIDADE PARA TABLETS */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 8px;
        }
        
        .row {
            margin: 0;
        }
        
        .col-md-3, .col-md-9 {
            padding: 4px;
        }
        
        /* Layout em stack para tablets */
        .col-md-3 {
            margin-bottom: 16px;
        }
        
        /* AJUSTES ESPEC√çFICOS PARA BARRA LATERAL COM PESQUISA */
        .obras-scroll-container {
            height: 280px; /* Altura reduzida para tablets */
        }
        
        .search-input {
            font-size: 16px; /* Evita zoom autom√°tico no iOS */
            padding: 12px 16px;
        }
        
        .search-icon, .clear-search {
            padding: 12px 16px;
        }
        
        /* Obras maiores para touch */
        .obras-scroll-container .obra-draggable {
            margin-bottom: 12px;
        }
        
        .obras-scroll-container .obra-draggable .card-body {
            padding: 12px;
        }
        
        /* Scrollbar mais ampla para touch */
        .obras-scroll-container::-webkit-scrollbar {
            width: 12px;
        }
        
        .obras-scroll-container::-webkit-scrollbar-thumb {
            border-radius: 6px;
        }
        
        /* Bot√µes de navega√ß√£o maiores para touch */
        .btn-group .btn {
            padding: 12px 16px;
            font-size: 14px;
            min-height: 48px;
        }
        
        /* Drop zones maiores para touch */
        .drop-zone {
            min-height: 120px !important;
            padding: 16px !important;
        }
        
        /* Cards de obra maiores para touch */
        .obra-draggable {
            margin-bottom: 8px;
        }
        
        .obra-draggable .card-body {
            padding: 12px !important;
        }
        
        /* Bot√µes de remo√ß√£o maiores */
        .allocation-item .btn-sm {
            min-width: 36px;
            min-height: 36px;
        }
        
        /* Toast responsivo */
        .custom-toast {
            right: 10px;
            left: 10px;
            min-width: auto;
            transform: translateY(-100px);
        }
        
        .custom-toast.show {
            transform: translateY(0);
        }
        
        /* Modal responsivo */
        .removal-confirmation-content {
            margin: 20px;
            width: calc(100% - 40px);
        }
    }
    
    @media (max-width: 576px) {
        /* Grid semanal em scroll horizontal para celulares - FOR√áA UMA LINHA */
        .weekly-grid-container {
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .weekly-grid {
            min-width: 600px;
            display: flex !important;
            flex-wrap: nowrap !important;
        }
        
        /* Cabe√ßalhos menores */
        h3 {
            font-size: 1.5rem;
        }
        
        h5 {
            font-size: 1.1rem;
        }
        
        /* Debug panel minimizado */
        .debug-panel {
            display: none;
        }
    }
    
    /* ===================================
       ESTILOS PARA BARRA HORIZONTAL DE OBRAS - LAYOUT TABLET
       =================================== */
    
    /* CARD PRINCIPAL DA BARRA HORIZONTAL */
    .obras-horizontal-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    
    /* HEADER DE OBRAS COMPACTO */
    .obras-header h6 {
        font-size: 16px;
        margin-bottom: 4px;
    }
    
    .obras-header small {
        font-size: 12px;
        font-weight: 500;
    }
    
    /* PESQUISA HORIZONTAL COMPACTA */
    .search-container-horizontal {
        width: 100%;
    }
    
    .search-input-horizontal {
        border-radius: 6px;
        border: 1px solid #e9ecef;
        font-size: 13px;
        padding: 6px 10px;
        height: 36px;
    }
    
    .search-input-horizontal:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
        outline: none;
    }
    
    .search-icon-horizontal {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-right: none;
        border-radius: 6px 0 0 6px;
        color: #6c757d;
        font-size: 12px;
        padding: 6px 8px;
    }
    
    .clear-search-horizontal {
        border: 1px solid #e9ecef;
        border-left: none;
        border-radius: 0 6px 6px 0;
        background: #f8f9fa;
        color: #6c757d;
        font-size: 12px;
        padding: 4px 8px;
        min-width: 32px;
    }
    
    .clear-search-horizontal:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    .search-results-info-horizontal {
        font-size: 11px;
        color: #6c757d;
    }
    
    /* CONTAINER HORIZONTAL DE OBRAS */
    .obras-horizontal-container {
        position: relative;
        width: 100%;
        height: 100px;
        overflow: hidden;
    }
    
    .obras-horizontal-list {
        display: flex;
        gap: 12px;
        height: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 4px 8px;
        scroll-behavior: smooth;
        /* Scroll customizado para horizontal */
        scrollbar-width: thin;
        scrollbar-color: #007bff #f1f1f1;
    }
    
    .obras-horizontal-list::-webkit-scrollbar {
        height: 6px;
    }
    
    .obras-horizontal-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .obras-horizontal-list::-webkit-scrollbar-thumb {
        background: #007bff;
        border-radius: 3px;
        transition: background 0.3s ease;
    }
    
    .obras-horizontal-list::-webkit-scrollbar-thumb:hover {
        background: #0056b3;
    }
    
    /* CARDS DE OBRA HORIZONTAL */
    .obras-horizontal-list .obra-draggable {
        flex: 0 0 280px; /* 3 obras visuais + espa√ßo */
        min-width: 280px;
        max-width: 280px;
        height: 88px;
        margin: 0;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        transition: all 0.3s ease;
        cursor: grab;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }
    
    .obras-horizontal-list .obra-draggable:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
    }
    
    .obras-horizontal-list .obra-draggable:active {
        cursor: grabbing;
        transform: rotate(2deg) scale(1.02);
    }
    
    .obras-horizontal-list .obra-draggable .card-body {
        padding: 8px 12px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .obras-horizontal-list .obra-draggable .card-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 2px;
        line-height: 1.2;
        color: #495057;
    }
    
    .obras-horizontal-list .obra-draggable .card-text {
        font-size: 11px;
        line-height: 1.3;
        color: #6c757d;
        margin-bottom: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    /* CALEND√ÅRIO EXPANDIDO - SEMPRE UMA LINHA HORIZONTAL */
    .weekly-grid-container {
        padding: 16px 20px;
        overflow-x: auto; /* Scroll horizontal se necess√°rio */
    }
    
    .weekly-grid {
        display: flex !important;
        flex-wrap: nowrap !important; /* NUNCA quebra linha */
        min-width: 100%;
        gap: 0.5rem;
    }
    
    .weekly-grid .col {
        flex: 1 1 0px !important; /* Cada dia ocupa espa√ßo igual */
        min-width: 0; /* Permite reduzir se necess√°rio */
        padding: 0 4px;
        max-width: none !important; /* Remove limita√ß√µes Bootstrap */
    }
    
    .drop-zone {
        min-height: 250px !important; /* Maior que antes */
        padding: 16px !important;
        border-radius: 10px !important;
    }
    
    /* RESPONSIVIDADE ESPEC√çFICA PARA LAYOUT HORIZONTAL */
    @media (max-width: 1200px) {
        .obras-horizontal-list .obra-draggable {
            flex: 0 0 260px;
            min-width: 260px;
            max-width: 260px;
        }
    }
    
    @media (max-width: 992px) {
        .col-md-3.col-lg-2 {
            margin-bottom: 12px;
        }
        
        .obras-horizontal-list {
            height: 120px;
        }
        
        .obras-horizontal-list .obra-draggable {
            flex: 0 0 240px;
            min-width: 240px;
            max-width: 240px;
            height: 100px;
        }
        
        .drop-zone {
            min-height: 200px !important;
        }
    }
    
    @media (max-width: 768px) {
        /* LAYOUT STACK PARA TABLETS PEQUENOS */
        .obras-horizontal-card .row {
            flex-direction: column;
        }
        
        .col-md-3.col-lg-2 {
            width: 100%;
            margin-bottom: 16px;
        }
        
        .col-md-9.col-lg-10 {
            width: 100%;
        }
        
        .search-container-horizontal {
            max-width: 300px;
        }
        
        .obras-horizontal-list {
            height: 140px;
        }
        
        .obras-horizontal-list .obra-draggable {
            flex: 0 0 220px;
            min-width: 220px;
            max-width: 220px;
            height: 120px;
        }
        
        .obras-horizontal-list .obra-draggable .card-body {
            padding: 12px;
        }
        
        .obras-horizontal-list .obra-draggable .card-title {
            font-size: 14px;
        }
        
        .obras-horizontal-list .obra-draggable .card-text {
            font-size: 12px;
        }
        
        /* Calend√°rio otimizado para tablet */
        .weekly-grid-container {
            padding: 12px;
            overflow-x: auto; /* Permite scroll se necess√°rio */
        }
        
        .weekly-grid {
            min-width: 700px; /* Garante espa√ßo m√≠nimo para 7 dias */
        }
        
        .drop-zone {
            min-height: 180px !important;
            padding: 12px !important;
        }
    }
    
    @media (max-width: 576px) {
        /* CELULARES - SCROLL AINDA MAIS COMPACTO */
        .obras-horizontal-list {
            height: 100px;
            gap: 8px;
        }
        
        .obras-horizontal-list .obra-draggable {
            flex: 0 0 200px;
            min-width: 200px;
            max-width: 200px;
            height: 88px;
        }
        
        .weekly-grid {
            min-width: 580px; /* Scroll horizontal para semana - largura ajustada */
        }
        
        .weekly-grid .col {
            min-width: 80px; /* Largura m√≠nima para cada dia */
        }
        
        .drop-zone {
            min-height: 140px !important;
        }
    }
    
    /* ===================================
       ESTILOS LEGADOS PARA COMPATIBILIDADE
       =================================== */
    
    /* CONTAINER PRINCIPAL DE PESQUISA */
    .search-container {
        position: relative;
    }
    
    .search-input {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .search-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        outline: none;
    }
    
    .search-icon {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-right: none;
        border-radius: 8px 0 0 8px;
        color: #6c757d;
        padding: 8px 12px;
    }
    
    .clear-search {
        border: 2px solid #e9ecef;
        border-left: none;
        border-radius: 0 8px 8px 0;
        background: #f8f9fa;
        color: #6c757d;
        padding: 6px 10px;
        transition: all 0.2s ease;
    }
    
    .clear-search:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    /* CONTAINER COM SCROLL PARA 5 OBRAS */
    .obras-scroll-container {
        height: 320px; /* Altura para aproximadamente 5 obras */
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fafafa;
        padding: 8px;
        /* Scroll customizado */
        scrollbar-width: thin;
        scrollbar-color: #007bff #f1f1f1;
    }
    
    .obras-scroll-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .obras-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .obras-scroll-container::-webkit-scrollbar-thumb {
        background: #007bff;
        border-radius: 4px;
        transition: background 0.3s ease;
    }
    
    .obras-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #0056b3;
    }
    
    /* ESTILOS PARA OBRAS DENTRO DO SCROLL */
    .obras-scroll-container #obras-list {
        min-height: initial;
        padding: 0;
    }
    
    .obras-scroll-container .obra-draggable {
        margin-bottom: 8px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .obras-scroll-container .obra-draggable:hover {
        border-color: #007bff;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }
    
    /* ESTADO DE FILTRAGEM */
    .obra-draggable.filtered-out {
        display: none;
        animation: fadeOut 0.2s ease-out;
    }
    
    .obra-draggable.filtered-in {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* INFO DE RESULTADOS DE PESQUISA */
    .search-results-info {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 8px 12px;
        border: 1px solid #e9ecef;
    }
    
    .search-results-info.no-results {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    .search-results-info .fas {
        color: #007bff;
    }
    
    /* CONTADOR DE OBRAS MELHORADO */
    #obras-count.obras-count {
        font-weight: 600;
        color: #007bff;
        font-size: 13px;
    }
    
    /* PLACEHOLDER PARA LISTA VAZIA */
    .empty-search-result {
        text-align: center;
        padding: 24px 16px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 16px 0;
        border: 2px dashed #dee2e6;
    }
    
    .empty-search-result .fas {
        font-size: 32px;
        color: #adb5bd;
        margin-bottom: 12px;
    }
    
    .empty-search-result p {
        margin: 8px 0 0 0;
        font-size: 14px;
    }
    
    /* HIGHLIGHT DE TEXTO PESQUISADO */
    .highlight-search {
        background: linear-gradient(120deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: 600;
    }

    /* MELHORIAS DE ACESSIBILIDADE */
    .obra-draggable:focus,
    .allocation-item:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }
    
    .btn:focus {
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }
    
    /* ANIMA√á√ïES SUAVES */
    .card, .drop-zone, .btn, .badge {
        transition: all 0.2s ease;
    }
    
    .allocation-item {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* INDICADORES VISUAIS MELHORADOS */
    .status-debug {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    
    .obras-count {
        font-weight: 600;
        color: #007bff;
    }
    
    /* PERSONALIZA√á√ÉO ADICIONAL PARA TABLETS DE OBRA */
    @media (min-width: 768px) and (max-width: 1024px) {
        /* Tablet landscape otimizado */
        .drop-zone {
            min-height: 180px;
        }
        
        .obra-draggable {
            font-size: 14px;
        }
        
        .btn-group {
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .btn-group .btn {
            flex: 1;
            min-width: 120px;
        }
    }
</style>

<!-- SortableJS - CDN confi√°vel -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// CLASSE FASE 2 - FOCO EM DEBUG E CORRE√á√ïES + INTEGRA√á√ÉO COMPLETA
class EquipeFase2 {
    constructor() {
        this.obras = [];
        this.allocations = {};  // Aloca√ß√µes por dia
        this.currentWeek = null;  // Data da semana atual (segunda-feira)
        this.debugArea = document.getElementById('debug-results');
        this.statusArea = document.getElementById('status-debug');
        
        // Estado para rollback robusto
        this.operationState = {
            inProgress: false,
            originalHTML: {},
            pendingOperation: null
        };
        
        this.log('=== INICIANDO FASE 2 ===');
        this.init();
    }
    
    log(message) {
        console.log(message);
        if (this.debugArea) {
            this.debugArea.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
            this.debugArea.scrollTop = this.debugArea.scrollHeight;
        }
    }
    
    updateStatus(message, type = 'info') {
        if (this.statusArea) {
            this.statusArea.className = `alert alert-${type}`;
            this.statusArea.innerHTML = `<strong>Status:</strong> ${message}`;
        }
    }
    
    async init() {
        try {
            this.log('Verificando se SortableJS carregou...');
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå ERRO: SortableJS n√£o carregou!');
                this.updateStatus('SortableJS n√£o carregou', 'danger');
                return;
            }
            this.log('‚úÖ SortableJS carregado com sucesso');
            
            // Verificar semana da URL ou usar atual
            this.setCurrentWeekFromURL();
            
            // Atualizar interface de datas
            this.updateWeekDisplay();
            
            // Carregar dados automaticamente
            await this.testarObras();
            await this.carregarAlocacoes();
            
            this.updateStatus('Sistema inicializado - pronto para uso', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na inicializa√ß√£o: ${error.message}`);
            this.updateStatus(`Erro: ${error.message}`, 'danger');
        }
    }
    
    // M√âTODOS UTILIT√ÅRIOS PARA DATAS
    calculateCurrentWeek() {
        const today = new Date();
        const sunday = this.getSundayOfWeek(today);
        
        this.currentWeek = sunday.toISOString().split('T')[0]; // YYYY-MM-DD
        this.log(`üìÖ Semana atual (domingo): ${this.currentWeek}`);
    }
    
    getDateForDay(dayOfWeek) {
        if (!this.currentWeek) {
            this.calculateCurrentWeek();
        }
        
        const sunday = new Date(this.currentWeek);
        const targetDate = new Date(sunday);
        targetDate.setDate(sunday.getDate() + dayOfWeek);
        
        return targetDate.toISOString().split('T')[0]; // YYYY-MM-DD
    }
    
    // ===================================  
    // M√âTODOS DE NAVEGA√á√ÉO SEMANAL
    // ===================================
    
    setCurrentWeekFromURL() {
        // Verificar se h√° par√¢metro week na URL
        const urlParams = new URLSearchParams(window.location.search);
        const weekParam = urlParams.get('week');
        
        if (weekParam) {
            // Validar formato YYYY-MM-DD
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (dateRegex.test(weekParam)) {
                const date = new Date(weekParam);
                if (!isNaN(date.getTime())) {
                    // Calcular domingo da semana desta data
                    const sunday = this.getSundayOfWeek(date);
                    
                    this.currentWeek = sunday.toISOString().split('T')[0];
                    this.log(`üìÖ Semana carregada da URL: ${this.currentWeek}`);
                    return;
                }
            }
        }
        
        // Fallback para semana atual
        this.calculateCurrentWeek();
    }
    
    updateWeekDisplay() {
        if (!this.currentWeek) {
            this.calculateCurrentWeek();
        }
        
        const sunday = new Date(this.currentWeek);
        const saturday = new Date(sunday);
        saturday.setDate(sunday.getDate() + 6);
        
        // Atualizar t√≠tulo da semana
        const weekTitle = document.getElementById('week-title');
        if (weekTitle) {
            const sundayStr = this.formatDateBrazilian(sunday);
            const saturdayStr = this.formatDateBrazilian(saturday);
            weekTitle.textContent = `Semana de ${sundayStr} a ${saturdayStr}`;
        }
        
        // Atualizar cabe√ßalhos dos dias
        const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        for (let i = 0; i < 7; i++) {
            const dateElement = document.getElementById(`date-day-${i}`);
            if (dateElement) {
                const dayDate = new Date(sunday);
                dayDate.setDate(sunday.getDate() + i);
                dateElement.textContent = this.formatDateBrazilian(dayDate);
            }
        }
        
        // Destacar se √© semana atual
        this.highlightCurrentWeek();
        
        this.log(`üìÖ Interface atualizada para semana: ${this.currentWeek}`);
    }
    
    formatDateBrazilian(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return `${day}/${month}`;
    }
    
    highlightCurrentWeek() {
        const today = new Date();
        const currentSunday = this.getSundayOfWeek(today);
        const isCurrentWeek = currentSunday.toISOString().split('T')[0] === this.currentWeek;
        
        const btnCurrentWeek = document.getElementById('btn-current-week');
        if (btnCurrentWeek) {
            if (isCurrentWeek) {
                btnCurrentWeek.className = 'btn btn-secondary';
                btnCurrentWeek.textContent = 'Esta Semana';
            } else {
                btnCurrentWeek.className = 'btn btn-outline-secondary';
                btnCurrentWeek.textContent = 'Hoje';
            }
        }
        
        // Adicionar classe para semana atual nos cabe√ßalhos
        for (let i = 0; i < 7; i++) {
            const headerElement = document.getElementById(`header-day-${i}`);
            if (headerElement) {
                if (isCurrentWeek) {
                    headerElement.classList.add('text-primary');
                } else {
                    headerElement.classList.remove('text-primary');
                }
            }
        }
    }
    
    getSundayOfWeek(date) {
        const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.
        const sunday = new Date(date);
        sunday.setDate(date.getDate() - dayOfWeek); // Sunday is day 0
        return sunday;
    }
    
    async navegarSemana(direction) {
        this.log(`üóìÔ∏è Navegando semana: ${direction > 0 ? '+1' : '-1'}`);
        
        // Mostrar loading
        this.showWeekLoading(true);
        
        try {
            // Calcular nova semana
            const currentSunday = new Date(this.currentWeek);
            const newSunday = new Date(currentSunday);
            newSunday.setDate(currentSunday.getDate() + (direction * 7));
            
            this.currentWeek = newSunday.toISOString().split('T')[0];
            
            // Atualizar URL
            this.updateURL();
            
            // Atualizar interface
            this.updateWeekDisplay();
            
            // Recarregar dados
            await this.carregarAlocacoes();
            
            this.updateStatus(`Semana ${direction > 0 ? 'seguinte' : 'anterior'} carregada`, 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao navegar: ${error.message}`);
            this.updateStatus(`Erro na navega√ß√£o: ${error.message}`, 'danger');
        } finally {
            this.showWeekLoading(false);
        }
    }
    
    async irParaSemanaAtual() {
        this.log('üè† Voltando para semana atual...');
        
        // Mostrar loading
        this.showWeekLoading(true);
        
        try {
            // Calcular semana atual (domingo)
            this.calculateCurrentWeek();
            
            // Atualizar URL
            this.updateURL();
            
            // Atualizar interface
            this.updateWeekDisplay();
            
            // Recarregar dados
            await this.carregarAlocacoes();
            
            this.updateStatus('Voltou para semana atual', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao voltar para semana atual: ${error.message}`);
            this.updateStatus(`Erro: ${error.message}`, 'danger');
        } finally {
            this.showWeekLoading(false);
        }
    }
    
    showWeekLoading(show) {
        const loadingElement = document.getElementById('week-loading');
        const gridElement = document.getElementById('weekly-grid');
        
        if (loadingElement && gridElement) {
            if (show) {
                loadingElement.style.display = 'block';
                gridElement.style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
                gridElement.style.display = 'block';
            }
        }
    }
    
    updateURL() {
        // Atualizar URL sem recarregar p√°gina
        const url = new URL(window.location);
        url.searchParams.set('week', this.currentWeek);
        window.history.pushState({}, '', url);
        
        this.log(`üîó URL atualizada: ${url.toString()}`);
    }
    
    // TESTE 1: API B√ÅSICA
    async testarAPI() {
        this.log('=== TESTANDO API B√ÅSICA ===');
        
        try {
            // Teste 1: API sem autentica√ß√£o
            this.log('Testando /equipe/debug/test-direct...');
            const response1 = await fetch('/equipe/debug/test-direct');
            const data1 = await response1.json();
            this.log(`‚úÖ API direta: ${JSON.stringify(data1)}`);
            
            // Teste 2: API com autentica√ß√£o
            this.log('Testando /equipe/debug/obras-count...');
            const response2 = await fetch('/equipe/debug/obras-count');
            const data2 = await response2.json();
            this.log(`‚úÖ API obras: ${JSON.stringify(data2)}`);
            
            this.updateStatus('APIs funcionando corretamente', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na API: ${error.message}`);
            this.updateStatus(`Erro na API: ${error.message}`, 'danger');
        }
    }
    
    // TESTE 2: CARREGAMENTO DE OBRAS
    async testarObras() {
        this.log('=== TESTANDO CARREGAMENTO DE OBRAS ===');
        
        try {
            const response = await fetch('/equipe/api/obras-simples');
            const result = await response.json();
            
            this.log(`Response status: ${response.status}`);
            this.log(`Response data: ${JSON.stringify(result)}`);
            
            if (result.success && result.data) {
                this.obras = result.data;
                this.log(`‚úÖ ${this.obras.length} obras carregadas`);
                this.renderObras();
                this.updateStatus(`${this.obras.length} obras carregadas`, 'success');
            } else {
                this.log(`‚ùå Erro no resultado: ${result.error || 'Dados inv√°lidos'}`);
                this.updateStatus(`Erro: ${result.error || 'Dados inv√°lidos'}`, 'warning');
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO ao carregar obras: ${error.message}`);
            this.updateStatus(`Erro ao carregar obras: ${error.message}`, 'danger');
        }
    }
    
    renderObras() {
        const container = document.getElementById('obras-list');
        const countElement = document.getElementById('obras-count');
        
        if (!container) {
            this.log('‚ùå Container obras-list n√£o encontrado');
            return;
        }
        
        container.innerHTML = '';
        countElement.textContent = `${this.obras.length} obras encontradas`;
        countElement.className = 'obras-count';
        
        this.obras.forEach((obra, index) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 obra-draggable';
            div.dataset.obraId = obra.id;
            div.style.cursor = 'grab';
            div.setAttribute('tabindex', '0'); // Acessibilidade
            
            div.innerHTML = `
                <div class="card-body p-2">
                    <h6 class="card-title mb-1 text-primary">${obra.codigo}</h6>
                    <small class="text-muted">${obra.nome.length > 30 ? obra.nome.substring(0, 30) + '...' : obra.nome}</small>
                </div>
            `;
            
            // Adicionar tooltips com detalhes da obra
            this.addTooltipToElement(div, {
                title: `${obra.codigo} - ${obra.nome}`,
                content: `
                    <strong>C√≥digo:</strong> ${obra.codigo}<br>
                    <strong>Nome:</strong> ${obra.nome}<br>
                    <strong>ID:</strong> ${obra.id}
                `
            });
            
            container.appendChild(div);
        });
        
        this.log(`‚úÖ ${this.obras.length} obras renderizadas no DOM com tooltips`);
        
        // Configurar sistema de pesquisa ap√≥s renderizar obras
        this.setupSearchFunctionality();
        
        // Configurar drag & drop ap√≥s renderizar
        this.setupDragDrop();
    }
    
    // CARREGAR ALOCA√á√ïES EXISTENTES
    async carregarAlocacoes() {
        this.log('=== CRUD: CARREGANDO ALOCA√á√ïES EXISTENTES ===');
        
        try {
            const apiUrl = `/equipe/api/allocations-simples?week_start=${this.currentWeek}`;
            this.log(`üì° CRUD: Fazendo requisi√ß√£o para ${apiUrl}`);
            
            const response = await fetch(apiUrl);
            this.log(`üì° CRUD: Response status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                throw new Error(`API retornou ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            this.log(`üì° CRUD: Response data: ${JSON.stringify(result, null, 2).substring(0, 300)}...`);
            
            if (!result.success) {
                throw new Error(result.error || 'Erro desconhecido da API');
            }
            
            if (result.data && result.data.length > 0) {
                this.log(`‚úÖ CRUD: ${result.data.length} aloca√ß√µes encontradas`);
                
                // Renderizar aloca√ß√µes
                this.renderAlocacoes(result.data);
                
                // Aguardar renderiza√ß√£o completar, depois atualizar badges
                setTimeout(() => {
                    this.log('üîÑ CRUD: Atualizando badges de funcion√°rios...');
                    this.updateAllFuncionariosBadges();
                }, 500);
                
                this.updateStatus(`${result.data.length} aloca√ß√µes carregadas`, 'success');
            } else {
                this.log(`‚ö†Ô∏è CRUD: Nenhuma aloca√ß√£o encontrada para a semana ${this.currentWeek}`);
                this.updateStatus('Nenhuma aloca√ß√£o encontrada', 'info');
                
                // Limpar grid
                this.limparGridSemanal();
            }
            
        } catch (error) {
            this.log(`‚ùå CRUD: ERRO CR√çTICO ao carregar aloca√ß√µes - ${error.message}`);
            this.updateStatus(`Erro cr√≠tico: ${error.message}`, 'danger');
            
            // Mostrar erro no grid
            this.mostrarErroNoGrid(error.message);
        }
    }
    
    renderAlocacoes(allocationsData) {
        // Store allocations data properly
        if (allocationsData && allocationsData.length > 0) {
            // Convert array to day-based structure
            this.allocations = {};
            allocationsData.forEach(allocation => {
                // Use day_of_week from API instead of recalculating (FIXED BUG)
                const dayOfWeek = allocation.day_of_week; // 0=Sunday, already correct from backend
                if (!this.allocations[dayOfWeek]) {
                    this.allocations[dayOfWeek] = { allocations: [] };
                }
                this.allocations[dayOfWeek].allocations.push(allocation);
            });
        }
        
        if (!this.allocations) return;
        
        // Limpar todas as drop zones primeiro
        for (let i = 0; i < 7; i++) {
            const dayElement = document.getElementById(`day-${i}`);
            if (dayElement) {
                // Manter apenas elementos que n√£o s√£o aloca√ß√µes
                const existingAllocations = dayElement.querySelectorAll('.allocation-item');
                existingAllocations.forEach(item => item.remove());
            }
        }
        
        // Renderizar aloca√ß√µes por dia
        Object.keys(this.allocations).forEach(dayKey => {
            const dayData = this.allocations[dayKey];
            const dayElement = document.getElementById(`day-${dayKey}`);
            
            if (dayElement && dayData.allocations) {
                dayData.allocations.forEach(allocation => {
                    this.renderAllocationItem(dayElement, allocation, parseInt(dayKey));
                });
                
                // Remover placeholder se existir
                const placeholder = dayElement.querySelector('.text-muted');
                if (placeholder && placeholder.textContent.includes('Arraste')) {
                    placeholder.remove();
                }
            }
        });
        
        // Atualizar contadores para todos os dias
        for (let i = 0; i < 7; i++) {
            this.updateDayCounter(i);
        }
        
        // MODAL INTEGRATION: Agora usa bot√µes dedicados com stopPropagation
        // Removido addClickListenersToAllocations() para evitar conflito com drag & drop
        
        this.log(`‚úÖ Aloca√ß√µes renderizadas na interface com contadores e integra√ß√£o de modal`);
    }
    
    renderAllocationItem(container, allocation, dayOfWeek) {
        const div = document.createElement('div');
        div.className = 'card mb-2 allocation-item';
        div.dataset.obraId = allocation.obra_id;
        div.dataset.allocationId = allocation.id;
        div.style.border = '1px solid #28a745';
        div.style.backgroundColor = '#f8fff8';
        div.style.position = 'relative'; // Para posicionar o badge
        div.innerHTML = `
            <div class="card-body p-2">
                <h6 class="card-title mb-1 text-success">${allocation.obra_codigo}</h6>
                <small class="text-muted">${allocation.obra_nome.substring(0, 30)}...</small>
                <div class="mt-1 d-flex align-items-center justify-content-between">
                    <small class="badge bg-success">${allocation.turno_inicio} - ${allocation.turno_fim}</small>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary btn-funcionarios" 
                                onclick="event.stopPropagation(); window.equipeFase2.openFuncionariosModal(${allocation.id})"
                                title="Gerenciar funcion√°rios">
                            üë§
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="event.stopPropagation(); window.equipeFase2.removerAlocacaoManual(${allocation.obra_id}, ${dayOfWeek})"
                                title="Remover aloca√ß√£o">
                            ‚ùå
                        </button>
                    </div>
                </div>
                <!-- Badge contador de funcion√°rios -->
                <span class="funcionarios-badge position-absolute top-0 end-0 badge bg-info rounded-pill" 
                      style="font-size: 10px; margin: 4px;" 
                      id="badge-${allocation.id}">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </div>
        `;
        container.appendChild(div);
        
        // Carregar contador de funcion√°rios ap√≥s adicionar ao DOM
        this.loadFuncionariosCount(allocation.id);
    }
    
    // M√âTODOS DE SALVAMENTO E REMO√á√ÉO - APIs INTEGRADAS
    async salvarAlocacao(obraId, dayOfWeek) {
        this.log(`üíæ Salvando aloca√ß√£o: Obra ${obraId} no dia ${dayOfWeek}`);
        
        try {
            const data_alocacao = this.getDateForDay(dayOfWeek);
            
            const response = await fetch('/equipe/api/allocations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    obra_id: parseInt(obraId),
                    day_of_week: dayOfWeek,
                    data_alocacao: data_alocacao
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.log(`‚úÖ Aloca√ß√£o salva: ${result.message}`);
                this.updateStatus(`‚úÖ ${result.message}`, 'success');
                
                // Recarregar aloca√ß√µes para atualizar interface
                await this.carregarAlocacoes();
                
                return true;
            } else {
                this.log(`‚ùå Erro ao salvar: ${result.error}`);
                this.updateStatus(`‚ùå ${result.error}`, 'danger');
                return false;
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO CR√çTICO ao salvar: ${error.message}`);
            this.updateStatus(`‚ùå Erro ao salvar: ${error.message}`, 'danger');
            return false;
        }
    }
    
    async removerAlocacao(obraId, dayOfWeek) {
        this.log(`üóëÔ∏è Removendo aloca√ß√£o: Obra ${obraId} do dia ${dayOfWeek}`);
        
        try {
            const data_alocacao = this.getDateForDay(dayOfWeek);
            
            const response = await fetch(`/equipe/api/allocations/${obraId}/${data_alocacao}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.log(`‚úÖ Aloca√ß√£o removida: ${result.message}`);
                this.updateStatus(`‚úÖ ${result.message}`, 'info');
                
                // Recarregar aloca√ß√µes para atualizar interface
                await this.carregarAlocacoes();
                
                return true;
            } else {
                this.log(`‚ùå Erro ao remover: ${result.error}`);
                this.updateStatus(`‚ùå ${result.error}`, 'warning');
                return false;
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO CR√çTICO ao remover: ${error.message}`);
            this.updateStatus(`‚ùå Erro ao remover: ${error.message}`, 'danger');
            return false;
        }
    }
    
    // SISTEMA DE TOOLTIPS
    addTooltipToElement(element, tooltipData) {
        let tooltip = null;
        let timeoutId = null;
        
        const showTooltip = (e) => {
            // Limpar timeout anterior
            if (timeoutId) clearTimeout(timeoutId);
            
            // Remover tooltip existente
            this.hideTooltip();
            
            // Criar novo tooltip
            tooltip = document.createElement('div');
            tooltip.className = 'obra-tooltip';
            tooltip.innerHTML = tooltipData.content;
            
            document.body.appendChild(tooltip);
            
            // Posicionar tooltip
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 10;
            
            // Ajustar se sair da tela
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            
            // Mostrar com delay
            timeoutId = setTimeout(() => {
                tooltip.classList.add('show');
            }, 500);
        };
        
        const hideTooltip = () => {
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            this.hideTooltip();
        };
        
        element.addEventListener('mouseenter', showTooltip);
        element.addEventListener('mouseleave', hideTooltip);
        element.addEventListener('touchstart', showTooltip);
        element.addEventListener('touchend', hideTooltip);
    }
    
    hideTooltip() {
        const existingTooltip = document.querySelector('.obra-tooltip');
        if (existingTooltip) {
            existingTooltip.classList.remove('show');
            setTimeout(() => existingTooltip.remove(), 300);
        }
    }
    
    // M√âTODO PARA REMO√á√ÉO MANUAL (BOT√ÉO ‚ùå) - MELHORADO
    async removerAlocacaoManual(obraId, dayOfWeek) {
        this.log(`üî¥ Remo√ß√£o manual solicitada: Obra ${obraId} do dia ${dayOfWeek}`);
        
        // Buscar informa√ß√µes da obra para confirma√ß√£o melhorada
        const obra = this.obras.find(o => o.id.toString() === obraId.toString());
        const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][dayOfWeek];
        
        // Usar confirma√ß√£o melhorada
        const confirmed = await this.confirmRemoval(
            obra || {codigo: `#${obraId}`, nome: 'Obra n√£o identificada'}, 
            dayName
        );
        
        if (!confirmed) {
            this.log('‚ùå Remo√ß√£o cancelada pelo usu√°rio');
            return;
        }
        
        // Executar remo√ß√£o com feedback melhorado
        const success = await this.removerAlocacao(obraId, dayOfWeek);
        
        if (success) {
            this.showToast(`‚úÖ Obra removida do ${dayName}`, 'success', 2000);
            this.updateDayCounter(dayOfWeek);
        }
    }
    
    // TESTE 3: DRAG & DROP
    testarDragDrop() {
        this.log('=== TESTANDO DRAG & DROP ===');
        
        try {
            // Verificar se SortableJS est√° dispon√≠vel
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå SortableJS n√£o est√° carregado');
                this.updateStatus('SortableJS n√£o carregado', 'danger');
                return;
            }
            
            // Testar se obras est√£o carregadas
            if (this.obras.length === 0) {
                this.log('‚ö†Ô∏è Nenhuma obra carregada. Execute "Testar Carregamento Obras" primeiro');
                this.updateStatus('Carregue obras primeiro', 'warning');
                return;
            }
            
            this.setupDragDrop();
            this.log('‚úÖ Drag & Drop configurado com sucesso');
            this.updateStatus('Drag & Drop ativo - arraste obras para os dias', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO no Drag & Drop: ${error.message}`);
            this.updateStatus(`Erro no Drag & Drop: ${error.message}`, 'danger');
        }
    }
    
    // ====================================
    // M√âTODOS DE ROLLBACK ROBUSTO
    // ====================================
    
    captureStateForRollback(dayElement, dayIndex, operation, item) {
        this.log(`üì∑ Capturando estado original para rollback (${operation})`);
        
        this.operationState = {
            inProgress: true,
            operation: operation,
            dayIndex: dayIndex,
            dayElement: dayElement,
            originalHTML: dayElement.innerHTML,
            item: item ? item.cloneNode(true) : null,
            itemParent: item ? item.parentElement : null,
            itemNextSibling: item ? item.nextElementSibling : null
        };
    }
    
    executeRollback() {
        if (!this.operationState.inProgress) {
            this.log('‚ùå Nenhuma opera√ß√£o em progresso para rollback');
            return;
        }
        
        this.log(`‚Ü©Ô∏è Executando rollback da opera√ß√£o: ${this.operationState.operation}`);
        
        try {
            const { dayElement, originalHTML, operation, item, itemParent, itemNextSibling } = this.operationState;
            
            if (operation === 'add') {
                // Reverter adi√ß√£o: restaurar HTML original
                dayElement.innerHTML = originalHTML;
                
                // Reconfigurar sortable ap√≥s restaura√ß√£o
                if (dayElement.sortableInstance) {
                    dayElement.sortableInstance.destroy();
                    dayElement.sortableInstance = null;
                }
                
                // Reconfigurar drag & drop
                this.setupDragDropForDay(this.operationState.dayIndex);
                
            } else if (operation === 'remove') {
                // Reverter remo√ß√£o: restaurar item removido
                if (item && itemParent) {
                    if (itemNextSibling) {
                        itemParent.insertBefore(item, itemNextSibling);
                    } else {
                        itemParent.appendChild(item);
                    }
                }
            }
            
            this.updateStatus('‚Ü©Ô∏è Opera√ß√£o revertida - tente novamente', 'warning');
            this.log('‚úÖ Rollback executado com sucesso');
            
        } catch (error) {
            this.log(`‚ùå Erro durante rollback: ${error.message}`);
            this.updateStatus('‚ùå Erro cr√≠tico no rollback', 'danger');
        }
        
        this.clearRollbackState();
    }
    
    clearRollbackState() {
        this.operationState = {
            inProgress: false,
            originalHTML: {},
            pendingOperation: null
        };
    }
    
    // M√©todo auxiliar para reconfigurar drag & drop de um dia espec√≠fico
    setupDragDropForDay(dayIndex) {
        const dayElement = document.getElementById(`day-${dayIndex}`);
        if (!dayElement) return;
        
        // Destruir inst√¢ncia existente se houver
        if (dayElement.sortableInstance) {
            dayElement.sortableInstance.destroy();
            dayElement.sortableInstance = null;
        }
        
        // Recriar inst√¢ncia para este dia com handlers completos
        const i = dayIndex;
        dayElement.sortableInstance = Sortable.create(dayElement, {
            group: 'obras',
            animation: 150,
            onAdd: async (evt) => {
                const obraId = evt.item.dataset.obraId;
                const dayName = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][i];
                this.log(`üéØ Obra ${obraId} arrastada para ${dayName}!`);
                
                this.captureStateForRollback(dayElement, i, 'add', evt.item);
                this.updateStatus(`üíæ Salvando obra no ${dayName}...`, 'info');
                evt.item.style.opacity = '0.5';
                
                const success = await this.salvarAlocacao(obraId, i);
                
                if (success) {
                    this.log(`‚úÖ Obra ${obraId} salva no ${dayName}!`);
                    evt.item.remove();
                    
                    if (dayElement.querySelector('.text-muted')) {
                        const placeholder = dayElement.querySelector('.text-muted');
                        if (placeholder.textContent.includes('Drop zone')) {
                            placeholder.remove();
                        }
                    }
                    
                    this.clearRollbackState();
                } else {
                    this.log(`‚ùå Erro ao salvar obra ${obraId} no ${dayName} - executando rollback`);
                    this.executeRollback();
                }
            },
            onRemove: async (evt) => {
                const obraId = evt.item.dataset.obraId;
                const allocationId = evt.item.dataset.allocationId;
                
                if (allocationId) {
                    this.log(`üóëÔ∏è Removendo aloca√ß√£o ${allocationId} do dia ${i}`);
                    
                    this.captureStateForRollback(dayElement, i, 'remove', evt.item);
                    this.updateStatus(`üóëÔ∏è Removendo obra do dia...`, 'warning');
                    
                    const success = await this.removerAlocacao(obraId, i);
                    
                    if (!success) {
                        this.log(`‚ùå Erro ao remover - executando rollback`);
                        this.executeRollback();
                    } else {
                        this.clearRollbackState();
                    }
                } else {
                    this.log(`üì§ Item tempor√°rio removido do dia ${i}`);
                }
            }
        });
    }
    
    // VALIDA√á√ÉO INTELIGENTE: Verificar duplicatas
    isDuplicateAllocation(obraId, dayOfWeek) {
        const dayElement = document.getElementById(`day-${dayOfWeek}`);
        if (!dayElement) return false;
        
        const existingAllocations = dayElement.querySelectorAll('.allocation-item');
        for (let allocation of existingAllocations) {
            if (allocation.dataset.obraId === obraId.toString()) {
                return true;
            }
        }
        return false;
    }
    
    // TOAST SYSTEM MELHORADO
    showToast(message, type = 'info', duration = 3000) {
        // Remove toast existente se houver
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${type}`;
        
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è',
            loading: '‚è≥'
        };
        
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                <span class="toast-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Anima√ß√£o de entrada
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto-remove ap√≥s dura√ß√£o especificada
        if (duration > 0) {
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        return toast;
    }
    
    // LOADING ELEGANTE PARA OPERA√á√ïES
    showOperationLoading(dayElement, operation = 'salvando') {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'operation-loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="operation-loading-content">
                <div class="spinner-elegant"></div>
                <span>${operation}...</span>
            </div>
        `;
        
        dayElement.style.position = 'relative';
        dayElement.appendChild(loadingOverlay);
        
        return loadingOverlay;
    }
    
    hideOperationLoading(loadingOverlay) {
        if (loadingOverlay) {
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => loadingOverlay.remove(), 300);
        }
    }
    
    // CONTADOR DE OBRAS POR DIA
    updateDayCounter(dayOfWeek) {
        const dayElement = document.getElementById(`day-${dayOfWeek}`);
        const headerElement = document.getElementById(`header-day-${dayOfWeek}`);
        
        if (!dayElement || !headerElement) return;
        
        const allocationCount = dayElement.querySelectorAll('.allocation-item').length;
        
        // Remover contador existente
        const existingCounter = headerElement.querySelector('.day-counter');
        if (existingCounter) {
            existingCounter.remove();
        }
        
        // Adicionar novo contador
        if (allocationCount > 0) {
            const counter = document.createElement('div');
            counter.className = 'day-counter';
            counter.innerHTML = `<span class="badge bg-primary">${allocationCount}</span>`;
            headerElement.appendChild(counter);
        }
        
        // Atualizar indicador visual de capacidade
        this.updateCapacityIndicator(dayOfWeek, allocationCount);
    }
    
    // INDICADOR DE CAPACIDADE POR DIA
    updateCapacityIndicator(dayOfWeek, allocationCount) {
        const dayElement = document.getElementById(`day-${dayOfWeek}`);
        if (!dayElement) return;
        
        // Remove classes de capacidade existentes
        dayElement.classList.remove('capacity-low', 'capacity-medium', 'capacity-high', 'capacity-full');
        
        // Aplica classe baseada na quantidade de obras
        if (allocationCount === 0) {
            // Sem classe especial para vazio
        } else if (allocationCount <= 2) {
            dayElement.classList.add('capacity-low');
        } else if (allocationCount <= 4) {
            dayElement.classList.add('capacity-medium');
        } else if (allocationCount <= 6) {
            dayElement.classList.add('capacity-high');
        } else {
            dayElement.classList.add('capacity-full');
        }
    }
    
    // CONFIRMA√á√ÉO MELHORADA DE REMO√á√ÉO
    async confirmRemoval(obraInfo, dayName) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'removal-confirmation-modal';
            modal.innerHTML = `
                <div class="removal-confirmation-content">
                    <h5>üóëÔ∏è Confirmar Remo√ß√£o</h5>
                    <p>Deseja remover a obra <strong>${obraInfo.codigo}</strong> do <strong>${dayName}</strong>?</p>
                    <p class="text-muted">${obraInfo.nome}</p>
                    <div class="confirmation-buttons">
                        <button class="btn btn-outline-secondary" id="cancel-removal">Cancelar</button>
                        <button class="btn btn-danger" id="confirm-removal">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 100);
            
            document.getElementById('confirm-removal').onclick = () => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
                resolve(true);
            };
            
            document.getElementById('cancel-removal').onclick = () => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
                resolve(false);
            };
            
            // Fechar com ESC ou clique fora
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    setTimeout(() => modal.remove(), 300);
                    resolve(false);
                }
            };
        });
    }

    setupDragDrop() {
        this.log('Configurando SortableJS com valida√ß√µes inteligentes...');
        
        try {
            // Lista de obras (source)
            const obrasList = document.getElementById('obras-list');
            if (obrasList && !obrasList.sortableInstance) {
                obrasList.sortableInstance = Sortable.create(obrasList, {
                    group: {
                        name: 'obras',
                        pull: 'clone',
                        put: false
                    },
                    sort: false,
                    animation: 150,
                    onStart: (evt) => {
                        this.log(`üéØ Arrastando obra: ${evt.item.dataset.obraId}`);
                        
                        // Adicionar efeito visual de arraste
                        evt.item.classList.add('dragging');
                        
                        // Destacar drop zones v√°lidas
                        document.querySelectorAll('.drop-zone').forEach(zone => {
                            zone.classList.add('drop-zone-active');
                        });
                    },
                    onEnd: (evt) => {
                        // Remover efeitos visuais
                        evt.item.classList.remove('dragging');
                        document.querySelectorAll('.drop-zone').forEach(zone => {
                            zone.classList.remove('drop-zone-active', 'drop-zone-invalid');
                        });
                    }
                });
            }
            
            // Drop zones (dias da semana) - CALEND√ÅRIO COMPLETO 7 DIAS
            for (let i = 0; i < 7; i++) {
                const dayElement = document.getElementById(`day-${i}`);
                if (dayElement && !dayElement.sortableInstance) {
                    dayElement.sortableInstance = Sortable.create(dayElement, {
                        group: 'obras',
                        animation: 150,
                        onAdd: async (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const dayName = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][i];
                            
                            // VALIDA√á√ÉO INTELIGENTE: Verificar duplicata
                            if (this.isDuplicateAllocation(obraId, i)) {
                                this.log(`‚ùå Obra ${obraId} j√° est√° alocada no ${dayName}!`);
                                
                                // Feedback visual de erro
                                dayElement.classList.add('drop-zone-invalid');
                                setTimeout(() => dayElement.classList.remove('drop-zone-invalid'), 1500);
                                
                                // Toast de erro
                                this.showToast(`Obra j√° alocada neste dia!`, 'warning', 3000);
                                
                                // Remover item duplicado
                                evt.item.remove();
                                return;
                            }
                            
                            this.log(`üéØ Obra ${obraId} arrastada para ${dayName}!`);
                            
                            // Capturar estado original para rollback
                            this.captureStateForRollback(dayElement, i, 'add', evt.item);
                            
                            // Loading elegante
                            const loadingOverlay = this.showOperationLoading(dayElement, 'Salvando obra');
                            evt.item.style.opacity = '0.5';
                            
                            // Toast de loading
                            const loadingToast = this.showToast(`Salvando obra no ${dayName}...`, 'loading', 0);
                            
                            // Salvar via API
                            const success = await this.salvarAlocacao(obraId, i);
                            
                            // Remover loading
                            this.hideOperationLoading(loadingOverlay);
                            loadingToast.remove();
                            
                            if (success) {
                                this.log(`‚úÖ Obra ${obraId} salva no ${dayName}!`);
                                
                                // Toast de sucesso
                                this.showToast(`‚úÖ Obra salva no ${dayName}!`, 'success', 2000);
                                
                                // Remover o item arrastado (ser√° substitu√≠do pela renderiza√ß√£o correta)
                                evt.item.remove();
                                
                                // Limpar placeholder
                                if (dayElement.querySelector('.text-muted')) {
                                    const placeholder = dayElement.querySelector('.text-muted');
                                    if (placeholder.textContent.includes('Arraste')) {
                                        placeholder.remove();
                                    }
                                }
                                
                                // Atualizar contador
                                this.updateDayCounter(i);
                                
                                // Limpar estado de rollback
                                this.clearRollbackState();
                            } else {
                                // Erro - executar rollback
                                this.log(`‚ùå Erro ao salvar obra ${obraId} no ${dayName} - executando rollback`);
                                this.showToast(`‚ùå Erro ao salvar obra`, 'error', 3000);
                                this.executeRollback();
                            }
                        },
                        onRemove: async (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const allocationId = evt.item.dataset.allocationId;
                            
                            // Se tem allocationId, √© uma aloca√ß√£o existente sendo removida
                            if (allocationId) {
                                this.log(`üóëÔ∏è Removendo aloca√ß√£o ${allocationId} do dia ${i}`);
                                
                                // Buscar informa√ß√µes da obra para confirma√ß√£o
                                const obra = this.obras.find(o => o.id.toString() === obraId);
                                const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][i];
                                
                                // Confirma√ß√£o melhorada
                                const confirmed = await this.confirmRemoval(
                                    obra || {codigo: `#${obraId}`, nome: 'Obra n√£o identificada'}, 
                                    dayName
                                );
                                
                                if (!confirmed) {
                                    // Usu√°rio cancelou - recarregar aloca√ß√µes para restaurar
                                    await this.carregarAlocacoes();
                                    return;
                                }
                                
                                // Capturar estado original para rollback
                                this.captureStateForRollback(dayElement, i, 'remove', evt.item);
                                
                                // Loading para remo√ß√£o
                                const loadingOverlay = this.showOperationLoading(dayElement, 'Removendo obra');
                                const loadingToast = this.showToast(`Removendo obra do ${dayName}...`, 'loading', 0);
                                
                                const success = await this.removerAlocacao(obraId, i);
                                
                                // Remover loading
                                this.hideOperationLoading(loadingOverlay);
                                loadingToast.remove();
                                
                                if (!success) {
                                    // Se falhou, executar rollback
                                    this.log(`‚ùå Erro ao remover - executando rollback`);
                                    this.showToast(`‚ùå Erro ao remover obra`, 'error', 3000);
                                    this.executeRollback();
                                } else {
                                    this.showToast(`‚úÖ Obra removida do ${dayName}`, 'success', 2000);
                                    this.updateDayCounter(i);
                                    this.clearRollbackState();
                                }
                            } else {
                                this.log(`üì§ Item tempor√°rio removido do dia ${i}`);
                            }
                        }
                    });
                }
            }
            
            this.log('‚úÖ Todas as drop zones configuradas com valida√ß√µes inteligentes');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao configurar SortableJS: ${error.message}`);
            throw error;
        }
    }
    
    // ===================================
    // SISTEMA DE PESQUISA DE OBRAS
    // ===================================
    
    setupSearchFunctionality() {
        this.log('üîç Configurando sistema de pesquisa...');
        
        const searchInput = document.getElementById('search-obras');
        const clearButton = document.getElementById('clear-search');
        const resultsInfo = document.getElementById('search-results-info');
        
        if (!searchInput) {
            this.log('‚ùå Campo de pesquisa n√£o encontrado');
            return;
        }
        
        // Event listener para pesquisa em tempo real
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            
            if (searchTerm) {
                clearButton.style.display = 'block';
                this.filterObras(searchTerm);
            } else {
                clearButton.style.display = 'none';
                this.clearSearch();
            }
        });
        
        // Bot√£o de limpar pesquisa
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            clearButton.style.display = 'none';
            this.clearSearch();
            searchInput.focus();
        });
        
        // Atalho ESC para limpar pesquisa
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                searchInput.value = '';
                clearButton.style.display = 'none';
                this.clearSearch();
            }
        });
        
        // Placeholder din√¢mico com n√∫mero de obras
        this.updateSearchPlaceholder();
        
        this.log('‚úÖ Sistema de pesquisa configurado com sucesso');
    }
    
    updateSearchPlaceholder() {
        const searchInput = document.getElementById('search-obras');
        if (searchInput && this.obras.length > 0) {
            searchInput.placeholder = `Buscar entre ${this.obras.length} obras por c√≥digo ou nome...`;
        }
    }
    
    filterObras(searchTerm) {
        if (!searchTerm || this.obras.length === 0) {
            this.clearSearch();
            return;
        }
        
        this.log(`üîç Filtrando obras com termo: "${searchTerm}"`);
        
        const normalizedTerm = this.normalizeString(searchTerm);
        let filteredCount = 0;
        let totalCount = this.obras.length;
        
        // Percorrer todas as obras e aplicar filtro
        const obraElements = document.querySelectorAll('.obra-draggable');
        
        obraElements.forEach((element, index) => {
            const obra = this.obras[index];
            if (!obra) return;
            
            const normalizedCodigo = this.normalizeString(obra.codigo);
            const normalizedNome = this.normalizeString(obra.nome);
            
            // Verificar se o termo est√° no c√≥digo ou nome
            const matchesCodigo = normalizedCodigo.includes(normalizedTerm);
            const matchesNome = normalizedNome.includes(normalizedTerm);
            
            if (matchesCodigo || matchesNome) {
                // Mostrar obra
                element.classList.remove('filtered-out');
                element.classList.add('filtered-in');
                element.style.display = 'block';
                filteredCount++;
                
                // Destacar termo encontrado
                this.highlightSearchTermInElement(element, searchTerm, obra);
            } else {
                // Ocultar obra
                element.classList.remove('filtered-in');
                element.classList.add('filtered-out');
                element.style.display = 'none';
            }
        });
        
        this.updateSearchResults(filteredCount, totalCount);
        this.log(`‚úÖ Filtro aplicado: ${filteredCount}/${totalCount} obras encontradas`);
    }
    
    clearSearch() {
        this.log('üîç Limpando filtros de pesquisa...');
        
        // Mostrar todas as obras
        const obraElements = document.querySelectorAll('.obra-draggable');
        obraElements.forEach(element => {
            element.classList.remove('filtered-out', 'filtered-in');
            element.style.display = 'block';
            
            // Remover highlights
            this.removeHighlightsFromElement(element);
        });
        
        // Ocultar info de resultados
        const resultsInfo = document.getElementById('search-results-info');
        if (resultsInfo) {
            resultsInfo.style.display = 'none';
            resultsInfo.classList.remove('no-results');
        }
        
        // Ocultar placeholder de vazio
        this.hideEmptySearchResult();
        
        this.log('‚úÖ Filtros limpos - todas as obras vis√≠veis');
    }
    
    highlightSearchTermInElement(element, searchTerm, obra) {
        const titleElement = element.querySelector('.card-title');
        const nameElement = element.querySelector('small.text-muted');
        
        if (!titleElement || !nameElement) return;
        
        // Restaurar texto original
        titleElement.innerHTML = obra.codigo;
        nameElement.innerHTML = obra.nome.length > 30 ? obra.nome.substring(0, 30) + '...' : obra.nome;
        
        // Aplicar highlight
        const normalizedTerm = this.normalizeString(searchTerm);
        
        if (this.normalizeString(obra.codigo).includes(normalizedTerm)) {
            titleElement.innerHTML = this.highlightSearchTerm(obra.codigo, searchTerm);
        }
        
        if (this.normalizeString(obra.nome).includes(normalizedTerm)) {
            const displayName = obra.nome.length > 30 ? obra.nome.substring(0, 30) + '...' : obra.nome;
            nameElement.innerHTML = this.highlightSearchTerm(displayName, searchTerm);
        }
    }
    
    removeHighlightsFromElement(element) {
        const highlights = element.querySelectorAll('.highlight-search');
        highlights.forEach(highlight => {
            highlight.outerHTML = highlight.textContent;
        });
    }
    
    highlightSearchTerm(text, term) {
        if (!text || !term) return text;
        
        const normalizedText = this.normalizeString(text);
        const normalizedTerm = this.normalizeString(term);
        
        // Encontrar posi√ß√£o do termo no texto normalizado
        const startIndex = normalizedText.indexOf(normalizedTerm);
        if (startIndex === -1) return text;
        
        // Aplicar highlight preservando capitaliza√ß√£o original
        const beforeMatch = text.substring(0, startIndex);
        const match = text.substring(startIndex, startIndex + term.length);
        const afterMatch = text.substring(startIndex + term.length);
        
        return `${beforeMatch}<span class="highlight-search">${match}</span>${afterMatch}`;
    }
    
    updateSearchResults(filteredCount, totalCount) {
        const resultsInfo = document.getElementById('search-results-info');
        const filteredCountElement = document.getElementById('filtered-count');
        const totalCountElement = document.getElementById('total-count');
        
        if (resultsInfo && filteredCountElement && totalCountElement) {
            filteredCountElement.textContent = filteredCount;
            totalCountElement.textContent = totalCount;
            
            if (filteredCount === 0) {
                resultsInfo.classList.add('no-results');
                this.showEmptySearchResult();
            } else {
                resultsInfo.classList.remove('no-results');
                this.hideEmptySearchResult();
            }
            
            resultsInfo.style.display = 'block';
        }
    }
    
    showEmptySearchResult() {
        const container = document.getElementById('obras-list');
        if (!container || container.querySelector('.empty-search-result')) return;
        
        const emptyResult = document.createElement('div');
        emptyResult.className = 'empty-search-result';
        emptyResult.innerHTML = `
            <i class="fas fa-search-minus"></i>
            <p><strong>Nenhuma obra encontrada</strong></p>
            <p>Tente buscar por outro c√≥digo ou nome.</p>
        `;
        
        container.appendChild(emptyResult);
    }
    
    hideEmptySearchResult() {
        const emptyResult = document.querySelector('.empty-search-result');
        if (emptyResult) {
            emptyResult.remove();
        }
    }
    
    normalizeString(str) {
        if (!str) return '';
        return str.toString()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .trim();
    }
    
    // ===================================
    // MODAL DE FUNCION√ÅRIOS - M√âTODOS
    // ===================================
    
    /**
     * Abre o modal de funcion√°rios para uma aloca√ß√£o espec√≠fica
     */
    async openFuncionariosModal(allocationId) {
        if (!allocationId) {
            this.log('‚ùå MODAL: ID da aloca√ß√£o n√£o fornecido');
            return;
        }
        
        this.log(`üîç MODAL: Abrindo modal para aloca√ß√£o ID ${allocationId}`);
        
        // Resetar modal para estado inicial
        this.resetModal();
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('funcionariosModal'));
        modal.show();
        
        // Carregar dados da aloca√ß√£o
        await this.loadModalData(allocationId);
        
        // Configurar event listeners
        this.setupModalEventListeners(allocationId);
    }
    
    /**
     * Reseta o modal para estado inicial
     */
    resetModal() {
        // Mostrar loading, ocultar conte√∫do e erro
        document.getElementById('modal-loading').style.display = 'block';
        document.getElementById('modal-content').style.display = 'none';
        document.getElementById('modal-error').style.display = 'none';
        
        // Resetar t√≠tulo
        document.getElementById('modal-title-text').textContent = 'Carregando funcion√°rios...';
        
        // Limpar formul√°rio
        document.getElementById('select-funcionario').value = '';
        document.getElementById('input-turno-inicio').value = '08:00';
        document.getElementById('input-turno-fim').value = '17:00';
        document.getElementById('input-papel').value = '';
        
        // Limpar contadores
        document.getElementById('allocated-count').textContent = '0';
        document.getElementById('available-count').textContent = '0';
        
        this.log('üîÑ MODAL: Reset completo realizado');
    }
    
    /**
     * Carrega os dados da aloca√ß√£o via API
     */
    async loadModalData(allocationId) {
        try {
            this.log(`üì° MODAL: Carregando dados da aloca√ß√£o ${allocationId}...`);
            
            const response = await fetch(`/equipe/api/allocation/${allocationId}/funcionarios`);
            
            if (!response.ok) {
                throw new Error(`API retornou ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Erro desconhecido da API');
            }
            
            this.log(`‚úÖ MODAL: Dados carregados com sucesso`);
            
            // Armazenar dados no modal
            this.currentModalData = {
                allocationId: allocationId,
                allocation: data.allocation,
                funcionariosAlocados: data.funcionarios_alocados || [],
                funcionariosDisponiveis: data.funcionarios_disponiveis || []
            };
            
            // Renderizar dados no modal
            this.renderModalContent();
            
        } catch (error) {
            this.log(`‚ùå MODAL: Erro ao carregar dados - ${error.message}`);
            this.showModalError(error.message);
        }
    }
    
    /**
     * Renderiza o conte√∫do do modal
     */
    renderModalContent() {
        const data = this.currentModalData;
        
        // Atualizar t√≠tulo do modal
        const obraInfo = data.allocation.obra_codigo || `#${data.allocation.obra_id}`;
        const dataInfo = new Date(data.allocation.data_alocacao).toLocaleDateString('pt-BR');
        const dayName = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][new Date(data.allocation.data_alocacao).getDay()];
        
        document.getElementById('modal-title-text').textContent = `${obraInfo} - ${dayName} (${dataInfo})`;
        
        // Renderizar funcion√°rios alocados
        this.renderFuncionariosAlocados(data.funcionariosAlocados);
        
        // Renderizar funcion√°rios dispon√≠veis
        this.renderFuncionariosDisponiveis(data.funcionariosDisponiveis);
        
        // Atualizar contadores
        document.getElementById('allocated-count').textContent = data.funcionariosAlocados.length;
        document.getElementById('available-count').textContent = data.funcionariosDisponiveis.length;
        
        // Mostrar conte√∫do, ocultar loading
        document.getElementById('modal-loading').style.display = 'none';
        document.getElementById('modal-content').style.display = 'block';
        
        this.log(`‚úÖ MODAL: Conte√∫do renderizado - ${data.funcionariosAlocados.length} alocados, ${data.funcionariosDisponiveis.length} dispon√≠veis`);
    }
    
    /**
     * Renderiza lista de funcion√°rios alocados
     */
    renderFuncionariosAlocados(funcionarios) {
        const container = document.getElementById('funcionarios-alocados-list');
        
        if (!funcionarios || funcionarios.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-slash fa-2x mb-2"></i>
                    <p>Nenhum funcion√°rio alocado ainda</p>
                </div>
            `;
            return;
        }
        
        const html = funcionarios.map(func => {
            const iniciais = this.getIniciais(func.funcionario_nome);
            const avatar = this.generateAvatarColor(func.funcionario_nome);
            
            return `
                <div class="funcionario-alocado-card d-flex align-items-center" data-allocation-employee-id="${func.allocation_employee_id}">
                    <div class="funcionario-avatar" style="background: ${avatar};">
                        ${iniciais}
                    </div>
                    <div class="funcionario-info">
                        <div class="funcionario-name">${func.funcionario_nome}</div>
                        <div class="funcionario-details">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                ${func.turno_inicio} - ${func.turno_fim}
                                ${func.papel ? `<i class="fas fa-user-tag ms-2 me-1"></i>${func.papel}` : ''}
                            </small>
                        </div>
                    </div>
                    <div class="funcionario-actions">
                        <button class="btn btn-outline-danger btn-sm btn-remove-funcionario" 
                                onclick="window.equipeFase2.removeFuncionario(${func.allocation_employee_id})"
                                title="Remover funcion√°rio">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
    
    /**
     * Renderiza lista de funcion√°rios dispon√≠veis
     */
    renderFuncionariosDisponiveis(funcionarios) {
        const container = document.getElementById('funcionarios-disponiveis-list');
        const selectElement = document.getElementById('select-funcionario');
        
        // Limpar e popular select
        selectElement.innerHTML = '<option value="">Selecione...</option>';
        
        if (!funcionarios || funcionarios.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-users-slash fa-2x mb-2"></i>
                        <p>Nenhum funcion√°rio dispon√≠vel</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Renderizar cards
        const cardsHtml = funcionarios.map(func => {
            const iniciais = this.getIniciais(func.nome);
            const avatar = this.generateAvatarColor(func.nome);
            
            return `
                <div class="col-md-3 col-sm-4 col-6 mb-2">
                    <div class="funcionario-disponivel-card" onclick="window.equipeFase2.selectFuncionario(${func.id})">
                        <div class="funcionario-avatar" style="background: ${avatar};">
                            ${iniciais}
                        </div>
                        <div class="funcionario-name">${func.nome}</div>
                        <small class="text-muted">${func.funcao || 'Sem fun√ß√£o'}</small>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = cardsHtml;
        
        // Popular select
        funcionarios.forEach(func => {
            const option = document.createElement('option');
            option.value = func.id;
            option.textContent = `${func.nome} ${func.funcao ? '(' + func.funcao + ')' : ''}`;
            selectElement.appendChild(option);
        });
    }
    
    /**
     * Configura event listeners do modal
     */
    setupModalEventListeners(allocationId) {
        // Remover listeners anteriores para evitar duplica√ß√£o
        const addBtn = document.getElementById('btn-add-funcionario');
        const newAddBtn = addBtn.cloneNode(true);
        addBtn.parentNode.replaceChild(newAddBtn, addBtn);
        
        // Adicionar novo listener
        newAddBtn.addEventListener('click', () => {
            this.addFuncionario(allocationId);
        });
        
        this.log(`‚úÖ MODAL: Event listeners configurados para aloca√ß√£o ${allocationId}`);
    }
    
    /**
     * Adiciona funcion√°rio via API - VERS√ÉO COM LOGS DETALHADOS
     */
    async addFuncionario(allocationId) {
        const funcionarioId = document.getElementById('select-funcionario').value;
        const turnoInicio = document.getElementById('input-turno-inicio').value;
        const turnoFim = document.getElementById('input-turno-fim').value;
        const papel = document.getElementById('input-papel').value.trim();
        
        this.log(`‚ûï CRUD: Iniciando adi√ß√£o de funcion√°rio - aloca√ß√£o ${allocationId}`);
        this.log(`üìù CRUD: Dados do formul√°rio - funcionarioId: ${funcionarioId}, turno: ${turnoInicio}-${turnoFim}, papel: '${papel}'`);
        
        // Valida√ß√µes detalhadas
        if (!funcionarioId) {
            this.log(`‚ùå CRUD: Valida√ß√£o falhou - nenhum funcion√°rio selecionado`);
            this.showToast('Selecione um funcion√°rio', 'warning', 3000);
            return;
        }
        
        if (!turnoInicio || !turnoFim) {
            this.log(`‚ùå CRUD: Valida√ß√£o falhou - hor√°rios incompletos (in√≠cio: ${turnoInicio}, fim: ${turnoFim})`);
            this.showToast('Preencha os hor√°rios', 'warning', 3000);
            return;
        }
        
        // Validar se hor√°rio fim √© ap√≥s hor√°rio in√≠cio
        if (turnoFim <= turnoInicio) {
            this.log(`‚ùå CRUD: Valida√ß√£o falhou - hor√°rio fim (${turnoFim}) n√£o √© posterior ao in√≠cio (${turnoInicio})`);
            this.showToast('Hor√°rio de fim deve ser ap√≥s hor√°rio de in√≠cio', 'warning', 3000);
            return;
        }
        
        this.log(`‚úÖ CRUD: Valida√ß√µes aprovadas - prosseguindo com requisi√ß√£o`);
        
        // Declarar vari√°veis antes do try/catch para que fiquem acess√≠veis em todos os blocos
        let originalHtml = '';
        
        try {
            // Mostrar loading no bot√£o
            const addBtn = document.getElementById('btn-add-funcionario');
            originalHtml = addBtn.innerHTML; // Remover 'const' pois j√° foi declarado acima
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';
            addBtn.disabled = true;
            
            const payload = {
                allocation_id: parseInt(allocationId),
                funcionario_id: parseInt(funcionarioId),
                turno_inicio: turnoInicio,
                turno_fim: turnoFim,
                papel: papel
            };
            
            this.log(`üì° CRUD: Enviando POST para /equipe/api/allocation-employee`);
            this.log(`üì° CRUD: Payload: ${JSON.stringify(payload, null, 2)}`);
            
            const response = await fetch('/equipe/api/allocation-employee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            this.log(`üì° CRUD: Response status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                const errorData = await response.json();
                this.log(`‚ùå CRUD: API retornou erro: ${JSON.stringify(errorData, null, 2)}`);
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            this.log(`üì° CRUD: Response data: ${JSON.stringify(data, null, 2)}`);
            
            if (!data.success) {
                throw new Error(data.error || 'Erro desconhecido');
            }
            
            this.log(`‚úÖ CRUD: Funcion√°rio adicionado com sucesso!`);
            this.log(`üë§ CRUD: Funcion√°rio criado: ${data.funcionario_nome || 'Nome n√£o retornado'}`);
            
            this.showToast(`‚úÖ ${data.funcionario_nome || 'Funcion√°rio'} adicionado!`, 'success', 2000);
            
            // Recarregar dados do modal
            this.log(`üîÑ CRUD: Recarregando dados do modal...`);
            await this.loadModalData(allocationId);
            
            // Atualizar calend√°rio principal
            this.log(`üîÑ CRUD: Atualizando calend√°rio principal...`);
            await this.carregarAlocacoes();
            
            this.log(`‚úÖ CRUD: Opera√ß√£o de adi√ß√£o conclu√≠da com sucesso`);
            
        } catch (error) {
            this.log(`‚ùå CRUD: ERRO CR√çTICO ao adicionar funcion√°rio - ${error.message}`);
            this.showToast(`‚ùå Erro: ${error.message}`, 'error', 4000);
        } finally {
            // Restaurar bot√£o
            const addBtn = document.getElementById('btn-add-funcionario');
            if (addBtn) {
                addBtn.innerHTML = originalHtml;
                addBtn.disabled = false;
            }
            this.log(`üîß CRUD: Bot√£o de adi√ß√£o restaurado`);
        }
    }
    
    /**
     * Remove funcion√°rio via API - VERS√ÉO COM LOGS DETALHADOS
     */
    async removeFuncionario(allocationEmployeeId) {
        this.log(`üóëÔ∏è CRUD: Iniciando remo√ß√£o de funcion√°rio - allocation_employee_id: ${allocationEmployeeId}`);
        
        if (!confirm('Remover este funcion√°rio da aloca√ß√£o?')) {
            this.log(`‚ùå CRUD: Remo√ß√£o cancelada pelo usu√°rio`);
            return;
        }
        
        try {
            this.log(`üì° CRUD: Enviando DELETE para /equipe/api/allocation-employee/${allocationEmployeeId}`);
            
            const response = await fetch(`/equipe/api/allocation-employee/${allocationEmployeeId}`, {
                method: 'DELETE'
            });
            
            this.log(`üì° CRUD: Response status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                const errorData = await response.json();
                this.log(`‚ùå CRUD: API retornou erro: ${JSON.stringify(errorData, null, 2)}`);
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            this.log(`üì° CRUD: Response data: ${JSON.stringify(data, null, 2)}`);
            
            if (!data.success) {
                throw new Error(data.error || 'Erro desconhecido');
            }
            
            this.log(`‚úÖ CRUD: Funcion√°rio removido com sucesso!`);
            this.log(`üë§ CRUD: Funcion√°rio removido: ${data.funcionario_nome || 'Nome n√£o retornado'}`);
            
            this.showToast(`‚úÖ ${data.funcionario_nome || 'Funcion√°rio'} removido!`, 'success', 2000);
            
            // Recarregar dados do modal
            this.log(`üîÑ CRUD: Recarregando dados do modal...`);
            await this.loadModalData(this.currentModalData.allocationId);
            
            // Atualizar calend√°rio principal
            this.log(`üîÑ CRUD: Atualizando calend√°rio principal...`);
            await this.carregarAlocacoes();
            
            this.log(`‚úÖ CRUD: Opera√ß√£o de remo√ß√£o conclu√≠da com sucesso`);
            
        } catch (error) {
            this.log(`‚ùå CRUD: ERRO CR√çTICO ao remover funcion√°rio - ${error.message}`);
            this.showToast(`‚ùå Erro: ${error.message}`, 'error', 4000);
        }
    }
    
    /**
     * FUN√á√ïES AUXILIARES PARA GRID
     */
    limparGridSemanal() {
        this.log('üßπ GRID: Limpando grid semanal...');
        
        for (let i = 0; i < 7; i++) {
            const dayElement = document.getElementById(`day-${i}`);
            if (dayElement) {
                dayElement.innerHTML = '<small class="text-muted">Arraste obras aqui</small>';
            }
        }
        
        this.log('‚úÖ GRID: Grid semanal limpo');
    }
    
    mostrarErroNoGrid(errorMessage) {
        this.log(`‚ùå GRID: Mostrando erro no grid - ${errorMessage}`);
        
        for (let i = 0; i < 7; i++) {
            const dayElement = document.getElementById(`day-${i}`);
            if (dayElement) {
                dayElement.innerHTML = `
                    <div class="text-center text-danger p-3">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Erro ao carregar dados</p>
                        <small>${errorMessage}</small>
                    </div>
                `;
            }
        }
    }
    
    /**
     * Seleciona funcion√°rio no formul√°rio (clique no card)
     */
    selectFuncionario(funcionarioId) {
        const selectElement = document.getElementById('select-funcionario');
        selectElement.value = funcionarioId;
        
        // Highlight visual tempor√°rio
        const card = event.target.closest('.funcionario-disponivel-card');
        if (card) {
            card.style.transform = 'scale(0.95)';
            setTimeout(() => {
                card.style.transform = '';
            }, 200);
        }
        
        this.log(`üëÜ MODAL: Funcion√°rio ${funcionarioId} selecionado`);
    }
    
    /**
     * Recarrega dados do modal
     */
    async reloadModal() {
        if (this.currentModalData) {
            await this.loadModalData(this.currentModalData.allocationId);
        }
    }
    
    /**
     * Mostra erro no modal
     */
    showModalError(message) {
        document.getElementById('modal-loading').style.display = 'none';
        document.getElementById('modal-content').style.display = 'none';
        document.getElementById('modal-error').style.display = 'block';
        document.getElementById('modal-error-message').textContent = message;
    }
    
    /**
     * Gera iniciais do nome
     */
    getIniciais(nome) {
        if (!nome) return '??';
        const parts = nome.trim().split(' ');
        if (parts.length === 1) {
            return parts[0].substring(0, 2).toUpperCase();
        }
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }
    
    /**
     * Gera cor do avatar baseada no nome
     */
    generateAvatarColor(nome) {
        if (!nome) return '#6c757d';
        
        const colors = [
            '#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8',
            '#6610f2', '#e83e8c', '#fd7e14', '#20c997', '#6f42c1'
        ];
        
        let hash = 0;
        for (let i = 0; i < nome.length; i++) {
            hash = nome.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const index = Math.abs(hash) % colors.length;
        return colors[index];
    }
    
    // ===================================
    // INTEGRA√á√ÉO COM DRAG & DROP EXISTENTE
    // ===================================
    
    /**
     * Carrega contador de funcion√°rios para uma aloca√ß√£o espec√≠fica - VERS√ÉO MELHORADA
     */
    async loadFuncionariosCount(allocationId) {
        try {
            this.log(`üîÑ BADGE: Carregando contador para aloca√ß√£o ${allocationId}...`);
            
            const response = await fetch(`/equipe/api/allocation/${allocationId}/funcionarios`);
            
            if (!response.ok) {
                throw new Error(`API retornou ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Erro desconhecido da API');
            }
            
            const count = data.total_alocados || 0;
            const badgeElement = document.getElementById(`badge-${allocationId}`);
            
            if (badgeElement) {
                if (count > 0) {
                    badgeElement.innerHTML = `<i class="fas fa-user me-1"></i>${count}`;
                    badgeElement.className = 'funcionarios-badge position-absolute top-0 end-0 badge bg-success rounded-pill';
                    badgeElement.style.fontSize = '10px';
                    badgeElement.style.cursor = 'pointer';
                    badgeElement.title = `${count} funcion√°rio${count > 1 ? 's' : ''} alocado${count > 1 ? 's' : ''} - Clique para gerenciar`;
                    
                    // Adicionar click listener para abrir modal
                    badgeElement.onclick = (e) => {
                        e.stopPropagation();
                        this.openFuncionariosModal(allocationId);
                    };
                } else {
                    badgeElement.innerHTML = '0';
                    badgeElement.className = 'funcionarios-badge position-absolute top-0 end-0 badge bg-secondary rounded-pill';
                    badgeElement.style.fontSize = '10px';
                    badgeElement.style.cursor = 'pointer';
                    badgeElement.title = 'Nenhum funcion√°rio alocado - Clique para adicionar';
                    
                    // Click listener para adicionar funcion√°rio
                    badgeElement.onclick = (e) => {
                        e.stopPropagation();
                        this.openFuncionariosModal(allocationId);
                    };
                }
            }
            
            this.log(`‚úÖ BADGE: Contador atualizado - Aloca√ß√£o ${allocationId} tem ${count} funcion√°rio${count !== 1 ? 's' : ''}`);
            
        } catch (error) {
            this.log(`‚ùå BADGE: Erro ao carregar contador para aloca√ß√£o ${allocationId} - ${error.message}`);
            const badgeElement = document.getElementById(`badge-${allocationId}`);
            if (badgeElement) {
                badgeElement.innerHTML = '‚ö†Ô∏è';
                badgeElement.className = 'funcionarios-badge position-absolute top-0 end-0 badge bg-warning rounded-pill';
                badgeElement.style.fontSize = '10px';
                badgeElement.title = `Erro ao carregar contador: ${error.message}`;
            }
        }
    }
    
    /**
     * Atualiza todos os badges de funcion√°rios na tela atual
     */
    async updateAllFuncionariosBadges() {
        this.log('üîÑ BADGE: Atualizando todos os contadores de funcion√°rios...');
        
        const allocationItems = document.querySelectorAll('.allocation-item[data-allocation-id]');
        const promises = [];
        
        allocationItems.forEach(item => {
            const allocationId = item.dataset.allocationId;
            if (allocationId) {
                promises.push(this.loadFuncionariosCount(allocationId));
            }
        });
        
        try {
            await Promise.all(promises);
            this.log(`‚úÖ BADGE: ${promises.length} contadores atualizados com sucesso`);
        } catch (error) {
            this.log(`‚ö†Ô∏è BADGE: Alguns contadores falharam ao atualizar: ${error.message}`);
        }
    }
    
    /**
     * REMOVIDO: addClickListenersToAllocations()
     * Substitu√≠do por bot√µes dedicados com stopPropagation para evitar conflito com drag & drop
     */
}

// ===================================
// FUN√á√ïES GLOBAIS PARA OS BOT√ïES
// ===================================

function testarAPI() {
    if (window.equipeFase2) {
        window.equipeFase2.testarAPI();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarObras() {
    if (window.equipeFase2) {
        window.equipeFase2.testarObras();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarDragDrop() {
    if (window.equipeFase2) {
        window.equipeFase2.testarDragDrop();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

// ===================================
// INICIALIZA√á√ÉO AUTOM√ÅTICA
// ===================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM loaded - Inicializando FASE 2...');
    window.equipeFase2 = new EquipeFase2();
});

console.log('üìú Script FASE 2 carregado - Aguardando DOM...');
</script>
{% endblock %}