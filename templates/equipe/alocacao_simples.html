{% extends "base_completo.html" %}

{% block title %}Gest√£o de Equipe - FASE 2{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3>üìã Gest√£o de Equipe - FASE 2 CORRE√á√ïES</h3>
    <p class="text-muted">Implementa√ß√£o gradual - "FUNCIONA PRIMEIRO, OTIMIZA DEPOIS"</p>
    
    <!-- STATUS DE DEBUG -->
    <div class="alert alert-info" id="status-debug">
        <strong>Status:</strong> Carregando sistema...
    </div>
    
    <div class="row">
        <!-- SIDEBAR: OBRAS -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>üèóÔ∏è Obras Dispon√≠veis</h5>
                    <small id="obras-count">Carregando...</small>
                </div>
                <div class="card-body">
                    <div id="obras-list" style="min-height: 300px;">
                        <div class="text-center text-muted p-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Carregando obras...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GRID SEMANAL -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5>üìÖ Semana - FASE 2</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- SEGUNDA -->
                        <div class="col">
                            <h6 class="text-center">Segunda</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="0" 
                                 id="day-0">
                                <small class="text-muted">Drop zone Segunda</small>
                            </div>
                        </div>
                        
                        <!-- TER√áA -->
                        <div class="col">
                            <h6 class="text-center">Ter√ßa</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="1" 
                                 id="day-1">
                                <small class="text-muted">Drop zone Ter√ßa</small>
                            </div>
                        </div>
                        
                        <!-- QUARTA -->
                        <div class="col">
                            <h6 class="text-center">Quarta</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="2" 
                                 id="day-2">
                                <small class="text-muted">Drop zone Quarta</small>
                            </div>
                        </div>
                        
                        <!-- QUINTA -->
                        <div class="col">
                            <h6 class="text-center">Quinta</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="3" 
                                 id="day-3">
                                <small class="text-muted">Drop zone Quinta</small>
                            </div>
                        </div>
                        
                        <!-- SEXTA -->
                        <div class="col">
                            <h6 class="text-center">Sexta</h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="4" 
                                 id="day-4">
                                <small class="text-muted">Drop zone Sexta</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PAINEL DE DEBUG MELHORADO -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>üîç FASE 2 - DEBUG E TESTE</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-info w-100" onclick="testarAPI()">
                        üîç Testar API B√°sica
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="testarObras()">
                        üèóÔ∏è Testar Carregamento Obras
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" onclick="testarDragDrop()">
                        üéØ Testar Drag & Drop
                    </button>
                </div>
            </div>
            
            <!-- √ÅREA DE RESULTADOS -->
            <div class="mt-3">
                <h6>Resultados dos Testes:</h6>
                <div id="debug-results" class="border rounded p-3" style="background: #f8f9fa; min-height: 100px; font-family: monospace; font-size: 0.9rem;">
                    Clique nos bot√µes acima para testar...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SortableJS - CDN confi√°vel -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// CLASSE FASE 2 - FOCO EM DEBUG E CORRE√á√ïES + INTEGRA√á√ÉO COMPLETA
class EquipeFase2 {
    constructor() {
        this.obras = [];
        this.allocations = {};  // Aloca√ß√µes por dia
        this.currentWeek = null;  // Data da semana atual (segunda-feira)
        this.debugArea = document.getElementById('debug-results');
        this.statusArea = document.getElementById('status-debug');
        
        // Estado para rollback robusto
        this.operationState = {
            inProgress: false,
            originalHTML: {},
            pendingOperation: null
        };
        
        this.log('=== INICIANDO FASE 2 ===');
        this.init();
    }
    
    log(message) {
        console.log(message);
        if (this.debugArea) {
            this.debugArea.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
            this.debugArea.scrollTop = this.debugArea.scrollHeight;
        }
    }
    
    updateStatus(message, type = 'info') {
        if (this.statusArea) {
            this.statusArea.className = `alert alert-${type}`;
            this.statusArea.innerHTML = `<strong>Status:</strong> ${message}`;
        }
    }
    
    async init() {
        try {
            this.log('Verificando se SortableJS carregou...');
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå ERRO: SortableJS n√£o carregou!');
                this.updateStatus('SortableJS n√£o carregou', 'danger');
                return;
            }
            this.log('‚úÖ SortableJS carregado com sucesso');
            
            // Calcular semana atual
            this.calculateCurrentWeek();
            
            // Carregar dados automaticamente
            await this.testarObras();
            await this.carregarAlocacoes();
            
            this.updateStatus('Sistema inicializado - pronto para uso', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na inicializa√ß√£o: ${error.message}`);
            this.updateStatus(`Erro: ${error.message}`, 'danger');
        }
    }
    
    // M√âTODOS UTILIT√ÅRIOS PARA DATAS
    calculateCurrentWeek() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0=Domingo, 1=Segunda, etc.
        const monday = new Date(today);
        
        // Calcular segunda-feira
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        monday.setDate(today.getDate() - daysToSubtract);
        
        this.currentWeek = monday.toISOString().split('T')[0]; // YYYY-MM-DD
        this.log(`üìÖ Semana atual: ${this.currentWeek}`);
    }
    
    getDateForDay(dayOfWeek) {
        if (!this.currentWeek) {
            this.calculateCurrentWeek();
        }
        
        const monday = new Date(this.currentWeek);
        const targetDate = new Date(monday);
        targetDate.setDate(monday.getDate() + dayOfWeek);
        
        return targetDate.toISOString().split('T')[0]; // YYYY-MM-DD
    }
    
    // TESTE 1: API B√ÅSICA
    async testarAPI() {
        this.log('=== TESTANDO API B√ÅSICA ===');
        
        try {
            // Teste 1: API sem autentica√ß√£o
            this.log('Testando /equipe/debug/test-direct...');
            const response1 = await fetch('/equipe/debug/test-direct');
            const data1 = await response1.json();
            this.log(`‚úÖ API direta: ${JSON.stringify(data1)}`);
            
            // Teste 2: API com autentica√ß√£o
            this.log('Testando /equipe/debug/obras-count...');
            const response2 = await fetch('/equipe/debug/obras-count');
            const data2 = await response2.json();
            this.log(`‚úÖ API obras: ${JSON.stringify(data2)}`);
            
            this.updateStatus('APIs funcionando corretamente', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na API: ${error.message}`);
            this.updateStatus(`Erro na API: ${error.message}`, 'danger');
        }
    }
    
    // TESTE 2: CARREGAMENTO DE OBRAS
    async testarObras() {
        this.log('=== TESTANDO CARREGAMENTO DE OBRAS ===');
        
        try {
            const response = await fetch('/equipe/api/obras-simples');
            const result = await response.json();
            
            this.log(`Response status: ${response.status}`);
            this.log(`Response data: ${JSON.stringify(result)}`);
            
            if (result.success && result.data) {
                this.obras = result.data;
                this.log(`‚úÖ ${this.obras.length} obras carregadas`);
                this.renderObras();
                this.updateStatus(`${this.obras.length} obras carregadas`, 'success');
            } else {
                this.log(`‚ùå Erro no resultado: ${result.error || 'Dados inv√°lidos'}`);
                this.updateStatus(`Erro: ${result.error || 'Dados inv√°lidos'}`, 'warning');
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO ao carregar obras: ${error.message}`);
            this.updateStatus(`Erro ao carregar obras: ${error.message}`, 'danger');
        }
    }
    
    renderObras() {
        const container = document.getElementById('obras-list');
        const countElement = document.getElementById('obras-count');
        
        if (!container) {
            this.log('‚ùå Container obras-list n√£o encontrado');
            return;
        }
        
        container.innerHTML = '';
        countElement.textContent = `${this.obras.length} obras encontradas`;
        
        this.obras.forEach((obra, index) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 obra-draggable';
            div.dataset.obraId = obra.id;
            div.style.cursor = 'grab';
            div.innerHTML = `
                <div class="card-body p-2">
                    <h6 class="card-title mb-1 text-primary">${obra.codigo}</h6>
                    <small class="text-muted">${obra.nome}</small>
                </div>
            `;
            container.appendChild(div);
        });
        
        this.log(`‚úÖ ${this.obras.length} obras renderizadas no DOM`);
        
        // Configurar drag & drop ap√≥s renderizar
        this.setupDragDrop();
    }
    
    // CARREGAR ALOCA√á√ïES EXISTENTES
    async carregarAlocacoes() {
        this.log('=== CARREGANDO ALOCA√á√ïES EXISTENTES ===');
        
        try {
            const response = await fetch(`/equipe/api/allocations-week?week=${this.currentWeek}`);
            const result = await response.json();
            
            this.log(`Response status: ${response.status}`);
            this.log(`Response data: ${JSON.stringify(result).substring(0, 200)}...`);
            
            if (result.success && result.data) {
                this.allocations = result.data;
                this.renderAlocacoes();
                this.log(`‚úÖ Aloca√ß√µes carregadas para semana ${result.week_start}`);
            } else {
                this.log(`‚ö†Ô∏è Nenhuma aloca√ß√£o encontrada: ${result.error || 'Dados vazios'}`);
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO ao carregar aloca√ß√µes: ${error.message}`);
        }
    }
    
    renderAlocacoes() {
        if (!this.allocations) return;
        
        // Limpar todas as drop zones primeiro
        for (let i = 0; i < 5; i++) {
            const dayElement = document.getElementById(`day-${i}`);
            if (dayElement) {
                // Manter apenas elementos que n√£o s√£o aloca√ß√µes
                const existingAllocations = dayElement.querySelectorAll('.allocation-item');
                existingAllocations.forEach(item => item.remove());
            }
        }
        
        // Renderizar aloca√ß√µes por dia
        Object.keys(this.allocations).forEach(dayKey => {
            const dayData = this.allocations[dayKey];
            const dayElement = document.getElementById(`day-${dayKey}`);
            
            if (dayElement && dayData.allocations) {
                dayData.allocations.forEach(allocation => {
                    this.renderAllocationItem(dayElement, allocation, parseInt(dayKey));
                });
                
                // Remover placeholder se existir
                const placeholder = dayElement.querySelector('.text-muted');
                if (placeholder && placeholder.textContent.includes('Drop zone')) {
                    placeholder.remove();
                }
            }
        });
        
        this.log(`‚úÖ Aloca√ß√µes renderizadas na interface`);
    }
    
    renderAllocationItem(container, allocation, dayOfWeek) {
        const div = document.createElement('div');
        div.className = 'card mb-2 allocation-item';
        div.dataset.obraId = allocation.obra_id;
        div.dataset.allocationId = allocation.id;
        div.style.border = '1px solid #28a745';
        div.style.backgroundColor = '#f8fff8';
        div.innerHTML = `
            <div class="card-body p-2">
                <h6 class="card-title mb-1 text-success">${allocation.obra_codigo}</h6>
                <small class="text-muted">${allocation.obra_nome.substring(0, 30)}...</small>
                <div class="mt-1">
                    <small class="badge bg-success">${allocation.turno_inicio} - ${allocation.turno_fim}</small>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="window.equipeFase2.removerAlocacaoManual(${allocation.obra_id}, ${dayOfWeek})">
                        ‚ùå
                    </button>
                </div>
            </div>
        `;
        container.appendChild(div);
    }
    
    // M√âTODOS DE SALVAMENTO E REMO√á√ÉO - APIs INTEGRADAS
    async salvarAlocacao(obraId, dayOfWeek) {
        this.log(`üíæ Salvando aloca√ß√£o: Obra ${obraId} no dia ${dayOfWeek}`);
        
        try {
            const data_alocacao = this.getDateForDay(dayOfWeek);
            
            const response = await fetch('/equipe/api/allocations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    obra_id: parseInt(obraId),
                    day_of_week: dayOfWeek,
                    data_alocacao: data_alocacao
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.log(`‚úÖ Aloca√ß√£o salva: ${result.message}`);
                this.updateStatus(`‚úÖ ${result.message}`, 'success');
                
                // Recarregar aloca√ß√µes para atualizar interface
                await this.carregarAlocacoes();
                
                return true;
            } else {
                this.log(`‚ùå Erro ao salvar: ${result.error}`);
                this.updateStatus(`‚ùå ${result.error}`, 'danger');
                return false;
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO CR√çTICO ao salvar: ${error.message}`);
            this.updateStatus(`‚ùå Erro ao salvar: ${error.message}`, 'danger');
            return false;
        }
    }
    
    async removerAlocacao(obraId, dayOfWeek) {
        this.log(`üóëÔ∏è Removendo aloca√ß√£o: Obra ${obraId} do dia ${dayOfWeek}`);
        
        try {
            const data_alocacao = this.getDateForDay(dayOfWeek);
            
            const response = await fetch(`/equipe/api/allocations/${obraId}/${data_alocacao}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.log(`‚úÖ Aloca√ß√£o removida: ${result.message}`);
                this.updateStatus(`‚úÖ ${result.message}`, 'info');
                
                // Recarregar aloca√ß√µes para atualizar interface
                await this.carregarAlocacoes();
                
                return true;
            } else {
                this.log(`‚ùå Erro ao remover: ${result.error}`);
                this.updateStatus(`‚ùå ${result.error}`, 'warning');
                return false;
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO CR√çTICO ao remover: ${error.message}`);
            this.updateStatus(`‚ùå Erro ao remover: ${error.message}`, 'danger');
            return false;
        }
    }
    
    // M√âTODO PARA REMO√á√ÉO MANUAL (BOT√ÉO ‚ùå)
    async removerAlocacaoManual(obraId, dayOfWeek) {
        this.log(`üî¥ Remo√ß√£o manual solicitada: Obra ${obraId} do dia ${dayOfWeek}`);
        
        // Confirmar a√ß√£o
        const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][dayOfWeek];
        if (!confirm(`Deseja remover esta obra do ${dayName}?`)) {
            this.log('‚ùå Remo√ß√£o cancelada pelo usu√°rio');
            return;
        }
        
        await this.removerAlocacao(obraId, dayOfWeek);
    }
    
    // TESTE 3: DRAG & DROP
    testarDragDrop() {
        this.log('=== TESTANDO DRAG & DROP ===');
        
        try {
            // Verificar se SortableJS est√° dispon√≠vel
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå SortableJS n√£o est√° carregado');
                this.updateStatus('SortableJS n√£o carregado', 'danger');
                return;
            }
            
            // Testar se obras est√£o carregadas
            if (this.obras.length === 0) {
                this.log('‚ö†Ô∏è Nenhuma obra carregada. Execute "Testar Carregamento Obras" primeiro');
                this.updateStatus('Carregue obras primeiro', 'warning');
                return;
            }
            
            this.setupDragDrop();
            this.log('‚úÖ Drag & Drop configurado com sucesso');
            this.updateStatus('Drag & Drop ativo - arraste obras para os dias', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO no Drag & Drop: ${error.message}`);
            this.updateStatus(`Erro no Drag & Drop: ${error.message}`, 'danger');
        }
    }
    
    // ====================================
    // M√âTODOS DE ROLLBACK ROBUSTO
    // ====================================
    
    captureStateForRollback(dayElement, dayIndex, operation, item) {
        this.log(`üì∑ Capturando estado original para rollback (${operation})`);
        
        this.operationState = {
            inProgress: true,
            operation: operation,
            dayIndex: dayIndex,
            dayElement: dayElement,
            originalHTML: dayElement.innerHTML,
            item: item ? item.cloneNode(true) : null,
            itemParent: item ? item.parentElement : null,
            itemNextSibling: item ? item.nextElementSibling : null
        };
    }
    
    executeRollback() {
        if (!this.operationState.inProgress) {
            this.log('‚ùå Nenhuma opera√ß√£o em progresso para rollback');
            return;
        }
        
        this.log(`‚Ü©Ô∏è Executando rollback da opera√ß√£o: ${this.operationState.operation}`);
        
        try {
            const { dayElement, originalHTML, operation, item, itemParent, itemNextSibling } = this.operationState;
            
            if (operation === 'add') {
                // Reverter adi√ß√£o: restaurar HTML original
                dayElement.innerHTML = originalHTML;
                
                // Reconfigurar sortable ap√≥s restaura√ß√£o
                if (dayElement.sortableInstance) {
                    dayElement.sortableInstance.destroy();
                    dayElement.sortableInstance = null;
                }
                
                // Reconfigurar drag & drop
                this.setupDragDropForDay(this.operationState.dayIndex);
                
            } else if (operation === 'remove') {
                // Reverter remo√ß√£o: restaurar item removido
                if (item && itemParent) {
                    if (itemNextSibling) {
                        itemParent.insertBefore(item, itemNextSibling);
                    } else {
                        itemParent.appendChild(item);
                    }
                }
            }
            
            this.updateStatus('‚Ü©Ô∏è Opera√ß√£o revertida - tente novamente', 'warning');
            this.log('‚úÖ Rollback executado com sucesso');
            
        } catch (error) {
            this.log(`‚ùå Erro durante rollback: ${error.message}`);
            this.updateStatus('‚ùå Erro cr√≠tico no rollback', 'danger');
        }
        
        this.clearRollbackState();
    }
    
    clearRollbackState() {
        this.operationState = {
            inProgress: false,
            originalHTML: {},
            pendingOperation: null
        };
    }
    
    // M√©todo auxiliar para reconfigurar drag & drop de um dia espec√≠fico
    setupDragDropForDay(dayIndex) {
        const dayElement = document.getElementById(`day-${dayIndex}`);
        if (!dayElement) return;
        
        // Destruir inst√¢ncia existente se houver
        if (dayElement.sortableInstance) {
            dayElement.sortableInstance.destroy();
            dayElement.sortableInstance = null;
        }
        
        // Recriar inst√¢ncia para este dia com handlers completos
        const i = dayIndex;
        dayElement.sortableInstance = Sortable.create(dayElement, {
            group: 'obras',
            animation: 150,
            onAdd: async (evt) => {
                const obraId = evt.item.dataset.obraId;
                const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][i];
                this.log(`üéØ Obra ${obraId} arrastada para ${dayName}!`);
                
                this.captureStateForRollback(dayElement, i, 'add', evt.item);
                this.updateStatus(`üíæ Salvando obra no ${dayName}...`, 'info');
                evt.item.style.opacity = '0.5';
                
                const success = await this.salvarAlocacao(obraId, i);
                
                if (success) {
                    this.log(`‚úÖ Obra ${obraId} salva no ${dayName}!`);
                    evt.item.remove();
                    
                    if (dayElement.querySelector('.text-muted')) {
                        const placeholder = dayElement.querySelector('.text-muted');
                        if (placeholder.textContent.includes('Drop zone')) {
                            placeholder.remove();
                        }
                    }
                    
                    this.clearRollbackState();
                } else {
                    this.log(`‚ùå Erro ao salvar obra ${obraId} no ${dayName} - executando rollback`);
                    this.executeRollback();
                }
            },
            onRemove: async (evt) => {
                const obraId = evt.item.dataset.obraId;
                const allocationId = evt.item.dataset.allocationId;
                
                if (allocationId) {
                    this.log(`üóëÔ∏è Removendo aloca√ß√£o ${allocationId} do dia ${i}`);
                    
                    this.captureStateForRollback(dayElement, i, 'remove', evt.item);
                    this.updateStatus(`üóëÔ∏è Removendo obra do dia...`, 'warning');
                    
                    const success = await this.removerAlocacao(obraId, i);
                    
                    if (!success) {
                        this.log(`‚ùå Erro ao remover - executando rollback`);
                        this.executeRollback();
                    } else {
                        this.clearRollbackState();
                    }
                } else {
                    this.log(`üì§ Item tempor√°rio removido do dia ${i}`);
                }
            }
        });
    }
    
    setupDragDrop() {
        this.log('Configurando SortableJS...');
        
        try {
            // Lista de obras (source)
            const obrasList = document.getElementById('obras-list');
            if (obrasList && !obrasList.sortableInstance) {
                obrasList.sortableInstance = Sortable.create(obrasList, {
                    group: {
                        name: 'obras',
                        pull: 'clone',
                        put: false
                    },
                    sort: false,
                    animation: 150,
                    onStart: (evt) => {
                        this.log(`üéØ Arrastando obra: ${evt.item.dataset.obraId}`);
                    }
                });
            }
            
            // Drop zones (dias da semana)
            for (let i = 0; i < 5; i++) {
                const dayElement = document.getElementById(`day-${i}`);
                if (dayElement && !dayElement.sortableInstance) {
                    dayElement.sortableInstance = Sortable.create(dayElement, {
                        group: 'obras',
                        animation: 150,
                        onAdd: async (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][i];
                            this.log(`üéØ Obra ${obraId} arrastada para ${dayName}!`);
                            
                            // Capturar estado original para rollback
                            this.captureStateForRollback(dayElement, i, 'add', evt.item);
                            
                            // Mostrar feedback de carregamento
                            this.updateStatus(`üíæ Salvando obra no ${dayName}...`, 'info');
                            evt.item.style.opacity = '0.5';
                            
                            // Salvar via API
                            const success = await this.salvarAlocacao(obraId, i);
                            
                            if (success) {
                                // Sucesso - o carregamento autom√°tico j√° atualizou a interface
                                this.log(`‚úÖ Obra ${obraId} salva no ${dayName}!`);
                                
                                // Remover o item arrastado (ser√° substitu√≠do pela renderiza√ß√£o correta)
                                evt.item.remove();
                                
                                // Limpar placeholder
                                if (dayElement.querySelector('.text-muted')) {
                                    const placeholder = dayElement.querySelector('.text-muted');
                                    if (placeholder.textContent.includes('Drop zone')) {
                                        placeholder.remove();
                                    }
                                }
                                
                                // Limpar estado de rollback
                                this.clearRollbackState();
                            } else {
                                // Erro - executar rollback
                                this.log(`‚ùå Erro ao salvar obra ${obraId} no ${dayName} - executando rollback`);
                                this.executeRollback();
                            }
                        },
                        onRemove: async (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const allocationId = evt.item.dataset.allocationId;
                            
                            // Se tem allocationId, √© uma aloca√ß√£o existente sendo removida
                            if (allocationId) {
                                this.log(`üóëÔ∏è Removendo aloca√ß√£o ${allocationId} do dia ${i}`);
                                
                                // Capturar estado original para rollback
                                this.captureStateForRollback(dayElement, i, 'remove', evt.item);
                                
                                this.updateStatus(`üóëÔ∏è Removendo obra do dia...`, 'warning');
                                
                                const success = await this.removerAlocacao(obraId, i);
                                
                                if (!success) {
                                    // Se falhou, executar rollback
                                    this.log(`‚ùå Erro ao remover - executando rollback`);
                                    this.executeRollback();
                                } else {
                                    this.clearRollbackState();
                                }
                            } else {
                                this.log(`üì§ Item tempor√°rio removido do dia ${i}`);
                            }
                        }
                    });
                }
            }
            
            this.log('‚úÖ Todas as drop zones configuradas');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao configurar SortableJS: ${error.message}`);
            throw error;
        }
    }
}

// ===================================
// FUN√á√ïES GLOBAIS PARA OS BOT√ïES
// ===================================

function testarAPI() {
    if (window.equipeFase2) {
        window.equipeFase2.testarAPI();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarObras() {
    if (window.equipeFase2) {
        window.equipeFase2.testarObras();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarDragDrop() {
    if (window.equipeFase2) {
        window.equipeFase2.testarDragDrop();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

// ===================================
// INICIALIZA√á√ÉO AUTOM√ÅTICA
// ===================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM loaded - Inicializando FASE 2...');
    window.equipeFase2 = new EquipeFase2();
});

console.log('üìú Script FASE 2 carregado - Aguardando DOM...');
</script>
{% endblock %}