{% extends "base_completo.html" %}

{% block title %}Gest√£o de Equipe - FASE 2{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3>üìã Gest√£o de Equipe - FASE 2 CORRE√á√ïES</h3>
    <p class="text-muted">Implementa√ß√£o gradual - "FUNCIONA PRIMEIRO, OTIMIZA DEPOIS"</p>
    
    <!-- STATUS DE DEBUG -->
    <div class="alert alert-info" id="status-debug">
        <strong>Status:</strong> Carregando sistema...
    </div>
    
    <div class="row">
        <!-- SIDEBAR: OBRAS -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>üèóÔ∏è Obras Dispon√≠veis</h5>
                    <small id="obras-count">Carregando...</small>
                </div>
                <div class="card-body">
                    <div id="obras-list" style="min-height: 300px;">
                        <div class="text-center text-muted p-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Carregando obras...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GRID SEMANAL COM NAVEGA√á√ÉO -->
        <div class="col-md-9">
            <div class="card">
                <!-- CABE√áALHO COM NAVEGA√á√ÉO -->
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">üìÖ Gest√£o Semanal</h5>
                            <small id="week-title" class="text-muted">Carregando semana...</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" id="btn-prev-week" onclick="window.equipeFase2.navegarSemana(-1)">
                                <i class="fas fa-chevron-left"></i> Semana Anterior
                            </button>
                            <button class="btn btn-outline-secondary" id="btn-current-week" onclick="window.equipeFase2.irParaSemanaAtual()">
                                Hoje
                            </button>
                            <button class="btn btn-outline-primary" id="btn-next-week" onclick="window.equipeFase2.navegarSemana(1)">
                                Pr√≥xima Semana <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- INDICADOR DE CARREGAMENTO -->
                <div id="week-loading" class="card-body text-center" style="display: none;">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Carregando semana...</span>
                </div>
                
                <div class="card-body weekly-grid-container" id="weekly-grid">
                    <div class="row weekly-grid">
                        <!-- DOMINGO -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-0">
                                <div class="fw-bold">Domingo</div>
                                <small class="date-display text-muted" id="date-day-0">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="0" 
                                 id="day-0"
                                 role="region"
                                 aria-label="Zona para obras de domingo"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- SEGUNDA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-1">
                                <div class="fw-bold">Segunda</div>
                                <small class="date-display text-muted" id="date-day-1">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="1" 
                                 id="day-1"
                                 role="region"
                                 aria-label="Zona para obras de segunda-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- TER√áA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-2">
                                <div class="fw-bold">Ter√ßa</div>
                                <small class="date-display text-muted" id="date-day-2">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="2" 
                                 id="day-2"
                                 role="region"
                                 aria-label="Zona para obras de ter√ßa-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- QUARTA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-3">
                                <div class="fw-bold">Quarta</div>
                                <small class="date-display text-muted" id="date-day-3">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="3" 
                                 id="day-3"
                                 role="region"
                                 aria-label="Zona para obras de quarta-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- QUINTA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-4">
                                <div class="fw-bold">Quinta</div>
                                <small class="date-display text-muted" id="date-day-4">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="4" 
                                 id="day-4"
                                 role="region"
                                 aria-label="Zona para obras de quinta-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- SEXTA -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-5">
                                <div class="fw-bold">Sexta</div>
                                <small class="date-display text-muted" id="date-day-5">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="5" 
                                 id="day-5"
                                 role="region"
                                 aria-label="Zona para obras de sexta-feira"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                        
                        <!-- S√ÅBADO -->
                        <div class="col">
                            <h6 class="text-center day-header" id="header-day-6">
                                <div class="fw-bold">S√°bado</div>
                                <small class="date-display text-muted" id="date-day-6">--/--</small>
                            </h6>
                            <div class="border rounded p-3 drop-zone" 
                                 style="min-height: 200px; background: #f8f9fa;" 
                                 data-day="6" 
                                 id="day-6"
                                 role="region"
                                 aria-label="Zona para obras de s√°bado"
                                 tabindex="0">
                                <small class="text-muted">Arraste obras aqui</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PAINEL DE DEBUG MELHORADO - Minimalista -->
    <div class="card mt-4 debug-panel" style="display: none;" id="debug-panel">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üîç Ferramentas de Desenvolvimento</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('debug-panel').style.display='none'">
                    ‚úï Fechar
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-info w-100" onclick="testarAPI()">
                        üîç Testar API B√°sica
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="testarObras()">
                        üèóÔ∏è Recarregar Obras
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" onclick="testarDragDrop()">
                        üéØ Reconfigurar Drag & Drop
                    </button>
                </div>
            </div>
            
            <!-- √ÅREA DE RESULTADOS -->
            <div class="mt-3">
                <h6>Resultados dos Testes:</h6>
                <div id="debug-results" class="border rounded p-3" style="background: #f8f9fa; min-height: 100px; font-family: monospace; font-size: 0.9rem;">
                    Clique nos bot√µes acima para testar...
                </div>
            </div>
        </div>
    </div>
    
    <!-- BOT√ÉO PARA MOSTRAR DEBUG (apenas para desenvolvimento) -->
    <div class="position-fixed" style="bottom: 20px; left: 20px; z-index: 1000;">
        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('debug-panel').style.display='block'" title="Mostrar ferramentas de desenvolvimento">
            üîß
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FontAwesome for navigation icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Custom styles for calendar navigation -->
<style>
    .day-header {
        border-bottom: 2px solid transparent;
        padding-bottom: 8px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }
    
    .day-header.text-primary {
        border-bottom-color: #007bff;
        background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        border-radius: 8px;
        padding: 8px;
    }
    
    .drop-zone {
        transition: all 0.3s ease;
        border: 2px dashed #dee2e6 !important;
    }
    
    .drop-zone:hover {
        border-color: #007bff !important;
        background-color: #f8f9ff !important;
    }
    
    .drop-zone.drag-over {
        border-color: #28a745 !important;
        background-color: #f8fff8 !important;
        transform: scale(1.02);
    }
    
    .obra-draggable {
        transition: all 0.2s ease;
        cursor: grab;
    }
    
    .obra-draggable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .obra-draggable:active {
        cursor: grabbing;
        transform: rotate(3deg);
    }
    
    .allocation-item {
        transition: all 0.2s ease;
    }
    
    .allocation-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .btn-group .btn {
        transition: all 0.2s ease;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-1px);
    }
    
    #week-loading {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .week-nav-header {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-bottom: 1px solid #dee2e6;
    }
    
    .current-week-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        margin-left: 8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* ===================================
       MELHORIAS DE UX - SISTEMAS NOVOS
       =================================== */
    
    /* TOAST SYSTEM MELHORADO */
    .custom-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px 16px;
        min-width: 280px;
        transform: translateX(350px);
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }
    
    .custom-toast.show {
        transform: translateX(0);
    }
    
    .custom-toast.toast-success {
        border-left-color: #28a745;
    }
    
    .custom-toast.toast-error {
        border-left-color: #dc3545;
    }
    
    .custom-toast.toast-warning {
        border-left-color: #ffc107;
    }
    
    .custom-toast.toast-loading {
        border-left-color: #17a2b8;
    }
    
    .toast-content {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .toast-icon {
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .toast-message {
        font-weight: 500;
        color: #333;
    }
    
    /* LOADING ELEGANTE PARA OPERA√á√ïES */
    .operation-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        z-index: 100;
        transition: opacity 0.3s ease;
    }
    
    .operation-loading-overlay.fade-out {
        opacity: 0;
    }
    
    .operation-loading-content {
        text-align: center;
        color: #007bff;
        font-weight: 500;
    }
    
    .spinner-elegant {
        width: 32px;
        height: 32px;
        border: 3px solid #e3f2fd;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* CONTADOR DE OBRAS POR DIA */
    .day-counter {
        margin-top: 4px;
        text-align: center;
    }
    
    .day-counter .badge {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    /* INDICADORES DE CAPACIDADE */
    .drop-zone.capacity-low {
        border-color: #28a745 !important;
        background-color: #f8fff8 !important;
    }
    
    .drop-zone.capacity-medium {
        border-color: #ffc107 !important;
        background-color: #fffdf8 !important;
    }
    
    .drop-zone.capacity-high {
        border-color: #fd7e14 !important;
        background-color: #fff8f5 !important;
    }
    
    .drop-zone.capacity-full {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
    }
    
    /* ESTADOS DE DRAG & DROP APRIMORADOS */
    .drop-zone-active {
        border-color: #007bff !important;
        background-color: #f8f9ff !important;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }
    
    .drop-zone-invalid {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .obra-draggable.dragging {
        opacity: 0.8;
        transform: rotate(5deg) scale(1.05);
        z-index: 1000;
    }
    
    /* MODAL DE CONFIRMA√á√ÉO DE REMO√á√ÉO */
    .removal-confirmation-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .removal-confirmation-modal.show {
        opacity: 1;
    }
    
    .removal-confirmation-content {
        background: white;
        border-radius: 8px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }
    
    .removal-confirmation-modal.show .removal-confirmation-content {
        transform: scale(1);
    }
    
    .confirmation-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: flex-end;
    }
    
    .confirmation-buttons .btn {
        min-width: 100px;
    }
    
    /* TOOLTIPS APRIMORADOS */
    .obra-tooltip {
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        max-width: 250px;
        word-wrap: break-word;
    }
    
    .obra-tooltip.show {
        opacity: 1;
    }
    
    .obra-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
    
    /* RESPONSIVIDADE PARA TABLETS */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 8px;
        }
        
        .row {
            margin: 0;
        }
        
        .col-md-3, .col-md-9 {
            padding: 4px;
        }
        
        /* Layout em stack para tablets */
        .col-md-3 {
            margin-bottom: 16px;
        }
        
        /* Bot√µes de navega√ß√£o maiores para touch */
        .btn-group .btn {
            padding: 12px 16px;
            font-size: 14px;
            min-height: 48px;
        }
        
        /* Drop zones maiores para touch */
        .drop-zone {
            min-height: 120px !important;
            padding: 16px !important;
        }
        
        /* Cards de obra maiores para touch */
        .obra-draggable {
            margin-bottom: 8px;
        }
        
        .obra-draggable .card-body {
            padding: 12px !important;
        }
        
        /* Bot√µes de remo√ß√£o maiores */
        .allocation-item .btn-sm {
            min-width: 36px;
            min-height: 36px;
        }
        
        /* Toast responsivo */
        .custom-toast {
            right: 10px;
            left: 10px;
            min-width: auto;
            transform: translateY(-100px);
        }
        
        .custom-toast.show {
            transform: translateY(0);
        }
        
        /* Modal responsivo */
        .removal-confirmation-content {
            margin: 20px;
            width: calc(100% - 40px);
        }
    }
    
    @media (max-width: 576px) {
        /* Grid semanal em scroll horizontal para celulares */
        .weekly-grid-container {
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .weekly-grid {
            min-width: 600px;
        }
        
        /* Cabe√ßalhos menores */
        h3 {
            font-size: 1.5rem;
        }
        
        h5 {
            font-size: 1.1rem;
        }
        
        /* Debug panel minimizado */
        .debug-panel {
            display: none;
        }
    }
    
    /* MELHORIAS DE ACESSIBILIDADE */
    .obra-draggable:focus,
    .allocation-item:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }
    
    .btn:focus {
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }
    
    /* ANIMA√á√ïES SUAVES */
    .card, .drop-zone, .btn, .badge {
        transition: all 0.2s ease;
    }
    
    .allocation-item {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* INDICADORES VISUAIS MELHORADOS */
    .status-debug {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    
    .obras-count {
        font-weight: 600;
        color: #007bff;
    }
    
    /* PERSONALIZA√á√ÉO ADICIONAL PARA TABLETS DE OBRA */
    @media (min-width: 768px) and (max-width: 1024px) {
        /* Tablet landscape otimizado */
        .drop-zone {
            min-height: 180px;
        }
        
        .obra-draggable {
            font-size: 14px;
        }
        
        .btn-group {
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .btn-group .btn {
            flex: 1;
            min-width: 120px;
        }
    }
</style>

<!-- SortableJS - CDN confi√°vel -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// CLASSE FASE 2 - FOCO EM DEBUG E CORRE√á√ïES + INTEGRA√á√ÉO COMPLETA
class EquipeFase2 {
    constructor() {
        this.obras = [];
        this.allocations = {};  // Aloca√ß√µes por dia
        this.currentWeek = null;  // Data da semana atual (segunda-feira)
        this.debugArea = document.getElementById('debug-results');
        this.statusArea = document.getElementById('status-debug');
        
        // Estado para rollback robusto
        this.operationState = {
            inProgress: false,
            originalHTML: {},
            pendingOperation: null
        };
        
        this.log('=== INICIANDO FASE 2 ===');
        this.init();
    }
    
    log(message) {
        console.log(message);
        if (this.debugArea) {
            this.debugArea.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
            this.debugArea.scrollTop = this.debugArea.scrollHeight;
        }
    }
    
    updateStatus(message, type = 'info') {
        if (this.statusArea) {
            this.statusArea.className = `alert alert-${type}`;
            this.statusArea.innerHTML = `<strong>Status:</strong> ${message}`;
        }
    }
    
    async init() {
        try {
            this.log('Verificando se SortableJS carregou...');
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå ERRO: SortableJS n√£o carregou!');
                this.updateStatus('SortableJS n√£o carregou', 'danger');
                return;
            }
            this.log('‚úÖ SortableJS carregado com sucesso');
            
            // Verificar semana da URL ou usar atual
            this.setCurrentWeekFromURL();
            
            // Atualizar interface de datas
            this.updateWeekDisplay();
            
            // Carregar dados automaticamente
            await this.testarObras();
            await this.carregarAlocacoes();
            
            this.updateStatus('Sistema inicializado - pronto para uso', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na inicializa√ß√£o: ${error.message}`);
            this.updateStatus(`Erro: ${error.message}`, 'danger');
        }
    }
    
    // M√âTODOS UTILIT√ÅRIOS PARA DATAS
    calculateCurrentWeek() {
        const today = new Date();
        const sunday = this.getSundayOfWeek(today);
        
        this.currentWeek = sunday.toISOString().split('T')[0]; // YYYY-MM-DD
        this.log(`üìÖ Semana atual (domingo): ${this.currentWeek}`);
    }
    
    getDateForDay(dayOfWeek) {
        if (!this.currentWeek) {
            this.calculateCurrentWeek();
        }
        
        const sunday = new Date(this.currentWeek);
        const targetDate = new Date(sunday);
        targetDate.setDate(sunday.getDate() + dayOfWeek);
        
        return targetDate.toISOString().split('T')[0]; // YYYY-MM-DD
    }
    
    // ===================================  
    // M√âTODOS DE NAVEGA√á√ÉO SEMANAL
    // ===================================
    
    setCurrentWeekFromURL() {
        // Verificar se h√° par√¢metro week na URL
        const urlParams = new URLSearchParams(window.location.search);
        const weekParam = urlParams.get('week');
        
        if (weekParam) {
            // Validar formato YYYY-MM-DD
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (dateRegex.test(weekParam)) {
                const date = new Date(weekParam);
                if (!isNaN(date.getTime())) {
                    // Calcular domingo da semana desta data
                    const sunday = this.getSundayOfWeek(date);
                    
                    this.currentWeek = sunday.toISOString().split('T')[0];
                    this.log(`üìÖ Semana carregada da URL: ${this.currentWeek}`);
                    return;
                }
            }
        }
        
        // Fallback para semana atual
        this.calculateCurrentWeek();
    }
    
    updateWeekDisplay() {
        if (!this.currentWeek) {
            this.calculateCurrentWeek();
        }
        
        const sunday = new Date(this.currentWeek);
        const saturday = new Date(sunday);
        saturday.setDate(sunday.getDate() + 6);
        
        // Atualizar t√≠tulo da semana
        const weekTitle = document.getElementById('week-title');
        if (weekTitle) {
            const sundayStr = this.formatDateBrazilian(sunday);
            const saturdayStr = this.formatDateBrazilian(saturday);
            weekTitle.textContent = `Semana de ${sundayStr} a ${saturdayStr}`;
        }
        
        // Atualizar cabe√ßalhos dos dias
        const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        for (let i = 0; i < 7; i++) {
            const dateElement = document.getElementById(`date-day-${i}`);
            if (dateElement) {
                const dayDate = new Date(sunday);
                dayDate.setDate(sunday.getDate() + i);
                dateElement.textContent = this.formatDateBrazilian(dayDate);
            }
        }
        
        // Destacar se √© semana atual
        this.highlightCurrentWeek();
        
        this.log(`üìÖ Interface atualizada para semana: ${this.currentWeek}`);
    }
    
    formatDateBrazilian(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return `${day}/${month}`;
    }
    
    highlightCurrentWeek() {
        const today = new Date();
        const currentSunday = this.getSundayOfWeek(today);
        const isCurrentWeek = currentSunday.toISOString().split('T')[0] === this.currentWeek;
        
        const btnCurrentWeek = document.getElementById('btn-current-week');
        if (btnCurrentWeek) {
            if (isCurrentWeek) {
                btnCurrentWeek.className = 'btn btn-secondary';
                btnCurrentWeek.textContent = 'Esta Semana';
            } else {
                btnCurrentWeek.className = 'btn btn-outline-secondary';
                btnCurrentWeek.textContent = 'Hoje';
            }
        }
        
        // Adicionar classe para semana atual nos cabe√ßalhos
        for (let i = 0; i < 7; i++) {
            const headerElement = document.getElementById(`header-day-${i}`);
            if (headerElement) {
                if (isCurrentWeek) {
                    headerElement.classList.add('text-primary');
                } else {
                    headerElement.classList.remove('text-primary');
                }
            }
        }
    }
    
    getSundayOfWeek(date) {
        const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.
        const sunday = new Date(date);
        sunday.setDate(date.getDate() - dayOfWeek); // Sunday is day 0
        return sunday;
    }
    
    async navegarSemana(direction) {
        this.log(`üóìÔ∏è Navegando semana: ${direction > 0 ? '+1' : '-1'}`);
        
        // Mostrar loading
        this.showWeekLoading(true);
        
        try {
            // Calcular nova semana
            const currentSunday = new Date(this.currentWeek);
            const newSunday = new Date(currentSunday);
            newSunday.setDate(currentSunday.getDate() + (direction * 7));
            
            this.currentWeek = newSunday.toISOString().split('T')[0];
            
            // Atualizar URL
            this.updateURL();
            
            // Atualizar interface
            this.updateWeekDisplay();
            
            // Recarregar dados
            await this.carregarAlocacoes();
            
            this.updateStatus(`Semana ${direction > 0 ? 'seguinte' : 'anterior'} carregada`, 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao navegar: ${error.message}`);
            this.updateStatus(`Erro na navega√ß√£o: ${error.message}`, 'danger');
        } finally {
            this.showWeekLoading(false);
        }
    }
    
    async irParaSemanaAtual() {
        this.log('üè† Voltando para semana atual...');
        
        // Mostrar loading
        this.showWeekLoading(true);
        
        try {
            // Calcular semana atual (domingo)
            this.calculateCurrentWeek();
            
            // Atualizar URL
            this.updateURL();
            
            // Atualizar interface
            this.updateWeekDisplay();
            
            // Recarregar dados
            await this.carregarAlocacoes();
            
            this.updateStatus('Voltou para semana atual', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao voltar para semana atual: ${error.message}`);
            this.updateStatus(`Erro: ${error.message}`, 'danger');
        } finally {
            this.showWeekLoading(false);
        }
    }
    
    showWeekLoading(show) {
        const loadingElement = document.getElementById('week-loading');
        const gridElement = document.getElementById('weekly-grid');
        
        if (loadingElement && gridElement) {
            if (show) {
                loadingElement.style.display = 'block';
                gridElement.style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
                gridElement.style.display = 'block';
            }
        }
    }
    
    updateURL() {
        // Atualizar URL sem recarregar p√°gina
        const url = new URL(window.location);
        url.searchParams.set('week', this.currentWeek);
        window.history.pushState({}, '', url);
        
        this.log(`üîó URL atualizada: ${url.toString()}`);
    }
    
    // TESTE 1: API B√ÅSICA
    async testarAPI() {
        this.log('=== TESTANDO API B√ÅSICA ===');
        
        try {
            // Teste 1: API sem autentica√ß√£o
            this.log('Testando /equipe/debug/test-direct...');
            const response1 = await fetch('/equipe/debug/test-direct');
            const data1 = await response1.json();
            this.log(`‚úÖ API direta: ${JSON.stringify(data1)}`);
            
            // Teste 2: API com autentica√ß√£o
            this.log('Testando /equipe/debug/obras-count...');
            const response2 = await fetch('/equipe/debug/obras-count');
            const data2 = await response2.json();
            this.log(`‚úÖ API obras: ${JSON.stringify(data2)}`);
            
            this.updateStatus('APIs funcionando corretamente', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO na API: ${error.message}`);
            this.updateStatus(`Erro na API: ${error.message}`, 'danger');
        }
    }
    
    // TESTE 2: CARREGAMENTO DE OBRAS
    async testarObras() {
        this.log('=== TESTANDO CARREGAMENTO DE OBRAS ===');
        
        try {
            const response = await fetch('/equipe/api/obras-simples');
            const result = await response.json();
            
            this.log(`Response status: ${response.status}`);
            this.log(`Response data: ${JSON.stringify(result)}`);
            
            if (result.success && result.data) {
                this.obras = result.data;
                this.log(`‚úÖ ${this.obras.length} obras carregadas`);
                this.renderObras();
                this.updateStatus(`${this.obras.length} obras carregadas`, 'success');
            } else {
                this.log(`‚ùå Erro no resultado: ${result.error || 'Dados inv√°lidos'}`);
                this.updateStatus(`Erro: ${result.error || 'Dados inv√°lidos'}`, 'warning');
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO ao carregar obras: ${error.message}`);
            this.updateStatus(`Erro ao carregar obras: ${error.message}`, 'danger');
        }
    }
    
    renderObras() {
        const container = document.getElementById('obras-list');
        const countElement = document.getElementById('obras-count');
        
        if (!container) {
            this.log('‚ùå Container obras-list n√£o encontrado');
            return;
        }
        
        container.innerHTML = '';
        countElement.textContent = `${this.obras.length} obras encontradas`;
        countElement.className = 'obras-count';
        
        this.obras.forEach((obra, index) => {
            const div = document.createElement('div');
            div.className = 'card mb-2 obra-draggable';
            div.dataset.obraId = obra.id;
            div.style.cursor = 'grab';
            div.setAttribute('tabindex', '0'); // Acessibilidade
            
            div.innerHTML = `
                <div class="card-body p-2">
                    <h6 class="card-title mb-1 text-primary">${obra.codigo}</h6>
                    <small class="text-muted">${obra.nome.length > 30 ? obra.nome.substring(0, 30) + '...' : obra.nome}</small>
                </div>
            `;
            
            // Adicionar tooltips com detalhes da obra
            this.addTooltipToElement(div, {
                title: `${obra.codigo} - ${obra.nome}`,
                content: `
                    <strong>C√≥digo:</strong> ${obra.codigo}<br>
                    <strong>Nome:</strong> ${obra.nome}<br>
                    <strong>ID:</strong> ${obra.id}
                `
            });
            
            container.appendChild(div);
        });
        
        this.log(`‚úÖ ${this.obras.length} obras renderizadas no DOM com tooltips`);
        
        // Configurar drag & drop ap√≥s renderizar
        this.setupDragDrop();
    }
    
    // CARREGAR ALOCA√á√ïES EXISTENTES
    async carregarAlocacoes() {
        this.log('=== CARREGANDO ALOCA√á√ïES EXISTENTES ===');
        
        try {
            const response = await fetch(`/equipe/api/allocations-week?week=${this.currentWeek}`);
            const result = await response.json();
            
            this.log(`Response status: ${response.status}`);
            this.log(`Response data: ${JSON.stringify(result).substring(0, 200)}...`);
            
            if (result.success && result.data) {
                this.allocations = result.data;
                this.renderAlocacoes();
                this.log(`‚úÖ Aloca√ß√µes carregadas para semana ${result.week_start}`);
            } else {
                this.log(`‚ö†Ô∏è Nenhuma aloca√ß√£o encontrada: ${result.error || 'Dados vazios'}`);
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO ao carregar aloca√ß√µes: ${error.message}`);
        }
    }
    
    renderAlocacoes() {
        if (!this.allocations) return;
        
        // Limpar todas as drop zones primeiro
        for (let i = 0; i < 7; i++) {
            const dayElement = document.getElementById(`day-${i}`);
            if (dayElement) {
                // Manter apenas elementos que n√£o s√£o aloca√ß√µes
                const existingAllocations = dayElement.querySelectorAll('.allocation-item');
                existingAllocations.forEach(item => item.remove());
            }
        }
        
        // Renderizar aloca√ß√µes por dia
        Object.keys(this.allocations).forEach(dayKey => {
            const dayData = this.allocations[dayKey];
            const dayElement = document.getElementById(`day-${dayKey}`);
            
            if (dayElement && dayData.allocations) {
                dayData.allocations.forEach(allocation => {
                    this.renderAllocationItem(dayElement, allocation, parseInt(dayKey));
                });
                
                // Remover placeholder se existir
                const placeholder = dayElement.querySelector('.text-muted');
                if (placeholder && placeholder.textContent.includes('Arraste')) {
                    placeholder.remove();
                }
            }
        });
        
        // Atualizar contadores para todos os dias
        for (let i = 0; i < 7; i++) {
            this.updateDayCounter(i);
        }
        
        this.log(`‚úÖ Aloca√ß√µes renderizadas na interface com contadores`);
    }
    
    renderAllocationItem(container, allocation, dayOfWeek) {
        const div = document.createElement('div');
        div.className = 'card mb-2 allocation-item';
        div.dataset.obraId = allocation.obra_id;
        div.dataset.allocationId = allocation.id;
        div.style.border = '1px solid #28a745';
        div.style.backgroundColor = '#f8fff8';
        div.innerHTML = `
            <div class="card-body p-2">
                <h6 class="card-title mb-1 text-success">${allocation.obra_codigo}</h6>
                <small class="text-muted">${allocation.obra_nome.substring(0, 30)}...</small>
                <div class="mt-1">
                    <small class="badge bg-success">${allocation.turno_inicio} - ${allocation.turno_fim}</small>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="window.equipeFase2.removerAlocacaoManual(${allocation.obra_id}, ${dayOfWeek})">
                        ‚ùå
                    </button>
                </div>
            </div>
        `;
        container.appendChild(div);
    }
    
    // M√âTODOS DE SALVAMENTO E REMO√á√ÉO - APIs INTEGRADAS
    async salvarAlocacao(obraId, dayOfWeek) {
        this.log(`üíæ Salvando aloca√ß√£o: Obra ${obraId} no dia ${dayOfWeek}`);
        
        try {
            const data_alocacao = this.getDateForDay(dayOfWeek);
            
            const response = await fetch('/equipe/api/allocations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    obra_id: parseInt(obraId),
                    day_of_week: dayOfWeek,
                    data_alocacao: data_alocacao
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.log(`‚úÖ Aloca√ß√£o salva: ${result.message}`);
                this.updateStatus(`‚úÖ ${result.message}`, 'success');
                
                // Recarregar aloca√ß√µes para atualizar interface
                await this.carregarAlocacoes();
                
                return true;
            } else {
                this.log(`‚ùå Erro ao salvar: ${result.error}`);
                this.updateStatus(`‚ùå ${result.error}`, 'danger');
                return false;
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO CR√çTICO ao salvar: ${error.message}`);
            this.updateStatus(`‚ùå Erro ao salvar: ${error.message}`, 'danger');
            return false;
        }
    }
    
    async removerAlocacao(obraId, dayOfWeek) {
        this.log(`üóëÔ∏è Removendo aloca√ß√£o: Obra ${obraId} do dia ${dayOfWeek}`);
        
        try {
            const data_alocacao = this.getDateForDay(dayOfWeek);
            
            const response = await fetch(`/equipe/api/allocations/${obraId}/${data_alocacao}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.log(`‚úÖ Aloca√ß√£o removida: ${result.message}`);
                this.updateStatus(`‚úÖ ${result.message}`, 'info');
                
                // Recarregar aloca√ß√µes para atualizar interface
                await this.carregarAlocacoes();
                
                return true;
            } else {
                this.log(`‚ùå Erro ao remover: ${result.error}`);
                this.updateStatus(`‚ùå ${result.error}`, 'warning');
                return false;
            }
            
        } catch (error) {
            this.log(`‚ùå ERRO CR√çTICO ao remover: ${error.message}`);
            this.updateStatus(`‚ùå Erro ao remover: ${error.message}`, 'danger');
            return false;
        }
    }
    
    // SISTEMA DE TOOLTIPS
    addTooltipToElement(element, tooltipData) {
        let tooltip = null;
        let timeoutId = null;
        
        const showTooltip = (e) => {
            // Limpar timeout anterior
            if (timeoutId) clearTimeout(timeoutId);
            
            // Remover tooltip existente
            this.hideTooltip();
            
            // Criar novo tooltip
            tooltip = document.createElement('div');
            tooltip.className = 'obra-tooltip';
            tooltip.innerHTML = tooltipData.content;
            
            document.body.appendChild(tooltip);
            
            // Posicionar tooltip
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 10;
            
            // Ajustar se sair da tela
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            
            // Mostrar com delay
            timeoutId = setTimeout(() => {
                tooltip.classList.add('show');
            }, 500);
        };
        
        const hideTooltip = () => {
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            this.hideTooltip();
        };
        
        element.addEventListener('mouseenter', showTooltip);
        element.addEventListener('mouseleave', hideTooltip);
        element.addEventListener('touchstart', showTooltip);
        element.addEventListener('touchend', hideTooltip);
    }
    
    hideTooltip() {
        const existingTooltip = document.querySelector('.obra-tooltip');
        if (existingTooltip) {
            existingTooltip.classList.remove('show');
            setTimeout(() => existingTooltip.remove(), 300);
        }
    }
    
    // M√âTODO PARA REMO√á√ÉO MANUAL (BOT√ÉO ‚ùå) - MELHORADO
    async removerAlocacaoManual(obraId, dayOfWeek) {
        this.log(`üî¥ Remo√ß√£o manual solicitada: Obra ${obraId} do dia ${dayOfWeek}`);
        
        // Buscar informa√ß√µes da obra para confirma√ß√£o melhorada
        const obra = this.obras.find(o => o.id.toString() === obraId.toString());
        const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][dayOfWeek];
        
        // Usar confirma√ß√£o melhorada
        const confirmed = await this.confirmRemoval(
            obra || {codigo: `#${obraId}`, nome: 'Obra n√£o identificada'}, 
            dayName
        );
        
        if (!confirmed) {
            this.log('‚ùå Remo√ß√£o cancelada pelo usu√°rio');
            return;
        }
        
        // Executar remo√ß√£o com feedback melhorado
        const success = await this.removerAlocacao(obraId, dayOfWeek);
        
        if (success) {
            this.showToast(`‚úÖ Obra removida do ${dayName}`, 'success', 2000);
            this.updateDayCounter(dayOfWeek);
        }
    }
    
    // TESTE 3: DRAG & DROP
    testarDragDrop() {
        this.log('=== TESTANDO DRAG & DROP ===');
        
        try {
            // Verificar se SortableJS est√° dispon√≠vel
            if (typeof Sortable === 'undefined') {
                this.log('‚ùå SortableJS n√£o est√° carregado');
                this.updateStatus('SortableJS n√£o carregado', 'danger');
                return;
            }
            
            // Testar se obras est√£o carregadas
            if (this.obras.length === 0) {
                this.log('‚ö†Ô∏è Nenhuma obra carregada. Execute "Testar Carregamento Obras" primeiro');
                this.updateStatus('Carregue obras primeiro', 'warning');
                return;
            }
            
            this.setupDragDrop();
            this.log('‚úÖ Drag & Drop configurado com sucesso');
            this.updateStatus('Drag & Drop ativo - arraste obras para os dias', 'success');
            
        } catch (error) {
            this.log(`‚ùå ERRO no Drag & Drop: ${error.message}`);
            this.updateStatus(`Erro no Drag & Drop: ${error.message}`, 'danger');
        }
    }
    
    // ====================================
    // M√âTODOS DE ROLLBACK ROBUSTO
    // ====================================
    
    captureStateForRollback(dayElement, dayIndex, operation, item) {
        this.log(`üì∑ Capturando estado original para rollback (${operation})`);
        
        this.operationState = {
            inProgress: true,
            operation: operation,
            dayIndex: dayIndex,
            dayElement: dayElement,
            originalHTML: dayElement.innerHTML,
            item: item ? item.cloneNode(true) : null,
            itemParent: item ? item.parentElement : null,
            itemNextSibling: item ? item.nextElementSibling : null
        };
    }
    
    executeRollback() {
        if (!this.operationState.inProgress) {
            this.log('‚ùå Nenhuma opera√ß√£o em progresso para rollback');
            return;
        }
        
        this.log(`‚Ü©Ô∏è Executando rollback da opera√ß√£o: ${this.operationState.operation}`);
        
        try {
            const { dayElement, originalHTML, operation, item, itemParent, itemNextSibling } = this.operationState;
            
            if (operation === 'add') {
                // Reverter adi√ß√£o: restaurar HTML original
                dayElement.innerHTML = originalHTML;
                
                // Reconfigurar sortable ap√≥s restaura√ß√£o
                if (dayElement.sortableInstance) {
                    dayElement.sortableInstance.destroy();
                    dayElement.sortableInstance = null;
                }
                
                // Reconfigurar drag & drop
                this.setupDragDropForDay(this.operationState.dayIndex);
                
            } else if (operation === 'remove') {
                // Reverter remo√ß√£o: restaurar item removido
                if (item && itemParent) {
                    if (itemNextSibling) {
                        itemParent.insertBefore(item, itemNextSibling);
                    } else {
                        itemParent.appendChild(item);
                    }
                }
            }
            
            this.updateStatus('‚Ü©Ô∏è Opera√ß√£o revertida - tente novamente', 'warning');
            this.log('‚úÖ Rollback executado com sucesso');
            
        } catch (error) {
            this.log(`‚ùå Erro durante rollback: ${error.message}`);
            this.updateStatus('‚ùå Erro cr√≠tico no rollback', 'danger');
        }
        
        this.clearRollbackState();
    }
    
    clearRollbackState() {
        this.operationState = {
            inProgress: false,
            originalHTML: {},
            pendingOperation: null
        };
    }
    
    // M√©todo auxiliar para reconfigurar drag & drop de um dia espec√≠fico
    setupDragDropForDay(dayIndex) {
        const dayElement = document.getElementById(`day-${dayIndex}`);
        if (!dayElement) return;
        
        // Destruir inst√¢ncia existente se houver
        if (dayElement.sortableInstance) {
            dayElement.sortableInstance.destroy();
            dayElement.sortableInstance = null;
        }
        
        // Recriar inst√¢ncia para este dia com handlers completos
        const i = dayIndex;
        dayElement.sortableInstance = Sortable.create(dayElement, {
            group: 'obras',
            animation: 150,
            onAdd: async (evt) => {
                const obraId = evt.item.dataset.obraId;
                const dayName = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][i];
                this.log(`üéØ Obra ${obraId} arrastada para ${dayName}!`);
                
                this.captureStateForRollback(dayElement, i, 'add', evt.item);
                this.updateStatus(`üíæ Salvando obra no ${dayName}...`, 'info');
                evt.item.style.opacity = '0.5';
                
                const success = await this.salvarAlocacao(obraId, i);
                
                if (success) {
                    this.log(`‚úÖ Obra ${obraId} salva no ${dayName}!`);
                    evt.item.remove();
                    
                    if (dayElement.querySelector('.text-muted')) {
                        const placeholder = dayElement.querySelector('.text-muted');
                        if (placeholder.textContent.includes('Drop zone')) {
                            placeholder.remove();
                        }
                    }
                    
                    this.clearRollbackState();
                } else {
                    this.log(`‚ùå Erro ao salvar obra ${obraId} no ${dayName} - executando rollback`);
                    this.executeRollback();
                }
            },
            onRemove: async (evt) => {
                const obraId = evt.item.dataset.obraId;
                const allocationId = evt.item.dataset.allocationId;
                
                if (allocationId) {
                    this.log(`üóëÔ∏è Removendo aloca√ß√£o ${allocationId} do dia ${i}`);
                    
                    this.captureStateForRollback(dayElement, i, 'remove', evt.item);
                    this.updateStatus(`üóëÔ∏è Removendo obra do dia...`, 'warning');
                    
                    const success = await this.removerAlocacao(obraId, i);
                    
                    if (!success) {
                        this.log(`‚ùå Erro ao remover - executando rollback`);
                        this.executeRollback();
                    } else {
                        this.clearRollbackState();
                    }
                } else {
                    this.log(`üì§ Item tempor√°rio removido do dia ${i}`);
                }
            }
        });
    }
    
    // VALIDA√á√ÉO INTELIGENTE: Verificar duplicatas
    isDuplicateAllocation(obraId, dayOfWeek) {
        const dayElement = document.getElementById(`day-${dayOfWeek}`);
        if (!dayElement) return false;
        
        const existingAllocations = dayElement.querySelectorAll('.allocation-item');
        for (let allocation of existingAllocations) {
            if (allocation.dataset.obraId === obraId.toString()) {
                return true;
            }
        }
        return false;
    }
    
    // TOAST SYSTEM MELHORADO
    showToast(message, type = 'info', duration = 3000) {
        // Remove toast existente se houver
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${type}`;
        
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è',
            loading: '‚è≥'
        };
        
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                <span class="toast-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Anima√ß√£o de entrada
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto-remove ap√≥s dura√ß√£o especificada
        if (duration > 0) {
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        return toast;
    }
    
    // LOADING ELEGANTE PARA OPERA√á√ïES
    showOperationLoading(dayElement, operation = 'salvando') {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'operation-loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="operation-loading-content">
                <div class="spinner-elegant"></div>
                <span>${operation}...</span>
            </div>
        `;
        
        dayElement.style.position = 'relative';
        dayElement.appendChild(loadingOverlay);
        
        return loadingOverlay;
    }
    
    hideOperationLoading(loadingOverlay) {
        if (loadingOverlay) {
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => loadingOverlay.remove(), 300);
        }
    }
    
    // CONTADOR DE OBRAS POR DIA
    updateDayCounter(dayOfWeek) {
        const dayElement = document.getElementById(`day-${dayOfWeek}`);
        const headerElement = document.getElementById(`header-day-${dayOfWeek}`);
        
        if (!dayElement || !headerElement) return;
        
        const allocationCount = dayElement.querySelectorAll('.allocation-item').length;
        
        // Remover contador existente
        const existingCounter = headerElement.querySelector('.day-counter');
        if (existingCounter) {
            existingCounter.remove();
        }
        
        // Adicionar novo contador
        if (allocationCount > 0) {
            const counter = document.createElement('div');
            counter.className = 'day-counter';
            counter.innerHTML = `<span class="badge bg-primary">${allocationCount}</span>`;
            headerElement.appendChild(counter);
        }
        
        // Atualizar indicador visual de capacidade
        this.updateCapacityIndicator(dayOfWeek, allocationCount);
    }
    
    // INDICADOR DE CAPACIDADE POR DIA
    updateCapacityIndicator(dayOfWeek, allocationCount) {
        const dayElement = document.getElementById(`day-${dayOfWeek}`);
        if (!dayElement) return;
        
        // Remove classes de capacidade existentes
        dayElement.classList.remove('capacity-low', 'capacity-medium', 'capacity-high', 'capacity-full');
        
        // Aplica classe baseada na quantidade de obras
        if (allocationCount === 0) {
            // Sem classe especial para vazio
        } else if (allocationCount <= 2) {
            dayElement.classList.add('capacity-low');
        } else if (allocationCount <= 4) {
            dayElement.classList.add('capacity-medium');
        } else if (allocationCount <= 6) {
            dayElement.classList.add('capacity-high');
        } else {
            dayElement.classList.add('capacity-full');
        }
    }
    
    // CONFIRMA√á√ÉO MELHORADA DE REMO√á√ÉO
    async confirmRemoval(obraInfo, dayName) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'removal-confirmation-modal';
            modal.innerHTML = `
                <div class="removal-confirmation-content">
                    <h5>üóëÔ∏è Confirmar Remo√ß√£o</h5>
                    <p>Deseja remover a obra <strong>${obraInfo.codigo}</strong> do <strong>${dayName}</strong>?</p>
                    <p class="text-muted">${obraInfo.nome}</p>
                    <div class="confirmation-buttons">
                        <button class="btn btn-outline-secondary" id="cancel-removal">Cancelar</button>
                        <button class="btn btn-danger" id="confirm-removal">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 100);
            
            document.getElementById('confirm-removal').onclick = () => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
                resolve(true);
            };
            
            document.getElementById('cancel-removal').onclick = () => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
                resolve(false);
            };
            
            // Fechar com ESC ou clique fora
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    setTimeout(() => modal.remove(), 300);
                    resolve(false);
                }
            };
        });
    }

    setupDragDrop() {
        this.log('Configurando SortableJS com valida√ß√µes inteligentes...');
        
        try {
            // Lista de obras (source)
            const obrasList = document.getElementById('obras-list');
            if (obrasList && !obrasList.sortableInstance) {
                obrasList.sortableInstance = Sortable.create(obrasList, {
                    group: {
                        name: 'obras',
                        pull: 'clone',
                        put: false
                    },
                    sort: false,
                    animation: 150,
                    onStart: (evt) => {
                        this.log(`üéØ Arrastando obra: ${evt.item.dataset.obraId}`);
                        
                        // Adicionar efeito visual de arraste
                        evt.item.classList.add('dragging');
                        
                        // Destacar drop zones v√°lidas
                        document.querySelectorAll('.drop-zone').forEach(zone => {
                            zone.classList.add('drop-zone-active');
                        });
                    },
                    onEnd: (evt) => {
                        // Remover efeitos visuais
                        evt.item.classList.remove('dragging');
                        document.querySelectorAll('.drop-zone').forEach(zone => {
                            zone.classList.remove('drop-zone-active', 'drop-zone-invalid');
                        });
                    }
                });
            }
            
            // Drop zones (dias da semana) - CALEND√ÅRIO COMPLETO 7 DIAS
            for (let i = 0; i < 7; i++) {
                const dayElement = document.getElementById(`day-${i}`);
                if (dayElement && !dayElement.sortableInstance) {
                    dayElement.sortableInstance = Sortable.create(dayElement, {
                        group: 'obras',
                        animation: 150,
                        onAdd: async (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const dayName = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][i];
                            
                            // VALIDA√á√ÉO INTELIGENTE: Verificar duplicata
                            if (this.isDuplicateAllocation(obraId, i)) {
                                this.log(`‚ùå Obra ${obraId} j√° est√° alocada no ${dayName}!`);
                                
                                // Feedback visual de erro
                                dayElement.classList.add('drop-zone-invalid');
                                setTimeout(() => dayElement.classList.remove('drop-zone-invalid'), 1500);
                                
                                // Toast de erro
                                this.showToast(`Obra j√° alocada neste dia!`, 'warning', 3000);
                                
                                // Remover item duplicado
                                evt.item.remove();
                                return;
                            }
                            
                            this.log(`üéØ Obra ${obraId} arrastada para ${dayName}!`);
                            
                            // Capturar estado original para rollback
                            this.captureStateForRollback(dayElement, i, 'add', evt.item);
                            
                            // Loading elegante
                            const loadingOverlay = this.showOperationLoading(dayElement, 'Salvando obra');
                            evt.item.style.opacity = '0.5';
                            
                            // Toast de loading
                            const loadingToast = this.showToast(`Salvando obra no ${dayName}...`, 'loading', 0);
                            
                            // Salvar via API
                            const success = await this.salvarAlocacao(obraId, i);
                            
                            // Remover loading
                            this.hideOperationLoading(loadingOverlay);
                            loadingToast.remove();
                            
                            if (success) {
                                this.log(`‚úÖ Obra ${obraId} salva no ${dayName}!`);
                                
                                // Toast de sucesso
                                this.showToast(`‚úÖ Obra salva no ${dayName}!`, 'success', 2000);
                                
                                // Remover o item arrastado (ser√° substitu√≠do pela renderiza√ß√£o correta)
                                evt.item.remove();
                                
                                // Limpar placeholder
                                if (dayElement.querySelector('.text-muted')) {
                                    const placeholder = dayElement.querySelector('.text-muted');
                                    if (placeholder.textContent.includes('Arraste')) {
                                        placeholder.remove();
                                    }
                                }
                                
                                // Atualizar contador
                                this.updateDayCounter(i);
                                
                                // Limpar estado de rollback
                                this.clearRollbackState();
                            } else {
                                // Erro - executar rollback
                                this.log(`‚ùå Erro ao salvar obra ${obraId} no ${dayName} - executando rollback`);
                                this.showToast(`‚ùå Erro ao salvar obra`, 'error', 3000);
                                this.executeRollback();
                            }
                        },
                        onRemove: async (evt) => {
                            const obraId = evt.item.dataset.obraId;
                            const allocationId = evt.item.dataset.allocationId;
                            
                            // Se tem allocationId, √© uma aloca√ß√£o existente sendo removida
                            if (allocationId) {
                                this.log(`üóëÔ∏è Removendo aloca√ß√£o ${allocationId} do dia ${i}`);
                                
                                // Buscar informa√ß√µes da obra para confirma√ß√£o
                                const obra = this.obras.find(o => o.id.toString() === obraId);
                                const dayName = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'][i];
                                
                                // Confirma√ß√£o melhorada
                                const confirmed = await this.confirmRemoval(
                                    obra || {codigo: `#${obraId}`, nome: 'Obra n√£o identificada'}, 
                                    dayName
                                );
                                
                                if (!confirmed) {
                                    // Usu√°rio cancelou - recarregar aloca√ß√µes para restaurar
                                    await this.carregarAlocacoes();
                                    return;
                                }
                                
                                // Capturar estado original para rollback
                                this.captureStateForRollback(dayElement, i, 'remove', evt.item);
                                
                                // Loading para remo√ß√£o
                                const loadingOverlay = this.showOperationLoading(dayElement, 'Removendo obra');
                                const loadingToast = this.showToast(`Removendo obra do ${dayName}...`, 'loading', 0);
                                
                                const success = await this.removerAlocacao(obraId, i);
                                
                                // Remover loading
                                this.hideOperationLoading(loadingOverlay);
                                loadingToast.remove();
                                
                                if (!success) {
                                    // Se falhou, executar rollback
                                    this.log(`‚ùå Erro ao remover - executando rollback`);
                                    this.showToast(`‚ùå Erro ao remover obra`, 'error', 3000);
                                    this.executeRollback();
                                } else {
                                    this.showToast(`‚úÖ Obra removida do ${dayName}`, 'success', 2000);
                                    this.updateDayCounter(i);
                                    this.clearRollbackState();
                                }
                            } else {
                                this.log(`üì§ Item tempor√°rio removido do dia ${i}`);
                            }
                        }
                    });
                }
            }
            
            this.log('‚úÖ Todas as drop zones configuradas com valida√ß√µes inteligentes');
            
        } catch (error) {
            this.log(`‚ùå ERRO ao configurar SortableJS: ${error.message}`);
            throw error;
        }
    }
}

// ===================================
// FUN√á√ïES GLOBAIS PARA OS BOT√ïES
// ===================================

function testarAPI() {
    if (window.equipeFase2) {
        window.equipeFase2.testarAPI();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarObras() {
    if (window.equipeFase2) {
        window.equipeFase2.testarObras();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

function testarDragDrop() {
    if (window.equipeFase2) {
        window.equipeFase2.testarDragDrop();
    } else {
        console.error('EquipeFase2 n√£o inicializada');
    }
}

// ===================================
// INICIALIZA√á√ÉO AUTOM√ÅTICA
// ===================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM loaded - Inicializando FASE 2...');
    window.equipeFase2 = new EquipeFase2();
});

console.log('üìú Script FASE 2 carregado - Aguardando DOM...');
</script>
{% endblock %}