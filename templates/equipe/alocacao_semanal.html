{% extends "base_completo.html" %}

{% block title %}üìã Gest√£o de Equipe - Semana {{ monday.strftime('%d/%m') }}{% endblock %}

{% block head_content %}
<!-- Sortable.js para drag & drop otimizado mobile -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* ===========================================
   CSS MOBILE-FIRST PARA CANTEIRO DE OBRA
   =========================================== */

/* Base responsiva - tablet como prioridade */
.equipe-container {
    padding: 8px;
    max-width: 100%;
    overflow-x: auto;
}

/* Header com stats r√°pidas */
.equipe-header {
    background: linear-gradient(135deg, #2c5530, #198754);
    border-radius: 12px;
    padding: 16px;
    color: white;
    margin-bottom: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.stat-item {
    text-align: center;
    padding: 8px;
    background: rgba(255,255,255,0.15);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.85rem;
    opacity: 0.9;
}

/* Grade semanal - layout horizontal otimizado */
.week-grid {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 16px;
    min-height: 500px;
}

/* Sidebar de obras - fonte para drag */
.obras-sidebar {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 12px;
    border: 2px solid #dee2e6;
    position: sticky;
    top: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.obras-title {
    font-weight: bold;
    color: #2c5530;
    margin-bottom: 12px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.obra-item {
    background: white;
    border: 2px solid #198754;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    min-height: 44px; /* Touch target m√≠nimo */
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.obra-item:hover {
    background: #e8f5e8;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25,135,84,0.2);
}

.obra-item:active {
    cursor: grabbing;
    transform: scale(1.05);
}

/* Grid dos dias da semana */
.days-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    background: white;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.day-column {
    min-height: 400px;
    background: #fafafa;
    border: 2px dashed #d1ecf1;
    border-radius: 8px;
    padding: 8px;
    transition: all 0.3s ease;
}

.day-column.drag-over {
    background: #d4edda;
    border-color: #198754;
    border-style: solid;
    box-shadow: inset 0 0 20px rgba(25,135,84,0.1);
}

.day-header {
    font-weight: bold;
    color: #2c5530;
    margin-bottom: 8px;
    font-size: 0.9rem;
    text-align: center;
    padding: 6px;
    background: rgba(25,135,84,0.1);
    border-radius: 6px;
}

/* Obras alocadas (dropadas) */
.allocated-obra {
    background: linear-gradient(135deg, #198754, #28a745);
    color: white;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    position: relative;
    min-height: 44px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.allocated-obra:hover {
    background: linear-gradient(135deg, #28a745, #34ce57);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(25,135,84,0.3);
}

.obra-nome {
    font-weight: bold;
    margin-bottom: 2px;
}

.obra-turno {
    font-size: 0.75rem;
    opacity: 0.9;
}

.funcionarios-count {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
}

/* Bot√µes de a√ß√£o r√°pida */
.quick-actions {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.action-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #198754;
    color: white;
    border: none;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(25,135,84,0.3);
}

.action-btn:hover {
    background: #28a745;
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(25,135,84,0.4);
}

/* Navega√ß√£o de semana */
.week-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    background: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.week-nav button {
    background: #198754;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s ease;
}

.week-nav button:hover {
    background: #28a745;
}

.current-week {
    font-weight: bold;
    color: #2c5530;
    font-size: 1.1rem;
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #198754;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    transform: translate(-50%, -50%);
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Responsividade progressiva */
@media (max-width: 768px) {
    .week-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .obras-sidebar {
        max-height: 200px;
        position: static;
        order: 2;
    }
    
    .days-grid {
        grid-template-columns: repeat(2, 1fr);
        order: 1;
    }
    
    .equipe-header {
        padding: 12px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 480px) {
    .days-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-number {
        font-size: 1.4rem;
    }
    
    .equipe-container {
        padding: 4px;
    }
}

/* Estados visuais para feedback t√°til */
.obra-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.allocated-obra.removing {
    animation: slideOut 0.3s ease forwards;
}

@keyframes slideOut {
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Melhor contraste para text legibility */
.day-header {
    color: #000;
    font-weight: 600;
}

.obra-nome {
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="equipe-container">
    <!-- Header com estat√≠sticas r√°pidas -->
    <div class="equipe-header">
        <h2>üìã Gest√£o de Equipe - Canteiro Otimizado</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-number">{{ stats.total_obras }}</span>
                <span class="stat-label">Obras</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ stats.total_alocacoes_semana }}</span>
                <span class="stat-label">Aloca√ß√µes</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ stats.funcionarios_alocados }}</span>
                <span class="stat-label">Funcion√°rios</span>
            </div>
        </div>
    </div>

    <!-- Navega√ß√£o de semana -->
    <div class="week-nav">
        <button onclick="navigateWeek(-1)">‚óÄ Anterior</button>
        <span class="current-week">Semana de {{ monday.strftime('%d/%m') }} a {{ friday.strftime('%d/%m') }}</span>
        <button onclick="navigateWeek(1)">Pr√≥xima ‚ñ∂</button>
    </div>

    <!-- Grid principal: Sidebar + Dias -->
    <div class="week-grid">
        <!-- Sidebar: Lista de obras para arrastar -->
        <div class="obras-sidebar">
            <div class="obras-title">üèóÔ∏è Obras Dispon√≠veis</div>
            <div id="obras-list">
                {% for obra in obras %}
                <div class="obra-item" 
                     data-obra-id="{{ obra.id }}"
                     data-obra-nome="{{ obra.nome }}"
                     data-obra-codigo="{{ obra.codigo }}">
                    <strong>{{ obra.codigo }}</strong><br>
                    <small>{{ obra.nome[:20] }}...</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Grid dos dias da semana -->
        <div class="days-grid">
            {% set weekdays = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'] %}
            {% for day_index in range(5) %}
            <div class="day-column" 
                 data-day="{{ day_index }}"
                 data-date="{{ week_grid[day_index]['date'].strftime('%Y-%m-%d') }}">
                
                <div class="day-header">
                    {{ weekdays[day_index] }}<br>
                    <small>{{ week_grid[day_index]['date_str'] }}</small>
                </div>

                <!-- Obras j√° alocadas neste dia -->
                <div class="allocated-obras" data-day="{{ day_index }}">
                    {% for allocation in week_grid[day_index]['allocations'] %}
                    <div class="allocated-obra" 
                         data-allocation-id="{{ allocation.id }}"
                         onclick="openFuncionarios({{ allocation.id }})">
                        
                        <div class="obra-nome">{{ allocation.obra.codigo }}</div>
                        <div class="obra-turno">
                            {{ allocation.turno_inicio.strftime('%H:%M') if allocation.turno_inicio else '08:00' }} - 
                            {{ allocation.turno_fim.strftime('%H:%M') if allocation.turno_fim else '17:00' }}
                        </div>
                        
                        <div class="funcionarios-count">{{ allocation.funcionarios_count }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Bot√µes de a√ß√£o r√°pida -->
    <div class="quick-actions">
        <button class="action-btn" onclick="refreshWeek()" title="Atualizar">
            üîÑ
        </button>
        <button class="action-btn" onclick="goToToday()" title="Hoje">
            üìÖ
        </button>
    </div>
</div>

<!-- JavaScript drag & drop otimizado -->
<script>
// ===================================
// SISTEMA DRAG & DROP LEAN
// Performance cr√≠tica para canteiro
// ===================================

let currentWeekStart = '{{ monday.strftime("%Y-%m-%d") }}';
let draggedElement = null;

// Inicializar drag & drop nas obras
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    console.log('üöÄ Sistema EQUIPE inicializado - Canteiro ready!');
});

function initializeDragAndDrop() {
    // Obras sidebar - fonte para drag
    const obrasList = document.getElementById('obras-list');
    if (obrasList) {
        new Sortable(obrasList, {
            group: {
                name: 'obras',
                pull: 'clone', // Clona em vez de mover
                put: false     // N√£o aceita drops
            },
            sort: false,       // N√£o reordena sidebar
            animation: 150,
            ghostClass: 'obra-item',
            chosenClass: 'dragging',
            onStart: function(evt) {
                console.log('üü¢ Drag iniciado:', evt.item.dataset.obraNome);
            }
        });
    }

    // Dias da semana - destino para drop
    document.querySelectorAll('.allocated-obras').forEach(dayContainer => {
        new Sortable(dayContainer, {
            group: {
                name: 'obras',
                pull: false,    // N√£o permite arrastar para fora
                put: true       // Aceita drops
            },
            animation: 200,
            ghostClass: 'allocated-obra',
            onAdd: function(evt) {
                // Nova obra dropada neste dia
                const obraElement = evt.item;
                const dayDate = evt.to.closest('.day-column').dataset.date;
                const obraId = obraElement.dataset.obraId;
                const obraNome = obraElement.dataset.obraNome;
                
                console.log(`üü° Drop: ${obraNome} ‚Üí ${dayDate}`);
                
                // Criar aloca√ß√£o via API
                createAllocation(obraId, dayDate, obraElement);
            },
            onRemove: function(evt) {
                // Obra removida (deletada)
                const allocationId = evt.item.dataset.allocationId;
                if (allocationId) {
                    console.log('üî¥ Removendo aloca√ß√£o:', allocationId);
                    deleteAllocation(allocationId);
                }
            }
        });
    });
}

// ===================================
// API CALLS - R√ÅPIDAS E DIRETAS
// ===================================

async function createAllocation(obraId, dataAlocacao, elemento) {
    try {
        elemento.classList.add('loading');
        
        const response = await fetch('/equipe/api/allocations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                obra_id: parseInt(obraId),
                data_alocacao: dataAlocacao,
                turno_inicio: '08:00',
                turno_fim: '17:00',
                nota: ''
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            // Transformar em obra alocada
            elemento.className = 'allocated-obra';
            elemento.dataset.allocationId = result.id;
            elemento.innerHTML = `
                <div class="obra-nome">${elemento.dataset.obraCodigo || elemento.dataset.obraNome}</div>
                <div class="obra-turno">08:00 - 17:00</div>
                <div class="funcionarios-count">0</div>
            `;
            elemento.onclick = () => openFuncionarios(result.id);
            
            console.log('‚úÖ Aloca√ß√£o criada:', result.id);
            showToast('Obra alocada com sucesso!', 'success');
            
        } else {
            throw new Error(result.error || 'Erro ao criar aloca√ß√£o');
        }
    } catch (error) {
        console.error('‚ùå Erro create allocation:', error);
        showToast(error.message, 'error');
        
        // Remover elemento em caso de erro
        elemento.remove();
    } finally {
        elemento.classList.remove('loading');
    }
}

async function deleteAllocation(allocationId) {
    try {
        const response = await fetch(`/equipe/api/allocations/${allocationId}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        
        if (response.ok) {
            console.log('‚úÖ Aloca√ß√£o removida:', allocationId);
            showToast('Obra removida da semana', 'info');
        } else {
            throw new Error(result.error || 'Erro ao remover aloca√ß√£o');
        }
    } catch (error) {
        console.error('‚ùå Erro delete allocation:', error);
        showToast(error.message, 'error');
    }
}

// ===================================
// NAVEGA√á√ÉO E UTILIT√ÅRIOS
// ===================================

function navigateWeek(direction) {
    const currentDate = new Date(currentWeekStart);
    currentDate.setDate(currentDate.getDate() + (direction * 7));
    
    const newWeekStart = currentDate.toISOString().split('T')[0];
    window.location.href = `/equipe/alocacao?week=${newWeekStart}`;
}

function goToToday() {
    window.location.href = '/equipe/alocacao';
}

function refreshWeek() {
    window.location.reload();
}

function openFuncionarios(allocationId) {
    window.location.href = `/equipe/funcionarios/${allocationId}`;
}

// ===================================
// FEEDBACK VISUAL
// ===================================

function showToast(message, type = 'info') {
    // Toast simples sem depend√™ncias
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#198754' : '#17a2b8'};
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
        max-width: 300px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Haptic feedback para dispositivos m√≥veis
function hapticFeedback(type = 'impact') {
    if (navigator.vibrate) {
        const patterns = {
            'impact': [10],
            'success': [10, 50, 10],
            'error': [100, 30, 100]
        };
        navigator.vibrate(patterns[type] || patterns.impact);
    }
}

// ===================================
// PWA E PERFORMANCE
// ===================================

// Service Worker para funcionamento offline (futuro)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
}

// Preload da pr√≥xima semana para performance
window.addEventListener('load', () => {
    const nextWeek = new Date(currentWeekStart);
    nextWeek.setDate(nextWeek.getDate() + 7);
    const nextWeekUrl = `/equipe/alocacao?week=${nextWeek.toISOString().split('T')[0]}`;
    
    // Prefetch silencioso
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = nextWeekUrl;
    document.head.appendChild(link);
});

console.log('üîß EQUIPE Drag&Drop System initialized - Mobile optimized for construction sites');
</script>
{% endblock %}