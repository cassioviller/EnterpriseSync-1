{% extends "base.html" %}

{% block title %}Novo RDO - Sistema SIGE{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header do RDO -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-clipboard-list"></i> Novo RDO
                        </h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light btn-sm" onclick="voltarListagem()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="salvarRascunho()">
                                <i class="fas fa-save"></i> Salvar Rascunho
                            </button>
                            <button class="btn btn-success btn-sm" onclick="finalizarRDO()">
                                <i class="fas fa-check"></i> Finalizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="form_rdo">
        <!-- Se√ß√£o 1: Informa√ß√µes Gerais -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informa√ß√µes Gerais</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Data do Relat√≥rio *</label>
                                <input type="date" class="form-control" id="data_relatorio" name="data_relatorio" required>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Obra *</label>
                                <select class="form-select" id="obra_select" name="obra_id" required>
                                    <option value="">Carregando obras...</option>
                                </select>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Selecione a obra para este RDO
                                </small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tempo Manh√£</label>
                                <select class="form-select" id="tempo_manha" name="tempo_manha">
                                    <option value="">Selecione...</option>
                                    <option value="ensolarado">‚òÄÔ∏è Ensolarado</option>
                                    <option value="nublado">‚òÅÔ∏è Nublado</option>
                                    <option value="parcialmente_nublado">‚õÖ Parcialmente Nublado</option>
                                    <option value="chuvoso">üåßÔ∏è Chuvoso</option>
                                    <option value="garoa">üå¶Ô∏è Garoa</option>
                                    <option value="tempestade">‚õàÔ∏è Tempestade</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tempo Tarde</label>
                                <select class="form-select" id="tempo_tarde" name="tempo_tarde">
                                    <option value="">Selecione...</option>
                                    <option value="ensolarado">‚òÄÔ∏è Ensolarado</option>
                                    <option value="nublado">‚òÅÔ∏è Nublado</option>
                                    <option value="parcialmente_nublado">‚õÖ Parcialmente Nublado</option>
                                    <option value="chuvoso">üåßÔ∏è Chuvoso</option>
                                    <option value="garoa">üå¶Ô∏è Garoa</option>
                                    <option value="tempestade">‚õàÔ∏è Tempestade</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tempo Noite</label>
                                <select class="form-select" id="tempo_noite" name="tempo_noite">
                                    <option value="">Selecione...</option>
                                    <option value="ensolarado">‚òÄÔ∏è Ensolarado</option>
                                    <option value="nublado">‚òÅÔ∏è Nublado</option>
                                    <option value="parcialmente_nublado">‚õÖ Parcialmente Nublado</option>
                                    <option value="chuvoso">üåßÔ∏è Chuvoso</option>
                                    <option value="garoa">üå¶Ô∏è Garoa</option>
                                    <option value="tempestade">‚õàÔ∏è Tempestade</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 2: Funcion√°rios -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users"></i> Funcion√°rios</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="adicionarFuncionario()">
                            <i class="fas fa-plus"></i> Adicionar Funcion√°rio
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="container_funcionarios">
                            <!-- Funcion√°rios ser√£o adicionados aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 3: Observa√ß√µes -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observa√ß√µes</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Observa√ß√µes Meteorol√≥gicas</label>
                                <textarea class="form-control" id="observacoes_meteorologicas" name="observacoes_meteorologicas" rows="3" placeholder="Detalhes sobre as condi√ß√µes clim√°ticas..."></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Coment√°rio Geral</label>
                                <textarea class="form-control" id="comentario_geral" name="comentario_geral" rows="3" placeholder="Coment√°rios gerais sobre o dia de trabalho..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Template para funcion√°rio -->
    <div id="template_funcionario" class="funcionario-item mb-3" style="display: none;">
        <div class="card border-info">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label class="form-label">Funcion√°rio *</label>
                        <select class="form-select funcionario-select" name="funcionario_id" required>
                            <option value="">Carregando funcion√°rios...</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Entrada</label>
                        <input type="time" class="form-control hora-entrada" name="hora_entrada">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Sa√≠da</label>
                        <input type="time" class="form-control hora-saida" name="hora_saida">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Total Horas</label>
                        <input type="number" class="form-control total-horas" name="total_horas" step="0.1" readonly>
                    </div>
                    <div class="col-md-1 mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerFuncionario(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="presente" checked>
                            <label class="form-check-label">
                                Presente no trabalho
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ===== INICIALIZA√á√ÉO PRINCIPAL =====
$(document).ready(function() {
    console.log("Inicializando RDO v6.3...");
    
    // Aguardar carregamento completo do Select2
    setTimeout(function() {
        if (typeof $.fn.select2 !== 'undefined') {
            inicializarDropdownObra();
            inicializarEventosFormulario();
            console.log("RDO v6.3 inicializado com sucesso!");
        } else {
            console.error("Select2 n√£o foi carregado!");
        }
    }, 1000);
});

// ===== DROPDOWN DE OBRAS =====
function inicializarDropdownObra() {
    const obraSelect = $("#obra_select");
    console.log("Inicializando dropdown de obras...");
    
    // Carregar todas as obras via AJAX
    $.ajax({
        url: "/api/obras/todas",
        method: "GET",
        success: function(obras) {
            console.log("Obras carregadas:", obras.length);
            
            // Limpar e popular
            obraSelect.empty().append('<option value="">Selecione a obra...</option>');
            
            obras.forEach(function(obra) {
                const opcao = new Option(
                    `${obra.nome} (${obra.codigo})`, 
                    obra.id
                );
                obraSelect.append(opcao);
            });
            
            // Inicializar Select2
            obraSelect.select2({
                placeholder: "Selecione a obra...",
                allowClear: true,
                width: '100%'
            });
        },
        error: function(xhr, status, error) {
            console.error("Erro ao carregar obras:", error);
            obraSelect.empty().append('<option value="">Erro ao carregar obras</option>');
        }
    });
}

// ===== FUNCION√ÅRIOS =====
function adicionarFuncionario() {
    const container = document.getElementById("container_funcionarios");
    const template = document.getElementById("template_funcionario");
    
    if (!template) {
        console.error("Template de funcion√°rio n√£o encontrado!");
        return;
    }
    
    const novoItem = template.cloneNode(true);
    novoItem.style.display = "block";
    novoItem.id = `funcionario_${Date.now()}`;
    
    container.appendChild(novoItem);
    
    // Inicializar Select2 no novo funcion√°rio
    inicializarFuncionarioSelect(novoItem);
    
    console.log("Funcion√°rio adicionado ao RDO");
}

function inicializarFuncionarioSelect(container) {
    const select = $(container).find(".funcionario-select");
    
    // Carregar funcion√°rios via AJAX
    $.ajax({
        url: "/api/funcionarios/todos",
        method: "GET",
        success: function(funcionarios) {
            console.log("Funcion√°rios carregados:", funcionarios.length);
            
            // Popular select
            select.empty().append('<option value="">Selecione o funcion√°rio...</option>');
            
            funcionarios.forEach(function(func) {
                select.append(new Option(
                    `${func.nome} (${func.codigo})`, 
                    func.id
                ));
            });
            
            // Inicializar Select2
            select.select2({
                placeholder: "Digite para buscar funcion√°rio...",
                allowClear: true,
                width: '100%'
            });
            
            // Evento de sele√ß√£o
            select.on("select2:select", function(e) {
                const funcionarioId = e.params.data.id;
                carregarDadosPonto(container, funcionarioId);
            });
        },
        error: function(xhr, status, error) {
            console.error("Erro ao carregar funcion√°rios:", error);
            select.empty().append('<option value="">Erro ao carregar funcion√°rios</option>');
        }
    });
}

function carregarDadosPonto(container, funcionarioId) {
    const dataRDO = $("#data_relatorio").val();
    
    if (!funcionarioId || !dataRDO) {
        habilitarPreenchimentoManual(container);
        return;
    }
    
    // Buscar dados do ponto
    const url = `/api/ponto/funcionario/${funcionarioId}/data/${dataRDO}`;
    
    $.ajax({
        url: url,
        method: "GET",
        success: function(data) {
            if (data.success && data.registro_ponto) {
                preencherDadosPonto(container, data.registro_ponto);
                mostrarMensagem(container, "Dados do ponto carregados automaticamente", "success");
            } else {
                habilitarPreenchimentoManual(container);
                mostrarMensagem(container, "Ponto n√£o encontrado - preencha manualmente", "warning");
            }
        },
        error: function(xhr, status, error) {
            console.error("Erro ao buscar ponto:", error);
            habilitarPreenchimentoManual(container);
            mostrarMensagem(container, "Erro ao buscar ponto - preencha manualmente", "warning");
        }
    });
}

function preencherDadosPonto(container, registro) {
    const campos = {
        ".hora-entrada": registro.hora_entrada || "",
        ".hora-saida": registro.hora_saida || "",
        ".total-horas": registro.horas_trabalhadas || "0.0"
    };
    
    // Preencher campos
    Object.keys(campos).forEach(selector => {
        const campo = container.querySelector(selector);
        if (campo) {
            campo.value = campos[selector];
            campo.readOnly = true;
        }
    });
    
    // Marcar como presente
    const checkbox = container.querySelector('input[type="checkbox"]');
    if (checkbox) checkbox.checked = true;
}

function habilitarPreenchimentoManual(container) {
    const campos = [".hora-entrada", ".hora-saida", ".total-horas"];
    
    campos.forEach(selector => {
        const campo = container.querySelector(selector);
        if (campo) {
            campo.value = "";
            campo.readOnly = false;
        }
    });
    
    const checkbox = container.querySelector('input[type="checkbox"]');
    if (checkbox) checkbox.checked = false;
}

function mostrarMensagem(container, mensagem, tipo) {
    // Remover mensagem anterior
    const mensagemAnterior = container.querySelector(".mensagem-status");
    if (mensagemAnterior) {
        mensagemAnterior.remove();
    }
    
    // Criar nova mensagem
    const div = document.createElement("div");
    div.className = `alert alert-${tipo} alert-sm mt-2 mensagem-status`;
    div.innerHTML = `<small>${mensagem}</small>`;
    
    const cardBody = container.querySelector(".card-body");
    if (cardBody) {
        cardBody.appendChild(div);
        
        // Remover ap√≥s 5 segundos
        setTimeout(() => {
            if (div.parentNode) {
                div.remove();
            }
        }, 5000);
    }
}

function removerFuncionario(button) {
    const funcionarioItem = button.closest('.funcionario-item');
    if (funcionarioItem) {
        funcionarioItem.remove();
        console.log("Funcion√°rio removido do RDO");
    }
}

// ===== EVENTOS DO FORMUL√ÅRIO =====
function inicializarEventosFormulario() {
    // Valida√ß√£o de data
    $("#data_relatorio").on("change", function() {
        const data = $(this).val();
        if (data) {
            const dataObj = new Date(data);
            const hoje = new Date();
            
            if (dataObj > hoje) {
                alert("A data do relat√≥rio n√£o pode ser futura!");
                $(this).val("");
            }
        }
    });
    
    // Calcular horas automaticamente
    $(document).on("change", ".hora-entrada, .hora-saida", function() {
        const container = $(this).closest(".funcionario-item");
        calcularHorasAutomaticamente(container[0]);
    });
}

function calcularHorasAutomaticamente(container) {
    const horaEntrada = container.querySelector(".hora-entrada").value;
    const horaSaida = container.querySelector(".hora-saida").value;
    const totalHoras = container.querySelector(".total-horas");
    
    if (horaEntrada && horaSaida && totalHoras && !totalHoras.readOnly) {
        try {
            const entrada = new Date(`2000-01-01T${horaEntrada}:00`);
            const saida = new Date(`2000-01-01T${horaSaida}:00`);
            
            if (saida > entrada) {
                const diffMs = saida - entrada;
                const diffHours = diffMs / (1000 * 60 * 60);
                
                // Considerar intervalo de almo√ßo (1 hora)
                const horasLiquidas = Math.max(0, diffHours - 1);
                
                totalHoras.value = horasLiquidas.toFixed(1);
            }
        } catch (e) {
            console.error("Erro ao calcular horas:", e);
        }
    }
}

// ===== ENVIO DO FORMUL√ÅRIO =====
function salvarRascunho() {
    const formData = coletarDadosFormulario();
    
    $.ajax({
        url: "/rdo/salvar",
        method: "POST",
        data: JSON.stringify(formData),
        contentType: "application/json",
        success: function(response) {
            if (response.success) {
                alert("RDO salvo como rascunho!");
                window.location.href = "/rdo";
            } else {
                alert("Erro ao salvar: " + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error("Erro ao salvar RDO:", error);
            alert("Erro de conex√£o ao salvar RDO");
        }
    });
}

function finalizarRDO() {
    if (!validarFormulario()) {
        return;
    }
    
    const formData = coletarDadosFormulario();
    formData.status = "finalizado";
    
    $.ajax({
        url: "/rdo/finalizar",
        method: "POST",
        data: JSON.stringify(formData),
        contentType: "application/json",
        success: function(response) {
            if (response.success) {
                alert("RDO finalizado com sucesso!");
                window.location.href = "/rdo";
            } else {
                alert("Erro ao finalizar: " + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error("Erro ao finalizar RDO:", error);
            alert("Erro de conex√£o ao finalizar RDO");
        }
    });
}

function coletarDadosFormulario() {
    const funcionarios = [];
    document.querySelectorAll('.funcionario-item[style*="block"]').forEach(item => {
        const funcionarioId = item.querySelector('.funcionario-select').value;
        if (funcionarioId) {
            funcionarios.push({
                funcionario_id: funcionarioId,
                hora_entrada: item.querySelector('.hora-entrada').value,
                hora_saida: item.querySelector('.hora-saida').value,
                total_horas: item.querySelector('.total-horas').value,
                presente: item.querySelector('input[type="checkbox"]').checked
            });
        }
    });
    
    return {
        data_relatorio: $("#data_relatorio").val(),
        obra_id: $("#obra_select").val(),
        tempo_manha: $("#tempo_manha").val(),
        tempo_tarde: $("#tempo_tarde").val(),
        tempo_noite: $("#tempo_noite").val(),
        observacoes_meteorologicas: $("#observacoes_meteorologicas").val(),
        comentario_geral: $("#comentario_geral").val(),
        funcionarios: funcionarios
    };
}

function validarFormulario() {
    const dataRelatorio = $("#data_relatorio").val();
    const obraId = $("#obra_select").val();
    
    if (!dataRelatorio) {
        alert("Por favor, selecione a data do relat√≥rio!");
        return false;
    }
    
    if (!obraId) {
        alert("Por favor, selecione a obra!");
        return false;
    }
    
    // Verificar se h√° pelo menos um funcion√°rio
    const funcionarios = document.querySelectorAll(".funcionario-item[style*='block']");
    if (funcionarios.length === 0) {
        alert("Adicione pelo menos um funcion√°rio ao RDO!");
        return false;
    }
    
    // Verificar se os funcion√°rios t√™m dados v√°lidos
    let funcionariosValidos = 0;
    funcionarios.forEach(func => {
        const select = func.querySelector(".funcionario-select");
        if (select && select.value) {
            funcionariosValidos++;
        }
    });
    
    if (funcionariosValidos === 0) {
        alert("Selecione pelo menos um funcion√°rio v√°lido!");
        return false;
    }
    
    return true;
}

// ===== UTILIT√ÅRIOS =====
function voltarListagem() {
    window.location.href = "/rdo";
}

// Log para debug
console.log("JavaScript RDO v6.3 carregado com corre√ß√µes cr√≠ticas");
</script>
{% endblock %}