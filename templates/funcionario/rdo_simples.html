{% extends "base.html" %}

{% block title %}RDO - Relat√≥rio Di√°rio de Obra{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0d6efd">
<style>
:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --border-color: #dee2e6;
}

.rdo-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.rdo-header {
    background: linear-gradient(135deg, var(--primary-color), #0056b3);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.rdo-section {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-body {
    padding: 20px;
}

.subatividade-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
}

.subatividade-row:last-child {
    border-bottom: none;
}

.subatividade-nome {
    flex: 1;
    font-weight: 500;
}

.subatividade-input {
    width: 80px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    text-align: center;
}

.funcionario-selecionado {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
}

.dropdown-funcionarios {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    max-height: 200px;
    overflow-y: auto;
}

.funcionario-option {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}

.funcionario-option:hover {
    background: #f8f9fa;
}

.funcionario-option:last-child {
    border-bottom: none;
}

.btn-remove {
    color: var(--danger-color);
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .rdo-container {
        padding: 10px;
    }
    
    .rdo-header {
        padding: 15px;
    }
    
    .section-body {
        padding: 15px;
    }
    
    .subatividade-row {
        padding: 10px 12px;
    }
    
    .subatividade-input {
        width: 60px;
        padding: 6px;
        font-size: 14px;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 10px;
    }
    
    .d-flex.gap-2 > div {
        width: 100%;
    }
    
    .form-control, .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
    }
}

@media (max-width: 480px) {
    .subatividade-input {
        width: 50px;
        padding: 4px;
        font-size: 13px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="rdo-container">
    <!-- Header -->
    <div class="rdo-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-clipboard-list"></i> RDO - Relat√≥rio Di√°rio de Obra</h2>
                <p class="mb-0 opacity-75">Sistema simplificado e otimizado</p>
            </div>
            <a href="{{ url_for('main.funcionario_dashboard') }}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Formul√°rio Principal -->
    <form id="rdo-form" method="POST">
        <!-- Informa√ß√µes B√°sicas -->
        <div class="rdo-section">
            <div class="section-header">
                <h5><i class="fas fa-info-circle"></i> Informa√ß√µes B√°sicas</h5>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-building text-primary"></i> Obra *
                        </label>
                        <select name="obra_id" id="obra_id" class="form-select" required onchange="carregarServicos(this.value)">
                            <option value="">Selecione uma obra</option>
                            {% for obra in obras %}
                            <option value="{{ obra.id }}">{{ obra.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar text-primary"></i> Data do Relat√≥rio *
                        </label>
                        <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-comment text-primary"></i> Coment√°rio Geral
                    </label>
                    <textarea name="comentario_geral" class="form-control" rows="3" 
                              placeholder="Observa√ß√µes gerais sobre o trabalho do dia..."></textarea>
                </div>
            </div>
        </div>

        <!-- Condi√ß√µes Clim√°ticas -->
        <div class="rdo-section">
            <div class="section-header">
                <h5><i class="fas fa-cloud-sun"></i> Condi√ß√µes Clim√°ticas</h5>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Clima</label>
                        <select name="clima" class="form-select">
                            <option value="">Selecione...</option>
                            <option value="Ensolarado">‚òÄÔ∏è Ensolarado</option>
                            <option value="Nublado">‚òÅÔ∏è Nublado</option>
                            <option value="Chuvoso">üåßÔ∏è Chuvoso</option>
                            <option value="Parcialmente Nublado">‚õÖ Parcialmente Nublado</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Temperatura</label>
                        <input type="text" name="temperatura" class="form-control" placeholder="Ex: 25¬∞C">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Observa√ß√µes</label>
                        <textarea name="observacoes_climaticas" class="form-control" rows="2" 
                                  placeholder="Detalhes sobre o clima..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Servi√ßos e Subatividades -->
        <div class="rdo-section">
            <div class="section-header">
                <h5><i class="fas fa-tasks"></i> Servi√ßos e Subatividades</h5>
            </div>
            <div class="section-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="validarFormulario()">
                        <i class="fas fa-check-circle"></i> Validar Dados
                    </button>
                </div>

                <div id="servicos-container">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-building fa-3x mb-3"></i>
                        <h5>Selecione uma obra para carregar os servi√ßos</h5>
                        <p>Os servi√ßos dispon√≠veis ser√£o listados aqui automaticamente</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funcion√°rios -->
        <div class="rdo-section">
            <div class="section-header">
                <h5><i class="fas fa-users"></i> Funcion√°rios</h5>
            </div>
            <div class="section-body">
                <!-- Adicionar Funcion√°rio -->
                <div class="mb-3">
                    <div class="d-flex gap-2 align-items-end">
                        <div class="flex-1 position-relative">
                            <label class="form-label fw-bold">Selecionar Funcion√°rio</label>
                            <input type="text" 
                                   id="funcionario-search" 
                                   class="form-control" 
                                   placeholder="Digite o nome do funcion√°rio..."
                                   autocomplete="off">
                            <div id="funcionario-dropdown" class="dropdown-funcionarios" style="display: none;">
                                <!-- Lista de funcion√°rios ser√° carregada aqui -->
                            </div>
                        </div>
                        <div>
                            <label class="form-label fw-bold">Horas</label>
                            <input type="number" 
                                   id="horas-funcionario" 
                                   class="form-control" 
                                   style="width: 80px;"
                                   min="0" max="12" step="0.5" 
                                   placeholder="8">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="adicionarFuncionario()">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Funcion√°rios Selecionados -->
                <div id="funcionarios-selecionados">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p>Nenhum funcion√°rio adicionado</p>
                    </div>
                </div>
                
                <!-- Container original mantido para compatibilidade -->
                <div id="funcionarios-container" style="display: none;">
                    {% for funcionario in funcionarios %}
                    <div class="funcionario-item" data-id="{{ funcionario.id }}" data-nome="{{ funcionario.nome }}">
                        {{ funcionario.nome }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('main.funcionario_dashboard') }}'">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="salvarRascunho()">
                    <i class="fas fa-save"></i> Salvar Rascunho
                </button>
                <button type="submit" class="btn btn-success" id="btn-finalizar" disabled>
                    <i class="fas fa-check"></i> Finalizar RDO
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Notification Container -->
<div id="notifications" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

<script>
let servicosCarregados = [];
let funcionariosDisponiveis = [];
let funcionariosSelecionados = [];

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    // Definir data padr√£o
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data_relatorio').value = hoje;
    
    // Carregar funcion√°rios dispon√≠veis
    carregarFuncionarios();
    renderizarFuncionariosSelecionados();
    
    // Autocomplete funcion√°rios
    const funcionarioSearch = document.getElementById('funcionario-search');
    funcionarioSearch.addEventListener('input', function() {
        const termo = this.value.trim();
        const funcionarios = filtrarFuncionarios(termo);
        mostrarDropdownFuncionarios(funcionarios);
    });
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.position-relative')) {
            document.getElementById('funcionario-dropdown').style.display = 'none';
        }
    });
    
    // Enter para adicionar funcion√°rio
    document.getElementById('horas-funcionario').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            adicionarFuncionario();
        }
    });
    
    // Submit do formul√°rio
    document.getElementById('rdo-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const dados = coletarDados();
            dados.status = 'Finalizado';
            salvarRDO(dados);
        }
    });
});

// Carregar servi√ßos da obra
async function carregarServicos(obraId) {
    if (!obraId) {
        limparServicos();
        return;
    }
    
    try {
        const response = await fetch(`/api/test/rdo/servicos-obra/${obraId}`);
        const data = await response.json();
        
        if (response.ok) {
            servicosCarregados = data.servicos || [];
            renderizarServicos();
            mostrarNotificacao(`${servicosCarregados.length} servi√ßos carregados`, 'success');
        } else {
            throw new Error(data.error || 'Erro ao carregar servi√ßos');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao carregar servi√ßos da obra', 'danger');
        servicosCarregados = [];
    }
}

// Renderizar servi√ßos
function renderizarServicos() {
    const container = document.getElementById('servicos-container');
    
    if (servicosCarregados.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <h5>Nenhum servi√ßo encontrado</h5>
                <p>Esta obra n√£o possui servi√ßos cadastrados</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = servicosCarregados.map(servico => `
        <div class="mb-4">
            <h6 class="text-primary fw-bold mb-3">
                <i class="fas fa-cog"></i> ${servico.nome}
            </h6>
            ${servico.subatividades.map(sub => `
                <div class="subatividade-row">
                    <div class="subatividade-nome">
                        <i class="fas fa-check-circle text-success"></i> ${sub.nome}
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <input type="number" 
                               class="subatividade-input" 
                               name="subatividade_${sub.id}_percentual"
                               min="0" max="100" step="0.1" 
                               placeholder="0"
                               onchange="atualizarProgresso()">
                        <span class="text-muted">%</span>
                    </div>
                </div>
            `).join('')}
        </div>
    `).join('');
}

function limparServicos() {
    const container = document.getElementById('servicos-container');
    container.innerHTML = `
        <div class="text-center py-5 text-muted">
            <i class="fas fa-building fa-3x mb-3"></i>
            <h5>Selecione uma obra para carregar os servi√ßos</h5>
            <p>Os servi√ßos dispon√≠veis ser√£o listados aqui automaticamente</p>
        </div>
    `;
}

// Funcionalidades dos funcion√°rios
function carregarFuncionarios() {
    const funcionarios = document.querySelectorAll('#funcionarios-container .funcionario-item');
    funcionariosDisponiveis = Array.from(funcionarios).map(item => ({
        id: item.dataset.id,
        nome: item.dataset.nome
    }));
}

function filtrarFuncionarios(termo) {
    if (!termo) return [];
    
    const termoLower = termo.toLowerCase();
    return funcionariosDisponiveis.filter(func => 
        func.nome.toLowerCase().includes(termoLower)
    );
}

function mostrarDropdownFuncionarios(funcionarios) {
    const dropdown = document.getElementById('funcionario-dropdown');
    
    if (funcionarios.length === 0) {
        dropdown.style.display = 'none';
        return;
    }
    
    dropdown.innerHTML = funcionarios.map(func => `
        <div class="funcionario-option" onclick="selecionarFuncionarioDropdown('${func.id}', '${func.nome}')">
            <i class="fas fa-user text-primary"></i> ${func.nome}
        </div>
    `).join('');
    
    dropdown.style.display = 'block';
}

function selecionarFuncionarioDropdown(id, nome) {
    document.getElementById('funcionario-search').value = nome;
    document.getElementById('funcionario-dropdown').style.display = 'none';
}

function adicionarFuncionario() {
    const searchInput = document.getElementById('funcionario-search');
    const horasInput = document.getElementById('horas-funcionario');
    
    const nomeFuncionario = searchInput.value.trim();
    const horas = parseFloat(horasInput.value) || 0;
    
    if (!nomeFuncionario) {
        mostrarNotificacao('Selecione um funcion√°rio', 'warning');
        return;
    }
    
    if (horas <= 0 || horas > 12) {
        mostrarNotificacao('Informe as horas trabalhadas (0.5 a 12)', 'warning');
        return;
    }
    
    // Verificar se funcion√°rio j√° foi adicionado
    if (funcionariosSelecionados.find(f => f.nome === nomeFuncionario)) {
        mostrarNotificacao('Funcion√°rio j√° adicionado', 'warning');
        return;
    }
    
    // Encontrar o ID do funcion√°rio
    const funcionario = funcionariosDisponiveis.find(f => f.nome === nomeFuncionario);
    const funcionarioId = funcionario ? funcionario.id : Date.now();
    
    // Adicionar √† lista
    funcionariosSelecionados.push({
        id: funcionarioId,
        nome: nomeFuncionario,
        horas: horas
    });
    
    // Atualizar interface
    renderizarFuncionariosSelecionados();
    
    // Limpar campos
    searchInput.value = '';
    horasInput.value = '';
    
    mostrarNotificacao(`${nomeFuncionario} adicionado (${horas}h)`, 'success');
}

function removerFuncionario(index) {
    const funcionario = funcionariosSelecionados[index];
    funcionariosSelecionados.splice(index, 1);
    renderizarFuncionariosSelecionados();
    mostrarNotificacao(`${funcionario.nome} removido`, 'info');
}

function renderizarFuncionariosSelecionados() {
    const container = document.getElementById('funcionarios-selecionados');
    
    if (funcionariosSelecionados.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>Nenhum funcion√°rio adicionado</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = funcionariosSelecionados.map((func, index) => `
        <div class="funcionario-selecionado">
            <div>
                <i class="fas fa-user text-primary"></i> 
                <strong>${func.nome}</strong> - ${func.horas}h
                <input type="hidden" name="funcionario_${func.id}_nome" value="${func.nome}">
                <input type="hidden" name="funcionario_${func.id}_horas" value="${func.horas}">
            </div>
            <button type="button" class="btn-remove" onclick="removerFuncionario(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// Valida√ß√£o e salvamento
function validarFormulario() {
    const obraId = document.getElementById('obra_id').value;
    const dataRelatorio = document.getElementById('data_relatorio').value;
    
    if (!obraId) {
        mostrarNotificacao('Selecione uma obra', 'warning');
        return false;
    }
    
    if (!dataRelatorio) {
        mostrarNotificacao('Informe a data do relat√≥rio', 'warning');
        return false;
    }
    
    // Habilitar bot√£o finalizar se v√°lido
    document.getElementById('btn-finalizar').disabled = false;
    mostrarNotificacao('Formul√°rio validado com sucesso!', 'success');
    return true;
}

function coletarDados() {
    const formData = new FormData(document.getElementById('rdo-form'));
    const dados = {};
    
    for (let [key, value] of formData.entries()) {
        dados[key] = value;
    }
    
    return dados;
}

function salvarRascunho() {
    const dados = coletarDados();
    dados.status = 'Rascunho';
    console.log('Salvando rascunho:', dados);
    mostrarNotificacao('Rascunho salvo automaticamente', 'info');
}

function salvarRDO(dados) {
    console.log('Salvando RDO:', dados);
    mostrarNotificacao('RDO finalizado com sucesso!', 'success');
    
    // Redirecionar ap√≥s 2 segundos
    setTimeout(() => {
        window.location.href = "{{ url_for('main.funcionario_dashboard') }}";
    }, 2000);
}

function atualizarProgresso() {
    // Atualizar progresso geral se necess√°rio
    console.log('Progresso atualizado');
}

function mostrarNotificacao(mensagem, tipo = 'info') {
    const container = document.getElementById('notifications');
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${tipo} alert-dismissible`;
    notification.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    container.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}