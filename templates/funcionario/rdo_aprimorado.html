{% extends "base.html" %}

{% block title %}RDO Aprimorado - Sistema SIGE{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
/* RDO Aprimorado - Design Profissional */
:root {
    --primary-color: #0d6efd;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --info-color: #17a2b8;
    --light-bg: #f8f9fa;
    --border-color: #e9ecef;
    --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
    --shadow-medium: 0 4px 15px rgba(0,0,0,0.15);
    --transition-smooth: all 0.3s ease;
}

.rdo-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    background: var(--light-bg);
    min-height: 100vh;
}

/* Header melhorado */
.rdo-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 15px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-medium);
}

.rdo-header h2 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
}

.rdo-header .subtitle {
    font-size: 16px;
    opacity: 0.9;
    margin-top: 5px;
}

/* Progress indicator */
.progress-indicator {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-light);
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.progress-step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    background: var(--light-bg);
    transition: var(--transition-smooth);
    min-width: 140px;
    justify-content: center;
}

.progress-step.active {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
    box-shadow: var(--shadow-light);
}

.progress-step.completed {
    background: var(--success-color);
    color: white;
}

.progress-step-icon {
    font-size: 16px;
}

/* Form sections */
.form-section {
    background: white;
    border-radius: 15px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-light);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.section-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #6610f2 100%);
    color: white;
    padding: 20px 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.section-header:hover {
    background: linear-gradient(135deg, #0056b3 0%, #5a0eb3 100%);
}

.section-header h4 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
}

.section-toggle {
    font-size: 20px;
    transition: var(--transition-smooth);
}

.section-toggle.collapsed {
    transform: rotate(-90deg);
}

.section-body {
    padding: 25px;
    display: none;
}

.section-body.active {
    display: block;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Enhanced form controls */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-label .required {
    color: var(--danger-color);
    font-size: 14px;
}

.form-control-enhanced {
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 16px;
    transition: var(--transition-smooth);
    background: white;
    width: 100%;
}

.form-control-enhanced:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.15);
    outline: none;
}

/* Service cards */
.service-card {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 15px;
    margin-bottom: 20px;
    transition: var(--transition-smooth);
    overflow: hidden;
}

.service-card:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

.service-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}

.service-info h5 {
    margin: 0;
    color: var(--primary-color);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.service-badge {
    background: var(--primary-color);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.service-stats {
    display: flex;
    gap: 15px;
    font-size: 14px;
    color: #6c757d;
    margin-top: 5px;
}

.service-toggle-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.service-toggle-btn:hover {
    background: #0056b3;
    transform: scale(1.1);
}

/* Subactivities */
.subactivities-container {
    padding: 25px;
    background: #fafbfc;
    display: none;
}

.subactivities-container.active {
    display: block;
    animation: slideDown 0.3s ease-out;
}

.subactivity-item {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: var(--transition-smooth);
}

.subactivity-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-light);
}

.subactivity-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.subactivity-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 16px;
}

.percentage-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.percentage-input {
    width: 80px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 8px;
    text-align: center;
    font-weight: 600;
    transition: var(--transition-smooth);
}

.percentage-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
}

.progress-bar-container {
    width: 120px;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color) 0%, var(--info-color) 100%);
    transition: width 0.3s ease;
    border-radius: 4px;
}

/* Action buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding: 25px;
    background: var(--light-bg);
    border-top: 1px solid var(--border-color);
}

.btn-enhanced {
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: var(--transition-smooth);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    box-shadow: var(--shadow-light);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.btn-success {
    background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: white;
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

/* Loading states */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Notifications */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 10px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideInRight 0.4s ease;
    max-width: 400px;
}

.notification.success {
    background: var(--success-color);
}

.notification.error {
    background: var(--danger-color);
}

.notification.warning {
    background: var(--warning-color);
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Responsive design */
@media (max-width: 768px) {
    .rdo-container {
        padding: 15px;
    }
    
    .rdo-header {
        padding: 20px;
    }
    
    .rdo-header h2 {
        font-size: 24px;
    }
    
    .progress-steps {
        flex-direction: column;
        align-items: stretch;
    }
    
    .progress-step {
        min-width: auto;
    }
    
    .section-body {
        padding: 20px;
    }
    
    .service-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .subactivity-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .percentage-input-group {
        width: 100%;
        justify-content: space-between;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 10px;
    }
    
    .btn-enhanced {
        width: 100%;
        justify-content: center;
    }
}

/* Smooth transitions for collapsible elements */
.collapsible {
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}

.collapsible.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    overflow: hidden;
}
</style>
{% endblock %}

{% block content %}
<div class="rdo-container" data-user-id="{{ current_user.id }}" data-admin-id="{{ current_user.admin_id }}">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Header -->
    <div class="rdo-header">
        <h2>
            <i class="fas fa-clipboard-list"></i>
            RDO Aprimorado - Sistema Integrado
        </h2>
        <div class="subtitle">
            Relatório Diário de Obra com controle hierárquico de subatividades e herança automática de percentuais
        </div>
    </div>
    
    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-steps">
            <div class="progress-step active" data-step="1">
                <i class="fas fa-info-circle progress-step-icon"></i>
                <span>Dados Gerais</span>
            </div>
            <div class="progress-step" data-step="2">
                <i class="fas fa-cloud-sun progress-step-icon"></i>
                <span>Clima</span>
            </div>
            <div class="progress-step" data-step="3">
                <i class="fas fa-tasks progress-step-icon"></i>
                <span>Atividades</span>
            </div>
            <div class="progress-step" data-step="4">
                <i class="fas fa-users progress-step-icon"></i>
                <span>Mão de Obra</span>
            </div>
            <div class="progress-step" data-step="5">
                <i class="fas fa-tools progress-step-icon"></i>
                <span>Equipamentos</span>
            </div>
            <div class="progress-step" data-step="6">
                <i class="fas fa-check progress-step-icon"></i>
                <span>Finalizar</span>
            </div>
        </div>
    </div>
    
    <!-- Form -->
    <form id="rdo-form" method="POST" action="{{ url_for('main.funcionario_criar_rdo') }}">
        <!-- Seção 1: Dados Gerais -->
        <div class="form-section" data-section="1">
            <div class="section-header" onclick="toggleSection(this)">
                <h4>
                    <i class="fas fa-info-circle"></i>
                    Informações Gerais
                </h4>
                <i class="fas fa-chevron-down section-toggle"></i>
            </div>
            <div class="section-body active">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="obra_id">
                                <i class="fas fa-building"></i>
                                Obra <span class="required">*</span>
                            </label>
                            <select name="obra_id" id="obra_id" class="form-control-enhanced" required onchange="carregarServicosObra(this.value)">
                                <option value="">Selecione uma obra</option>
                                {% for obra in obras %}
                                <option value="{{ obra.id }}" {% if obra.id|string == request.args.get('obra_id') %}selected{% endif %}>
                                    {{ obra.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="data_relatorio">
                                <i class="fas fa-calendar"></i>
                                Data do Relatório <span class="required">*</span>
                            </label>
                            <input type="date" name="data_relatorio" id="data_relatorio" 
                                   class="form-control-enhanced" required 
                                   value="{{ date.today().strftime('%Y-%m-%d') if date else '' }}"
                                   max="{{ date.today().strftime('%Y-%m-%d') if date else '' }}">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="comentario_geral">
                        <i class="fas fa-comment"></i>
                        Comentário Geral
                    </label>
                    <textarea name="comentario_geral" id="comentario_geral" 
                              class="form-control-enhanced" rows="3"
                              placeholder="Observações gerais sobre o dia de trabalho..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Seção 2: Condições Climáticas -->
        <div class="form-section" data-section="2">
            <div class="section-header" onclick="toggleSection(this)">
                <h4>
                    <i class="fas fa-cloud-sun"></i>
                    Condições Climáticas
                </h4>
                <i class="fas fa-chevron-down section-toggle collapsed"></i>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label" for="clima">
                                <i class="fas fa-cloud"></i>
                                Clima
                            </label>
                            <select name="clima" id="clima" class="form-control-enhanced">
                                <option value="">Selecione...</option>
                                <option value="Ensolarado">Ensolarado</option>
                                <option value="Parcialmente nublado">Parcialmente nublado</option>
                                <option value="Nublado">Nublado</option>
                                <option value="Chuvoso">Chuvoso</option>
                                <option value="Tempestade">Tempestade</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label" for="temperatura">
                                <i class="fas fa-thermometer-half"></i>
                                Temperatura
                            </label>
                            <input type="text" name="temperatura" id="temperatura" 
                                   class="form-control-enhanced" placeholder="Ex: 25°C">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label" for="condicoes_climaticas">
                                <i class="fas fa-eye"></i>
                                Observações Climáticas
                            </label>
                            <textarea name="condicoes_climaticas" id="condicoes_climaticas" 
                                      class="form-control-enhanced" rows="3"
                                      placeholder="Detalhes sobre o clima..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seção 3: Atividades e Subatividades -->
        <div class="form-section" data-section="3">
            <div class="section-header" onclick="toggleSection(this)">
                <h4>
                    <i class="fas fa-tasks"></i>
                    Atividades e Subatividades
                    <span id="total-services-badge" class="service-badge" style="margin-left: 10px;">0 serviços</span>
                </h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" class="btn-enhanced btn-secondary" onclick="herdarPercentuaisAnteriores()" 
                            title="Herdar percentuais do RDO anterior">
                        <i class="fas fa-download"></i> Herdar Anterior
                    </button>
                    <i class="fas fa-chevron-down section-toggle collapsed"></i>
                </div>
            </div>
            <div class="section-body">
                <div id="services-container">
                    <div class="text-center" style="padding: 40px; color: #6c757d;">
                        <i class="fas fa-building" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h5>Selecione uma obra para carregar os serviços</h5>
                        <p>Os serviços e subatividades serão carregados automaticamente após a seleção da obra.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="{{ url_for('main.funcionario_dashboard') }}" class="btn-enhanced btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Dashboard
            </a>
            <button type="button" class="btn-enhanced btn-primary" onclick="salvarRascunho()">
                <i class="fas fa-save"></i>
                Salvar Rascunho
            </button>
            <button type="submit" class="btn-enhanced btn-success">
                <i class="fas fa-check"></i>
                Finalizar RDO
            </button>
        </div>
    </form>
</div>

<!-- Hidden data -->
<input type="hidden" id="current-user-admin-id" value="{{ current_user.admin_id }}">

<script>
// RDO Aprimorado - JavaScript
let servicosCarregados = [];
let subatividadesData = {};
let rdoId = null;

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    initializeRDO();
});

function initializeRDO() {
    console.log('Inicializando RDO Aprimorado...');
    
    // Verificar se obra já está selecionada
    const obraSelect = document.getElementById('obra_id');
    if (obraSelect.value) {
        carregarServicosObra(obraSelect.value);
    }
    
    // Event listeners
    setupEventListeners();
}

function setupEventListeners() {
    // Form submit
    document.getElementById('rdo-form').addEventListener('submit', function(e) {
        e.preventDefault();
        finalizarRDO();
    });
}

// Função para alternar seções colapsáveis
function toggleSection(headerElement) {
    const sectionBody = headerElement.nextElementSibling;
    const toggleIcon = headerElement.querySelector('.section-toggle');
    
    if (sectionBody.classList.contains('active')) {
        sectionBody.classList.remove('active');
        toggleIcon.classList.add('collapsed');
    } else {
        sectionBody.classList.add('active');
        toggleIcon.classList.remove('collapsed');
    }
}

// Carregar serviços da obra dinamicamente
async function carregarServicosObra(obraId) {
    if (!obraId) {
        document.getElementById('services-container').innerHTML = `
            <div class="text-center" style="padding: 40px; color: #6c757d;">
                <i class="fas fa-building" style="font-size: 48px; margin-bottom: 15px;"></i>
                <h5>Selecione uma obra para carregar os serviços</h5>
                <p>Os serviços e subatividades serão carregados automaticamente após a seleção da obra.</p>
            </div>
        `;
        document.getElementById('total-services-badge').textContent = '0 serviços';
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch(`/api/rdo/servicos-obra/${obraId}`);
        const data = await response.json();
        
        if (data.success) {
            servicosCarregados = data.servicos;
            renderizarServicos(data.servicos);
            document.getElementById('total-services-badge').textContent = `${data.servicos.length} serviços`;
            showNotification('Serviços carregados com sucesso!', 'success');
        } else {
            showNotification(data.error || 'Erro ao carregar serviços', 'error');
        }
    } catch (error) {
        console.error('Erro ao carregar serviços:', error);
        showNotification('Erro ao conectar com o servidor', 'error');
    } finally {
        hideLoading();
    }
}

// Renderizar serviços e subatividades
function renderizarServicos(servicos) {
    const container = document.getElementById('services-container');
    
    if (servicos.length === 0) {
        container.innerHTML = `
            <div class="text-center" style="padding: 40px; color: #6c757d;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                <h5>Nenhum serviço encontrado</h5>
                <p>Esta obra não possui serviços cadastrados.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    servicos.forEach((servico, index) => {
        const servicoId = `servico-${servico.id}`;
        
        html += `
            <div class="service-card" data-servico-id="${servico.id}">
                <div class="service-header" onclick="toggleServiceSubactivities('${servicoId}')">
                    <div class="service-info">
                        <h5>
                            <i class="fas fa-cogs"></i>
                            ${servico.nome}
                        </h5>
                        <div class="service-stats">
                            <span><i class="fas fa-tag"></i> ${servico.categoria || 'Sem categoria'}</span>
                            <span><i class="fas fa-chart-pie"></i> ${servico.percentual_obra}% concluído na obra</span>
                            <span><i class="fas fa-list"></i> ${servico.subatividades.length} subatividades</span>
                        </div>
                    </div>
                    <button type="button" class="service-toggle-btn" data-toggle="${servicoId}">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <div class="subactivities-container" id="${servicoId}">
                    ${renderizarSubatividades(servico.subatividades, servico.id)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Renderizar subatividades de um serviço
function renderizarSubatividades(subatividades, servicoId) {
    if (subatividades.length === 0) {
        return `
            <div class="text-center" style="padding: 20px; color: #6c757d;">
                <i class="fas fa-info-circle"></i>
                <p>Este serviço não possui subatividades cadastradas.</p>
            </div>
        `;
    }
    
    let html = '<h6 style="margin-bottom: 20px; color: #495057; font-weight: 600;">Subatividades:</h6>';
    
    subatividades.forEach((sub, index) => {
        html += `
            <div class="subactivity-item" data-subatividade-id="${sub.id}" data-servico-id="${servicoId}">
                <div class="subactivity-header">
                    <div>
                        <div class="subactivity-name">${sub.nome}</div>
                        ${sub.descricao ? `<small class="text-muted">${sub.descricao}</small>` : ''}
                    </div>
                    <div class="percentage-input-group">
                        <input type="number" 
                               class="percentage-input" 
                               min="0" max="100" step="0.1" 
                               value="0"
                               onchange="updateProgressBar(this)"
                               placeholder="0"
                               data-servico-id="${servicoId}"
                               data-subatividade-id="${sub.id}">
                        <span style="color: #6c757d;">%</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <textarea class="form-control-enhanced" 
                              rows="2" 
                              placeholder="Observações técnicas desta subatividade..."
                              data-servico-id="${servicoId}"
                              data-subatividade-id="${sub.id}"></textarea>
                </div>
            </div>
        `;
    });
    
    return html;
}

// Alternar visibilidade das subatividades
function toggleServiceSubactivities(servicoId) {
    const container = document.getElementById(servicoId);
    const toggleBtn = document.querySelector(`[data-toggle="${servicoId}"] i`);
    
    if (container.classList.contains('active')) {
        container.classList.remove('active');
        toggleBtn.style.transform = 'rotate(0deg)';
    } else {
        container.classList.add('active');
        toggleBtn.style.transform = 'rotate(180deg)';
    }
}

// Atualizar barra de progresso
function updateProgressBar(input) {
    const value = parseFloat(input.value) || 0;
    const progressBar = input.closest('.percentage-input-group').querySelector('.progress-bar');
    progressBar.style.width = `${Math.min(value, 100)}%`;
    
    // Validar valor
    if (value > 100) {
        input.value = 100;
        progressBar.style.width = '100%';
    }
    if (value < 0) {
        input.value = 0;
        progressBar.style.width = '0%';
    }
}

// Herdar percentuais do RDO anterior
async function herdarPercentuaisAnteriores() {
    const obraId = document.getElementById('obra_id').value;
    if (!obraId) {
        showNotification('Selecione uma obra primeiro', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch(`/api/rdo/herdar-percentuais/${obraId}`);
        const data = await response.json();
        
        if (data.success) {
            if (data.heranca.length === 0) {
                showNotification('Nenhum RDO anterior encontrado para herança', 'warning');
                return;
            }
            
            // Aplicar percentuais herdados
            data.heranca.forEach(item => {
                const inputs = document.querySelectorAll(`input[data-servico-id="${item.servico_id}"]`);
                inputs.forEach(input => {
                    const subatividadeContainer = input.closest('.subactivity-item');
                    const nomeSubatividade = subatividadeContainer.querySelector('.subactivity-name').textContent;
                    
                    if (nomeSubatividade === item.nome_subatividade) {
                        input.value = item.percentual_anterior;
                        updateProgressBar(input);
                        
                        // Preencher observações se existirem
                        if (item.observacoes_tecnicas) {
                            const textarea = subatividadeContainer.querySelector('textarea');
                            if (textarea) textarea.value = item.observacoes_tecnicas;
                        }
                    }
                });
            });
            
            showNotification(`Percentuais herdados do RDO ${data.ultimo_rdo.numero_rdo} (${data.ultimo_rdo.data_relatorio})`, 'success');
        } else {
            showNotification(data.error || 'Erro ao herdar percentuais', 'error');
        }
    } catch (error) {
        console.error('Erro ao herdar percentuais:', error);
        showNotification('Erro ao conectar com o servidor', 'error');
    } finally {
        hideLoading();
    }
}

// Salvar rascunho
async function salvarRascunho() {
    // TODO: Implementar salvamento de rascunho
    showNotification('Funcionalidade em desenvolvimento', 'warning');
}

// Finalizar RDO
async function finalizarRDO() {
    if (!validarFormulario()) {
        return;
    }
    
    showLoading();
    
    try {
        // Coletar dados das subatividades
        const subatividades = coletarDadosSubatividades();
        
        // TODO: Implementar submissão do formulário completo
        console.log('Dados coletados:', {
            subatividades: subatividades
        });
        
        showNotification('RDO finalizado com sucesso!', 'success');
        
        // Redirecionar após sucesso (simulado)
        setTimeout(() => {
            // window.location.href = "{{ url_for('main.funcionario_dashboard') }}";
        }, 2000);
        
    } catch (error) {
        console.error('Erro ao finalizar RDO:', error);
        showNotification('Erro ao finalizar RDO', 'error');
    } finally {
        hideLoading();
    }
}

// Coletar dados das subatividades
function coletarDadosSubatividades() {
    const subatividades = [];
    
    document.querySelectorAll('.subactivity-item').forEach(item => {
        const servicoId = item.dataset.servicoId;
        const subatividadeId = item.dataset.subatividadeId;
        const percentualInput = item.querySelector('.percentage-input');
        const observacoesTextarea = item.querySelector('textarea');
        const nomeSubatividade = item.querySelector('.subactivity-name').textContent;
        const descricaoElement = item.querySelector('.subactivity-name + small');
        
        subatividades.push({
            servico_id: servicoId,
            subatividade_id: subatividadeId,
            nome_subatividade: nomeSubatividade,
            descricao_subatividade: descricaoElement ? descricaoElement.textContent : '',
            percentual_conclusao: parseFloat(percentualInput.value) || 0,
            observacoes_tecnicas: observacoesTextarea.value.trim(),
            ordem_execucao: 1
        });
    });
    
    return subatividades;
}

// Validar formulário
function validarFormulario() {
    const obraId = document.getElementById('obra_id').value;
    const dataRelatorio = document.getElementById('data_relatorio').value;
    
    if (!obraId) {
        showNotification('Selecione uma obra', 'error');
        return false;
    }
    
    if (!dataRelatorio) {
        showNotification('Informe a data do relatório', 'error');
        return false;
    }
    
    return true;
}

// Utilities
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}
</script>
{% endblock %}