{% extends "base.html" %}

{% block title %}Sistema RDO Consolidado - SIGE{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0d6efd">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="RDO - SIGE">
<style>
:root {
    --primary-color: #0d6efd;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-bg: #f8f9fa;
    --border-color: #e9ecef;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.rdo-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: var(--light-bg);
    min-height: 100vh;
}

.rdo-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.rdo-section {
    background: white;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.section-header {
    background: var(--primary-color);
    color: white;
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
}

.section-body {
    padding: 20px;
}

.form-control, .form-select {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 12px;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
}

.subatividade-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 15px;
    border-bottom: 1px solid var(--border-color);
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
}

.subatividade-row:last-child {
    border-bottom: none;
}

.subatividade-nome {
    font-weight: 600;
    color: #495057;
    flex: 1;
}

.subatividade-input {
    width: 60px;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
    font-weight: bold;
}

.funcionario-row, .ferramenta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 10px;
}

.funcionario-nome, .ferramenta-nome {
    font-weight: 600;
    color: #495057;
    flex: 1;
}

.horas-input {
    width: 70px;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-outline-primary {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.floating-save {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    border-radius: 50px;
    padding: 15px 25px;
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: none;
}

.alert-success {
    background: #d4edda;
    color: #155724;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
}

/* Mobile-first responsive design */
@media (max-width: 768px) {
    .rdo-container {
        padding: 10px;
        margin: 0;
    }
    
    .rdo-header {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .rdo-header h2 {
        font-size: 1.4rem;
    }
    
    .rdo-header .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
    
    .section-header {
        padding: 12px 15px;
        font-size: 0.95rem;
    }
    
    .section-body {
        padding: 15px;
    }
    
    /* Subatividades mobile */
    .subatividade-row {
        padding: 12px 15px;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }
    
    .subatividade-nome {
        font-size: 0.9rem;
        flex: 1;
        margin-right: 15px;
    }
    
    .subatividade-input {
        width: 50px;
        padding: 8px 4px;
        font-size: 14px;
    }
    
    /* Funcion√°rios mobile */
    .funcionario-row {
        padding: 12px 15px;
    }
    
    .funcionario-nome {
        font-size: 0.9rem;
        margin-right: 15px;
    }
    
    .horas-input {
        width: 60px;
        padding: 8px 6px;
    }
    
    /* Dropdown funcion√°rios */
    .dropdown-funcionarios {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1050;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .funcionario-option {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .funcionario-option:hover {
        background: #f8f9fa;
    }
    
    .funcionario-option:last-child {
        border-bottom: none;
    }
    
    .funcionario-selecionado {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-bottom: 8px;
    }
    
    .funcionario-selecionado .btn-remove {
        color: #dc3545;
        background: none;
        border: none;
        padding: 2px 6px;
    }
    
    /* Ferramentas mobile */
    .ferramenta-row {
        flex-direction: column;
        gap: 12px;
        padding: 15px;
    }
    
    .ferramenta-row .d-flex.align-items-center.gap-2.flex-1 {
        width: 100%;
    }
    
    .ferramenta-row .form-control {
        font-size: 0.9rem;
    }
    
    /* Formul√°rios mobile */
    .form-control, .form-select {
        padding: 12px;
        font-size: 16px; /* Previne zoom no iOS */
        border-radius: 8px;
    }
    
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 8px;
    }
    
    /* Bot√µes mobile */
    .btn {
        padding: 12px 20px;
        font-size: 0.9rem;
        touch-action: manipulation; /* Melhora touch */
    }
    
    .btn-sm {
        padding: 8px 12px;
        font-size: 0.8rem;
    }
    
    /* Cards mobile */
    .rdo-section {
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    
    /* Progress mobile */
    .d-flex.justify-content-between.align-items-center {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .progress-bar-mini {
        width: 100%;
        max-width: 200px;
    }
    
    /* Headers mobile */
    .d-flex.justify-content-between.align-items-center .btn {
        margin-bottom: 8px;
    }
    
    /* Melhor experi√™ncia touch */
    .section-header {
        touch-action: manipulation;
        min-height: 48px;
        display: flex;
        align-items: center;
    }
    
    /* Floating button mobile */
    .floating-save {
        bottom: 15px;
        right: 15px;
        padding: 12px 20px;
        font-size: 0.9rem;
        box-shadow: 0 4px 20px rgba(13, 110, 253, 0.4);
    }
    
    /* Notifica√ß√µes mobile */
    #notifications {
        top: 10px;
        right: 10px;
        left: 10px;
        width: auto;
    }
    
    .alert {
        margin-bottom: 10px;
        font-size: 0.9rem;
        padding: 10px 12px;
    }
    
    /* Loading mobile */
    .loading-overlay .spinner {
        width: 50px;
        height: 50px;
        border-width: 5px;
    }
    
    /* Inputs mobile otimizados */
    input[type="number"] {
        -webkit-appearance: none;
        appearance: none;
        font-size: 16px; /* Previne zoom */
    }
    
    input[type="date"] {
        font-size: 16px; /* Previne zoom */
    }
    
    textarea {
        font-size: 16px; /* Previne zoom */
        resize: vertical;
    }
    
    /* Mobile bottom bar */
    .mobile-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1040;
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    .mobile-bottom-bar .btn-sm {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        padding: 8px 12px;
        border: none;
        background: transparent;
    }
    
    .mobile-bottom-bar .btn-sm:hover {
        background: rgba(0,0,0,0.05);
    }
    
    .mobile-bottom-bar .btn-sm small {
        font-size: 0.7rem;
    }
    
    /* Ajustar padding do body para mobile bottom bar */
    .mobile-device .rdo-container {
        padding-bottom: 80px;
    }
}

/* Extra small devices */
@media (max-width: 480px) {
    .rdo-container {
        padding: 8px;
    }
    
    .rdo-header {
        padding: 12px;
    }
    
    .rdo-header h2 {
        font-size: 1.2rem;
    }
    
    .section-body {
        padding: 12px;
    }
    
    .subatividade-row, .funcionario-row {
        padding: 10px 12px;
    }
    
    .subatividade-nome, .funcionario-nome {
        font-size: 0.85rem;
    }
    
    .subatividade-input, .horas-input {
        width: 45px;
        padding: 6px 2px;
        font-size: 13px;
    }
    
    /* Dropdown mobile */
    .dropdown-funcionarios {
        max-height: 150px;
    }
    
    .funcionario-option {
        padding: 12px;
        font-size: 0.9rem;
    }
    
    .btn {
        padding: 10px 16px;
        font-size: 0.85rem;
    }
    
    .floating-save {
        padding: 10px 16px;
        font-size: 0.85rem;
    }
}

/* Landscape mobile */
@media (max-width: 768px) and (orientation: landscape) {
    .rdo-header {
        padding: 10px 15px;
    }
    
    .rdo-header h2 {
        font-size: 1.3rem;
    }
    
    .section-header {
        padding: 10px 15px;
    }
    
    .floating-save {
        display: none; /* Hide em landscape para mais espa√ßo */
    }
}
</style>
{% endblock %}

{% block content %}
<div class="rdo-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Header -->
    <div class="rdo-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-clipboard-list"></i> Sistema RDO Consolidado</h2>
                <p class="mb-0 opacity-75">Relat√≥rio Di√°rio de Obra com controle de subatividades</p>
            </div>
            <a href="{{ url_for('main.funcionario_dashboard') }}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Progress Display -->
    <div class="rdo-section mb-3">
        <div class="section-body py-3">
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">Progresso Geral da Obra:</span>
                <div class="d-flex align-items-center gap-3">
                    <div class="progress-bar-mini" style="width: 200px;">
                        <div class="progress-fill" id="progresso-geral"></div>
                    </div>
                    <span class="fw-bold text-primary" id="progresso-texto">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form id="rdo-form" method="POST">
        <!-- Dados B√°sicos -->
        <div class="rdo-section">
            <div class="section-header" onclick="toggleSection(this)">
                <h5><i class="fas fa-info-circle"></i> Informa√ß√µes B√°sicas</h5>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-building text-primary"></i> Obra *
                        </label>
                        <select name="obra_id" id="obra_id" class="form-select" required onchange="carregarServicos(this.value)">
                            <option value="">Selecione uma obra</option>
                            {% for obra in obras %}
                            <option value="{{ obra.id }}">{{ obra.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar text-primary"></i> Data do Relat√≥rio *
                        </label>
                        <input type="date" name="data_relatorio" id="data_relatorio" 
                               class="form-control" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-comment text-primary"></i> Coment√°rio Geral
                    </label>
                    <textarea name="comentario_geral" class="form-control" rows="3" 
                              placeholder="Observa√ß√µes gerais sobre o trabalho do dia..."></textarea>
                </div>
            </div>
        </div>

        <!-- Condi√ß√µes Clim√°ticas -->
        <div class="rdo-section">
            <div class="section-header" onclick="toggleSection(this)">
                <h5><i class="fas fa-cloud-sun"></i> Condi√ß√µes Clim√°ticas</h5>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Clima</label>
                        <select name="clima_geral" class="form-select">
                            <option value="">Selecione...</option>
                            <option value="Ensolarado">‚òÄÔ∏è Ensolarado</option>
                            <option value="Parcialmente nublado">‚õÖ Parcialmente nublado</option>
                            <option value="Nublado">‚òÅÔ∏è Nublado</option>
                            <option value="Chuvoso">üåßÔ∏è Chuvoso</option>
                            <option value="Tempestade">‚õàÔ∏è Tempestade</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Temperatura</label>
                        <input type="text" name="temperatura_media" class="form-control" 
                               placeholder="Ex: 25¬∞C">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Observa√ß√µes</label>
                        <textarea name="observacoes_climaticas" class="form-control" rows="2" 
                                  placeholder="Detalhes sobre o clima..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Servi√ßos e Subatividades -->
        <div class="rdo-section">
            <div class="section-header" onclick="toggleSection(this)">
                <h5><i class="fas fa-tasks"></i> Servi√ßos e Subatividades <span id="servicos-count" class="opacity-75">(0 servi√ßos)</span></h5>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="section-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="herdarPercentuais()" id="btn-herdar" disabled>
                        <i class="fas fa-download"></i> Herdar RDO Anterior
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="validarFormulario()">
                        <i class="fas fa-check-circle"></i> Validar Dados
                    </button>
                </div>

                <!-- Container de Servi√ßos -->
                <div id="servicos-container">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-building fa-3x mb-3"></i>
                        <h5>Selecione uma obra para carregar os servi√ßos</h5>
                        <p>Os servi√ßos dispon√≠veis ser√£o listados aqui automaticamente</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funcion√°rios (M√£o de Obra) -->
        <div class="rdo-section">
            <div class="section-header" onclick="toggleSection(this)">
                <h5><i class="fas fa-users"></i> Funcion√°rios (M√£o de Obra)</h5>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="section-body">
                <!-- Adicionar Funcion√°rio -->
                <div class="mb-3">
                    <div class="d-flex gap-2 align-items-end">
                        <div class="flex-1 position-relative">
                            <label class="form-label fw-bold">Selecionar Funcion√°rio</label>
                            <input type="text" 
                                   id="funcionario-search" 
                                   class="form-control" 
                                   placeholder="Digite o nome do funcion√°rio..."
                                   autocomplete="off">
                            <div id="funcionario-dropdown" class="dropdown-funcionarios" style="display: none;">
                                <!-- Lista de funcion√°rios ser√° carregada aqui -->
                            </div>
                        </div>
                        <div>
                            <label class="form-label fw-bold">Horas</label>
                            <input type="number" 
                                   id="horas-funcionario" 
                                   class="form-control" 
                                   style="width: 80px;"
                                   min="0" max="12" step="0.5" 
                                   placeholder="8">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="adicionarFuncionario()">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Funcion√°rios Selecionados -->
                <div id="funcionarios-selecionados">
                    <!-- Funcion√°rios selecionados aparecer√£o aqui -->
                </div>
                
                <!-- Container original mantido para compatibilidade -->
                <div id="funcionarios-container" style="display: none;">
                    {% for funcionario in funcionarios %}
                    <div class="funcionario-item" data-id="{{ funcionario.id }}" data-nome="{{ funcionario.nome }}">
                        {{ funcionario.nome }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Ferramentas e Equipamentos -->
        <div class="rdo-section">
            <div class="section-header" onclick="toggleSection(this)">
                <h5><i class="fas fa-tools"></i> Ferramentas e Equipamentos</h5>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="section-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarFerramenta()">
                        <i class="fas fa-plus"></i> Adicionar Ferramenta
                    </button>
                </div>
                <div id="ferramentas-container">
                    <!-- Ferramentas ser√£o adicionadas dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('main.funcionario_dashboard') }}'">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="salvarRascunho()">
                    <i class="fas fa-save"></i> Salvar Rascunho
                </button>
                <button type="submit" class="btn btn-success" id="btn-finalizar" disabled>
                    <i class="fas fa-check"></i> Finalizar RDO
                </button>
            </div>
        </div>
    </form>

    <!-- Floating Save (Mobile) -->
    <button type="button" class="floating-save btn btn-primary d-md-none" onclick="salvarRascunho()" id="floating-save-btn">
        <i class="fas fa-save"></i>
        <span class="d-none" id="save-text">Salvar</span>
    </button>
    
    <!-- Mobile Bottom Bar -->
    <div class="mobile-bottom-bar d-md-none" id="mobile-bottom-bar">
        <div class="d-flex justify-content-around align-items-center p-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.location.href='{{ url_for('main.funcionario_dashboard') }}'">
                <i class="fas fa-arrow-left"></i>
                <small>Voltar</small>
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="validarFormulario()">
                <i class="fas fa-check-circle"></i>
                <small>Validar</small>
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="salvarRascunho()">
                <i class="fas fa-save"></i>
                <small>Salvar</small>
            </button>
            <button type="submit" class="btn btn-success btn-sm" form="rdo-form" id="btn-finalizar-mobile" disabled>
                <i class="fas fa-check"></i>
                <small>Finalizar</small>
            </button>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notifications" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

<script>
let servicosCarregados = [];
let validacaoErros = [];
let funcionariosDisponiveis = [];
let funcionariosSelecionados = [];

// Toggle se√ß√µes
function toggleSection(header) {
    const section = header.nextElementSibling;
    const icon = header.querySelector('.fas:last-child');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
    } else {
        section.style.display = 'none';
        icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
    }
}

// Carregar servi√ßos da obra
async function carregarServicos(obraId) {
    if (!obraId) {
        limparServicos();
        return;
    }
    
    mostrarLoading(true);
    
    try {
        const response = await fetch(`/api/test/rdo/servicos-obra/${obraId}`);
        const data = await response.json();
        
        if (response.ok) {
            servicosCarregados = data.servicos || [];
            renderizarServicos();
            document.getElementById('btn-herdar').disabled = false;
            mostrarNotificacao(`${servicosCarregados.length} servi√ßos carregados`, 'success');
        } else {
            throw new Error(data.error || 'Erro ao carregar servi√ßos');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao carregar servi√ßos da obra', 'danger');
        servicosCarregados = [];
    }
    
    mostrarLoading(false);
    atualizarContador();
}

// Renderizar servi√ßos
function renderizarServicos() {
    const container = document.getElementById('servicos-container');
    
    if (servicosCarregados.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <h5>Nenhum servi√ßo encontrado</h5>
                <p>Esta obra n√£o possui servi√ßos cadastrados</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    servicosCarregados.forEach((servico, servicoIndex) => {
        html += `
            <div class="rdo-section mb-3">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cogs"></i> ${servico.nome}
                        <span class="opacity-75">(${servico.subatividades?.length || 0} subatividades)</span>
                    </h6>
                </div>
                <div class="section-body">
        `;
        
        if (servico.subatividades && servico.subatividades.length > 0) {
            servico.subatividades.forEach((sub, subIndex) => {
                html += `
                    <div class="subatividade-row">
                        <div class="subatividade-nome">
                            <i class="fas fa-tasks text-primary"></i> ${sub.nome}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" 
                                   class="subatividade-input" 
                                   name="subatividades[${servicoIndex}][${subIndex}][percentual]"
                                   min="0" max="100" step="0.1" value="0"
                                   onchange="atualizarProgresso(this)"
                                   placeholder="0">
                            <span class="text-muted">%</span>
                        </div>
                        <input type="hidden" name="subatividades[${servicoIndex}][${subIndex}][nome]" value="${sub.nome}">
                        <input type="hidden" name="subatividades[${servicoIndex}][${subIndex}][servico_id]" value="${servico.id}">
                        <input type="hidden" name="subatividades[${servicoIndex}][${subIndex}][servico_nome]" value="${servico.nome}">
                    </div>
                `;
            });
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Atualizar progresso
function atualizarProgresso(input) {
    const valor = parseFloat(input.value) || 0;
    
    // Validar valor
    if (valor < 0) input.value = 0;
    if (valor > 100) input.value = 100;
    
    // Calcular progresso geral
    calcularProgressoGeral();
}

// Calcular progresso geral
function calcularProgressoGeral() {
    const inputs = document.querySelectorAll('.subatividade-input');
    let total = 0;
    let count = 0;
    
    inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        total += valor;
        count++;
    });
    
    const progressoMedio = count > 0 ? (total / count) : 0;
    
    document.getElementById('progresso-geral').style.width = `${progressoMedio}%`;
    document.getElementById('progresso-texto').textContent = `${progressoMedio.toFixed(1)}%`;
    
    return progressoMedio;
}

// Herdar percentuais do RDO anterior
async function herdarPercentuais() {
    const obraId = document.getElementById('obra_id').value;
    if (!obraId) {
        mostrarNotificacao('Selecione uma obra primeiro', 'warning');
        return;
    }
    
    mostrarLoading(true);
    
    try {
        const response = await fetch(`/api/rdo/herdar-percentuais/${obraId}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
            if (data.percentuais && Object.keys(data.percentuais).length > 0) {
                aplicarPercentuais(data.percentuais);
                mostrarNotificacao('Percentuais herdados com sucesso!', 'success');
            } else {
                mostrarNotificacao('Nenhum RDO anterior encontrado', 'warning');
            }
        } else {
            mostrarNotificacao(data.error || 'Erro ao herdar percentuais', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro de conex√£o', 'danger');
    }
    
    mostrarLoading(false);
}

// Aplicar percentuais herdados
function aplicarPercentuais(percentuais) {
    Object.keys(percentuais).forEach(nomeSubatividade => {
        const percentual = percentuais[nomeSubatividade];
        
        const inputs = document.querySelectorAll('.subatividade-input');
        inputs.forEach(input => {
            const nomeInput = input.closest('.subatividade-row').querySelector('input[name*="[nome]"]');
            if (nomeInput && nomeInput.value === nomeSubatividade) {
                input.value = percentual;
                atualizarProgresso(input);
            }
        });
    });
}

// Validar formul√°rio
function validarFormulario() {
    validacaoErros = [];
    
    const obraId = document.getElementById('obra_id').value;
    const dataRelatorio = document.getElementById('data_relatorio').value;
    
    if (!obraId) validacaoErros.push('Obra deve ser selecionada');
    if (!dataRelatorio) validacaoErros.push('Data do relat√≥rio √© obrigat√≥ria');
    
    // Validar data futura
    if (dataRelatorio) {
        const hoje = new Date().toISOString().split('T')[0];
        if (dataRelatorio > hoje) {
            validacaoErros.push('Data n√£o pode ser futura');
        }
    }
    
    // Validar se tem pelo menos uma subatividade com percentual
    const inputs = document.querySelectorAll('.subatividade-input');
    let temPercentuais = false;
    
    inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        if (valor > 0) temPercentuais = true;
    });
    
    if (!temPercentuais) {
        validacaoErros.push('Adicione pelo menos um percentual de subatividade');
    }
    
    // Mostrar resultado
    if (validacaoErros.length === 0) {
        mostrarNotificacao('Formul√°rio v√°lido! Pronto para salvar.', 'success');
        document.getElementById('btn-finalizar').disabled = false;
    } else {
        const mensagem = `Problemas encontrados:\n‚Ä¢ ${validacaoErros.join('\n‚Ä¢ ')}`;
        mostrarNotificacao(mensagem, 'danger');
        document.getElementById('btn-finalizar').disabled = true;
    }
}

// Salvar rascunho
async function salvarRascunho() {
    const dados = coletarDados();
    dados.status = 'Rascunho';
    await salvarRDO(dados);
}

// Coletar dados do formul√°rio
function coletarDados() {
    const formData = new FormData(document.getElementById('rdo-form'));
    
    const dados = {
        obra_id: formData.get('obra_id'),
        data_relatorio: formData.get('data_relatorio'),
        clima_geral: formData.get('clima_geral'),
        temperatura_media: formData.get('temperatura_media'),
        observacoes_climaticas: formData.get('observacoes_climaticas'),
        comentario_geral: formData.get('comentario_geral'),
        subatividades: [],
        funcionarios: [],
        ferramentas: []
    };
    
    // Coletar subatividades com percentual > 0
    const inputs = document.querySelectorAll('.subatividade-input');
    inputs.forEach(input => {
        const percentual = parseFloat(input.value) || 0;
        if (percentual > 0) {
            const row = input.closest('.subatividade-row');
            const nomeInput = row.querySelector('input[name*="[nome]"]');
            const servicoIdInput = row.querySelector('input[name*="[servico_id]"]');
            const servicoNomeInput = row.querySelector('input[name*="[servico_nome]"]');
            
            dados.subatividades.push({
                servico_id: parseInt(servicoIdInput.value),
                servico_nome: servicoNomeInput.value,
                nome_subatividade: nomeInput.value,
                percentual_conclusao: percentual,
                observacoes_tecnicas: '' // Removido conforme solicitado
            });
        }
    });
    
    // Coletar funcion√°rios com horas > 0
    const funcionarioInputs = document.querySelectorAll('.horas-input[name*="funcionario_"]');
    funcionarioInputs.forEach(input => {
        const horas = parseFloat(input.value) || 0;
        if (horas > 0) {
            const funcionarioId = input.name.match(/funcionario_(\d+)_horas/)[1];
            const nomeInput = document.querySelector(`input[name="funcionario_${funcionarioId}_nome"]`);
            
            dados.funcionarios.push({
                funcionario_id: parseInt(funcionarioId),
                nome: nomeInput.value,
                horas_trabalhadas: horas
            });
        }
    });
    
    // Coletar ferramentas com horas > 0
    const ferramentaInputs = document.querySelectorAll('.horas-input[name*="ferramenta_"]');
    ferramentaInputs.forEach(input => {
        const horas = parseFloat(input.value) || 0;
        if (horas > 0) {
            const ferramentaId = input.name.match(/ferramenta_(\d+)_horas/)[1];
            const nomeInput = document.querySelector(`input[name="ferramenta_${ferramentaId}_nome"]`);
            
            if (nomeInput && nomeInput.value.trim()) {
                dados.ferramentas.push({
                    nome: nomeInput.value.trim(),
                    horas_utilizadas: horas
                });
            }
        }
    });
    
    return dados;
}

// Salvar RDO
async function salvarRDO(dados) {
    mostrarLoading(true);
    
    try {
        const response = await fetch('/api/test/rdo/salvar-subatividades', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            const tipo = dados.status === 'Rascunho' ? 'rascunho salvo' : 'RDO finalizado';
            mostrarNotificacao(`${tipo.toUpperCase()} com sucesso! ID: ${result.rdo_id}`, 'success');
            
            setTimeout(() => {
                window.location.href = '/funcionario/dashboard';
            }, 2000);
        } else {
            mostrarNotificacao(result.error || 'Erro ao salvar RDO', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro de conex√£o com o servidor', 'danger');
    }
    
    mostrarLoading(false);
}

// Fun√ß√µes auxiliares
function limparServicos() {
    servicosCarregados = [];
    document.getElementById('servicos-container').innerHTML = `
        <div class="text-center py-5 text-muted">
            <i class="fas fa-building fa-3x mb-3"></i>
            <h5>Selecione uma obra para carregar os servi√ßos</h5>
            <p>Os servi√ßos dispon√≠veis ser√£o listados aqui automaticamente</p>
        </div>
    `;
    document.getElementById('btn-herdar').disabled = true;
    document.getElementById('btn-finalizar').disabled = true;
    atualizarContador();
}

function atualizarContador() {
    document.getElementById('servicos-count').textContent = `(${servicosCarregados.length} servi√ßos)`;
}

function mostrarLoading(mostrar) {
    document.getElementById('loading-overlay').style.display = mostrar ? 'flex' : 'none';
}

function mostrarNotificacao(mensagem, tipo = 'info') {
    const container = document.getElementById('notifications');
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${tipo} alert-dismissible`;
    
    // Melhorar notifica√ß√µes no mobile
    if (window.innerWidth <= 768) {
        notification.style.animation = 'slideInRight 0.3s ease-out';
        notification.style.fontSize = '0.9rem';
        notification.style.padding = '10px 12px';
    }
    
    notification.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()" style="font-size: 0.8rem;"></button>
    `;
    
    container.appendChild(notification);
    
    // Auto-dismiss mais r√°pido no mobile
    const dismissTime = window.innerWidth <= 768 ? 3000 : 5000;
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, dismissTime);
}

// Adicionar anima√ß√µes CSS para mobile
const mobileAnimations = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    @media (max-width: 768px) {
        .btn:active, .section-header:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }
        
        .subatividade-input:focus, .horas-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
            transform: scale(1.05);
            transition: all 0.2s;
        }
        
        .mobile-device .loading-overlay {
            backdrop-filter: blur(3px);
        }
        
        .mobile-landscape .floating-save {
            display: none !important;
        }
    }
`;

// Injetar anima√ß√µes mobile
const style = document.createElement('style');
style.textContent = mobileAnimations;
document.head.appendChild(style);

// Mobile UX enhancements
let touchStartY = 0;
let isScrolling = false;

// Melhorar experi√™ncia touch
function melhorarTouch() {
    // Adicionar feedback visual touch nos bot√µes
    document.querySelectorAll('.btn, .section-header').forEach(element => {
        element.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        
        element.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Otimizar inputs para mobile
    document.querySelectorAll('input[type="number"]').forEach(input => {
        // Adicionar teclado num√©rico no mobile
        input.setAttribute('inputmode', 'decimal');
        input.setAttribute('pattern', '[0-9]*');
        
        // Melhorar UX com sele√ß√£o autom√°tica
        input.addEventListener('focus', function() {
            if (window.innerWidth <= 768) {
                setTimeout(() => this.select(), 100);
            }
        });
    });
}

// Auto-save no mobile (salvar automaticamente a cada mudan√ßa)
let autoSaveTimer = null;
function autoSaveMobile() {
    if (window.innerWidth <= 768) {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            const obraId = document.getElementById('obra_id').value;
            if (obraId) {
                salvarRascunho();
                mostrarNotificacao('üíæ Auto-salvamento realizado', 'success');
            }
        }, 30000); // Auto-save a cada 30 segundos no mobile
    }
}

// Detectar orienta√ß√£o mobile
function detectarOrientacao() {
    if (window.innerWidth <= 768) {
        const isLandscape = window.innerWidth > window.innerHeight;
        document.body.classList.toggle('mobile-landscape', isLandscape);
        
        // Ajustar floating button
        const floatingBtn = document.querySelector('.floating-save');
        if (floatingBtn) {
            floatingBtn.style.display = isLandscape ? 'none' : 'block';
        }
    }
}

// Swipe gestures para mobile
function adicionarSwipeGestures() {
    if (window.innerWidth <= 768) {
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchmove', function(e) {
            if (!isScrolling) {
                const touchY = e.touches[0].clientY;
                const diffY = touchStartY - touchY;
                
                // Pull to refresh gesture (puxar para baixo no topo)
                if (window.scrollY === 0 && diffY < -50) {
                    mostrarNotificacao('üîÑ Puxe mais para recarregar', 'info');
                }
            }
        });
    }
}

// Otimiza√ß√µes espec√≠ficas mobile
function otimizarMobile() {
    if (window.innerWidth <= 768) {
        // Ajustar altura do viewport
        document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        
        // Melhorar scroll
        document.body.style.overscrollBehavior = 'contain';
        
        // Otimizar taps duplos
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });
        
        // Adicionar classes mobile
        document.body.classList.add('mobile-device');
        
        // Esconder elementos n√£o essenciais
        const progressGeral = document.querySelector('.rdo-section .section-body .d-flex');
        if (progressGeral) {
            progressGeral.style.flexDirection = 'column';
            progressGeral.style.gap = '10px';
        }
    }
}

// Vibra√ß√£o haptica no mobile (se suportada)
function vibrarSucesso() {
    if ('vibrate' in navigator && window.innerWidth <= 768) {
        navigator.vibrate(100);
    }
}

function vibrarErro() {
    if ('vibrate' in navigator && window.innerWidth <= 768) {
        navigator.vibrate([100, 100, 100]);
    }
}

// Funcionalidades dos funcion√°rios
function carregarFuncionarios() {
    // Carregar lista de funcion√°rios dispon√≠veis
    const funcionarios = document.querySelectorAll('#funcionarios-container .funcionario-item');
    funcionariosDisponiveis = Array.from(funcionarios).map(item => ({
        id: item.dataset.id,
        nome: item.dataset.nome
    }));
}

function filtrarFuncionarios(termo) {
    if (!termo) return [];
    
    const termoLower = termo.toLowerCase();
    return funcionariosDisponiveis.filter(func => 
        func.nome.toLowerCase().includes(termoLower)
    );
}

function mostrarDropdownFuncionarios(funcionarios) {
    const dropdown = document.getElementById('funcionario-dropdown');
    
    if (funcionarios.length === 0) {
        dropdown.style.display = 'none';
        return;
    }
    
    dropdown.innerHTML = funcionarios.map(func => `
        <div class="funcionario-option" onclick="selecionarFuncionarioDropdown('${func.id}', '${func.nome}')">
            <i class="fas fa-user text-primary"></i> ${func.nome}
        </div>
    `).join('');
    
    dropdown.style.display = 'block';
}

function selecionarFuncionarioDropdown(id, nome) {
    document.getElementById('funcionario-search').value = nome;
    document.getElementById('funcionario-dropdown').style.display = 'none';
}

function adicionarFuncionario() {
    const searchInput = document.getElementById('funcionario-search');
    const horasInput = document.getElementById('horas-funcionario');
    
    const nomeFuncionario = searchInput.value.trim();
    const horas = parseFloat(horasInput.value) || 0;
    
    if (!nomeFuncionario) {
        mostrarNotificacao('Selecione um funcion√°rio', 'warning');
        return;
    }
    
    if (horas <= 0 || horas > 12) {
        mostrarNotificacao('Informe as horas trabalhadas (0.5 a 12)', 'warning');
        return;
    }
    
    // Verificar se funcion√°rio j√° foi adicionado
    if (funcionariosSelecionados.find(f => f.nome === nomeFuncionario)) {
        mostrarNotificacao('Funcion√°rio j√° adicionado', 'warning');
        return;
    }
    
    // Encontrar o ID do funcion√°rio
    const funcionario = funcionariosDisponiveis.find(f => f.nome === nomeFuncionario);
    const funcionarioId = funcionario ? funcionario.id : Date.now(); // Fallback para ID √∫nico
    
    // Adicionar √† lista
    funcionariosSelecionados.push({
        id: funcionarioId,
        nome: nomeFuncionario,
        horas: horas
    });
    
    // Atualizar interface
    renderizarFuncionariosSelecionados();
    
    // Limpar campos
    searchInput.value = '';
    horasInput.value = '';
    
    mostrarNotificacao(`${nomeFuncionario} adicionado (${horas}h)`, 'success');
    vibrarSucesso();
}

function removerFuncionario(index) {
    const funcionario = funcionariosSelecionados[index];
    funcionariosSelecionados.splice(index, 1);
    renderizarFuncionariosSelecionados();
    mostrarNotificacao(`${funcionario.nome} removido`, 'info');
}

function renderizarFuncionariosSelecionados() {
    const container = document.getElementById('funcionarios-selecionados');
    
    if (funcionariosSelecionados.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>Nenhum funcion√°rio adicionado</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = funcionariosSelecionados.map((func, index) => `
        <div class="funcionario-selecionado">
            <div>
                <i class="fas fa-user text-primary"></i> 
                <strong>${func.nome}</strong> - ${func.horas}h
                <input type="hidden" name="funcionario_${func.id}_nome" value="${func.nome}">
                <input type="hidden" name="funcionario_${func.id}_horas" value="${func.horas}">
            </div>
            <button type="button" class="btn-remove" onclick="removerFuncionario(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Definir data padr√£o
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data_relatorio').value = hoje;
    
    // Carregar funcion√°rios dispon√≠veis
    carregarFuncionarios();
    renderizarFuncionariosSelecionados();
    
    // Autocomplete funcion√°rios
    const funcionarioSearch = document.getElementById('funcionario-search');
    funcionarioSearch.addEventListener('input', function() {
        const termo = this.value.trim();
        const funcionarios = filtrarFuncionarios(termo);
        mostrarDropdownFuncionarios(funcionarios);
    });
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.position-relative')) {
            document.getElementById('funcionario-dropdown').style.display = 'none';
        }
    });
    
    // Enter para adicionar funcion√°rio
    document.getElementById('horas-funcionario').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            adicionarFuncionario();
        }
    });
    
    // Submit do formul√°rio
    document.getElementById('rdo-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validarFormulario() && validacaoErros.length === 0) {
            const dados = coletarDados();
            dados.status = 'Finalizado';
            salvarRDO(dados);
            vibrarSucesso();
        } else {
            vibrarErro();
        }
    });
    
    // Inicializar otimiza√ß√µes mobile
    melhorarTouch();
    detectarOrientacao();
    adicionarSwipeGestures();
    otimizarMobile();
    
    // Listeners para auto-save mobile
    document.querySelectorAll('input, select, textarea').forEach(element => {
        element.addEventListener('change', autoSaveMobile);
        element.addEventListener('input', autoSaveMobile);
    });
});

// Listener para mudan√ßa de orienta√ß√£o
window.addEventListener('orientationchange', function() {
    setTimeout(detectarOrientacao, 100);
});

// Listener para resize
window.addEventListener('resize', function() {
    detectarOrientacao();
    otimizarMobile();
});

// Adicionar ferramenta
let contadorFerramentas = 0;
function adicionarFerramenta() {
    contadorFerramentas++;
    const container = document.getElementById('ferramentas-container');
    
    const ferramentaHtml = `
        <div class="ferramenta-row" id="ferramenta-${contadorFerramentas}">
            <div class="d-flex align-items-center gap-2 flex-1">
                <i class="fas fa-tools text-primary"></i>
                <input type="text" 
                       class="form-control" 
                       name="ferramenta_${contadorFerramentas}_nome"
                       placeholder="Nome da ferramenta/equipamento"
                       required>
            </div>
            <div class="d-flex align-items-center gap-2">
                <input type="number" 
                       class="horas-input" 
                       name="ferramenta_${contadorFerramentas}_horas"
                       min="0" max="12" step="0.5" 
                       placeholder="0">
                <span class="text-muted">horas</span>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerFerramenta(${contadorFerramentas})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', ferramentaHtml);
}

// Remover ferramenta
function removerFerramenta(id) {
    const elemento = document.getElementById(`ferramenta-${id}`);
    if (elemento) {
        elemento.remove();
    }
}

console.log('Sistema RDO Consolidado carregado com sucesso!');
</script>
{% endblock %}