{% extends "base_completo.html" %}

{% block title %}Balanço Patrimonial - SIGE v9.0{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-balance-scale"></i> Balanço Patrimonial
        </h1>
        <div class="btn-group">
            <a href="{{ url_for('contabilidade.dashboard_contabil') }}" class="btn btn-sm btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <button class="btn btn-sm btn-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimir
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-calendar-alt"></i> Data de Referência
            </h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row align-items-end">
                <div class="col-md-3">
                    <label for="data">Data:</label>
                    <input type="date" name="data" id="data" value="{{ data_referencia.isoformat() }}" class="form-control">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Gerar Balanço
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Validation Badge -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 {% if balanco.balanceado %}bg-success{% else %}bg-danger{% endif %} text-white">
            <h6 class="m-0 font-weight-bold">
                {% if balanco.balanceado %}
                    <i class="fas fa-check-circle"></i> ✓ Balanceado - Ativo = Passivo + Patrimônio Líquido
                {% else %}
                    <i class="fas fa-exclamation-triangle"></i> ⚠ Desbalanceado - Diferença: R$ {{ "%.2f"|format((balanco.ativo.total - balanco.total_passivo_pl)|abs|float) }}
                {% endif %}
            </h6>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h4 class="text-primary mb-0">R$ {{ "{:,.2f}".format(balanco.ativo.total|float) }}</h4>
                    <small class="text-muted">Total do Ativo</small>
                </div>
                <div class="col-md-4">
                    <h4 class="{% if balanco.balanceado %}text-success{% else %}text-danger{% endif %} mb-0">
                        {% if balanco.balanceado %}
                            <i class="fas fa-equals"></i>
                        {% else %}
                            <i class="fas fa-not-equal"></i>
                        {% endif %}
                    </h4>
                    <small class="text-muted">Equação Fundamental</small>
                </div>
                <div class="col-md-4">
                    <h4 class="text-warning mb-0">R$ {{ "{:,.2f}".format(balanco.total_passivo_pl|float) }}</h4>
                    <small class="text-muted">Total Passivo + PL</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Balanço Patrimonial - 2 Column Layout -->
    <div class="row">
        <!-- LEFT COLUMN: ATIVO -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-plus-circle"></i> ATIVO
                    </h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <tbody>
                            <!-- ATIVO CIRCULANTE -->
                            {% set total_circulante = balanco.ativo.circulante.values()|sum(attribute='saldo') if balanco.ativo.circulante else 0 %}
                            <tr class="table-light border-bottom">
                                <td class="font-weight-bold" style="padding-left: 10px;">
                                    <i class="fas fa-angle-right"></i> ATIVO CIRCULANTE
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(total_circulante|float) }}</td>
                            </tr>
                            {% for codigo, conta in balanco.ativo.circulante.items()|sort %}
                                <tr>
                                    <td style="padding-left: {{ (conta.nivel * 15) }}px;">
                                        {{ conta.nome }}
                                        <small class="text-muted">({{ codigo }})</small>
                                    </td>
                                    <td class="text-right">R$ {{ "{:,.2f}".format(conta.saldo|float) }}</td>
                                </tr>
                            {% endfor %}
                            
                            <!-- ATIVO NÃO CIRCULANTE -->
                            {% set total_nao_circulante = balanco.ativo.nao_circulante.values()|sum(attribute='saldo') if balanco.ativo.nao_circulante else 0 %}
                            <tr class="table-light border-bottom border-top">
                                <td class="font-weight-bold" style="padding-left: 10px;">
                                    <i class="fas fa-angle-right"></i> ATIVO NÃO CIRCULANTE
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(total_nao_circulante|float) }}</td>
                            </tr>
                            {% for codigo, conta in balanco.ativo.nao_circulante.items()|sort %}
                                <tr>
                                    <td style="padding-left: {{ (conta.nivel * 15) }}px;">
                                        {{ conta.nome }}
                                        <small class="text-muted">({{ codigo }})</small>
                                    </td>
                                    <td class="text-right">R$ {{ "{:,.2f}".format(conta.saldo|float) }}</td>
                                </tr>
                            {% endfor %}
                            
                            <!-- TOTAL ATIVO -->
                            <tr class="table-primary border-top" style="border-top: 3px double #000 !important;">
                                <td class="font-weight-bold">
                                    <i class="fas fa-calculator"></i> TOTAL DO ATIVO
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(balanco.ativo.total|float) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: PASSIVO + PATRIMÔNIO LÍQUIDO -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-warning text-dark">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-minus-circle"></i> PASSIVO + PATRIMÔNIO LÍQUIDO
                    </h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <tbody>
                            <!-- PASSIVO CIRCULANTE -->
                            {% set total_passivo_circulante = balanco.passivo.circulante.values()|sum(attribute='saldo') if balanco.passivo.circulante else 0 %}
                            <tr class="table-light border-bottom">
                                <td class="font-weight-bold" style="padding-left: 10px;">
                                    <i class="fas fa-angle-right"></i> PASSIVO CIRCULANTE
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(total_passivo_circulante|float) }}</td>
                            </tr>
                            {% for codigo, conta in balanco.passivo.circulante.items()|sort %}
                                <tr>
                                    <td style="padding-left: {{ (conta.nivel * 15) }}px;">
                                        {{ conta.nome }}
                                        <small class="text-muted">({{ codigo }})</small>
                                    </td>
                                    <td class="text-right">R$ {{ "{:,.2f}".format(conta.saldo|float) }}</td>
                                </tr>
                            {% endfor %}
                            
                            <!-- PASSIVO NÃO CIRCULANTE -->
                            {% set total_passivo_nao_circulante = balanco.passivo.nao_circulante.values()|sum(attribute='saldo') if balanco.passivo.nao_circulante else 0 %}
                            <tr class="table-light border-bottom border-top">
                                <td class="font-weight-bold" style="padding-left: 10px;">
                                    <i class="fas fa-angle-right"></i> PASSIVO NÃO CIRCULANTE
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(total_passivo_nao_circulante|float) }}</td>
                            </tr>
                            {% for codigo, conta in balanco.passivo.nao_circulante.items()|sort %}
                                <tr>
                                    <td style="padding-left: {{ (conta.nivel * 15) }}px;">
                                        {{ conta.nome }}
                                        <small class="text-muted">({{ codigo }})</small>
                                    </td>
                                    <td class="text-right">R$ {{ "{:,.2f}".format(conta.saldo|float) }}</td>
                                </tr>
                            {% endfor %}
                            
                            <!-- PATRIMÔNIO LÍQUIDO -->
                            <tr class="table-light border-bottom border-top">
                                <td class="font-weight-bold" style="padding-left: 10px;">
                                    <i class="fas fa-angle-right"></i> PATRIMÔNIO LÍQUIDO
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(balanco.total_pl|float) }}</td>
                            </tr>
                            {% for codigo, conta in balanco.patrimonio_liquido.items()|sort %}
                                <tr>
                                    <td style="padding-left: {{ (conta.nivel * 15) }}px;">
                                        {{ conta.nome }}
                                        <small class="text-muted">({{ codigo }})</small>
                                    </td>
                                    <td class="text-right">R$ {{ "{:,.2f}".format(conta.saldo|float) }}</td>
                                </tr>
                            {% endfor %}
                            
                            <!-- TOTAL PASSIVO + PL -->
                            <tr class="table-warning border-top" style="border-top: 3px double #000 !important;">
                                <td class="font-weight-bold">
                                    <i class="fas fa-calculator"></i> TOTAL PASSIVO + PL
                                </td>
                                <td class="text-right font-weight-bold">R$ {{ "{:,.2f}".format(balanco.total_passivo_pl|float) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Cards -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle"></i> Informações do Balanço
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center border-right">
                            <h5 class="text-primary">{{ balanco.ativo.circulante|length }}</h5>
                            <small class="text-muted">Contas Ativo Circulante</small>
                        </div>
                        <div class="col-md-3 text-center border-right">
                            <h5 class="text-primary">{{ balanco.ativo.nao_circulante|length }}</h5>
                            <small class="text-muted">Contas Ativo Não Circulante</small>
                        </div>
                        <div class="col-md-3 text-center border-right">
                            <h5 class="text-warning">{{ (balanco.passivo.circulante|length + balanco.passivo.nao_circulante|length) }}</h5>
                            <small class="text-muted">Contas Passivo</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h5 class="text-success">{{ balanco.patrimonio_liquido|length }}</h5>
                            <small class="text-muted">Contas Patrimônio Líquido</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <p class="mb-0">
                            <i class="fas fa-calendar-alt"></i> 
                            <strong>Data de Referência:</strong> {{ data_referencia.strftime('%d/%m/%Y') }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .btn-group, .card-header .btn, nav, footer {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
    
    body {
        padding-top: 0 !important;
    }
}
</style>
{% endblock %}
