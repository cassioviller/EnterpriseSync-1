{% extends "base_completo.html" %}

{% block title %}{{ titulo }} - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header da Página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-building"></i> {{ titulo }}
            </h1>
            <p class="text-muted mb-0">{{ 'Editar informações da obra' if obra else 'Criar nova obra no sistema' }}</p>
        </div>
        <div>
            <a href="{{ url_for('main.obras') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar para Lista
            </a>
        </div>
    </div>

    <!-- Formulário -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-edit"></i> {{ 'Informações da Obra' if obra else 'Dados da Nova Obra' }}
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" id="obraForm">
                <div class="row">
                    <!-- Nome da Obra -->
                    <div class="col-md-8 mb-3">
                        <label for="nome" class="form-label">
                            <i class="fas fa-building text-primary"></i> Nome da Obra *
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="nome" 
                               name="nome" 
                               value="{{ obra.nome if obra else '' }}" 
                               required
                               placeholder="Ex: Edifício Residencial São Paulo">
                    </div>
                    
                    <!-- Status -->
                    <div class="col-md-4 mb-3">
                        <label for="status" class="form-label">
                            <i class="fas fa-flag text-success"></i> Status
                        </label>
                        <select class="form-select" id="status" name="status">
                            <option value="Em andamento" {{ 'selected' if obra and obra.status == 'Em andamento' else '' }}>Em andamento</option>
                            <option value="PLANEJAMENTO" {{ 'selected' if obra and obra.status == 'PLANEJAMENTO' else '' }}>Planejamento</option>
                            <option value="Pausada" {{ 'selected' if obra and obra.status == 'Pausada' else '' }}>Pausada</option>
                            <option value="Concluída" {{ 'selected' if obra and obra.status == 'Concluída' else '' }}>Concluída</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <!-- Cliente Nome -->
                    <div class="col-md-4 mb-3">
                        <label for="cliente_nome" class="form-label">
                            <i class="fas fa-user text-info"></i> Nome do Cliente
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="cliente_nome" 
                               name="cliente_nome" 
                               value="{{ obra.cliente_nome if obra and obra.cliente_nome else '' }}"
                               placeholder="Nome completo do cliente">
                    </div>
                    
                    <!-- Cliente Email -->
                    <div class="col-md-4 mb-3">
                        <label for="cliente_email" class="form-label">
                            <i class="fas fa-envelope text-info"></i> Email do Cliente
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="cliente_email" 
                               name="cliente_email" 
                               value="{{ obra.cliente_email if obra and obra.cliente_email else '' }}"
                               placeholder="email@cliente.com">
                    </div>
                    
                    <!-- Cliente Telefone -->
                    <div class="col-md-4 mb-3">
                        <label for="cliente_telefone" class="form-label">
                            <i class="fas fa-phone text-info"></i> Telefone do Cliente
                        </label>
                        <input type="tel" 
                               class="form-control" 
                               id="cliente_telefone" 
                               name="cliente_telefone" 
                               value="{{ obra.cliente_telefone if obra and obra.cliente_telefone else '' }}"
                               placeholder="(11) 99999-9999">
                    </div>
                </div>

                <div class="row">
                    <!-- Endereço -->
                    <div class="col-md-8 mb-3">
                        <label for="endereco" class="form-label">
                            <i class="fas fa-map-marker-alt text-warning"></i> Endereço da Obra
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="endereco" 
                               name="endereco" 
                               value="{{ obra.endereco if obra and obra.endereco else '' }}"
                               placeholder="Endereço completo da obra">
                    </div>
                    
                    <!-- Área Total -->
                    <div class="col-md-4 mb-3">
                        <label for="area_total_m2" class="form-label">
                            <i class="fas fa-ruler-combined text-warning"></i> Área Total (m²)
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="area_total_m2" 
                               name="area_total_m2" 
                               step="0.01" 
                               value="{{ obra.area_total_m2 if obra and obra.area_total_m2 else '' }}"
                               placeholder="0.00">
                    </div>
                </div>

                <div class="row">
                    <!-- Data de Início -->
                    <div class="col-md-3 mb-3">
                        <label for="data_inicio" class="form-label">
                            <i class="fas fa-calendar-alt text-success"></i> Data de Início *
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="data_inicio" 
                               name="data_inicio" 
                               value="{{ obra.data_inicio.strftime('%Y-%m-%d') if obra and obra.data_inicio else '' }}" 
                               required>
                    </div>
                    
                    <!-- Data de Previsão de Fim -->
                    <div class="col-md-3 mb-3">
                        <label for="data_previsao_fim" class="form-label">
                            <i class="fas fa-calendar-check text-warning"></i> Previsão de Fim
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="data_previsao_fim" 
                               name="data_previsao_fim" 
                               value="{{ obra.data_previsao_fim.strftime('%Y-%m-%d') if obra and obra.data_previsao_fim else '' }}">
                    </div>
                    
                    <!-- Responsável -->
                    <div class="col-md-6 mb-3">
                        <label for="responsavel_id" class="form-label">
                            <i class="fas fa-user-hard-hat text-primary"></i> Responsável pela Obra
                        </label>
                        <select class="form-select" id="responsavel_id" name="responsavel_id">
                            <option value="">Selecione um responsável</option>
                            {% if funcionarios %}
                                {% for funcionario in funcionarios %}
                                <option value="{{ funcionario.id }}" {{ 'selected' if obra and obra.responsavel_id == funcionario.id else '' }}>
                                    {{ funcionario.nome }} - {{ funcionario.funcao.nome if funcionario.funcao else 'Sem função' }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <!-- Orçamento Inicial -->
                    <div class="col-md-3 mb-3">
                        <label for="orcamento" class="form-label">
                            <i class="fas fa-calculator text-primary"></i> Orçamento Inicial (R$)
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="orcamento" 
                               name="orcamento" 
                               step="0.01" 
                               value="{{ obra.orcamento if obra and obra.orcamento else '' }}"
                               placeholder="0.00">
                    </div>
                    
                    <!-- Valor do Contrato -->
                    <div class="col-md-3 mb-3">
                        <label for="valor_contrato" class="form-label">
                            <i class="fas fa-file-contract text-info"></i> Valor do Contrato (R$)
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="valor_contrato" 
                               name="valor_contrato" 
                               step="0.01" 
                               value="{{ obra.valor_contrato if obra and obra.valor_contrato else '' }}"
                               placeholder="0.00">
                    </div>
                    
                    <!-- Código da Obra -->
                    <div class="col-md-3 mb-3">
                        <label for="codigo" class="form-label">
                            <i class="fas fa-hashtag text-secondary"></i> Código da Obra
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="codigo" 
                               name="codigo" 
                               value="{{ obra.codigo if obra and obra.codigo else '' }}"
                               placeholder="Ex: OBR001">
                        <small class="form-text text-muted">Deixe em branco para gerar automaticamente</small>
                    </div>
                    
                    <!-- Portal Ativo -->
                    <div class="col-md-3 mb-3">
                        <label for="portal_ativo" class="form-label">
                            <i class="fas fa-globe text-info"></i> Portal do Cliente
                        </label>
                        <select class="form-select" id="portal_ativo" name="portal_ativo">
                            <option value="1" {{ 'selected' if not obra or (obra and obra.portal_ativo) else '' }}>Ativo</option>
                            <option value="0" {{ 'selected' if obra and not obra.portal_ativo else '' }}>Inativo</option>
                        </select>
                        <small class="form-text text-muted">Permite ao cliente acompanhar a obra online</small>
                    </div>
                </div>

                <!-- Informações adicionais se editando -->
                {% if obra %}
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Informações:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Código da obra: <strong>{{ obra.codigo if obra.codigo else 'Não definido' }}</strong></li>
                                <li>Criada em: <strong>{{ obra.created_at.strftime('%d/%m/%Y às %H:%M') if obra.created_at else 'Não disponível' }}</strong></li>
                                <li>Admin ID: <strong>{{ obra.admin_id }}</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Botões de Ação -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {{ 'Atualizar Obra' if obra else 'Criar Obra' }}
                                </button>
                                <a href="{{ url_for('main.obras') }}" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </div>
                            
                            {% if obra %}
                            <div>
                                <button type="button" 
                                        class="btn btn-outline-danger" 
                                        onclick="confirmarExclusao({{ obra.id }}, '{{ obra.nome }}')">
                                    <i class="fas fa-trash"></i> Excluir Obra
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
{% if obra %}
<div class="modal fade" id="modalExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a obra <strong id="nomeObraExclusao"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i>
                    <strong>Atenção:</strong> Esta ação não pode ser desfeita. Todos os dados relacionados à obra serão verificados antes da exclusão.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" id="formExclusao" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Confirmar Exclusão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
{% if obra %}
function confirmarExclusao(obraId, nomeObra) {
    document.getElementById('nomeObraExclusao').textContent = nomeObra;
    document.getElementById('formExclusao').action = `/obras/excluir/${obraId}`;
    new bootstrap.Modal(document.getElementById('modalExclusao')).show();
}
{% endif %}

// Validação do formulário
document.getElementById('obraForm').addEventListener('submit', function(e) {
    const nome = document.getElementById('nome').value.trim();
    const dataInicio = document.getElementById('data_inicio').value;
    
    if (!nome) {
        e.preventDefault();
        alert('Por favor, informe o nome da obra.');
        document.getElementById('nome').focus();
        return;
    }
    
    if (!dataInicio) {
        e.preventDefault();
        alert('Por favor, informe a data de início da obra.');
        document.getElementById('data_inicio').focus();
        return;
    }
});
</script>
{% endblock %}