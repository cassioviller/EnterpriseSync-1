{% extends "veiculos_avancado/base_veiculos.html" %}

{% block title %}Relatório TCO - {{ veiculo.placa }}{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{{ url_for('veiculos_avancado.dashboard_financeiro') }}">Dashboard</a></li>
    <li class="breadcrumb-item active">Relatório TCO</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-chart-bar text-primary me-2"></i>
                Relatório TCO (Total Cost of Ownership)
            </h2>
            <p class="text-muted mb-0">{{ veiculo.placa }} - {{ veiculo.marca }} {{ veiculo.modelo }} ({{ veiculo.ano or 'N/A' }})</p>
        </div>
        <div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-custom dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Exportar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('veiculos_avancado.relatorio_tco', veiculo_id=veiculo.id, formato='pdf') }}">
                        <i class="fas fa-file-pdf me-2"></i>PDF
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('veiculos_avancado.relatorio_tco', veiculo_id=veiculo.id, formato='excel') }}">
                        <i class="fas fa-file-excel me-2"></i>Excel
                    </a></li>
                </ul>
            </div>
            <button class="btn btn-outline-secondary btn-custom ms-2" onclick="window.print()">
                <i class="fas fa-print me-1"></i>Imprimir
            </button>
        </div>
    </div>

    <!-- Filtros de Período -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Período de Análise</label>
                    <select name="periodo" class="form-select" onchange="toggleCustomPeriod()">
                        <option value="3_meses" {{ 'selected' if request.args.get('periodo') == '3_meses' }}>Últimos 3 Meses</option>
                        <option value="6_meses" {{ 'selected' if request.args.get('periodo') == '6_meses' }}>Últimos 6 Meses</option>
                        <option value="1_ano" {{ 'selected' if request.args.get('periodo') == '1_ano' }}>Último Ano</option>
                        <option value="2_anos" {{ 'selected' if request.args.get('periodo') == '2_anos' }}>Últimos 2 Anos</option>
                        <option value="personalizado" {{ 'selected' if request.args.get('periodo') == 'personalizado' }}>Período Personalizado</option>
                    </select>
                </div>
                <div class="col-md-2" id="dataInicio" style="display: {{ 'block' if request.args.get('periodo') == 'personalizado' else 'none' }};">
                    <label class="form-label">Data Início</label>
                    <input type="date" name="data_inicio" class="form-control" value="{{ request.args.get('data_inicio', '') }}">
                </div>
                <div class="col-md-2" id="dataFim" style="display: {{ 'block' if request.args.get('periodo') == 'personalizado' else 'none' }};">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="data_fim" class="form-control" value="{{ request.args.get('data_fim', '') }}">
                </div>
                <div class="col-md-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="incluir_depreciacao" value="1" 
                               {{ 'checked' if request.args.get('incluir_depreciacao') }} id="incluirDepreciacao">
                        <label class="form-check-label" for="incluirDepreciacao">
                            Incluir Depreciação
                        </label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sync me-1"></i>Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumo Executivo TCO -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center h-100 border-primary">
                <div class="card-body">
                    <h3 class="text-primary mb-2">R$ {{ "%.2f"|format(tco.custo_total) | replace('.', ',') }}</h3>
                    <p class="text-muted mb-0 fw-bold">Custo Total (TCO)</p>
                    <small class="text-muted">{{ tco.periodo_analise }}</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center h-100 border-success">
                <div class="card-body">
                    <h3 class="text-success mb-2">R$ {{ "%.2f"|format(tco.custo_por_km) | replace('.', ',') }}</h3>
                    <p class="text-muted mb-0 fw-bold">Custo por KM</p>
                    <small class="text-muted">{{ "{:,}".format(tco.km_rodados).replace(',', '.') }} km no período</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center h-100 border-warning">
                <div class="card-body">
                    <h3 class="text-warning mb-2">R$ {{ "%.2f"|format(tco.custo_mensal) | replace('.', ',') }}</h3>
                    <p class="text-muted mb-0 fw-bold">Custo Mensal Médio</p>
                    <small class="text-muted">Baseado em {{ tco.meses_analise }} meses</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center h-100 border-info">
                <div class="card-body">
                    <h3 class="text-info mb-2">{{ tco.disponibilidade }}%</h3>
                    <p class="text-muted mb-0 fw-bold">Disponibilidade</p>
                    <small class="text-muted">{{ tco.dias_manutencao }} dias em manutenção</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gráficos de Análise -->
        <div class="col-lg-8">
            <!-- Breakdown de Custos -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-pie-chart me-2"></i>Distribuição de Custos por Categoria
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="graficoDistribuicao"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Categoria</th>
                                            <th class="text-end">Valor</th>
                                            <th class="text-end">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in tco.breakdown_categorias %}
                                        <tr>
                                            <td>
                                                <span class="badge" style="background-color: {{ categoria.cor }}; width: 12px; height: 12px; display: inline-block; margin-right: 8px;"></span>
                                                {{ categoria.nome }}
                                            </td>
                                            <td class="text-end">R$ {{ "%.2f"|format(categoria.valor) | replace('.', ',') }}</td>
                                            <td class="text-end">{{ "%.1f"|format(categoria.percentual) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evolução Temporal -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-line-chart me-2"></i>Evolução Mensal dos Custos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="graficoEvolucao"></canvas>
                    </div>
                </div>
            </div>

            <!-- Comparativo com Frota -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-balance-scale me-2"></i>Comparativo com a Frota
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h4 class="text-{{ 'success' if tco.ranking_custo <= 3 else 'warning' if tco.ranking_custo <= 6 else 'danger' }}">
                                {{ tco.ranking_custo }}º
                            </h4>
                            <p class="text-muted mb-0">Posição no Ranking de Custos</p>
                            <small class="text-muted">entre {{ tco.total_veiculos }} veículos</small>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-{{ 'danger' if tco.custo_vs_media > 1.2 else 'warning' if tco.custo_vs_media > 1.0 else 'success' }}">
                                {{ "%.1f"|format((tco.custo_vs_media - 1) * 100) }}%
                            </h4>
                            <p class="text-muted mb-0">{{ 'Acima' if tco.custo_vs_media > 1 else 'Abaixo' }} da Média</p>
                            <small class="text-muted">Média da frota: R$ {{ "%.2f"|format(tco.media_frota) | replace('.', ',') }}/km</small>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-{{ 'success' if tco.eficiencia == 'alta' else 'warning' if tco.eficiencia == 'media' else 'danger' }}">
                                {{ tco.eficiencia.title() }}
                            </h4>
                            <p class="text-muted mb-0">Eficiência Operacional</p>
                            <small class="text-muted">Baseada em custo/km e disponibilidade</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Detalhes e Insights -->
        <div class="col-lg-4">
            <!-- Insights e Recomendações -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Insights e Recomendações
                    </h6>
                </div>
                <div class="card-body">
                    {% for insight in tco.insights %}
                    <div class="alert alert-{{ insight.tipo }} alert-sm mb-2">
                        <i class="fas fa-{{ insight.icone }} me-2"></i>
                        <strong>{{ insight.titulo }}:</strong> {{ insight.descricao }}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Próximas Manutenções -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Próximas Manutenções
                    </h6>
                </div>
                <div class="card-body">
                    {% if tco.proximas_manutencoes %}
                    {% for manutencao in tco.proximas_manutencoes %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="fw-bold">{{ manutencao.tipo }}</small>
                            <small class="text-{{ 'danger' if manutencao.dias_restantes <= 7 else 'warning' if manutencao.dias_restantes <= 30 else 'muted' }}">
                                {{ manutencao.dias_restantes }} dias
                            </small>
                        </div>
                        <small class="text-muted">{{ manutencao.descricao }}</small>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0">Nenhuma manutenção programada</p>
                    {% endif %}
                </div>
            </div>

            <!-- Dados Técnicos -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>Dados Técnicos
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">KM Inicial:</td>
                            <td class="text-end">{{ "{:,}".format(tco.km_inicial).replace(',', '.') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">KM Atual:</td>
                            <td class="text-end">{{ "{:,}".format(tco.km_atual).replace(',', '.') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">KM Rodados:</td>
                            <td class="text-end fw-bold">{{ "{:,}".format(tco.km_rodados).replace(',', '.') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Média KM/Mês:</td>
                            <td class="text-end">{{ "{:,}".format(tco.km_mensal_medio).replace(',', '.') }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Idade do Veículo:</td>
                            <td class="text-end">{{ tco.idade_anos }} anos</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Últimos Custos -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>Últimos Custos
                    </h6>
                </div>
                <div class="card-body">
                    {% if tco.ultimos_custos %}
                    {% for custo in tco.ultimos_custos %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="fw-bold">{{ custo.tipo_custo.title() }}</small>
                            <small class="text-success">R$ {{ "%.2f"|format(custo.valor) | replace('.', ',') }}</small>
                        </div>
                        <small class="text-muted">{{ custo.data_custo.strftime('%d/%m/%Y') if custo.data_custo else '-' }}</small>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0">Nenhum custo registrado</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados dos gráficos
const dadosDistribuicao = {{ tco.dados_grafico_distribuicao | tojson | safe }};
const dadosEvolucao = {{ tco.dados_grafico_evolucao | tojson | safe }};

// Gráfico de Distribuição
if (dadosDistribuicao && dadosDistribuicao.labels.length > 0) {
    const ctxDist = document.getElementById('graficoDistribuicao').getContext('2d');
    new Chart(ctxDist, {
        type: 'doughnut',
        data: {
            labels: dadosDistribuicao.labels,
            datasets: [{
                data: dadosDistribuicao.values,
                backgroundColor: dadosDistribuicao.colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return context.label + ': R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Evolução
if (dadosEvolucao && dadosEvolucao.labels.length > 0) {
    const ctxEv = document.getElementById('graficoEvolucao').getContext('2d');
    new Chart(ctxEv, {
        type: 'line',
        data: {
            labels: dadosEvolucao.labels,
            datasets: [{
                label: 'Custos Mensais (R$)',
                data: dadosEvolucao.values,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#17a2b8',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Custos: R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            }
        }
    });
}

function toggleCustomPeriod() {
    const periodo = document.querySelector('select[name="periodo"]').value;
    const dataInicio = document.getElementById('dataInicio');
    const dataFim = document.getElementById('dataFim');
    
    if (periodo === 'personalizado') {
        dataInicio.style.display = 'block';
        dataFim.style.display = 'block';
    } else {
        dataInicio.style.display = 'none';
        dataFim.style.display = 'none';
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.alert-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

@media print {
    .btn, .dropdown, .card-header .btn-group {
        display: none !important;
    }
    
    .chart-container {
        height: 300px !important;
    }
}
</style>
{% endblock %}