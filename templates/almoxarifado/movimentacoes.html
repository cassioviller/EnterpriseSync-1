{% extends "base_completo.html" %}

{% block title %}Movimentações - Almoxarifado{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<style>
    .badge-movimento {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
        font-weight: 600;
    }
    .table-movimentacoes td {
        vertical-align: middle;
    }
    .filtros-card {
        background: #fff;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i data-feather="activity" class="text-success me-2"></i>
                Movimentações de Estoque
            </h1>
            <p class="text-muted mb-0">Histórico completo de entradas, saídas e devoluções</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('almoxarifado.dashboard') }}" class="btn btn-outline-secondary">
                <i data-feather="arrow-left" style="width: 16px; height: 16px;"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Card de Filtros -->
    <div class="card filtros-card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i data-feather="filter" class="text-primary me-2"></i>
                Filtros Avançados
            </h5>
            <form method="GET" action="{{ url_for('almoxarifado.movimentacoes') }}">
                <div class="row g-3">
                    <!-- Período -->
                    <div class="col-md-3">
                        <label for="data_inicio" class="form-label">
                            <i data-feather="calendar" style="width: 14px; height: 14px;"></i>
                            Data Início
                        </label>
                        <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                               value="{{ data_inicio }}">
                    </div>
                    <div class="col-md-3">
                        <label for="data_fim" class="form-label">
                            <i data-feather="calendar" style="width: 14px; height: 14px;"></i>
                            Data Fim
                        </label>
                        <input type="date" class="form-control" id="data_fim" name="data_fim" 
                               value="{{ data_fim }}">
                    </div>

                    <!-- Tipo de Movimento -->
                    <div class="col-md-3">
                        <label for="tipo_movimento" class="form-label">
                            <i data-feather="list" style="width: 14px; height: 14px;"></i>
                            Tipo de Movimento
                        </label>
                        <select class="form-select" id="tipo_movimento" name="tipo_movimento">
                            <option value="">Todos</option>
                            <option value="ENTRADA" {% if tipo_movimento == 'ENTRADA' %}selected{% endif %}>
                                Entrada
                            </option>
                            <option value="SAIDA" {% if tipo_movimento == 'SAIDA' %}selected{% endif %}>
                                Saída
                            </option>
                            <option value="DEVOLUCAO" {% if tipo_movimento == 'DEVOLUCAO' %}selected{% endif %}>
                                Devolução
                            </option>
                        </select>
                    </div>

                    <!-- Item -->
                    <div class="col-md-3">
                        <label for="item_id" class="form-label">
                            <i data-feather="package" style="width: 14px; height: 14px;"></i>
                            Item
                        </label>
                        <select class="form-select" id="item_id" name="item_id">
                            <option value="">Todos</option>
                            {% for item in itens %}
                            <option value="{{ item.id }}" {% if item_id == item.id %}selected{% endif %}>
                                {{ item.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <!-- Funcionário -->
                    <div class="col-md-4">
                        <label for="funcionario_id" class="form-label">
                            <i data-feather="user" style="width: 14px; height: 14px;"></i>
                            Funcionário
                        </label>
                        <select class="form-select" id="funcionario_id" name="funcionario_id">
                            <option value="">Todos</option>
                            {% for funcionario in funcionarios %}
                            <option value="{{ funcionario.id }}" {% if funcionario_id == funcionario.id %}selected{% endif %}>
                                {{ funcionario.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Obra -->
                    <div class="col-md-4">
                        <label for="obra_id" class="form-label">
                            <i data-feather="map-pin" style="width: 14px; height: 14px;"></i>
                            Obra
                        </label>
                        <select class="form-select" id="obra_id" name="obra_id">
                            <option value="">Todas</option>
                            {% for obra in obras %}
                            <option value="{{ obra.id }}" {% if obra_id == obra.id %}selected{% endif %}>
                                {{ obra.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Botões -->
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-success flex-fill">
                            <i data-feather="search" style="width: 16px; height: 16px;"></i> Filtrar
                        </button>
                        <a href="{{ url_for('almoxarifado.movimentacoes') }}" class="btn btn-outline-secondary">
                            <i data-feather="x" style="width: 16px; height: 16px;"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Card de Resultados -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i data-feather="list" class="text-success me-2"></i>
                    Movimentações Encontradas
                </h5>
                {% if total_registros > 0 %}
                <span class="badge bg-success">
                    Mostrando {{ inicio }}-{{ fim }} de {{ total_registros }} registros
                </span>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            {% if movimentacoes.items %}
                <div class="table-responsive">
                    <table class="table table-movimentacoes table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 130px;">Data/Hora</th>
                                <th style="width: 110px;">Tipo</th>
                                <th>Item</th>
                                <th style="width: 150px;">Qtd/Serial</th>
                                <th>Funcionário</th>
                                <th>Obra</th>
                                <th style="width: 120px;" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in movimentacoes.items %}
                            <tr>
                                <!-- Data/Hora -->
                                <td>
                                    <div class="fw-semibold">{{ mov.data_movimento.strftime('%d/%m/%Y') }}</div>
                                    <small class="text-muted">{{ mov.data_movimento.strftime('%H:%M') }}</small>
                                </td>

                                <!-- Tipo (Badge colorido) -->
                                <td>
                                    {% if mov.tipo_movimento == 'ENTRADA' %}
                                        <span class="badge bg-success badge-movimento">
                                            <i data-feather="arrow-down-circle" style="width: 14px; height: 14px;"></i>
                                            ENTRADA
                                        </span>
                                    {% elif mov.tipo_movimento == 'SAIDA' %}
                                        <span class="badge bg-danger badge-movimento">
                                            <i data-feather="arrow-up-circle" style="width: 14px; height: 14px;"></i>
                                            SAÍDA
                                        </span>
                                    {% elif mov.tipo_movimento == 'DEVOLUCAO' %}
                                        <span class="badge bg-warning badge-movimento">
                                            <i data-feather="rotate-ccw" style="width: 14px; height: 14px;"></i>
                                            DEVOLUÇÃO
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary badge-movimento">{{ mov.tipo_movimento }}</span>
                                    {% endif %}
                                </td>

                                <!-- Item -->
                                <td>
                                    <div class="fw-semibold">{{ mov.item.nome }}</div>
                                    <small class="text-muted">{{ mov.item.codigo }}</small>
                                </td>

                                <!-- Quantidade/Serial -->
                                <td>
                                    {% if mov.numero_serie %}
                                        <span class="badge bg-info">
                                            <i data-feather="hash" style="width: 12px; height: 12px;"></i>
                                            {{ mov.numero_serie }}
                                        </span>
                                    {% else %}
                                        <span class="fw-semibold">
                                            {% if mov.tipo_movimento == 'SAIDA' %}
                                                <span class="text-danger">-{{ mov.quantidade }}</span>
                                            {% else %}
                                                <span class="text-success">+{{ mov.quantidade }}</span>
                                            {% endif %}
                                            {{ mov.item.unidade }}
                                        </span>
                                    {% endif %}
                                </td>

                                <!-- Funcionário -->
                                <td>
                                    {% if mov.funcionario %}
                                        <i data-feather="user" style="width: 14px; height: 14px;" class="text-muted"></i>
                                        {{ mov.funcionario.nome }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>

                                <!-- Obra -->
                                <td>
                                    {% if mov.obra %}
                                        <i data-feather="map-pin" style="width: 14px; height: 14px;" class="text-muted"></i>
                                        {{ mov.obra.nome }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>

                                <!-- Ações -->
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('almoxarifado.movimentacoes_editar', id=mov.id) }}" 
                                           class="btn btn-outline-primary" 
                                           title="Editar movimentação">
                                            <i data-feather="edit-2" style="width: 14px; height: 14px;"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-excluir-mov" 
                                                data-mov-id="{{ mov.id }}"
                                                data-mov-tipo="{{ mov.tipo_movimento }}"
                                                data-mov-item="{{ mov.item.nome }}"
                                                data-mov-quantidade="{{ mov.quantidade }}"
                                                data-mov-unidade="{{ mov.item.unidade or 'un' }}"
                                                data-mov-data="{{ mov.data_movimento.strftime('%d/%m/%Y %H:%M') if mov.data_movimento else '-' }}"
                                                data-mov-observacao="{{ mov.observacao or '' }}"
                                                data-mov-updated-at="{{ mov.updated_at if mov.updated_at else '' }}"
                                                title="Excluir movimentação">
                                            <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                                        </button>
                                        <a href="{{ url_for('almoxarifado.itens_detalhes', id=mov.item.id) }}" 
                                           class="btn btn-outline-success" 
                                           title="Ver Detalhes do Item">
                                            <i data-feather="eye" style="width: 14px; height: 14px;"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                {% if movimentacoes.pages > 1 %}
                <div class="p-3 border-top">
                    <nav aria-label="Navegação de páginas">
                        <ul class="pagination justify-content-center mb-0">
                            <!-- Botão Anterior -->
                            {% if movimentacoes.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('almoxarifado.movimentacoes', page=movimentacoes.prev_num, data_inicio=data_inicio, data_fim=data_fim, tipo_movimento=tipo_movimento, funcionario_id=funcionario_id, obra_id=obra_id, item_id=item_id) }}">
                                    <i data-feather="chevron-left" style="width: 14px; height: 14px;"></i>
                                    Anterior
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">
                                    <i data-feather="chevron-left" style="width: 14px; height: 14px;"></i>
                                    Anterior
                                </span>
                            </li>
                            {% endif %}

                            <!-- Números de Página -->
                            {% for page_num in movimentacoes.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                {% if page_num %}
                                    {% if page_num == movimentacoes.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('almoxarifado.movimentacoes', page=page_num, data_inicio=data_inicio, data_fim=data_fim, tipo_movimento=tipo_movimento, funcionario_id=funcionario_id, obra_id=obra_id, item_id=item_id) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Botão Próximo -->
                            {% if movimentacoes.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('almoxarifado.movimentacoes', page=movimentacoes.next_num, data_inicio=data_inicio, data_fim=data_fim, tipo_movimento=tipo_movimento, funcionario_id=funcionario_id, obra_id=obra_id, item_id=item_id) }}">
                                    Próximo
                                    <i data-feather="chevron-right" style="width: 14px; height: 14px;"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">
                                    Próximo
                                    <i data-feather="chevron-right" style="width: 14px; height: 14px;"></i>
                                </span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}

            {% else %}
                <!-- Mensagem de lista vazia -->
                <div class="text-center py-5">
                    <i data-feather="inbox" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma movimentação encontrada</h5>
                    <p class="text-muted">
                        {% if data_inicio or data_fim or tipo_movimento or funcionario_id or obra_id or item_id %}
                            Tente ajustar os filtros para encontrar movimentações.
                        {% else %}
                            Ainda não há movimentações registradas no sistema.
                        {% endif %}
                    </p>
                    <a href="{{ url_for('almoxarifado.entrada') }}" class="btn btn-success mt-2">
                        <i data-feather="plus-circle" style="width: 16px; height: 16px;"></i>
                        Registrar Primeira Entrada
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Único de Confirmação de Exclusão -->
<div class="modal fade" id="modalExcluirMovimentacao" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalExcluirLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Tem certeza que deseja excluir esta movimentação?</p>
                <div class="card bg-light">
                    <div class="card-body">
                        <p class="mb-1"><strong>Tipo:</strong> <span id="modal-tipo"></span></p>
                        <p class="mb-1"><strong>Item:</strong> <span id="modal-item"></span></p>
                        <p class="mb-1"><strong>Quantidade:</strong> <span id="modal-quantidade"></span></p>
                        <p class="mb-1"><strong>Data:</strong> <span id="modal-data"></span></p>
                        <p class="mb-0" id="modal-observacao-container" style="display: none;">
                            <strong>Observação:</strong> <span id="modal-observacao"></span>
                        </p>
                    </div>
                </div>
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Atenção:</strong> Esta ação reverterá o impacto desta movimentação no estoque e não poderá ser desfeita.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <form method="POST" id="form-excluir-movimentacao" style="display: inline;">
                    <input type="hidden" name="updated_at_original" id="modal-updated-at">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Sim, Excluir
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Inicializar Feather Icons apenas uma vez
    let featherInitialized = false;
    
    function initFeatherIcons() {
        if (typeof feather !== 'undefined' && !featherInitialized) {
            feather.replace();
            featherInitialized = true;
        }
    }
    
    // Configurar modal de exclusão
    function setupDeleteModal() {
        const modal = document.getElementById('modalExcluirMovimentacao');
        const form = document.getElementById('form-excluir-movimentacao');
        
        if (!modal || !form) {
            console.error('Modal ou formulário de exclusão não encontrado');
            return;
        }
        
        // Bootstrap Modal instance
        const bsModal = new bootstrap.Modal(modal);
        
        // Event listeners para todos os botões de exclusão
        document.querySelectorAll('.btn-excluir-mov').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Obter dados do botão clicado
                const movId = this.getAttribute('data-mov-id');
                const movTipo = this.getAttribute('data-mov-tipo');
                const movItem = this.getAttribute('data-mov-item');
                const movQuantidade = this.getAttribute('data-mov-quantidade');
                const movUnidade = this.getAttribute('data-mov-unidade');
                const movData = this.getAttribute('data-mov-data');
                const movObservacao = this.getAttribute('data-mov-observacao');
                const movUpdatedAt = this.getAttribute('data-mov-updated-at');
                
                // Popular campos do modal
                document.getElementById('modal-tipo').textContent = movTipo;
                document.getElementById('modal-item').textContent = movItem;
                document.getElementById('modal-quantidade').textContent = movQuantidade + ' ' + movUnidade;
                document.getElementById('modal-data').textContent = movData;
                
                // Observação (mostrar apenas se houver)
                const obsContainer = document.getElementById('modal-observacao-container');
                const obsSpan = document.getElementById('modal-observacao');
                if (movObservacao && movObservacao.trim() !== '') {
                    obsSpan.textContent = movObservacao;
                    obsContainer.style.display = 'block';
                } else {
                    obsContainer.style.display = 'none';
                }
                
                // Configurar action do formulário
                form.action = '/almoxarifado/movimentacoes/' + movId + '/deletar';
                
                // Configurar campo hidden para optimistic locking
                document.getElementById('modal-updated-at').value = movUpdatedAt;
                
                // Abrir modal
                bsModal.show();
            });
        });
    }
    
    // Inicializar quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        initFeatherIcons();
        setupDeleteModal();
    });
})();
</script>
{% endblock %}
