{% extends "base_completo.html" %}

{% block title %}Devolução de Materiais - Almoxarifado{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-undo text-primary me-2"></i>
                Devolução de Materiais
            </h1>
            <p class="text-muted mb-0">Registrar devolução de itens ao almoxarifado</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('almoxarifado.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form id="formDevolucao">
                        <!-- Seleção de Funcionário -->
                        <div class="mb-4">
                            <label for="funcionario_id" class="form-label fw-bold">
                                <i class="fas fa-user text-primary me-1"></i> Funcionário *
                            </label>
                            <select class="form-select form-select-lg" id="funcionario_id" name="funcionario_id">
                                <option value="">Selecione um funcionário...</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{ funcionario.id }}">{{ funcionario.codigo }} - {{ funcionario.nome }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Selecione o funcionário que está devolvendo os itens
                            </small>
                        </div>

                        <!-- Área de Itens do Funcionário (exibida dinamicamente) -->
                        <div id="areaItens" style="display: none;">
                            <!-- Loading Indicator -->
                            <div id="loadingItens" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="text-muted mt-2">Carregando itens do funcionário...</p>
                            </div>

                            <!-- Nenhum Item Disponível -->
                            <div id="semItens" class="alert alert-warning border-0" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Nenhum item disponível para devolução.</strong>
                                <p class="mb-0 small">Este funcionário não possui itens que possam ser devolvidos.</p>
                            </div>

                            <!-- Lista de Itens Serializados -->
                            <div id="itensSerializados" style="display: none;">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-barcode text-warning me-1"></i> Itens Serializados para Devolução
                                    </label>
                                    <div id="listaSerializados" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Selecione um ou mais itens para adicionar ao carrinho.
                                    </small>
                                </div>
                            </div>

                            <!-- Lista de Itens Consumíveis -->
                            <div id="itensConsumiveis" style="display: none;">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calculator text-success me-1"></i> Itens Consumíveis para Devolução
                                    </label>
                                    <div id="listaConsumiveis" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Informe a quantidade e condição de cada item a devolver.
                                    </small>
                                </div>
                            </div>

                            <!-- Botões -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary btn-lg" id="btnAdicionarCarrinho" disabled>
                                    <i class="fas fa-cart-plus me-1"></i> Adicionar ao Carrinho
                                </button>
                                <button type="reset" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-eraser me-1"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Carrinho de Itens -->
            <div class="card border-0 shadow-sm mt-3" id="carrinhoContainer" style="display: none;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Itens no Carrinho (<span id="carrinhoCount">0</span>)
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Observações Gerais -->
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">
                            <i class="fas fa-comment-alt text-secondary me-1"></i> Observações Gerais
                        </label>
                        <textarea class="form-control" id="observacoes" rows="2" 
                                  placeholder="Observações que serão aplicadas a todos os itens desta devolução (opcional)"></textarea>
                    </div>

                    <div id="carrinhoItens" class="mb-3"></div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-danger" id="btnLimparCarrinho">
                            <i class="fas fa-trash me-1"></i> Limpar Carrinho
                        </button>
                        <button type="button" class="btn btn-success btn-lg" id="btnFinalizarDevolucao">
                            <i class="fas fa-check-circle me-1"></i> Finalizar Devolução
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel de Ajuda -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-question-circle text-info me-2"></i>
                        Como Funciona?
                    </h5>
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-shopping-cart me-1"></i> Sistema de Carrinho
                        </h6>
                        <p class="small mb-0">
                            Agora você pode adicionar múltiplos itens ao carrinho:
                        </p>
                        <ul class="small">
                            <li>Selecione o funcionário</li>
                            <li>Escolha os itens e suas condições</li>
                            <li>Adicione vários itens ao carrinho</li>
                            <li>Finalize a devolução de uma vez</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-barcode me-1"></i> Itens Serializados
                        </h6>
                        <p class="small mb-0">
                            Para itens com controle por número de série:
                        </p>
                        <ul class="small">
                            <li>Sempre podem ser devolvidos</li>
                            <li>Selecione condição por item</li>
                            <li>Status volta para "DISPONÍVEL" se em bom estado</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold text-success">
                            <i class="fas fa-calculator me-1"></i> Itens Consumíveis
                        </h6>
                        <p class="small mb-0">
                            Para itens de controle por quantidade:
                        </p>
                        <ul class="small">
                            <li>Somente se permitir devolução</li>
                            <li>Informe quantidade e condição</li>
                            <li>Quantidade volta ao estoque disponível</li>
                        </ul>
                    </div>
                    <div class="alert alert-info border-0 small">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Condição Obrigatória:</strong> Cada item deve ter sua condição informada para melhor controle de qualidade.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const funcionarioSelect = document.getElementById('funcionario_id');
    const areaItens = document.getElementById('areaItens');
    const loadingItens = document.getElementById('loadingItens');
    const semItens = document.getElementById('semItens');
    const itensSerializados = document.getElementById('itensSerializados');
    const itensConsumiveis = document.getElementById('itensConsumiveis');
    const listaSerializados = document.getElementById('listaSerializados');
    const listaConsumiveis = document.getElementById('listaConsumiveis');
    const btnAdicionarCarrinho = document.getElementById('btnAdicionarCarrinho');
    const formDevolucao = document.getElementById('formDevolucao');
    const carrinhoContainer = document.getElementById('carrinhoContainer');
    const carrinhoItens = document.getElementById('carrinhoItens');
    const carrinhoCount = document.getElementById('carrinhoCount');
    const btnLimparCarrinho = document.getElementById('btnLimparCarrinho');
    const btnFinalizarDevolucao = document.getElementById('btnFinalizarDevolucao');
    const observacoesInput = document.getElementById('observacoes');

    let carrinho = [];
    let itensData = [];
    let temSerializados = false;
    let temConsumiveis = false;

    funcionarioSelect.addEventListener('change', async function() {
        const funcionarioId = this.value;
        
        if (!funcionarioId) {
            resetFormItens();
            return;
        }

        try {
            areaItens.style.display = 'block';
            loadingItens.style.display = 'block';
            semItens.style.display = 'none';
            itensSerializados.style.display = 'none';
            itensConsumiveis.style.display = 'none';
            btnAdicionarCarrinho.disabled = true;

            const response = await fetch(`/almoxarifado/api/itens-funcionario/${funcionarioId}`);
            
            if (!response.ok) {
                throw new Error('Erro ao buscar itens do funcionário');
            }

            const data = await response.json();
            itensData = data.itens;
            
            loadingItens.style.display = 'none';

            if (itensData.length === 0) {
                semItens.style.display = 'block';
                btnAdicionarCarrinho.disabled = true;
                return;
            }

            // Separar itens por tipo
            const serializados = itensData.filter(item => item.tipo_controle === 'SERIALIZADO');
            const consumiveis = itensData.filter(item => item.tipo_controle === 'CONSUMIVEL');

            temSerializados = serializados.length > 0;
            temConsumiveis = consumiveis.length > 0;

            // Renderizar itens serializados
            if (temSerializados) {
                renderSerializados(serializados);
                itensSerializados.style.display = 'block';
            }

            // Renderizar itens consumíveis
            if (temConsumiveis) {
                renderConsumiveis(consumiveis);
                itensConsumiveis.style.display = 'block';
            }

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao carregar itens do funcionário. Por favor, tente novamente.');
            loadingItens.style.display = 'none';
            semItens.style.display = 'block';
        }
    });

    function renderSerializados(itens) {
        let html = '';
        itens.forEach(item => {
            html += `
                <div class="p-2 border-bottom item-serializado" data-estoque-id="${item.estoque_id}">
                    <div class="form-check">
                        <input class="form-check-input checkbox-serializado" type="checkbox" 
                               value="${item.estoque_id}" id="item_${item.estoque_id}"
                               data-item-id="${item.item_id}"
                               data-item-nome="${item.item_nome}"
                               data-numero-serie="${item.numero_serie}">
                        <label class="form-check-label w-100" for="item_${item.estoque_id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="text-primary">${item.item_nome}</strong>
                                    <div class="small text-muted">
                                        <i class="fas fa-barcode me-1"></i> N/S: ${item.numero_serie}
                                    </div>
                                </div>
                                <div class="text-end small">
                                    <div><i class="fas fa-building me-1"></i> ${item.obra}</div>
                                    <div><i class="fas fa-calendar me-1"></i> ${item.data_saida}</div>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="mt-2 condicao-serializado" style="display: none;">
                        <label class="form-label small">Condição *</label>
                        <select class="form-select form-select-sm select-condicao" data-estoque-id="${item.estoque_id}">
                            <option value="">Selecione...</option>
                            <option value="Perfeito">Perfeito</option>
                            <option value="Bom">Bom</option>
                            <option value="Regular">Regular</option>
                            <option value="Danificado">Danificado</option>
                            <option value="Inutilizado">Inutilizado</option>
                        </select>
                    </div>
                </div>
            `;
        });
        listaSerializados.innerHTML = html;

        // Mostrar/ocultar campo de condição quando checkbox é marcado
        const checkboxes = document.querySelectorAll('.checkbox-serializado');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const condicaoDiv = this.closest('.item-serializado').querySelector('.condicao-serializado');
                const selectCondicao = condicaoDiv.querySelector('.select-condicao');
                
                if (this.checked) {
                    condicaoDiv.style.display = 'block';
                    selectCondicao.required = true;
                } else {
                    condicaoDiv.style.display = 'none';
                    selectCondicao.required = false;
                    selectCondicao.value = '';
                }
                
                validarBotaoAdicionar();
            });
        });

        // Validar quando condição é selecionada
        const selectsCondicao = document.querySelectorAll('.select-condicao');
        selectsCondicao.forEach(select => {
            select.addEventListener('change', validarBotaoAdicionar);
        });
    }

    function renderConsumiveis(itens) {
        let html = '';
        itens.forEach((item, index) => {
            html += `
                <div class="mb-3 p-3 border-bottom item-consumivel" data-item-id="${item.item_id}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong class="text-success">${item.item_nome}</strong>
                            <div class="small text-muted">
                                Disponível para devolução: <strong>${item.quantidade_disponivel} ${item.unidade}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label for="qtd_${item.item_id}" class="form-label small">Quantidade</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control input-consumivel" 
                                       id="qtd_${item.item_id}" 
                                       data-item-id="${item.item_id}"
                                       data-item-nome="${item.item_nome}"
                                       data-unidade="${item.unidade}"
                                       step="0.01" min="0.01" max="${item.quantidade_disponivel}"
                                       placeholder="0.00">
                                <span class="input-group-text">${item.unidade}</span>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label for="cond_${item.item_id}" class="form-label small">Condição *</label>
                            <select class="form-select form-select-sm select-condicao-consumivel" 
                                    id="cond_${item.item_id}" 
                                    data-item-id="${item.item_id}">
                                <option value="">Selecione...</option>
                                <option value="Perfeito">Perfeito</option>
                                <option value="Bom">Bom</option>
                                <option value="Regular">Regular</option>
                                <option value="Danificado">Danificado</option>
                                <option value="Inutilizado">Inutilizado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                Máx: ${item.quantidade_disponivel}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        listaConsumiveis.innerHTML = html;

        // Validar formulário quando mudar quantidade
        const inputs = document.querySelectorAll('.input-consumivel');
        inputs.forEach(input => {
            input.addEventListener('input', validarBotaoAdicionar);
        });

        const selects = document.querySelectorAll('.select-condicao-consumivel');
        selects.forEach(select => {
            select.addEventListener('change', validarBotaoAdicionar);
        });
    }

    function validarBotaoAdicionar() {
        let valido = false;

        // Verificar se há itens serializados selecionados com condição
        if (temSerializados) {
            const checkboxesMarcados = Array.from(document.querySelectorAll('.checkbox-serializado:checked'));
            checkboxesMarcados.forEach(cb => {
                const estoqueId = cb.value;
                const selectCondicao = document.querySelector(`.select-condicao[data-estoque-id="${estoqueId}"]`);
                if (selectCondicao && selectCondicao.value) {
                    valido = true;
                }
            });
        }

        // Verificar se há consumível com quantidade e condição
        if (temConsumiveis) {
            const inputs = document.querySelectorAll('.input-consumivel');
            inputs.forEach(input => {
                const qtd = parseFloat(input.value);
                const itemId = input.dataset.itemId;
                const selectCondicao = document.querySelector(`.select-condicao-consumivel[data-item-id="${itemId}"]`);
                
                if (qtd && qtd > 0 && selectCondicao && selectCondicao.value) {
                    valido = true;
                }
            });
        }

        btnAdicionarCarrinho.disabled = !valido;
    }

    btnAdicionarCarrinho.addEventListener('click', function() {
        const funcionarioId = funcionarioSelect.value;
        const funcionarioNome = funcionarioSelect.options[funcionarioSelect.selectedIndex].text;

        // Adicionar itens serializados selecionados
        if (temSerializados) {
            const checkboxesMarcados = Array.from(document.querySelectorAll('.checkbox-serializado:checked'));
            
            checkboxesMarcados.forEach(cb => {
                const estoqueId = cb.value;
                const itemId = cb.dataset.itemId;
                const itemNome = cb.dataset.itemNome;
                const numeroSerie = cb.dataset.numeroSerie;
                const selectCondicao = document.querySelector(`.select-condicao[data-estoque-id="${estoqueId}"]`);
                const condicao = selectCondicao ? selectCondicao.value : '';

                if (!condicao) {
                    alert('Por favor, selecione a condição para todos os itens marcados.');
                    return;
                }

                carrinho.push({
                    tipo_controle: 'SERIALIZADO',
                    estoque_id: estoqueId,
                    item_id: itemId,
                    item_nome: itemNome,
                    numero_serie: numeroSerie,
                    quantidade: 1,
                    condicao_item: condicao,
                    funcionario_id: funcionarioId,
                    funcionario_nome: funcionarioNome
                });

                // Desmarcar e remover do DOM
                cb.checked = false;
                cb.closest('.item-serializado').remove();
            });
        }

        // Adicionar itens consumíveis com quantidade preenchida
        if (temConsumiveis) {
            const inputs = document.querySelectorAll('.input-consumivel');
            
            inputs.forEach(input => {
                const qtd = parseFloat(input.value);
                if (qtd && qtd > 0) {
                    const itemId = input.dataset.itemId;
                    const itemNome = input.dataset.itemNome;
                    const unidade = input.dataset.unidade;
                    const selectCondicao = document.querySelector(`.select-condicao-consumivel[data-item-id="${itemId}"]`);
                    const condicao = selectCondicao ? selectCondicao.value : '';

                    if (!condicao) {
                        alert('Por favor, selecione a condição para todos os itens com quantidade preenchida.');
                        return;
                    }

                    carrinho.push({
                        tipo_controle: 'CONSUMIVEL',
                        item_id: itemId,
                        item_nome: itemNome,
                        quantidade: qtd,
                        unidade: unidade,
                        condicao_item: condicao,
                        funcionario_id: funcionarioId,
                        funcionario_nome: funcionarioNome
                    });

                    // Limpar campos
                    input.value = '';
                    selectCondicao.value = '';
                }
            });
        }

        atualizarCarrinho();
        validarBotaoAdicionar();
    });

    function atualizarCarrinho() {
        if (carrinho.length === 0) {
            carrinhoContainer.style.display = 'none';
            return;
        }
        
        carrinhoContainer.style.display = 'block';
        carrinhoCount.textContent = carrinho.length;
        
        let html = '<div class="list-group">';
        carrinho.forEach((item, index) => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${item.item_nome}</h6>
                            <p class="mb-1 small text-muted">
                                ${item.tipo_controle === 'SERIALIZADO' 
                                    ? `<strong>N/S:</strong> ${item.numero_serie}` 
                                    : `<strong>Qtd:</strong> ${item.quantidade} ${item.unidade}`}
                            </p>
                            <p class="mb-0 small">
                                <strong>Condição:</strong> <span class="badge bg-info">${item.condicao_item}</span> | 
                                <strong>Funcionário:</strong> ${item.funcionario_nome}
                            </p>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDoCarrinho(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        carrinhoItens.innerHTML = html;
    }

    window.removerDoCarrinho = function(index) {
        carrinho.splice(index, 1);
        atualizarCarrinho();
    };

    btnLimparCarrinho.addEventListener('click', function() {
        if (confirm('Deseja realmente limpar o carrinho?')) {
            carrinho = [];
            atualizarCarrinho();
            // Recarregar itens do funcionário
            funcionarioSelect.dispatchEvent(new Event('change'));
        }
    });

    btnFinalizarDevolucao.addEventListener('click', async function() {
        if (carrinho.length === 0) {
            alert('O carrinho está vazio!');
            return;
        }
        
        const observacoes = observacoesInput.value.trim();
        
        btnFinalizarDevolucao.disabled = true;
        btnFinalizarDevolucao.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processando...';
        
        try {
            const response = await fetch('{{ url_for("almoxarifado.processar_devolucao_multipla") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    itens: carrinho,
                    observacoes: observacoes
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                carrinho = [];
                atualizarCarrinho();
                limparFormularioCompleto();
                window.location.reload();
            } else {
                alert('Erro: ' + result.message);
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao processar devolução. Por favor, tente novamente.');
        } finally {
            btnFinalizarDevolucao.disabled = false;
            btnFinalizarDevolucao.innerHTML = '<i class="fas fa-check-circle me-1"></i> Finalizar Devolução';
        }
    });

    function resetFormItens() {
        areaItens.style.display = 'none';
        loadingItens.style.display = 'none';
        semItens.style.display = 'none';
        itensSerializados.style.display = 'none';
        itensConsumiveis.style.display = 'none';
        listaSerializados.innerHTML = '';
        listaConsumiveis.innerHTML = '';
        btnAdicionarCarrinho.disabled = true;
        itensData = [];
        temSerializados = false;
        temConsumiveis = false;
    }

    function limparFormularioCompleto() {
        resetFormItens();
        funcionarioSelect.value = '';
        observacoesInput.value = '';
    }

    formDevolucao.addEventListener('reset', function() {
        resetFormItens();
    });
});
</script>
{% endblock %}
