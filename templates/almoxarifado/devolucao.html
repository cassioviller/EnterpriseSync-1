{% extends "base_completo.html" %}

{% block title %}Devolução de Materiais - Almoxarifado{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-undo text-primary me-2"></i>
                Devolução de Materiais
            </h1>
            <p class="text-muted mb-0">Registrar devolução de itens ao almoxarifado</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('almoxarifado.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('almoxarifado.processar_devolucao') }}" id="formDevolucao">
                        <!-- Seleção de Funcionário -->
                        <div class="mb-4">
                            <label for="funcionario_id" class="form-label fw-bold">
                                <i class="fas fa-user text-primary me-1"></i> Funcionário *
                            </label>
                            <select class="form-select form-select-lg" id="funcionario_id" name="funcionario_id" required>
                                <option value="">Selecione um funcionário...</option>
                                {% for funcionario in funcionarios %}
                                <option value="{{ funcionario.id }}">{{ funcionario.codigo }} - {{ funcionario.nome }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Selecione o funcionário que está devolvendo os itens
                            </small>
                        </div>

                        <!-- Área de Itens do Funcionário (exibida dinamicamente) -->
                        <div id="areaItens" style="display: none;">
                            <!-- Loading Indicator -->
                            <div id="loadingItens" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="text-muted mt-2">Carregando itens do funcionário...</p>
                            </div>

                            <!-- Nenhum Item Disponível -->
                            <div id="semItens" class="alert alert-warning border-0" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Nenhum item disponível para devolução.</strong>
                                <p class="mb-0 small">Este funcionário não possui itens que possam ser devolvidos.</p>
                            </div>

                            <!-- Lista de Itens Serializados -->
                            <div id="itensSerializados" style="display: none;">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-barcode text-warning me-1"></i> Itens Serializados para Devolução *
                                    </label>
                                    <div id="listaSerializados" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Selecione um ou mais itens para devolver ao almoxarifado.
                                    </small>
                                </div>
                            </div>

                            <!-- Lista de Itens Consumíveis -->
                            <div id="itensConsumiveis" style="display: none;">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calculator text-success me-1"></i> Itens Consumíveis para Devolução
                                    </label>
                                    <div id="listaConsumiveis" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Informe a quantidade que está sendo devolvida de cada item.
                                    </small>
                                </div>
                            </div>

                            <!-- Condição da Devolução (obrigatório) -->
                            <div class="mb-3">
                                <label for="condicao_devolucao" class="form-label fw-bold">
                                    <i class="fas fa-check-circle text-info me-1"></i> Condição do Item *
                                </label>
                                <select class="form-select form-select-lg" id="condicao_devolucao" name="condicao_devolucao" required>
                                    <option value="">Selecione a condição...</option>
                                    <option value="Perfeito">Perfeito</option>
                                    <option value="Bom">Bom</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Danificado">Danificado</option>
                                    <option value="Inutilizado">Inutilizado</option>
                                </select>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Avalie o estado atual do item devolvido
                                </small>
                            </div>

                            <!-- Observações -->
                            <div class="mb-4">
                                <label for="observacoes" class="form-label">
                                    <i class="fas fa-comment-alt text-secondary me-1"></i> Observações
                                </label>
                                <textarea class="form-control" id="observacoes" name="observacoes" 
                                          rows="3" 
                                          placeholder="Observações sobre esta devolução (opcional)"></textarea>
                            </div>

                            <!-- Campos Hidden para tipo_controle -->
                            <input type="hidden" id="tipo_controle" name="tipo_controle">
                            <input type="hidden" id="item_id_consumivel" name="item_id">
                            <input type="hidden" id="quantidade_consumivel" name="quantidade">

                            <!-- Botões -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit" disabled>
                                    <i class="fas fa-check-circle me-1"></i> Processar Devolução
                                </button>
                                <button type="reset" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-eraser me-1"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Painel de Ajuda -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-question-circle text-info me-2"></i>
                        Como Funciona?
                    </h5>
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-barcode me-1"></i> Itens Serializados
                        </h6>
                        <p class="small mb-0">
                            Para itens com controle por número de série:
                        </p>
                        <ul class="small">
                            <li>Sempre podem ser devolvidos</li>
                            <li>Selecione os itens específicos a devolver</li>
                            <li>Status volta para "DISPONÍVEL"</li>
                            <li>Vínculo com funcionário/obra é removido</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold text-success">
                            <i class="fas fa-calculator me-1"></i> Itens Consumíveis
                        </h6>
                        <p class="small mb-0">
                            Para itens de controle por quantidade:
                        </p>
                        <ul class="small">
                            <li>Somente se permitir devolução</li>
                            <li>Informe a quantidade sendo devolvida</li>
                            <li>Quantidade volta ao estoque disponível</li>
                            <li>Sistema calcula automaticamente o disponível</li>
                        </ul>
                    </div>
                    <div class="alert alert-info border-0 small">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Condição Obrigatória:</strong> Sempre informe a condição do item devolvido para melhor controle de qualidade.
                    </div>
                    <div class="alert alert-warning border-0 small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Atenção:</strong> A devolução registra a condição atual do item. Items danificados ou inutilizados devem ser reportados corretamente.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const funcionarioSelect = document.getElementById('funcionario_id');
    const areaItens = document.getElementById('areaItens');
    const loadingItens = document.getElementById('loadingItens');
    const semItens = document.getElementById('semItens');
    const itensSerializados = document.getElementById('itensSerializados');
    const itensConsumiveis = document.getElementById('itensConsumiveis');
    const listaSerializados = document.getElementById('listaSerializados');
    const listaConsumiveis = document.getElementById('listaConsumiveis');
    const btnSubmit = document.getElementById('btnSubmit');
    const tipoControleInput = document.getElementById('tipo_controle');
    const itemIdConsumivel = document.getElementById('item_id_consumivel');
    const quantidadeConsumivel = document.getElementById('quantidade_consumivel');
    const condicaoSelect = document.getElementById('condicao_devolucao');
    const formDevolucao = document.getElementById('formDevolucao');

    let itensData = [];
    let temSerializados = false;
    let temConsumiveis = false;

    funcionarioSelect.addEventListener('change', async function() {
        const funcionarioId = this.value;
        
        if (!funcionarioId) {
            resetForm();
            return;
        }

        try {
            areaItens.style.display = 'block';
            loadingItens.style.display = 'block';
            semItens.style.display = 'none';
            itensSerializados.style.display = 'none';
            itensConsumiveis.style.display = 'none';
            btnSubmit.disabled = true;

            const response = await fetch(`/almoxarifado/api/itens-funcionario/${funcionarioId}`);
            
            if (!response.ok) {
                throw new Error('Erro ao buscar itens do funcionário');
            }

            const data = await response.json();
            itensData = data.itens;
            
            loadingItens.style.display = 'none';

            if (itensData.length === 0) {
                semItens.style.display = 'block';
                btnSubmit.disabled = true;
                return;
            }

            // Separar itens por tipo
            const serializados = itensData.filter(item => item.tipo_controle === 'SERIALIZADO');
            const consumiveis = itensData.filter(item => item.tipo_controle === 'CONSUMIVEL');

            temSerializados = serializados.length > 0;
            temConsumiveis = consumiveis.length > 0;

            // Renderizar itens serializados
            if (temSerializados) {
                renderSerializados(serializados);
                itensSerializados.style.display = 'block';
            }

            // Renderizar itens consumíveis
            if (temConsumiveis) {
                renderConsumiveis(consumiveis);
                itensConsumiveis.style.display = 'block';
            }

            // Definir tipo de controle predominante
            if (temSerializados && !temConsumiveis) {
                tipoControleInput.value = 'SERIALIZADO';
            } else if (!temSerializados && temConsumiveis) {
                tipoControleInput.value = 'CONSUMIVEL';
            } else {
                tipoControleInput.value = 'MISTO';
            }

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao carregar itens do funcionário. Por favor, tente novamente.');
            loadingItens.style.display = 'none';
            semItens.style.display = 'block';
        }
    });

    function renderSerializados(itens) {
        let html = '';
        itens.forEach(item => {
            html += `
                <div class="form-check mb-2 p-2 border-bottom">
                    <input class="form-check-input checkbox-serializado" type="checkbox" 
                           name="estoque_ids[]" value="${item.estoque_id}" id="item_${item.estoque_id}">
                    <label class="form-check-label w-100" for="item_${item.estoque_id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-primary">${item.item_nome}</strong>
                                <div class="small text-muted">
                                    <i class="fas fa-barcode me-1"></i> N/S: ${item.numero_serie}
                                </div>
                            </div>
                            <div class="text-end small">
                                <div><i class="fas fa-building me-1"></i> ${item.obra}</div>
                                <div><i class="fas fa-calendar me-1"></i> ${item.data_saida}</div>
                            </div>
                        </div>
                    </label>
                </div>
            `;
        });
        listaSerializados.innerHTML = html;

        // Habilitar botão quando selecionar checkbox
        const checkboxes = document.querySelectorAll('.checkbox-serializado');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', validarFormulario);
        });
    }

    function renderConsumiveis(itens) {
        let html = '';
        itens.forEach((item, index) => {
            html += `
                <div class="mb-3 p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong class="text-success">${item.item_nome}</strong>
                            <div class="small text-muted">
                                Disponível para devolução: <strong>${item.quantidade_disponivel} ${item.unidade}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label for="qtd_${item.item_id}" class="form-label small">Quantidade a devolver</label>
                            <div class="input-group">
                                <input type="number" class="form-control input-consumivel" 
                                       id="qtd_${item.item_id}" 
                                       data-item-id="${item.item_id}"
                                       data-item-nome="${item.item_nome}"
                                       step="0.01" min="0.01" max="${item.quantidade_disponivel}"
                                       placeholder="0.00">
                                <span class="input-group-text">${item.unidade}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Máximo: ${item.quantidade_disponivel} ${item.unidade}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        listaConsumiveis.innerHTML = html;

        // Validar formulário quando mudar quantidade
        const inputs = document.querySelectorAll('.input-consumivel');
        inputs.forEach(input => {
            input.addEventListener('input', validarFormulario);
        });
    }

    function validarFormulario() {
        let valido = false;
        const condicao = condicaoSelect.value;

        if (!condicao) {
            btnSubmit.disabled = true;
            return;
        }

        // Verificar se há itens serializados selecionados
        if (temSerializados) {
            const checkboxesMarcados = Array.from(document.querySelectorAll('.checkbox-serializado:checked'));
            if (checkboxesMarcados.length > 0) {
                valido = true;
                tipoControleInput.value = 'SERIALIZADO';
            }
        }

        // Verificar se há consumível com quantidade preenchida
        if (temConsumiveis) {
            const inputs = document.querySelectorAll('.input-consumivel');
            inputs.forEach(input => {
                const qtd = parseFloat(input.value);
                if (qtd && qtd > 0) {
                    valido = true;
                    tipoControleInput.value = 'CONSUMIVEL';
                    itemIdConsumivel.value = input.dataset.itemId;
                    quantidadeConsumivel.value = qtd;
                }
            });
        }

        btnSubmit.disabled = !valido;
    }

    condicaoSelect.addEventListener('change', validarFormulario);

    function resetForm() {
        areaItens.style.display = 'none';
        loadingItens.style.display = 'none';
        semItens.style.display = 'none';
        itensSerializados.style.display = 'none';
        itensConsumiveis.style.display = 'none';
        listaSerializados.innerHTML = '';
        listaConsumiveis.innerHTML = '';
        btnSubmit.disabled = true;
        tipoControleInput.value = '';
        itemIdConsumivel.value = '';
        quantidadeConsumivel.value = '';
        itensData = [];
        temSerializados = false;
        temConsumiveis = false;
    }

    formDevolucao.addEventListener('reset', function() {
        resetForm();
    });

    formDevolucao.addEventListener('submit', function(e) {
        const tipoControle = tipoControleInput.value;
        const condicao = condicaoSelect.value;

        if (!condicao) {
            e.preventDefault();
            alert('Por favor, informe a condição do item devolvido.');
            condicaoSelect.focus();
            return false;
        }

        if (tipoControle === 'SERIALIZADO') {
            const checkboxesMarcados = Array.from(document.querySelectorAll('.checkbox-serializado:checked'));
            if (checkboxesMarcados.length === 0) {
                e.preventDefault();
                alert('Por favor, selecione ao menos um item para devolução.');
                return false;
            }
        } else if (tipoControle === 'CONSUMIVEL') {
            const qtd = parseFloat(quantidadeConsumivel.value);
            if (!qtd || qtd <= 0) {
                e.preventDefault();
                alert('Por favor, informe uma quantidade válida para devolução.');
                return false;
            }
        } else {
            e.preventDefault();
            alert('Selecione itens para devolução.');
            return false;
        }
    });
});
</script>
{% endblock %}
