{% extends "base_completo.html" %}

{% block title %}Funcion√°rios - SIGE{% endblock %}

{% block styles %}
<!-- Select2 CSS para dropdown com scroll confi√°vel -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
/* ===== DROPDOWN CUSTOMIZADO COM SCROLL GARANTIDO ===== */
.custom-dropdown-container {
    position: relative;
    width: 100%;
}

.custom-dropdown-selected {
    cursor: pointer;
    background-color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.custom-dropdown-selected:hover {
    border-color: #86b7fe;
}

.custom-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 9999;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 6px 12px rgba(0,0,0,0.175);
    padding: 8px;
    margin-top: 2px;
}

.custom-dropdown-options {
    max-height: 250px;
    overflow-y: auto !important;
    overflow-x: hidden;
}

.custom-dropdown-option {
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.15s;
}

.custom-dropdown-option:hover {
    background-color: #e9ecef;
}

.custom-dropdown-option.selected {
    background-color: #0d6efd;
    color: white;
}

.custom-dropdown-option.hidden {
    display: none;
}

/* ===== FIX DROPDOWN OBRAS NO MODAL ===== */
#modalLancamentoMultiplo .modal-body {
    min-height: 70vh;
    max-height: 80vh;
    overflow-y: auto;
    overflow-x: visible;
}

/* Fix para dropdown de obras ter scroll adequado */
#modalLancamentoMultiplo .modal-content {
    overflow: visible;
}

/* Fix para Firefox e outros navegadores */
@supports (-moz-appearance: none) {
    #obra_lancamento {
        scrollbar-width: thin;
    }
}

/* ===== SISTEMA DE KPIs FUNCION√ÅRIOS 4-4-4-4 ===== */
.kpis-funcionario-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin: 1rem 0;
}

.kpi-item {
    display: flex;
    align-items: center;
    padding: 0.6rem;
    border-radius: 8px;
    color: white;
    min-height: 52px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.kpi-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.kpi-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    margin-right: 0.6rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    flex-shrink: 0;
}

.kpi-icon i {
    font-size: 0.9rem;
    color: white;
}

.kpi-content {
    flex: 1;
    min-width: 0;
}

.kpi-label {
    font-size: 0.65rem;
    font-weight: 500;
    opacity: 0.9;
    margin-bottom: 0.2rem;
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.kpi-value {
    font-size: 0.8rem;
    font-weight: 700;
    line-height: 1;
    color: white;
}

/* Cores dos KPIs */
.kpi-item.bg-primary { background: linear-gradient(135deg, #0d6efd, #0b5ed7); }
.kpi-item.bg-warning { background: linear-gradient(135deg, #ffc107, #ffb700); }
.kpi-item.bg-danger { background: linear-gradient(135deg, #dc3545, #c21807); }

/* ===== ESTILOS PARA FUNCION√ÅRIOS INATIVOS ===== */
.funcionario-card-inativo {
    opacity: 0.75;
    background-color: #f8f9fa !important;
    border: 1px dashed #dee2e6 !important;
    position: relative;
    overflow: hidden;
}

.funcionario-card-inativo::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 8px,
        rgba(108, 117, 125, 0.1) 8px,
        rgba(108, 117, 125, 0.1) 16px
    );
    pointer-events: none;
    z-index: 1;
}

.funcionario-card-inativo .card-body {
    position: relative;
    z-index: 2;
}

.funcionario-card-inativo:hover {
    opacity: 0.85;
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.foto-inativo {
    filter: grayscale(20%);
}

.funcionarios-separador {
    margin: 2rem 0 !important;
    position: relative;
}

.funcionarios-separador::after {
    content: "üìä Dados Hist√≥ricos Preservados";
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 0 1rem;
    font-size: 0.75rem;
    color: #6c757d;
}

/* Se√ß√µes de funcion√°rios */
.funcionarios-section {
    margin-bottom: 2rem;
}

.funcionarios-ativos {
    background: linear-gradient(135deg, rgba(25, 135, 84, 0.05), rgba(25, 135, 84, 0.02));
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #198754;
}

.funcionarios-inativos {
    background: linear-gradient(135deg, rgba(108, 117, 125, 0.05), rgba(108, 117, 125, 0.02));
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #6c757d;
}
.kpi-item.bg-info { background: linear-gradient(135deg, #0dcaf0, #0aa2c0); }
.kpi-item.bg-success { background: linear-gradient(135deg, #198754, #146c43); }
.kpi-item.bg-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); }
.kpi-item.bg-dark { background: linear-gradient(135deg, #212529, #1c1e21); }
.kpi-item.bg-light { 
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 1px solid #dee2e6;
    color: #212529 !important;
}

.kpi-item.bg-light .kpi-icon i {
    color: #212529 !important;
}

.kpi-item.bg-light .kpi-label,
.kpi-item.bg-light .kpi-value {
    color: #212529 !important;
}

/* Gradientes especiais */
.kpi-item.bg-primary-gradient { background: linear-gradient(135deg, #4154f1, #2c3cdd); }
.kpi-item.bg-success-gradient { background: linear-gradient(135deg, #20c997, #0f5132); }
.kpi-item.bg-warning-gradient { background: linear-gradient(135deg, #fd7e14, #dc6012); }
.kpi-item.bg-info-gradient { background: linear-gradient(135deg, #39c0ed, #0099cc); }
.kpi-item.bg-danger-gradient { background: linear-gradient(135deg, #e74c3c, #c0392b); }
.kpi-item.bg-secondary-gradient { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
.kpi-item.bg-dark-gradient { background: linear-gradient(135deg, #34495e, #2c3e50); }
.kpi-item.bg-gradient-total { 
    background: linear-gradient(135deg, #8e44ad, #9b59b6);
    border: 2px solid #fff;
    box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
}

/* Responsividade para KPIs */
@media (max-width: 1200px) {
    .kpis-funcionario-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.4rem;
    }
    
    .kpi-item {
        min-height: 48px;
        padding: 0.5rem;
    }
    
    .kpi-label {
        font-size: 0.6rem;
    }
    
    .kpi-value {
        font-size: 0.75rem;
    }
}

@media (max-width: 768px) {
    .kpis-funcionario-grid {
        display: none; /* Ocultar em mobile - usar vers√£o compacta */
    }
}

/* Responsividade mobile */
@media (max-width: 768px) {
    .funcionario-card-item {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Bot√£o Flutuante Mobile -->
<div class="floating-action d-lg-none">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#funcionarioModal" onclick="abrirModalNovoFuncionario()">
        <i class="fas fa-user-plus"></i>
    </button>
</div>
<div class="container-fluid">
    <!-- Cabe√ßalho -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-users"></i> Funcion√°rios
                </h1>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#funcionarioModal" onclick="abrirModalNovoFuncionario()">
                        <i class="fas fa-plus"></i> Novo Funcion√°rio
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalLancamentoMultiplo">
                        <i class="fas fa-users-cog"></i> Lan√ßamento M√∫ltiplo
                    </button>
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalFinaisSemana">
                        <i class="fas fa-calendar-check"></i> S√°bados e Domingos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Data -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filtros de Per√≠odo
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filtroForm" method="GET" action="{{ url_for('main.funcionarios') }}">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="data_inicio" class="form-label">Data Inicial</label>
                                <input type="date" class="form-control" name="data_inicio" id="data_inicio" 
                                       value="{{ data_inicio }}">
                            </div>
                            <div class="col-md-3">
                                <label for="data_fim" class="form-label">Data Final</label>
                                <input type="date" class="form-control" name="data_fim" id="data_fim" 
                                       value="{{ data_fim }}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Aplicar Filtro
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('mes_atual')">M√™s Atual</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ultimo_mes')">√öltimo M√™s</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ultimos_3_meses')">3 Meses</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ano_atual')">Ano Atual</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Funcion√°rios Ativos</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_funcionarios if kpis_geral else 0 }}</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Custo Total</h6>
                            <h4 class="mb-0">R$ {{ '{:,.2f}'.format(kpis_geral.total_custo_geral if kpis_geral else 0).replace(',', '.') }}</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Total de Horas</h6>
                            <h4 class="mb-0">{{ '{:,.1f}'.format(kpis_geral.total_horas_geral if kpis_geral else 0).replace(',', '.') }}h</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Faltas Justificadas</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_faltas_justificadas_geral if kpis_geral else 0 }} dias</h4>
                            <small>R$ {{ '{:,.2f}'.format(kpis_geral.total_custo_faltas_geral if kpis_geral else 0).replace(',', '.') }}</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda linha de KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Faltas Normais</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_faltas_geral if kpis_geral else 0 }} dias</h4>
                            <small class="opacity-75">Faltas n√£o justificadas</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-times fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Taxa de Absente√≠smo</h6>
                            <h4 class="mb-0">{{ '{:,.1f}'.format(kpis_geral.taxa_absenteismo_geral if kpis_geral else 0).replace(',', '.') }}%</h4>
                            <small class="opacity-75">Aus√™ncias no per√≠odo</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Total de Faltas</h6>
                            <h4 class="mb-0">{{ (kpis_geral.total_faltas_geral + kpis_geral.total_faltas_justificadas_geral) if kpis_geral else 0 }} dias</h4>
                            <small class="opacity-75">Normais + Justificadas</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-calendar-times fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-light text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Meta Absente√≠smo</h6>
                            <h4 class="mb-0 {% if kpis_geral and kpis_geral.taxa_absenteismo_geral <= 5 %}text-success{% elif kpis_geral and kpis_geral.taxa_absenteismo_geral <= 10 %}text-warning{% else %}text-danger{% endif %}">
                                {% if kpis_geral and kpis_geral.taxa_absenteismo_geral <= 5 %}‚úì Excelente{% elif kpis_geral and kpis_geral.taxa_absenteismo_geral <= 10 %}‚ñ≥ Aceit√°vel{% else %}‚úó Alto{% endif %}
                            </h4>
                            <small class="text-muted">Meta: ‚â§ 5%</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-bullseye fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Pesquisa -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Pesquisar funcion√°rios...">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <select class="form-select" id="statusFilter">
                <option value="">Todos os Status</option>
                <option value="ativo">Ativos</option>
                <option value="inativo">Inativos</option>
            </select>
        </div>
    </div>

<!-- Grid de Cards de Funcion√°rios - SEPARA√á√ÉO ATIVO/INATIVO -->
<!-- Funcion√°rios Ativos -->
{% set funcionarios_ativos = funcionarios_kpis | selectattr('funcionario.ativo', 'equalto', true) | list %}
{% set funcionarios_inativos = funcionarios_kpis | selectattr('funcionario.ativo', 'equalto', false) | list %}

{% if funcionarios_ativos %}
<div class="funcionarios-section funcionarios-ativos mb-4">
    <div class="d-flex align-items-center mb-3">
        <h5 class="mb-0">
            <i class="fas fa-users text-success me-2"></i>
            Funcion√°rios Ativos
            <span class="badge bg-success ms-2">{{ funcionarios_ativos|length }}</span>
        </h5>
    </div>
    <div class="row" id="funcionariosAtivosGrid">
        {% for kpi in funcionarios_ativos %}
        <div class="col-lg-4 col-md-6 mb-4 funcionario-card funcionario-ativo" 
             data-nome="{{ kpi.funcionario.nome.lower() }}" 
             data-telefone="{{ kpi.funcionario.telefone.lower() if kpi.funcionario.telefone else '' }}"
             data-funcao="{{ kpi.funcionario.funcao_ref.nome.lower() if kpi.funcionario.funcao_ref else '' }}"
             data-status="ativo">
        <div class="card h-100 funcionario-card-item">
            <div class="card-body d-flex flex-column">
                <!-- Foto e Nome -->
                <div class="text-center mb-3">
                    <img src="{{ obter_foto_funcionario(kpi.funcionario) }}" 
                         class="rounded-circle mb-3" 
                         width="80" 
                         height="80" 
                         style="object-fit: cover; aspect-ratio: 1/1;"
                         alt="Foto de {{ kpi.funcionario.nome }}"
                         data-nome="{{ kpi.funcionario.nome }}">
                    <h5 class="card-title mb-1">{{ kpi.funcionario.nome }}</h5>
                    <small class="text-muted">{{ kpi.funcionario.telefone if kpi.funcionario.telefone else '-' }}</small>
                </div>
                
                <!-- Informa√ß√µes -->
                <div class="mb-3">
                    <div class="mb-2">
                        <i class="fas fa-user-tie text-success me-2"></i>
                        <span>{{ kpi.funcionario.funcao_ref.nome if kpi.funcionario.funcao_ref else '-' }}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-clock text-info me-2"></i>
                        <span>{{ kpi.funcionario.horario_trabalho.nome if kpi.funcionario.horario_trabalho else 'N√£o definido' }}</span>
                    </div>
                </div>
                
                <!-- KPIs do Per√≠odo -->
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Horas</small>
                            <strong class="text-primary">{{ '{:,.1f}'.format(kpi.horas_trabalhadas).replace(',', '.') }}h</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Custo Total</small>
                            <strong class="text-success">R$ {{ '{:,.0f}'.format(kpi.custo_total).replace(',', '.') }}</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div class="mb-3">
                    {% if kpi.funcionario.ativo %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Ativo
                        </span>
                    {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle me-1"></i>Inativo
                        </span>
                    {% endif %}
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.funcionario_perfil', id=kpi.funcionario.id) }}" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-user me-1"></i>Ver Perfil
                        </a>
                        <div class="row g-1">
                            <div class="col-6">
                                <button class="btn btn-outline-warning btn-sm w-100" disabled>
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                            <div class="col-6">
                                {% if kpi.funcionario.ativo %}
                                    <button class="btn btn-outline-danger btn-sm w-100" 
                                            onclick="toggleStatusFuncionario({{ kpi.funcionario.id }}, '{{ kpi.funcionario.nome }}', false)">
                                        <i class="fas fa-user-times"></i> Desativar
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-success btn-sm w-100" 
                                            onclick="toggleStatusFuncionario({{ kpi.funcionario.id }}, '{{ kpi.funcionario.nome }}', true)">
                                        <i class="fas fa-user-check"></i> Reativar
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Linha Separadora entre Ativos e Inativos -->
{% if funcionarios_inativos %}
<hr class="funcionarios-separador my-4" style="border: 0; height: 2px; background: linear-gradient(90deg, #dee2e6 0%, #6c757d 50%, #dee2e6 100%); opacity: 0.7;">

<!-- Funcion√°rios Inativos -->
<div class="funcionarios-section funcionarios-inativos mb-4">
    <div class="d-flex align-items-center mb-3">
        <h5 class="mb-0 text-muted">
            <i class="fas fa-user-slash me-2"></i>
            Funcion√°rios Inativos 
            <span class="badge bg-secondary ms-2">{{ funcionarios_inativos|length }}</span>
        </h5>
        <small class="text-muted ms-3">(dados hist√≥ricos preservados)</small>
    </div>
    <div class="row" id="funcionariosInativosGrid">
        {% for kpi in funcionarios_inativos %}
        <div class="col-lg-4 col-md-6 mb-4 funcionario-card funcionario-inativo" 
             data-nome="{{ kpi.funcionario.nome.lower() }}" 
             data-telefone="{{ kpi.funcionario.telefone.lower() if kpi.funcionario.telefone else '' }}"
             data-funcao="{{ kpi.funcionario.funcao_ref.nome.lower() if kpi.funcionario.funcao_ref else '' }}"
             data-status="inativo">
        <div class="card h-100 funcionario-card-item funcionario-card-inativo">
            <div class="card-body d-flex flex-column">
                <!-- Foto e Nome -->
                <div class="text-center mb-3">
                    <img src="{{ obter_foto_funcionario(kpi.funcionario) }}" 
                         class="rounded-circle mb-3 foto-inativo" 
                         width="80" 
                         height="80" 
                         style="object-fit: cover; aspect-ratio: 1/1; opacity: 0.7;"
                         alt="Foto de {{ kpi.funcionario.nome }}"
                         data-nome="{{ kpi.funcionario.nome }}">
                    <h5 class="card-title mb-1 text-muted">{{ kpi.funcionario.nome }}</h5>
                    <small class="text-muted">{{ kpi.funcionario.telefone if kpi.funcionario.telefone else '-' }}</small>
                </div>
                
                <!-- Informa√ß√µes -->
                <div class="mb-3">
                    <div class="mb-2">
                        <i class="fas fa-user-tie text-muted me-2"></i>
                        <span class="text-muted">{{ kpi.funcionario.funcao_ref.nome if kpi.funcionario.funcao_ref else '-' }}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-clock text-muted me-2"></i>
                        <span class="text-muted">{{ kpi.funcionario.horario_trabalho.nome if kpi.funcionario.horario_trabalho else 'N√£o definido' }}</span>
                    </div>
                </div>
                
                <!-- KPIs do Per√≠odo (Dados Hist√≥ricos) -->
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Horas (hist√≥rico)</small>
                            <strong class="text-muted">{{ '{:,.1f}'.format(kpi.horas_trabalhadas).replace(',', '.') }}h</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Custo (hist√≥rico)</small>
                            <strong class="text-muted">R$ {{ '{:,.0f}'.format(kpi.custo_total).replace(',', '.') }}</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div class="mb-3">
                    <span class="badge bg-danger">
                        <i class="fas fa-times-circle me-1"></i>Inativo
                    </span>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.funcionario_perfil', id=kpi.funcionario.id) }}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-user me-1"></i>Ver Perfil
                        </a>
                        <div class="row g-1">
                            <div class="col-6">
                                <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success btn-sm w-100" 
                                        onclick="toggleStatusFuncionario({{ kpi.funcionario.id }}, '{{ kpi.funcionario.nome }}', true)">
                                    <i class="fas fa-user-check"></i> Reativar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Mensagem quando n√£o h√° funcion√°rios -->
{% if not funcionarios_kpis %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhum funcion√°rio encontrado</h5>
                <p class="text-muted">N√£o h√° funcion√°rios no per√≠odo selecionado.</p>
                <div class="alert alert-info mt-3">
                    <strong>Debug:</strong> {{ funcionarios|length }} funcion√°rios totais, {{ funcionarios_kpis|length }} KPIs calculados
                    <br><small>Admin ID: {% if current_user.is_authenticated %}{{ current_user.id }}{% else %}N√£o logado{% endif %}</small>
                </div>
                <a href="{{ url_for('main.funcionarios') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Primeiro Funcion√°rio
                </a>
            </div>
        </div>
    </div>
{% endif %}

<!-- Mensagem quando n√£o h√° funcion√°rios -->
<div id="noResultsMessage" class="text-center py-5" style="display: none;">
    <i class="fas fa-users fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">Nenhum funcion√°rio encontrado</h4>
    <p class="text-muted">Ajuste os filtros de pesquisa ou adicione novos funcion√°rios.</p>
</div>


<!-- Modal Funcion√°rio -->
<div class="modal fade" id="funcionarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user"></i> 
                    <span id="modalTitle">Novo Funcion√°rio</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="funcionarioForm" enctype="multipart/form-data" action="{{ url_for('main.funcionarios') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nome" class="form-label">Nome *</label>
                                        <input type="text" class="form-control" id="nome" name="nome" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cpf" class="form-label">CPF *</label>
                                        <input type="text" class="form-control" id="cpf" name="cpf" required 
                                               pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}" 
                                               placeholder="000.000.000-00" oninput="formatCPF(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto do Funcion√°rio</label>
                                <input type="file" class="form-control" id="foto" name="foto" 
                                       accept="image/jpeg,image/png,image/gif">
                                <div id="foto-preview" class="mt-2" style="display: none;">
                                    <img id="foto-img" src="" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" class="form-control" id="rg" name="rg">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="data_nascimento" name="data_nascimento">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endere√ßo</label>
                        <textarea class="form-control" id="endereco" name="endereco" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="telefone" name="telefone" oninput="formatPhone(this)">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_admissao" class="form-label">Data de Admiss√£o *</label>
                                <input type="date" class="form-control" id="data_admissao" name="data_admissao" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="salario" class="form-label">Sal√°rio</label>
                                <input type="number" class="form-control" id="salario" name="salario" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="departamento_id" class="form-label">Departamento</label>
                                <select class="form-select" id="departamento_id" name="departamento_id">
                                    <option value="0">Selecione...</option>
                                    {% for departamento in departamentos %}
                                        <option value="{{ departamento.id }}">{{ departamento.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="funcao_id" class="form-label">Fun√ß√£o</label>
                                <select class="form-select" id="funcao_id" name="funcao_id">
                                    <option value="0">Selecione...</option>
                                    {% for funcao in funcoes %}
                                        <option value="{{ funcao.id }}">{{ funcao.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="horario_trabalho_id" class="form-label">Hor√°rio de Trabalho</label>
                                <select class="form-select" id="horario_trabalho_id" name="horario_trabalho_id">
                                    <option value="0">Selecione...</option>
                                    {% for horario in horarios %}
                                        <option value="{{ horario.id }}">{{ horario.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ativo" name="ativo" checked>
                            <label class="form-check-label" for="ativo">
                                Funcion√°rio Ativo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Funcion√°rio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Abrir modal para novo funcion√°rio
function abrirModalNovoFuncionario() {
    // Limpar formul√°rio
    document.getElementById('funcionarioForm').reset();
    document.getElementById('modalTitle').textContent = 'Novo Funcion√°rio';
    document.getElementById('funcionarioForm').action = "{{ url_for('main.funcionarios') }}";
    
    // Esconder preview da foto
    const fotoPreview = document.getElementById('foto-preview');
    if (fotoPreview) {
        fotoPreview.style.display = 'none';
    }
}

// Enhanced photo upload functionality
function setupPhotoUpload() {
    const fotoInput = document.getElementById('foto');
    const fotoPreview = document.getElementById('foto-preview');
    const fotoImg = document.getElementById('foto-img');
    
    if (fotoInput) {
        fotoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotoImg.src = e.target.result;
                    fotoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

// Auto-preencher sal√°rio ao selecionar fun√ß√£o
function setupFuncaoSalarioAutocomplete() {
    const funcaoSelect = document.getElementById('funcao_id');
    const salarioInput = document.getElementById('salario');
    
    if (funcaoSelect && salarioInput) {
        funcaoSelect.addEventListener('change', async function() {
            const funcaoId = this.value;
            
            // Se nenhuma fun√ß√£o selecionada ou "Selecione...", limpar sal√°rio
            if (!funcaoId || funcaoId === '0') {
                salarioInput.value = '';
                return;
            }
            
            try {
                // Buscar dados da fun√ß√£o via API
                const response = await fetch(`/api/funcao/${funcaoId}`);
                const data = await response.json();
                
                if (data.success && data.funcao) {
                    // Preencher sal√°rio com o sal√°rio base da fun√ß√£o
                    salarioInput.value = data.funcao.salario_base.toFixed(2);
                    
                    // Feedback visual
                    salarioInput.classList.add('bg-light');
                    setTimeout(() => {
                        salarioInput.classList.remove('bg-light');
                    }, 300);
                } else {
                    // Se fun√ß√£o n√£o encontrada, limpar sal√°rio
                    salarioInput.value = '';
                }
            } catch (error) {
                console.error('Erro ao buscar dados da fun√ß√£o:', error);
                // Em caso de erro, limpar sal√°rio para evitar dados incorretos
                salarioInput.value = '';
            }
        });
    }
}

// Enhanced CPF formatting
function formatCPF(input) {
    let value = input.value.replace(/\D/g, '');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    input.value = value;
}

// Enhanced phone formatting
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
    } else {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{5})(\d)/, '$1-$2');
    }
    input.value = value;
}

// Enhanced form validation
function validateForm() {
    const cpf = document.getElementById('cpf').value;
    const nome = document.getElementById('nome').value;
    
    if (!nome.trim()) {
        alert('Nome √© obrigat√≥rio');
        return false;
    }
    
    if (!cpf.trim()) {
        alert('CPF √© obrigat√≥rio');
        return false;
    }
    
    if (!isValidCPF(cpf)) {
        alert('CPF inv√°lido');
        return false;
    }
    
    return true;
}

// CPF validation algorithm
function isValidCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    
    let sum = 0;
    for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.charAt(9))) return false;
    
    sum = 0;
    for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
    }
    remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.charAt(10))) return false;
    
    return true;
}

async function editarFuncionario(id) {
    try {
        // Buscar dados do funcion√°rio via API
        const response = await fetch(`/api/funcionario/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            alert(`Erro ao carregar funcion√°rio: ${data.message}`);
            return;
        }
        
        const func = data.funcionario;
        
        // Popular formul√°rio
        document.getElementById('nome').value = func.nome || '';
        document.getElementById('cpf').value = func.cpf || '';
        document.getElementById('rg').value = func.rg || '';
        document.getElementById('data_nascimento').value = func.data_nascimento || '';
        document.getElementById('email').value = func.email || '';
        document.getElementById('telefone').value = func.telefone || '';
        document.getElementById('endereco').value = func.endereco || '';
        document.getElementById('data_admissao').value = func.data_admissao || '';
        document.getElementById('salario').value = func.salario || '';
        
        // Popular dropdowns
        document.getElementById('departamento_id').value = func.departamento_id || '0';
        document.getElementById('funcao_id').value = func.funcao_id || '0';
        document.getElementById('horario_trabalho_id').value = func.horario_trabalho_id || '0';
        
        // Checkbox ativo
        document.getElementById('ativo').checked = func.ativo;
        
        // Mostrar preview da foto se existir
        const fotoPreview = document.getElementById('foto-preview');
        const fotoImg = document.getElementById('foto-img');
        if (func.foto) {
            fotoImg.src = `/static/fotos_funcionarios/${func.foto}`;
            fotoPreview.style.display = 'block';
        } else {
            fotoPreview.style.display = 'none';
        }
        
        // Configurar formul√°rio para editar
        document.getElementById('modalTitle').textContent = 'Editar Funcion√°rio';
        document.getElementById('funcionarioForm').action = `/funcionarios/${id}/editar`;
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('funcionarioModal'));
        modal.show();
        
    } catch (error) {
        console.error('Erro ao editar funcion√°rio:', error);
        alert('Erro ao carregar dados do funcion√°rio');
    }
}

function verDetalhesFuncionario(id) {
    window.location.href = `/funcionarios/${id}/perfil`;
}

function excluirFuncionario(id) {
    if (confirm('Tem certeza que deseja excluir este funcion√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/funcionarios/' + id + '/excluir';
        document.body.appendChild(form);
        form.submit();
    }
}

function resetForm() {
    document.getElementById('funcionarioForm').reset();
    const modalLabel = document.getElementById('funcionarioModalLabel') || document.getElementById('modalTitle');
    if (modalLabel) {
        modalLabel.textContent = 'Novo Funcion√°rio';
    }
    const fotoPreview = document.getElementById('foto-preview');
    if (fotoPreview) {
        fotoPreview.style.display = 'none';
    }
    const dataAdmissao = document.getElementById('data_admissao');
    if (dataAdmissao) {
        dataAdmissao.valueAsDate = new Date();
    }
}

// Fun√ß√£o para filtrar funcion√°rios
function filtrarFuncionarios() {
    console.log('üîç Iniciando filtro de funcion√°rios...');
    
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    if (!searchInput) {
        console.error('‚ùå Campo searchInput n√£o encontrado');
        return;
    }
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    const statusFilterValue = statusFilter ? statusFilter.value : 'todos';
    const funcionarioCards = document.querySelectorAll('.funcionario-card');
    let visibleCount = 0;
    
    console.log('üîç Filtro aplicado:', {
        busca: searchTerm,
        status: statusFilterValue,
        totalCards: funcionarioCards.length
    });
    
    if (funcionarioCards.length === 0) {
        console.warn('‚ö†Ô∏è Nenhum card .funcionario-card encontrado');
        return;
    }
    
    funcionarioCards.forEach(card => {
        const nome = card.dataset.nome || '';
        const telefone = card.dataset.telefone || '';
        const funcao = card.dataset.funcao || '';
        const status = card.dataset.status || '';
        
        console.log('Card:', {
            nome,
            status,
            statusFilter,
            matchesStatus: statusFilter === '' || status === statusFilter
        });
        
        const matchesSearch = nome.includes(searchTerm) || 
                            telefone.includes(searchTerm) || 
                            funcao.includes(searchTerm);
        
        const matchesStatus = statusFilter === '' || status === statusFilter;
        
        if (matchesSearch && matchesStatus) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    console.log('Funcion√°rios vis√≠veis:', visibleCount);
    
    // Mostrar/esconder mensagem "nenhum resultado"
    let noResults = document.getElementById('noResultsMessage');
    if (visibleCount === 0 && !noResults) {
        // Criar mensagem se n√£o existir
        noResults = document.createElement('div');
        noResults.id = 'noResultsMessage';
        noResults.className = 'col-12 text-center py-5';
        noResults.innerHTML = `
            <div class="text-muted">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5>Nenhum funcion√°rio encontrado</h5>
                <p>Tente ajustar os filtros de pesquisa</p>
            </div>
        `;
        document.getElementById('funcionariosGrid').appendChild(noResults);
    }
    
    if (noResults) {
        if (visibleCount === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
}

$(document).ready(function() {
    // Setup search and filter functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filtrarFuncionarios);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filtrarFuncionarios);
    }
    
    // Setup photo upload
    setupPhotoUpload();
    
    // Setup fun√ß√£o -> sal√°rio autocomplete
    setupFuncaoSalarioAutocomplete();
    
    // Setup form validation
    const form = document.getElementById('funcionarioForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });
    }
    
    // Setup input formatting
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function() {
            formatCPF(this);
        });
    }
    
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
            formatPhone(this);
        });
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Reset form when modal closes
    const modal = document.getElementById('funcionarioModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', resetForm);
    }
    
    // Configurar data de admiss√£o padr√£o
    const dataAdmissaoInput = document.getElementById('data_admissao');
    if (dataAdmissaoInput) {
        dataAdmissaoInput.valueAsDate = new Date();
    }
    
    // Adicionar hover effect aos cards
    const cards = document.querySelectorAll('.funcionario-card-item');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});

function setDateRange(period) {
    console.log('setDateRange chamado com per√≠odo:', period);
    const today = new Date();
    let startDate, endDate = today;
    
    switch(period) {
        case 'ultimo_mes':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'ultimos_3_meses':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            break;
        case 'ano_atual':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    // Formatar datas para yyyy-mm-dd
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');
    
    if (dataInicioInput && dataFimInput) {
        const dataInicioFormatada = formatDate(startDate);
        const dataFimFormatada = formatDate(endDate);
        
        console.log('Definindo datas:', dataInicioFormatada, 'at√©', dataFimFormatada);
        
        dataInicioInput.value = dataInicioFormatada;
        dataFimInput.value = dataFimFormatada;
        
        // Aguardar um momento para garantir que os valores foram definidos
        setTimeout(() => {
            // M√©todo alternativo: redirecionar diretamente com par√¢metros
            const url = new URL(window.location);
            url.searchParams.set('data_inicio', dataInicioFormatada);
            url.searchParams.set('data_fim', dataFimFormatada);
            console.log('Redirecionando para:', url.toString());
            window.location.href = url.toString();
        }, 100);
    } else {
        console.error('Campos de data n√£o encontrados!');
    }
}
</script>

<!-- Select2 JS - DEVE CARREGAR ANTES DA INICIALIZA√á√ÉO -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Modal de Lan√ßamento M√∫ltiplo -->
<div class="modal fade" id="modalLancamentoMultiplo" tabindex="-1" aria-labelledby="modalLancamentoMultiploLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalLancamentoMultiploLabel">
                    <i class="fas fa-users-cog"></i> Lan√ßamento M√∫ltiplo de Ponto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formLancamentoMultiplo">
                    <!-- Per√≠odo e Configura√ß√µes Gerais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-calendar-alt"></i> Configura√ß√µes do Lan√ßamento</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="periodo_inicio" class="form-label">Data In√≠cio*</label>
                                            <input type="date" class="form-control" id="periodo_inicio" name="periodo_inicio" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="periodo_fim" class="form-label">Data Fim*</label>
                                            <input type="date" class="form-control" id="periodo_fim" name="periodo_fim" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="tipo_lancamento" class="form-label">Tipo de Lan√ßamento*</label>
                                            <select class="form-select" id="tipo_lancamento" name="tipo_lancamento" required onchange="toggleCamposTipoLancamento()">
                                                <option value="">Selecione...</option>
                                                
                                                <optgroup label="üìã TRABALHO (com custo)">
                                                    <option value="trabalho_normal">üë∑ Trabalho Normal</option>
                                                    <option value="sabado_trabalhado">üìÖ S√°bado Trabalhado (+50%)</option>
                                                    <option value="domingo_trabalhado">üìÖ Domingo Trabalhado (+100%)</option>
                                                    <option value="feriado_trabalhado">üéâ Feriado Trabalhado (+100%)</option>
                                                </optgroup>
                                                
                                                <optgroup label="‚ö†Ô∏è AUS√äNCIAS">
                                                    <option value="falta">‚ùå Falta (desconta sal√°rio)</option>
                                                    <option value="falta_justificada">‚öïÔ∏è Falta Justificada</option>
                                                    <option value="ferias">üèñÔ∏è F√©rias</option>
                                                </optgroup>
                                                
                                                <optgroup label="üè† FOLGAS (sem custo)">
                                                    <option value="sabado_folga">üìÖ S√°bado - Folga</option>
                                                    <option value="domingo_folga">üìÖ Domingo - Folga</option>
                                                    <option value="feriado_folga">üéâ Feriado - Folga</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="obra_lancamento" class="form-label">Obra*</label>
                                            <!-- Dropdown Customizado com Scroll Garantido -->
                                            <div class="custom-dropdown-container" id="obraDropdownContainer" onclick="event.stopPropagation()">
                                                <input type="hidden" id="obra_lancamento" name="obra_id" required>
                                                <div class="custom-dropdown-selected form-select" id="obraDropdownSelected" onclick="toggleObraDropdown(event)">
                                                    <span id="obraSelectedText">Selecione uma obra...</span>
                                                    <i class="fas fa-chevron-down float-end mt-1"></i>
                                                </div>
                                                <div class="custom-dropdown-menu" id="obraDropdownMenu" style="display: none;" onclick="event.stopPropagation()">
                                                    <input type="text" class="form-control mb-2" id="obraBusca" placeholder="üîç Buscar obra..." oninput="filtrarObras(event)" onclick="event.stopPropagation()">
                                                    <div class="custom-dropdown-options" id="obraOptions">
                                                        {% for obra in obras_ativas %}
                                                        <div class="custom-dropdown-option" data-value="{{ obra.id }}" data-text="{{ obra.nome }}" onclick="selecionarObra(this, event)">
                                                            {{ obra.nome }}
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos de Hor√°rios (vis√≠vel apenas para tipos que precisam) -->
                    <div class="row mb-4" id="campos_horarios" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-clock"></i> Hor√°rios de Trabalho</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label for="hora_entrada" class="form-label">Entrada</label>
                                            <input type="time" class="form-control" id="hora_entrada" name="hora_entrada">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="hora_almoco_inicio" class="form-label">In√≠cio Almo√ßo</label>
                                            <input type="time" class="form-control" id="hora_almoco_inicio" name="hora_almoco_inicio">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="hora_almoco_fim" class="form-label">Fim Almo√ßo</label>
                                            <input type="time" class="form-control" id="hora_almoco_fim" name="hora_almoco_fim">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="hora_saida" class="form-label">Sa√≠da</label>
                                            <input type="time" class="form-control" id="hora_saida" name="hora_saida">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="percentual_extras" class="form-label">% Extras</label>
                                            <input type="number" class="form-control" id="percentual_extras" name="percentual_extras" 
                                                   min="0" max="200" placeholder="50">
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="sem_intervalo" name="sem_intervalo">
                                                <label class="form-check-label" for="sem_intervalo">
                                                    Sem Intervalo
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sele√ß√£o de Funcion√°rios -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-users"></i> Selecionar Funcion√°rios</h6>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosFuncionarios()">
                                            <i class="fas fa-check-double"></i> Selecionar Todos
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoFuncionarios()">
                                            <i class="fas fa-times"></i> Limpar Sele√ß√£o
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="busca_funcionarios" 
                                                   placeholder="Buscar funcion√°rios..." onkeyup="filtrarFuncionariosModal()">
                                        </div>
                                        <div class="col-md-6">
                                            <div id="contador_selecionados" class="text-muted">
                                                <i class="fas fa-users"></i> 0 funcion√°rios selecionados
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row" id="lista_funcionarios" style="max-height: 300px; overflow-y: auto;">
                                        {% for funcionario in funcionarios %}
                                        <div class="col-md-4 mb-2 funcionario-item" data-nome="{{ funcionario.nome.lower() }}" data-funcao="{{ funcionario.funcao.nome.lower() if funcionario.funcao else '' }}">
                                            <div class="card">
                                                <div class="card-body p-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input funcionario-checkbox" type="checkbox" 
                                                               value="{{ funcionario.id }}" id="func_{{ funcionario.id }}" 
                                                               onchange="atualizarContadorSelecionados()">
                                                        <label class="form-check-label w-100" for="func_{{ funcionario.id }}">
                                                            <div class="d-flex align-items-center">
                                                                <div class="me-2">
                                                                    {% if funcionario.foto %}
                                                                    <img src="{{ funcionario.foto }}" class="rounded-circle" width="30" height="30">
                                                                    {% else %}
                                                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                                                         style="width: 30px; height: 30px; font-size: 12px;">
                                                                        {{ funcionario.nome.split()[0][0] }}{{ funcionario.nome.split()[-1][0] if funcionario.nome.split()|length > 1 else '' }}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <div class="fw-bold" style="font-size: 0.9em;">{{ funcionario.nome[:20] }}{% if funcionario.nome|length > 20 %}...{% endif %}</div>
                                                                    <small class="text-muted">{{ funcionario.funcao.nome if funcionario.funcao else 'Sem fun√ß√£o' }}</small>
                                                                </div>
                                                            </div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observa√ß√µes -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-comment"></i> Observa√ß√µes (Opcional)</h6>
                                </div>
                                <div class="card-body">
                                    <textarea class="form-control" id="observacoes_lancamento" name="observacoes" 
                                              rows="3" placeholder="Observa√ß√µes sobre este lan√ßamento..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="processarLancamentoMultiplo()">
                    <i class="fas fa-save"></i> Processar Lan√ßamentos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Lan√ßamento de S√°bados e Domingos -->
<div class="modal fade" id="modalFinaisSemana" tabindex="-1" aria-labelledby="modalFinaisSemanaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalFinaisSemanaLabel">
                    <i class="fas fa-calendar-check"></i> Lan√ßar S√°bados e Domingos como Folga
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Como funciona:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Lan√ßar√° automaticamente "S√°bado folga" e "Domingo folga" para todos os funcion√°rios ativos</li>
                        <li>Ser√° aplicado apenas √† compet√™ncia selecionada</li>
                        <li>N√£o ir√° sobrescrever registros j√° existentes</li>
                        <li>Funcion√°rios inativos n√£o ser√£o afetados</li>
                    </ul>
                </div>
                
                <form id="formFinaisSemana">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="competencia_finais_semana" class="form-label">
                                    <i class="fas fa-calendar"></i> Compet√™ncia (M√™s/Ano)
                                </label>
                                <input type="month" 
                                       class="form-control" 
                                       id="competencia_finais_semana" 
                                       name="competencia" 
                                       required>
                                <div class="form-text">Selecione o m√™s/ano para lan√ßamento</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-users"></i> Funcion√°rios Ativos
                                </label>
                                <div class="badge bg-success fs-6" id="contadorFuncionariosAtivos">
                                    {{ funcionarios|length }} funcion√°rios
                                </div>
                                <div class="form-text">Somente funcion√°rios ativos ser√£o afetados</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-preview"></i> Pr√©via do Lan√ßamento
                                    </h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Tipo de Registro:</small>
                                            <div><span class="badge bg-info">S√°bado folga</span></div>
                                            <div><span class="badge bg-info">Domingo folga</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Horas Trabalhadas:</small>
                                            <div>0 horas (folga)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="executarLancamentoFinaisSemana()" id="btnLancarFinaisSemana">
                    <i class="fas fa-rocket"></i> Lan√ßar S√°bados e Domingos
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√µes para o Modal de Lan√ßamento M√∫ltiplo
function toggleCamposTipoLancamento() {
    const tipo = document.getElementById('tipo_lancamento').value;
    const camposHorarios = document.getElementById('campos_horarios');
    
    // Tipos que precisam de hor√°rios
    const tiposComHorarios = ['trabalho_normal', 'sabado_trabalhado', 'domingo_trabalhado', 'feriado_trabalhado'];
    
    if (tiposComHorarios.includes(tipo)) {
        camposHorarios.style.display = 'block';
        
        // Definir valores padr√£o baseados no tipo
        const horaEntrada = document.getElementById('hora_entrada');
        const horaAlmocoInicio = document.getElementById('hora_almoco_inicio');
        const horaAlmocoFim = document.getElementById('hora_almoco_fim');
        const horaSaida = document.getElementById('hora_saida');
        const percentualExtras = document.getElementById('percentual_extras');
        
        switch(tipo) {
            case 'trabalho_normal':
                horaEntrada.value = '07:12';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '17:00';
                percentualExtras.value = '';
                break;
            case 'sabado_trabalhado':
                horaEntrada.value = '07:00';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '16:00';
                percentualExtras.value = '50';
                break;
            case 'domingo_trabalhado':
                horaEntrada.value = '07:00';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '16:00';
                percentualExtras.value = '100';
                break;
            case 'feriado_trabalhado':
                horaEntrada.value = '07:12';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '17:00';
                percentualExtras.value = '100';
                break;

        }
    } else {
        camposHorarios.style.display = 'none';
    }
}

function selecionarTodosFuncionarios() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox');
    const funcionariosVisiveis = document.querySelectorAll('.funcionario-item:not([style*="display: none"])');
    
    funcionariosVisiveis.forEach(item => {
        const checkbox = item.querySelector('.funcionario-checkbox');
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    atualizarContadorSelecionados();
}

function limparSelecaoFuncionarios() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    atualizarContadorSelecionados();
}

function atualizarContadorSelecionados() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox:checked');
    const contador = document.getElementById('contador_selecionados');
    contador.innerHTML = `<i class="fas fa-users"></i> ${checkboxes.length} funcion√°rios selecionados`;
}

function filtrarFuncionariosModal() {
    const busca = document.getElementById('busca_funcionarios').value.toLowerCase();
    const funcionarios = document.querySelectorAll('.funcionario-item');
    
    funcionarios.forEach(funcionario => {
        const nome = funcionario.dataset.nome || '';
        const funcao = funcionario.dataset.funcao || '';
        
        if (nome.includes(busca) || funcao.includes(busca)) {
            funcionario.style.display = '';
        } else {
            funcionario.style.display = 'none';
        }
    });
}

function processarLancamentoMultiplo() {
    const form = document.getElementById('formLancamentoMultiplo');
    const formData = new FormData(form);
    
    // Valida√ß√µes
    if (!formData.get('periodo_inicio') || !formData.get('periodo_fim')) {
        alert('Por favor, selecione o per√≠odo de lan√ßamento.');
        return;
    }
    
    if (!formData.get('tipo_lancamento')) {
        alert('Por favor, selecione o tipo de lan√ßamento.');
        return;
    }
    
    if (!formData.get('obra_id')) {
        alert('Por favor, selecione uma obra.');
        return;
    }
    
    // Coletar funcion√°rios selecionados
    const funcionariosSelecionados = [];
    const checkboxes = document.querySelectorAll('.funcionario-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Por favor, selecione pelo menos um funcion√°rio.');
        return;
    }
    
    checkboxes.forEach(checkbox => {
        funcionariosSelecionados.push(checkbox.value);
    });
    
    // Preparar dados para envio
    const dadosLancamento = {
        periodo_inicio: formData.get('periodo_inicio'),
        periodo_fim: formData.get('periodo_fim'),
        tipo_lancamento: formData.get('tipo_lancamento'),
        obra_id: formData.get('obra_id'),
        funcionarios: funcionariosSelecionados,
        hora_entrada: formData.get('hora_entrada'),
        hora_almoco_inicio: formData.get('hora_almoco_inicio'),
        hora_almoco_fim: formData.get('hora_almoco_fim'),
        hora_saida: formData.get('hora_saida'),
        percentual_extras: formData.get('percentual_extras'),
        sem_intervalo: formData.get('sem_intervalo') ? true : false,
        observacoes: formData.get('observacoes')
    };
    
    // Confirmar com o usu√°rio
    const diasPeriodo = Math.ceil((new Date(dadosLancamento.periodo_fim) - new Date(dadosLancamento.periodo_inicio)) / (1000 * 60 * 60 * 24)) + 1;
    const totalLancamentos = funcionariosSelecionados.length * diasPeriodo;
    
    if (!confirm(`Confirma o lan√ßamento m√∫ltiplo?\n\n${funcionariosSelecionados.length} funcion√°rios\n${diasPeriodo} dias\nTotal: ${totalLancamentos} lan√ßamentos`)) {
        return;
    }
    
    // Mostrar loading
    const btnProcessar = event.target;
    const textoOriginal = btnProcessar.innerHTML;
    btnProcessar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    btnProcessar.disabled = true;
    
    // Enviar requisi√ß√£o
    fetch('/api/ponto/lancamento-multiplo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dadosLancamento)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`Sucesso! ${result.total_lancamentos} lan√ßamentos processados.`);
            $('#modalLancamentoMultiplo').modal('hide');
            location.reload();
        } else {
            alert('Erro: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar lan√ßamentos.');
    })
    .finally(() => {
        btnProcessar.innerHTML = textoOriginal;
        btnProcessar.disabled = false;
    });
}

// Configurar datas padr√£o ao abrir o modal
$('#modalLancamentoMultiplo').on('show.bs.modal', function() {
    const hoje = new Date();
    const primeiroDiaDoMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    
    document.getElementById('periodo_inicio').value = primeiroDiaDoMes.toISOString().split('T')[0];
    document.getElementById('periodo_fim').value = hoje.toISOString().split('T')[0];
    
    // Reset do dropdown customizado
    resetObraDropdown();
});

// ===== FUN√á√ïES DO DROPDOWN CUSTOMIZADO DE OBRAS =====
var obraDropdownOpen = false;
var obraDropdownIgnoreNextClick = false;

function abrirObraDropdown() {
    var menu = document.getElementById('obraDropdownMenu');
    if (!obraDropdownOpen) {
        menu.style.display = 'block';
        obraDropdownOpen = true;
        setTimeout(function() {
            var busca = document.getElementById('obraBusca');
            if (busca) busca.focus();
        }, 100);
    }
}

function fecharObraDropdown() {
    var menu = document.getElementById('obraDropdownMenu');
    menu.style.display = 'none';
    obraDropdownOpen = false;
}

function toggleObraDropdown(event) {
    event.preventDefault();
    event.stopPropagation();
    
    if (obraDropdownOpen) {
        fecharObraDropdown();
    } else {
        abrirObraDropdown();
    }
}

function filtrarObras(event) {
    event.stopPropagation();
    
    var busca = document.getElementById('obraBusca').value.toLowerCase();
    var opcoes = document.querySelectorAll('.custom-dropdown-option');
    
    for (var i = 0; i < opcoes.length; i++) {
        var texto = opcoes[i].getAttribute('data-text').toLowerCase();
        if (texto.indexOf(busca) !== -1) {
            opcoes[i].style.display = 'block';
        } else {
            opcoes[i].style.display = 'none';
        }
    }
}

function selecionarObra(elemento, event) {
    event.preventDefault();
    event.stopPropagation();
    
    var valor = elemento.getAttribute('data-value');
    var texto = elemento.getAttribute('data-text');
    
    document.getElementById('obra_lancamento').value = valor;
    document.getElementById('obraSelectedText').textContent = texto;
    
    var opcoes = document.querySelectorAll('.custom-dropdown-option');
    for (var i = 0; i < opcoes.length; i++) {
        opcoes[i].classList.remove('selected');
    }
    elemento.classList.add('selected');
    
    fecharObraDropdown();
}

function resetObraDropdown() {
    document.getElementById('obra_lancamento').value = '';
    document.getElementById('obraSelectedText').textContent = 'Selecione uma obra...';
    document.getElementById('obraBusca').value = '';
    var opcoes = document.querySelectorAll('.custom-dropdown-option');
    for (var i = 0; i < opcoes.length; i++) {
        opcoes[i].classList.remove('selected');
        opcoes[i].style.display = 'block';
    }
    fecharObraDropdown();
}

// Fechar ao clicar fora - usando mousedown para ser mais r√°pido
document.addEventListener('mousedown', function(event) {
    var container = document.getElementById('obraDropdownContainer');
    if (container && obraDropdownOpen && !container.contains(event.target)) {
        fecharObraDropdown();
    }
}, true);

// ===== FUN√á√ïES PARA LAN√áAMENTO DE FINAIS DE SEMANA =====

// Configurar data padr√£o ao abrir o modal
$('#modalFinaisSemana').on('show.bs.modal', function() {
    const hoje = new Date();
    const competenciaAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('competencia_finais_semana').value = competenciaAtual;
});

// Executar lan√ßamento de s√°bados e domingos
function executarLancamentoFinaisSemana() {
    const competencia = document.getElementById('competencia_finais_semana').value;
    const btnLancar = document.getElementById('btnLancarFinaisSemana');
    
    if (!competencia) {
        alert('Por favor, selecione a compet√™ncia (m√™s/ano).');
        return;
    }
    
    // Confirma√ß√£o
    const [ano, mes] = competencia.split('-');
    const nomesMeses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const mesNome = nomesMeses[parseInt(mes) - 1];
    
    const confirmacao = confirm(`Tem certeza que deseja lan√ßar s√°bados e domingos como folga para todos os funcion√°rios ativos em ${mesNome}/${ano}?\n\nEsta a√ß√£o n√£o ir√° sobrescrever registros j√° existentes.`);
    
    if (!confirmacao) {
        return;
    }
    
    // Desabilitar bot√£o e mostrar loading
    btnLancar.disabled = true;
    btnLancar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    
    console.log(`üóìÔ∏è Iniciando lan√ßamento de finais de semana para ${competencia}`);
    
    // Chamar API
    fetch('/api/ponto/lancamento-finais-semana', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            competencia: competencia
        })
    })
    .then(response => {
        console.log(`üîÑ Response status: ${response.status}`);
        return response.json();
    })
    .then(result => {
        console.log('üéØ Resultado da API:', result);
        
        if (result.success) {
            const detalhes = result.detalhes;
            let mensagem = `‚úÖ Lan√ßamento conclu√≠do para ${mesNome}/${ano}!\n\n`;
            mensagem += `üìä Relat√≥rio:\n`;
            mensagem += `‚Ä¢ ${detalhes.registros_criados} novos registros criados\n`;
            mensagem += `‚Ä¢ ${detalhes.registros_existentes} registros j√° existentes (n√£o alterados)\n`;
            mensagem += `‚Ä¢ ${detalhes.funcionarios_processados} funcion√°rios processados\n`;
            mensagem += `‚Ä¢ ${detalhes.finais_semana_encontrados} s√°bados/domingos encontrados\n`;
            
            if (detalhes.erros && detalhes.erros.length > 0) {
                mensagem += `\n‚ö†Ô∏è Avisos:\n${detalhes.erros.join('\n')}`;
            }
            
            alert(mensagem);
            $('#modalFinaisSemana').modal('hide');
            
            // Recarregar p√°gina se houver registros criados
            if (detalhes.registros_criados > 0) {
                location.reload();
            }
        } else {
            alert(`‚ùå Erro: ${result.message}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        alert('‚ùå Erro ao processar lan√ßamento de finais de semana. Tente novamente.');
    })
    .finally(() => {
        // Restaurar bot√£o
        btnLancar.disabled = false;
        btnLancar.innerHTML = '<i class="fas fa-rocket"></i> Lan√ßar S√°bados e Domingos';
    });
}

// Toggle status funcion√°rio (ativar/desativar) - CORRIGIDO
function toggleStatusFuncionario(id, nome, ativar) {
    const acao = ativar ? 'ativar' : 'desativar';
    const mensagem = `Tem certeza que deseja ${acao} o funcion√°rio ${nome}?`;
    
    if (confirm(mensagem)) {
        console.log(`üîß DEBUG TOGGLE: ID=${id}, Nome=${nome}, Ativar=${ativar}`);
        
        fetch(`/api/funcionario/${id}/toggle-ativo`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            console.log(`üîß DEBUG RESPONSE: Status=${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro interno do servidor');
        });
    }
}

// Function to get CSRF token
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
