{% extends "base.html" %}

{% block title %}Funcionários - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-users"></i> Funcionários
                </h1>
                <a href="{{ url_for('main.novo_funcionario') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Novo Funcionário
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros de Data -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filtros de Período
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('main.funcionarios') }}">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="data_inicio" class="form-label">Data Inicial</label>
                                <input type="date" class="form-control" name="data_inicio" id="data_inicio" 
                                       value="{{ data_inicio }}">
                            </div>
                            <div class="col-md-3">
                                <label for="data_fim" class="form-label">Data Final</label>
                                <input type="date" class="form-control" name="data_fim" id="data_fim" 
                                       value="{{ data_fim }}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Aplicar Filtro
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ultimo_mes')">Último Mês</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ultimos_3_meses')">3 Meses</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ano_atual')">Ano Atual</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Funcionários Ativos</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_funcionarios if kpis_geral else 0 }}</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Custo Total</h6>
                            <h4 class="mb-0">R$ {{ '{:,.2f}'.format(kpis_geral.total_custo_geral if kpis_geral else 0).replace(',', '.') }}</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Total de Horas</h6>
                            <h4 class="mb-0">{{ '{:,.1f}'.format(kpis_geral.total_horas_geral if kpis_geral else 0).replace(',', '.') }}h</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Faltas Justificadas</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_faltas_geral if kpis_geral else 0 }} dias</h4>
                            <small>R$ {{ '{:,.2f}'.format(kpis_geral.total_custo_faltas_geral if kpis_geral else 0).replace(',', '.') }}</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Pesquisa -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Pesquisar funcionários...">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <select class="form-select" id="statusFilter">
                <option value="">Todos os Status</option>
                <option value="ativo">Ativos</option>
                <option value="inativo">Inativos</option>
            </select>
        </div>
    </div>

<!-- Grid de Cards de Funcionários -->
<div class="row" id="funcionariosGrid">
    {% if funcionarios_kpis %}
        {% for kpi in funcionarios_kpis %}
    <div class="col-lg-4 col-md-6 mb-4 funcionario-card" 
         data-nome="{{ kpi.funcionario.nome.lower() }}" 
         data-departamento="{{ kpi.funcionario.departamento_ref.nome.lower() if kpi.funcionario.departamento_ref else '' }}"
         data-funcao="{{ kpi.funcionario.funcao_ref.nome.lower() if kpi.funcionario.funcao_ref else '' }}"
         data-status="{{ 'ativo' if kpi.funcionario.ativo else 'inativo' }}">
        <div class="card h-100 funcionario-card-item">
            <div class="card-body d-flex flex-column">
                <!-- Foto e Nome -->
                <div class="text-center mb-3">
                    <img src="{{ url_for('static', filename='images/default-avatar.svg') }}" 
                         class="rounded-circle mb-3" 
                         width="80" 
                         height="80" 
                         style="object-fit: cover; aspect-ratio: 1/1;">
                    <h5 class="card-title mb-1">{{ kpi.funcionario.nome }}</h5>
                    <small class="text-muted">{{ kpi.funcionario.email if kpi.funcionario.email else '-' }}</small>
                </div>
                
                <!-- Informações -->
                <div class="mb-3">
                    <div class="mb-2">
                        <i class="fas fa-sitemap text-primary me-2"></i>
                        <span>{{ kpi.funcionario.departamento_ref.nome if kpi.funcionario.departamento_ref else '-' }}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-user-tie text-success me-2"></i>
                        <span>{{ kpi.funcionario.funcao_ref.nome if kpi.funcionario.funcao_ref else '-' }}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-clock text-info me-2"></i>
                        <span>{{ kpi.funcionario.horario_trabalho.nome if kpi.funcionario.horario_trabalho else 'Não definido' }}</span>
                    </div>
                </div>
                
                <!-- KPIs do Período -->
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Horas</small>
                            <strong class="text-primary">{{ '{:,.1f}'.format(kpi.horas_trabalhadas).replace(',', '.') }}h</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Custo Total</small>
                            <strong class="text-success">R$ {{ '{:,.0f}'.format(kpi.custo_total).replace(',', '.') }}</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div class="mb-3">
                    {% if kpi.funcionario.ativo %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Ativo
                        </span>
                    {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle me-1"></i>Inativo
                        </span>
                    {% endif %}
                </div>
                
                <!-- Botões de Ação -->
                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.funcionario_perfil', id=kpi.funcionario.id) }}" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-user me-1"></i>Ver Perfil
                        </a>
                        <div class="row g-1">
                            <div class="col-6">
                                <a href="{{ url_for('main.editar_funcionario', id=kpi.funcionario.id) }}"
                                   class="btn btn-outline-warning btn-sm w-100">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-danger btn-sm w-100" 
                                        onclick="excluirFuncionario({{ kpi.funcionario.id }}, '{{ kpi.funcionario.nome }}')">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum funcionário encontrado</h5>
                    <p class="text-muted">Não há funcionários ativos no período selecionado.</p>
                    <a href="{{ url_for('main.novo_funcionario') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Adicionar Primeiro Funcionário
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Mensagem quando não há funcionários -->
<div id="noResultsMessage" class="text-center py-5" style="display: none;">
    <i class="fas fa-users fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">Nenhum funcionário encontrado</h4>
    <p class="text-muted">Ajuste os filtros de pesquisa ou adicione novos funcionários.</p>
</div>


<!-- Modal Funcionário -->
<div class="modal fade" id="funcionarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user"></i> 
                    <span id="modalTitle">Novo Funcionário</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="funcionarioForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nome" class="form-label">Nome *</label>
                                        <input type="text" class="form-control" id="nome" name="nome" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cpf" class="form-label">CPF *</label>
                                        <input type="text" class="form-control" id="cpf" name="cpf" required 
                                               pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}" 
                                               placeholder="000.000.000-00">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto do Funcionário</label>
                                <input type="file" class="form-control" id="foto" name="foto" 
                                       accept="image/jpeg,image/png,image/gif">
                                <div id="foto-preview" class="mt-2" style="display: none;">
                                    <img id="foto-img" src="" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" class="form-control" id="rg" name="rg">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="data_nascimento" name="data_nascimento">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endereço</label>
                        <textarea class="form-control" id="endereco" name="endereco" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="telefone" name="telefone">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_admissao" class="form-label">Data de Admissão *</label>
                                <input type="date" class="form-control" id="data_admissao" name="data_admissao" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="salario" class="form-label">Salário</label>
                                <input type="number" class="form-control" id="salario" name="salario" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="departamento_id" class="form-label">Departamento</label>
                                <select class="form-select" id="departamento_id" name="departamento_id">
                                    <option value="">Selecione...</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="funcao_id" class="form-label">Função</label>
                                <select class="form-select" id="funcao_id" name="funcao_id">
                                    <option value="">Selecione...</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="horario_trabalho_id" class="form-label">Horário de Trabalho</label>
                                <select class="form-select" id="horario_trabalho_id" name="horario_trabalho_id">
                                    <option value="">Selecione...</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ativo" name="ativo" checked>
                            <label class="form-check-label" for="ativo">
                                Funcionário Ativo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced photo upload functionality
function setupPhotoUpload() {
    const fotoInput = document.getElementById('foto');
    const fotoPreview = document.getElementById('foto-preview');
    const fotoImg = document.getElementById('foto-img');
    
    if (fotoInput) {
        fotoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotoImg.src = e.target.result;
                    fotoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

// Enhanced CPF formatting
function formatCPF(input) {
    let value = input.value.replace(/\D/g, '');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    input.value = value;
}

// Enhanced phone formatting
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
    } else {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{5})(\d)/, '$1-$2');
    }
    input.value = value;
}

// Enhanced form validation
function validateForm() {
    const cpf = document.getElementById('cpf').value;
    const nome = document.getElementById('nome').value;
    
    if (!nome.trim()) {
        alert('Nome é obrigatório');
        return false;
    }
    
    if (!cpf.trim()) {
        alert('CPF é obrigatório');
        return false;
    }
    
    if (!isValidCPF(cpf)) {
        alert('CPF inválido');
        return false;
    }
    
    return true;
}

// CPF validation algorithm
function isValidCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    
    let sum = 0;
    for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.charAt(9))) return false;
    
    sum = 0;
    for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
    }
    remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.charAt(10))) return false;
    
    return true;
}

function editarFuncionario(id) {
    alert('Funcionalidade de edição será implementada em breve');
}

function verDetalhesFuncionario(id) {
    window.location.href = `/funcionarios/${id}/perfil`;
}

function excluirFuncionario(id) {
    if (confirm('Tem certeza que deseja excluir este funcionário? Esta ação não pode ser desfeita.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/funcionarios/' + id + '/excluir';
        document.body.appendChild(form);
        form.submit();
    }
}

function resetForm() {
    document.getElementById('funcionarioForm').reset();
    document.getElementById('funcionarioModalLabel').textContent = 'Novo Funcionário';
    document.getElementById('foto-preview').style.display = 'none';
    document.getElementById('data_admissao').valueAsDate = new Date();
}

// Função para filtrar funcionários
function filtrarFuncionarios() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const funcionarioCards = document.querySelectorAll('.funcionario-card');
    let visibleCount = 0;
    
    funcionarioCards.forEach(card => {
        const nome = card.dataset.nome || '';
        const departamento = card.dataset.departamento || '';
        const funcao = card.dataset.funcao || '';
        const status = card.dataset.status || '';
        
        const matchesSearch = nome.includes(searchTerm) || 
                            departamento.includes(searchTerm) || 
                            funcao.includes(searchTerm);
        
        const matchesStatus = statusFilter === '' || status === statusFilter;
        
        if (matchesSearch && matchesStatus) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Mostrar/esconder mensagem "nenhum resultado"
    const noResults = document.getElementById('noResultsMessage');
    if (visibleCount === 0) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
}

$(document).ready(function() {
    // Setup search and filter functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filtrarFuncionarios);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filtrarFuncionarios);
    }
    
    // Setup photo upload
    setupPhotoUpload();
    
    // Setup form validation
    const form = document.getElementById('funcionarioForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });
    }
    
    // Setup input formatting
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function() {
            formatCPF(this);
        });
    }
    
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
            formatPhone(this);
        });
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Reset form when modal closes
    const modal = document.getElementById('funcionarioModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', resetForm);
    }
    
    // Configurar data de admissão padrão
    const dataAdmissaoInput = document.getElementById('data_admissao');
    if (dataAdmissaoInput) {
        dataAdmissaoInput.valueAsDate = new Date();
    }
    
    // Adicionar hover effect aos cards
    const cards = document.querySelectorAll('.funcionario-card-item');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});

function setDateRange(period) {
    const today = new Date();
    let startDate, endDate = today;
    
    switch(period) {
        case 'ultimo_mes':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'ultimos_3_meses':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            break;
        case 'ano_atual':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    // Formatar datas para yyyy-mm-dd
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    document.getElementById('data_inicio').value = formatDate(startDate);
    document.getElementById('data_fim').value = formatDate(endDate);
    
    // Submeter o formulário automaticamente
    const form = document.querySelector('form[method="GET"]');
    if (form) {
        form.submit();
    }
}
</script>
{% endblock %}
