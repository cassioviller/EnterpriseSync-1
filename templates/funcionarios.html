{% extends "base.html" %}

{% block title %}Funcionários - SIGE{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-users"></i> Funcionários
                </h1>
                <div class="btn-group">
                    <a href="{{ url_for('main.funcionarios') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Funcionário
                    </a>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#funcionarioModal" onclick="abrirModalNovoFuncionario()">
                        <i class="fas fa-plus-circle"></i> Modal Rápido
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalLancamentoMultiplo">
                        <i class="fas fa-users-cog"></i> Lançamento Múltiplo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Data -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filtros de Período
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filtroForm" method="GET" action="{{ url_for('main.funcionarios') }}">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="data_inicio" class="form-label">Data Inicial</label>
                                <input type="date" class="form-control" name="data_inicio" id="data_inicio" 
                                       value="{{ data_inicio }}">
                            </div>
                            <div class="col-md-3">
                                <label for="data_fim" class="form-label">Data Final</label>
                                <input type="date" class="form-control" name="data_fim" id="data_fim" 
                                       value="{{ data_fim }}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Aplicar Filtro
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('mes_atual')">Mês Atual</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ultimo_mes')">Último Mês</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ultimos_3_meses')">3 Meses</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="setDateRange('ano_atual')">Ano Atual</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Funcionários Ativos</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_funcionarios if kpis_geral else 0 }}</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Custo Total</h6>
                            <h4 class="mb-0">R$ {{ '{:,.2f}'.format(kpis_geral.total_custo_geral if kpis_geral else 0).replace(',', '.') }}</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Total de Horas</h6>
                            <h4 class="mb-0">{{ '{:,.1f}'.format(kpis_geral.total_horas_geral if kpis_geral else 0).replace(',', '.') }}h</h4>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Faltas Justificadas</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_faltas_justificadas_geral if kpis_geral else 0 }} dias</h4>
                            <small>R$ {{ '{:,.2f}'.format(kpis_geral.total_custo_faltas_geral if kpis_geral else 0).replace(',', '.') }}</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda linha de KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Faltas Normais</h6>
                            <h4 class="mb-0">{{ kpis_geral.total_faltas_geral if kpis_geral else 0 }} dias</h4>
                            <small class="opacity-75">Faltas não justificadas</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-user-times fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Taxa de Absenteísmo</h6>
                            <h4 class="mb-0">{{ '{:,.1f}'.format(kpis_geral.taxa_absenteismo_geral if kpis_geral else 0).replace(',', '.') }}%</h4>
                            <small class="opacity-75">Ausências no período</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Total de Faltas</h6>
                            <h4 class="mb-0">{{ (kpis_geral.total_faltas_geral + kpis_geral.total_faltas_justificadas_geral) if kpis_geral else 0 }} dias</h4>
                            <small class="opacity-75">Normais + Justificadas</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-calendar-times fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-light text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Meta Absenteísmo</h6>
                            <h4 class="mb-0 {% if kpis_geral and kpis_geral.taxa_absenteismo_geral <= 5 %}text-success{% elif kpis_geral and kpis_geral.taxa_absenteismo_geral <= 10 %}text-warning{% else %}text-danger{% endif %}">
                                {% if kpis_geral and kpis_geral.taxa_absenteismo_geral <= 5 %}✓ Excelente{% elif kpis_geral and kpis_geral.taxa_absenteismo_geral <= 10 %}△ Aceitável{% else %}✗ Alto{% endif %}
                            </h4>
                            <small class="text-muted">Meta: ≤ 5%</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-bullseye fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Pesquisa -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Pesquisar funcionários...">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <select class="form-select" id="statusFilter">
                <option value="">Todos os Status</option>
                <option value="ativo">Ativos</option>
                <option value="inativo">Inativos</option>
            </select>
        </div>
    </div>

<!-- Grid de Cards de Funcionários -->
<div class="row" id="funcionariosGrid">
    {% if funcionarios_kpis %}
        {% for kpi in funcionarios_kpis %}
    <div class="col-lg-4 col-md-6 mb-4 funcionario-card" 
         data-nome="{{ kpi.funcionario.nome.lower() }}" 
         data-telefone="{{ kpi.funcionario.telefone.lower() if kpi.funcionario.telefone else '' }}"
         data-funcao="{{ kpi.funcionario.funcao_ref.nome.lower() if kpi.funcionario.funcao_ref else '' }}"
         data-status="{{ 'ativo' if kpi.funcionario.ativo else 'inativo' }}">
        <div class="card h-100 funcionario-card-item">
            <div class="card-body d-flex flex-column">
                <!-- Foto e Nome -->
                <div class="text-center mb-3">
                    <img src="{{ obter_foto_funcionario(kpi.funcionario) }}" 
                         class="rounded-circle mb-3" 
                         width="80" 
                         height="80" 
                         style="object-fit: cover; aspect-ratio: 1/1;"
                         alt="Foto de {{ kpi.funcionario.nome }}"
                         data-nome="{{ kpi.funcionario.nome }}">
                    <h5 class="card-title mb-1">{{ kpi.funcionario.nome }}</h5>
                    <small class="text-muted">{{ kpi.funcionario.telefone if kpi.funcionario.telefone else '-' }}</small>
                </div>
                
                <!-- Informações -->
                <div class="mb-3">
                    <div class="mb-2">
                        <i class="fas fa-user-tie text-success me-2"></i>
                        <span>{{ kpi.funcionario.funcao_ref.nome if kpi.funcionario.funcao_ref else '-' }}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-clock text-info me-2"></i>
                        <span>{{ kpi.funcionario.horario_trabalho.nome if kpi.funcionario.horario_trabalho else 'Não definido' }}</span>
                    </div>
                </div>
                
                <!-- KPIs do Período -->
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Horas</small>
                            <strong class="text-primary">{{ '{:,.1f}'.format(kpi.horas_trabalhadas).replace(',', '.') }}h</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Custo Total</small>
                            <strong class="text-success">R$ {{ '{:,.0f}'.format(kpi.custo_total).replace(',', '.') }}</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div class="mb-3">
                    {% if kpi.funcionario.ativo %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Ativo
                        </span>
                    {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle me-1"></i>Inativo
                        </span>
                    {% endif %}
                </div>
                
                <!-- Botões de Ação -->
                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.funcionario_perfil', id=kpi.funcionario.id) }}" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-user me-1"></i>Ver Perfil
                        </a>
                        <div class="row g-1">
                            <div class="col-6">
                                <button class="btn btn-outline-warning btn-sm w-100" disabled>
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                            <div class="col-6">
                                {% if kpi.funcionario.ativo %}
                                    <button class="btn btn-outline-danger btn-sm w-100" 
                                            onclick="toggleStatusFuncionario({{ kpi.funcionario.id }}, '{{ kpi.funcionario.nome }}', false)">
                                        <i class="fas fa-user-times"></i> Desativar
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-success btn-sm w-100" 
                                            onclick="toggleStatusFuncionario({{ kpi.funcionario.id }}, '{{ kpi.funcionario.nome }}', true)">
                                        <i class="fas fa-user-check"></i> Reativar
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum funcionário encontrado</h5>
                    <p class="text-muted">Não há funcionários ativos no período selecionado.</p>
                    <div class="alert alert-info mt-3">
                        <strong>Debug:</strong> {{ funcionarios|length }} funcionários totais, {{ funcionarios_kpis|length }} KPIs calculados
                        <br><small>Admin ID: {% if current_user.is_authenticated %}{{ current_user.id }}{% else %}Não logado{% endif %}</small>
                    </div>
                    <a href="{{ url_for('main.funcionarios') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Adicionar Primeiro Funcionário
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Mensagem quando não há funcionários -->
<div id="noResultsMessage" class="text-center py-5" style="display: none;">
    <i class="fas fa-users fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">Nenhum funcionário encontrado</h4>
    <p class="text-muted">Ajuste os filtros de pesquisa ou adicione novos funcionários.</p>
</div>


<!-- Modal Funcionário -->
<div class="modal fade" id="funcionarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user"></i> 
                    <span id="modalTitle">Novo Funcionário</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="funcionarioForm" enctype="multipart/form-data" action="{{ url_for('main.funcionarios') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nome" class="form-label">Nome *</label>
                                        <input type="text" class="form-control" id="nome" name="nome" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cpf" class="form-label">CPF *</label>
                                        <input type="text" class="form-control" id="cpf" name="cpf" required 
                                               pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}" 
                                               placeholder="000.000.000-00" oninput="formatCPF(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto do Funcionário</label>
                                <input type="file" class="form-control" id="foto" name="foto" 
                                       accept="image/jpeg,image/png,image/gif">
                                <div id="foto-preview" class="mt-2" style="display: none;">
                                    <img id="foto-img" src="" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" class="form-control" id="rg" name="rg">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="data_nascimento" name="data_nascimento">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endereço</label>
                        <textarea class="form-control" id="endereco" name="endereco" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="telefone" name="telefone" oninput="formatPhone(this)">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_admissao" class="form-label">Data de Admissão *</label>
                                <input type="date" class="form-control" id="data_admissao" name="data_admissao" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="salario" class="form-label">Salário</label>
                                <input type="number" class="form-control" id="salario" name="salario" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="departamento_id" class="form-label">Departamento</label>
                                <select class="form-select" id="departamento_id" name="departamento_id">
                                    <option value="0">Selecione...</option>
                                    {% for departamento in departamentos %}
                                        <option value="{{ departamento.id }}">{{ departamento.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="funcao_id" class="form-label">Função</label>
                                <select class="form-select" id="funcao_id" name="funcao_id">
                                    <option value="0">Selecione...</option>
                                    {% for funcao in funcoes %}
                                        <option value="{{ funcao.id }}">{{ funcao.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="horario_trabalho_id" class="form-label">Horário de Trabalho</label>
                                <select class="form-select" id="horario_trabalho_id" name="horario_trabalho_id">
                                    <option value="0">Selecione...</option>
                                    {% for horario in horarios %}
                                        <option value="{{ horario.id }}">{{ horario.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ativo" name="ativo" checked>
                            <label class="form-check-label" for="ativo">
                                Funcionário Ativo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Funcionário
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Abrir modal para novo funcionário
function abrirModalNovoFuncionario() {
    // Limpar formulário
    document.getElementById('funcionarioForm').reset();
    document.getElementById('modalTitle').textContent = 'Novo Funcionário';
    document.getElementById('funcionarioForm').action = "{{ url_for('main.funcionarios') }}";
    
    // Esconder preview da foto
    const fotoPreview = document.getElementById('foto-preview');
    if (fotoPreview) {
        fotoPreview.style.display = 'none';
    }
}

// Enhanced photo upload functionality
function setupPhotoUpload() {
    const fotoInput = document.getElementById('foto');
    const fotoPreview = document.getElementById('foto-preview');
    const fotoImg = document.getElementById('foto-img');
    
    if (fotoInput) {
        fotoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotoImg.src = e.target.result;
                    fotoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

// Enhanced CPF formatting
function formatCPF(input) {
    let value = input.value.replace(/\D/g, '');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    input.value = value;
}

// Enhanced phone formatting
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
    } else {
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{5})(\d)/, '$1-$2');
    }
    input.value = value;
}

// Enhanced form validation
function validateForm() {
    const cpf = document.getElementById('cpf').value;
    const nome = document.getElementById('nome').value;
    
    if (!nome.trim()) {
        alert('Nome é obrigatório');
        return false;
    }
    
    if (!cpf.trim()) {
        alert('CPF é obrigatório');
        return false;
    }
    
    if (!isValidCPF(cpf)) {
        alert('CPF inválido');
        return false;
    }
    
    return true;
}

// CPF validation algorithm
function isValidCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    
    let sum = 0;
    for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.charAt(9))) return false;
    
    sum = 0;
    for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
    }
    remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.charAt(10))) return false;
    
    return true;
}

function editarFuncionario(id) {
    alert('Funcionalidade de edição será implementada em breve');
}

function verDetalhesFuncionario(id) {
    window.location.href = `/funcionarios/${id}/perfil`;
}

function excluirFuncionario(id) {
    if (confirm('Tem certeza que deseja excluir este funcionário? Esta ação não pode ser desfeita.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/funcionarios/' + id + '/excluir';
        document.body.appendChild(form);
        form.submit();
    }
}

function resetForm() {
    document.getElementById('funcionarioForm').reset();
    document.getElementById('funcionarioModalLabel').textContent = 'Novo Funcionário';
    document.getElementById('foto-preview').style.display = 'none';
    document.getElementById('data_admissao').valueAsDate = new Date();
}

// Função para filtrar funcionários
function filtrarFuncionarios() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const funcionarioCards = document.querySelectorAll('.funcionario-card');
    let visibleCount = 0;
    
    console.log('Filtro aplicado:', {
        busca: searchTerm,
        status: statusFilter,
        totalCards: funcionarioCards.length
    });
    
    funcionarioCards.forEach(card => {
        const nome = card.dataset.nome || '';
        const telefone = card.dataset.telefone || '';
        const funcao = card.dataset.funcao || '';
        const status = card.dataset.status || '';
        
        console.log('Card:', {
            nome,
            status,
            statusFilter,
            matchesStatus: statusFilter === '' || status === statusFilter
        });
        
        const matchesSearch = nome.includes(searchTerm) || 
                            telefone.includes(searchTerm) || 
                            funcao.includes(searchTerm);
        
        const matchesStatus = statusFilter === '' || status === statusFilter;
        
        if (matchesSearch && matchesStatus) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    console.log('Funcionários visíveis:', visibleCount);
    
    // Mostrar/esconder mensagem "nenhum resultado"
    let noResults = document.getElementById('noResultsMessage');
    if (visibleCount === 0 && !noResults) {
        // Criar mensagem se não existir
        noResults = document.createElement('div');
        noResults.id = 'noResultsMessage';
        noResults.className = 'col-12 text-center py-5';
        noResults.innerHTML = `
            <div class="text-muted">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5>Nenhum funcionário encontrado</h5>
                <p>Tente ajustar os filtros de pesquisa</p>
            </div>
        `;
        document.getElementById('funcionariosGrid').appendChild(noResults);
    }
    
    if (noResults) {
        if (visibleCount === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
}

$(document).ready(function() {
    // Setup search and filter functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filtrarFuncionarios);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filtrarFuncionarios);
    }
    
    // Setup photo upload
    setupPhotoUpload();
    
    // Setup form validation
    const form = document.getElementById('funcionarioForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });
    }
    
    // Setup input formatting
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function() {
            formatCPF(this);
        });
    }
    
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
            formatPhone(this);
        });
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Reset form when modal closes
    const modal = document.getElementById('funcionarioModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', resetForm);
    }
    
    // Configurar data de admissão padrão
    const dataAdmissaoInput = document.getElementById('data_admissao');
    if (dataAdmissaoInput) {
        dataAdmissaoInput.valueAsDate = new Date();
    }
    
    // Adicionar hover effect aos cards
    const cards = document.querySelectorAll('.funcionario-card-item');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});

function setDateRange(period) {
    console.log('setDateRange chamado com período:', period);
    const today = new Date();
    let startDate, endDate = today;
    
    switch(period) {
        case 'ultimo_mes':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'ultimos_3_meses':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            break;
        case 'ano_atual':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    // Formatar datas para yyyy-mm-dd
    const formatDate = (date) => {
        return date.getFullYear() + '-' + 
               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
               String(date.getDate()).padStart(2, '0');
    };
    
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');
    
    if (dataInicioInput && dataFimInput) {
        const dataInicioFormatada = formatDate(startDate);
        const dataFimFormatada = formatDate(endDate);
        
        console.log('Definindo datas:', dataInicioFormatada, 'até', dataFimFormatada);
        
        dataInicioInput.value = dataInicioFormatada;
        dataFimInput.value = dataFimFormatada;
        
        // Aguardar um momento para garantir que os valores foram definidos
        setTimeout(() => {
            // Método alternativo: redirecionar diretamente com parâmetros
            const url = new URL(window.location);
            url.searchParams.set('data_inicio', dataInicioFormatada);
            url.searchParams.set('data_fim', dataFimFormatada);
            console.log('Redirecionando para:', url.toString());
            window.location.href = url.toString();
        }, 100);
    } else {
        console.error('Campos de data não encontrados!');
    }
}
</script>

<!-- Modal de Lançamento Múltiplo -->
<div class="modal fade" id="modalLancamentoMultiplo" tabindex="-1" aria-labelledby="modalLancamentoMultiploLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalLancamentoMultiploLabel">
                    <i class="fas fa-users-cog"></i> Lançamento Múltiplo de Ponto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formLancamentoMultiplo">
                    <!-- Período e Configurações Gerais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-calendar-alt"></i> Configurações do Lançamento</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="periodo_inicio" class="form-label">Data Início*</label>
                                            <input type="date" class="form-control" id="periodo_inicio" name="periodo_inicio" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="periodo_fim" class="form-label">Data Fim*</label>
                                            <input type="date" class="form-control" id="periodo_fim" name="periodo_fim" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="tipo_lancamento" class="form-label">Tipo de Lançamento*</label>
                                            <select class="form-select" id="tipo_lancamento" name="tipo_lancamento" required onchange="toggleCamposTipoLancamento()">
                                                <option value="">Selecione...</option>
                                                
                                                <optgroup label="📋 TRABALHO (com custo)">
                                                    <option value="trabalho_normal">👷 Trabalho Normal</option>
                                                    <option value="sabado_trabalhado">📅 Sábado Trabalhado (+50%)</option>
                                                    <option value="domingo_trabalhado">📅 Domingo Trabalhado (+100%)</option>
                                                    <option value="feriado_trabalhado">🎉 Feriado Trabalhado (+100%)</option>
                                                </optgroup>
                                                
                                                <optgroup label="⚠️ AUSÊNCIAS">
                                                    <option value="falta">❌ Falta (desconta salário)</option>
                                                    <option value="falta_justificada">⚕️ Falta Justificada</option>
                                                    <option value="ferias">🏖️ Férias</option>
                                                </optgroup>
                                                
                                                <optgroup label="🏠 FOLGAS (sem custo)">
                                                    <option value="sabado_folga">📅 Sábado - Folga</option>
                                                    <option value="domingo_folga">📅 Domingo - Folga</option>
                                                    <option value="feriado_folga">🎉 Feriado - Folga</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="obra_lancamento" class="form-label">Obra*</label>
                                            <select class="form-select" id="obra_lancamento" name="obra_id" required>
                                                <option value="">Selecione uma obra...</option>
                                                {% for obra in obras_ativas %}
                                                <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos de Horários (visível apenas para tipos que precisam) -->
                    <div class="row mb-4" id="campos_horarios" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-clock"></i> Horários de Trabalho</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label for="hora_entrada" class="form-label">Entrada</label>
                                            <input type="time" class="form-control" id="hora_entrada" name="hora_entrada">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="hora_almoco_inicio" class="form-label">Início Almoço</label>
                                            <input type="time" class="form-control" id="hora_almoco_inicio" name="hora_almoco_inicio">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="hora_almoco_fim" class="form-label">Fim Almoço</label>
                                            <input type="time" class="form-control" id="hora_almoco_fim" name="hora_almoco_fim">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="hora_saida" class="form-label">Saída</label>
                                            <input type="time" class="form-control" id="hora_saida" name="hora_saida">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="percentual_extras" class="form-label">% Extras</label>
                                            <input type="number" class="form-control" id="percentual_extras" name="percentual_extras" 
                                                   min="0" max="200" placeholder="50">
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="sem_intervalo" name="sem_intervalo">
                                                <label class="form-check-label" for="sem_intervalo">
                                                    Sem Intervalo
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seleção de Funcionários -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-users"></i> Selecionar Funcionários</h6>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosFuncionarios()">
                                            <i class="fas fa-check-double"></i> Selecionar Todos
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoFuncionarios()">
                                            <i class="fas fa-times"></i> Limpar Seleção
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="busca_funcionarios" 
                                                   placeholder="Buscar funcionários..." onkeyup="filtrarFuncionariosModal()">
                                        </div>
                                        <div class="col-md-6">
                                            <div id="contador_selecionados" class="text-muted">
                                                <i class="fas fa-users"></i> 0 funcionários selecionados
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row" id="lista_funcionarios" style="max-height: 300px; overflow-y: auto;">
                                        {% for funcionario in funcionarios %}
                                        <div class="col-md-4 mb-2 funcionario-item" data-nome="{{ funcionario.nome.lower() }}" data-funcao="{{ funcionario.funcao.nome.lower() if funcionario.funcao else '' }}">
                                            <div class="card">
                                                <div class="card-body p-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input funcionario-checkbox" type="checkbox" 
                                                               value="{{ funcionario.id }}" id="func_{{ funcionario.id }}" 
                                                               onchange="atualizarContadorSelecionados()">
                                                        <label class="form-check-label w-100" for="func_{{ funcionario.id }}">
                                                            <div class="d-flex align-items-center">
                                                                <div class="me-2">
                                                                    {% if funcionario.foto %}
                                                                    <img src="{{ funcionario.foto }}" class="rounded-circle" width="30" height="30">
                                                                    {% else %}
                                                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                                                         style="width: 30px; height: 30px; font-size: 12px;">
                                                                        {{ funcionario.nome.split()[0][0] }}{{ funcionario.nome.split()[-1][0] if funcionario.nome.split()|length > 1 else '' }}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <div class="fw-bold" style="font-size: 0.9em;">{{ funcionario.nome[:20] }}{% if funcionario.nome|length > 20 %}...{% endif %}</div>
                                                                    <small class="text-muted">{{ funcionario.funcao.nome if funcionario.funcao else 'Sem função' }}</small>
                                                                </div>
                                                            </div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-comment"></i> Observações (Opcional)</h6>
                                </div>
                                <div class="card-body">
                                    <textarea class="form-control" id="observacoes_lancamento" name="observacoes" 
                                              rows="3" placeholder="Observações sobre este lançamento..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="processarLancamentoMultiplo()">
                    <i class="fas fa-save"></i> Processar Lançamentos
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Funções para o Modal de Lançamento Múltiplo
function toggleCamposTipoLancamento() {
    const tipo = document.getElementById('tipo_lancamento').value;
    const camposHorarios = document.getElementById('campos_horarios');
    
    // Tipos que precisam de horários
    const tiposComHorarios = ['trabalho_normal', 'sabado_trabalhado', 'domingo_trabalhado', 'feriado_trabalhado'];
    
    if (tiposComHorarios.includes(tipo)) {
        camposHorarios.style.display = 'block';
        
        // Definir valores padrão baseados no tipo
        const horaEntrada = document.getElementById('hora_entrada');
        const horaAlmocoInicio = document.getElementById('hora_almoco_inicio');
        const horaAlmocoFim = document.getElementById('hora_almoco_fim');
        const horaSaida = document.getElementById('hora_saida');
        const percentualExtras = document.getElementById('percentual_extras');
        
        switch(tipo) {
            case 'trabalho_normal':
                horaEntrada.value = '07:12';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '17:00';
                percentualExtras.value = '';
                break;
            case 'sabado_trabalhado':
                horaEntrada.value = '07:00';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '16:00';
                percentualExtras.value = '50';
                break;
            case 'domingo_trabalhado':
                horaEntrada.value = '07:00';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '16:00';
                percentualExtras.value = '100';
                break;
            case 'feriado_trabalhado':
                horaEntrada.value = '07:12';
                horaAlmocoInicio.value = '12:00';
                horaAlmocoFim.value = '13:00';
                horaSaida.value = '17:00';
                percentualExtras.value = '100';
                break;

        }
    } else {
        camposHorarios.style.display = 'none';
    }
}

function selecionarTodosFuncionarios() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox');
    const funcionariosVisiveis = document.querySelectorAll('.funcionario-item:not([style*="display: none"])');
    
    funcionariosVisiveis.forEach(item => {
        const checkbox = item.querySelector('.funcionario-checkbox');
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    atualizarContadorSelecionados();
}

function limparSelecaoFuncionarios() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    atualizarContadorSelecionados();
}

function atualizarContadorSelecionados() {
    const checkboxes = document.querySelectorAll('.funcionario-checkbox:checked');
    const contador = document.getElementById('contador_selecionados');
    contador.innerHTML = `<i class="fas fa-users"></i> ${checkboxes.length} funcionários selecionados`;
}

function filtrarFuncionariosModal() {
    const busca = document.getElementById('busca_funcionarios').value.toLowerCase();
    const funcionarios = document.querySelectorAll('.funcionario-item');
    
    funcionarios.forEach(funcionario => {
        const nome = funcionario.dataset.nome || '';
        const funcao = funcionario.dataset.funcao || '';
        
        if (nome.includes(busca) || funcao.includes(busca)) {
            funcionario.style.display = '';
        } else {
            funcionario.style.display = 'none';
        }
    });
}

function processarLancamentoMultiplo() {
    const form = document.getElementById('formLancamentoMultiplo');
    const formData = new FormData(form);
    
    // Validações
    if (!formData.get('periodo_inicio') || !formData.get('periodo_fim')) {
        alert('Por favor, selecione o período de lançamento.');
        return;
    }
    
    if (!formData.get('tipo_lancamento')) {
        alert('Por favor, selecione o tipo de lançamento.');
        return;
    }
    
    if (!formData.get('obra_id')) {
        alert('Por favor, selecione uma obra.');
        return;
    }
    
    // Coletar funcionários selecionados
    const funcionariosSelecionados = [];
    const checkboxes = document.querySelectorAll('.funcionario-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Por favor, selecione pelo menos um funcionário.');
        return;
    }
    
    checkboxes.forEach(checkbox => {
        funcionariosSelecionados.push(checkbox.value);
    });
    
    // Preparar dados para envio
    const dadosLancamento = {
        periodo_inicio: formData.get('periodo_inicio'),
        periodo_fim: formData.get('periodo_fim'),
        tipo_lancamento: formData.get('tipo_lancamento'),
        obra_id: formData.get('obra_id'),
        funcionarios: funcionariosSelecionados,
        hora_entrada: formData.get('hora_entrada'),
        hora_almoco_inicio: formData.get('hora_almoco_inicio'),
        hora_almoco_fim: formData.get('hora_almoco_fim'),
        hora_saida: formData.get('hora_saida'),
        percentual_extras: formData.get('percentual_extras'),
        sem_intervalo: formData.get('sem_intervalo') ? true : false,
        observacoes: formData.get('observacoes')
    };
    
    // Confirmar com o usuário
    const diasPeriodo = Math.ceil((new Date(dadosLancamento.periodo_fim) - new Date(dadosLancamento.periodo_inicio)) / (1000 * 60 * 60 * 24)) + 1;
    const totalLancamentos = funcionariosSelecionados.length * diasPeriodo;
    
    if (!confirm(`Confirma o lançamento múltiplo?\n\n${funcionariosSelecionados.length} funcionários\n${diasPeriodo} dias\nTotal: ${totalLancamentos} lançamentos`)) {
        return;
    }
    
    // Mostrar loading
    const btnProcessar = event.target;
    const textoOriginal = btnProcessar.innerHTML;
    btnProcessar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    btnProcessar.disabled = true;
    
    // Enviar requisição
    fetch('/api/ponto/lancamento-multiplo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dadosLancamento)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`Sucesso! ${result.total_lancamentos} lançamentos processados.`);
            $('#modalLancamentoMultiplo').modal('hide');
            location.reload();
        } else {
            alert('Erro: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar lançamentos.');
    })
    .finally(() => {
        btnProcessar.innerHTML = textoOriginal;
        btnProcessar.disabled = false;
    });
}

// Configurar datas padrão ao abrir o modal
$('#modalLancamentoMultiplo').on('show.bs.modal', function() {
    const hoje = new Date();
    const primeiroDiaDoMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    
    document.getElementById('periodo_inicio').value = primeiroDiaDoMes.toISOString().split('T')[0];
    document.getElementById('periodo_fim').value = hoje.toISOString().split('T')[0];
});

// Toggle status funcionário (ativar/desativar)
function toggleStatusFuncionario(id, nome, ativar) {
    const acao = ativar ? 'ativar' : 'desativar';
    const mensagem = `Tem certeza que deseja ${acao} o funcionário ${nome}?`;
    
    if (confirm(mensagem)) {
        fetch(`/funcionario/${id}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                ativo: ativar
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro interno do servidor');
        });
    }
}

// Function to get CSRF token
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
