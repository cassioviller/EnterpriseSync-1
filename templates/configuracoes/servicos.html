{% extends "base_completo.html" %}

{% block title %}Serviços - SIGE{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tools me-2"></i> Gestão de Serviços</h2>
                <a href="{{ url_for('main.novo_servico') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Novo Serviço
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i> Serviços Disponíveis</h5>
                </div>
                <div class="card-body">
                    {% if servicos %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Unidade</th>
                                    <th>Subatividades</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for servico in servicos %}
                                <tr>
                                    <td>
                                        <strong>{{ servico.nome }}</strong>
                                        {% if servico.descricao %}
                                        <br><small class="text-muted">{{ servico.descricao }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ servico.categoria or 'Sem categoria' }}</span>
                                    </td>
                                    <td>{{ servico.unidade_medida }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ servico.subatividades|length }} subatividades</span>
                                    </td>
                                    <td>
                                        {% if servico.ativo %}
                                        <span class="badge bg-success">Ativo</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inativo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('main.ver_servico', servico_id=servico.id) }}" 
                                               class="btn btn-sm btn-outline-primary" title="Visualizar">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('main.editar_servico', servico_id=servico.id) }}" 
                                               class="btn btn-sm btn-outline-warning" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-success" 
                                                    title="Gerenciar Subatividades"
                                                    onclick="gerenciarSubatividades({{ servico.id }}, '{{ servico.nome }}')">
                                                <i class="fas fa-tasks"></i>
                                            </button>
                                            {% if servico.ativo %}
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    title="Desativar"
                                                    onclick="toggleServico({{ servico.id }}, false)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-success" 
                                                    title="Ativar"
                                                    onclick="toggleServico({{ servico.id }}, true)">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum serviço cadastrado</h5>
                        <p class="text-muted">Clique em "Novo Serviço" para cadastrar o primeiro serviço.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gerenciar Subatividades -->
<div class="modal fade" id="subatividadesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i> Subatividades do Serviço
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="subatividades-content">
                    <div class="text-center py-3">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Função para alternar status do serviço
function toggleServico(servicoId, ativo) {
    const action = ativo ? 'ativar' : 'desativar';
    
    if (confirm(`Deseja ${action} este serviço?`)) {
        fetch(`/servicos/${servicoId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ativo: ativo })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao alterar status: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao alterar status do serviço');
        });
    }
}

// Função para gerenciar subatividades
function gerenciarSubatividades(servicoId, servicoNome) {
    const modal = new bootstrap.Modal(document.getElementById('subatividadesModal'));
    document.querySelector('#subatividadesModal .modal-title').innerHTML = 
        `<i class="fas fa-tasks me-2"></i> Subatividades: ${servicoNome}`;
    
    // Carregar subatividades
    fetch(`/servicos/${servicoId}/subatividades/api`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderSubatividades(data.subatividades, servicoId);
            } else {
                document.getElementById('subatividades-content').innerHTML = 
                    '<div class="alert alert-danger">Erro ao carregar subatividades</div>';
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('subatividades-content').innerHTML = 
                '<div class="alert alert-danger">Erro de conexão</div>';
        });
    
    modal.show();
}

// Renderizar lista de subatividades
function renderSubatividades(subatividades, servicoId) {
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">${subatividades.length} subatividades</span>
            <button type="button" class="btn btn-sm btn-primary" onclick="novaSubatividade(${servicoId})">
                <i class="fas fa-plus me-1"></i> Nova Subatividade
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Ordem</th>
                        <th>Nome</th>
                        <th>Complexidade</th>
                        <th>Duração</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (subatividades.length === 0) {
        html += `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Nenhuma subatividade cadastrada
                </td>
            </tr>
        `;
    } else {
        subatividades.forEach(sub => {
            html += `
                <tr>
                    <td>${sub.ordem_padrao}</td>
                    <td>
                        <strong>${sub.nome}</strong>
                        ${sub.descricao ? `<br><small class="text-muted">${sub.descricao}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-secondary">Nível ${sub.complexidade}</span>
                    </td>
                    <td>${sub.duracao_estimada_horas}h</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" 
                                    onclick="editarSubatividade(${sub.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" 
                                    onclick="excluirSubatividade(${sub.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('subatividades-content').innerHTML = html;
}

// Placeholder functions para as ações de subatividades
function novaSubatividade(servicoId) {
    alert('Funcionalidade de nova subatividade em desenvolvimento');
}

function editarSubatividade(subatividadeId) {
    alert('Funcionalidade de edição em desenvolvimento');
}

function excluirSubatividade(subatividadeId) {
    if (confirm('Deseja realmente excluir esta subatividade?')) {
        alert('Funcionalidade de exclusão em desenvolvimento');
    }
}
</script>
{% endblock %}