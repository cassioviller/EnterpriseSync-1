{% extends "base_completo.html" %}

{% block title %}Configurações da Empresa{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configurações da Empresa
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('configuracoes.configuracoes') }}">Configurações</a></li>
                        <li class="breadcrumb-item active">Empresa</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        Dados da Empresa
                    </h5>
                    <small class="text-muted">Configure as informações que aparecerão nas propostas</small>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('configuracoes.salvar_empresa') }}">
                        <!-- Dados Básicos -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="nome_empresa" class="form-label">Nome da Empresa *</label>
                                    <input type="text" class="form-control" id="nome_empresa" name="nome_empresa" 
                                           value="{{ config.nome_empresa if config else '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cnpj" class="form-label">CNPJ</label>
                                    <input type="text" class="form-control" id="cnpj" name="cnpj" 
                                           value="{{ config.cnpj if config else '' }}" placeholder="00.000.000/0001-00">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="endereco" class="form-label">Endereço</label>
                            <textarea class="form-control" id="endereco" name="endereco" rows="2" 
                                      placeholder="Rua, número, bairro, cidade - estado">{{ config.endereco if config else '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="telefone" class="form-label">Telefone</label>
                                    <input type="tel" class="form-control" id="telefone" name="telefone" 
                                           value="{{ config.telefone if config else '' }}" placeholder="(00) 0000-0000">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ config.email if config else '' }}" placeholder="contato@empresa.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="website" class="form-label">Website</label>
                                    <input type="url" class="form-control" id="website" name="website" 
                                           value="{{ config.website if config else '' }}" placeholder="https://www.empresa.com">
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Personalização Visual -->
                        <h6 class="mb-3">
                            <i class="fas fa-palette me-2"></i>
                            Personalização Visual
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="logo_upload" class="form-label">Logo da Empresa (Geral)</label>
                                    <div class="d-flex align-items-center gap-3">
                                        {% if config and config.logo_base64 %}
                                            <div class="position-relative">
                                                <img id="logo_preview" src="data:image/png;base64,{{ config.logo_base64 }}" 
                                                     alt="Logo atual" style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;">
                                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle p-1" 
                                                        onclick="clearImage('logo')" style="width: 20px; height: 20px; font-size: 10px; margin-top: -5px; margin-right: -5px;">×</button>
                                            </div>
                                        {% else %}
                                            <div id="logo_preview" style="width: 60px; height: 60px; border: 2px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                        {% endif %}
                                        <div class="flex-grow-1">
                                            <input type="file" class="form-control" id="logo_upload" accept="image/*">
                                            <small class="text-muted">Para portal do cliente e propostas online</small>
                                        </div>
                                    </div>
                                    <input type="hidden" id="logo_base64" name="logo_base64" value="{{ config.logo_base64 if config else '' }}">
                                    <input type="hidden" id="clear_logo" name="clear_logo" value="">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="logo_pdf_upload" class="form-label">Logo para PDF</label>
                                    <div class="d-flex align-items-center gap-3">
                                        {% if config and config.logo_pdf_base64 %}
                                            <div class="position-relative">
                                                <img id="logo_pdf_preview" src="data:image/png;base64,{{ config.logo_pdf_base64 }}" 
                                                     alt="Logo PDF atual" style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;">
                                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle p-1" 
                                                        onclick="clearImage('logo_pdf')" style="width: 20px; height: 20px; font-size: 10px; margin-top: -5px; margin-right: -5px;">×</button>
                                            </div>
                                        {% else %}
                                            <div id="logo_pdf_preview" style="width: 60px; height: 60px; border: 2px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-file-pdf text-muted"></i>
                                            </div>
                                        {% endif %}
                                        <div class="flex-grow-1">
                                            <input type="file" class="form-control" id="logo_pdf_upload" accept="image/*">
                                            <small class="text-muted">Específica para documentos PDF (formato Estruturas do Vale)</small>
                                        </div>
                                    </div>
                                    <input type="hidden" id="logo_pdf_base64" name="logo_pdf_base64" value="{{ config.logo_pdf_base64 if config else '' }}">
                                    <input type="hidden" id="clear_logo_pdf" name="clear_logo_pdf" value="">
                                </div>
                            </div>
                            
                            <!-- Header PDF -->
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-image me-2"></i>
                                        Header do PDF (Cabeçalho Completo)
                                    </label>
                                    <div class="d-flex align-items-center gap-3">
                                        {% if config and config.header_pdf_base64 %}
                                        <div class="position-relative">
                                            <img id="header_pdf_preview" src="data:image/png;base64,{{ config.header_pdf_base64 }}" alt="Header PDF" style="height: 60px; max-width: 200px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;">
                                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle p-1" 
                                                    onclick="clearImage('header_pdf')" style="width: 20px; height: 20px; font-size: 10px; margin-top: -5px; margin-right: -5px;">×</button>
                                        </div>
                                        {% else %}
                                        <div id="header_pdf_preview" class="bg-light border rounded d-flex align-items-center justify-content-center" style="height: 60px; width: 200px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                        {% endif %}
                                        <div class="flex-grow-1">
                                            <input type="file" class="form-control" id="header_pdf_upload" accept="image/*">
                                            <small class="text-muted">
                                                <strong>Tamanho recomendado:</strong> 800-1200px (largura) x 80-120px (altura)<br>
                                                Substitui a logo no cabeçalho do PDF - ideal para headers com design específico
                                            </small>
                                        </div>
                                    </div>
                                    <input type="hidden" id="header_pdf_base64" name="header_pdf_base64" value="{{ config.header_pdf_base64 if config else '' }}">
                                    <input type="hidden" id="clear_header_pdf" name="clear_header_pdf" value="">
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Seção de Cores -->
                        <h6 class="mb-3">
                            <i class="fas fa-palette me-2"></i>
                            Personalização Visual
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="cor_primaria" class="form-label">Cor Primária</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <input type="color" class="form-control form-control-color" id="cor_primaria" name="cor_primaria" 
                                                       value="{{ config.cor_primaria if config else '#007bff' }}" style="width: 50px;">
                                                <input type="text" class="form-control" id="cor_primaria_text" readonly 
                                                       value="{{ config.cor_primaria if config else '#007bff' }}">
                                            </div>
                                            <small class="text-muted">Cor principal dos botões e elementos</small>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="cor_fundo_proposta" class="form-label">Cor de Fundo das Propostas</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <input type="color" class="form-control form-control-color" id="cor_fundo_proposta" name="cor_fundo_proposta" 
                                                       value="{{ config.cor_fundo_proposta if config else '#f8f9fa' }}" style="width: 50px;">
                                                <input type="text" class="form-control" id="cor_fundo_proposta_text" readonly 
                                                       value="{{ config.cor_fundo_proposta if config else '#f8f9fa' }}">
                                            </div>
                                            <small class="text-muted">Cor de fundo das propostas PDF</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Configurações Padrão -->
                        <h6 class="mb-3">
                            <i class="fas fa-sliders-h me-2"></i>
                            Configurações Padrão para Propostas
                        </h6>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="prazo_entrega_padrao" class="form-label">Prazo de Entrega (dias)</label>
                                    <input type="number" class="form-control" id="prazo_entrega_padrao" name="prazo_entrega_padrao" 
                                           value="{{ config.prazo_entrega_padrao if config else 90 }}" min="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="validade_padrao" class="form-label">Validade (dias)</label>
                                    <input type="number" class="form-control" id="validade_padrao" name="validade_padrao" 
                                           value="{{ config.validade_padrao if config else 7 }}" min="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="percentual_nota_fiscal_padrao" class="form-label">% Nota Fiscal</label>
                                    <input type="number" class="form-control" id="percentual_nota_fiscal_padrao" name="percentual_nota_fiscal_padrao" 
                                           value="{{ config.percentual_nota_fiscal_padrao if config else 13.5 }}" step="0.1" min="0">
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Textos Padrão -->
                        <h6 class="mb-3">
                            <i class="fas fa-file-text me-2"></i>
                            Textos Padrão para Propostas
                        </h6>

                        <div class="mb-3">
                            <label for="itens_inclusos_padrao" class="form-label">Itens Inclusos</label>
                            <textarea class="form-control" id="itens_inclusos_padrao" name="itens_inclusos_padrao" rows="4" 
                                      placeholder="Liste os itens que geralmente estão inclusos nos serviços...">{{ config.itens_inclusos_padrao if config else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="itens_exclusos_padrao" class="form-label">Itens Exclusos</label>
                            <textarea class="form-control" id="itens_exclusos_padrao" name="itens_exclusos_padrao" rows="4" 
                                      placeholder="Liste os itens que geralmente NÃO estão inclusos...">{{ config.itens_exclusos_padrao if config else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="condicoes_pagamento_padrao" class="form-label">Condições de Pagamento</label>
                            <textarea class="form-control" id="condicoes_pagamento_padrao" name="condicoes_pagamento_padrao" rows="3" 
                                      placeholder="Descreva as condições de pagamento padrão...">{{ config.condicoes_pagamento_padrao if config else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="garantias_padrao" class="form-label">Garantias</label>
                            <textarea class="form-control" id="garantias_padrao" name="garantias_padrao" rows="3" 
                                      placeholder="Descreva as garantias oferecidas...">{{ config.garantias_padrao if config else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="condicoes_padrao" class="form-label">Condições Gerais</label>
                            <textarea class="form-control" id="condicoes_padrao" name="condicoes_padrao" rows="3" 
                                      placeholder="Condições gerais do serviço...">{{ config.condicoes_padrao if config else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="observacoes_gerais_padrao" class="form-label">Observações Gerais</label>
                            <textarea class="form-control" id="observacoes_gerais_padrao" name="observacoes_gerais_padrao" rows="3" 
                                      placeholder="Observações que aparecem no final das propostas...">{{ config.observacoes_gerais_padrao if config else '' }}</textarea>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('configuracoes.configuracoes') }}" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>
                                Salvar Configurações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Máscaras para campos
document.getElementById('cnpj').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/^(\d{2})(\d)/, '$1.$2');
    value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
    value = value.replace(/(\d{4})(\d)/, '$1-$2');
    e.target.value = value;
});

document.getElementById('telefone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/^(\d{2})(\d)/, '($1) $2');
    value = value.replace(/(\d{4})(\d)/, '$1-$2');
    e.target.value = value;
});

// Upload de logo
document.getElementById('logo_upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Verificar tamanho do arquivo (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('O arquivo é muito grande. O tamanho máximo é 2MB.');
            e.target.value = '';
            return;
        }
        
        // Verificar tipo do arquivo
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem.');
            e.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64String = event.target.result.split(',')[1]; // Remove o prefixo data:image/...;base64,
            document.getElementById('logo_base64').value = base64String;
            
            // Atualizar preview
            const preview = document.getElementById('logo_preview');
            if (preview.tagName === 'IMG') {
                preview.src = event.target.result;
            } else {
                // Substituir div por img
                const img = document.createElement('img');
                img.id = 'logo_preview';
                img.src = event.target.result;
                img.alt = 'Preview da logo';
                img.style.cssText = 'width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;';
                preview.parentNode.replaceChild(img, preview);
            }
        };
        reader.readAsDataURL(file);
    }
});

// Upload da logo PDF
document.getElementById('logo_pdf_upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validar tamanho (2MB max)
        if (file.size > 2 * 1024 * 1024) {
            alert('Arquivo muito grande! Máximo 2MB.');
            e.target.value = '';
            return;
        }
        
        // Converter para base64
        const reader = new FileReader();
        reader.onload = function(event) {
            // Remover prefixo "data:image/...;base64,"
            const base64 = event.target.result.split(',')[1];
            document.getElementById('logo_pdf_base64').value = base64;
            
            // Atualizar preview
            const preview = document.getElementById('logo_pdf_preview');
            if (preview.tagName === 'IMG') {
                preview.src = event.target.result;
            } else {
                // Substituir div por img
                const img = document.createElement('img');
                img.id = 'logo_pdf_preview';
                img.src = event.target.result;
                img.alt = 'Preview da logo PDF';
                img.style.cssText = 'width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;';
                preview.parentNode.replaceChild(img, preview);
            }
        };
        reader.readAsDataURL(file);
    }
});

// Função para limpar imagens
function clearImage(imageType) {
    // Definir campos baseado no tipo
    let previewElement, hiddenField, clearField, uploadField;
    
    switch(imageType) {
        case 'logo':
            previewElement = document.getElementById('logo_preview');
            hiddenField = document.getElementById('logo_base64');
            clearField = document.getElementById('clear_logo');
            uploadField = document.getElementById('logo_upload');
            break;
        case 'logo_pdf':
            previewElement = document.getElementById('logo_pdf_preview');
            hiddenField = document.getElementById('logo_pdf_base64');
            clearField = document.getElementById('clear_logo_pdf');
            uploadField = document.getElementById('logo_pdf_upload');
            break;
        case 'header_pdf':
            previewElement = document.getElementById('header_pdf_preview');
            hiddenField = document.getElementById('header_pdf_base64');
            clearField = document.getElementById('clear_header_pdf');
            uploadField = document.getElementById('header_pdf_upload');
            break;
    }
    
    if (previewElement && hiddenField && clearField && uploadField) {
        // Limpar valores
        hiddenField.value = '';
        clearField.value = 'true';
        uploadField.value = '';
        
        // Atualizar preview visual
        if (imageType === 'logo') {
            previewElement.outerHTML = '<div id="logo_preview" style="width: 60px; height: 60px; border: 2px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image text-muted"></i></div>';
        } else if (imageType === 'logo_pdf') {
            previewElement.outerHTML = '<div id="logo_pdf_preview" style="width: 60px; height: 60px; border: 2px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-file-pdf text-muted"></i></div>';
        } else if (imageType === 'header_pdf') {
            previewElement.outerHTML = '<div id="header_pdf_preview" class="bg-light border rounded d-flex align-items-center justify-content-center" style="height: 60px; width: 200px;"><i class="fas fa-image text-muted"></i></div>';
        }
    }
}

// Upload do header PDF
document.getElementById('header_pdf_upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validar tamanho (2MB max)
        if (file.size > 2 * 1024 * 1024) {
            alert('Arquivo muito grande! Máximo 2MB.');
            e.target.value = '';
            return;
        }
        
        // Validar dimensões recomendadas
        const img = new Image();
        img.onload = function() {
            const ratio = this.width / this.height;
            if (ratio < 6 || ratio > 15) {
                const confirm = window.confirm(
                    'As dimensões não seguem o formato recomendado para header PDF (proporção 10:1).\n' +
                    `Dimensões do arquivo: ${this.width}x${this.height}\n` +
                    'Recomendado: 800-1200px (largura) x 80-120px (altura)\n\n' +
                    'Deseja continuar mesmo assim?'
                );
                if (!confirm) {
                    document.getElementById('header_pdf_upload').value = '';
                    return;
                }
            }
        };
        
        // Converter para base64
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64 = event.target.result.split(',')[1];
            document.getElementById('header_pdf_base64').value = base64;
            
            // Atualizar preview com botão de remoção
            const currentPreview = document.getElementById('header_pdf_preview');
            if (currentPreview) {
                const container = document.createElement('div');
                container.className = 'position-relative';
                
                const img = document.createElement('img');
                img.id = 'header_pdf_preview';
                img.src = event.target.result;
                img.alt = 'Header PDF';
                img.style.cssText = 'height: 60px; max-width: 200px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;';
                
                const clearBtn = document.createElement('button');
                clearBtn.type = 'button';
                clearBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle p-1';
                clearBtn.style.cssText = 'width: 20px; height: 20px; font-size: 10px; margin-top: -5px; margin-right: -5px;';
                clearBtn.innerHTML = '×';
                clearBtn.onclick = () => clearImage('header_pdf');
                
                container.appendChild(img);
                container.appendChild(clearBtn);
                currentPreview.replaceWith(container);
            }
            
            img.src = event.target.result; // Para validação de dimensões
        };
        reader.readAsDataURL(file);
    }
});

// Sincronização dos campos de cor
document.getElementById('cor_primaria').addEventListener('input', function(e) {
    document.getElementById('cor_primaria_text').value = e.target.value;
});

document.getElementById('cor_fundo_proposta').addEventListener('input', function(e) {
    document.getElementById('cor_fundo_proposta_text').value = e.target.value;
});

// Aplicar cores em tempo real para preview
document.getElementById('cor_primaria').addEventListener('change', function(e) {
    // Aplicar cor primária aos botões para preview
    const buttons = document.querySelectorAll('.btn-success');
    buttons.forEach(btn => {
        btn.style.backgroundColor = e.target.value;
        btn.style.borderColor = e.target.value;
    });
});
</script>
{% endblock %}