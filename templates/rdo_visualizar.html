{% extends "base_completo.html" %}

{% block title %}RDO {{ rdo.numero_rdo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header do RDO -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-eye me-2"></i>RDO {{ rdo.numero_rdo }}
                        </h4>
                        <div class="d-flex gap-2">
                            {% if rdo.status == 'Rascunho' %}
                                <a href="{{ url_for('rdo_crud.editar_rdo', rdo_id=rdo.id) }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit me-1"></i>Editar
                                </a>
                                <button class="btn btn-success btn-sm" onclick="finalizarRDO({{ rdo.id }})">
                                    <i class="fas fa-check me-1"></i>Finalizar
                                </button>
                            {% endif %}
                            <a href="{{ url_for('rdo_crud.listar_rdos') }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-arrow-left me-1"></i>Voltar
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Obra:</strong><br>
                            {{ rdo.obra.nome }}
                        </div>
                        <div class="col-md-3">
                            <strong>Data:</strong><br>
                            {{ rdo.data_relatorio.strftime('%d/%m/%Y') }}
                        </div>
                        <div class="col-md-3">
                            <strong>Status:</strong><br>
                            <span class="badge bg-{{ 'warning' if rdo.status == 'Rascunho' else 'success' if rdo.status == 'Finalizado' else 'info' }}">
                                {{ rdo.status }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Progresso Total:</strong><br>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ progresso_total }}%" 
                                     aria-valuenow="{{ progresso_total }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ progresso_total }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estatísticas Resumidas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5>{{ rdo_subatividades|length }}</h5>
                            <p class="mb-0">Subatividades</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5>{{ rdo_funcionarios|length }}</h5>
                            <p class="mb-0">Funcionários</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5>{{ "%.1f"|format(horas_totais) }}h</h5>
                            <p class="mb-0">Horas Trabalhadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5>{{ rdo_equipamentos|length }}</h5>
                            <p class="mb-0">Equipamentos</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Condições Climáticas -->
            {% if rdo.clima_geral or rdo.temperatura_media or rdo.umidade_relativa %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cloud-sun me-2"></i>Condições Climáticas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if rdo.clima_geral %}
                        <div class="col-md-3">
                            <strong>Clima:</strong><br>
                            {{ rdo.clima_geral }}
                        </div>
                        {% endif %}
                        {% if rdo.temperatura_media %}
                        <div class="col-md-3">
                            <strong>Temperatura:</strong><br>
                            {{ rdo.temperatura_media }}
                        </div>
                        {% endif %}
                        {% if rdo.umidade_relativa %}
                        <div class="col-md-3">
                            <strong>Umidade:</strong><br>
                            {{ rdo.umidade_relativa }}%
                        </div>
                        {% endif %}
                        {% if rdo.vento_velocidade %}
                        <div class="col-md-3">
                            <strong>Vento:</strong><br>
                            {{ rdo.vento_velocidade }}
                        </div>
                        {% endif %}
                    </div>
                    {% if rdo.precipitacao %}
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>Precipitação:</strong> {{ rdo.precipitacao }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Subatividades Executadas -->
            {% if rdo_subatividades %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Subatividades Executadas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Subatividade</th>
                                    <th>Conclusão</th>
                                    <th>Observações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subativ in rdo_subatividades %}
                                <tr>
                                    <td>{{ subativ.nome_subatividade }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px; width: 100px;">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 style="width: {{ subativ.percentual_conclusao }}%" 
                                                 aria-valuenow="{{ subativ.percentual_conclusao }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ subativ.percentual_conclusao }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ subativ.observacoes_tecnicas or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Mão de Obra -->
            {% if rdo_funcionarios %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Mão de Obra</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Funcionário</th>
                                    <th>Código</th>
                                    <th>Função</th>
                                    <th>Horas Trabalhadas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mao_obra, funcionario in rdo_funcionarios %}
                                <tr>
                                    <td>{{ funcionario.nome }}</td>
                                    <td>{{ funcionario.codigo }}</td>
                                    <td>{{ mao_obra.funcao_exercida }}</td>
                                    <td>{{ mao_obra.horas_trabalhadas }}h</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Equipamentos -->
            {% if rdo_equipamentos %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Equipamentos Utilizados</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Equipamento</th>
                                    <th>Quantidade</th>
                                    <th>Horas de Uso</th>
                                    <th>Observações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for equipamento in rdo_equipamentos %}
                                <tr>
                                    <td>{{ equipamento.nome_equipamento }}</td>
                                    <td>{{ equipamento.quantidade }}</td>
                                    <td>{{ equipamento.horas_utilizacao }}h</td>
                                    <td>{{ equipamento.observacoes or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Ocorrências -->
            {% if rdo_ocorrencias %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Ocorrências</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Descrição</th>
                                    <th>Severidade</th>
                                    <th>Status</th>
                                    <th>Responsável</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ocorrencia in rdo_ocorrencias %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ ocorrencia.tipo_ocorrencia }}</span>
                                    </td>
                                    <td>{{ ocorrencia.descricao_completa }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if ocorrencia.severidade == 'Alta' else 'warning' if ocorrencia.severidade == 'Média' else 'info' }}">
                                            {{ ocorrencia.severidade }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if ocorrencia.status_resolucao == 'Resolvido' else 'warning' }}">
                                            {{ ocorrencia.status_resolucao }}
                                        </span>
                                    </td>
                                    <td>{{ ocorrencia.responsavel_acao or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Observações Gerais -->
            {% if rdo.comentario_geral %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-comment me-2"></i>Observações Gerais</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ rdo.comentario_geral }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Informações do Sistema -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações do Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Criado em:</strong><br>
                            {{ rdo.created_at.strftime('%d/%m/%Y às %H:%M') if rdo.created_at else '-' }}
                        </div>
                        <div class="col-md-4">
                            {% if rdo.finalizado_em %}
                            <strong>Finalizado em:</strong><br>
                            {{ rdo.finalizado_em.strftime('%d/%m/%Y às %H:%M') }}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <strong>Última atualização:</strong><br>
                            {{ rdo.updated_at.strftime('%d/%m/%Y às %H:%M') if rdo.updated_at else rdo.created_at.strftime('%d/%m/%Y às %H:%M') if rdo.created_at else '-' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function finalizarRDO(rdoId) {
    if (confirm('Tem certeza que deseja finalizar este RDO? Após finalizado não poderá mais ser editado.')) {
        fetch(`/rdo/finalizar/${rdoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao finalizar RDO');
            }
        });
    }
}
</script>

<style>
.progress {
    background-color: #e9ecef;
}

.card-header h5 {
    color: #495057;
    font-weight: 600;
}

.badge {
    font-size: 0.875em;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}