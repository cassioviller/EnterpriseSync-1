{% extends "base_completo.html" %}

{% block title %}Novo Template de Proposta{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-plus-circle text-primary me-2"></i>
                Novo Template de Proposta
            </h1>
            <p class="text-muted mb-0">Crie um template completo com todos os dados da proposta</p>
        </div>
        <div>
            <a href="{{ url_for('templates.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <form method="POST" id="templateForm">
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills nav-justified mb-4" id="templateTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basico-tab" data-bs-toggle="pill" data-bs-target="#basico" type="button" role="tab">
                    <i class="fas fa-info-circle"></i> Básico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="destinatario-tab" data-bs-toggle="pill" data-bs-target="#destinatario" type="button" role="tab">
                    <i class="fas fa-user"></i> Destinatário
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="engenheiro-tab" data-bs-toggle="pill" data-bs-target="#engenheiro" type="button" role="tab">
                    <i class="fas fa-user-tie"></i> Engenheiro
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="proposta-tab" data-bs-toggle="pill" data-bs-target="#proposta" type="button" role="tab">
                    <i class="fas fa-file-contract"></i> Proposta
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="itens-tab" data-bs-toggle="pill" data-bs-target="#itens" type="button" role="tab">
                    <i class="fas fa-list"></i> Itens
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="templateTabsContent">
            
            <!-- ABA 1: INFORMAÇÕES BÁSICAS -->
            <div class="tab-pane fade show active" id="basico" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informações Básicas</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="nome" class="form-label">Nome do Template *</label>
                                            <input type="text" class="form-control form-control-lg" id="nome" name="nome" required 
                                                   placeholder="Ex: Estrutura Metálica Residencial">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="categoria" class="form-label">Categoria *</label>
                                            <select class="form-select form-select-lg" id="categoria" name="categoria" required>
                                                <option value="">Selecione...</option>
                                                <option value="Estrutura Metálica">Estrutura Metálica</option>
                                                <option value="Mezanino">Mezanino</option>
                                                <option value="Cobertura">Cobertura</option>
                                                <option value="Galpão Industrial">Galpão Industrial</option>
                                                <option value="Cobertura Gourmet">Cobertura Gourmet</option>
                                                <option value="Reforma">Reforma</option>
                                                <option value="Outros">Outros</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="descricao" class="form-label">Descrição</label>
                                    <textarea class="form-control" id="descricao" name="descricao" rows="4"
                                              placeholder="Descrição detalhada do template e sua aplicação"></textarea>
                                </div>

                                <!-- Configurações Rápidas -->
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="prazo_entrega_dias" class="form-label">Prazo (dias)</label>
                                            <input type="number" class="form-control" id="prazo_entrega_dias" 
                                                   name="prazo_entrega_dias" value="90" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="validade_dias" class="form-label">Validade (dias)</label>
                                            <input type="number" class="form-control" id="validade_dias" 
                                                   name="validade_dias" value="7" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="percentual_nota_fiscal" class="form-label">% Nota Fiscal</label>
                                            <input type="number" class="form-control" id="percentual_nota_fiscal" 
                                                   name="percentual_nota_fiscal" value="13.5" step="0.1" min="0" max="100">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label d-block">&nbsp;</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="publico" name="publico">
                                                <label class="form-check-label" for="publico">
                                                    Template público
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Dicas</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <small>
                                        <strong>Nome:</strong> Use nomes descritivos e específicos<br>
                                        <strong>Categoria:</strong> Ajuda na organização e busca<br>
                                        <strong>Público:</strong> Permite que outros usuários usem este template
                                    </small>
                                </div>
                                
                                <div class="mt-4">
                                    <h6 class="text-muted">Template Existente</h6>
                                    <select class="form-select" id="templatePreCarregado" onchange="carregarTemplateCompleto()">
                                        <option value="">Selecione um template para pré-carregar...</option>
                                        {% for template in templates_existentes %}
                                        <option value="{{ template.id }}">{{ template.nome }} ({{ template.categoria }})</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Carregue um template existente como base</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 2: DADOS DO DESTINATÁRIO -->
            <div class="tab-pane fade" id="destinatario" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Dados do Destinatário</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="destinatario" class="form-label">À (Destinatário)</label>
                                    <input type="text" class="form-control" id="destinatario" name="destinatario" 
                                           placeholder="Ex: À Construtora ABC Ltda">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="atencao_de" class="form-label">A/c. (Atenção de)</label>
                                    <input type="text" class="form-control" id="atencao_de" name="atencao_de" 
                                           placeholder="Ex: Sr. João Silva">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telefone_cliente" class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="telefone_cliente" name="telefone_cliente" 
                                           placeholder="Ex: (12) 99999-9999">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="numero_referencia" class="form-label">N. Ref. (Número de Referência)</label>
                                    <input type="text" class="form-control" id="numero_referencia" name="numero_referencia" 
                                           placeholder="Ex: Proposta Comercial 001/2025">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="assunto" class="form-label">Ass. (Assunto)</label>
                                    <input type="text" class="form-control" id="assunto" name="assunto" 
                                           placeholder="Ex: Fabricação e montagem de estrutura metálica">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cidade_data" class="form-label">Cidade e Data</label>
                                    <input type="text" class="form-control" id="cidade_data" name="cidade_data" 
                                           value="São José dos Campos, [DATA]" 
                                           placeholder="Ex: São José dos Campos">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="texto_apresentacao" class="form-label">Texto de Apresentação</label>
                            <textarea class="form-control" id="texto_apresentacao" name="texto_apresentacao" rows="6">Prezados,

Atendendo a solicitação de V.sas., apresentamos nossas "Condições Comerciais" para o fornecimento em referência.

Na expectativa de ter atendido às condições especificadas, aproveitamos para expressar os nossos votos de estima e consideração.

Atenciosamente,

Jefferson Luiz Moreira – Gerente Estruturas do Vale</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 3: DADOS DO ENGENHEIRO -->
            <div class="tab-pane fade" id="engenheiro" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-tie"></i> Dados do Engenheiro Responsável</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="engenheiro_nome" class="form-label">Nome do Engenheiro</label>
                                    <input type="text" class="form-control" id="engenheiro_nome" name="engenheiro_nome" 
                                           value="Engº Lucas Barbosa Alves Pinto"
                                           placeholder="Ex: Engº João Silva">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="engenheiro_crea" class="form-label">CREA</label>
                                    <input type="text" class="form-control" id="engenheiro_crea" name="engenheiro_crea" 
                                           value="CREA- 5070458626-SP"
                                           placeholder="Ex: CREA-12345/SP">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="engenheiro_email" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="engenheiro_email" name="engenheiro_email" 
                                           value="contato@estruturasdovale.com.br"
                                           placeholder="Ex: engenheiro@empresa.com.br">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="engenheiro_telefone" class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="engenheiro_telefone" name="engenheiro_telefone" 
                                           value="12 99187-7435"
                                           placeholder="Ex: (12) 99999-9999">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="engenheiro_endereco" class="form-label">Endereço Completo</label>
                                    <textarea class="form-control" id="engenheiro_endereco" name="engenheiro_endereco" rows="2">Rua Benedita Nunes de Campos, 140. Residencial União, São José dos Campos - CEP 12.239-008</textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="engenheiro_website" class="form-label">Website</label>
                                    <input type="text" class="form-control" id="engenheiro_website" name="engenheiro_website" 
                                           value="www.estruturasdovale.com.br"
                                           placeholder="Ex: www.empresa.com.br">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 4: SEÇÕES DA PROPOSTA -->
            <div class="tab-pane fade" id="proposta" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <!-- Seção 1: Objeto -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-bullseye"></i> 1. OBJETO</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="secao_objeto" name="secao_objeto" rows="3">Esta proposta descreve as condições comerciais a serem atendidas para o fornecimento de mão de obra especializada para fabricação e montagem de estruturas conforme segue.</textarea>
                            </div>
                        </div>

                        <!-- Seção 3: Itens Inclusos -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-check-circle"></i> 3. ITENS INCLUSOS</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="itens_inclusos" name="itens_inclusos" rows="4" placeholder="Itens inclusos no orçamento (separados por vírgula)"></textarea>
                            </div>
                        </div>

                        <!-- Seção 5: Condições de Pagamento -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card"></i> 5. CONDIÇÕES DE PAGAMENTO</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="condicoes_pagamento" name="condicoes_pagamento" rows="5">10% de entrada na assinatura do contrato
10% após projeto aprovado
45% compra dos perfis
25% no início da montagem in loco
10% após a conclusão da montagem</textarea>
                            </div>
                        </div>

                        <!-- Seção 8: Considerações Gerais -->
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-clipboard-list"></i> 8. CONSIDERAÇÕES GERAIS</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="consideracoes_gerais" name="consideracoes_gerais" rows="6">8.1 Modificações e Cancelamentos
Qualquer alteração no escopo do projeto deverá ser previamente aprovada por escrito, podendo resultar em ajustes nos prazos e valores.

8.2 Obrigações do Contratante
O contratante deverá fornecer energia elétrica, água potável e local adequado para estoque temporário dos materiais.

8.3 Água e Energia
Por conta do contratante o fornecimento de água e energia elétrica durante o período de execução da obra.</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <!-- Seção 4: Itens Exclusos -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-times-circle"></i> 4. ITENS EXCLUSOS</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="itens_exclusos" name="itens_exclusos" rows="4" placeholder="Itens não inclusos no orçamento (separados por vírgula)"></textarea>
                            </div>
                        </div>

                        <!-- Seção 6: Condições de Entrega -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-truck"></i> 6. CONDIÇÕES DE ENTREGA</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="condicoes_entrega" name="condicoes_entrega" rows="3">Prazo de entrega de 90 dias corridos após aprovação do projeto executivo e recebimento da primeira parcela.

O prazo poderá ser alterado em função de condições climáticas adversas.</textarea>
                            </div>
                        </div>

                        <!-- Seção 7: Garantias -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-shield-alt"></i> 7. GARANTIAS</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="garantias" name="garantias" rows="3">A Estruturas do Vale garante todos os materiais empregados nos serviços contra defeitos de fabricação pelo prazo de 12 (doze) meses contados a partir da data de conclusão da obra, conforme NBR 8800.</textarea>
                            </div>
                        </div>

                        <!-- Seção 9: Validade -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt"></i> 9. VALIDADE DA PROPOSTA</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="secao_validade" name="secao_validade" rows="2">Esta proposta tem validade de 7 (sete) dias corridos a partir da data de emissão.</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 5: ITENS DO TEMPLATE -->
            <div class="tab-pane fade" id="itens" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Itens do Template</h5>
                    </div>
                    <div class="card-body">
                        <!-- Formulário para adicionar novo item -->
                        <div class="card bg-light mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-plus"></i> Adicionar Novo Item</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="mb-3">
                                            <label for="novoItemDescricao" class="form-label">Descrição *</label>
                                            <input type="text" class="form-control" id="novoItemDescricao" 
                                                   placeholder="Ex: Fabricação de estrutura metálica">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="novoItemQuantidade" class="form-label">Quantidade *</label>
                                            <input type="number" class="form-control" id="novoItemQuantidade" 
                                                   value="1" min="0.1" step="0.1">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="novoItemUnidade" class="form-label">Unidade *</label>
                                            <select class="form-select" id="novoItemUnidade">
                                                <option value="un">un</option>
                                                <option value="m²">m²</option>
                                                <option value="m³">m³</option>
                                                <option value="m">m</option>
                                                <option value="kg">kg</option>
                                                <option value="ton">ton</option>
                                                <option value="h">h</option>
                                                <option value="dia">dia</option>
                                                <option value="pç">pç</option>
                                                <option value="lote">lote</option>
                                                <option value="vb">vb</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="novoItemPreco" class="form-label">Preço Unit. *</label>
                                            <input type="number" class="form-control" id="novoItemPreco" 
                                                   min="0" step="0.01" placeholder="0,00">
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label d-block">&nbsp;</label>
                                        <button type="button" class="btn btn-success w-100" onclick="adicionarItemManual()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de itens adicionados -->
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-list-ul me-2"></i> Itens do Template (<span id="contadorItens">0</span>)</h6>
                                <span class="badge bg-white text-primary fs-6">
                                    Total: R$ <span id="totalTemplateHeader">0,00</span>
                                </span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="tabelaItens" data-datatable="false">
                                        <thead class="table-dark">
                                            <tr>
                                                <th width="50">#</th>
                                                <th>Descrição</th>
                                                <th width="80">Qtd</th>
                                                <th width="80">Unidade</th>
                                                <th width="100">Preço Unit.</th>
                                                <th width="100">Subtotal</th>
                                                <th width="80">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="corpoTabelaItens">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted py-4">
                                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                                    Nenhum item adicionado ainda
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="bg-light p-3 text-end">
                                    <h5 class="mb-0 text-primary">
                                        <i class="fas fa-calculator me-2"></i>
                                        Total Geral: R$ <span id="totalTemplate">0,00</span>
                                    </h5>
                                </div>
                            </div>
                        </div>

                        <!-- Campo oculto para JSON dos itens -->
                        <input type="hidden" id="itens_json" name="itens_json" value="[]">
                    </div>
                </div>
            </div>
        </div>

        <!-- Botões de Ação Fixos -->
        <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1000;">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> Salvar Template
                </button>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript para funcionalidades -->
<script>
// Variáveis globais
let itensTemplate = [];
let contadorItens = 0;

// Função para adicionar item manual
function adicionarItemManual() {
    const descricao = document.getElementById('novoItemDescricao').value.trim();
    const quantidade = parseFloat(document.getElementById('novoItemQuantidade').value);
    const unidade = document.getElementById('novoItemUnidade').value;
    const preco = parseFloat(document.getElementById('novoItemPreco').value);
    
    // Validações
    if (!descricao) {
        alert('Descrição é obrigatória');
        document.getElementById('novoItemDescricao').focus();
        return;
    }
    
    if (!quantidade || quantidade <= 0) {
        alert('Quantidade deve ser maior que zero');
        document.getElementById('novoItemQuantidade').focus();
        return;
    }
    
    if (!preco || preco <= 0) {
        alert('Preço deve ser maior que zero');
        document.getElementById('novoItemPreco').focus();
        return;
    }
    
    // Adicionar item
    contadorItens++;
    const novoItem = {
        ordem: contadorItens,
        descricao: descricao,
        quantidade: quantidade,
        unidade: unidade,
        preco_unitario: preco,
        subtotal: quantidade * preco
    };
    
    itensTemplate.push(novoItem);
    
    // Limpar formulário
    document.getElementById('novoItemDescricao').value = '';
    document.getElementById('novoItemQuantidade').value = '1';
    document.getElementById('novoItemUnidade').value = 'un';
    document.getElementById('novoItemPreco').value = '';
    
    // Atualizar interface
    atualizarTabelaItens();
    atualizarTotal();
    atualizarJsonItens();
    atualizarContadorItens();
    
    // Focar no campo descrição para próximo item
    document.getElementById('novoItemDescricao').focus();
}

// Função para adicionar serviço ao template (manter para compatibilidade)
function adicionarServicoAoTemplate(id, nome, unidade, preco) {
    contadorItens++;
    const novoItem = {
        ordem: contadorItens,
        descricao: nome,
        quantidade: 1,
        unidade: unidade,
        preco_unitario: preco,
        subtotal: preco
    };
    
    itensTemplate.push(novoItem);
    atualizarTabelaItens();
    atualizarTotal();
    atualizarJsonItens();
    atualizarContadorItens();
}

// Função para atualizar a tabela de itens
function atualizarTabelaItens() {
    const tbody = document.getElementById('corpoTabelaItens');
    
    if (itensTemplate.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                    Nenhum item adicionado ainda
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    itensTemplate.forEach((item, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td class="fw-bold">${item.ordem}</td>
            <td class="text-break">${item.descricao}</td>
            <td><input type="number" class="form-control form-control-sm" value="${item.quantidade}" min="0.1" step="0.1" onchange="atualizarQuantidade(${index}, this.value)"></td>
            <td class="text-center">${item.unidade}</td>
            <td class="text-end">R$ ${item.preco_unitario.toFixed(2)}</td>
            <td class="text-end fw-bold">R$ ${item.subtotal.toFixed(2)}</td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerItem(${index})" title="Remover item">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
}

// Função para atualizar quantidade
function atualizarQuantidade(index, novaQtd) {
    itensTemplate[index].quantidade = parseFloat(novaQtd);
    itensTemplate[index].subtotal = itensTemplate[index].quantidade * itensTemplate[index].preco_unitario;
    atualizarTabelaItens();
    atualizarTotal();
    atualizarJsonItens();
}

// Função para remover item
function removerItem(index) {
    itensTemplate.splice(index, 1);
    atualizarTabelaItens();
    atualizarTotal();
    atualizarJsonItens();
    atualizarContadorItens();
}

// Função para atualizar contador de itens
function atualizarContadorItens() {
    document.getElementById('contadorItens').textContent = itensTemplate.length;
}

// Função para atualizar total
function atualizarTotal() {
    const total = itensTemplate.reduce((sum, item) => sum + item.subtotal, 0);
    const totalFormatado = total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('totalTemplate').textContent = totalFormatado;
    document.getElementById('totalTemplateHeader').textContent = totalFormatado;
}

// Função para atualizar JSON dos itens
function atualizarJsonItens() {
    document.getElementById('itens_json').value = JSON.stringify(itensTemplate);
}

// Função para carregar template existente
function carregarTemplateCompleto() {
    const select = document.getElementById('templatePreCarregado');
    const templateId = select.value;
    
    if (!templateId) return;
    
    fetch(`/propostas/api/template/${templateId}`)
        .then(response => response.json())
        .then(data => {
            // Preencher campos básicos
            document.getElementById('nome').value = data.nome + ' (Cópia)';
            document.getElementById('categoria').value = data.categoria;
            document.getElementById('prazo_entrega_dias').value = data.prazo_entrega_dias || 90;
            document.getElementById('validade_dias').value = data.validade_dias || 7;
            document.getElementById('percentual_nota_fiscal').value = data.percentual_nota_fiscal || 13.5;
            
            // Preencher seções da proposta
            if (data.condicoes_pagamento) document.getElementById('condicoes_pagamento').value = data.condicoes_pagamento;
            if (data.garantias) document.getElementById('garantias').value = data.garantias;
            if (data.itens_inclusos) document.getElementById('itens_inclusos').value = data.itens_inclusos;
            if (data.itens_exclusos) document.getElementById('itens_exclusos').value = data.itens_exclusos;
            
            // Carregar itens se existirem
            if (data.itens_padrao && data.itens_padrao.length > 0) {
                itensTemplate = data.itens_padrao.map((item, index) => ({
                    ordem: index + 1,
                    descricao: item.descricao,
                    quantidade: item.quantidade,
                    unidade: item.unidade,
                    preco_unitario: item.preco_unitario || item.valor_unitario,
                    subtotal: item.subtotal || (item.quantidade * (item.preco_unitario || item.valor_unitario))
                }));
                contadorItens = itensTemplate.length;
                atualizarTabelaItens();
                atualizarTotal();
                atualizarJsonItens();
            }
            
            // Ir para a aba de itens
            const itensTab = new bootstrap.Tab(document.getElementById('itens-tab'));
            itensTab.show();
        })
        .catch(error => {
            console.error('Erro ao carregar template:', error);
            alert('Erro ao carregar template');
        });
}

// Validação do formulário
document.getElementById('templateForm').addEventListener('submit', function(e) {
    const nome = document.getElementById('nome').value.trim();
    const categoria = document.getElementById('categoria').value;
    
    if (!nome) {
        e.preventDefault();
        alert('Nome do template é obrigatório');
        document.getElementById('basico-tab').click();
        document.getElementById('nome').focus();
        return;
    }
    
    if (!categoria) {
        e.preventDefault();
        alert('Categoria é obrigatória');
        document.getElementById('basico-tab').click();
        document.getElementById('categoria').focus();
        return;
    }
});

// Suporte ao Enter nos campos de item
document.addEventListener('DOMContentLoaded', function() {
    const camposItem = ['novoItemDescricao', 'novoItemQuantidade', 'novoItemUnidade', 'novoItemPreco'];
    
    camposItem.forEach(function(campoId) {
        const campo = document.getElementById(campoId);
        if (campo) {
            campo.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    adicionarItemManual();
                }
            });
        }
    });
    
    // Foco inicial no nome do template
    const nomeField = document.getElementById('nome');
    if (nomeField) {
        nomeField.focus();
    }
});

// Busca de serviços (removido - não é mais necessário)
function buscarServicos() {
    // Função mantida para compatibilidade
}
</script>

<style>
.nav-pills .nav-link {
    border-radius: 8px;
    margin-right: 8px;
    font-weight: 600;
    color: #495057;
    background-color: #e9ecef;
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
    padding: 12px 20px;
}

.nav-pills .nav-link:hover {
    background-color: #dee2e6;
    border-color: #0d6efd;
    color: #0d6efd;
    transform: translateY(-2px);
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

.nav-pills .nav-link i {
    margin-right: 8px;
}

.card-header h5, .card-header h6 {
    font-weight: 600;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.position-fixed {
    bottom: 20px !important;
    right: 20px !important;
}

.table-sm th, .table-sm td {
    padding: 0.5rem 0.25rem;
}

.text-break {
    word-break: break-word;
}
</style>
{% endblock %}