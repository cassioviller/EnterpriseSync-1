{% extends "base.html" %}

{% block title %}Templates de Propostas{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-list text-primary me-2"></i>
                Templates de Propostas
            </h1>
            <p class="text-muted mb-0">{{ templates.total }} templates encontrados</p>
        </div>
        <div>
            <a href="{{ url_for('templates.novo_template') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Novo Template
            </a>
            <a href="{{ url_for('templates.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-dashboard"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="busca" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="busca" name="busca" 
                           value="{{ busca }}" placeholder="Nome ou descrição...">
                </div>
                <div class="col-md-3">
                    <label for="categoria" class="form-label">Categoria</label>
                    <select class="form-select" id="categoria" name="categoria">
                        <option value="">Todas</option>
                        {% for cat in categorias %}
                        <option value="{{ cat }}" {% if cat == categoria_filtro %}selected{% endif %}>
                            {{ cat }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Todos</option>
                        <option value="ativo" {% if status == 'ativo' %}selected{% endif %}>Ativos</option>
                        <option value="inativo" {% if status == 'inativo' %}selected{% endif %}>Inativos</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Templates -->
    {% if templates.items %}
    <div class="row">
        {% for template in templates.items %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 {{ 'border-success' if template.ativo else 'border-secondary' }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="badge {{ 'bg-success' if template.ativo else 'bg-secondary' }}">
                        {{ 'Ativo' if template.ativo else 'Inativo' }}
                    </span>
                    <span class="badge bg-primary">{{ template.categoria }}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ template.nome }}</h5>
                    {% if template.descricao %}
                    <p class="card-text text-muted">
                        {{ template.descricao[:100] }}{% if template.descricao|length > 100 %}...{% endif %}
                    </p>
                    {% endif %}
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="border rounded py-2">
                                <h6 class="mb-0">{{ template.itens_padrao|length if template.itens_padrao else 0 }}</h6>
                                <small class="text-muted">Itens</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded py-2">
                                <h6 class="mb-0">{{ template.uso_contador }}</h6>
                                <small class="text-muted">Usos</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded py-2">
                                <h6 class="mb-0">{{ template.prazo_entrega_dias }}</h6>
                                <small class="text-muted">Dias</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Criado em {{ template.criado_em.strftime('%d/%m/%Y') }}
                        </small>
                        {% if template.publico %}
                        <i class="fas fa-globe text-info" title="Template público"></i>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                        <a href="{{ url_for('templates.ver_template', id=template.id) }}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                        <a href="{{ url_for('templates.editar_template', id=template.id) }}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info btn-sm dropdown-toggle" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <form method="POST" action="{{ url_for('templates.duplicar_template', id=template.id) }}" 
                                          style="display: inline;">
                                        <button type="submit" class="dropdown-item">
                                            <i class="fas fa-copy text-success"></i> Duplicar
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form method="POST" action="{{ url_for('templates.toggle_status', id=template.id) }}" 
                                          style="display: inline;">
                                        <button type="submit" class="dropdown-item">
                                            {% if template.ativo %}
                                            <i class="fas fa-pause text-warning"></i> Desativar
                                            {% else %}
                                            <i class="fas fa-play text-success"></i> Ativar
                                            {% endif %}
                                        </button>
                                    </form>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    {% if template.uso_contador == 0 %}
                                    <form method="POST" action="{{ url_for('templates.deletar_template', id=template.id) }}" 
                                          style="display: inline;"
                                          onsubmit="return confirm('Tem certeza que deseja deletar este template?')">
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="fas fa-trash"></i> Deletar
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="dropdown-item text-muted">
                                        <i class="fas fa-info-circle"></i> Não é possível deletar (já foi usado)
                                    </span>
                                    {% endif %}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Paginação -->
    {% if templates.pages > 1 %}
    <nav aria-label="Navegação de templates">
        <ul class="pagination justify-content-center">
            {% if templates.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('templates.listar_templates', 
                    page=templates.prev_num, busca=busca, categoria=categoria_filtro, status=status) }}">
                    Anterior
                </a>
            </li>
            {% endif %}
            
            {% for page_num in templates.iter_pages() %}
                {% if page_num %}
                    {% if page_num != templates.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('templates.listar_templates', 
                            page=page_num, busca=busca, categoria=categoria_filtro, status=status) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if templates.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('templates.listar_templates', 
                    page=templates.next_num, busca=busca, categoria=categoria_filtro, status=status) }}">
                    Próximo
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Sem templates -->
    <div class="text-center py-5">
        <i class="fas fa-file-contract fa-5x text-muted mb-4"></i>
        <h4>Nenhum template encontrado</h4>
        {% if busca or categoria_filtro or status %}
        <p class="text-muted mb-4">Tente ajustar os filtros ou criar um novo template</p>
        <a href="{{ url_for('templates.listar_templates') }}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-times"></i> Limpar Filtros
        </a>
        {% else %}
        <p class="text-muted mb-4">Crie seu primeiro template para começar</p>
        {% endif %}
        <a href="{{ url_for('templates.novo_template') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Criar Primeiro Template
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}