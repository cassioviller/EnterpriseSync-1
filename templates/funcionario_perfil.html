{% extends "base.html" %}

{% block title %}{{ funcionario.nome }} - Perfil - SIGE{% endblock %}

{% block content %}
<!-- Cabeçalho -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-user"></i> {{ funcionario.nome }}
            </h1>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editarFuncionarioModal">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <a href="{{ url_for('main.funcionarios') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Dados Cadastrais Básicos -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                {% if funcionario.foto %}
                    <img src="{{ url_for('static', filename=funcionario.foto) }}" 
                         class="rounded-circle mb-3" 
                         width="120" 
                         height="120" 
                         style="object-fit: cover;"
                         alt="Foto de {{ funcionario.nome }}"
                         onerror="this.src='{{ url_for('static', filename='images/default-avatar.svg') }}'">
                {% else %}
                    <img src="{{ url_for('static', filename='images/default-avatar.svg') }}" 
                         class="rounded-circle mb-3" 
                         width="120" 
                         height="120" 
                         style="object-fit: cover;"
                         alt="Avatar padrão">
                {% endif %}
                <h5 class="card-title mb-1">{{ funcionario.nome }}</h5>
                <p class="text-muted mb-2">{{ funcionario.funcao_ref.nome if funcionario.funcao_ref else 'Sem função' }}</p>
                {% if funcionario.ativo %}
                    <span class="badge bg-success">Ativo</span>
                {% else %}
                    <span class="badge bg-secondary">Inativo</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Dados Cadastrais
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold">CPF:</td>
                                <td>{{ funcionario.cpf }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">RG:</td>
                                <td>{{ funcionario.rg or '-' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Data de Nascimento:</td>
                                <td>{{ funcionario.data_nascimento.strftime('%d/%m/%Y') if funcionario.data_nascimento else '-' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Telefone:</td>
                                <td>{{ funcionario.telefone or '-' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Email:</td>
                                <td>{{ funcionario.email or '-' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold">Data de Admissão:</td>
                                <td>{{ funcionario.data_admissao.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Salário:</td>
                                <td>R$ {{ '{:,.2f}'.format(funcionario.salario) }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Departamento:</td>
                                <td>{{ funcionario.departamento_ref.nome if funcionario.departamento_ref else '-' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Função:</td>
                                <td>{{ funcionario.funcao_ref.nome if funcionario.funcao_ref else '-' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Horário de Trabalho:</td>
                                <td>{{ funcionario.horario_trabalho.nome if funcionario.horario_trabalho else '-' }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Endereço:</td>
                                <td>{{ funcionario.endereco or '-' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPIs Individuais -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> Indicadores de Desempenho
                </h5>
            </div>
            <div class="card-body">
                <!-- Filtros de Período -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <div class="d-flex gap-2">
                                <input type="date" id="dataInicio" class="form-control form-control-sm" style="width: 140px;" value="{{ data_inicio.strftime('%Y-%m-%d') if data_inicio else '' }}">
                                <input type="date" id="dataFim" class="form-control form-control-sm" style="width: 140px;" value="{{ data_fim.strftime('%Y-%m-%d') if data_fim else '' }}">
                                <button onclick="aplicarFiltros()" class="btn btn-primary btn-sm">
                                    <i class="fas fa-filter"></i> Aplicar
                                </button>
                            </div>
                            <div class="d-flex gap-1">
                                <button onclick="filtroRapido('ultimos_7_dias')" class="btn btn-outline-secondary btn-sm">7 dias</button>
                                <button onclick="filtroRapido('ultimos_30_dias')" class="btn btn-outline-secondary btn-sm">30 dias</button>
                                <button onclick="filtroRapido('ultimo_mes')" class="btn btn-outline-secondary btn-sm">Último mês</button>
                                <button onclick="filtroRapido('ultimo_trimestre')" class="btn btn-outline-secondary btn-sm">Trimestre</button>
                                <button onclick="filtroRapido('ultimo_semestre')" class="btn btn-outline-secondary btn-sm">Semestre</button>
                                <button onclick="filtroRapido('ultimo_ano')" class="btn btn-outline-secondary btn-sm">Ano</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Grid 4-4-4-3 de KPIs v4.0 -->
                <!-- Linha 1: KPIs Básicos -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-primary mb-1">{{ '{:.1f}h'.format(kpis.horas_trabalhadas) }}</h4>
                            <small class="text-muted">Horas Trabalhadas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-warning mb-1">{{ '{:.1f}h'.format(kpis.horas_extras) }}</h4>
                            <small class="text-muted">Horas Extras</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-danger mb-1">{{ kpis.faltas }}</h4>
                            <small class="text-muted">Faltas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-info mb-1">{{ '{:.2f}h'.format(kpis.atrasos_horas) }}</h4>
                            <small class="text-muted">Atrasos</small>
                        </div>
                    </div>
                </div>
                
                <!-- Linha 2: KPIs Analíticos -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-success mb-1">{{ '{:.1f}%'.format(kpis.produtividade) if kpis.produtividade is defined else '0.0%' }}</h4>
                            <small class="text-muted">Produtividade</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-secondary mb-1">{{ '{:.1f}%'.format(kpis.absenteismo) }}</h4>
                            <small class="text-muted">Absenteísmo</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-info mb-1">{{ '{:.1f}h'.format(kpis.media_diaria) }}</h4>
                            <small class="text-muted">Média Diária</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-primary mb-1">{{ kpis.faltas_justificadas if kpis.faltas_justificadas is defined else 0 }}</h4>
                            <small class="text-muted">Faltas Justificadas</small>
                        </div>
                    </div>
                </div>

                <!-- Linha 3: KPIs Financeiros -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-success mb-1">R$ {{ '{:,.2f}'.format(kpis.custo_mao_obra) if kpis.custo_mao_obra is defined else '0,00' }}</h4>
                            <small class="text-muted">Custo Mão de Obra</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-primary mb-1">R$ {{ '{:,.2f}'.format(kpis.custo_alimentacao) if kpis.custo_alimentacao is defined else '0,00' }}</h4>
                            <small class="text-muted">Custo Alimentação</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-warning mb-1">R$ {{ '{:,.2f}'.format(kpis.custo_transporte) if kpis.custo_transporte is defined else '0,00' }}</h4>
                            <small class="text-muted">Custo Transporte</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-info mb-1">R$ {{ '{:,.2f}'.format(kpis.outros_custos if kpis.outros_custos is defined else 0) }}</h4>
                            <small class="text-muted">Outros Custos</small>
                        </div>
                    </div>
                </div>
                
                <!-- Linha 4: KPIs Resumo (4 indicadores) -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-danger mb-1">{{ '{:.1f}h'.format(kpis.horas_perdidas) if kpis.horas_perdidas is defined else '0.0h' }}</h4>
                            <small class="text-muted">Horas Perdidas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-secondary mb-1">{{ '{:.1f}%'.format(kpis.eficiencia) if kpis.eficiencia is defined else '0.0%' }}</h4>
                            <small class="text-muted">Eficiência</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h4 class="text-success mb-1">R$ {{ '{:,.2f}'.format(kpis.valor_falta_justificada) if kpis.valor_falta_justificada is defined else '0,00' }}</h4>
                            <small class="text-muted">Valor Falta Justificada</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-gradient-primary text-white">
                            <h4 class="mb-1 fw-bold">R$ {{ '{:,.2f}'.format(kpis.custo_total) if kpis.custo_total is defined else '0,00' }}</h4>
                            <small class="text-light">Custo Total</small>
                        </div>
                    </div>
                </div>
                
                <!-- Informações do Horário de Trabalho -->
                {% if kpis.horario_info %}
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Horário:</strong> {{ kpis.horario_info.nome }}<br>
                            <strong>Período:</strong> {{ kpis.periodo }}
                        </div>
                        <div class="col-md-6">
                            <strong>Jornada:</strong> {{ kpis.horario_info.horas_diarias }}h/dia<br>
                            <strong>Valor/hora:</strong> R$ {{ '{:.2f}'.format(kpis.horario_info.valor_hora) }}
                        </div>
                    </div>
                </div>
                {% endif %}
                

                

            </div>
        </div>
    </div>
</div>

<!-- Controle de Ponto -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock"></i> Controle de Ponto
                </h5>
                <button class="btn btn-primary btn-sm" id="btnNovoRegistro" onclick="abrirModalNovoPonto()">
                    <i class="fas fa-plus"></i> Novo Registro
                </button>
            </div>
            <div class="card-body">
                <!-- Legenda Visual para Tipos de Lançamento -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info p-2">
                            <strong>Legenda:</strong>
                            <span class="badge bg-success ms-2"><i class="fas fa-calendar-week"></i> SÁBADO</span>
                            <span class="badge bg-warning ms-2"><i class="fas fa-sun"></i> DOMINGO</span>
                            <span class="badge bg-info ms-2"><i class="fas fa-star"></i> FERIADO TRAB.</span>
                            <span class="badge bg-secondary ms-2"><i class="fas fa-home"></i> FERIADO NORMAL</span>
                            <span class="badge bg-primary ms-2"><i class="fas fa-check"></i> JUSTIFICADA</span>
                            <span class="badge bg-danger ms-2"><i class="fas fa-times"></i> FALTA</span>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Período -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <small>
                                <strong>Resumo do período:</strong>
                                {{ registros_ponto|length }} registros encontrados |
                                Horas Extras: {{ '{:.1f}h'.format(registros_ponto|sum(attribute='horas_extras') or 0) }} |
                                Horas Trabalhadas: {{ '{:.1f}h'.format(registros_ponto|sum(attribute='horas_trabalhadas') or 0) }}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Registros -->
                <div class="table-responsive">
                    <table class="table table-striped" id="pontoTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Entrada</th>
                                <th>Saída Almoço</th>
                                <th>Retorno Almoço</th>
                                <th>Saída</th>
                                <th>H. Trabalhadas</th>
                                <th>H. Extras</th>
                                <th>Atraso</th>
                                <th>Obra</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros_ponto %}
                            <tr {% if registro.is_falta %}style="background-color: #3d2a2a;"{% elif registro.is_feriado %}style="background-color: #2a2a3d;"{% elif registro.tipo_registro == 'sabado_horas_extras' %}style="background-color: #2a3d2a;"{% elif registro.tipo_registro == 'domingo_horas_extras' %}style="background-color: #3d2a3d;"{% endif %}>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span>{{ registro.data.strftime('%d/%m/%Y') }}</span>
                                        {% if registro.tipo_registro == 'sabado_horas_extras' %}
                                            <span class="badge bg-success ms-2"><i class="fas fa-calendar-week"></i> SÁBADO</span>
                                        {% elif registro.tipo_registro == 'domingo_horas_extras' %}
                                            <span class="badge bg-warning ms-2"><i class="fas fa-sun"></i> DOMINGO</span>
                                        {% elif registro.tipo_registro == 'sabado_nao_trabalhado' %}
                                            <span class="badge bg-secondary ms-2"><i class="fas fa-calendar-times"></i> SÁB. FOLGA</span>
                                        {% elif registro.tipo_registro == 'domingo_nao_trabalhado' %}
                                            <span class="badge bg-light text-dark ms-2"><i class="fas fa-home"></i> DOM. FOLGA</span>
                                        {% elif registro.tipo_registro == 'feriado_trabalhado' %}
                                            <span class="badge bg-info ms-2"><i class="fas fa-star"></i> FERIADO TRAB.</span>
                                        {% elif registro.tipo_registro == 'feriado' %}
                                            <span class="badge bg-secondary ms-2"><i class="fas fa-home"></i> FERIADO</span>
                                        {% elif registro.tipo_registro == 'falta_justificada' %}
                                            <span class="badge bg-primary ms-2"><i class="fas fa-check"></i> JUSTIFICADA</span>
                                        {% elif registro.tipo_registro == 'falta' %}
                                            <span class="badge bg-danger ms-2"><i class="fas fa-times"></i> FALTA</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta_justificada' %}
                                        <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                    {% elif registro.tipo_registro == 'falta' %}
                                        <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                    {% elif registro.hora_entrada %}
                                        <span class="badge bg-info">{{ registro.hora_entrada.strftime('%H:%M') }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta_justificada' %}
                                        <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                    {% elif registro.tipo_registro == 'falta' %}
                                        <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                    {% elif registro.hora_almoco_saida %}
                                        <span class="badge bg-warning">{{ registro.hora_almoco_saida.strftime('%H:%M') }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta_justificada' %}
                                        <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                    {% elif registro.tipo_registro == 'falta' %}
                                        <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                    {% elif registro.hora_almoco_retorno %}
                                        <span class="badge bg-info">{{ registro.hora_almoco_retorno.strftime('%H:%M') }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta_justificada' %}
                                        <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                    {% elif registro.tipo_registro == 'falta' %}
                                        <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                    {% elif registro.hora_saida %}
                                        <span class="badge bg-danger">{{ registro.hora_saida.strftime('%H:%M') }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta_justificada' %}
                                        <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                    {% elif registro.tipo_registro == 'falta' %}
                                        <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                    {% elif registro.horas_trabalhadas %}
                                        <span class="fw-bold text-primary">{{ '{:.2f}h'.format(registro.horas_trabalhadas) }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta' or registro.tipo_registro == 'falta_justificada' %}
                                        {% if registro.tipo_registro == 'falta_justificada' %}
                                            <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                        {% else %}
                                            <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                        {% endif %}
                                    {% elif registro.horas_extras and registro.horas_extras > 0 %}
                                        {% if registro.percentual_extras %}
                                            <span class="badge bg-warning">{{ '{:.1f}h - {:.0f}%'.format(registro.horas_extras, registro.percentual_extras) }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ '{:.1f}h'.format(registro.horas_extras) }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.tipo_registro == 'feriado' %}
                                        <span class="fw-bold" style="color: #6c757d;">Feriado</span>
                                    {% elif registro.tipo_registro == 'falta_justificada' %}
                                        <span class="fw-bold" style="color: #28a745;">Falta Justificada</span>
                                    {% elif registro.tipo_registro == 'falta' %}
                                        <span class="fw-bold" style="color: #dc3545;">Falta</span>
                                    {% elif registro.total_atraso_minutos and registro.total_atraso_minutos > 0 %}
                                        <span class="badge bg-danger">{{ '{:.0f}min'.format(registro.total_atraso_minutos) }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.obra_ref %}
                                        <span class="badge bg-secondary">{{ registro.obra_ref.nome }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="editarPonto({{ registro.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="excluirPonto({{ registro.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Ocorrências removida conforme solicitado -->

<!-- Outros Custos -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-money-bill-wave"></i> Outros Custos
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#outroCustoModal">
                    <i class="fas fa-plus"></i> Novo Registro
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="outrosCustosTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Categoria</th>
                                <th>Valor</th>

                                <th>Descrição</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for custo in outros_custos %}
                            <tr>
                                <td>{{ custo.data.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <span class="badge {% if custo.categoria == 'adicional' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ custo.tipo }}
                                    </span>
                                </td>
                                <td>
                                    {% if custo.categoria == 'adicional' %}
                                        <span class="text-success fw-bold">Adicional</span>
                                    {% else %}
                                        <span class="text-danger fw-bold">Desconto</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if custo.categoria == 'adicional' %}
                                        <span class="text-success">+R$ {{ '{:,.2f}'.format(custo.valor) }}</span>
                                    {% else %}
                                        <span class="text-danger">-R$ {{ '{:,.2f}'.format(custo.valor) }}</span>
                                    {% endif %}
                                </td>

                                <td>{{ custo.descricao or '-' }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="editarOutroCusto({{ custo.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="excluirOutroCusto({{ custo.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Alimentação -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-utensils"></i> Histórico de Alimentação
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#alimentacaoModal">
                    <i class="fas fa-plus"></i> Novo Registro
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="alimentacaoTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Obra</th>
                                <th>Restaurante</th>
                                <th>Observações</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros_alimentacao %}
                            <tr>
                                <td>{{ registro.data.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% if registro.tipo == 'cafe' %}
                                        <span class="badge bg-warning">Café da Manhã</span>
                                    {% elif registro.tipo == 'almoco' %}
                                        <span class="badge bg-primary">Almoço</span>
                                    {% elif registro.tipo == 'jantar' %}
                                        <span class="badge bg-dark">Jantar</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ registro.tipo.title() }}</span>
                                    {% endif %}
                                </td>
                                <td>R$ {{ '{:,.2f}'.format(registro.valor) }}</td>
                                <td>
                                    {% if registro.obra_ref %}
                                        <span class="badge bg-secondary">{{ registro.obra_ref.nome }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.restaurante_ref %}
                                        <span class="badge bg-success">{{ registro.restaurante_ref.nome }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.observacoes %}
                                        <div class="d-flex align-items-center">
                                            {% if registro.tipo_registro == 'sabado_horas_extras' %}
                                                <i class="fas fa-calendar-week text-success me-2"></i>
                                            {% elif registro.tipo_registro == 'domingo_horas_extras' %}
                                                <i class="fas fa-sun text-warning me-2"></i>
                                            {% elif registro.tipo_registro == 'feriado_trabalhado' %}
                                                <i class="fas fa-star text-info me-2"></i>
                                            {% elif registro.tipo_registro == 'feriado' %}
                                                <i class="fas fa-home text-secondary me-2"></i>
                                            {% elif registro.tipo_registro == 'falta_justificada' %}
                                                <i class="fas fa-check text-primary me-2"></i>
                                            {% elif registro.tipo_registro == 'falta' %}
                                                <i class="fas fa-times text-danger me-2"></i>
                                            {% else %}
                                                <i class="fas fa-briefcase text-muted me-2"></i>
                                            {% endif %}
                                            <span>{{ registro.observacoes[:30] + '...' if registro.observacoes|length > 30 else registro.observacoes }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="editarAlimentacao({{ registro.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="excluirAlimentacao({{ registro.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos de Desempenho -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> Evolução de Horas Trabalhadas
                </h5>
            </div>
            <div class="card-body">
                <canvas id="horasTrabalhadasChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Absenteísmo Mensal
                </h5>
            </div>
            <div class="card-body">
                <canvas id="absenteismoChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registro de Ponto -->
<div class="modal fade" id="pontoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pontoModalLabel">Novo Registro de Ponto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="pontoForm" action="{{ url_for('main.novo_ponto') }}" onsubmit="return submeterFormularioPonto(event)">
                <div class="modal-body">
                    <input type="hidden" id="funcionario_id" name="funcionario_id" value="{{ funcionario.id }}">
                    
                    <!-- Tipo de Lançamento -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-clipboard-list"></i> Tipo de Lançamento</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <select class="form-select form-select-lg" id="tipo_lancamento" name="tipo_lancamento" required onchange="alterarTipoLancamento()">
                                                <option value="">Selecione o tipo de lançamento...</option>
                                                <option value="trabalhado">Trabalho Normal</option>
                                                <option value="falta">Falta</option>
                                                <option value="falta_justificada">Falta Justificada</option>
                                                <option value="feriado">Feriado Normal</option>
                                                <option value="feriado_trabalhado">Feriado Trabalhado</option>
                                                <option value="sabado_horas_extras">Sábado - Horas Extras</option>
                                                <option value="domingo_horas_extras">Domingo - Horas Extras</option>
                                                <option value="meio_periodo">Meio Período</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="button" class="btn btn-success w-100" id="btnHorarioPadrao" onclick="preencherHorarioPadrao()" style="display: none;">
                                                <i class="fas fa-clock"></i> Horário Padrão
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Alertas informativos baseados no tipo -->
                                    <div id="alertaTipoLancamento" class="mt-3" style="display: none;">
                                        <div id="alertaTrabalhado" class="alert alert-info" style="display: none;">
                                            <i class="fas fa-info-circle"></i> <strong>Trabalhado:</strong> Registre os horários normais de trabalho. Configure o percentual para horas extras (se houver).
                                        </div>
                                        <div id="alertaFeriado" class="alert alert-secondary" style="display: none;">
                                            <i class="fas fa-calendar"></i> <strong>Feriado Normal:</strong> Marcação de feriado nacional/local não trabalhado. Não é necessário informar horários.
                                        </div>
                                        <div id="alertaFeriadoTrabalhado" class="alert alert-warning" style="display: none;">
                                            <i class="fas fa-exclamation-triangle"></i> <strong>Feriado Trabalhado:</strong> Trabalho em feriado recebe <strong>100% de adicional</strong> sobre as horas normais.
                                        </div>
                                        <div id="alertaFalta" class="alert alert-danger" style="display: none;">
                                            <i class="fas fa-times-circle"></i> <strong>Falta:</strong> Ausência não justificada. Impacta negativamente os KPIs de assiduidade.
                                        </div>
                                        <div id="alertaFaltaJustificada" class="alert alert-success" style="display: none;">
                                            <i class="fas fa-check-circle"></i> <strong>Falta Justificada:</strong> Ausência com justificativa. Uma ocorrência será criada automaticamente.
                                        </div>
                                        <div id="alertaSabadoHorasExtras" class="alert alert-primary" style="display: none;">
                                            <i class="fas fa-calendar-week"></i> <strong>Sábado Horas Extras:</strong> Trabalho em sábado. Configure o percentual extra (normalmente 50-60%) no cadastro.
                                        </div>
                                        <div id="alertaDomingoHorasExtras" class="alert alert-warning" style="display: none;">
                                            <i class="fas fa-calendar-alt"></i> <strong>Domingo Horas Extras:</strong> Trabalho em domingo recebe <strong>100% de adicional</strong> sobre as horas normais.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_ponto" class="form-label">Data *</label>
                                <input type="date" class="form-control" id="data_ponto" name="data" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="obra_id_ponto" class="form-label">Obra</label>
                                <select class="form-select" id="obra_id_ponto" name="obra_id">
                                    <option value="">Selecione...</option>
                                    {% for obra in obras %}
                                    <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos de Horário - Visibilidade controlada por JavaScript -->
                    <div id="campos_horario">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hora_entrada_ponto" class="form-label">Hora de Entrada</label>
                                    <div class="input-group">
                                        <input type="time" class="form-control" id="hora_entrada_ponto" name="hora_entrada">
                                        <button type="button" class="btn btn-outline-secondary" onclick="preencherHorarioAtual('hora_entrada_ponto')">
                                            <i class="fas fa-clock"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hora_saida_ponto" class="form-label">Hora de Saída</label>
                                    <div class="input-group">
                                        <input type="time" class="form-control" id="hora_saida_ponto" name="hora_saida">
                                        <button type="button" class="btn btn-outline-secondary" onclick="preencherHorarioAtual('hora_saida_ponto')">
                                            <i class="fas fa-clock"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hora_almoco_saida_ponto" class="form-label">Saída para Almoço</label>
                                    <div class="input-group">
                                        <input type="time" class="form-control" id="hora_almoco_saida_ponto" name="hora_almoco_saida">
                                        <button type="button" class="btn btn-outline-secondary" onclick="preencherHorarioAtual('hora_almoco_saida_ponto')">
                                            <i class="fas fa-clock"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hora_almoco_retorno_ponto" class="form-label">Retorno do Almoço</label>
                                    <div class="input-group">
                                        <input type="time" class="form-control" id="hora_almoco_retorno_ponto" name="hora_almoco_retorno">
                                        <button type="button" class="btn btn-outline-secondary" onclick="preencherHorarioAtual('hora_almoco_retorno_ponto')">
                                            <i class="fas fa-clock"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Percentual de Horas Extras (para tipos que precisam) -->
                    <div class="mb-3" id="campo_percentual_extras" style="display: none;">
                        <label for="percentual_extras" class="form-label">Percentual de Horas Extras (%)</label>
                        <input type="number" class="form-control" id="percentual_extras" name="percentual_extras" min="0" max="200" step="1" placeholder="Ex: 50, 60, 100">
                        <div class="form-text">
                            <small>Informe o percentual adicional sobre as horas normais (50-60% para sábado, 100% para domingo/feriado)</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ocorrência -->
<div class="modal fade" id="ocorrenciaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ocorrenciaModalLabel">Nova Ocorrência</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="ocorrenciaForm" action="{{ url_for('main.nova_ocorrencia', funcionario_id=funcionario.id) }}">
                <div class="modal-body">
                    <input type="hidden" name="funcionario_id" value="{{ funcionario.id }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_ocorrencia" class="form-label">Tipo de Ocorrência *</label>
                                <select class="form-select" id="tipo_ocorrencia" name="tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="Atestado Médico">Atestado Médico</option>
                                    <option value="Licença">Licença</option>
                                    <option value="Atraso Justificado">Atraso Justificado</option>
                                    <option value="Falta Justificada">Falta Justificada</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status_ocorrencia" class="form-label">Status</label>
                                <select class="form-select" id="status_ocorrencia" name="status">
                                    <option value="Pendente">Pendente</option>
                                    <option value="Aprovada">Aprovada</option>
                                    <option value="Rejeitada">Rejeitada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_inicio_ocorrencia" class="form-label">Data Início *</label>
                                <input type="date" class="form-control" id="data_inicio_ocorrencia" name="data_inicio" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_fim_ocorrencia" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="data_fim_ocorrencia" name="data_fim">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao_ocorrencia" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao_ocorrencia" name="descricao" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Alimentação -->
<div class="modal fade" id="alimentacaoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alimentacaoModalLabel">Novo Registro de Alimentação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="alimentacaoForm" action="{{ url_for('main.nova_alimentacao') }}">
                <div class="modal-body">
                    <input type="hidden" name="funcionario_id" value="{{ funcionario.id }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_alimentacao" class="form-label">Data *</label>
                                <input type="date" class="form-control" id="data_alimentacao" name="data" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_alimentacao" class="form-label">Tipo *</label>
                                <select class="form-select" id="tipo_alimentacao" name="tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="cafe">Café da Manhã</option>
                                    <option value="almoco">Almoço</option>
                                    <option value="jantar">Jantar</option>
                                    <option value="lanche">Lanche</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="valor_alimentacao" class="form-label">Valor *</label>
                                <input type="number" class="form-control" id="valor_alimentacao" name="valor" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="obra_id_alimentacao" class="form-label">Obra</label>
                                <select class="form-select" id="obra_id_alimentacao" name="obra_id">
                                    <option value="">Selecione...</option>
                                    {% for obra in obras %}
                                    <option value="{{ obra.id }}">{{ obra.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_alimentacao" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes_alimentacao" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Funcionário -->
<div class="modal fade" id="editarFuncionarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editar Funcionário
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.editar_funcionario', id=funcionario.id) }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nome" class="form-label">Nome *</label>
                                <input type="text" class="form-control" name="nome" value="{{ funcionario.nome }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cpf" class="form-label">CPF *</label>
                                <input type="text" class="form-control" name="cpf" value="{{ funcionario.cpf }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" class="form-control" name="rg" value="{{ funcionario.rg or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" name="data_nascimento" 
                                       value="{{ funcionario.data_nascimento.strftime('%Y-%m-%d') if funcionario.data_nascimento else '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="text" class="form-control" name="telefone" value="{{ funcionario.telefone or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" value="{{ funcionario.email or '' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_admissao" class="form-label">Data de Admissão *</label>
                                <input type="date" class="form-control" name="data_admissao" 
                                       value="{{ funcionario.data_admissao.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="salario" class="form-label">Salário</label>
                                <input type="number" class="form-control" name="salario" step="0.01" min="0" 
                                       value="{{ funcionario.salario }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="departamento_id" class="form-label">Departamento</label>
                                <select class="form-select" name="departamento_id">
                                    <option value="">Selecione...</option>
                                    {% for dept in departamentos %}
                                    <option value="{{ dept.id }}" {{ 'selected' if funcionario.departamento_id == dept.id else '' }}>
                                        {{ dept.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="funcao_id" class="form-label">Função</label>
                                <select class="form-select" name="funcao_id">
                                    <option value="">Selecione...</option>
                                    {% for func in funcoes %}
                                    <option value="{{ func.id }}" {{ 'selected' if funcionario.funcao_id == func.id else '' }}>
                                        {{ func.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horario_trabalho_id" class="form-label">Horário de Trabalho</label>
                                <select class="form-select" name="horario_trabalho_id">
                                    <option value="">Selecione...</option>
                                    {% for horario in horarios %}
                                    <option value="{{ horario.id }}" {{ 'selected' if funcionario.horario_trabalho_id == horario.id else '' }}>
                                        {{ horario.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="foto" class="form-label">Foto</label>
                                <input type="file" class="form-control" name="foto" accept="image/*">
                                <small class="text-muted">Deixe em branco para manter a foto atual</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endereço</label>
                        <textarea class="form-control" name="endereco" rows="2">{{ funcionario.endereco or '' }}</textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="ativo" value="1" 
                               {{ 'checked' if funcionario.ativo else '' }}>
                        <label class="form-check-label" for="ativo">
                            Funcionário Ativo
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Preenchimento automático de horário atual
function preencherHorarioAtual(campo) {
    const now = new Date();
    const currentTime = now.toTimeString().slice(0, 5);
    document.getElementById(campo).value = currentTime;
}

// Controlar visibilidade dos campos baseado no tipo de lançamento
function alterarTipoLancamento() {
    const tipo = document.getElementById('tipo_lancamento').value;
    const camposHorario = document.getElementById('campos_horario');
    const btnHorarioPadrao = document.getElementById('btnHorarioPadrao');
    
    // Limpar campos
    document.getElementById('hora_entrada_ponto').value = '';
    document.getElementById('hora_saida_ponto').value = '';
    document.getElementById('hora_almoco_saida_ponto').value = '';
    document.getElementById('hora_almoco_retorno_ponto').value = '';
    
    switch(tipo) {
        case 'trabalhado':
            // Mostrar campos de horário e botão
            camposHorario.style.display = 'block';
            btnHorarioPadrao.style.display = 'block';
            // Tornar campos obrigatórios
            document.getElementById('hora_entrada_ponto').required = true;
            document.getElementById('hora_saida_ponto').required = true;
            // Mostrar campo de percentual para horas extras
            document.getElementById('campo_percentual_extras').style.display = 'block';
            document.getElementById('percentual_extras').value = '50';  // Valor padrão para horas extras normais
            document.getElementById('percentual_extras').required = false; // Opcional para trabalho normal
            // Mostrar alerta específico
            mostrarAlerta('alertaTrabalhado');
            break;
            
        case 'feriado_trabalhado':
            // Mostrar campos de horário e botão
            camposHorario.style.display = 'block';
            btnHorarioPadrao.style.display = 'block';
            // Tornar campos obrigatórios
            document.getElementById('hora_entrada_ponto').required = true;
            document.getElementById('hora_saida_ponto').required = true;
            // Mostrar campo de percentual com valor padrão 100%
            document.getElementById('campo_percentual_extras').style.display = 'block';
            document.getElementById('percentual_extras').value = '100';
            document.getElementById('percentual_extras').required = true;
            // Mostrar alerta específico
            mostrarAlerta('alertaFeriadoTrabalhado');
            break;
            
        case 'sabado_horas_extras':
            // Mostrar campos de horário e botão
            camposHorario.style.display = 'block';
            btnHorarioPadrao.style.display = 'block';
            // Tornar campos obrigatórios
            document.getElementById('hora_entrada_ponto').required = true;
            document.getElementById('hora_saida_ponto').required = true;
            // Mostrar campo de percentual
            document.getElementById('campo_percentual_extras').style.display = 'block';
            document.getElementById('percentual_extras').value = '50';  // Valor padrão sugerido
            document.getElementById('percentual_extras').required = true;
            // Mostrar alerta específico
            mostrarAlerta('alertaSabadoHorasExtras');
            break;
            
        case 'domingo_horas_extras':
            // Mostrar campos de horário e botão
            camposHorario.style.display = 'block';
            btnHorarioPadrao.style.display = 'block';
            // Tornar campos obrigatórios
            document.getElementById('hora_entrada_ponto').required = true;
            document.getElementById('hora_saida_ponto').required = true;
            // Mostrar campo de percentual com valor padrão 100%
            document.getElementById('campo_percentual_extras').style.display = 'block';
            document.getElementById('percentual_extras').value = '100';
            document.getElementById('percentual_extras').required = true;
            // Mostrar alerta específico
            mostrarAlerta('alertaDomingoHorasExtras');
            break;
            
        case 'falta':
            // Esconder campos de horário e botão
            camposHorario.style.display = 'none';
            btnHorarioPadrao.style.display = 'none';
            // Remover obrigatoriedade
            document.getElementById('hora_entrada_ponto').required = false;
            document.getElementById('hora_saida_ponto').required = false;
            // Mostrar alerta específico
            mostrarAlerta('alertaFalta');
            break;
            
        case 'falta_justificada':
            // Esconder campos de horário e botão
            camposHorario.style.display = 'none';
            btnHorarioPadrao.style.display = 'none';
            // Remover obrigatoriedade
            document.getElementById('hora_entrada_ponto').required = false;
            document.getElementById('hora_saida_ponto').required = false;
            // Mostrar alerta específico
            mostrarAlerta('alertaFaltaJustificada');
            break;
            
        case 'feriado':
            // Esconder campos de horário e botão
            camposHorario.style.display = 'none';
            btnHorarioPadrao.style.display = 'none';
            // Remover obrigatoriedade
            document.getElementById('hora_entrada_ponto').required = false;
            document.getElementById('hora_saida_ponto').required = false;
            // Mostrar alerta específico
            mostrarAlerta('alertaFeriado');
            break;
            
        default:
            // Estado inicial
            camposHorario.style.display = 'none';
            btnHorarioPadrao.style.display = 'none';
            document.getElementById('hora_entrada_ponto').required = false;
            document.getElementById('hora_saida_ponto').required = false;
            // Esconder campo de percentual
            document.getElementById('campo_percentual_extras').style.display = 'none';
            document.getElementById('percentual_extras').required = false;
            // Esconder alertas
            document.getElementById('alertaTipoLancamento').style.display = 'none';
    }
}

// Preencher horário padrão do funcionário
function preencherHorarioPadrao() {
    const funcionarioId = document.getElementById('funcionario_id').value;
    
    // Buscar horário padrão do funcionário via AJAX
    fetch(`/funcionarios/${funcionarioId}/horario-padrao`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('hora_entrada_ponto').value = data.hora_entrada || '08:00';
                document.getElementById('hora_saida_ponto').value = data.hora_saida || '17:00';
                document.getElementById('hora_almoco_saida_ponto').value = data.hora_almoco_saida || '12:00';
                document.getElementById('hora_almoco_retorno_ponto').value = data.hora_almoco_retorno || '13:00';
            } else {
                // Usar horário padrão fixo se não encontrar
                document.getElementById('hora_entrada_ponto').value = '08:00';
                document.getElementById('hora_saida_ponto').value = '17:00';
                document.getElementById('hora_almoco_saida_ponto').value = '12:00';
                document.getElementById('hora_almoco_retorno_ponto').value = '13:00';
            }
        })
        .catch(error => {
            console.log('Erro ao buscar horário padrão, usando valores fixos');
            document.getElementById('hora_entrada_ponto').value = '08:00';
            document.getElementById('hora_saida_ponto').value = '17:00';
            document.getElementById('hora_almoco_saida_ponto').value = '12:00';
            document.getElementById('hora_almoco_retorno_ponto').value = '13:00';
        });
}

// Função para mostrar alerta específico do tipo de lançamento
function mostrarAlerta(alertaId) {
    // Esconder todos os alertas primeiro
    const alertas = ['alertaTrabalhado', 'alertaFeriado', 'alertaFeriadoTrabalhado', 'alertaFalta', 'alertaFaltaJustificada', 'alertaSabadoHorasExtras', 'alertaDomingoHorasExtras'];
    alertas.forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    
    // Mostrar o container de alertas
    document.getElementById('alertaTipoLancamento').style.display = 'block';
    
    // Mostrar o alerta específico
    document.getElementById(alertaId).style.display = 'block';
}

// Filtros rápidos para KPIs
function filtroRapido(tipo) {
    const hoje = new Date();
    let dataInicio, dataFim;
    
    switch(tipo) {
        case 'ultimos_7_dias':
            dataInicio = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
            dataFim = hoje;
            break;
        case 'ultimos_30_dias':
            dataInicio = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
            dataFim = hoje;
            break;
        case 'ultimo_mes':
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
            dataFim = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
            break;
        case 'ultimo_trimestre':
            dataInicio = new Date(hoje.getTime() - 90 * 24 * 60 * 60 * 1000);
            dataFim = hoje;
            break;
        case 'ultimo_semestre':
            dataInicio = new Date(hoje.getTime() - 180 * 24 * 60 * 60 * 1000);
            dataFim = hoje;
            break;
        case 'ultimo_ano':
            dataInicio = new Date(hoje.getFullYear() - 1, hoje.getMonth(), hoje.getDate());
            dataFim = hoje;
            break;
    }
    
    // Formatar datas para input HTML
    const formatarData = (data) => {
        return data.toISOString().split('T')[0];
    };
    
    document.getElementById('dataInicio').value = formatarData(dataInicio);
    document.getElementById('dataFim').value = formatarData(dataFim);
    
    // Aplicar automaticamente
    aplicarFiltros();
}

// Aplicar filtros de período aos KPIs
function aplicarFiltros() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    
    if (!dataInicio || !dataFim) {
        alert('Por favor, selecione ambas as datas');
        return;
    }
    
    // Recarregar página com parâmetros de filtro
    let url = new URL(window.location);
    url.searchParams.set('data_inicio', dataInicio);
    url.searchParams.set('data_fim', dataFim);
    url.searchParams.set('filtro_kpis', 'true');
    
    window.location.href = url.toString();
}

// Inicializar página sem sobrescrever valores dos campos de data
document.addEventListener('DOMContentLoaded', function() {
    // Os valores dos campos já são definidos pelo backend via Jinja2
    // Não fazer nada aqui para preservar os valores corretos
    console.log('Página de perfil carregada com filtros preservados');
});

// Função para submeter formulário de ponto (criação ou edição)
function submeterFormularioPonto(event) {
    event.preventDefault();
    
    const form = document.getElementById('pontoForm');
    const formData = new FormData(form);
    
    // Verificar se é edição ou criação
    const registroId = document.getElementById('registro_id_ponto');
    const isEdicao = registroId && registroId.value;
    
    let url, method;
    if (isEdicao) {
        // Edição
        url = `/ponto/registro/${registroId.value}`;
        method = 'PUT';
        
        // Converter FormData para JSON para PUT
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'registro_id') { // Não incluir o ID no corpo
                data[key] = value;
            }
        }
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Registro atualizado com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('pontoModal')).hide();
                location.reload();
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao atualizar registro: ' + error.message);
        });
    } else {
        // Criação - usar o formulário padrão
        form.submit();
    }
    
    return false;
}

// Função específica para abrir modal de novo registro
function abrirModalNovoPonto() {
    console.log('🎯 Abrindo modal de novo registro...');
    
    try {
        // Limpar formulário se existir
        const form = document.getElementById('pontoForm');
        if (form) {
            form.reset();
            form.removeAttribute('data-modo');
            
            // Remover campo hidden de edição se existir
            const hiddenId = document.getElementById('registro_id_ponto');
            if (hiddenId) {
                hiddenId.remove();
            }
        }
        
        // Definir data atual
        const hoje = new Date().toISOString().split('T')[0];
        const dataEl = document.getElementById('data_ponto');
        if (dataEl) {
            dataEl.value = hoje;
            console.log('✅ Data definida:', hoje);
        }
        
        // Resetar título do modal
        const titulo = document.querySelector('#pontoModal .modal-title');
        if (titulo) {
            titulo.innerHTML = '<i class="fas fa-clock"></i> Novo Registro de Ponto';
        }
        
        // Esconder campos opcionais inicialmente (com verificação de existência)
        const campos_opcionais = ['campos_horario', 'campo_percentual_extras', 'alertaTipoLancamento'];
        campos_opcionais.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento && elemento.style) {
                elemento.style.display = 'none';
            }
        });
        
        // Resetar select de tipo se existir
        const tipoSelect = document.getElementById('tipo_lancamento');
        if (tipoSelect) {
            tipoSelect.value = '';
        }
        
        // Abrir modal
        const modalElement = document.getElementById('pontoModal');
        if (modalElement) {
            console.log('✅ Modal encontrado, abrindo...');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('✅ Modal exibido');
        } else {
            console.error('❌ Modal pontoModal não encontrado no DOM');
            alert('Erro: Modal não encontrado. Recarregue a página.');
        }
        
    } catch (error) {
        console.error('❌ Erro ao abrir modal:', error);
        // Log detalhado do erro
        if (error.message.includes('Cannot read properties of null')) {
            console.error('❌ Tentando acessar propriedade de elemento null');
            console.error('❌ Verifique se todos os elementos HTML existem');
        }
        alert('Erro ao abrir modal. Recarregue a página e tente novamente.');
    }
}

// Funções de edição e exclusão  
function editarPonto(id) {
    console.log('🔧 Editando registro:', id);
    
    // Buscar dados do registro
    fetch(`/ponto/registro/${id}`)
        .then(response => {
            if (!response.ok) throw new Error('Erro ao carregar dados');
            return response.json();
        })
        .then(data => {
            console.log('Dados carregados:', data);
            
            // Preencher o modal com os dados - verificar elementos principais
            const dataEl = document.getElementById('data_ponto');
            const tipoEl = document.getElementById('tipo_lancamento');
            const obraEl = document.getElementById('obra_id_ponto');
            
            if (dataEl) dataEl.value = data.data;
            if (tipoEl) tipoEl.value = data.tipo_registro;
            if (obraEl) obraEl.value = data.obra_id || '';
            // Verificar se os elementos existem antes de definir valores
            const entradaEl = document.getElementById('hora_entrada_ponto');
            const saidaEl = document.getElementById('hora_saida_ponto');
            const almocoSaidaEl = document.getElementById('hora_almoco_saida_ponto');
            const almocoRetornoEl = document.getElementById('hora_almoco_retorno_ponto');
            const percentualEl = document.getElementById('percentual_extras');
            const observacoesEl = document.getElementById('observacoes');
            
            if (entradaEl) entradaEl.value = data.entrada || '';
            if (saidaEl) saidaEl.value = data.saida || '';
            if (almocoSaidaEl) almocoSaidaEl.value = data.saida_almoco || '';
            if (almocoRetornoEl) almocoRetornoEl.value = data.retorno_almoco || '';
            if (percentualEl) percentualEl.value = data.percentual_extras || 0;
            if (observacoesEl) observacoesEl.value = data.observacoes || '';
            
            // Alterar o título do modal
            document.querySelector('#pontoModal .modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Registro de Ponto';
            
            // Adicionar campo hidden com ID do registro
            let formPonto = document.getElementById('pontoForm');
            let hiddenId = document.getElementById('registro_id_ponto');
            if (!hiddenId) {
                hiddenId = document.createElement('input');
                hiddenId.type = 'hidden';
                hiddenId.id = 'registro_id_ponto';
                hiddenId.name = 'registro_id';
                formPonto.appendChild(hiddenId);
            }
            hiddenId.value = id;
            
            // Configurar modo de edição
            formPonto.setAttribute('data-modo', 'edicao');
            
            // Ajustar visibilidade dos campos baseado no tipo
            alterarTipoLancamento();
            
            // Abrir modal com verificação
            const modalElement = document.getElementById('pontoModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('Modal pontoModal não encontrado');
                alert('Erro: Modal não encontrado');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar registro:', error);
            
            // Mostrar detalhes do erro
            if (error.message.includes('Cannot read properties of null')) {
                alert('Erro: Dados do registro não puderam ser carregados. Verifique se o registro existe.');
            } else {
                alert('Erro ao carregar dados do registro: ' + error.message);
            }
        });
}

function excluirPonto(id) {
    if (confirm('Tem certeza que deseja excluir este registro de ponto?\\n\\nEsta ação não pode ser desfeita.')) {
        console.log('Excluindo registro:', id);
        
        fetch(`/ponto/registro/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Erro na requisição');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Registro excluído com sucesso!');
                location.reload(); // Recarregar a página para atualizar a tabela
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('Erro ao excluir:', error);
            alert('Erro ao excluir registro: ' + error.message);
        });
    }
}

function editarOcorrencia(id) {
    alert('Funcionalidade de edição de ocorrência será implementada');
}

function excluirOcorrencia(id) {
    if (confirm('Tem certeza que deseja excluir esta ocorrência?')) {
        // Implementar exclusão via AJAX
        console.log('Excluir ocorrência:', id);
    }
}

function editarAlimentacao(id) {
    alert('Funcionalidade de edição de alimentação será implementada');
}

function excluirAlimentacao(id) {
    if (confirm('Tem certeza que deseja excluir este registro de alimentação?')) {
        // Implementar exclusão via AJAX
        console.log('Excluir alimentação:', id);
    }
}

$(document).ready(function() {
    // Inicializar DataTables
    $('#pontoTable').DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' },
        order: [[0, 'desc']],
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],
        dom: 'lBfrtip',
        buttons: [
            {
                extend: 'pageLength',
                text: 'Registros por página'
            }
        ]
    });
    
    $('#ocorrenciasTable').DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' },
        order: [[1, 'desc']],
        pageLength: 10
    });
    
    $('#alimentacaoTable').DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' },
        order: [[0, 'desc']],
        pageLength: 10
    });
    
    $('#outrosCustosTable').DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' },
        order: [[0, 'desc']],
        pageLength: 10
    });
    
    // Definir data padrão nos formulários
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('data_ponto').value = today;
    document.getElementById('data_inicio_ocorrencia').value = today;
    document.getElementById('data_alimentacao').value = today;
    
    // Reset do modal de ponto para novos registros
    $('#pontoModal').on('show.bs.modal', function (event) {
        // Se não foi clique no botão editar, limpar o formulário para novo registro
        if (!event.relatedTarget || !event.relatedTarget.classList.contains('btn-outline-warning')) {
            document.querySelector('#pontoModal .modal-title').innerHTML = '<i class="fas fa-clock"></i> Novo Registro de Ponto';
            document.getElementById('pontoForm').reset();
            document.getElementById('pontoForm').removeAttribute('data-modo');
            
            // Remover campo hidden se existir
            const hiddenId = document.getElementById('registro_id_ponto');
            if (hiddenId) {
                hiddenId.remove();
            }
            
            // Definir data padrão
            document.getElementById('data_ponto').value = today;
            
            // Esconder campos de horário inicialmente
            document.getElementById('camposHorario').style.display = 'none';
            document.getElementById('btnHorarioPadrao').style.display = 'none';
        }
    });
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Gráficos
    renderCharts();
});

function renderCharts() {
    // Gráfico de Horas Trabalhadas
    const ctxHoras = document.getElementById('horasTrabalhadasChart').getContext('2d');
    new Chart(ctxHoras, {
        type: 'line',
        data: {
            labels: {{ graficos.meses|tojson }},
            datasets: [{
                label: 'Horas Trabalhadas',
                data: {{ graficos.horas_trabalhadas|tojson }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Gráfico de Absenteísmo
    const ctxAbsenteismo = document.getElementById('absenteismoChart').getContext('2d');
    new Chart(ctxAbsenteismo, {
        type: 'bar',
        data: {
            labels: {{ graficos.meses|tojson }},
            datasets: [{
                label: 'Absenteísmo (%)',
                data: {{ graficos.absenteismo|tojson }},
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgb(255, 99, 132)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Funções para modal de ocorrência
function editarOcorrencia(ocorrenciaId) {
    console.log('Editando ocorrência:', ocorrenciaId);
    alert('Funcionalidade de edição será implementada em breve.');
}

function excluirOcorrencia(ocorrenciaId) {
    if (confirm('Tem certeza que deseja excluir esta ocorrência?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/funcionarios/ocorrencias/' + ocorrenciaId + '/excluir';
        document.body.appendChild(form);
        form.submit();
    }
}

// Validação do formulário de ocorrência
document.addEventListener('DOMContentLoaded', function() {
    const ocorrenciaForm = document.getElementById('ocorrenciaForm');
    if (ocorrenciaForm) {
        ocorrenciaForm.addEventListener('submit', function(e) {
            const tipo = document.getElementById('tipo_ocorrencia').value;
            const dataInicio = document.getElementById('data_inicio_ocorrencia').value;
            
            if (!tipo) {
                e.preventDefault();
                alert('Por favor, selecione o tipo de ocorrência.');
                return;
            }
            
            if (!dataInicio) {
                e.preventDefault();
                alert('Por favor, informe a data de início.');
                return;
            }
            
            const dataFim = document.getElementById('data_fim_ocorrencia').value;
            if (dataFim && dataFim < dataInicio) {
                e.preventDefault();
                alert('A data de fim deve ser posterior à data de início.');
                return;
            }
        });
    }
    
    // Limpar formulário ao abrir modal
    const ocorrenciaModal = document.getElementById('ocorrenciaModal');
    if (ocorrenciaModal) {
        ocorrenciaModal.addEventListener('show.bs.modal', function() {
            const form = this.querySelector('form');
            if (form) {
                form.reset();
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('data_inicio_ocorrencia').value = hoje;
            }
        });
    }
    
    // Limpar formulário de ponto ao abrir modal
    const pontoModal = document.getElementById('pontoModal');
    if (pontoModal) {
        pontoModal.addEventListener('show.bs.modal', function() {
            const form = this.querySelector('form');
            if (form) {
                form.reset();
                const hoje = new Date().toISOString().split('T')[0];
                const dataEl = document.getElementById('data_ponto');
                if (dataEl) dataEl.value = hoje;
                
                // Resetar visibilidade dos elementos com verificação de existência
                const elementos = [
                    'campos_horario',
                    'btnHorarioPadrao', 
                    'campo_percentual_extras',
                    'alertaTipoLancamento'
                ];
                
                elementos.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) {
                        elemento.style.display = 'none';
                    }
                });
            }
        });
    }
});

// Função para excluir outro custo
function excluirOutroCusto(id) {
    if (confirm('Tem certeza que deseja excluir este registro de outros custos?')) {
        fetch(`/funcionarios/{{ funcionario.id }}/outros-custos/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Registro excluído com sucesso!');
                location.reload();
            } else {
                alert('Erro ao excluir registro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir registro');
        });
    }
}

// Limpar formulário ao fechar modal
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('outroCustoModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('outroCustoForm').reset();
        });
    }
});
</script>

<!-- Modal Outros Custos -->
<div class="modal fade" id="outroCustoModal" tabindex="-1" aria-labelledby="outroCustoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="outroCustoModalLabel">
                    <i class="fas fa-money-bill-wave"></i> Novo Registro de Outros Custos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="outroCustoForm" action="{{ url_for('main.criar_outro_custo', funcionario_id=funcionario.id) }}" method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_outro_custo" class="form-label">Data</label>
                                <input type="date" class="form-control" id="data_outro_custo" name="data" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_outro_custo" class="form-label">Tipo</label>
                                <input type="text" class="form-control" id="tipo_outro_custo" name="tipo" 
                                       placeholder="Ex: Vale Transporte, Vale Alimentação, Desconto VT..." required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_outro_custo" class="form-label">Categoria</label>
                                <select class="form-select" id="categoria_outro_custo" name="categoria" required>
                                    <option value="">Selecione...</option>
                                    <option value="adicional">Adicional (+)</option>
                                    <option value="desconto">Desconto (-)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="valor_outro_custo" class="form-label">Valor (R$)</label>
                                <input type="number" step="0.01" class="form-control" id="valor_outro_custo" name="valor" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="descricao_outro_custo" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao_outro_custo" name="descricao" rows="3" placeholder="Detalhes sobre o custo..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="outroCustoForm" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}