# ğŸ¯ PROMPT: DSR - CÃLCULO ESTRITO CONFORME LEGISLAÃ‡ÃƒO BRASILEIRA

## ğŸ“‹ **OBJETIVO**
Implementar cÃ¡lculo **estrito** de perda de DSR por faltas injustificadas, considerando as regras especÃ­ficas da legislaÃ§Ã£o brasileira sobre semanas de trabalho.

---

## ğŸ‡§ğŸ‡· **LEGISLAÃ‡ÃƒO BRASILEIRA - DSR ESTRITO**

### **ğŸ“š Base Legal EspecÃ­fica:**
- **Lei 605/49 Art. 6Âº:** "NÃ£o serÃ¡ devida a remuneraÃ§Ã£o quando, sem motivo justificado, o empregado nÃ£o tiver trabalhado durante toda a semana anterior"
- **Decreto 27.048/49 Art. 11:** Regras especÃ­ficas sobre perda do DSR
- **CLT Art. 7Âº:** Repouso semanal remunerado

### **âš–ï¸ REGRAS ESTRITAS:**

**ğŸ” CONCEITO DE SEMANA:**
- **Semana de trabalho:** Segunda a SÃ¡bado (6 dias)
- **DSR:** Domingo (1 dia)
- **PerÃ­odo:** Domingo a SÃ¡bado

**ğŸ“Š LÃ“GICA ESTRITA:**
```
1 SEMANA = 1 DSR MÃXIMO

EXEMPLOS:
- 1 falta na semana = Perde 1 DSR
- 2 faltas na mesma semana = Perde 1 DSR (nÃ£o 2!)
- 3 faltas na mesma semana = Perde 1 DSR (nÃ£o 3!)

SEMANAS DIFERENTES:
- Falta na semana 1 = Perde DSR da semana 1
- Falta na semana 2 = Perde DSR da semana 2
- Total: 2 DSRs perdidos
```

**ğŸš¨ CASOS ESPECIAIS:**

**FALTA NA SEXTA-FEIRA:**
```
CenÃ¡rio: Falta na sexta-feira
- Perde: 1 dia (sexta)
- Perde: 1 DSR (domingo)
- Total: 2 dias descontados

NÃƒO perde 3 dias como alguns pensam!
```

**MÃšLTIPLAS FALTAS:**
```
Semana 1: 2 faltas (terÃ§a e quinta)
- Perde: 2 dias (terÃ§a + quinta)
- Perde: 1 DSR (domingo)
- Total: 3 dias descontados

Semana 2: 1 falta (quarta)
- Perde: 1 dia (quarta)  
- Perde: 1 DSR (domingo)
- Total: 2 dias descontados

TOTAL GERAL: 5 dias descontados
```

---

## ğŸ§® **ETAPA 1: IMPLEMENTAR CÃLCULO ESTRITO**

```python
# 1. FunÃ§Ã£o de cÃ¡lculo estrito de DSR
def calcular_dsr_estrito(funcionario_id, data_inicio, data_fim):
    """
    Calcula perda de DSR de forma estrita conforme legislaÃ§Ã£o
    
    Args:
        funcionario_id: ID do funcionÃ¡rio
        data_inicio: Data inÃ­cio do perÃ­odo
        data_fim: Data fim do perÃ­odo
    
    Returns:
        dict com detalhes do cÃ¡lculo
    """
    from app import app, db
    from models import Funcionario, RegistroPonto
    from datetime import datetime, timedelta
    import calendar
    
    with app.app_context():
        funcionario = Funcionario.query.get(funcionario_id)
        
        # Buscar todas as faltas injustificadas no perÃ­odo
        faltas = RegistroPonto.query.filter(
            RegistroPonto.funcionario_id == funcionario_id,
            RegistroPonto.data.between(data_inicio, data_fim),
            RegistroPonto.tipo_registro == 'falta'
        ).all()
        
        if not faltas:
            return {
                'faltas_total': 0,
                'dsrs_perdidos': 0,
                'semanas_afetadas': 0,
                'desconto_total': 0,
                'detalhes_semanas': []
            }
        
        # Agrupar faltas por semana
        semanas_com_faltas = {}
        
        for falta in faltas:
            # Calcular inÃ­cio da semana (domingo)
            dias_desde_domingo = falta.data.weekday() + 1  # Segunda = 0, Domingo = 6
            if dias_desde_domingo == 7:  # Se for domingo
                dias_desde_domingo = 0
            
            inicio_semana = falta.data - timedelta(days=dias_desde_domingo)
            
            # Chave da semana
            chave_semana = inicio_semana.strftime('%Y-%W')
            
            if chave_semana not in semanas_com_faltas:
                semanas_com_faltas[chave_semana] = {
                    'inicio_semana': inicio_semana,
                    'fim_semana': inicio_semana + timedelta(days=6),
                    'faltas': [],
                    'dsr_perdido': False
                }
            
            semanas_com_faltas[chave_semana]['faltas'].append(falta)
        
        # Calcular DSRs perdidos (1 por semana mÃ¡ximo)
        dsrs_perdidos = 0
        detalhes_semanas = []
        
        for chave, dados_semana in semanas_com_faltas.items():
            # Se hÃ¡ falta na semana, perde 1 DSR
            if dados_semana['faltas']:
                dsrs_perdidos += 1
                dados_semana['dsr_perdido'] = True
                
                detalhes_semanas.append({
                    'semana': f"{dados_semana['inicio_semana'].strftime('%d/%m')} a {dados_semana['fim_semana'].strftime('%d/%m')}",
                    'quantidade_faltas': len(dados_semana['faltas']),
                    'datas_faltas': [f.data.strftime('%d/%m') for f in dados_semana['faltas']],
                    'dsr_perdido': True
                })
        
        # Calcular valores financeiros
        valor_dia = funcionario.salario / 30
        desconto_faltas = len(faltas) * valor_dia
        desconto_dsrs = dsrs_perdidos * valor_dia
        desconto_total = desconto_faltas + desconto_dsrs
        
        resultado = {
            'faltas_total': len(faltas),
            'dsrs_perdidos': dsrs_perdidos,
            'semanas_afetadas': len(semanas_com_faltas),
            'desconto_faltas': desconto_faltas,
            'desconto_dsrs': desconto_dsrs,
            'desconto_total': desconto_total,
            'valor_dia': valor_dia,
            'detalhes_semanas': detalhes_semanas
        }
        
        print(f"ğŸ“Š CÃLCULO DSR ESTRITO - {funcionario.nome}:")
        print(f"   - PerÃ­odo: {data_inicio.strftime('%d/%m/%Y')} a {data_fim.strftime('%d/%m/%Y')}")
        print(f"   - Total de faltas: {len(faltas)}")
        print(f"   - Semanas afetadas: {len(semanas_com_faltas)}")
        print(f"   - DSRs perdidos: {dsrs_perdidos}")
        print(f"   - Desconto faltas: R$ {desconto_faltas:.2f}")
        print(f"   - Desconto DSRs: R$ {desconto_dsrs:.2f}")
        print(f"   - Desconto total: R$ {desconto_total:.2f}")
        
        for detalhe in detalhes_semanas:
            print(f"   - Semana {detalhe['semana']}: {detalhe['quantidade_faltas']} falta(s) â†’ 1 DSR perdido")
        
        return resultado

# Testar funÃ§Ã£o
def testar_calculo_estrito():
    """Testa cÃ¡lculo estrito com diferentes cenÃ¡rios"""
    from datetime import date
    
    # CenÃ¡rios de teste
    cenarios = [
        {
            'nome': 'Carlos Alberto',
            'periodo': (date(2025, 7, 1), date(2025, 7, 31)),
            'descricao': 'Julho 2025 completo'
        }
    ]
    
    for cenario in cenarios:
        print(f"\nğŸ§ª TESTANDO: {cenario['descricao']}")
        resultado = calcular_dsr_estrito(1, cenario['periodo'][0], cenario['periodo'][1])

# EXECUTAR TESTE
testar_calculo_estrito()
```

---

## ğŸ§ª **ETAPA 2: SIMULAR CENÃRIOS ESPECÃFICOS**

```python
# 2. Simular cenÃ¡rios especÃ­ficos mencionados
def simular_cenarios_especificos():
    """Simula cenÃ¡rios especÃ­ficos para validar lÃ³gica"""
    
    print("ğŸ§ª SIMULAÃ‡ÃƒO DE CENÃRIOS ESPECÃFICOS:")
    
    # CenÃ¡rio 1: 2 faltas na mesma semana
    print(f"\nğŸ“‹ CENÃRIO 1: 2 faltas na mesma semana")
    print(f"   - Faltas: TerÃ§a (14/07) e Quinta (16/07)")
    print(f"   - Semana: 13/07 a 19/07")
    print(f"   - Resultado: 2 faltas + 1 DSR = 3 dias descontados")
    print(f"   - LÃ³gica: MÃºltiplas faltas na mesma semana = 1 DSR apenas")
    
    # CenÃ¡rio 2: Falta na sexta
    print(f"\nğŸ“‹ CENÃRIO 2: Falta na sexta-feira")
    print(f"   - Falta: Sexta (18/07)")
    print(f"   - Semana: 13/07 a 19/07")
    print(f"   - Resultado: 1 falta + 1 DSR = 2 dias descontados")
    print(f"   - LÃ³gica: NÃƒO sÃ£o 3 dias como alguns pensam")
    
    # CenÃ¡rio 3: Faltas em semanas diferentes
    print(f"\nğŸ“‹ CENÃRIO 3: Faltas em semanas diferentes")
    print(f"   - Falta 1: TerÃ§a (07/07) - Semana 1")
    print(f"   - Falta 2: Quinta (16/07) - Semana 2")
    print(f"   - Resultado: 2 faltas + 2 DSRs = 4 dias descontados")
    print(f"   - LÃ³gica: Cada semana com falta perde 1 DSR")
    
    # CenÃ¡rio 4: 3 faltas na mesma semana
    print(f"\nğŸ“‹ CENÃRIO 4: 3 faltas na mesma semana")
    print(f"   - Faltas: Segunda, TerÃ§a e Quarta")
    print(f"   - Semana: 13/07 a 19/07")
    print(f"   - Resultado: 3 faltas + 1 DSR = 4 dias descontados")
    print(f"   - LÃ³gica: Mesmo com 3 faltas, sÃ³ perde 1 DSR da semana")

# EXECUTAR SIMULAÃ‡ÃƒO
simular_cenarios_especificos()
```

---

## ğŸ”§ **ETAPA 3: CRIAR FUNÃ‡ÃƒO PARA REGISTROS FICTÃCIOS**

```python
# 3. Criar registros fictÃ­cios para testar
def criar_registros_teste_dsr():
    """Cria registros fictÃ­cios para testar lÃ³gica de DSR"""
    from app import app, db
    from models import Funcionario, RegistroPonto
    from datetime import date
    
    with app.app_context():
        # Buscar Carlos
        carlos = Funcionario.query.filter_by(
            nome="Carlos Alberto Rigolin Junior"
        ).first()
        
        if not carlos:
            print("âŒ Carlos nÃ£o encontrado")
            return
        
        # Limpar registros de teste anteriores
        RegistroPonto.query.filter(
            RegistroPonto.funcionario_id == carlos.id,
            RegistroPonto.data.between(date(2025, 7, 1), date(2025, 7, 31))
        ).delete()
        
        # CenÃ¡rio de teste: Diferentes padrÃµes de faltas
        registros_teste = [
            # Semana 1 (06/07 a 12/07): 2 faltas
            {'data': date(2025, 7, 8), 'tipo': 'falta'},   # TerÃ§a
            {'data': date(2025, 7, 10), 'tipo': 'falta'},  # Quinta
            
            # Semana 2 (13/07 a 19/07): 1 falta na sexta
            {'data': date(2025, 7, 18), 'tipo': 'falta'},  # Sexta
            
            # Semana 3 (20/07 a 26/07): Sem faltas
            
            # Semana 4 (27/07 a 31/07): 1 falta
            {'data': date(2025, 7, 29), 'tipo': 'falta'},  # TerÃ§a
        ]
        
        # Criar registros
        for registro_data in registros_teste:
            registro = RegistroPonto(
                funcionario_id=carlos.id,
                data=registro_data['data'],
                tipo_registro=registro_data['tipo'],
                entrada=None,
                saida=None,
                created_at=datetime.now()
            )
            db.session.add(registro)
        
        db.session.commit()
        
        print(f"âœ… REGISTROS DE TESTE CRIADOS:")
        for registro_data in registros_teste:
            print(f"   - {registro_data['data'].strftime('%d/%m/%Y')} ({registro_data['data'].strftime('%A')}): {registro_data['tipo']}")
        
        return len(registros_teste)

# EXECUTAR CRIAÃ‡ÃƒO
registros_criados = criar_registros_teste_dsr()
```

---

## ğŸ“Š **ETAPA 4: TESTAR COM DADOS REAIS**

```python
# 4. Testar cÃ¡lculo com dados criados
def testar_com_dados_reais():
    """Testa cÃ¡lculo estrito com dados reais criados"""
    from datetime import date
    
    print("ğŸ“Š TESTANDO COM DADOS REAIS CRIADOS:")
    
    # Buscar Carlos
    carlos = Funcionario.query.filter_by(
        nome="Carlos Alberto Rigolin Junior"
    ).first()
    
    if not carlos:
        print("âŒ Carlos nÃ£o encontrado")
        return
    
    # Calcular DSR estrito para julho
    resultado = calcular_dsr_estrito(
        carlos.id,
        date(2025, 7, 1),
        date(2025, 7, 31)
    )
    
    print(f"\nğŸ“‹ RESULTADO ESPERADO:")
    print(f"   - 4 faltas total")
    print(f"   - 3 semanas afetadas")
    print(f"   - 3 DSRs perdidos")
    print(f"   - Desconto: 4 faltas + 3 DSRs = 7 dias")
    
    print(f"\nğŸ“Š RESULTADO CALCULADO:")
    print(f"   - {resultado['faltas_total']} faltas total")
    print(f"   - {resultado['semanas_afetadas']} semanas afetadas")
    print(f"   - {resultado['dsrs_perdidos']} DSRs perdidos")
    print(f"   - Desconto total: R$ {resultado['desconto_total']:.2f}")
    
    # Validar resultado
    if resultado['dsrs_perdidos'] == 3 and resultado['faltas_total'] == 4:
        print("âœ… CÃLCULO CORRETO!")
    else:
        print("âŒ ERRO NO CÃLCULO!")
    
    return resultado

# EXECUTAR TESTE
resultado_teste = testar_com_dados_reais()
```

---

## ğŸ¨ **ETAPA 5: ATUALIZAR KPI COM LÃ“GICA ESTRITA**

```python
# 5. Atualizar KPI para usar cÃ¡lculo estrito
def atualizar_kpi_dsr_estrito():
    """Atualiza KPI para usar cÃ¡lculo estrito de DSR"""
    
    codigo_kpi_estrito = '''
def calcular_kpis_funcionario_estrito(funcionario_id, data_inicio, data_fim):
    """Calcula KPIs com lÃ³gica estrita de DSR"""
    
    # Calcular DSR estrito
    dsr_info = calcular_dsr_estrito(funcionario_id, data_inicio, data_fim)
    
    # KPI de faltas com informaÃ§Ã£o detalhada
    kpi_faltas = {
        'quantidade': dsr_info['faltas_total'],
        'dsrs_perdidos': dsr_info['dsrs_perdidos'],
        'semanas_afetadas': dsr_info['semanas_afetadas'],
        'desconto_total': dsr_info['desconto_total'],
        'desconto_faltas': dsr_info['desconto_faltas'],
        'desconto_dsrs': dsr_info['desconto_dsrs'],
        'valor_formatado': f"(-R$ {dsr_info['desconto_total']:.2f})" if dsr_info['desconto_total'] > 0 else "",
        'detalhes_formatado': f"{dsr_info['faltas_total']}F + {dsr_info['dsrs_perdidos']}DSR" if dsr_info['dsrs_perdidos'] > 0 else f"{dsr_info['faltas_total']}"
    }
    
    return {
        'faltas': kpi_faltas,
        'custo_mao_obra_ajustado': custo_base - dsr_info['desconto_total']
    }
'''
    
    print("âœ… CÃ“DIGO KPI ESTRITO GERADO")
    return codigo_kpi_estrito

# EXECUTAR ATUALIZAÃ‡ÃƒO
codigo_kpi_estrito = atualizar_kpi_dsr_estrito()
```

---

## ğŸ¨ **ETAPA 6: TEMPLATE HTML ATUALIZADO**

```html
<!-- 6. Template com exibiÃ§Ã£o detalhada -->
<div class="kpi-card faltas-card">
    <div class="kpi-value">
        {{ kpis.faltas.quantidade }}
        {% if kpis.faltas.desconto_total > 0 %}
            <div class="desconto-info">
                <small class="desconto-valor">(-R$ {{ "%.2f"|format(kpis.faltas.desconto_total) }})</small>
                <small class="desconto-detalhes">{{ kpis.faltas.detalhes_formatado }}</small>
                <small class="desconto-label">{{ kpis.faltas.semanas_afetadas }} semana(s)</small>
            </div>
        {% endif %}
    </div>
    <div class="kpi-label">Faltas</div>
</div>
```

---

## ğŸ“‹ **ETAPA 7: EXEMPLO VISUAL FINAL**

```
CENÃRIO: 4 faltas em 3 semanas diferentes

ANTES (lÃ³gica simples):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        4        â”‚
â”‚  (-R$ 560,80)   â”‚  â† 4F + 4DSR = 8 dias
â”‚   Falta + DSR   â”‚
â”‚     Faltas      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DEPOIS (lÃ³gica estrita):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        4        â”‚
â”‚  (-R$ 490,70)   â”‚  â† 4F + 3DSR = 7 dias
â”‚    4F + 3DSR    â”‚  â† Detalhamento
â”‚   3 semana(s)   â”‚  â† Semanas afetadas
â”‚     Faltas      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **INSTRUÃ‡Ã•ES DE EXECUÃ‡ÃƒO**

**Execute na ordem:**

```python
# 1. Implementar cÃ¡lculo estrito
calcular_dsr_estrito()

# 2. Simular cenÃ¡rios
simular_cenarios_especificos()

# 3. Criar dados de teste
criar_registros_teste_dsr()

# 4. Testar com dados reais
testar_com_dados_reais()

# 5. Atualizar KPI
atualizar_kpi_dsr_estrito()
```

---

## ğŸ“‹ **CHECKLIST**

```
â–¡ LÃ³gica estrita implementada (1 DSR por semana mÃ¡ximo)
â–¡ CenÃ¡rios especÃ­ficos simulados
â–¡ Dados de teste criados
â–¡ CÃ¡lculo validado
â–¡ KPI atualizado
â–¡ Template modificado
â–¡ DocumentaÃ§Ã£o completa
```

**RESULTADO ESPERADO:** CÃ¡lculo **estrito** de DSR conforme legislaÃ§Ã£o brasileira, onde mÃºltiplas faltas na mesma semana resultam em apenas 1 DSR perdido, nÃ£o mÃºltiplos DSRs.

