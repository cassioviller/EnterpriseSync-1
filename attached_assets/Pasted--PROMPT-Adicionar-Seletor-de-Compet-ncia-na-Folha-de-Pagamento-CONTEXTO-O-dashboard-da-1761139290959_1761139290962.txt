# üéØ PROMPT: Adicionar Seletor de Compet√™ncia na Folha de Pagamento

## CONTEXTO

O dashboard da folha de pagamento atualmente est√° fixo no m√™s atual (October/2025). O usu√°rio precisa poder selecionar qualquer compet√™ncia (m√™s/ano) para:
- Visualizar dados hist√≥ricos
- Processar folhas de meses anteriores ou futuros
- Comparar per√≠odos diferentes

**Arquivos a modificar:**
1. `folha_pagamento_views.py` - Adicionar l√≥gica de compet√™ncias
2. `templates/folha_pagamento/dashboard.html` - Adicionar seletor visual

---

## TAREFA 1: Modificar `folha_pagamento_views.py`

### **Instru√ß√£o:** Substitua a fun√ß√£o `dashboard()` (linhas 35-105) pela vers√£o abaixo.

```python
@folha_bp.route('/dashboard')
@admin_required
def dashboard():
    """Dashboard principal da folha de pagamento com seletor de compet√™ncia"""
    
    from models import db
    from dateutil.relativedelta import relativedelta
    
    # M√™s atual
    hoje = date.today()
    mes_atual = hoje.replace(day=1)
    
    # Gerar lista de compet√™ncias (√∫ltimos 12 meses + pr√≥ximos 2)
    competencias = []
    for i in range(-12, 3):  # De 12 meses atr√°s at√© 2 meses √† frente
        mes_comp = mes_atual + relativedelta(months=i)
        competencias.append({
            'ano': mes_comp.year,
            'mes': mes_comp.month,
            'label': mes_comp.strftime('%B/%Y').capitalize(),
            'valor': f"{mes_comp.year}-{mes_comp.month:02d}"
        })
    
    # Compet√™ncia selecionada (padr√£o: m√™s atual)
    comp_selecionada = request.args.get('competencia', f"{mes_atual.year}-{mes_atual.month:02d}")
    
    try:
        ano_sel, mes_sel = map(int, comp_selecionada.split('-'))
        mes_referencia = date(ano_sel, mes_sel, 1)
    except (ValueError, AttributeError):
        # Se compet√™ncia inv√°lida, usar m√™s atual
        mes_referencia = mes_atual
        comp_selecionada = f"{mes_atual.year}-{mes_atual.month:02d}"
    
    # Obter folhas da compet√™ncia selecionada
    folhas_mes = FolhaPagamento.query.filter_by(
        admin_id=current_user.id,
        mes_referencia=mes_referencia
    ).all()
    
    # Calcular m√©tricas
    total_folha = sum(f.total_proventos or 0 for f in folhas_mes)
    total_liquido = sum(f.salario_liquido or 0 for f in folhas_mes)
    total_encargos = sum((f.inss or 0) + (f.fgts or 0) for f in folhas_mes)
    
    # M√™s anterior para compara√ß√£o
    mes_anterior = mes_referencia + relativedelta(months=-1)
    folhas_anterior = FolhaPagamento.query.filter_by(
        admin_id=current_user.id,
        mes_referencia=mes_anterior
    ).all()
    
    total_anterior = sum(f.total_proventos or 0 for f in folhas_anterior)
    variacao = ((total_folha - total_anterior) / total_anterior * 100) if total_anterior > 0 else 0
    
    # Status do processamento
    from models import Funcionario
    funcionarios_ativos = Funcionario.query.filter_by(
        admin_id=current_user.id,
        ativo=True
    ).count()
    
    folhas_processadas = len(folhas_mes)
    percentual_processado = (folhas_processadas / funcionarios_ativos * 100) if funcionarios_ativos > 0 else 0
    
    # Top 5 maiores sal√°rios
    top_salarios = sorted(folhas_mes, key=lambda x: x.total_proventos or 0, reverse=True)[:5]
    
    # Funcion√°rios com mais horas extras
    top_extras = sorted(folhas_mes, key=lambda x: x.horas_extras or 0, reverse=True)[:5]
    
    # Verificar se par√¢metros legais est√£o configurados para o ano selecionado
    parametros = ParametrosLegais.query.filter_by(
        admin_id=current_user.id,
        ano_vigencia=ano_sel,
        ativo=True
    ).first()
    
    parametros_configurados = parametros is not None
    if not parametros_configurados and folhas_processadas == 0:
        flash(f'Par√¢metros legais n√£o configurados para {ano_sel}. Configure antes de processar a folha.', 'warning')
    
    return render_template('folha_pagamento/dashboard.html',
                         mes_referencia=mes_referencia,
                         competencias=competencias,
                         comp_selecionada=comp_selecionada,
                         total_folha=total_folha,
                         total_liquido=total_liquido,
                         total_encargos=total_encargos,
                         variacao=variacao,
                         funcionarios_ativos=funcionarios_ativos,
                         folhas_processadas=folhas_processadas,
                         percentual_processado=percentual_processado,
                         top_salarios=top_salarios,
                         top_extras=top_extras,
                         parametros_configurados=parametros_configurados)
```

### **Adicionar depend√™ncia:**

Se o m√≥dulo `python-dateutil` n√£o estiver instalado, adicione ao `requirements.txt`:

```
python-dateutil==2.8.2
```

---

## TAREFA 2: Modificar Template `dashboard.html`

### **Instru√ß√£o:** Substitua o bloco do header (linhas 8-45) pelo c√≥digo abaixo.

```html
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-money-check-alt text-success me-2"></i>
                        Folha de Pagamento
                    </h1>
                    <p class="text-muted small mb-0">M√≥dulo 6 - Sistema de Folha Autom√°tica</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Seletor de Compet√™ncia -->
                    <div>
                        <label class="form-label small mb-1">Compet√™ncia:</label>
                        <select class="form-select form-select-sm" style="min-width: 180px;" onchange="window.location.href='{{ url_for('folha.dashboard') }}?competencia=' + this.value">
                            {% for comp in competencias %}
                            <option value="{{ comp.valor }}" {% if comp.valor == comp_selecionada %}selected{% endif %}>
                                {{ comp.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    {% if not parametros_configurados %}
                    <div>
                        <label class="form-label small mb-1">&nbsp;</label>
                        <a href="{{ url_for('folha.parametros_legais') }}" class="btn btn-warning btn-sm d-block">
                            <i class="fas fa-cog me-1"></i>
                            Configurar Par√¢metros
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Bot√£o de Processar -->
                    <div>
                        <label class="form-label small mb-1">&nbsp;</label>
                        <div class="btn-group d-block">
                            <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-calculator me-1"></i>
                                Processar Folha
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="processarFolha({{ mes_referencia.year }}, {{ mes_referencia.month }})">
                                    <i class="fas fa-play me-1"></i>
                                    Processar {{ mes_referencia.strftime('%B/%Y').capitalize() }}
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="processarFolha({{ mes_referencia.year }}, {{ mes_referencia.month }}, true)">
                                    <i class="fas fa-redo me-1"></i>
                                    Reprocessar {{ mes_referencia.strftime('%B/%Y').capitalize() }}
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
```

---

## TAREFA 3: Adicionar Indicador Visual da Compet√™ncia Selecionada

### **Instru√ß√£o:** Logo ap√≥s o header, adicione um badge informativo (antes da linha 47 - "M√©tricas Principais").

```html
    <!-- Indicador de Compet√™ncia -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
                <i class="fas fa-calendar-alt me-2"></i>
                <div>
                    <strong>Compet√™ncia Selecionada:</strong> {{ mes_referencia.strftime('%B de %Y').capitalize() }}
                    {% if folhas_processadas > 0 %}
                    <span class="badge bg-success ms-2">
                        <i class="fas fa-check me-1"></i>
                        {{ folhas_processadas }} folha(s) processada(s)
                    </span>
                    {% else %}
                    <span class="badge bg-warning ms-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Nenhuma folha processada
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
```

---

## TAREFA 4: Melhorar Feedback Visual no Processamento

### **Instru√ß√£o:** Adicione CSS customizado no final do template (antes do `{% endblock %}`).

```html
{% block extra_css %}
<style>
    /* Estilo para seletor de compet√™ncia */
    .form-select-sm {
        font-size: 0.875rem;
        padding: 0.375rem 2rem 0.375rem 0.75rem;
    }
    
    /* Badge de status */
    .alert-info {
        background-color: #e7f3ff;
        border-color: #b3d9ff;
        color: #004085;
    }
    
    /* Anima√ß√£o de loading durante processamento */
    .processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .processing-overlay.active {
        display: flex;
    }
    
    .processing-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Melhorar feedback visual durante processamento
    function processarFolha(ano, mes, reprocessar = false) {
        // Mostrar overlay de loading
        const overlay = document.createElement('div');
        overlay.className = 'processing-overlay active';
        overlay.innerHTML = `
            <div class="processing-content">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Processando...</span>
                </div>
                <h5>${reprocessar ? 'Reprocessando' : 'Processando'} folha de pagamento...</h5>
                <p class="text-muted mb-0">Aguarde, isso pode levar alguns segundos.</p>
            </div>
        `;
        document.body.appendChild(overlay);
        
        // Criar formul√°rio e submeter
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/folha/processar/${ano}/${mes}`;
        
        if (reprocessar) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'reprocessar';
            input.value = 'true';
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}
```

---

## VALIDA√á√ÉO

Ap√≥s aplicar as altera√ß√µes:

### **Teste 1: Seletor de Compet√™ncia**
1. [ ] Acessar `/folha/dashboard`
2. [ ] Verificar que o seletor mostra 15 op√ß√µes (12 meses passados + m√™s atual + 2 futuros)
3. [ ] Selecionar "Setembro/2025"
4. [ ] Verificar que a URL muda para `/folha/dashboard?competencia=2025-09`
5. [ ] Verificar que o t√≠tulo do bot√£o "Processar" muda para "Processar Setembro/2025"

### **Teste 2: Processamento de Compet√™ncia Diferente**
1. [ ] Selecionar "Agosto/2025" no seletor
2. [ ] Clicar em "Processar Agosto/2025"
3. [ ] Verificar que a folha √© processada para Agosto/2025
4. [ ] Verificar que o badge mostra "X folha(s) processada(s)"

### **Teste 3: Compara√ß√£o de Per√≠odos**
1. [ ] Processar folha de Setembro/2025
2. [ ] Processar folha de Outubro/2025
3. [ ] Selecionar Outubro/2025 no seletor
4. [ ] Verificar que a varia√ß√£o percentual √© calculada corretamente (comparando com Setembro)

### **Teste 4: Valida√ß√£o de Par√¢metros**
1. [ ] Selecionar compet√™ncia de 2024 (ano passado)
2. [ ] Se n√£o houver par√¢metros configurados para 2024, verificar mensagem de aviso
3. [ ] Clicar em "Configurar Par√¢metros"
4. [ ] Criar par√¢metros para 2024
5. [ ] Voltar ao dashboard e processar folha de 2024

---

## RESULTADO ESPERADO

### **Antes:**
```
[Processar Folha ‚ñº]
  ‚îú‚îÄ Processar October/2025    ‚Üê Fixo
  ‚îî‚îÄ Reprocessar October/2025  ‚Üê Fixo
```

### **Depois:**
```
Compet√™ncia: [Outubro/2025 ‚ñº]  [Processar Folha ‚ñº]
             [Janeiro/2024   ]    ‚îú‚îÄ Processar Outubro/2025  ‚Üê Din√¢mico
             [Fevereiro/2024 ]    ‚îî‚îÄ Reprocessar Outubro/2025
             ...
             [Outubro/2025   ] ‚Üê Selecionado
             [Novembro/2025  ]
             [Dezembro/2025  ]
```

**Funcionalidades:**
- ‚úÖ Seletor com 15 compet√™ncias (12 passadas + 1 atual + 2 futuras)
- ‚úÖ URL com query string: `/folha/dashboard?competencia=2025-10`
- ‚úÖ KPIs atualizam conforme compet√™ncia selecionada
- ‚úÖ Bot√£o "Processar" mostra m√™s correto dinamicamente
- ‚úÖ Valida√ß√£o de par√¢metros legais por ano
- ‚úÖ Badge visual mostrando status do processamento
- ‚úÖ Overlay de loading durante processamento
- ‚úÖ Compara√ß√£o autom√°tica com m√™s anterior

---

## RESUMO DAS ALTERA√á√ïES

| Arquivo | Linhas Modificadas | Tipo | Descri√ß√£o |
|---|---|---|---|
| `folha_pagamento_views.py` | 35-105 (70 linhas) | Refatora√ß√£o | Adicionar l√≥gica de compet√™ncias |
| `dashboard.html` | 8-45 (37 linhas) | Template | Adicionar seletor visual |
| `dashboard.html` | Nova se√ß√£o | Template | Badge informativo de compet√™ncia |
| `dashboard.html` | Nova se√ß√£o | CSS/JS | Feedback visual de processamento |

**Total:** ~150 linhas de c√≥digo

---

**Resultado:** Dashboard com seletor de compet√™ncia totalmente funcional! üéØ

