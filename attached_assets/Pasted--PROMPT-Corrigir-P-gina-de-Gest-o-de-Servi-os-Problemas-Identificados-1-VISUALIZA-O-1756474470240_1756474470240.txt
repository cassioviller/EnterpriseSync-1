# PROMPT: Corrigir Página de Gestão de Serviços

## Problemas Identificados

### 1. VISUALIZAÇÃO HORRÍVEL DA LISTA
**Problema:** Layout básico, sem design moderno, informações desorganizadas
**Solução:** Aplicar design moderno consistente com outras páginas

### 2. ERRO AO CRIAR NOVO SERVIÇO  
**Problema:** "ERR_TOO_MANY_REDIRECTS" ao clicar em "+ Novo Serviço"
**Solução:** Corrigir rota e redirecionamentos

### 3. FALTA CAMPOS PARA SUBATIVIDADES
**Problema:** Formulário só tem campo para serviço, não para subatividades
**Solução:** Criar formulário completo com gestão de subatividades

## Soluções Detalhadas

### 1. REDESIGN DA LISTA DE SERVIÇOS

#### HEADER MODERNO:
```html
<div class="page-header">
    <div class="header-content">
        <div class="header-icon">
            <i class="fas fa-cogs"></i>
        </div>
        <div class="header-text">
            <h1>Gestão de Serviços</h1>
            <p>Configure os serviços e subatividades do seu sistema</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="btn-primary" onclick="abrirModalNovoServico()">
            <i class="fas fa-plus"></i> Novo Serviço
        </button>
    </div>
</div>
```

#### CARDS DE ESTATÍSTICAS:
```html
<div class="stats-dashboard">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-cogs"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">3</div>
            <div class="stat-label">Serviços Ativos</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-tasks"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">11</div>
            <div class="stat-label">Subatividades</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-layer-group"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">3</div>
            <div class="stat-label">Categorias</div>
        </div>
    </div>
</div>
```

#### LISTA DE SERVIÇOS MODERNA:
```html
<div class="servicos-grid">
    <!-- Card de Serviço -->
    <div class="servico-card">
        <div class="servico-header">
            <div class="servico-info">
                <h3 class="servico-nome">Estrutura Metálica</h3>
                <span class="servico-categoria">Estrutural</span>
            </div>
            <div class="servico-actions">
                <button class="btn-icon" onclick="editarServico(1)">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-danger" onclick="excluirServico(1)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="servico-body">
            <p class="servico-descricao">
                Montagem completa de estruturas metálicas incluindo pilares, vigas e contraventamentos
            </p>
            
            <div class="subatividades-preview">
                <div class="subatividades-header">
                    <i class="fas fa-tasks"></i>
                    <span>Subatividades (4)</span>
                    <button class="btn-toggle" onclick="toggleSubatividades(1)">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <div class="subatividades-lista" id="subatividades-1" style="display: none;">
                    <div class="subatividade-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Montagem de Pilares</span>
                    </div>
                    <div class="subatividade-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Instalação de Vigas</span>
                    </div>
                    <div class="subatividade-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Contraventamentos</span>
                    </div>
                    <div class="subatividade-item">
                        <i class="fas fa-plus"></i>
                        <span class="add-subatividade">Adicionar subatividade</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Repetir para outros serviços -->
</div>
```

### 2. CORRIGIR ERRO DE REDIRECIONAMENTO

#### PROBLEMA: ERR_TOO_MANY_REDIRECTS
**Causa provável:** Loop de redirecionamento na rota

#### SOLUÇÃO: Corrigir rotas
```python
# routes/servicos.py

@servicos_bp.route('/servicos')
@login_required
def lista_servicos():
    """Lista todos os serviços - NÃO redirecionar"""
    servicos = Servico.query.all()
    return render_template('servicos/lista.html', servicos=servicos)

@servicos_bp.route('/servicos/novo', methods=['GET'])
@login_required
def novo_servico_form():
    """Exibe formulário para novo serviço - NÃO redirecionar"""
    return render_template('servicos/novo.html')

@servicos_bp.route('/servicos/novo', methods=['POST'])
@login_required
def criar_servico():
    """Processa criação do serviço"""
    try:
        # Processar dados do formulário
        nome = request.form.get('nome')
        descricao = request.form.get('descricao')
        categoria = request.form.get('categoria')
        
        # Criar serviço
        servico = Servico(nome=nome, descricao=descricao, categoria=categoria)
        db.session.add(servico)
        db.session.flush()  # Para obter o ID
        
        # Processar subatividades
        subatividades = request.form.getlist('subatividades[]')
        for sub_nome in subatividades:
            if sub_nome.strip():
                subatividade = Subatividade(nome=sub_nome, servico_id=servico.id)
                db.session.add(subatividade)
        
        db.session.commit()
        flash('Serviço criado com sucesso!', 'success')
        return redirect(url_for('servicos.lista_servicos'))
        
    except Exception as e:
        db.session.rollback()
        flash(f'Erro ao criar serviço: {str(e)}', 'error')
        return redirect(url_for('servicos.novo_servico_form'))
```

### 3. FORMULÁRIO COMPLETO COM SUBATIVIDADES

#### MODAL PARA NOVO SERVIÇO:
```html
<div class="modal fade" id="modalNovoServico" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Novo Serviço
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form id="formNovoServico" method="POST" action="/servicos/novo">
                <div class="modal-body">
                    <!-- Informações do Serviço -->
                    <div class="section-header">
                        <h6><i class="fas fa-info-circle"></i> Informações do Serviço</h6>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="nome">Nome do Serviço *</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="categoria">Categoria</label>
                                <select class="form-control" id="categoria" name="categoria">
                                    <option value="Estrutural">Estrutural</option>
                                    <option value="Acabamento">Acabamento</option>
                                    <option value="Instalações">Instalações</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao">Descrição</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="3"></textarea>
                    </div>
                    
                    <!-- Subatividades -->
                    <div class="section-header">
                        <h6><i class="fas fa-tasks"></i> Subatividades</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarSubatividade()">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    
                    <div id="subatividades-container">
                        <div class="subatividade-input">
                            <div class="input-group">
                                <input type="text" class="form-control" name="subatividades[]" placeholder="Nome da subatividade">
                                <button type="button" class="btn btn-outline-danger" onclick="removerSubatividade(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Dica:</strong> Adicione todas as subatividades que fazem parte deste serviço. 
                        Elas aparecerão nos RDOs quando este serviço for selecionado para uma obra.
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Serviço
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
```

#### JAVASCRIPT PARA SUBATIVIDADES:
```javascript
function adicionarSubatividade() {
    const container = document.getElementById('subatividades-container');
    const novaSubatividade = document.createElement('div');
    novaSubatividade.className = 'subatividade-input';
    novaSubatividade.innerHTML = `
        <div class="input-group">
            <input type="text" class="form-control" name="subatividades[]" placeholder="Nome da subatividade">
            <button type="button" class="btn btn-outline-danger" onclick="removerSubatividade(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(novaSubatividade);
}

function removerSubatividade(button) {
    const container = document.getElementById('subatividades-container');
    if (container.children.length > 1) {
        button.closest('.subatividade-input').remove();
    }
}

function abrirModalNovoServico() {
    const modal = new bootstrap.Modal(document.getElementById('modalNovoServico'));
    modal.show();
}

function toggleSubatividades(servicoId) {
    const lista = document.getElementById(`subatividades-${servicoId}`);
    const icon = event.target.querySelector('i') || event.target;
    
    if (lista.style.display === 'none') {
        lista.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        lista.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}
```

### 4. CSS MODERNO

```css
/* Header da página */
.page-header {
    background: linear-gradient(135deg, #2d5a27 0%, #4a7c59 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Grid de serviços */
.servicos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 2rem;
}

/* Cards de serviços */
.servico-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: transform 0.3s ease;
}

.servico-card:hover {
    transform: translateY(-5px);
}

.servico-header {
    background: #f8f9fa;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.servico-nome {
    margin: 0;
    color: #2d5a27;
    font-weight: 700;
}

.servico-categoria {
    background: #28a745;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
}

/* Subatividades */
.subatividades-preview {
    margin-top: 1rem;
}

.subatividades-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
}

.subatividade-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e9ecef;
}

.subatividade-item:last-child {
    border-bottom: none;
}

/* Modal */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1.5rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.subatividade-input {
    margin-bottom: 1rem;
}
```

## Resultado Final

✅ **Lista Moderna:** Cards organizados com design profissional
✅ **Sem Erros:** Rotas corrigidas, sem redirecionamentos em loop
✅ **Formulário Completo:** Campos para serviço E subatividades
✅ **Gestão Dinâmica:** Adicionar/remover subatividades no formulário
✅ **Interface Intuitiva:** Modal para criação, expansão de subatividades
✅ **Consistência Visual:** Mesmo padrão das outras páginas do sistema

A página ficará profissional, funcional e fácil de usar!

