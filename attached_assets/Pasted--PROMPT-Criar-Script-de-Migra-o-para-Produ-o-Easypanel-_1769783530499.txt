# üîß PROMPT: Criar Script de Migra√ß√£o para Produ√ß√£o (Easypanel)

## üéØ Objetivo

Criar um script de migra√ß√£o que possa ser executado no ambiente de **produ√ß√£o (Easypanel)** via Flask CLI, j√° que voc√™ n√£o tem acesso direto ao terminal de produ√ß√£o.

## ‚ö†Ô∏è IMPORTANTE

O ambiente de **desenvolvimento (Replit)** √© diferente do ambiente de **produ√ß√£o (Easypanel)**. Voc√™ precisa criar um script que possa ser executado remotamente via comando Flask no Easypanel.

---

## üìã TAREFA: Criar Comando Flask para Migra√ß√£o

Crie um arquivo `migrate_geofencing.py` na raiz do projeto com o seguinte conte√∫do:

```python
"""
Comando Flask para executar migra√ß√£o de geofencing em produ√ß√£o
Uso: flask migrate-geofencing
"""
from app import app, db
from flask.cli import with_appcontext
import click

@app.cli.command('migrate-geofencing')
@with_appcontext
def migrate_geofencing():
    """Executa a migra√ß√£o de geofencing adicionando colunas nas tabelas obra e registro_ponto"""
    
    print("=" * 60)
    print("INICIANDO MIGRA√á√ÉO DE GEOFENCING")
    print("=" * 60)
    
    try:
        # Obter conex√£o direta com o banco
        connection = db.engine.raw_connection()
        cursor = connection.cursor()
        
        # ===== MIGRA√á√ÉO DA TABELA OBRA =====
        print("\n[1/2] Migrando tabela OBRA...")
        
        # Verificar se as colunas j√° existem
        cursor.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name='obra' AND column_name IN ('latitude', 'longitude', 'raio_geofence_metros')
        """)
        existing_columns = [row[0] for row in cursor.fetchall()]
        
        if 'latitude' not in existing_columns:
            print("  ‚Üí Adicionando coluna 'latitude'...")
            cursor.execute('ALTER TABLE obra ADD COLUMN latitude DOUBLE PRECISION')
            print("  ‚úÖ Coluna 'latitude' adicionada!")
        else:
            print("  ‚ö†Ô∏è  Coluna 'latitude' j√° existe, pulando...")
        
        if 'longitude' not in existing_columns:
            print("  ‚Üí Adicionando coluna 'longitude'...")
            cursor.execute('ALTER TABLE obra ADD COLUMN longitude DOUBLE PRECISION')
            print("  ‚úÖ Coluna 'longitude' adicionada!")
        else:
            print("  ‚ö†Ô∏è  Coluna 'longitude' j√° existe, pulando...")
        
        if 'raio_geofence_metros' not in existing_columns:
            print("  ‚Üí Adicionando coluna 'raio_geofence_metros'...")
            cursor.execute('ALTER TABLE obra ADD COLUMN raio_geofence_metros INTEGER DEFAULT 100')
            print("  ‚úÖ Coluna 'raio_geofence_metros' adicionada!")
        else:
            print("  ‚ö†Ô∏è  Coluna 'raio_geofence_metros' j√° existe, pulando...")
        
        # ===== MIGRA√á√ÉO DA TABELA REGISTRO_PONTO =====
        print("\n[2/2] Migrando tabela REGISTRO_PONTO...")
        
        # Verificar se as colunas j√° existem
        cursor.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name='registro_ponto' AND column_name IN ('latitude', 'longitude', 'distancia_obra_metros')
        """)
        existing_columns_ponto = [row[0] for row in cursor.fetchall()]
        
        if 'latitude' not in existing_columns_ponto:
            print("  ‚Üí Adicionando coluna 'latitude'...")
            cursor.execute('ALTER TABLE registro_ponto ADD COLUMN latitude DOUBLE PRECISION')
            print("  ‚úÖ Coluna 'latitude' adicionada!")
        else:
            print("  ‚ö†Ô∏è  Coluna 'latitude' j√° existe, pulando...")
        
        if 'longitude' not in existing_columns_ponto:
            print("  ‚Üí Adicionando coluna 'longitude'...")
            cursor.execute('ALTER TABLE registro_ponto ADD COLUMN longitude DOUBLE PRECISION')
            print("  ‚úÖ Coluna 'longitude' adicionada!")
        else:
            print("  ‚ö†Ô∏è  Coluna 'longitude' j√° existe, pulando...")
        
        if 'distancia_obra_metros' not in existing_columns_ponto:
            print("  ‚Üí Adicionando coluna 'distancia_obra_metros'...")
            cursor.execute('ALTER TABLE registro_ponto ADD COLUMN distancia_obra_metros DOUBLE PRECISION')
            print("  ‚úÖ Coluna 'distancia_obra_metros' adicionada!")
        else:
            print("  ‚ö†Ô∏è  Coluna 'distancia_obra_metros' j√° existe, pulando...")
        
        # Commit das mudan√ßas
        connection.commit()
        
        print("\n" + "=" * 60)
        print("‚úÖ MIGRA√á√ÉO CONCLU√çDA COM SUCESSO!")
        print("=" * 60)
        print("\nüìã Resumo:")
        print("  ‚Ä¢ Tabela 'obra': 3 colunas de geofencing")
        print("  ‚Ä¢ Tabela 'registro_ponto': 3 colunas de localiza√ß√£o")
        print("\nüöÄ O sistema de geofencing est√° pronto para uso!")
        
    except Exception as e:
        connection.rollback()
        print("\n" + "=" * 60)
        print("‚ùå ERRO NA MIGRA√á√ÉO!")
        print("=" * 60)
        print(f"Erro: {str(e)}")
        print("\n‚ö†Ô∏è  As mudan√ßas foram revertidas (rollback)")
        raise
    
    finally:
        cursor.close()
        connection.close()


if __name__ == '__main__':
    with app.app_context():
        migrate_geofencing()
```

---

## üìã Como o Usu√°rio Vai Executar no Easypanel

Ap√≥s criar o arquivo, o usu√°rio executar√° no terminal do Easypanel:

```bash
flask migrate-geofencing
```

Ou, se necess√°rio especificar o app:

```bash
python -m flask migrate-geofencing
```

---

## ‚úÖ Vantagens deste M√©todo

1. ‚úÖ **Seguro**: Verifica se as colunas j√° existem antes de adicionar
2. ‚úÖ **Rollback autom√°tico**: Se der erro, reverte tudo
3. ‚úÖ **Logs detalhados**: Mostra exatamente o que est√° fazendo
4. ‚úÖ **Idempotente**: Pode ser executado m√∫ltiplas vezes sem problemas
5. ‚úÖ **Funciona em produ√ß√£o**: N√£o precisa de acesso ao terminal, s√≥ executar o comando Flask

---

## üéØ Resultado Esperado

Ao executar o comando, o usu√°rio ver√°:

```
============================================================
INICIANDO MIGRA√á√ÉO DE GEOFENCING
============================================================

[1/2] Migrando tabela OBRA...
  ‚Üí Adicionando coluna 'latitude'...
  ‚úÖ Coluna 'latitude' adicionada!
  ‚Üí Adicionando coluna 'longitude'...
  ‚úÖ Coluna 'longitude' adicionada!
  ‚Üí Adicionando coluna 'raio_geofence_metros'...
  ‚úÖ Coluna 'raio_geofence_metros' adicionada!

[2/2] Migrando tabela REGISTRO_PONTO...
  ‚Üí Adicionando coluna 'latitude'...
  ‚úÖ Coluna 'latitude' adicionada!
  ‚Üí Adicionando coluna 'longitude'...
  ‚úÖ Coluna 'longitude' adicionada!
  ‚Üí Adicionando coluna 'distancia_obra_metros'...
  ‚úÖ Coluna 'distancia_obra_metros' adicionada!

============================================================
‚úÖ MIGRA√á√ÉO CONCLU√çDA COM SUCESSO!
============================================================

üìã Resumo:
  ‚Ä¢ Tabela 'obra': 3 colunas de geofencing
  ‚Ä¢ Tabela 'registro_ponto': 3 colunas de localiza√ß√£o

üöÄ O sistema de geofencing est√° pronto para uso!
```

---

## üìù Pr√≥ximos Passos para o Usu√°rio

1. Fazer commit e push do arquivo `migrate_geofencing.py`
2. Fazer deploy no Easypanel
3. Acessar o terminal do container no Easypanel
4. Executar: `flask migrate-geofencing`
5. Reiniciar o servidor Flask
6. Testar o sistema de geofencing

‚úÖ Pronto! O geofencing estar√° funcionando em produ√ß√£o!
