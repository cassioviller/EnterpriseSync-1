# An√°lise Completa de Erros - Sistema RDO em Produ√ß√£o

## Resumo Executivo

O sistema de Relat√≥rios Di√°rios de Obra (RDO) est√° enfrentando **m√∫ltiplos erros cr√≠ticos em produ√ß√£o** que impedem o funcionamento normal da aplica√ß√£o. Foram identificados **tr√™s tipos principais de problemas**:

1. **Coluna `admin_id` inexistente** em tabelas cr√≠ticas
2. **Erro de c√°lculo de m√©tricas do RDO** com coluna `admin_id` 
3. **Erro de transa√ß√£o SQL abortada** ao consultar servi√ßos e subatividades
4. **Interface quebrada** com mensagem "Erro ao carregar RDO"

---

## 1. Erro: Coluna `rdo_mao_obra.admin_id` n√£o existe

### 1.1 Descri√ß√£o do Erro

**Erro identificado nas imagens 1:**
```
psycopg2.errors.UndefinedColumn: column rdo_mao_obra.admin_id does not exist
LINE 2: FROM (SELECT rdo_mao_obra.id AS rdo_mao_obra_id, rdo_mao_obr...
```

**SQL completo gerado:**
```sql
SELECT count(*) AS count_1
FROM (
    SELECT rdo_mao_obra.id AS rdo_mao_obra_id, 
           rdo_mao_obra.admin_id AS rdo_mao_obra_admin_id,  -- COLUNA N√ÉO EXISTE
           rdo_mao_obra.rdo_id AS rdo_mao_obra_rdo_id, 
           rdo_mao_obra.funcionario_id AS rdo_mao_obra_funcionario_id, 
           rdo_mao_obra.funcao_exercida AS rdo_mao_obra_funcao_exercida, 
           rdo_mao_obra.horas_trabalhadas AS rdo_mao_obra_horas_trabalhadas
    FROM rdo_mao_obra
    WHERE rdo_mao_obra.rdo_id = %(rdo_id_1)s
) AS anon_1
```

**Par√¢metros:**
- `rdo_id_1`: 120, 119, 118

### 1.2 Contexto do Erro

Este erro ocorre ao tentar calcular m√©tricas do RDO, especificamente ao contar registros de m√£o de obra. O SQLAlchemy est√° tentando selecionar a coluna `admin_id` que n√£o existe na tabela `rdo_mao_obra`.

### 1.3 Impacto

- ‚ùå **C√°lculo de m√©tricas do RDO quebrado**
- ‚ùå **Imposs√≠vel visualizar estat√≠sticas de m√£o de obra**
- ‚ùå **Dashboards e relat√≥rios n√£o funcionam**
- ‚ùå **Afeta m√∫ltiplos RDOs** (IDs: 118, 119, 120)

---

## 2. Erro: Transa√ß√£o SQL Abortada em `rdo_servico_subatividade`

### 2.1 Descri√ß√£o do Erro

**Erro identificado na imagem 2:**
```
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, 
commands ignored until end of transaction block
```

**SQL que causou o erro inicial:**
```sql
SELECT count(*) AS count_1
FROM (
    SELECT rdo_servico_subatividade.id AS rdo_servico_subatividade_id, 
           rdo_servico_subatividade.rdo_id AS rdo_servico_subatividade_rdo_id, 
           rdo_servico_subatividade.servico_id AS rdo_servico_subatividade_servico_id, 
           rdo_servico_subatividade.nome_subatividade AS rdo_servico_subatividade_nome_subatividade, 
           rdo_servico_subatividade.descricao_subatividade AS rdo_servico_subatividade_descricao_subatividade, 
           rdo_servico_subatividade.percentual_conclusao AS rdo_servico_subatividade_percentual_conclusao, 
           rdo_servico_subatividade.percentual_anterior AS rdo_servico_subatividade_percentual_anterior, 
           rdo_servico_subatividade.incremento_dia AS rdo_servico_subatividade_incremento_dia, 
           rdo_servico_subatividade.observacoes_tecnicas AS rdo_servico_subatividade_observacoes_tecnicas, 
           rdo_servico_subatividade.ordem_execucao AS rdo_servico_subatividade_ordem_execucao, 
           rdo_servico_subatividade.ativo AS rdo_servico_subatividade_ativo, 
           rdo_servico_subatividade.admin_id AS rdo_servico_subatividade_admin_id, 
           rdo_servico_subatividade.created_at AS rdo_servico_subatividade_created_at, 
           rdo_servico_subatividade.updated_at AS rdo_servico_subatividade_updated_at
    FROM rdo_servico_subatividade
    WHERE rdo_servico_subatividade.rdo_id = %(rdo_id_1)s
) AS anon_1
```

**Par√¢metros:**
- `rdo_id_1`: 112, 110, 106

### 2.2 Contexto do Erro

Este √© um **erro em cascata**. Um erro anterior (provavelmente relacionado a `admin_id`) causou o abort da transa√ß√£o PostgreSQL. Todas as queries subsequentes na mesma transa√ß√£o falham com este erro at√© que a transa√ß√£o seja finalizada (COMMIT ou ROLLBACK).

### 2.3 An√°lise da Tabela `rdo_servico_subatividade`

**Verifica√ß√£o no JSON fornecido:**

Analisando o arquivo `rdo_servico_subatividade(4).json`, **a coluna `admin_id` EXISTE** nos dados:

```json
{
  "id": 964,
  "rdo_id": 90,
  "servico_id": 33,
  "nome_subatividade": "1. Detalhamento do projeto",
  "admin_id": 2,  // ‚úÖ COLUNA EXISTE
  "created_at": "2025-10-10 12:57:27.228746",
  "updated_at": "2025-10-10 12:57:27.22875"
}
```

**Conclus√£o:** A tabela `rdo_servico_subatividade` possui a coluna `admin_id` no banco de dados. O erro n√£o √© causado por essa tabela, mas por um erro anterior na transa√ß√£o.

### 2.4 Impacto

- ‚ùå **Consultas de servi√ßos e subatividades falham**
- ‚ùå **Efeito cascata** - todas as queries na transa√ß√£o falham
- ‚ùå **Imposs√≠vel visualizar progresso de servi√ßos**
- ‚ùå **Afeta RDOs** (IDs: 106, 110, 112)

---

## 3. Erro na Interface: "Erro ao carregar RDO"

### 3.1 Descri√ß√£o do Erro

**Erro identificado na imagem 3:**

A interface do sistema mostra uma mensagem de erro em vermelho:

```
Erro ao carregar RDO.
```

Esta mensagem aparece na p√°gina de **Relat√≥rios Di√°rios de Obra**, impedindo o usu√°rio de visualizar ou editar RDOs.

### 3.2 Contexto

A p√°gina mostra:
- ‚úÖ Filtros funcionando (Obra, Status, Funcion√°rio, Per√≠odo, Ordena√ß√£o)
- ‚úÖ Lista de RDOs carregada (268.25 - Madrid Open Mall, 192.25 - GVC Mauricio)
- ‚úÖ Cards de RDO exibindo informa√ß√µes b√°sicas
- ‚ùå **Erro ao tentar carregar detalhes do RDO**

### 3.3 Causa Prov√°vel

O erro na interface √© consequ√™ncia dos erros de banco de dados identificados anteriormente. Quando o usu√°rio tenta:
- Visualizar detalhes de um RDO
- Editar um RDO
- Calcular m√©tricas do RDO

O backend falha devido aos erros de SQL, e a mensagem gen√©rica "Erro ao carregar RDO" √© exibida.

### 3.4 Impacto

- ‚ùå **Usu√°rios n√£o conseguem visualizar RDOs**
- ‚ùå **Imposs√≠vel editar RDOs existentes**
- ‚ùå **Experi√™ncia do usu√°rio comprometida**
- ‚ùå **Perda de produtividade da equipe**

---

## 4. Tabela Consolidada de Problemas

| Tabela | Coluna `admin_id` no Modelo | Coluna `admin_id` no DB | Status | Severidade |
|--------|----------------------------|------------------------|--------|------------|
| `rdo` | ‚úÖ Sim | ‚úÖ Sim | ‚úÖ OK | - |
| `rdo_servico_subatividade` | ‚úÖ Sim | ‚úÖ Sim | ‚úÖ OK | - |
| `rdo_mao_obra` | ‚úÖ Sim | ‚ùå **N√£o** | ‚ùå **ERRO** | üî¥ **CR√çTICO** |
| `funcao` | ‚úÖ Sim | ‚ùå **N√£o** | ‚ùå **ERRO** | üî¥ **CR√çTICO** |
| `registro_alimentacao` | ‚úÖ Sim | ‚ùå **N√£o** | ‚ùå **ERRO** | üî¥ **CR√çTICO** |

---

## 5. An√°lise de Causa Raiz

### 5.1 Padr√£o Identificado

Existe um **padr√£o claro** de inconsist√™ncia:

1. **Algumas tabelas t√™m `admin_id`** no banco de dados (rdo, rdo_servico_subatividade)
2. **Outras tabelas N√ÉO t√™m `admin_id`** no banco de dados (rdo_mao_obra, funcao, registro_alimentacao)
3. **Todos os modelos SQLAlchemy t√™m `admin_id`** definido

### 5.2 Hip√≥tese Principal

**Migration parcialmente executada:**

Provavelmente foi criada uma migration para adicionar a coluna `admin_id` em todas as tabelas do sistema, mas:

1. ‚úÖ A migration foi executada com sucesso em **algumas tabelas** (rdo, rdo_servico_subatividade)
2. ‚ùå A migration **falhou ou foi interrompida** antes de completar todas as tabelas
3. ‚ùå O c√≥digo foi deployado assumindo que todas as tabelas teriam a coluna
4. ‚ùå N√£o houve valida√ß√£o de schema antes do deploy em produ√ß√£o

### 5.3 Evid√™ncias

1. **Consist√™ncia nos dados:** Todas as tabelas que t√™m `admin_id` possuem o valor `2` consistentemente
2. **Timestamps similares:** As tabelas foram criadas/atualizadas em per√≠odos pr√≥ximos
3. **Padr√£o de nomenclatura:** Todas usam `admin_id` (mesmo nome de coluna)

---

## 6. Solu√ß√µes Detalhadas

### Solu√ß√£o 1: Adicionar coluna `admin_id` nas tabelas faltantes (RECOMENDADO)

#### Passo 1: Criar Migration

```python
# migrations/versions/xxxx_add_admin_id_missing_tables.py

"""Add admin_id to rdo_mao_obra, funcao, and registro_alimentacao

Revision ID: xxxx
Revises: yyyy
Create Date: 2025-10-30
"""

from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'xxxx'
down_revision = 'yyyy'
branch_labels = None
depends_on = None

def upgrade():
    # Adicionar admin_id na tabela rdo_mao_obra
    op.add_column('rdo_mao_obra', 
        sa.Column('admin_id', sa.Integer(), nullable=True)
    )
    op.create_foreign_key(
        'fk_rdo_mao_obra_admin_id', 
        'rdo_mao_obra', 
        'admin',  # ou 'usuario' - verificar nome da tabela
        ['admin_id'], 
        ['id'],
        ondelete='SET NULL'
    )
    
    # Adicionar admin_id na tabela funcao
    op.add_column('funcao', 
        sa.Column('admin_id', sa.Integer(), nullable=True)
    )
    op.create_foreign_key(
        'fk_funcao_admin_id', 
        'funcao', 
        'admin',
        ['admin_id'], 
        ['id'],
        ondelete='SET NULL'
    )
    
    # Adicionar admin_id na tabela registro_alimentacao
    op.add_column('registro_alimentacao', 
        sa.Column('admin_id', sa.Integer(), nullable=True)
    )
    op.create_foreign_key(
        'fk_registro_alimentacao_admin_id', 
        'registro_alimentacao', 
        'admin',
        ['admin_id'], 
        ['id'],
        ondelete='SET NULL'
    )

def downgrade():
    # Remover foreign keys
    op.drop_constraint('fk_registro_alimentacao_admin_id', 'registro_alimentacao', type_='foreignkey')
    op.drop_column('registro_alimentacao', 'admin_id')
    
    op.drop_constraint('fk_funcao_admin_id', 'funcao', type_='foreignkey')
    op.drop_column('funcao', 'admin_id')
    
    op.drop_constraint('fk_rdo_mao_obra_admin_id', 'rdo_mao_obra', type_='foreignkey')
    op.drop_column('rdo_mao_obra', 'admin_id')
```

#### Passo 2: Executar Migration

```bash
# Em ambiente de staging primeiro
flask db upgrade

# Verificar se funcionou
psql -d nome_do_banco -c "\d rdo_mao_obra"
psql -d nome_do_banco -c "\d funcao"
psql -d nome_do_banco -c "\d registro_alimentacao"
```

#### Passo 3: Atualizar Registros Existentes

```sql
-- Definir admin_id padr√£o para registros existentes
-- Usar o mesmo valor que as outras tabelas (admin_id = 2)

UPDATE rdo_mao_obra 
SET admin_id = 2 
WHERE admin_id IS NULL;

UPDATE funcao 
SET admin_id = 2 
WHERE admin_id IS NULL;

UPDATE registro_alimentacao 
SET admin_id = 2 
WHERE admin_id IS NULL;
```

#### Passo 4: Tornar Coluna NOT NULL (Opcional)

Se a coluna for obrigat√≥ria no modelo de neg√≥cio:

```sql
-- Ap√≥s garantir que todos os registros t√™m admin_id
ALTER TABLE rdo_mao_obra 
ALTER COLUMN admin_id SET NOT NULL;

ALTER TABLE funcao 
ALTER COLUMN admin_id SET NOT NULL;

ALTER TABLE registro_alimentacao 
ALTER COLUMN admin_id SET NOT NULL;
```

---

### Solu√ß√£o 2: Remover `admin_id` dos Modelos SQLAlchemy

Se a coluna `admin_id` n√£o for necess√°ria para o neg√≥cio, remova dos modelos:

#### Arquivo: `models.py`

```python
# ANTES
class RdoMaoObra(db.Model):
    __tablename__ = 'rdo_mao_obra'
    id = db.Column(db.Integer, primary_key=True)
    admin_id = db.Column(db.Integer, db.ForeignKey('admin.id'))  # REMOVER
    rdo_id = db.Column(db.Integer, db.ForeignKey('rdo.id'))
    funcionario_id = db.Column(db.Integer, db.ForeignKey('funcionario.id'))
    funcao_exercida = db.Column(db.String(100))
    horas_trabalhadas = db.Column(db.Numeric(5, 2))

# DEPOIS
class RdoMaoObra(db.Model):
    __tablename__ = 'rdo_mao_obra'
    id = db.Column(db.Integer, primary_key=True)
    # admin_id removido
    rdo_id = db.Column(db.Integer, db.ForeignKey('rdo.id'))
    funcionario_id = db.Column(db.Integer, db.ForeignKey('funcionario.id'))
    funcao_exercida = db.Column(db.String(100))
    horas_trabalhadas = db.Column(db.Numeric(5, 2))
```

Repetir para `Funcao` e `RegistroAlimentacao`.

**‚ö†Ô∏è Aten√ß√£o:** Esta solu√ß√£o requer tamb√©m remover `admin_id` das tabelas que j√° possuem a coluna (`rdo`, `rdo_servico_subatividade`) para manter consist√™ncia.

---

## 7. Corre√ß√£o do Erro de Transa√ß√£o Abortada

### 7.1 Problema

O erro `InFailedSqlTransaction` ocorre quando:
1. Uma query falha dentro de uma transa√ß√£o
2. O c√≥digo tenta executar outra query na mesma transa√ß√£o
3. PostgreSQL rejeita todas as queries at√© ROLLBACK

### 7.2 Solu√ß√£o: Tratamento de Erros

```python
# ANTES (c√≥digo problem√°tico)
def calcular_metricas_rdo(rdo_id):
    try:
        # Query 1 - pode falhar
        mao_obra = db.session.query(RdoMaoObra).filter_by(rdo_id=rdo_id).all()
        
        # Query 2 - falha se Query 1 falhou
        servicos = db.session.query(RdoServicoSubatividade).filter_by(rdo_id=rdo_id).all()
        
        return calcular(mao_obra, servicos)
    except Exception as e:
        # Erro n√£o √© tratado corretamente
        logger.error(f"Erro: {e}")
        return None

# DEPOIS (c√≥digo corrigido)
def calcular_metricas_rdo(rdo_id):
    try:
        # Query 1
        mao_obra = db.session.query(RdoMaoObra).filter_by(rdo_id=rdo_id).all()
        
        # Query 2
        servicos = db.session.query(RdoServicoSubatividade).filter_by(rdo_id=rdo_id).all()
        
        return calcular(mao_obra, servicos)
    except Exception as e:
        # IMPORTANTE: Fazer rollback da transa√ß√£o
        db.session.rollback()
        logger.error(f"Erro ao calcular m√©tricas do RDO {rdo_id}: {e}")
        raise  # Re-lan√ßar exce√ß√£o para tratamento superior
```

### 7.3 Melhoria: Usar Context Manager

```python
from contextlib import contextmanager

@contextmanager
def safe_transaction():
    """Context manager para garantir rollback em caso de erro"""
    try:
        yield db.session
        db.session.commit()
    except Exception:
        db.session.rollback()
        raise

# Uso
def calcular_metricas_rdo(rdo_id):
    with safe_transaction():
        mao_obra = db.session.query(RdoMaoObra).filter_by(rdo_id=rdo_id).all()
        servicos = db.session.query(RdoServicoSubatividade).filter_by(rdo_id=rdo_id).all()
        return calcular(mao_obra, servicos)
```

---

## 8. Plano de A√ß√£o Imediato

### 8.1 Hotfix Urgente (Pr√≥ximas 2 horas)

1. ‚úÖ **Criar backup do banco de dados**
   ```bash
   pg_dump -U usuario -d nome_banco > backup_pre_fix_$(date +%Y%m%d_%H%M%S).sql
   ```

2. ‚úÖ **Aplicar migration em staging**
   ```bash
   # Ambiente de staging
   flask db upgrade
   ```

3. ‚úÖ **Testar funcionalidades afetadas**
   - [ ] Visualizar RDO
   - [ ] Editar RDO
   - [ ] Calcular m√©tricas de m√£o de obra
   - [ ] Visualizar registros de alimenta√ß√£o
   - [ ] Visualizar fun√ß√µes de funcion√°rios

4. ‚úÖ **Atualizar registros existentes**
   ```sql
   UPDATE rdo_mao_obra SET admin_id = 2 WHERE admin_id IS NULL;
   UPDATE funcao SET admin_id = 2 WHERE admin_id IS NULL;
   UPDATE registro_alimentacao SET admin_id = 2 WHERE admin_id IS NULL;
   ```

5. ‚úÖ **Deploy em produ√ß√£o com janela de manuten√ß√£o**
   - Comunicar usu√°rios
   - Aplicar migration
   - Atualizar registros
   - Verificar logs
   - Testar funcionalidades cr√≠ticas

### 8.2 A√ß√µes Preventivas (Pr√≥xima semana)

1. ‚úÖ **Implementar valida√ß√£o de schema**
   ```python
   # check_schema.py
   def validate_schema():
       """Valida se modelos est√£o sincronizados com banco"""
       # Ver script completo na se√ß√£o 9
   ```

2. ‚úÖ **Adicionar testes de integra√ß√£o**
   ```python
   def test_rdo_mao_obra_columns():
       """Testa se todas as colunas do modelo existem no banco"""
       assert hasattr(RdoMaoObra, 'admin_id')
       # Verificar se coluna existe no banco
   ```

3. ‚úÖ **Melhorar tratamento de erros**
   - Adicionar rollback autom√°tico
   - Logs estruturados
   - Alertas em tempo real

4. ‚úÖ **Documentar processo de migration**
   - Checklist de deploy
   - Procedimentos de rollback
   - Testes obrigat√≥rios

---

## 9. Script de Verifica√ß√£o de Schema

```python
#!/usr/bin/env python3
"""
Script para verificar inconsist√™ncias entre modelos SQLAlchemy e banco de dados
Executar antes de cada deploy em produ√ß√£o
"""

from sqlalchemy import inspect
from app import db, app
import sys

def check_model_vs_database():
    """Verifica se todas as colunas dos modelos existem no banco"""
    
    inspector = inspect(db.engine)
    inconsistencies = []
    errors = []
    
    print("üîç Verificando consist√™ncia entre modelos e banco de dados...\n")
    
    for table_name in db.metadata.tables.keys():
        try:
            # Colunas no modelo
            model_columns = set(db.metadata.tables[table_name].columns.keys())
            
            # Colunas no banco
            db_columns = set([col['name'] for col in inspector.get_columns(table_name)])
            
            # Colunas no modelo mas n√£o no banco
            missing_in_db = model_columns - db_columns
            
            # Colunas no banco mas n√£o no modelo
            missing_in_model = db_columns - model_columns
            
            if missing_in_db or missing_in_model:
                inconsistencies.append({
                    'table': table_name,
                    'missing_in_db': list(missing_in_db),
                    'missing_in_model': list(missing_in_model)
                })
        except Exception as e:
            errors.append({
                'table': table_name,
                'error': str(e)
            })
    
    # Relat√≥rio
    if errors:
        print("‚ùå Erros ao verificar tabelas:")
        for error in errors:
            print(f"  Tabela: {error['table']}")
            print(f"  Erro: {error['error']}\n")
    
    if inconsistencies:
        print("‚ùå Inconsist√™ncias encontradas:\n")
        for issue in inconsistencies:
            print(f"üìã Tabela: {issue['table']}")
            if issue['missing_in_db']:
                print(f"  ‚ö†Ô∏è  Colunas no MODELO mas N√ÉO no BANCO: {', '.join(issue['missing_in_db'])}")
            if issue['missing_in_model']:
                print(f"  ‚ö†Ô∏è  Colunas no BANCO mas N√ÉO no MODELO: {', '.join(issue['missing_in_model'])}")
            print()
        
        print(f"\nüî¥ Total de tabelas com problemas: {len(inconsistencies)}")
        return False
    else:
        print("‚úÖ Todos os modelos est√£o sincronizados com o banco de dados!")
        return True

if __name__ == '__main__':
    with app.app_context():
        success = check_model_vs_database()
        sys.exit(0 if success else 1)
```

**Uso:**
```bash
# Executar antes de cada deploy
python check_schema.py

# Se retornar c√≥digo 1, N√ÉO fazer deploy
# Se retornar c√≥digo 0, OK para deploy
```

---

## 10. Melhorias de Mensagens de Erro

### 10.1 Problema Atual

A mensagem gen√©rica "Erro ao carregar RDO" n√£o ajuda o usu√°rio nem o desenvolvedor a entender o problema.

### 10.2 Solu√ß√£o: Mensagens Espec√≠ficas

```python
# views.py

@app.route('/rdo/<int:rdo_id>')
def visualizar_rdo(rdo_id):
    try:
        rdo = RDO.query.get_or_404(rdo_id)
        
        # Carregar m√£o de obra
        try:
            mao_obra = RdoMaoObra.query.filter_by(rdo_id=rdo_id).all()
        except Exception as e:
            logger.error(f"Erro ao carregar m√£o de obra do RDO {rdo_id}: {e}")
            flash("Erro ao carregar dados de m√£o de obra. Contate o suporte.", "error")
            mao_obra = []
        
        # Carregar servi√ßos
        try:
            servicos = RdoServicoSubatividade.query.filter_by(rdo_id=rdo_id).all()
        except Exception as e:
            logger.error(f"Erro ao carregar servi√ßos do RDO {rdo_id}: {e}")
            flash("Erro ao carregar servi√ßos. Contate o suporte.", "error")
            servicos = []
        
        return render_template('rdo_detalhes.html', 
                             rdo=rdo, 
                             mao_obra=mao_obra,
                             servicos=servicos)
    
    except Exception as e:
        logger.error(f"Erro cr√≠tico ao visualizar RDO {rdo_id}: {e}", exc_info=True)
        db.session.rollback()
        flash("Erro ao carregar RDO. Por favor, tente novamente.", "error")
        return redirect(url_for('lista_rdos'))
```

### 10.3 Logs Estruturados

```python
import logging
import json

class StructuredLogger:
    def __init__(self, logger):
        self.logger = logger
    
    def log_db_error(self, operation, table, error, context=None):
        """Log estruturado para erros de banco de dados"""
        log_data = {
            'type': 'database_error',
            'operation': operation,
            'table': table,
            'error': str(error),
            'error_type': type(error).__name__,
            'context': context or {}
        }
        self.logger.error(json.dumps(log_data))

# Uso
structured_logger = StructuredLogger(logging.getLogger(__name__))

try:
    mao_obra = RdoMaoObra.query.filter_by(rdo_id=rdo_id).all()
except Exception as e:
    structured_logger.log_db_error(
        operation='query',
        table='rdo_mao_obra',
        error=e,
        context={'rdo_id': rdo_id}
    )
```

---

## 11. Checklist de Deploy

### Antes do Deploy

- [ ] Backup do banco de dados criado
- [ ] Migration testada em ambiente de desenvolvimento
- [ ] Migration testada em ambiente de staging
- [ ] Script de verifica√ß√£o de schema executado
- [ ] Testes de integra√ß√£o passando
- [ ] Plano de rollback documentado
- [ ] Janela de manuten√ß√£o comunicada aos usu√°rios

### Durante o Deploy

- [ ] Colocar aplica√ß√£o em modo manuten√ß√£o
- [ ] Executar migration: `flask db upgrade`
- [ ] Atualizar registros existentes (scripts SQL)
- [ ] Verificar logs de erro
- [ ] Testar funcionalidades cr√≠ticas manualmente

### Ap√≥s o Deploy

- [ ] Remover modo manuten√ß√£o
- [ ] Monitorar logs por 1 hora
- [ ] Verificar m√©tricas de erro
- [ ] Confirmar com usu√°rios que sistema est√° funcionando
- [ ] Documentar li√ß√µes aprendidas

### Em Caso de Problema

- [ ] Colocar aplica√ß√£o em modo manuten√ß√£o
- [ ] Executar rollback: `flask db downgrade`
- [ ] Restaurar backup se necess√°rio
- [ ] Investigar causa raiz
- [ ] Comunicar usu√°rios

---

## 12. Conclus√£o

O sistema RDO est√° enfrentando **erros cr√≠ticos em produ√ß√£o** causados por **inconsist√™ncias entre modelos SQLAlchemy e o schema do banco de dados PostgreSQL**. Especificamente, tr√™s tabelas n√£o possuem a coluna `admin_id` que est√° definida nos modelos:

1. **`rdo_mao_obra`** - Impede c√°lculo de m√©tricas de m√£o de obra
2. **`funcao`** - Impede visualiza√ß√£o de fun√ß√µes de funcion√°rios  
3. **`registro_alimentacao`** - Impede visualiza√ß√£o de registros de alimenta√ß√£o

A **solu√ß√£o recomendada** √© adicionar a coluna `admin_id` nas tr√™s tabelas via migration, garantindo consist√™ncia com as demais tabelas do sistema (`rdo` e `rdo_servico_subatividade` j√° possuem a coluna).

Adicionalmente, √© fundamental implementar:
- ‚úÖ Valida√ß√£o autom√°tica de schema antes de deploys
- ‚úÖ Tratamento adequado de erros de transa√ß√£o SQL
- ‚úÖ Mensagens de erro mais espec√≠ficas para usu√°rios
- ‚úÖ Logs estruturados para facilitar debugging
- ‚úÖ Processo de deploy com checklist e valida√ß√µes

Com essas corre√ß√µes e melhorias, o sistema voltar√° a funcionar normalmente e estar√° mais resiliente a problemas futuros.
