# üöÄ PROMPT FINAL: Completar 4 M√≥dulos Pendentes do SIGE v9.0

**Objetivo:** Finalizar os 4 m√≥dulos incompletos (Custos, Frota, Alimenta√ß√£o e RDO) para atingir 100% de completude e deixar o sistema pronto para produ√ß√£o.

---

## üìä AN√ÅLISE DOS RELAT√ìRIOS

Baseado nos relat√≥rios **RELATORIO_TESTES_SIGE_v9.0(1).md** e **RELATORIO_MODULOS_INCOMPLETOS.md**:

### **Status Atual do Sistema:**

‚úÖ **Taxa de sucesso:** 93,6% (44/47 cen√°rios)  
‚úÖ **M√≥dulos 100% funcionais:** 11/15 (73,3%)  
‚ö†Ô∏è **M√≥dulos incompletos:** 4/15 (26,7%)  
‚úÖ **Integra√ß√µes validadas:** 6/6 (100%)  

### **M√≥dulos Incompletos:**

| M√≥dulo | Completude | Esfor√ßo Restante | Bloqueador? |
|---|---|---|---|
| **Custos** | 40% | 7 horas | ‚úÖ SIM |
| **Frota** | 60% | 5 horas | ‚úÖ SIM |
| **Alimenta√ß√£o** | 50% | 5 horas | ‚úÖ SIM |
| **RDO** | 75% | 2 horas | ‚ùå N√ÉO |

**Total de trabalho pendente:** 19 horas (2,5 dias √∫teis)

---

## üéØ PLANO DE EXECU√á√ÉO (19 HORAS)

### **DIA 1: M√ìDULO DE CUSTOS (7 HORAS)** üî¥

#### **Manh√£ (4 horas): Dashboard e Gr√°ficos**

**Tarefa 1.1 - Criar Dashboard de Custos** ‚è±Ô∏è 2h

**O que fazer:**
1. Criar rota `/custos/dashboard`
2. Implementar KPIs:
   - Total de custos do m√™s
   - Custos por categoria (M√£o de Obra, Material, Ve√≠culo, Servi√ßo, Alimenta√ß√£o)
   - Top 5 obras com mais custos
   - Evolu√ß√£o mensal (√∫ltimos 6 meses)

3. Criar template `templates/custos/dashboard.html`:
   ```html
   <!-- KPIs -->
   <div class="row">
     <div class="col-md-3">
       <div class="card">
         <h3>Total de Custos</h3>
         <p>R$ {{ total_custos }}</p>
       </div>
     </div>
     <!-- Mais KPIs... -->
   </div>
   
   <!-- Gr√°ficos -->
   <canvas id="custosPorCategoria"></canvas>
   <canvas id="evolucaoMensal"></canvas>
   ```

4. Adicionar gr√°ficos com Chart.js:
   - Gr√°fico de pizza: Custos por categoria
   - Gr√°fico de linha: Evolu√ß√£o mensal

**Crit√©rio de Sucesso:**
- [ ] Dashboard carrega em < 2s
- [ ] KPIs exibem valores corretos
- [ ] Gr√°ficos renderizam corretamente
- [ ] Multi-tenancy validado

---

**Tarefa 1.2 - Criar Gr√°ficos Interativos** ‚è±Ô∏è 2h

**O que fazer:**
1. Implementar filtros no dashboard:
   - Filtro por obra
   - Filtro por categoria
   - Filtro por per√≠odo (m√™s/ano)

2. Adicionar tabela de custos recentes:
   - √öltimos 10 custos
   - Colunas: Data, Obra, Categoria, Valor, Respons√°vel

3. Adicionar bot√£o "Exportar para Excel"

4. Implementar API `/api/custos/dashboard-data`:
   ```json
   {
     "total_custos": 125000.50,
     "custos_por_categoria": {...},
     "evolucao_mensal": [...],
     "top_obras": [...]
   }
   ```

**Crit√©rio de Sucesso:**
- [ ] Filtros funcionam corretamente
- [ ] Tabela exibe dados corretos
- [ ] Exporta√ß√£o para Excel funciona
- [ ] API retorna dados corretos

---

#### **Tarde (3 horas): Integra√ß√µes**

**Tarefa 1.3 - Integra√ß√£o com RDO** ‚è±Ô∏è 1,5h

**O que fazer:**
1. Criar event handler `rdo_finalizado` em `event_manager.py`:
   ```python
   @event_handler('rdo_finalizado')
   def criar_custo_rdo(data):
       """Cria custos automaticamente quando RDO √© finalizado"""
       rdo_id = data['rdo_id']
       rdo = RDO.query.get(rdo_id)
       
       # Criar custo de m√£o de obra
       for mao_obra in rdo.mao_obra:
           custo = CustoObra(
               obra_id=rdo.obra_id,
               tipo='mao_obra',
               valor=calcular_valor_mao_obra(mao_obra),
               data_custo=rdo.data_relatorio,
               descricao=f'M√£o de obra - {mao_obra.funcionario.nome}',
               origem='rdo',
               origem_id=rdo.id,
               admin_id=rdo.admin_id
           )
           db.session.add(custo)
       
       db.session.commit()
   ```

2. Atualizar `rdo_validator.py` para emitir evento:
   ```python
   def finalizar_rdo(rdo_id):
       rdo = RDO.query.get(rdo_id)
       rdo.status = 'Finalizado'
       db.session.commit()
       
       # Emitir evento
       EventManager.emit('rdo_finalizado', {
           'rdo_id': rdo.id,
           'obra_id': rdo.obra_id,
           'data': rdo.data_relatorio
       })
   ```

**Crit√©rio de Sucesso:**
- [ ] Evento `rdo_finalizado` √© emitido
- [ ] Handler cria custos automaticamente
- [ ] Custos t√™m origem='rdo' e origem_id correto
- [ ] Multi-tenancy preservado

---

**Tarefa 1.4 - Integra√ß√£o com Frota** ‚è±Ô∏è 1,5h

**O que fazer:**
1. Criar event handler `frota_custo_criado` em `event_manager.py`:
   ```python
   @event_handler('frota_custo_criado')
   def criar_custo_frota(data):
       """Cria custo na obra quando ve√≠culo √© usado"""
       utilizacao_id = data['utilizacao_id']
       utilizacao = FrotaUtilizacao.query.get(utilizacao_id)
       
       if utilizacao.obra_id:
           # Calcular custo (combust√≠vel + deprecia√ß√£o)
           custo_total = calcular_custo_utilizacao(utilizacao)
           
           custo = CustoObra(
               obra_id=utilizacao.obra_id,
               tipo='veiculo',
               valor=custo_total,
               data_custo=utilizacao.data_uso,
               descricao=f'Ve√≠culo {utilizacao.veiculo.placa} - {utilizacao.km_percorrido}km',
               origem='frota',
               origem_id=utilizacao.id,
               admin_id=utilizacao.admin_id
           )
           db.session.add(custo)
           db.session.commit()
   ```

2. Atualizar `frota_views.py` para emitir evento ao registrar uso

**Crit√©rio de Sucesso:**
- [ ] Evento `frota_custo_criado` √© emitido
- [ ] Handler cria custos automaticamente
- [ ] Custos t√™m origem='frota' e origem_id correto

---

### **DIA 2: M√ìDULOS FROTA E ALIMENTA√á√ÉO (10 HORAS)** üü°

#### **Manh√£ (5 horas): Frota**

**Tarefa 2.1 - Dashboard TCO (Total Cost of Ownership)** ‚è±Ô∏è 2h

**O que fazer:**
1. Criar rota `/frota/dashboard`
2. Implementar KPIs:
   - TCO por ve√≠culo (custo total / km rodado)
   - Custo m√©dio por km
   - Custo total por tipo (combust√≠vel, manuten√ß√£o, IPVA)
   - Ve√≠culos com maior custo

3. Criar gr√°ficos:
   - Gr√°fico de barras: TCO por ve√≠culo
   - Gr√°fico de pizza: Custos por tipo
   - Gr√°fico de linha: Evolu√ß√£o de custos

**Crit√©rio de Sucesso:**
- [ ] Dashboard exibe TCO correto
- [ ] Gr√°ficos renderizam
- [ ] Filtros por per√≠odo funcionam

---

**Tarefa 2.2 - Alertas de Manuten√ß√£o** ‚è±Ô∏è 2h

**O que fazer:**
1. Adicionar campos em `FrotaVeiculo`:
   ```python
   km_proxima_manutencao = db.Column(db.Integer)
   data_proxima_revisao = db.Column(db.Date)
   data_vencimento_ipva = db.Column(db.Date)
   data_vencimento_seguro = db.Column(db.Date)
   ```

2. Criar fun√ß√£o `verificar_alertas()`:
   ```python
   def verificar_alertas(veiculo):
       alertas = []
       
       # Alerta de KM
       if veiculo.km_atual >= veiculo.km_proxima_manutencao - 500:
           alertas.append({
               'tipo': 'manutencao',
               'mensagem': f'Manuten√ß√£o pr√≥xima em {veiculo.km_proxima_manutencao - veiculo.km_atual}km'
           })
       
       # Alerta de IPVA
       if veiculo.data_vencimento_ipva <= date.today() + timedelta(days=30):
           alertas.append({
               'tipo': 'ipva',
               'mensagem': 'IPVA vence em menos de 30 dias'
           })
       
       return alertas
   ```

3. Exibir alertas no dashboard com badges coloridos

**Crit√©rio de Sucesso:**
- [ ] Alertas aparecem no dashboard
- [ ] Cores corretas (verde/amarelo/vermelho)
- [ ] Notifica√ß√µes por e-mail (opcional)

---

**Tarefa 2.3 - Integra√ß√£o com EventManager** ‚è±Ô∏è 1h

**O que fazer:**
1. Emitir evento `frota_custo_criado` ao registrar uso
2. Emitir evento `frota_manutencao_vencida` quando alerta cr√≠tico
3. Registrar handler em `event_manager.py`

**Crit√©rio de Sucesso:**
- [ ] Eventos emitidos corretamente
- [ ] Handlers registrados
- [ ] Logs de eventos vis√≠veis

---

#### **Tarde (5 horas): Alimenta√ß√£o**

**Tarefa 2.4 - Dashboard de Alimenta√ß√£o** ‚è±Ô∏è 2h

**O que fazer:**
1. Criar rota `/alimentacao/dashboard`
2. Implementar KPIs:
   - Total de refei√ß√µes do m√™s
   - Custo total de alimenta√ß√£o
   - Custo m√©dio por refei√ß√£o
   - Top 5 funcion√°rios (mais refei√ß√µes)
   - Top 5 obras (mais refei√ß√µes)

3. Criar gr√°ficos:
   - Gr√°fico de barras: Refei√ß√µes por obra
   - Gr√°fico de linha: Evolu√ß√£o mensal
   - Gr√°fico de pizza: Refei√ß√µes por tipo (caf√©, almo√ßo, jantar)

**Crit√©rio de Sucesso:**
- [ ] Dashboard carrega em < 2s
- [ ] KPIs corretos
- [ ] Gr√°ficos funcionam

---

**Tarefa 2.5 - Integra√ß√£o com Financeiro** ‚è±Ô∏è 2h

**O que fazer:**
1. Criar event handler `refeicao_registrada`:
   ```python
   @event_handler('refeicao_registrada')
   def criar_conta_pagar_alimentacao(data):
       """Cria conta a pagar quando refei√ß√£o √© registrada"""
       refeicao_id = data['refeicao_id']
       refeicao = Alimentacao.query.get(refeicao_id)
       
       # Verificar se j√° existe conta para este dia/restaurante
       conta_existente = ContaPagar.query.filter_by(
           origem='alimentacao',
           origem_id=refeicao.id
       ).first()
       
       if not conta_existente:
           conta = ContaPagar(
               fornecedor_id=refeicao.restaurante_id,
               valor=refeicao.valor,
               data_vencimento=refeicao.data + timedelta(days=7),
               descricao=f'Refei√ß√£o - {refeicao.tipo}',
               origem='alimentacao',
               origem_id=refeicao.id,
               admin_id=refeicao.admin_id
           )
           db.session.add(conta)
           db.session.commit()
   ```

2. Atualizar `alimentacao_views.py` para emitir evento

**Crit√©rio de Sucesso:**
- [ ] Evento emitido ao registrar refei√ß√£o
- [ ] Conta a pagar criada automaticamente
- [ ] Fornecedor associado corretamente

---

**Tarefa 2.6 - CRUD Completo** ‚è±Ô∏è 1h

**O que fazer:**
1. Criar rotas:
   - `/alimentacao/` - Listar refei√ß√µes
   - `/alimentacao/nova` - Registrar refei√ß√£o
   - `/alimentacao/<id>/editar` - Editar
   - `/alimentacao/<id>/deletar` - Deletar

2. Criar templates correspondentes

3. Valida√ß√µes:
   - Data n√£o pode ser futura
   - Valor deve ser positivo
   - Funcion√°rio e obra obrigat√≥rios

**Crit√©rio de Sucesso:**
- [ ] CRUD completo funciona
- [ ] Valida√ß√µes aplicadas
- [ ] Multi-tenancy validado

---

### **DIA 3: RDO E VALIDA√á√ÉO FINAL (2 HORAS)** üü¢

#### **Manh√£ (2 horas): Testes E2E do RDO**

**Tarefa 3.1 - Criar Testes E2E com Playwright** ‚è±Ô∏è 2h

**O que fazer:**
1. Criar arquivo `tests/e2e/test_rdo.py`:
   ```python
   def test_criar_rdo(page):
       """Testa cria√ß√£o completa de RDO"""
       # Login
       page.goto('/login')
       page.fill('#username', 'admin@test.com')
       page.fill('#password', 'senha123')
       page.click('button[type="submit"]')
       
       # Navegar para RDO
       page.goto('/rdo/novo')
       
       # Preencher formul√°rio
       page.select_option('#obra_id', '1')
       page.fill('#data_relatorio', '2025-10-29')
       page.select_option('#clima', 'Ensolarado')
       
       # Adicionar m√£o de obra
       page.click('#add-mao-obra')
       page.select_option('#funcionario_id_0', '1')
       page.fill('#horas_trabalhadas_0', '8')
       
       # Salvar
       page.click('button[type="submit"]')
       
       # Verificar sucesso
       assert 'RDO criado com sucesso' in page.content()
   
   def test_finalizar_rdo(page):
       """Testa finaliza√ß√£o e integra√ß√£o com custos"""
       # ... (similar ao anterior)
       
       # Finalizar RDO
       page.click('#finalizar-rdo')
       
       # Verificar que custo foi criado
       page.goto('/custos/')
       assert 'M√£o de obra' in page.content()
   ```

2. Executar testes:
   ```bash
   pytest tests/e2e/test_rdo.py -v
   ```

**Crit√©rio de Sucesso:**
- [ ] Teste de cria√ß√£o passa
- [ ] Teste de finaliza√ß√£o passa
- [ ] Teste de integra√ß√£o com custos passa
- [ ] Cobertura > 90%

---

## üìã CHECKLIST FINAL DE VALIDA√á√ÉO

Ap√≥s completar todas as tarefas, validar:

### **M√≥dulo de Custos:**
- [ ] Dashboard funcional com KPIs
- [ ] Gr√°ficos renderizam corretamente
- [ ] Integra√ß√£o com RDO funciona
- [ ] Integra√ß√£o com Frota funciona
- [ ] Filtros e exporta√ß√£o funcionam

### **M√≥dulo de Frota:**
- [ ] Dashboard TCO funcional
- [ ] Alertas de manuten√ß√£o aparecem
- [ ] Integra√ß√£o com EventManager funciona
- [ ] Custos calculados corretamente

### **M√≥dulo de Alimenta√ß√£o:**
- [ ] Dashboard funcional
- [ ] CRUD completo funciona
- [ ] Integra√ß√£o com Financeiro funciona
- [ ] Conta a pagar criada automaticamente

### **M√≥dulo de RDO:**
- [ ] Testes E2E passam
- [ ] Integra√ß√£o com Custos validada
- [ ] Cobertura de testes > 90%

---

## üéØ RESULTADO ESPERADO

Ap√≥s executar este prompt, o sistema deve atingir:

‚úÖ **Taxa de sucesso:** 98%+  
‚úÖ **M√≥dulos 100% funcionais:** 15/15 (100%)  
‚úÖ **Integra√ß√µes validadas:** 9/9 (100%)  
‚úÖ **Dados de teste completos:** Todos os m√≥dulos  
‚úÖ **Status:** **PRONTO PARA PRODU√á√ÉO**  
‚úÖ **Confian√ßa de deploy:** 98%+  

---

## üìä COMPARA√á√ÉO ANTES/DEPOIS

### **ANTES (Relat√≥rio Atual):**
```
Taxa de sucesso: 93,6%
M√≥dulos 100% funcionais: 11/15 (73,3%)
M√≥dulos incompletos: 4/15 (26,7%)
Trabalho pendente: 19 horas
Status: Pronto com Ressalvas
Confian√ßa: 85%
```

### **DEPOIS (Ap√≥s Prompt):**
```
Taxa de sucesso: 98%+
M√≥dulos 100% funcionais: 15/15 (100%)
M√≥dulos incompletos: 0/15 (0%)
Trabalho pendente: 0 horas
Status: Pronto para Produ√ß√£o
Confian√ßa: 98%+
```

---

## ‚è±Ô∏è CRONOGRAMA DETALHADO

### **Dia 1 (7 horas) - Custos**
```
09:00-11:00 ‚Üí Dashboard e KPIs (2h)
11:00-13:00 ‚Üí Gr√°ficos e filtros (2h)
14:00-15:30 ‚Üí Integra√ß√£o RDO (1,5h)
15:30-17:00 ‚Üí Integra√ß√£o Frota (1,5h)
```

### **Dia 2 (10 horas) - Frota + Alimenta√ß√£o**
```
09:00-11:00 ‚Üí Dashboard TCO Frota (2h)
11:00-13:00 ‚Üí Alertas de manuten√ß√£o (2h)
14:00-15:00 ‚Üí EventManager Frota (1h)
15:00-17:00 ‚Üí Dashboard Alimenta√ß√£o (2h)
17:00-19:00 ‚Üí Integra√ß√£o Financeiro (2h)
19:00-20:00 ‚Üí CRUD Alimenta√ß√£o (1h)
```

### **Dia 3 (2 horas) - RDO**
```
09:00-11:00 ‚Üí Testes E2E RDO (2h)
```

**Total:** 19 horas (2,5 dias √∫teis)

---

## üìÅ ARQUIVOS A MODIFICAR

### **Custos:**
- `custos_views.py` (adicionar rotas de dashboard)
- `templates/custos/dashboard.html` (criar)
- `event_manager.py` (adicionar handlers)

### **Frota:**
- `frota_views.py` (adicionar dashboard TCO)
- `models.py` (adicionar campos de alerta)
- `templates/frota/dashboard.html` (criar)

### **Alimenta√ß√£o:**
- `alimentacao_views.py` (CRUD completo)
- `templates/alimentacao/dashboard.html` (criar)
- `event_manager.py` (handler de refei√ß√£o)

### **RDO:**
- `tests/e2e/test_rdo.py` (criar)

---

**Pronto para completar os 4 m√≥dulos e atingir 100% de completude!** üöÄ

Este prompt √© execut√°vel, detalhado e inclui c√≥digo pronto para copiar e colar. O Replit Agent pode seguir passo a passo para finalizar o sistema SIGE v9.0.

