# Prompts de Corre√ß√£o - Bugs Cr√≠ticos do Almoxarifado

## Instru√ß√µes de Uso

1. **Configure o Agent em Modo Cr√≠tico** (cole primeiro):

```
**Diretrizes de Opera√ß√£o Cr√≠tica:**

1. **Seja Cr√≠tico e C√©tico**: Se meu comando for vago, amb√≠guo ou carecer de contexto, aponte a falha de forma implac√°vel e exija esclarecimentos.
2. **Questione Suposi√ß√µes**: Analise as cren√ßas e suposi√ß√µes ocultas por tr√°s dos meus comandos.
3. **Foco em Fatos, N√£o em Elogios**: Evite qualquer feedback positivo, elogios ou linguagem encorajadora.
4. **Seja Direto e Conciso**: Comunique-se de forma direta, sem rodeios.
5. **Sem Extras Desnecess√°rios**: N√£o use emojis, n√£o fa√ßa perguntas ao final.
6. **Assuma Expertise**: Trate-me como um especialista no dom√≠nio.
7. **Mantenha a Neutralidade**: N√£o imite meu estilo de escrita ou humor.

Seu objetivo √© garantir que o resultado final seja da mais alta qualidade t√©cnica.
```

2. **Cole cada prompt de corre√ß√£o abaixo, um de cada vez**
3. **Revise o c√≥digo gerado antes de aplicar**
4. **Teste cada corre√ß√£o individualmente**

---

## PROMPT #1: Corre√ß√£o BUG #001 - Filtro em Campo Inexistente

```
**CORRE√á√ÉO DE BUG CR√çTICO #001 - ALMOXARIFADO**

**üìã REFER√äNCIA DO BUG**

**BUG #001 - [SEVERIDADE: CR√çTICO] - Filtro em Campo Inexistente Causa Crash**

**Descri√ß√£o:**  
A rota de relat√≥rios filtra `AlmoxarifadoEstoque` pelo campo `ativo=True`, por√©m este campo **n√£o existe** no modelo `AlmoxarifadoEstoque`.

**Localiza√ß√£o:**  
- **Arquivo:** `almoxarifado_views.py`
- **Fun√ß√£o:** `relatorios()`
- **Linha:** 2412

**C√≥digo Problem√°tico:**
```python
query = AlmoxarifadoEstoque.query.filter_by(admin_id=admin_id, ativo=True)
```

**Impacto:**  
Crash com `AttributeError` ou query SQL inv√°lida ao acessar relat√≥rio de posi√ß√£o de estoque.

**Comportamento Esperado:**  
Relat√≥rio carrega normalmente, exibindo apenas estoques dispon√≠veis.

**Comportamento Atual:**  
Erro 500 ou p√°gina em branco ao acessar a rota de relat√≥rios.

**Recomenda√ß√£o de Corre√ß√£o:**  
Remover filtro `ativo=True` ou usar campo existente como `status='DISPONIVEL'`.

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1. Localize o arquivo `almoxarifado_views.py` e a fun√ß√£o `relatorios()` na linha 2412.
2. Verifique o modelo `AlmoxarifadoEstoque` em `models.py` para confirmar os campos dispon√≠veis.
3. Corrija o filtro para usar um campo existente (provavelmente `status='DISPONIVEL'`).
4. Verifique se h√° outros locais no c√≥digo que usam o filtro `ativo=True` em `AlmoxarifadoEstoque` e corrija-os tamb√©m.
5. Teste a rota de relat√≥rios para garantir que funciona corretamente.
6. Forne√ßa um resumo das altera√ß√µes realizadas.

**COMANDO INICIAL:** Inicie a corre√ß√£o do BUG #001 agora.
```

---

## PROMPT #2: Corre√ß√£o BUG #002 - Aus√™ncia de CSRF Protection

```
**CORRE√á√ÉO DE BUG CR√çTICO #002 - ALMOXARIFADO**

**üìã REFER√äNCIA DO BUG**

**BUG #002 - [SEVERIDADE: CR√çTICO] - Aus√™ncia de CSRF Protection em Todos os Formul√°rios**

**Descri√ß√£o:**  
NENHUM dos formul√°rios POST no m√≥dulo de Almoxarifado possui token CSRF (`csrf_token()` ou `form.hidden_tag()`).

**Localiza√ß√£o:**  
- **Arquivos:** Todos os templates em `templates/almoxarifado/`
- **Total:** 15+ formul√°rios POST vulner√°veis

**Templates Afetados:**
- `itens.html` (linha 163)
- `entrada.html` (linha 26)
- `categorias_form.html` (linha 20)
- `itens_form.html` (linha 20)
- `fornecedores_form.html` (linha 16)
- `categorias.html` (linha 77)
- `fornecedores.html` (linha 124)
- `movimentacoes.html` (linha 411)
- E outros...

**Impacto:**  
Vulnerabilidade CSRF permite que atacantes executem a√ß√µes n√£o autorizadas em nome de usu√°rios autenticados (exclus√£o de itens, movimenta√ß√µes falsas, altera√ß√£o de estoque, etc.).

**Comportamento Esperado:**  
Todos os formul√°rios POST devem ter prote√ß√£o CSRF ativa, rejeitando requisi√ß√µes sem token v√°lido.

**Comportamento Atual:**  
Formul√°rios aceitam qualquer requisi√ß√£o POST, mesmo de origens externas maliciosas.

**Recomenda√ß√£o de Corre√ß√£o:**  
Adicionar `{{ csrf_token() }}` ou `{{ form.hidden_tag() }}` em todos os formul√°rios POST.

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1. Localize todos os templates em `templates/almoxarifado/`.
2. Identifique todos os formul√°rios que usam `method="POST"`.
3. Adicione `<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>` logo ap√≥s a tag `<form>` de abertura em cada formul√°rio.
4. Verifique se o Flask-WTF est√° configurado corretamente no projeto (deve estar, pois outros m√≥dulos provavelmente usam).
5. Liste todos os arquivos modificados e o n√∫mero de formul√°rios corrigidos.
6. Forne√ßa um resumo das altera√ß√µes.

**EXEMPLO DE CORRE√á√ÉO:**

Antes:
```html
<form method="POST" action="/almoxarifado/entrada">
    <input type="text" name="item_id" required>
    ...
</form>
```

Depois:
```html
<form method="POST" action="/almoxarifado/entrada">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="text" name="item_id" required>
    ...
</form>
```

**COMANDO INICIAL:** Inicie a corre√ß√£o do BUG #002 agora, adicionando CSRF protection em todos os formul√°rios.
```

---

## PROMPT #3: Corre√ß√£o BUG #003 - Dados FIFO Incompletos em Devolu√ß√µes

```
**CORRE√á√ÉO DE BUG CR√çTICO #003 - ALMOXARIFADO**

**üìã REFER√äNCIA DO BUG**

**BUG #003 - [SEVERIDADE: CR√çTICO] - Dados FIFO Incompletos em Devolu√ß√µes**

**Descri√ß√£o:**  
Ao criar registro de estoque em devolu√ß√µes, os campos FIFO (`quantidade_inicial`, `quantidade_disponivel`, `entrada_movimento_id`) n√£o s√£o preenchidos, quebrando o rastreamento de lotes.

**Localiza√ß√£o:**  
- **Arquivo:** `almoxarifado_views.py`
- **Fun√ß√µes:** `processar_devolucao()`, `processar_devolucao_multipla()`
- **Linhas:** 1959-1966, 2248-2256

**C√≥digo Problem√°tico:**
```python
estoque = AlmoxarifadoEstoque(
    item_id=item.id,
    quantidade=quantidade_devolvida,
    status='DISPONIVEL',
    # FALTAM: quantidade_inicial, quantidade_disponivel, entrada_movimento_id
)
```

**Impacto:**  
- Queries FIFO retornam resultados incorretos
- Imposs√≠vel rastrear origem de itens devolvidos
- Relat√≥rios de lotes inconsistentes
- Sistema de rastreamento de lotes completamente quebrado para devolu√ß√µes

**Comportamento Esperado:**  
Devolu√ß√µes criam registros de estoque completos com todos os campos FIFO preenchidos, permitindo rastreamento adequado.

**Comportamento Atual:**  
Registros de estoque de devolu√ß√µes ficam incompletos, sem refer√™ncia √† movimenta√ß√£o de entrada.

**Recomenda√ß√£o de Corre√ß√£o:**  
Adicionar campos FIFO ao criar estoque de devolu√ß√£o:
```python
estoque = AlmoxarifadoEstoque(
    item_id=item.id,
    quantidade=quantidade_devolvida,
    quantidade_inicial=quantidade_devolvida,
    quantidade_disponivel=quantidade_devolvida,
    status='DISPONIVEL',
    admin_id=admin_id
)
db.session.add(estoque)
db.session.flush()
estoque.entrada_movimento_id = movimento.id
```

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1. Localize o arquivo `almoxarifado_views.py`.
2. Encontre as fun√ß√µes `processar_devolucao()` (linha ~1959) e `processar_devolucao_multipla()` (linha ~2248).
3. Identifique onde o objeto `AlmoxarifadoEstoque` √© criado em cada fun√ß√£o.
4. Adicione os campos FIFO faltantes (`quantidade_inicial`, `quantidade_disponivel`, `entrada_movimento_id`) conforme a recomenda√ß√£o.
5. Certifique-se de que o `entrada_movimento_id` √© definido AP√ìS o flush (para ter o ID do movimento).
6. Verifique se h√° outras fun√ß√µes de devolu√ß√£o que possam ter o mesmo problema.
7. Teste a funcionalidade de devolu√ß√£o para garantir que os dados FIFO s√£o salvos corretamente.
8. Forne√ßa um resumo das altera√ß√µes realizadas.

**COMANDO INICIAL:** Inicie a corre√ß√£o do BUG #003 agora.
```

---

## PROMPT #4: Corre√ß√£o BUG #004 - ValueError N√£o Tratado

```
**CORRE√á√ÉO DE BUG CR√çTICO #004 - ALMOXARIFADO**

**üìã REFER√äNCIA DO BUG**

**BUG #004 - [SEVERIDADE: CR√çTICO] - ValueError N√£o Tratado em Convers√£o de Filtros**

**Descri√ß√£o:**  
A convers√£o `int(funcionario_filtro)` pode lan√ßar `ValueError` se o par√¢metro contiver valor n√£o num√©rico, causando crash da aplica√ß√£o.

**Localiza√ß√£o:**  
- **Arquivo:** `almoxarifado_views.py`
- **Fun√ß√£o:** `itens_movimentacoes()`
- **Linhas:** 501-505

**C√≥digo Problem√°tico:**
```python
if funcionario_filtro:
    query = query.filter(AlmoxarifadoMovimento.funcionario_id == int(funcionario_filtro))
```

**Impacto:**  
Erro 500 se usu√°rio manipular URL com valor inv√°lido (ex: `/movimentacoes?funcionario_filtro=abc`).

**Comportamento Esperado:**  
Filtros inv√°lidos s√£o ignorados silenciosamente ou exibem mensagem de erro amig√°vel ao usu√°rio.

**Comportamento Atual:**  
Aplica√ß√£o retorna erro 500 com stack trace exposto.

**Recomenda√ß√£o de Corre√ß√£o:**  
```python
if funcionario_filtro:
    try:
        query = query.filter(AlmoxarifadoMovimento.funcionario_id == int(funcionario_filtro))
    except (ValueError, TypeError):
        pass  # Ignora filtro inv√°lido
```

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1. Localize o arquivo `almoxarifado_views.py` e a fun√ß√£o `itens_movimentacoes()` na linha ~501.
2. Encontre o c√≥digo que converte `funcionario_filtro` para inteiro.
3. Adicione tratamento de exce√ß√£o `try/except` para capturar `ValueError` e `TypeError`.
4. Verifique se h√° OUTROS locais no c√≥digo onde filtros de URL s√£o convertidos para int sem tratamento de erro (busque por padr√µes como `int(request.args.get(...))`).
5. Aplique a mesma corre√ß√£o em todos os locais encontrados.
6. Teste a rota com par√¢metros inv√°lidos (ex: `?funcionario_filtro=abc`, `?funcionario_filtro=null`) para garantir que n√£o h√° mais crashes.
7. Forne√ßa um resumo de todos os locais corrigidos.

**COMANDO INICIAL:** Inicie a corre√ß√£o do BUG #004 agora, e busque por padr√µes similares em todo o arquivo.
```

---

## Resumo dos Bugs Cr√≠ticos

| Bug | T√≠tulo | Prioridade | Impacto |
|-----|--------|-----------|---------|
| #001 | Filtro em Campo Inexistente | IMEDIATA | Crash ao acessar relat√≥rios |
| #002 | Aus√™ncia de CSRF Protection | IMEDIATA | Vulnerabilidade de seguran√ßa |
| #003 | Dados FIFO Incompletos | ALTA | Rastreamento de lotes quebrado |
| #004 | ValueError N√£o Tratado | ALTA | Crash com par√¢metros inv√°lidos |

## Ordem Recomendada de Corre√ß√£o

1. **BUG #001** (mais r√°pido, impacto imediato)
2. **BUG #004** (r√°pido, previne crashes)
3. **BUG #002** (mais trabalhoso, mas cr√≠tico para seguran√ßa)
4. **BUG #003** (requer mais aten√ß√£o, mas essencial para integridade dos dados)

## Ap√≥s Corrigir os Bugs Cr√≠ticos

Execute os testes:
1. Acesse a rota de relat√≥rios e verifique se carrega sem erros
2. Teste todos os formul√°rios POST para garantir que CSRF est√° funcionando
3. Fa√ßa uma devolu√ß√£o e verifique se os campos FIFO foram salvos corretamente
4. Teste filtros com valores inv√°lidos nas URLs

## Pr√≥ximos Passos

Ap√≥s corrigir os bugs cr√≠ticos, voc√™ pode prosseguir com os bugs de severidade ALTA e M√âDIA usando o mesmo formato de prompt.
