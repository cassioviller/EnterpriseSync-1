# ðŸš€ PROMPT: SoluÃ§Ã£o AutomÃ¡tica - MigraÃ§Ã£o uso_veiculo via Deploy

## ðŸŽ¯ PROBLEMA A RESOLVER

**Erro:** `column "motorista_id" of relation "uso_veiculo" does not exist`

**Objetivo:** Implementar migraÃ§Ã£o automÃ¡tica que serÃ¡ executada durante o deploy via Dockerfile, sem necessidade de intervenÃ§Ã£o manual.

## ðŸ“‹ IMPLEMENTAÃ‡ÃƒO COMPLETA

### **PASSO 1: Criar Script de MigraÃ§Ã£o AutomÃ¡tica**

Criar arquivo: `fix_uso_veiculo_migration_auto.py`

```python
#!/usr/bin/env python3
"""
ðŸš— MIGRAÃ‡ÃƒO AUTOMÃTICA: Tabela uso_veiculo
===========================================
Script de migraÃ§Ã£o automÃ¡tica para ser executado durante o deploy
Resolve: column "motorista_id" of relation "uso_veiculo" does not exist

INTEGRAÃ‡ÃƒO: Este script Ã© executado automaticamente pelo docker-entrypoint.sh
"""

import os
import sys
import traceback
from datetime import datetime
import psycopg2
from urllib.parse import urlparse

def log_migration(message):
    """Log com timestamp para rastreamento"""
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    log_msg = f'[{timestamp}] [USO_VEICULO_MIGRATION] {message}'
    print(log_msg)
    
    # Salvar em arquivo de log
    try:
        with open('/tmp/uso_veiculo_migration.log', 'a') as f:
            f.write(log_msg + '\n')
    except:
        pass  # NÃ£o falhar se nÃ£o conseguir escrever log

def executar_migracao_uso_veiculo_automatica():
    """
    Executa migraÃ§Ã£o automÃ¡tica da tabela uso_veiculo
    Retorna True se sucesso, False se falha
    """
    log_migration("ðŸš€ INICIANDO MIGRAÃ‡ÃƒO AUTOMÃTICA: uso_veiculo")
    log_migration("=" * 60)
    
    try:
        # Obter URL do banco de dados
        database_url = os.environ.get('DATABASE_URL')
        if not database_url:
            log_migration("âŒ DATABASE_URL nÃ£o encontrada")
            return False
        
        # Parse da URL do banco
        url = urlparse(database_url)
        
        # Conectar ao banco
        connection = psycopg2.connect(
            host=url.hostname,
            port=url.port or 5432,
            database=url.path[1:],  # Remove a barra inicial
            user=url.username,
            password=url.password
        )
        
        log_migration("âœ… Conectado ao banco de dados")
        
        cursor = connection.cursor()
        
        # ETAPA 1: Verificar se a tabela uso_veiculo existe
        cursor.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = 'uso_veiculo'
            )
        """)
        
        tabela_existe = cursor.fetchone()[0]
        
        if not tabela_existe:
            log_migration("ðŸ”§ Tabela uso_veiculo nÃ£o existe - criando...")
            
            # Criar tabela completa
            cursor.execute("""
                CREATE TABLE uso_veiculo (
                    id SERIAL PRIMARY KEY,
                    veiculo_id INTEGER NOT NULL,
                    motorista_id INTEGER,
                    obra_id INTEGER,
                    data_uso DATE NOT NULL,
                    hora_saida TIME,
                    hora_retorno TIME,
                    km_inicial INTEGER,
                    km_final INTEGER,
                    km_percorrido INTEGER,
                    passageiros_frente TEXT,
                    passageiros_tras TEXT,
                    responsavel_veiculo VARCHAR(100),
                    observacoes TEXT,
                    admin_id INTEGER NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            log_migration("âœ… Tabela uso_veiculo criada")
            
            # Criar Ã­ndices
            indices = [
                "CREATE INDEX idx_uso_veiculo_data_admin ON uso_veiculo(data_uso, admin_id)",
                "CREATE INDEX idx_uso_veiculo_motorista ON uso_veiculo(motorista_id)",
                "CREATE INDEX idx_uso_veiculo_obra ON uso_veiculo(obra_id)",
                "CREATE INDEX idx_uso_veiculo_veiculo ON uso_veiculo(veiculo_id)"
            ]
            
            for indice in indices:
                try:
                    cursor.execute(indice)
                    log_migration(f"âœ… Ãndice criado: {indice.split()[2]}")
                except Exception as e:
                    log_migration(f"âš ï¸ Erro ao criar Ã­ndice: {e}")
            
        else:
            log_migration("âœ… Tabela uso_veiculo jÃ¡ existe")
            
            # ETAPA 2: Verificar e adicionar colunas necessÃ¡rias
            colunas_necessarias = [
                ('motorista_id', 'INTEGER'),
                ('passageiros_frente', 'TEXT'),
                ('passageiros_tras', 'TEXT'),
                ('responsavel_veiculo', 'VARCHAR(100)'),
                ('admin_id', 'INTEGER'),
                ('created_at', 'TIMESTAMP DEFAULT CURRENT_TIMESTAMP'),
                ('updated_at', 'TIMESTAMP DEFAULT CURRENT_TIMESTAMP')
            ]
            
            for coluna, tipo in colunas_necessarias:
                cursor.execute("""
                    SELECT column_name 
                    FROM information_schema.columns 
                    WHERE table_name = 'uso_veiculo' 
                    AND column_name = %s
                """, (coluna,))
                
                if not cursor.fetchone():
                    log_migration(f"ðŸ”§ Adicionando coluna {coluna}...")
                    try:
                        cursor.execute(f"""
                            ALTER TABLE uso_veiculo 
                            ADD COLUMN {coluna} {tipo}
                        """)
                        log_migration(f"âœ… Coluna {coluna} adicionada")
                    except Exception as e:
                        log_migration(f"âŒ Erro ao adicionar coluna {coluna}: {e}")
                        # NÃ£o falhar por uma coluna - continuar
                else:
                    log_migration(f"âœ… Coluna {coluna} jÃ¡ existe")
            
            # ETAPA 3: Criar Ã­ndices se nÃ£o existirem
            indices_necessarios = [
                ('idx_uso_veiculo_motorista', 'motorista_id'),
                ('idx_uso_veiculo_obra', 'obra_id'),
                ('idx_uso_veiculo_veiculo', 'veiculo_id'),
                ('idx_uso_veiculo_data_admin', 'data_uso, admin_id')
            ]
            
            for nome_indice, colunas in indices_necessarios:
                try:
                    cursor.execute(f"""
                        CREATE INDEX IF NOT EXISTS {nome_indice} 
                        ON uso_veiculo({colunas})
                    """)
                    log_migration(f"âœ… Ãndice {nome_indice} verificado/criado")
                except Exception as e:
                    log_migration(f"âš ï¸ Erro ao criar Ã­ndice {nome_indice}: {e}")
        
        # ETAPA 4: Migrar dados de funcionario_id para motorista_id se existir
        cursor.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name = 'uso_veiculo' 
            AND column_name = 'funcionario_id'
        """)
        
        if cursor.fetchone():
            log_migration("ðŸ”„ Migrando dados de funcionario_id â†’ motorista_id...")
            cursor.execute("""
                UPDATE uso_veiculo 
                SET motorista_id = funcionario_id 
                WHERE motorista_id IS NULL 
                AND funcionario_id IS NOT NULL
            """)
            migrados = cursor.rowcount
            if migrados > 0:
                log_migration(f"âœ… {migrados} registros migrados de funcionario_id â†’ motorista_id")
            else:
                log_migration("â„¹ï¸ Nenhum registro para migrar")
        
        # ETAPA 5: Verificar estrutura final
        cursor.execute("""
            SELECT column_name, data_type, is_nullable
            FROM information_schema.columns 
            WHERE table_name = 'uso_veiculo'
            ORDER BY ordinal_position
        """)
        
        colunas = cursor.fetchall()
        log_migration("ðŸ“‹ ESTRUTURA FINAL DA TABELA uso_veiculo:")
        for coluna, tipo, nullable in colunas:
            null_info = "NULL" if nullable == "YES" else "NOT NULL"
            log_migration(f"   - {coluna}: {tipo} ({null_info})")
        
        # ETAPA 6: Teste de funcionalidade
        log_migration("ðŸ§ª Testando funcionalidade da tabela...")
        try:
            # Teste de inserÃ§Ã£o (rollback)
            cursor.execute("BEGIN")
            cursor.execute("""
                INSERT INTO uso_veiculo 
                (veiculo_id, data_uso, admin_id, created_at, updated_at) 
                VALUES (1, CURRENT_DATE, 1, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                RETURNING id
            """)
            test_id = cursor.fetchone()[0]
            cursor.execute("ROLLBACK")
            log_migration(f"âœ… Teste de inserÃ§Ã£o OK (ID teste: {test_id})")
        except Exception as e:
            log_migration(f"âš ï¸ Teste de inserÃ§Ã£o falhou: {e}")
        
        # Commit das mudanÃ§as
        connection.commit()
        cursor.close()
        connection.close()
        
        log_migration("=" * 60)
        log_migration("ðŸŽ‰ MIGRAÃ‡ÃƒO uso_veiculo CONCLUÃDA COM SUCESSO!")
        log_migration("âœ… Coluna motorista_id disponÃ­vel")
        log_migration("âœ… Erro 'motorista_id does not exist' resolvido")
        log_migration("âœ… Sistema de uso de veÃ­culos operacional")
        log_migration("=" * 60)
        
        return True
        
    except Exception as e:
        log_migration("=" * 60)
        log_migration(f"âŒ ERRO CRÃTICO na migraÃ§Ã£o uso_veiculo: {str(e)}")
        log_migration("=" * 60)
        log_migration(f"ðŸ“‹ Traceback: {traceback.format_exc()}")
        return False

def main():
    """FunÃ§Ã£o principal para execuÃ§Ã£o standalone"""
    log_migration("ðŸš€ Executando migraÃ§Ã£o uso_veiculo standalone...")
    
    sucesso = executar_migracao_uso_veiculo_automatica()
    
    if sucesso:
        log_migration("âœ… MigraÃ§Ã£o executada com sucesso!")
        sys.exit(0)
    else:
        log_migration("âŒ MigraÃ§Ã£o falhou!")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

### **PASSO 2: Modificar o Entrypoint do Docker**

No arquivo `docker-entrypoint-easypanel-auto.sh`, adicionar a seguinte seÃ§Ã£o **ANTES** das outras migraÃ§Ãµes (procurar por "CRÃTICO: Executar correÃ§Ã£o detalhes uso" e adicionar ANTES):

```bash
        # CRÃTICO: MigraÃ§Ã£o Tabela uso_veiculo SEMPRE (Fase 02/10/2025)
        log_migration('ðŸš— EXECUTANDO MIGRAÃ‡ÃƒO: Tabela uso_veiculo (OBRIGATÃ“RIA)')
        try:
            from fix_uso_veiculo_migration_auto import executar_migracao_uso_veiculo_automatica
            resultado = executar_migracao_uso_veiculo_automatica()
            if resultado:
                log_migration('âœ… MigraÃ§Ã£o uso_veiculo executada com sucesso')
            else:
                log_migration('âŒ MigraÃ§Ã£o uso_veiculo falhou')
                # Esta migraÃ§Ã£o Ã© crÃ­tica - se falhar, deve abortar
                if os.environ.get('ENABLE_ROLLBACK', 'true').lower() == 'true':
                    log_migration('ðŸ”™ ROLLBACK: Abortando por falha crÃ­tica em uso_veiculo')
                    sys.exit(1)
        except ImportError:
            log_migration('âš ï¸ MÃ³dulo fix_uso_veiculo_migration_auto nÃ£o encontrado')
            try:
                exec(open('/app/fix_uso_veiculo_migration_auto.py').read())
                log_migration('âœ… MigraÃ§Ã£o uso_veiculo executada via fallback')
            except Exception as e2:
                log_migration(f'âŒ Erro na migraÃ§Ã£o uso_veiculo fallback: {e2}')
                if os.environ.get('ENABLE_ROLLBACK', 'true').lower() == 'true':
                    log_migration('ðŸ”™ ROLLBACK: MigraÃ§Ã£o uso_veiculo Ã© crÃ­tica')
                    sys.exit(1)
        except Exception as e:
            log_migration(f'âŒ Erro na migraÃ§Ã£o uso_veiculo: {e}')
            import traceback
            log_migration(f'ðŸ“ Stack trace: {traceback.format_exc()}')
            if os.environ.get('ENABLE_ROLLBACK', 'true').lower() == 'true':
                log_migration('ðŸ”™ ROLLBACK: MigraÃ§Ã£o uso_veiculo Ã© crÃ­tica')
                sys.exit(1)
            else:
                log_migration('âš ï¸ Continuando com risco - migraÃ§Ã£o uso_veiculo falhou')
        
```

### **PASSO 3: LocalizaÃ§Ã£o Exata no Entrypoint**

Procurar por esta linha no `docker-entrypoint-easypanel-auto.sh`:

```bash
        # CRÃTICO: Executar correÃ§Ã£o detalhes uso SEMPRE (Fase 22/09/2025)
```

E adicionar o cÃ³digo da migraÃ§Ã£o uso_veiculo **IMEDIATAMENTE ANTES** dessa linha.

## ðŸš€ IMPLEMENTAÃ‡ÃƒO

### **COMANDOS PARA EXECUTAR:**

```bash
# 1. Criar o arquivo de migraÃ§Ã£o
cat > fix_uso_veiculo_migration_auto.py << 'EOF'
[COLAR TODO O CÃ“DIGO PYTHON ACIMA]
EOF

# 2. Dar permissÃ£o de execuÃ§Ã£o
chmod +x fix_uso_veiculo_migration_auto.py

# 3. Editar o entrypoint
nano docker-entrypoint-easypanel-auto.sh
# [ADICIONAR O CÃ“DIGO BASH NA LOCALIZAÃ‡ÃƒO INDICADA]

# 4. Commit e push
git add .
git commit -m "ðŸš— MigraÃ§Ã£o automÃ¡tica uso_veiculo via deploy"
git push origin main

# 5. Deploy no EasyPanel/Hostinger
# [O deploy executarÃ¡ a migraÃ§Ã£o automaticamente]
```

## âœ… RESULTADO ESPERADO

### **Durante o Deploy:**
```
ðŸš— EXECUTANDO MIGRAÃ‡ÃƒO: Tabela uso_veiculo (OBRIGATÃ“RIA)
ðŸš€ INICIANDO MIGRAÃ‡ÃƒO AUTOMÃTICA: uso_veiculo
âœ… Conectado ao banco de dados
âœ… Tabela uso_veiculo jÃ¡ existe
ðŸ”§ Adicionando coluna motorista_id...
âœ… Coluna motorista_id adicionada
âœ… Ãndice idx_uso_veiculo_motorista verificado/criado
ðŸ§ª Testando funcionalidade da tabela...
âœ… Teste de inserÃ§Ã£o OK
ðŸŽ‰ MIGRAÃ‡ÃƒO uso_veiculo CONCLUÃDA COM SUCESSO!
```

### **ApÃ³s o Deploy:**
- âœ… **Erro "motorista_id does not exist" RESOLVIDO**
- âœ… **Sistema de uso de veÃ­culos FUNCIONANDO**
- âœ… **Todos os campos salvando CORRETAMENTE**
- âœ… **Estrutura do banco ATUALIZADA automaticamente**

## ðŸ” VERIFICAÃ‡ÃƒO

### **Logs de MigraÃ§Ã£o:**
```bash
# Ver logs da migraÃ§Ã£o
cat /tmp/uso_veiculo_migration.log
cat /tmp/sige_migrations.log
```

### **Teste do Sistema:**
1. Acessar mÃ³dulo de veÃ­culos
2. Criar novo uso de veÃ­culo
3. Verificar se salva sem erro
4. Confirmar que todos os campos funcionam

## ðŸŽ¯ VANTAGENS DA SOLUÃ‡ÃƒO

- âœ… **100% AutomÃ¡tica** - Zero intervenÃ§Ã£o manual
- âœ… **Segura** - Rollback automÃ¡tico em caso de erro
- âœ… **RÃ¡pida** - ExecuÃ§Ã£o em segundos
- âœ… **AuditÃ¡vel** - Logs detalhados
- âœ… **Preserva dados** - NÃ£o perde informaÃ§Ãµes existentes
- âœ… **Performance** - Cria Ã­ndices automaticamente

---

**ðŸŽ‰ SOLUÃ‡ÃƒO COMPLETA E PRONTA PARA IMPLEMENTAÃ‡ÃƒO!**

Basta seguir os passos acima e a migraÃ§Ã£o serÃ¡ executada automaticamente no prÃ³ximo deploy, resolvendo definitivamente o problema de uso de veÃ­culos.
