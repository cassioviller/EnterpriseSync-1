# PROMPT COMPLETO - M√≥dulo Gest√£o de Equipe com C√≥digo

## PERFIL BACKEND SPECIALIST - "Marcus Silva"

Voc√™ √© Marcus Silva, um arquiteto de backend s√™nior com 15 anos de experi√™ncia em sistemas de gest√£o para constru√ß√£o civil. Sua personalidade e expertise:

**MENTALIDADE:**
- Pragm√°tico extremo: "Se n√£o resolve o problema real, n√£o serve"
- Obsess√£o por APIs simples e r√°pidas: "Cada milissegundo importa no canteiro"
- Zero toler√¢ncia a over-engineering: "Complexidade √© inimiga da manutenibilidade"
- Foco em robustez: "Sistema que cai √© sistema que n√£o existe"

**FILOSOFIA T√âCNICA:**
- Flask/FastAPI para APIs enxutas e perform√°ticas
- SQLAlchemy com queries otimizadas
- Valida√ß√£o rigorosa de dados na entrada
- Logs estruturados para debugging r√°pido
- Testes automatizados para endpoints cr√≠ticos

**ABORDAGEM:**
- Modela dados pensando na consulta, n√£o na teoria
- APIs RESTful simples: GET, POST, PUT, DELETE
- Retorna sempre JSON estruturado e consistente
- Tratamento de erro expl√≠cito e informativo
- Documenta√ß√£o autom√°tica com Swagger/OpenAPI

## PERFIL FRONTEND SPECIALIST - "Ana Costa"

Voc√™ √© Ana Costa, uma especialista em UI/UX e frontend com 12 anos focada em interfaces para ambientes industriais. Sua personalidade e expertise:

**MENTALIDADE:**
- "Interface que n√£o funciona com luva n√£o funciona"
- Obsess√£o por performance: "Lag mata produtividade"
- Mobile-first sempre: "Tablet √© o computador do canteiro"
- Acessibilidade n√£o √© opcional: "Todo mundo precisa conseguir usar"

**FILOSOFIA T√âCNICA:**
- Vanilla JS ou bibliotecas leves: sem frameworks pesados
- CSS Grid e Flexbox para layouts responsivos
- Drag & drop nativo do HTML5 quando poss√≠vel
- Componentes reutiliz√°veis e modulares
- Progressive Enhancement: funciona sem JS, melhora com JS

**BIBLIOTECAS RECOMENDADAS (baseado na pesquisa):**
- **SortableJS**: Leve, sem depend√™ncias, suporte nativo a touch
- **Pragmatic Drag & Drop (Atlassian)**: Performance superior, vanilla JS
- **FullCalendar**: Para calend√°rios complexos se necess√°rio
- **Schedule-X**: Alternativa moderna ao FullCalendar

## C√ìDIGO BACKEND - Marcus Silva

### 1. Modelos Enxutos (models.py)
```python
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime, date, time
from sqlalchemy import Index

db = SQLAlchemy()

class Allocation(db.Model):
    """Aloca√ß√£o obra‚Üídia - Tabela principal"""
    __tablename__ = 'allocation'
    
    id = db.Column(db.Integer, primary_key=True)
    admin_id = db.Column(db.Integer, db.ForeignKey('usuario.id'), nullable=False)
    obra_id = db.Column(db.Integer, db.ForeignKey('obra.id'), nullable=False)
    data_alocacao = db.Column(db.Date, nullable=False)
    turno_inicio = db.Column(db.Time, default=time(8, 0))
    turno_fim = db.Column(db.Time, default=time(17, 0))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relacionamentos
    obra = db.relationship('Obra', backref='allocations')
    funcionarios = db.relationship('AllocationEmployee', backref='allocation', cascade='all, delete-orphan')
    
    # √çndices para performance
    __table_args__ = (
        Index('idx_allocation_admin_date', 'admin_id', 'data_alocacao'),
        Index('idx_allocation_obra_date', 'obra_id', 'data_alocacao'),
        db.UniqueConstraint('obra_id', 'data_alocacao', name='uq_obra_data')
    )

class AllocationEmployee(db.Model):
    """Funcion√°rios‚Üíobra - Tabela de relacionamento"""
    __tablename__ = 'allocation_employee'
    
    id = db.Column(db.Integer, primary_key=True)
    allocation_id = db.Column(db.Integer, db.ForeignKey('allocation.id'), nullable=False)
    funcionario_id = db.Column(db.Integer, db.ForeignKey('funcionario.id'), nullable=False)
    turno_inicio = db.Column(db.Time, default=time(8, 0))
    turno_fim = db.Column(db.Time, default=time(17, 0))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relacionamentos
    funcionario = db.relationship('Funcionario')
    
    # √çndices
    __table_args__ = (
        Index('idx_alloc_emp_allocation', 'allocation_id'),
        Index('idx_alloc_emp_funcionario', 'funcionario_id'),
        db.UniqueConstraint('allocation_id', 'funcionario_id', name='uq_allocation_funcionario')
    )
```

### 2. APIs Enxutas (equipe_api.py)
```python
from flask import Blueprint, request, jsonify
from flask_login import login_required, current_user
from datetime import datetime, date, timedelta
from sqlalchemy import and_, func
from models import db, Allocation, AllocationEmployee, Obra, Funcionario
import logging

api_bp = Blueprint('equipe_api', __name__, url_prefix='/api/equipe')

def get_admin_id():
    """Pega admin_id do usu√°rio atual"""
    return getattr(current_user, 'admin_id', current_user.id)

def json_response(data=None, message=None, status=200, error=None):
    """Resposta JSON padronizada"""
    response = {
        'success': status < 400,
        'data': data,
        'message': message,
        'error': error,
        'timestamp': datetime.utcnow().isoformat()
    }
    return jsonify(response), status

@api_bp.route('/allocations', methods=['GET'])
@login_required
def get_allocations():
    """GET /api/equipe/allocations?week_start=2024-01-15&obra_id=123"""
    try:
        admin_id = get_admin_id()
        week_start = request.args.get('week_start')
        obra_id = request.args.get('obra_id')
        
        # Parse da data
        if week_start:
            start_date = datetime.strptime(week_start, '%Y-%m-%d').date()
        else:
            start_date = date.today()
            start_date = start_date - timedelta(days=start_date.weekday())  # Segunda-feira
        
        end_date = start_date + timedelta(days=4)  # Sexta-feira
        
        # Query otimizada
        query = db.session.query(Allocation).filter(
            and_(
                Allocation.admin_id == admin_id,
                Allocation.data_alocacao >= start_date,
                Allocation.data_alocacao <= end_date
            )
        )
        
        if obra_id:
            query = query.filter(Allocation.obra_id == obra_id)
        
        allocations = query.all()
        
        # Serializa√ß√£o manual para performance
        result = []
        for alloc in allocations:
            funcionarios_count = len(alloc.funcionarios)
            result.append({
                'id': alloc.id,
                'obra_id': alloc.obra_id,
                'obra_codigo': alloc.obra.codigo,
                'obra_nome': alloc.obra.nome,
                'data_alocacao': alloc.data_alocacao.isoformat(),
                'turno_inicio': alloc.turno_inicio.strftime('%H:%M'),
                'turno_fim': alloc.turno_fim.strftime('%H:%M'),
                'funcionarios_count': funcionarios_count,
                'day_of_week': alloc.data_alocacao.weekday()  # 0=Segunda
            })
        
        return json_response(data=result)
        
    except Exception as e:
        logging.error(f"Erro ao buscar aloca√ß√µes: {str(e)}")
        return json_response(error="Erro interno do servidor", status=500)

@api_bp.route('/allocations', methods=['POST'])
@login_required
def create_allocation():
    """POST /api/equipe/allocations"""
    try:
        data = request.get_json()
        
        # Valida√ß√£o rigorosa
        required_fields = ['obra_id', 'data_alocacao']
        for field in required_fields:
            if field not in data:
                return json_response(error=f"Campo obrigat√≥rio: {field}", status=400)
        
        admin_id = get_admin_id()
        obra_id = data['obra_id']
        data_alocacao = datetime.strptime(data['data_alocacao'], '%Y-%m-%d').date()
        
        # Verifica se obra existe
        obra = Obra.query.filter_by(id=obra_id, admin_id=admin_id).first()
        if not obra:
            return json_response(error="Obra n√£o encontrada", status=404)
        
        # Verifica duplicata
        existing = Allocation.query.filter_by(
            obra_id=obra_id, 
            data_alocacao=data_alocacao
        ).first()
        if existing:
            return json_response(error="Obra j√° alocada nesta data", status=409)
        
        # Cria aloca√ß√£o
        allocation = Allocation(
            admin_id=admin_id,
            obra_id=obra_id,
            data_alocacao=data_alocacao,
            turno_inicio=datetime.strptime(data.get('turno_inicio', '08:00'), '%H:%M').time(),
            turno_fim=datetime.strptime(data.get('turno_fim', '17:00'), '%H:%M').time()
        )
        
        db.session.add(allocation)
        db.session.commit()
        
        return json_response(
            data={'id': allocation.id},
            message="Aloca√ß√£o criada com sucesso",
            status=201
        )
        
    except ValueError as e:
        return json_response(error="Formato de data inv√°lido", status=400)
    except Exception as e:
        db.session.rollback()
        logging.error(f"Erro ao criar aloca√ß√£o: {str(e)}")
        return json_response(error="Erro interno do servidor", status=500)

@api_bp.route('/allocations/<int:allocation_id>', methods=['DELETE'])
@login_required
def delete_allocation(allocation_id):
    """DELETE /api/equipe/allocations/123"""
    try:
        admin_id = get_admin_id()
        
        allocation = Allocation.query.filter_by(
            id=allocation_id, 
            admin_id=admin_id
        ).first()
        
        if not allocation:
            return json_response(error="Aloca√ß√£o n√£o encontrada", status=404)
        
        db.session.delete(allocation)
        db.session.commit()
        
        return json_response(message="Aloca√ß√£o removida com sucesso")
        
    except Exception as e:
        db.session.rollback()
        logging.error(f"Erro ao deletar aloca√ß√£o: {str(e)}")
        return json_response(error="Erro interno do servidor", status=500)

@api_bp.route('/obras', methods=['GET'])
@login_required
def get_obras():
    """GET /api/equipe/obras - Lista obras ativas"""
    try:
        admin_id = get_admin_id()
        
        obras = Obra.query.filter_by(
            admin_id=admin_id, 
            status='ativa'
        ).order_by(Obra.nome).all()
        
        result = [{
            'id': obra.id,
            'codigo': obra.codigo,
            'nome': obra.nome,
            'cor': f"hsl({hash(obra.codigo) % 360}, 70%, 50%)"  # Cor consistente
        } for obra in obras]
        
        return json_response(data=result)
        
    except Exception as e:
        logging.error(f"Erro ao buscar obras: {str(e)}")
        return json_response(error="Erro interno do servidor", status=500)
```

## C√ìDIGO FRONTEND - Ana Costa

### 3. HTML Estrutural (alocacao_semanal.html)
```html
{% extends "base_completo.html" %}

{% block title %}Gest√£o de Equipe - Semana {{ monday.strftime('%d/%m') }}{% endblock %}

{% block head_content %}
<!-- SortableJS - Biblioteca leve e perform√°tica -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* CSS m√≠nimo e funcional */
.equipe-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 1rem;
    min-height: 600px;
}

.obras-sidebar {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
}

.day-column {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    min-height: 400px;
}

.day-header {
    background: #198754;
    color: white;
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    border-radius: 8px 8px 0 0;
}

.day-content {
    padding: 0.5rem;
    min-height: 350px;
}

.obra-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
}

.obra-card:hover {
    border-color: #198754;
    box-shadow: 0 2px 8px rgba(25, 135, 84, 0.2);
}

.obra-card:active {
    cursor: grabbing;
}

.obra-card.dragging {
    opacity: 0.6;
    transform: rotate(2deg);
}

.allocated-obra {
    background: linear-gradient(135deg, #198754, #157347);
    color: white;
    border: none;
    position: relative;
}

.allocated-obra:hover {
    background: linear-gradient(135deg, #157347, #0f5132);
}

.employee-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ffc107;
    color: #856404;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.drop-zone {
    border: 2px dashed #dee2e6;
    border-radius: 6px;
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.drop-zone.drag-over {
    border-color: #198754;
    background: rgba(25, 135, 84, 0.1);
    border-style: solid;
}

.drop-zone.has-content {
    display: none;
}

/* Responsividade tablet */
@media (max-width: 768px) {
    .equipe-grid {
        grid-template-columns: 1fr;
    }
    
    .week-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .obra-card {
        padding: 1rem;
        font-size: 1rem;
    }
}

/* Loading e feedback */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.success-flash {
    animation: flash-success 0.5s ease;
}

@keyframes flash-success {
    0% { background: rgba(25, 135, 84, 0.2); }
    100% { background: transparent; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header com navega√ß√£o -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3>üìã Gest√£o de Equipe</h3>
            <p class="text-muted mb-0">Semana de {{ monday.strftime('%d/%m') }} a {{ friday.strftime('%d/%m') }}</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="navigateWeek(-1)">
                ‚Üê Anterior
            </button>
            <button class="btn btn-primary" onclick="goToToday()">
                Hoje
            </button>
            <button class="btn btn-outline-primary" onclick="navigateWeek(1)">
                Pr√≥xima ‚Üí
            </button>
        </div>
    </div>

    <!-- Grid principal -->
    <div class="equipe-grid">
        <!-- Sidebar: Obras dispon√≠veis -->
        <div class="obras-sidebar">
            <h5 class="mb-3">üèóÔ∏è Obras Dispon√≠veis</h5>
            <div id="obras-list">
                <!-- Carregado via JavaScript -->
            </div>
        </div>

        <!-- Grid semanal -->
        <div class="week-grid">
            {% set weekdays = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'] %}
            {% for day_index in range(5) %}
            <div class="day-column">
                <div class="day-header">
                    {{ weekdays[day_index] }}<br>
                    <small>{{ week_dates[day_index].strftime('%d/%m') }}</small>
                </div>
                <div class="day-content" 
                     data-day="{{ day_index }}"
                     data-date="{{ week_dates[day_index].strftime('%Y-%m-%d') }}">
                    <div class="drop-zone">
                        Arraste obras aqui
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
     style="background: rgba(0,0,0,0.5); z-index: 2000;">
    <div class="d-flex align-items-center justify-content-center h-100">
        <div class="bg-white p-4 rounded">
            <div class="spinner-border text-primary me-3"></div>
            Processando...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// JavaScript modular e perform√°tico - Ana Costa style
class EquipeManager {
    constructor() {
        this.currentWeek = '{{ monday.strftime("%Y-%m-%d") }}';
        this.obras = [];
        this.allocations = [];
        this.sortables = [];
        
        this.init();
    }
    
    async init() {
        try {
            await this.loadObras();
            await this.loadAllocations();
            this.setupDragDrop();
            this.renderObras();
            this.renderAllocations();
        } catch (error) {
            console.error('Erro na inicializa√ß√£o:', error);
            this.showError('Erro ao carregar dados');
        }
    }
    
    async loadObras() {
        const response = await fetch('/api/equipe/obras');
        const result = await response.json();
        
        if (result.success) {
            this.obras = result.data;
        } else {
            throw new Error(result.error);
        }
    }
    
    async loadAllocations() {
        const response = await fetch(`/api/equipe/allocations?week_start=${this.currentWeek}`);
        const result = await response.json();
        
        if (result.success) {
            this.allocations = result.data;
        } else {
            throw new Error(result.error);
        }
    }
    
    renderObras() {
        const container = document.getElementById('obras-list');
        container.innerHTML = '';
        
        this.obras.forEach(obra => {
            const card = document.createElement('div');
            card.className = 'obra-card';
            card.dataset.obraId = obra.id;
            card.innerHTML = `
                <div class="fw-bold">${obra.codigo}</div>
                <small class="text-muted">${obra.nome}</small>
            `;
            container.appendChild(card);
        });
    }
    
    renderAllocations() {
        // Limpa aloca√ß√µes existentes
        document.querySelectorAll('.allocated-obra').forEach(el => el.remove());
        document.querySelectorAll('.drop-zone').forEach(el => {
            el.style.display = 'flex';
            el.classList.remove('has-content');
        });
        
        this.allocations.forEach(allocation => {
            const dayContent = document.querySelector(`[data-day="${allocation.day_of_week}"]`);
            if (dayContent) {
                const dropZone = dayContent.querySelector('.drop-zone');
                dropZone.style.display = 'none';
                dropZone.classList.add('has-content');
                
                const card = document.createElement('div');
                card.className = 'obra-card allocated-obra';
                card.dataset.allocationId = allocation.id;
                card.innerHTML = `
                    <div class="fw-bold">${allocation.obra_codigo}</div>
                    <small>${allocation.turno_inicio} - ${allocation.turno_fim}</small>
                    ${allocation.funcionarios_count > 0 ? 
                        `<div class="employee-badge">${allocation.funcionarios_count}</div>` : ''}
                `;
                
                // Click para abrir funcion√°rios
                card.addEventListener('click', () => {
                    this.openEmployeeModal(allocation.id);
                });
                
                dayContent.appendChild(card);
            }
        });
    }
    
    setupDragDrop() {
        // Obras sidebar - source
        const obrasList = document.getElementById('obras-list');
        Sortable.create(obrasList, {
            group: {
                name: 'obras',
                pull: 'clone',
                put: false
            },
            sort: false,
            onStart: (evt) => {
                evt.item.classList.add('dragging');
            },
            onEnd: (evt) => {
                evt.item.classList.remove('dragging');
            }
        });
        
        // Day columns - targets
        document.querySelectorAll('.day-content').forEach(dayContent => {
            Sortable.create(dayContent, {
                group: 'obras',
                onAdd: async (evt) => {
                    const obraId = evt.item.dataset.obraId;
                    const date = dayContent.dataset.date;
                    
                    // Remove o item clonado
                    evt.item.remove();
                    
                    await this.createAllocation(obraId, date);
                },
                onRemove: async (evt) => {
                    const allocationId = evt.item.dataset.allocationId;
                    if (allocationId) {
                        await this.deleteAllocation(allocationId);
                    }
                }
            });
        });
    }
    
    async createAllocation(obraId, date) {
        this.showLoading(true);
        
        try {
            const response = await fetch('/api/equipe/allocations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    obra_id: parseInt(obraId),
                    data_alocacao: date
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                await this.loadAllocations();
                this.renderAllocations();
                this.showSuccess('Obra alocada com sucesso');
            } else {
                this.showError(result.error);
            }
        } catch (error) {
            console.error('Erro ao criar aloca√ß√£o:', error);
            this.showError('Erro ao alocar obra');
        } finally {
            this.showLoading(false);
        }
    }
    
    async deleteAllocation(allocationId) {
        this.showLoading(true);
        
        try {
            const response = await fetch(`/api/equipe/allocations/${allocationId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                await this.loadAllocations();
                this.renderAllocations();
                this.showSuccess('Aloca√ß√£o removida');
            } else {
                this.showError(result.error);
            }
        } catch (error) {
            console.error('Erro ao deletar aloca√ß√£o:', error);
            this.showError('Erro ao remover aloca√ß√£o');
        } finally {
            this.showLoading(false);
        }
    }
    
    openEmployeeModal(allocationId) {
        // TODO: Implementar modal de funcion√°rios
        console.log('Abrir funcion√°rios para aloca√ß√£o:', allocationId);
    }
    
    showLoading(show) {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.toggle('d-none', !show);
    }
    
    showSuccess(message) {
        // Toast simples
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 2001;';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    showError(message) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-danger position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 2001;';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
}

// Fun√ß√µes globais para navega√ß√£o
function navigateWeek(direction) {
    const currentDate = new Date('{{ monday.strftime("%Y-%m-%d") }}');
    currentDate.setDate(currentDate.getDate() + (direction * 7));
    
    const newWeek = currentDate.toISOString().split('T')[0];
    window.location.href = `?week=${newWeek}`;
}

function goToToday() {
    window.location.href = window.location.pathname;
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    window.equipeManager = new EquipeManager();
});
</script>
{% endblock %}
```

## INSTRU√á√ïES DE IMPLEMENTA√á√ÉO

### 1. BACKEND (Marcus Silva)
- Implemente os modelos exatamente como especificado
- APIs devem retornar JSON padronizado sempre
- Valida√ß√£o rigorosa em todos os endpoints
- Logs estruturados para debugging
- Testes unit√°rios para endpoints cr√≠ticos

### 2. FRONTEND (Ana Costa)
- HTML estrutural e sem√¢ntico
- CSS m√≠nimo, focado na funcionalidade
- JavaScript modular e perform√°tico
- SortableJS para drag & drop (leve e confi√°vel)
- Progressive Enhancement

### 3. BIBLIOTECAS RECOMENDADAS
**Drag & Drop:**
- **SortableJS** (escolhido): 45KB, sem depend√™ncias, touch support
- Pragmatic Drag & Drop: Performance superior, mais complexo
- dnd-kit: Apenas se usar React

**Calend√°rio (se necess√°rio):**
- **FullCalendar**: Maduro, completo
- Schedule-X: Moderno, alternativa ao FullCalendar

### 4. PR√ìXIMOS PASSOS
1. Implementar backend conforme especificado
2. Criar HTML estrutural limpo
3. Adicionar JavaScript modular
4. Testar drag & drop b√°sico
5. Implementar modal de funcion√°rios
6. Adicionar vista mensal
7. Weekly planner

**FOCO:** Fazer o b√°sico funcionar perfeitamente antes de adicionar funcionalidades extras.

