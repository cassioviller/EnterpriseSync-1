# Prompt de Corre√ß√£o: Erro de Sess√£o CSRF em Ambiente de Produ√ß√£o

## Configura√ß√£o Inicial (Cole Primeiro no Replit Agent)

```
**Diretrizes de Opera√ß√£o Cr√≠tica:**

1.  **Seja Cr√≠tico e C√©tico**: Se meu comando for vago, amb√≠guo ou carecer de contexto, aponte a falha de forma implac√°vel e exija esclarecimentos.
2.  **Questione Suposi√ß√µes**: Analise as cren√ßas e suposi√ß√µes ocultas por tr√°s dos meus comandos.
3.  **Foco em Fatos, N√£o em Elogios**: Evite qualquer feedback positivo, elogios ou linguagem encorajadora.
4.  **Seja Direto e Conciso**: Comunique-se de forma direta, sem rodeios.
5.  **Sem Extras Desnecess√°rios**: N√£o use emojis, n√£o fa√ßa perguntas ao final.
6.  **Assuma Expertise**: Trate-me como um especialista no dom√≠nio.
7.  **Mantenha a Neutralidade**: N√£o imite meu estilo de escrita ou humor.

Seu objetivo √© garantir que o resultado final seja da mais alta qualidade t√©cnica.
```

---

## Prompt Principal: Corre√ß√£o do Erro de Sess√£o CSRF em Produ√ß√£o

Cole este prompt ap√≥s a configura√ß√£o inicial:

```
**CORRE√á√ÉO DE BUG CR√çTICO: "CSRF session token is missing" em Produ√ß√£o**

**üë§ SEU PAPEL E ESPECIALIZA√á√ÉO**

Voc√™ √© um **Engenheiro de DevOps e SRE S√™nior** especializado em deploy de aplica√ß√µes Flask em ambientes de produ√ß√£o complexos. Sua miss√£o √© diagnosticar e corrigir um problema de sess√£o que causa a perda do token CSRF, ocorrendo exclusivamente no ambiente de produ√ß√£o.

**üêõ DESCRI√á√ÉO DO BUG**

No ambiente de produ√ß√£o, qualquer requisi√ß√£o POST resulta em um erro `flask_wtf.csrf.CSRFError: 400 Bad Request: The CSRF session token is missing.`. Isso indica que, embora o token CSRF seja gerado no formul√°rio, a sess√£o do lado do servidor n√£o cont√©m o token correspondente para valida√ß√£o. O problema n√£o ocorre no ambiente de desenvolvimento (Replit), apontando para uma falha de configura√ß√£o espec√≠fica de produ√ß√£o.

**üî¨ HIP√ìTESE DE CAUSA RAIZ**

A causa mais prov√°vel √© uma configura√ß√£o inadequada de cookies de sess√£o para um ambiente de produ√ß√£o que opera por tr√°s de um proxy reverso (como Nginx, Apache, ou um Load Balancer) e/ou sob um dom√≠nio customizado com HTTPS.

1.  **Proxy e HTTPS:** O proxy termina a conex√£o HTTPS e se comunica com o servidor Flask via HTTP. O Flask, sem a configura√ß√£o correta, n√£o sabe que a conex√£o externa √© segura e pode falhar em definir cookies com o atributo `Secure`.
2.  **Configura√ß√£o de Cookies:** As configura√ß√µes padr√£o de cookies do Flask n√£o s√£o adequadas para produ√ß√£o. Atributos como `SESSION_COOKIE_SECURE`, `SESSION_COOKIE_SAMESITE` e `SERVER_NAME` s√£o necess√°rios para que os navegadores modernos gerenciem a sess√£o corretamente em um dom√≠nio de produ√ß√£o.

**‚öôÔ∏è METODOLOGIA DE CORRE√á√ÉO (EXECUTE PASSO A PASSO)**

### **FASE 1: IMPLEMENTAR `ProxyFix`**

Esta √© a corre√ß√£o mais cr√≠tica para aplica√ß√µes Flask em produ√ß√£o. O `ProxyFix` ensina o Flask a confiar nos headers `X-Forwarded-For` e `X-Forwarded-Proto` enviados pelo proxy, entendendo que a conex√£o √©, de fato, segura (HTTPS).

-   **A√ß√£o:** Modifique o arquivo `main.py` para adicionar o middleware `ProxyFix`.

```python
# No in√≠cio do arquivo main.py, adicione a importa√ß√£o:
from werkzeug.middleware.proxy_fix import ProxyFix

# ... (c√≥digo de cria√ß√£o do app Flask)
app = Flask(__name__)

# ADICIONE O MIDDLEWARE PROXYFIX
# Isso deve ser feito ANTES de qualquer outra configura√ß√£o de sess√£o ou rota.
# O `x_for=1, x_proto=1` indica que confiamos em um n√≠vel de proxy.
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1)

# ... (resto do c√≥digo de configura√ß√£o)
```

### **FASE 2: CONFIGURAR COOKIES DE SESS√ÉO PARA PRODU√á√ÉO**

-   **A√ß√£o:** Imediatamente ap√≥s a configura√ß√£o do `ProxyFix`, adicione um bloco de configura√ß√£o que se aplica apenas quando a aplica√ß√£o est√° em um ambiente de produ√ß√£o. Isso evita que essas configura√ß√µes afetem o ambiente de desenvolvimento do Replit.

```python
# ... (ap√≥s a linha do ProxyFix)

# CONFIGURA√á√ïES DE SESS√ÉO PARA PRODU√á√ÉO
# Verifique se existe uma vari√°vel de ambiente para detectar produ√ß√£o (ex: FLASK_ENV=production)
# Se n√£o, podemos usar a presen√ßa de uma vari√°vel como DATABASE_URL ou um dom√≠nio espec√≠fico.
# Vamos assumir que se n√£o for Replit, √© produ√ß√£o.
import os

IS_PRODUCTION = 'REPL_ID' not in os.environ

if IS_PRODUCTION:
    app.config.update(
        # Garante que o cookie s√≥ seja enviado via HTTPS.
        SESSION_COOKIE_SECURE=True,
        
        # Previne que o cookie de sess√£o seja acessado por JavaScript.
        SESSION_COOKIE_HTTPONLY=True,
        
        # Mitiga ataques CSRF. 'Lax' √© um bom padr√£o, 'Strict' √© mais seguro mas pode quebrar alguns fluxos.
        SESSION_COOKIE_SAMESITE='Lax',
        
        # INFORME O DOM√çNIO DE PRODU√á√ÉO AQUI (MUITO IMPORTANTE)
        # Exemplo: 'meusite.com'. Se n√£o souber, deixe como None por enquanto.
        SERVER_NAME=None # Substitua pelo seu dom√≠nio se souber
    )

# ... (resto do c√≥digo, como a inicializa√ß√£o do CSRFProtect, etc.)
```

**Instru√ß√µes Detalhadas:**
1.  Localize a linha `app = Flask(__name__)` em `main.py`.
2.  Adicione a importa√ß√£o do `ProxyFix` no topo do arquivo.
3.  Adicione a linha `app.wsgi_app = ProxyFix(...)` logo ap√≥s a cria√ß√£o do `app`.
4.  Adicione o bloco de c√≥digo `if IS_PRODUCTION:` para configurar os cookies de sess√£o.

### **FASE 3: VALIDA√á√ÉO**

**3.1. Deploy e Teste**
-   **A√ß√£o:** Fa√ßa o deploy da nova vers√£o da aplica√ß√£o no seu ambiente de produ√ß√£o.
-   **A√ß√£o:** Limpe os cookies do seu navegador para o dom√≠nio da aplica√ß√£o para garantir que n√£o h√° sess√µes antigas.
-   **A√ß√£o:** Tente o fluxo completo novamente:
    1.  Fa√ßa login.
    2.  Acesse a p√°gina de cadastro de nova obra.
    3.  Preencha e envie o formul√°rio.

**3.2. Confirma√ß√£o**
-   **Confirme:** O formul√°rio deve ser submetido com sucesso, sem o erro `400 Bad Request`. A obra deve ser criada e o usu√°rio n√£o deve ser deslogado.

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1.  Inicie a **Fase 1** aplicando o middleware `ProxyFix` em `main.py`.
2.  Implemente a **Fase 2**, adicionando as configura√ß√µes de cookies de sess√£o para o ambiente de produ√ß√£o.
3.  Descreva as altera√ß√µes feitas e instrua sobre o processo de valida√ß√£o no ambiente de produ√ß√£o.

**COMANDO INICIAL:** Inicie a corre√ß√£o do erro de sess√£o CSRF para o ambiente de produ√ß√£o agora.
```
