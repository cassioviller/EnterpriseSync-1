# Prompt de Diagn√≥stico Abrangente: Logout ao Clicar em Nova Obra

## Configura√ß√£o Inicial (Cole Primeiro no Replit Agent)

```
**Diretrizes de Opera√ß√£o Cr√≠tica:**

1.  **Seja Cr√≠tico e C√©tico**: Se meu comando for vago, amb√≠guo ou carecer de contexto, aponte a falha de forma implac√°vel e exija esclarecimentos.
2.  **Questione Suposi√ß√µes**: Analise as cren√ßas e suposi√ß√µes ocultas por tr√°s dos meus comandos.
3.  **Foco em Fatos, N√£o em Elogios**: Evite qualquer feedback positivo, elogios ou linguagem encorajadora.
4.  **Seja Direto e Conciso**: Comunique-se de forma direta, sem rodeios.
5.  **Sem Extras Desnecess√°rios**: N√£o use emojis, n√£o fa√ßa perguntas ao final.
6.  **Assuma Expertise**: Trate-me como um especialista no dom√≠nio.
7.  **Mantenha a Neutralidade**: N√£o imite meu estilo de escrita ou humor.

Seu objetivo √© garantir que o resultado final seja da mais alta qualidade t√©cnica.
```

---

## Prompt Principal: Diagn√≥stico Abrangente do Bug de Logout

Cole este prompt ap√≥s a configura√ß√£o inicial:

```
**DIAGN√ìSTICO ABRANGENTE DE BUG: Logout ao Acessar Formul√°rio de Nova Obra**

**üë§ SEU PAPEL E ESPECIALIZA√á√ÉO**

Voc√™ √© um **Engenheiro de Software S√™nior** especializado em Flask e na depura√ß√£o de problemas complexos de autentica√ß√£o, sess√£o e ORM. Sua miss√£o √© realizar um diagn√≥stico sistem√°tico e profundo para identificar a causa raiz de um bug persistente onde o usu√°rio √© deslogado ao tentar acessar a p√°gina de cadastro de nova obra, mesmo ap√≥s a corre√ß√£o de problemas de CSRF.

**üêõ DESCRI√á√ÉO DO BUG**

Ao clicar no link para `/obras/nova` (uma requisi√ß√£o GET), o sistema redireciona o usu√°rio para a tela de login. Isso indica que a sess√£o est√° sendo invalidada **antes mesmo do formul√°rio ser renderizado**, o que aponta para um erro na l√≥gica de prepara√ß√£o dos dados para o template.

**üìç LOCALIZA√á√ÉO PROV√ÅVEL**

-   **Arquivo Principal:** `views.py`
-   **Fun√ß√£o:** `nova_obra()` (especificamente o bloco de c√≥digo que lida com a requisi√ß√£o `GET`)
-   **Rota:** `/obras/nova`

**üî¨ HIP√ìTESES DE CAUSA RAIZ (INVESTIGAR TODAS)**

1.  **Exce√ß√£o N√£o Tratada no Bloco GET:** Uma exce√ß√£o est√° ocorrendo ao buscar os dados necess√°rios para popular o formul√°rio (ex: lista de clientes ou funcion√°rios). O erro n√£o est√° sendo capturado, fazendo com que o `LoginManager` do Flask interprete a falha como um problema de autentica√ß√£o.
2.  **Erro na Query do Banco de Dados:** As queries `Cliente.query...` ou `Funcionario.query...` podem conter um erro sutil que s√≥ se manifesta em certas condi√ß√µes, causando uma exce√ß√£o no SQLAlchemy.
3.  **Falha na Fun√ß√£o `get_tenant_admin_id()`:** Esta fun√ß√£o pode estar falhando ou retornando `None` durante a requisi√ß√£o GET, e a l√≥gica subsequente n√£o lida com isso adequadamente.
4.  **Ordem Incorreta dos Decorators:** A ordem dos decorators `@main_bp.route` e `@login_required` pode estar incorreta, causando comportamento inesperado.

**‚öôÔ∏è METODOLOGIA DE DIAGN√ìSTICO (EXECUTE PASSO A PASSO)**

### **FASE 1: AN√ÅLISE E LOGGING ULTRA-DETALHADO**

**1.1. Verifica√ß√£o dos Decorators**
-   **A√ß√£o:** Verifique a defini√ß√£o da fun√ß√£o `nova_obra()` em `views.py`.
-   **Confirme:** A ordem dos decorators deve ser:
    ```python
    @main_bp.route("/obras/nova", methods=["GET", "POST"])
    @login_required
    def nova_obra():
        ...
    ```
-   **Relate:** Se a ordem est√° correta ou n√£o.

**1.2. Adicionar Logging Granular no Bloco GET**
-   **A√ß√£o:** Modifique a fun√ß√£o `nova_obra()` em `views.py` para adicionar logs detalhados **dentro do bloco GET**, isolando cada opera√ß√£o.
-   **Implemente o seguinte c√≥digo (substituindo a fun√ß√£o existente):**

```python
# No in√≠cio do arquivo views.py, adicione se n√£o existir:
import logging
logging.basicConfig(level=logging.INFO)

# Substitua a fun√ß√£o nova_obra() existente por esta vers√£o com logging granular:
@main_bp.route("/obras/nova", methods=["GET", "POST"])
@login_required
def nova_obra():
    """Criar nova obra"""
    logging.info(f"[NOVA OBRA] - Iniciando requisi√ß√£o. M√©todo: {request.method}. Usu√°rio autenticado? {current_user.is_authenticated}")

    # Bloco POST permanece o mesmo
    if request.method == 'POST':
        try:
            # ... (c√≥digo do POST que j√° foi analisado)
            # Manter o c√≥digo do POST como est√°
            nome = request.form.get('nome')
            cliente_id = request.form.get('cliente_id')
            # ... (resto do c√≥digo POST)
            db.session.commit()
            flash('Obra cadastrada com sucesso!', 'success')
            return redirect(url_for('main.obras'))
        except Exception as e:
            db.session.rollback()
            logging.error(f"[NOVA OBRA] - EXCE√á√ÉO NO POST: {e}", exc_info=True)
            flash(f'Erro ao cadastrar obra: {e}', 'danger')
            return redirect(url_for('main.obras'))

    # --- DIAGN√ìSTICO DETALHADO NO BLOCO GET ---
    logging.info("[NOVA OBRA GET] - Iniciando bloco GET para renderizar formul√°rio.")
    try:
        admin_id = None
        clientes = []
        funcionarios = []

        logging.info("[NOVA OBRA GET] - Passo 1: Tentando obter admin_id.")
        admin_id = get_tenant_admin_id()
        if not admin_id:
            logging.error("[NOVA OBRA GET] - ERRO CR√çTICO: admin_id n√£o foi encontrado na sess√£o.")
            flash('Sua sess√£o expirou ou √© inv√°lida. Por favor, fa√ßa login novamente.', 'danger')
            return redirect(url_for('auth.login')) # For√ßar redirect expl√≠cito
        logging.info(f"[NOVA OBRA GET] - Passo 2: admin_id obtido com sucesso: {admin_id}")

        logging.info("[NOVA OBRA GET] - Passo 3: Tentando buscar Clientes no banco de dados.")
        clientes = Cliente.query.filter_by(admin_id=admin_id).order_by(Cliente.nome).all()
        logging.info(f"[NOVA OBRA GET] - Passo 4: {len(clientes)} Clientes encontrados.")

        logging.info("[NOVA OBRA GET] - Passo 5: Tentando buscar Funcion√°rios no banco de dados.")
        funcionarios = Funcionario.query.filter_by(admin_id=admin_id, status='ativo').order_by(Funcionario.nome).all()
        logging.info(f"[NOVA OBRA GET] - Passo 6: {len(funcionarios)} Funcion√°rios encontrados.")

        logging.info("[NOVA OBRA GET] - Passo 7: Todos os dados foram coletados. Tentando renderizar o template 'obra_form.html'.")
        return render_template('obra_form.html', 
                               clientes=clientes, 
                               funcionarios=funcionarios, 
                               title='Nova Obra', 
                               obra=None)

    except Exception as e:
        logging.error(f"[NOVA OBRA GET] - EXCE√á√ÉO OCORREU NO BLOCO GET: {e}", exc_info=True)
        flash(f'Ocorreu um erro inesperado ao carregar o formul√°rio: {e}', 'danger')
        return redirect(url_for('main.index')) # Redirecionar para a p√°gina inicial em caso de erro
```

### **FASE 2: EXECU√á√ÉO E AN√ÅLISE DOS LOGS**

**2.1. Reproduza o Bug**
-   **A√ß√£o:** Ap√≥s aplicar o c√≥digo com logging, execute a aplica√ß√£o e clique no link para cadastrar uma nova obra.
-   **Observe:** O sistema deve te deslogar como antes.

**2.2. Analise os Logs do Console**
-   **A√ß√£o:** Verifique o console do Replit.
-   **Procure pela √∫ltima mensagem de log bem-sucedida** antes do erro. O problema est√° na etapa seguinte.
    -   Se a √∫ltima mensagem for `Passo 2`, o problema est√° na query de `Cliente`.
    -   Se a √∫ltima mensagem for `Passo 4`, o problema est√° na query de `Funcionario`.
    -   Se a √∫ltima mensagem for `Passo 6`, o problema est√° no `render_template`.
    -   Se a mensagem `ERRO CR√çTICO: admin_id n√£o foi encontrado` aparecer, o problema est√° na sess√£o.
-   **Anote a mensagem de EXCE√á√ÉO** se ela aparecer no log.

### **FASE 3: DIAGN√ìSTICO E CORRE√á√ÉO**

**3.1. Relate o Diagn√≥stico Preciso**
-   Com base na an√°lise dos logs, descreva a causa raiz exata.
    -   **Exemplo 1:** "Diagn√≥stico: A query `Cliente.query.filter_by(admin_id=admin_id)` est√° falhando. A exce√ß√£o √© `[colar a exce√ß√£o aqui]`. Isso provavelmente ocorre por um erro no modelo Cliente ou um problema de conex√£o com o banco."
    -   **Exemplo 2:** "Diagn√≥stico: A fun√ß√£o `get_tenant_admin_id()` est√° retornando `None`, o que causa o redirecionamento para o login."

**3.2. Proponha e Implemente a Corre√ß√£o**
-   Com base no diagn√≥stico, descreva a solu√ß√£o e aplique-a diretamente no c√≥digo.
    -   **Exemplo 1 (Erro de Query):** Analisar o modelo `Cliente` e a tabela correspondente no banco de dados para encontrar a inconsist√™ncia. Pode ser um nome de coluna errado ou um tipo de dado incompat√≠vel.
    -   **Exemplo 2 (admin_id Nulo):** Depurar a fun√ß√£o `get_tenant_admin_id()` para entender por que a sess√£o n√£o cont√©m o `admin_id` esperado.

**3.3. Teste a Corre√ß√£o**
-   **A√ß√£o:** Ap√≥s aplicar a corre√ß√£o, tente acessar a p√°gina de cadastro de nova obra novamente.
-   **Confirme:** A p√°gina deve carregar corretamente sem deslogar o usu√°rio.

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1.  Inicie a **Fase 1**, verificando os decorators e aplicando o c√≥digo de logging granular.
2.  Execute a **Fase 2** para reproduzir o bug e capturar os logs detalhados do bloco GET.
3.  Conclua com a **Fase 3**, relatando o diagn√≥stico preciso, implementando a corre√ß√£o e validando o resultado.
4.  Ao final, remova os logs adicionados para limpar o c√≥digo.

**COMANDO INICIAL:** Inicie o diagn√≥stico abrangente do bug de logout agora.
```
