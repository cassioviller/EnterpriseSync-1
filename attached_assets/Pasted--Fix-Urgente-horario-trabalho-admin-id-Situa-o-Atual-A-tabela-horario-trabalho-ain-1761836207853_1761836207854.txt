# Fix Urgente: `horario_trabalho.admin_id`

## Situa√ß√£o Atual

A tabela `horario_trabalho` **ainda n√£o tem a coluna `admin_id`** no banco de produ√ß√£o, causando erros em **2 p√°ginas diferentes**.

---

## Erros Confirmados

### Erro 1: P√°gina de Configura√ß√µes de Hor√°rios

**Origem:**
- Arquivo: `/app/configuracoes_views.py`, linha 348
- C√≥digo: `HorarioTrabalho.query.filter_by(admin_id=admin_id).all()`

**SQL que falha:**
```sql
SELECT horario_trabalho.id, horario_trabalho.nome, ..., horario_trabalho.admin_id
FROM horario_trabalho 
WHERE horario_trabalho.admin_id = 2
```

**Erro:**
```
psycopg2.errors.UndefinedColumn: column horario_trabalho.admin_id does not exist
```

---

### Erro 2: P√°gina de Funcion√°rios (Lazy Loading)

**Origem:**
- Arquivo: `/app/views.py`, linha 1680
- Template: `/app/templates/funcionarios.html`, linha 504
- C√≥digo: `{{ kpi.funcionario.horario_trabalho.nome if kpi.funcionario.horario_trabalho else 'N√£o definido' }}`

**SQL que falha:**
```sql
SELECT horario_trabalho.id, horario_trabalho.nome, ..., horario_trabalho.admin_id
FROM horario_trabalho 
WHERE horario_trabalho.id = 1
```

**Erro:**
```
psycopg2.errors.UndefinedColumn: column horario_trabalho.admin_id does not exist
```

**Causa:**
- SQLAlchemy faz **lazy loading** do relacionamento `funcionario.horario_trabalho`
- Tenta carregar a tabela `horario_trabalho` incluindo `admin_id`
- Coluna n√£o existe no banco

---

## Dados Atuais no Banco

```json
[
  {
    "id": 1,
    "nome": "Seg a Sex ",
    "entrada": "07:12:00",
    "saida_almoco": "12:00:00",
    "retorno_almoco": "13:00:00",
    "saida": "17:00:00",
    "dias_semana": "1,2,3,4,5",
    "horas_diarias": 8.8,
    "valor_hora": 12,
    "created_at": "2025-07-24 11:50:29.715057"
    // ‚ùå SEM admin_id
  },
  {
    "id": 2,
    "nome": "Estagiario",
    "entrada": "07:12:00",
    "saida_almoco": "12:11:00",
    "retorno_almoco": "12:11:00",
    "saida": "12:12:00",
    "dias_semana": "1,2,3,4,5",
    "horas_diarias": 5,
    "valor_hora": 12,
    "created_at": "2025-07-24 12:09:47.818042"
    // ‚ùå SEM admin_id
  }
]
```

---

## Solu√ß√£o: Script SQL Simplificado

### Arquivo: `fix_horario_trabalho_urgente.sql`

```sql
-- ============================================================================
-- FIX URGENTE: horario_trabalho.admin_id
-- ============================================================================

BEGIN;

DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'horario_trabalho' AND column_name = 'admin_id'
    ) THEN
        RAISE NOTICE '‚è≠Ô∏è  horario_trabalho.admin_id j√° existe - nada a fazer';
        RETURN;
    END IF;
    
    RAISE NOTICE 'üîÑ Corrigindo tabela horario_trabalho...';
    
    -- PASSO 1: Adicionar coluna
    ALTER TABLE horario_trabalho ADD COLUMN admin_id INTEGER;
    RAISE NOTICE '   ‚úÖ Coluna adicionada';
    
    -- PASSO 2: Backfill via funcionario.horario_trabalho_id
    UPDATE horario_trabalho ht
    SET admin_id = f.admin_id
    FROM funcionario f
    WHERE f.horario_trabalho_id = ht.id
      AND ht.admin_id IS NULL
      AND f.admin_id IS NOT NULL;
    
    RAISE NOTICE '   ‚úÖ Backfill via funcionario conclu√≠do';
    
    -- PASSO 3: Aplicar admin_id padr√£o (2) para registros √≥rf√£os
    UPDATE horario_trabalho 
    SET admin_id = 2 
    WHERE admin_id IS NULL;
    
    RAISE NOTICE '   ‚úÖ Registros √≥rf√£os corrigidos (admin_id = 2)';
    
    -- PASSO 4: Aplicar NOT NULL
    ALTER TABLE horario_trabalho ALTER COLUMN admin_id SET NOT NULL;
    RAISE NOTICE '   ‚úÖ Constraint NOT NULL aplicada';
    
    -- PASSO 5: Adicionar foreign key
    ALTER TABLE horario_trabalho
    ADD CONSTRAINT fk_horario_trabalho_admin_id
    FOREIGN KEY (admin_id) REFERENCES usuario(id) ON DELETE CASCADE;
    
    RAISE NOTICE '   ‚úÖ Foreign key criada';
    
    -- PASSO 6: Criar √≠ndice
    CREATE INDEX idx_horario_trabalho_admin_id ON horario_trabalho(admin_id);
    RAISE NOTICE '   ‚úÖ √çndice criado';
    
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ horario_trabalho CORRIGIDA COM SUCESSO!';
    
END $$;

COMMIT;

-- Valida√ß√£o
SELECT 
    'horario_trabalho' as tabela,
    COUNT(*) as total,
    COUNT(admin_id) as com_admin_id,
    COUNT(*) - COUNT(admin_id) as sem_admin_id,
    COUNT(DISTINCT admin_id) as admins_distintos
FROM horario_trabalho;

-- Mostrar dados
SELECT id, nome, admin_id FROM horario_trabalho ORDER BY id;
```

---

## Como Executar

### Op√ß√£o 1: Via psql (Recomendado)

```bash
psql -U usuario -d nome_banco -f fix_horario_trabalho_urgente.sql
```

### Op√ß√£o 2: Via pgAdmin ou DBeaver

1. Abrir o arquivo `fix_horario_trabalho_urgente.sql`
2. Copiar todo o conte√∫do
3. Colar na janela de query
4. Executar

### Op√ß√£o 3: Via Python (Flask Shell)

```python
from app import app, db

with app.app_context():
    connection = db.engine.raw_connection()
    cursor = connection.cursor()
    
    # Ler e executar o script
    with open('fix_horario_trabalho_urgente.sql', 'r') as f:
        sql = f.read()
        cursor.execute(sql)
    
    connection.commit()
    cursor.close()
    connection.close()
    
    print("‚úÖ Script executado com sucesso!")
```

---

## Resultado Esperado

### Sa√≠da do Script

```
üîÑ Corrigindo tabela horario_trabalho...
   ‚úÖ Coluna adicionada
   ‚úÖ Backfill via funcionario conclu√≠do
   ‚úÖ Registros √≥rf√£os corrigidos (admin_id = 2)
   ‚úÖ Constraint NOT NULL aplicada
   ‚úÖ Foreign key criada
   ‚úÖ √çndice criado

‚úÖ horario_trabalho CORRIGIDA COM SUCESSO!

      tabela       | total | com_admin_id | sem_admin_id | admins_distintos
-------------------+-------+--------------+--------------+------------------
 horario_trabalho  |     2 |            2 |            0 |                1

 id |     nome      | admin_id
----+---------------+----------
  1 | Seg a Sex     |        2
  2 | Estagiario    |        2
```

---

## Valida√ß√£o P√≥s-Execu√ß√£o

### 1. Verificar Estrutura da Tabela

```sql
SELECT 
    column_name, 
    data_type, 
    is_nullable,
    column_default
FROM information_schema.columns 
WHERE table_name = 'horario_trabalho' 
ORDER BY ordinal_position;
```

**Resultado esperado:**
```
   column_name    | data_type | is_nullable | column_default
------------------+-----------+-------------+----------------
 id               | integer   | NO          | nextval(...)
 nome             | varchar   | YES         | NULL
 entrada          | time      | YES         | NULL
 saida_almoco     | time      | YES         | NULL
 retorno_almoco   | time      | YES         | NULL
 saida            | time      | YES         | NULL
 dias_semana      | varchar   | YES         | NULL
 horas_diarias    | numeric   | YES         | NULL
 valor_hora       | numeric   | YES         | NULL
 admin_id         | integer   | NO          | NULL  ‚úÖ ADICIONADO
 created_at       | timestamp | YES         | NULL
```

### 2. Verificar Foreign Key

```sql
SELECT 
    constraint_name,
    table_name,
    constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'horario_trabalho'
  AND constraint_type = 'FOREIGN KEY';
```

**Resultado esperado:**
```
        constraint_name         |    table_name     | constraint_type
--------------------------------+-------------------+-----------------
 fk_horario_trabalho_admin_id   | horario_trabalho  | FOREIGN KEY  ‚úÖ
```

### 3. Verificar √çndice

```sql
SELECT 
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'horario_trabalho'
  AND indexname LIKE '%admin_id%';
```

**Resultado esperado:**
```
         indexname              |                    indexdef
--------------------------------+------------------------------------------------
 idx_horario_trabalho_admin_id  | CREATE INDEX ... ON horario_trabalho(admin_id)  ‚úÖ
```

### 4. Testar Query que Estava Falhando

```sql
-- Query da p√°gina de configura√ß√µes
SELECT * FROM horario_trabalho WHERE admin_id = 2;
```

**Resultado esperado:**
```
 id |     nome      | entrada  | saida_almoco | retorno_almoco |  saida   | dias_semana | horas_diarias | valor_hora | admin_id |       created_at
----+---------------+----------+--------------+----------------+----------+-------------+---------------+------------+----------+---------------------
  1 | Seg a Sex     | 07:12:00 | 12:00:00     | 13:00:00       | 17:00:00 | 1,2,3,4,5   |           8.8 |         12 |        2 | 2025-07-24 11:50:29
  2 | Estagiario    | 07:12:00 | 12:11:00     | 12:11:00       | 12:12:00 | 1,2,3,4,5   |             5 |         12 |        2 | 2025-07-24 12:09:47
```

‚úÖ **Query funciona!**

---

## Testes Funcionais

Ap√≥s executar o script, testar:

### ‚úÖ Teste 1: P√°gina de Configura√ß√µes de Hor√°rios

1. Acessar `/configuracoes/horarios`
2. Verificar que a p√°gina carrega sem erros
3. Verificar que os 2 hor√°rios s√£o exibidos:
   - "Seg a Sex"
   - "Estagiario"

### ‚úÖ Teste 2: P√°gina de Funcion√°rios

1. Acessar `/funcionarios`
2. Verificar que a p√°gina carrega sem erros
3. Verificar que o hor√°rio de trabalho √© exibido nos KPIs
4. Verificar que n√£o h√° erro de lazy loading

### ‚úÖ Teste 3: Criar Novo Hor√°rio

1. Acessar `/configuracoes/horarios`
2. Clicar em "Novo Hor√°rio"
3. Preencher dados e salvar
4. Verificar que `admin_id` √© preenchido automaticamente

---

## Troubleshooting

### Problema: Script n√£o executa

**Causa:** Permiss√µes insuficientes

**Solu√ß√£o:**
```bash
# Executar como superuser
psql -U postgres -d nome_banco -f fix_horario_trabalho_urgente.sql
```

### Problema: Erro "relation does not exist"

**Causa:** Nome do banco de dados incorreto

**Solu√ß√£o:**
```bash
# Listar bancos dispon√≠veis
psql -U usuario -l

# Conectar ao banco correto
psql -U usuario -d nome_correto -f fix_horario_trabalho_urgente.sql
```

### Problema: Erro "column already exists"

**Causa:** Script j√° foi executado anteriormente

**Solu√ß√£o:**
- ‚úÖ Isso √© esperado! O script √© idempotente
- Verificar com: `SELECT * FROM horario_trabalho LIMIT 1;`
- Se `admin_id` aparece, est√° tudo OK

### Problema: Registros com admin_id NULL

**Causa:** Backfill n√£o funcionou

**Solu√ß√£o:**
```sql
-- Aplicar admin_id padr√£o manualmente
UPDATE horario_trabalho SET admin_id = 2 WHERE admin_id IS NULL;
```

---

## Resumo

### Problema
- Tabela `horario_trabalho` sem coluna `admin_id`
- Quebra 2 p√°ginas: configura√ß√µes de hor√°rios e funcion√°rios

### Solu√ß√£o
- Script SQL simples e direto: `fix_horario_trabalho_urgente.sql`
- Adiciona coluna + backfill + constraints + FK + √≠ndice
- Idempotente e seguro

### Execu√ß√£o
```bash
psql -U usuario -d nome_banco -f fix_horario_trabalho_urgente.sql
```

### Valida√ß√£o
- Verificar estrutura da tabela
- Testar queries
- Testar p√°ginas afetadas

### Resultado
‚úÖ Sistema funcionando normalmente
