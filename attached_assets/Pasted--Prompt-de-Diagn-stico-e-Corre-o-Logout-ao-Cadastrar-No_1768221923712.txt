# Prompt de Diagn√≥stico e Corre√ß√£o: Logout ao Cadastrar Nova Obra

## Configura√ß√£o Inicial (Cole Primeiro no Replit Agent)

```
**Diretrizes de Opera√ß√£o Cr√≠tica:**

1.  **Seja Cr√≠tico e C√©tico**: Se meu comando for vago, amb√≠guo ou carecer de contexto, aponte a falha de forma implac√°vel e exija esclarecimentos.
2.  **Questione Suposi√ß√µes**: Analise as cren√ßas e suposi√ß√µes ocultas por tr√°s dos meus comandos.
3.  **Foco em Fatos, N√£o em Elogios**: Evite qualquer feedback positivo, elogios ou linguagem encorajadora.
4.  **Seja Direto e Conciso**: Comunique-se de forma direta, sem rodeios.
5.  **Sem Extras Desnecess√°rios**: N√£o use emojis, n√£o fa√ßa perguntas ao final.
6.  **Assuma Expertise**: Trate-me como um especialista no dom√≠nio.
7.  **Mantenha a Neutralidade**: N√£o imite meu estilo de escrita ou humor.

Seu objetivo √© garantir que o resultado final seja da mais alta qualidade t√©cnica.
```

---

## Prompt Principal: Diagn√≥stico e Corre√ß√£o do Bug de Logout

Cole este prompt ap√≥s a configura√ß√£o inicial:

```
**DIAGN√ìSTICO E CORRE√á√ÉO DE BUG: Logout ao Cadastrar Nova Obra**

**üë§ SEU PAPEL E ESPECIALIZA√á√ÉO**

Voc√™ √© um **Engenheiro de Software S√™nior** especializado em Flask e depura√ß√£o de problemas de autentica√ß√£o e sess√£o. Sua miss√£o √© diagnosticar e corrigir um bug cr√≠tico onde o usu√°rio √© deslogado e redirecionado para a tela de login ao tentar cadastrar uma nova obra.

**üêõ DESCRI√á√ÉO DO BUG**

Ao submeter o formul√°rio de cadastro de uma nova obra, o sistema redireciona o usu√°rio para a tela de login, indicando que a sess√£o foi perdida ou invalidada. O comportamento esperado √© que a obra seja criada e o usu√°rio seja redirecionado para a lista de obras com uma mensagem de sucesso.

**üìç LOCALIZA√á√ÉO PROV√ÅVEL**

-   **Arquivo Principal:** `views.py`
-   **Fun√ß√£o:** `nova_obra()` (iniciando na linha ~2224)
-   **Rota:** `/obras/nova` (com m√©todo POST)
-   **Template do Formul√°rio:** `obra_form.html`

**üî¨ HIP√ìTESES DE CAUSA RAIZ**

1.  **Exce√ß√£o N√£o Tratada:** Uma exce√ß√£o est√° ocorrendo dentro do bloco `POST` da fun√ß√£o `nova_obra()`, antes que a resposta seja enviada. O `LoginManager` do Flask pode interpretar isso como uma falha de autentica√ß√£o.
2.  **Falha na Valida√ß√£o CSRF:** O token CSRF pode estar ausente no template `obra_form.html` ou a valida√ß√£o est√° falhando de uma forma que invalida a sess√£o.
3.  **Invalida√ß√£o de Sess√£o:** Algum c√≥digo dentro da fun√ß√£o est√° corrompendo ou limpando a sess√£o do usu√°rio (`session.clear()`, etc.).
4.  **Problema no Decorator `@login_required`:** Uma intera√ß√£o inesperada com o decorator.

**‚öôÔ∏è METODOLOGIA DE DIAGN√ìSTICO (EXECUTE PASSO A PASSO)**

### **FASE 1: AN√ÅLISE E LOGGING**

**1.1. Verifica√ß√£o do Template**
-   **A√ß√£o:** Verifique o arquivo `templates/obra_form.html`.
-   **Confirme:** Se o formul√°rio (`<form>`) cont√©m o token CSRF: `{{ form.hidden_tag() }}` ou `<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>`.
-   **Relate:** Se o token est√° presente ou ausente.

**1.2. Adicionar Logging Detalhado**
-   **A√ß√£o:** Modifique a fun√ß√£o `nova_obra()` em `views.py` para adicionar logs detalhados e rastrear o fluxo de execu√ß√£o e o estado da autentica√ß√£o.
-   **Implemente o seguinte c√≥digo:**

```python
# No in√≠cio do arquivo views.py, adicione:
import logging
logging.basicConfig(level=logging.INFO)

# Substitua a fun√ß√£o nova_obra() existente por esta vers√£o com logging:
@main_bp.route("/obras/nova", methods=["GET", "POST"])
@login_required
def nova_obra():
    """Criar nova obra"""
    logging.info(f"[NOVA OBRA] - Iniciando requisi√ß√£o. M√©todo: {request.method}")
    logging.info(f"[NOVA OBRA] - Usu√°rio autenticado? {current_user.is_authenticated}")

    if request.method == 'POST':
        logging.info("[NOVA OBRA] - Entrou no bloco POST.")
        try:
            logging.info(f"[NOVA OBRA] - Dados do formul√°rio recebidos: {request.form}")
            
            # Obter dados do formul√°rio
            nome = request.form.get('nome')
            cliente_id = request.form.get('cliente_id')
            data_inicio = request.form.get('data_inicio')
            data_fim = request.form.get('data_fim')
            endereco = request.form.get('endereco')
            cidade = request.form.get('cidade')
            estado = request.form.get('estado')
            cep = request.form.get('cep')
            status = request.form.get('status')
            valor_contrato = request.form.get('valor_contrato')
            responsavel_id = request.form.get('responsavel_id')
            
            admin_id = get_tenant_admin_id()
            if not admin_id:
                logging.error("[NOVA OBRA] - ERRO CR√çTICO: admin_id n√£o encontrado.")
                flash('Erro cr√≠tico: Administrador n√£o identificado.', 'danger')
                return redirect(url_for('main.obras'))

            logging.info(f"[NOVA OBRA] - admin_id: {admin_id}, nome: {nome}")

            # Valida√ß√µes (adicionar mais se necess√°rio)
            if not nome or not cliente_id:
                logging.warning("[NOVA OBRA] - Valida√ß√£o falhou: Nome ou Cliente n√£o preenchido.")
                flash('Nome da obra e cliente s√£o obrigat√≥rios.', 'warning')
                return redirect(url_for('main.nova_obra'))

            # Criar nova obra
            nova_obra_obj = Obra(
                nome=nome,
                cliente_id=int(cliente_id),
                data_inicio=datetime.strptime(data_inicio, '%Y-%m-%d') if data_inicio else None,
                data_fim=datetime.strptime(data_fim, '%Y-%m-%d') if data_fim else None,
                endereco=endereco,
                cidade=cidade,
                estado=estado,
                cep=cep,
                status=status,
                valor_contrato=float(valor_contrato) if valor_contrato else 0.0,
                responsavel_id=int(responsavel_id) if responsavel_id else None,
                admin_id=admin_id
            )
            
            logging.info("[NOVA OBRA] - Objeto Obra criado na mem√≥ria.")
            
            db.session.add(nova_obra_obj)
            db.session.commit()
            
            logging.info(f"[NOVA OBRA] - Obra ID {nova_obra_obj.id} salva no banco de dados.")
            
            flash('Obra cadastrada com sucesso!', 'success')
            logging.info("[NOVA OBRA] - Redirecionando para a lista de obras.")
            return redirect(url_for('main.obras'))

        except Exception as e:
            db.session.rollback()
            logging.error(f"[NOVA OBRA] - EXCE√á√ÉO OCORREU: {e}", exc_info=True)
            flash(f'Erro ao cadastrar obra: {e}', 'danger')
            return redirect(url_for('main.obras'))

    # L√≥gica para GET (carregar formul√°rio)
    try:
        admin_id = get_tenant_admin_id()
        clientes = Cliente.query.filter_by(admin_id=admin_id).order_by(Cliente.nome).all()
        funcionarios = Funcionario.query.filter_by(admin_id=admin_id, status='ativo').order_by(Funcionario.nome).all()
    except Exception as e:
        logging.error(f"[NOVA OBRA] - Erro ao carregar dados para o formul√°rio GET: {e}")
        clientes = []
        funcionarios = []

    return render_template('obra_form.html', 
                           clientes=clientes, 
                           funcionarios=funcionarios, 
                           title='Nova Obra', 
                           obra=None)
```

### **FASE 2: EXECU√á√ÉO E AN√ÅLISE DOS LOGS**

**2.1. Reproduza o Bug**
-   **A√ß√£o:** Ap√≥s aplicar o c√≥digo com logging, execute a aplica√ß√£o e tente cadastrar uma nova obra novamente.
-   **Observe:** O sistema deve te deslogar como antes.

**2.2. Analise os Logs**
-   **A√ß√£o:** Verifique o console do Replit ou o arquivo de log.
-   **Procure por:**
    -   A √∫ltima mensagem de `logging.info` que apareceu. Isso indicar√° onde o c√≥digo falhou.
    -   Qualquer mensagem de `logging.error` ou `logging.warning`.
    -   Se a mensagem `[NOVA OBRA] - EXCE√á√ÉO OCORREU:` apareceu, anote a exce√ß√£o completa.
    -   Verifique se o log `Usu√°rio autenticado? True` √© exibido no in√≠cio.

### **FASE 3: DIAGN√ìSTICO E CORRE√á√ÉO**

**3.1. Relate o Diagn√≥stico**
-   Com base na an√°lise dos logs e na verifica√ß√£o do template, descreva a causa raiz do problema.
    -   **Exemplo 1:** "Diagn√≥stico: O token CSRF estava ausente no template `obra_form.html`."
    -   **Exemplo 2:** "Diagn√≥stico: Ocorreu uma `ValueError` na linha `valor_contrato=float(valor_contrato)` porque o campo estava sendo enviado vazio. A exce√ß√£o n√£o foi tratada corretamente e invalidou a sess√£o."
    -   **Exemplo 3:** "Diagn√≥stico: O log `admin_id n√£o encontrado` foi exibido. A fun√ß√£o `get_tenant_admin_id()` est√° retornando `None` durante o POST."

**3.2. Proponha e Implemente a Corre√ß√£o**
-   Com base no diagn√≥stico, descreva a solu√ß√£o e aplique-a diretamente no c√≥digo.
    -   **Exemplo 1 (CSRF):** Adicionar o token CSRF ao formul√°rio.
    -   **Exemplo 2 (ValueError):** Melhorar o tratamento de erro para campos num√©ricos, permitindo valores vazios ou definindo um padr√£o.
    -   **Exemplo 3 (admin_id):** Depurar a fun√ß√£o `get_tenant_admin_id()` para entender por que ela falha no POST.

**3.3. Teste a Corre√ß√£o**
-   **A√ß√£o:** Ap√≥s aplicar a corre√ß√£o, tente cadastrar uma nova obra novamente.
-   **Confirme:** Se a obra √© criada com sucesso e voc√™ √© redirecionado para a lista de obras sem ser deslogado.

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1.  Inicie a **Fase 1** verificando o template e aplicando o c√≥digo de logging.
2.  Execute a **Fase 2** para reproduzir o bug e capturar os logs.
3.  Conclua com a **Fase 3**, relatando o diagn√≥stico, implementando a corre√ß√£o e validando o resultado.
4.  Ao final, remova os logs adicionados para limpar o c√≥digo.

**COMANDO INICIAL:** Inicie o diagn√≥stico do bug de logout agora.
```
```
```
```
