# PROMPT PARA REPLIT AGENT - Corrigir KPIs Financeiros do Dashboard

## ðŸŽ¯ OBJETIVO

Corrigir as queries dos KPIs financeiros que nÃ£o estÃ£o filtrando por `admin_id`, causando:
- Valores zerados ou incorretos
- ViolaÃ§Ã£o de multi-tenancy (mostrando dados de outras empresas)
- Problemas de seguranÃ§a

---

## ðŸ“ MODIFICAÃ‡Ã•ES NECESSÃRIAS

### MODIFICAÃ‡ÃƒO 1: Corrigir Query de Custos de VeÃ­culos

**Arquivo:** `views.py`

**LocalizaÃ§Ã£o:** FunÃ§Ã£o `calcular_custos_veiculo()` (aproximadamente linha 830-836)

**CÃ³digo Atual (PROBLEMÃTICO):**
```python
def calcular_custos_veiculo():
    from models import VehicleExpense
    custos_veiculo = VehicleExpense.query.filter(
        VehicleExpense.data_custo >= data_inicio,
        VehicleExpense.data_custo <= data_fim
    ).all()
    return sum(c.valor or 0 for c in custos_veiculo)
```

**CÃ³digo Corrigido:**
```python
def calcular_custos_veiculo():
    from models import VehicleExpense
    custos_veiculo = VehicleExpense.query.filter(
        VehicleExpense.admin_id == admin_id,  # âœ… ADICIONAR FILTRO
        VehicleExpense.data_custo >= data_inicio,
        VehicleExpense.data_custo <= data_fim
    ).all()
    return sum(c.valor or 0 for c in custos_veiculo)
```

---

### MODIFICAÃ‡ÃƒO 2: Corrigir Query de AlimentaÃ§Ã£o (RegistroAlimentacao)

**Arquivo:** `views.py`

**LocalizaÃ§Ã£o:** CÃ¡lculo de `custo_alimentacao_real` (aproximadamente linha 799-820)

**CÃ³digo Atual (PROBLEMÃTICO):**
```python
custo_alimentacao_real = 0
try:
    # Tabela registro_alimentacao
    alimentacao_registros = RegistroAlimentacao.query.filter(
        RegistroAlimentacao.data >= data_inicio,
        RegistroAlimentacao.data <= data_fim
    ).all()
    custo_alimentacao_real += sum(a.valor or 0 for a in alimentacao_registros)
    
    # TambÃ©m buscar em outro_custo
    from models import OutroCusto
    outros_alimentacao = OutroCusto.query.filter(
        OutroCusto.data >= data_inicio,
        OutroCusto.data <= data_fim,
        OutroCusto.kpi_associado == 'custo_alimentacao'
    ).all()
    custo_alimentacao_real += sum(o.valor or 0 for o in outros_alimentacao)
    
    print(f"DEBUG ALIMENTAÃ‡ÃƒO DASHBOARD: Registros={sum(a.valor or 0 for a in alimentacao_registros):.2f}, Outros={sum(o.valor or 0 for o in outros_alimentacao):.2f}, Total={custo_alimentacao_real:.2f}")
except Exception as e:
    print(f"Erro cÃ¡lculo alimentaÃ§Ã£o: {e}")
    custo_alimentacao_real = 0
```

**CÃ³digo Corrigido:**
```python
custo_alimentacao_real = 0
try:
    # Tabela registro_alimentacao - JOIN com funcionario para filtrar por admin_id
    alimentacao_registros = db.session.query(RegistroAlimentacao).join(
        Funcionario, RegistroAlimentacao.funcionario_id == Funcionario.id
    ).filter(
        Funcionario.admin_id == admin_id,  # âœ… FILTRAR POR ADMIN
        RegistroAlimentacao.data >= data_inicio,
        RegistroAlimentacao.data <= data_fim
    ).all()
    custo_alimentacao_real += sum(a.valor or 0 for a in alimentacao_registros)
    
    # TambÃ©m buscar em outro_custo
    from models import OutroCusto
    outros_alimentacao = OutroCusto.query.filter(
        OutroCusto.admin_id == admin_id,  # âœ… ADICIONAR FILTRO
        OutroCusto.data >= data_inicio,
        OutroCusto.data <= data_fim,
        OutroCusto.kpi_associado == 'custo_alimentacao'
    ).all()
    custo_alimentacao_real += sum(o.valor or 0 for o in outros_alimentacao)
    
    print(f"DEBUG ALIMENTAÃ‡ÃƒO DASHBOARD: Registros={sum(a.valor or 0 for a in alimentacao_registros):.2f}, Outros={sum(o.valor or 0 for o in outros_alimentacao):.2f}, Total={custo_alimentacao_real:.2f}")
except Exception as e:
    print(f"Erro cÃ¡lculo alimentaÃ§Ã£o: {e}")
    custo_alimentacao_real = 0
```

---

### MODIFICAÃ‡ÃƒO 3: Corrigir Query de Faltas Justificadas

**Arquivo:** `views.py`

**LocalizaÃ§Ã£o:** FunÃ§Ã£o `calcular_faltas_justificadas()` (aproximadamente linha 842-860)

**CÃ³digo Atual (PROBLEMÃTICO):**
```python
def calcular_faltas_justificadas():
    # Buscar todas as faltas justificadas no perÃ­odo
    faltas_justificadas = RegistroPonto.query.filter(
        RegistroPonto.data >= data_inicio,
        RegistroPonto.data <= data_fim,
        RegistroPonto.tipo_registro == 'falta_justificada'
    ).all()
    
    quantidade = len(faltas_justificadas)
    custo = 0
    
    for falta in faltas_justificadas:
        funcionario = Funcionario.query.get(falta.funcionario_id)
        if funcionario and funcionario.salario:
            # Valor por dia baseado em 22 dias Ãºteis
            valor_dia = (funcionario.salario / 22)
            custo += valor_dia
    
    return quantidade, custo
```

**CÃ³digo Corrigido:**
```python
def calcular_faltas_justificadas():
    # Buscar faltas justificadas com JOIN em funcionario para filtrar por admin_id
    faltas_justificadas = db.session.query(RegistroPonto).join(
        Funcionario, RegistroPonto.funcionario_id == Funcionario.id
    ).filter(
        Funcionario.admin_id == admin_id,  # âœ… FILTRAR POR ADMIN
        RegistroPonto.data >= data_inicio,
        RegistroPonto.data <= data_fim,
        RegistroPonto.tipo_registro == 'falta_justificada'
    ).all()
    
    quantidade = len(faltas_justificadas)
    custo = 0
    
    for falta in faltas_justificadas:
        funcionario = Funcionario.query.get(falta.funcionario_id)
        if funcionario and funcionario.salario:
            # Valor por dia baseado em 22 dias Ãºteis
            valor_dia = (funcionario.salario / 22)
            custo += valor_dia
    
    return quantidade, custo
```

---

### MODIFICAÃ‡ÃƒO 4: Corrigir Query de Outros Custos

**Arquivo:** `views.py`

**LocalizaÃ§Ã£o:** FunÃ§Ã£o `calcular_outros_custos()` (aproximadamente linha 867-874)

**CÃ³digo Atual (PROBLEMÃTICO):**
```python
def calcular_outros_custos():
    from models import OutroCusto
    outros_custos = OutroCusto.query.filter(
        OutroCusto.data >= data_inicio,
        OutroCusto.data <= data_fim,
        ~OutroCusto.tipo.in_(['transporte', 'alimentacao'])
    ).all()
    return sum(o.valor or 0 for o in outros_custos)
```

**CÃ³digo Corrigido:**
```python
def calcular_outros_custos():
    from models import OutroCusto
    outros_custos = OutroCusto.query.filter(
        OutroCusto.admin_id == admin_id,  # âœ… ADICIONAR FILTRO
        OutroCusto.data >= data_inicio,
        OutroCusto.data <= data_fim,
        ~OutroCusto.tipo.in_(['transporte', 'alimentacao'])
    ).all()
    return sum(o.valor or 0 for o in outros_custos)
```

---

## ðŸ” VALIDAÃ‡ÃƒO

ApÃ³s implementar as modificaÃ§Ãµes:

### âœ… Teste 1: Verificar Logs

No console do Replit, procure por:

```
DEBUG ALIMENTAÃ‡ÃƒO DASHBOARD: Registros=150.00, Outros=0.00, Total=150.00
DEBUG Custos veÃ­culo: R$ 200.00
DEBUG DASHBOARD: Custo total calculado: R$ 500.00
```

Se os valores ainda estiverem zerados, verifique:
1. Se hÃ¡ dados no perÃ­odo selecionado
2. Se `admin_id` estÃ¡ correto
3. Se as tabelas tÃªm registros

---

### âœ… Teste 2: Verificar Dashboard

Acesse `/dashboard` e verifique se os cards mostram valores:

```
AlimentaÃ§Ã£o: R$ 150.00  (nÃ£o zero)
Transporte: R$ 200.00   (nÃ£o zero)
MÃ£o de Obra: R$ 500.00  (nÃ£o zero)
Outros: R$ 50.00        (nÃ£o zero)
Faltas: 3 dias          (nÃ£o zero)
Total: R$ 900.00        (soma correta)
```

---

### âœ… Teste 3: Verificar Filtro de Data

1. Clique em "Aplicar Filtro" com datas diferentes
2. Verifique se os valores mudam
3. Verifique se nÃ£o hÃ¡ erro no console

---

### âœ… Teste 4: Verificar Multi-tenancy

Se vocÃª tiver mÃºltiplos admins:

1. FaÃ§a login com Admin A
2. Anote os valores do dashboard
3. FaÃ§a login com Admin B
4. Verifique se os valores sÃ£o diferentes

**Valores devem ser isolados por empresa!**

---

## ðŸ› TROUBLESHOOTING

### Problema: "Ainda mostra R$ 0.00"

**Causa 1:** NÃ£o hÃ¡ dados no perÃ­odo

**Verificar:**
```sql
-- Conectar ao banco e executar
SELECT COUNT(*), SUM(valor) 
FROM frota_despesa 
WHERE admin_id = <seu_admin_id> 
AND data_custo >= '2025-10-01' 
AND data_custo <= '2025-10-16';
```

Se retornar 0, nÃ£o hÃ¡ dados. Cadastre custos de teste.

---

**Causa 2:** admin_id incorreto

**Verificar logs:**
```
âœ… DEBUG DASHBOARD KPIs: Usando admin_id=10 para cÃ¡lculos
```

Confirme se esse admin_id tem dados:
```sql
SELECT admin_id, COUNT(*) 
FROM funcionario 
WHERE ativo = true 
GROUP BY admin_id;
```

---

**Causa 3:** PerÃ­odo de data muito restrito

**SoluÃ§Ã£o:** Ampliar o perÃ­odo ou usar "Ãšltimo MÃªs" / "3 Meses"

---

### Problema: "Erro ao executar query"

**Erro tÃ­pico:**
```
AttributeError: 'NoneType' object has no attribute 'admin_id'
```

**Causa:** VariÃ¡vel `admin_id` nÃ£o estÃ¡ definida no escopo da funÃ§Ã£o

**SoluÃ§Ã£o:** As funÃ§Ãµes `calcular_custos_veiculo()`, `calcular_faltas_justificadas()`, etc. estÃ£o dentro da funÃ§Ã£o `dashboard()`, entÃ£o `admin_id` deve estar acessÃ­vel. Verificar se nÃ£o hÃ¡ problema de indentaÃ§Ã£o.

---

### Problema: "Query muito lenta"

**Causa:** JOINs sem Ã­ndices

**SoluÃ§Ã£o (futura):** Adicionar Ã­ndices:
```sql
CREATE INDEX idx_registro_alimentacao_funcionario_data 
ON registro_alimentacao(funcionario_id, data);

CREATE INDEX idx_registro_ponto_funcionario_data 
ON registro_ponto(funcionario_id, data);
```

---

## ðŸ“Š RESUMO DAS ALTERAÃ‡Ã•ES

| Query | Linha Aprox. | AlteraÃ§Ã£o | Impacto |
|-------|--------------|-----------|---------|
| calcular_custos_veiculo | 830-836 | + admin_id filter | Custos de transporte corretos |
| RegistroAlimentacao | 802-806 | + JOIN Funcionario | Custos de alimentaÃ§Ã£o corretos |
| OutroCusto (alimentaÃ§Ã£o) | 810-815 | + admin_id filter | Custos de alimentaÃ§Ã£o completos |
| calcular_faltas_justificadas | 842-860 | + JOIN Funcionario | Faltas corretas |
| calcular_outros_custos | 867-874 | + admin_id filter | Outros custos corretos |

**Total de linhas modificadas:** ~30 linhas

**Arquivos afetados:** 1 (`views.py`)

**Risco:** Baixo (apenas adiciona filtros de seguranÃ§a)

---

## âš¡ CHECKLIST DE IMPLEMENTAÃ‡ÃƒO

- [ ] Modificar `calcular_custos_veiculo()` - adicionar admin_id
- [ ] Modificar query de `RegistroAlimentacao` - adicionar JOIN
- [ ] Modificar query de `OutroCusto` (alimentaÃ§Ã£o) - adicionar admin_id
- [ ] Modificar `calcular_faltas_justificadas()` - adicionar JOIN
- [ ] Modificar `calcular_outros_custos()` - adicionar admin_id
- [ ] Salvar arquivo
- [ ] Reiniciar servidor Replit
- [ ] Acessar `/dashboard`
- [ ] Verificar se KPIs mostram valores
- [ ] Testar filtro de data
- [ ] Verificar logs no console
- [ ] Commit das alteraÃ§Ãµes

---

## ðŸŽ¯ RESULTADO ESPERADO

**Antes:**
```
ðŸ’° Financeiro e Custos
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlimentaÃ§Ã£o: R$ 0.00                         â”‚ âŒ
â”‚ Transporte: R$ 0.00                          â”‚ âŒ
â”‚ MÃ£o de Obra: R$ 500.00                       â”‚ âœ…
â”‚ Outros: R$ 0.00                              â”‚ âŒ
â”‚ Faltas: 0 dias                               â”‚ âŒ
â”‚ Total: R$ 500.00                             â”‚ âš ï¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Depois:**
```
ðŸ’° Financeiro e Custos
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlimentaÃ§Ã£o: R$ 150.00                       â”‚ âœ…
â”‚ Transporte: R$ 200.00                        â”‚ âœ…
â”‚ MÃ£o de Obra: R$ 500.00                       â”‚ âœ…
â”‚ Outros: R$ 50.00                             â”‚ âœ…
â”‚ Faltas: 3 dias (R$ 45.00)                   â”‚ âœ…
â”‚ Total: R$ 945.00                             â”‚ âœ…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸš¨ IMPORTANTE - SEGURANÃ‡A

Essas correÃ§Ãµes nÃ£o sÃ£o apenas para "fazer funcionar", mas tambÃ©m para **seguranÃ§a**:

- **Antes:** Queries buscavam dados de TODAS as empresas
- **Depois:** Queries filtram apenas dados da empresa do usuÃ¡rio logado

**Isso Ã© crÃ­tico para multi-tenancy e LGPD!**

---

## ðŸ“ COMMIT MESSAGE SUGERIDA

```
fix: Adicionar filtros de admin_id nas queries de KPIs financeiros

- Adiciona filtro admin_id em calcular_custos_veiculo()
- Adiciona JOIN com Funcionario em RegistroAlimentacao
- Adiciona filtro admin_id em OutroCusto (alimentaÃ§Ã£o e outros)
- Adiciona JOIN com Funcionario em calcular_faltas_justificadas()
- Corrige violaÃ§Ã£o de multi-tenancy nas queries
- Resolve problema de KPIs financeiros mostrando R$ 0.00

Impacto: KPIs agora mostram valores corretos e isolados por empresa
```

