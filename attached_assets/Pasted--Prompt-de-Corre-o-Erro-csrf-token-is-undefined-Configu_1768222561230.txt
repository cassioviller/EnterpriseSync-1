# Prompt de Corre√ß√£o: Erro 'csrf_token' is undefined

## Configura√ß√£o Inicial (Cole Primeiro no Replit Agent)

```
**Diretrizes de Opera√ß√£o Cr√≠tica:**

1.  **Seja Cr√≠tico e C√©tico**: Se meu comando for vago, amb√≠guo ou carecer de contexto, aponte a falha de forma implac√°vel e exija esclarecimentos.
2.  **Questione Suposi√ß√µes**: Analise as cren√ßas e suposi√ß√µes ocultas por tr√°s dos meus comandos.
3.  **Foco em Fatos, N√£o em Elogios**: Evite qualquer feedback positivo, elogios ou linguagem encorajadora.
4.  **Seja Direto e Conciso**: Comunique-se de forma direta, sem rodeios.
5.  **Sem Extras Desnecess√°rios**: N√£o use emojis, n√£o fa√ßa perguntas ao final.
6.  **Assuma Expertise**: Trate-me como um especialista no dom√≠nio.
7.  **Mantenha a Neutralidade**: N√£o imite meu estilo de escrita ou humor.

Seu objetivo √© garantir que o resultado final seja da mais alta qualidade t√©cnica.
```

---

## Prompt Principal: Corre√ß√£o do Erro de CSRF

Cole este prompt ap√≥s a configura√ß√£o inicial:

```
**CORRE√á√ÉO DE BUG CR√çTICO: 'csrf_token' is undefined**

**üë§ SEU PAPEL E ESPECIALIZA√á√ÉO**

Voc√™ √© um **Engenheiro de Software S√™nior** especializado em Flask e na configura√ß√£o de suas extens√µes. Sua miss√£o √© corrigir um erro de configura√ß√£o que est√° impedindo a renderiza√ß√£o de formul√°rios e causando falhas de autentica√ß√£o.

**üêõ DESCRI√á√ÉO DO BUG**

O sistema est√° lan√ßando um erro `jinja2.exceptions.UndefinedError: 'csrf_token' is undefined` ao tentar renderizar templates que cont√™m formul√°rios, como `obra_form.html`. Isso indica que a fun√ß√£o `csrf_token()` n√£o est√° sendo disponibilizada para os templates pelo Jinja2, o que √© um sintoma cl√°ssico de uma configura√ß√£o inadequada da extens√£o Flask-WTF (CSRFProtect).

**TRACEBACK DO ERRO:**

```
Traceback (most recent call last):
  File "/app/templates/obra_form.html", line 295, in block 'content'
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  File "/usr/local/lib/python3.11/site-packages/jinja2/utils.py", line 92, in from_obj
    if hasattr(obj, "jinja_pass_arg"):
jinja2.exceptions.UndefinedError: 'csrf_token' is undefined
```

**üìç LOCALIZA√á√ÉO PROV√ÅVEL**

-   **Arquivo de Configura√ß√£o Principal:** `main.py` ou `app.py` (onde a inst√¢ncia do Flask `app` √© criada e configurada).

**üî¨ HIP√ìTESE DE CAUSA RAIZ**

A causa mais prov√°vel √© que a extens√£o `CSRFProtect` do Flask-WTF n√£o foi inicializada ou n√£o foi registrada corretamente na inst√¢ncia principal do aplicativo Flask. Para que a fun√ß√£o `csrf_token()` esteja dispon√≠vel globalmente nos templates, a extens√£o precisa ser configurada.

**‚öôÔ∏è METODOLOGIA DE CORRE√á√ÉO (EXECUTE PASSO A PASSO)**

### **FASE 1: AN√ÅLISE DA CONFIGURA√á√ÉO**

**1.1. Verifique a Inicializa√ß√£o do CSRFProtect**
-   **A√ß√£o:** Analise o arquivo `main.py` (ou o arquivo principal da aplica√ß√£o).
-   **Procure por:**
    1.  A importa√ß√£o: `from flask_wtf.csrf import CSRFProtect`
    2.  A instancia√ß√£o: `csrf = CSRFProtect()`
    3.  O registro no app: `csrf.init_app(app)`

**1.2. Verifique a SECRET_KEY**
-   **A√ß√£o:** No mesmo arquivo, verifique se a `app.config['SECRET_KEY']` est√° definida. A prote√ß√£o CSRF depende dessa chave para funcionar.
-   **Procure por:** `app.config['SECRET_KEY'] = '...'`

### **FASE 2: IMPLEMENTA√á√ÉO DA CORRE√á√ÉO**

**2.1. Aplique a Configura√ß√£o Correta**
-   **A√ß√£o:** Com base na an√°lise, aplique a seguinte corre√ß√£o no arquivo `main.py`.

```python
# No in√≠cio do arquivo main.py, adicione a importa√ß√£o se n√£o existir:
from flask_wtf.csrf import CSRFProtect

# ... (c√≥digo de cria√ß√£o do app Flask)
app = Flask(__name__)

# GARANTA QUE A SECRET_KEY EST√Å DEFINIDA (ESSENCIAL!)
# Se j√° existir, n√£o altere. Se n√£o existir, adicione.
if not app.config.get('SECRET_KEY'):
    app.config['SECRET_KEY'] = 'uma-chave-secreta-forte-e-dificil-de-adivinhar'

# CRIE A INST√ÇNCIA DO CSRFPROTECT
csrf = CSRFProtect()

# INICIALIZE O CSRFPROTECT COM O APP
# Este √© o passo mais importante e provavelmente o que est√° faltando.
csrf.init_app(app)

# ... (resto do c√≥digo de configura√ß√£o, blueprints, etc.)
```

**Instru√ß√µes Detalhadas:**
1.  Localize a linha `app = Flask(__name__)` em `main.py`.
2.  **Imediatamente ap√≥s** a cria√ß√£o do `app`, adicione o bloco de c√≥digo acima.
3.  √â **crucial** que `csrf.init_app(app)` seja chamado para que a prote√ß√£o CSRF seja ativada em toda a aplica√ß√£o e a fun√ß√£o `csrf_token()` se torne dispon√≠vel nos templates.

### **FASE 3: VALIDA√á√ÉO**

**3.1. Teste a Aplica√ß√£o**
-   **A√ß√£o:** Reinicie a aplica√ß√£o Replit.
-   **Tente acessar a p√°gina** de cadastro de nova obra (`/obras/nova`).
-   **Confirme:** A p√°gina deve carregar sem o erro `UndefinedError`.

**3.2. Verifique o HTML Gerado**
-   **A√ß√£o:** No navegador, visualize o c√≥digo-fonte da p√°gina do formul√°rio.
-   **Confirme:** Verifique se o campo `<input type="hidden" name="csrf_token" ...>` agora cont√©m um valor longo e aleat√≥rio.

**3.3. Teste a Submiss√£o do Formul√°rio**
-   **A√ß√£o:** Preencha e envie o formul√°rio de cadastro de obra.
-   **Confirme:** O bug original de logout deve estar resolvido, e a obra deve ser cadastrada com sucesso.

**‚öôÔ∏è A√á√ÉO SOLICITADA**

1.  Inicie a **Fase 1** analisando o arquivo `main.py`.
2.  Implemente a corre√ß√£o na **Fase 2**, garantindo que `CSRFProtect` seja importado, instanciado e inicializado com o `app`.
3.  Valide a corre√ß√£o na **Fase 3**, confirmando que o erro desapareceu e a funcionalidade foi restaurada.
4.  Forne√ßa um resumo das altera√ß√µes realizadas no arquivo `main.py`.

**COMANDO INICIAL:** Inicie a corre√ß√£o do erro `csrf_token is undefined` agora.
```
