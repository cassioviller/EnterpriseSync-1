# Prompt de Otimiza√ß√£o: Acelerar Identifica√ß√£o Facial com Cache de Embeddings

## üéØ Objetivo

Acelerar drasticamente a identifica√ß√£o facial, reduzindo o tempo de resposta de 10-15 segundos para menos de 1 segundo.

## üîç O Problema

O `DeepFace.find()` processa todas as fotos dos funcion√°rios a cada requisi√ß√£o. Isso √© lento e ineficiente.

## üîß A Solu√ß√£o: Cache de Embeddings

Vamos pr√©-calcular os "embeddings" (a representa√ß√£o matem√°tica de cada rosto) e salv√°-los em um arquivo. Assim, a cada requisi√ß√£o, s√≥ precisamos calcular o embedding da foto capturada e comparar com os que j√° est√£o em cache.

## üìã Instru√ß√µes para o Replit Agent

### Fase 1: Gerar Cache de Embeddings

1.  **Crie um novo script:** `gerar_cache_facial.py`
2.  **L√≥gica do script:**
    -   Busca todos os funcion√°rios com foto.
    -   Para cada foto, calcula o embedding usando `DeepFace.represent()`.
    -   Salva os embeddings em um arquivo `pickle` (ex: `cache_facial.pkl`).

**Exemplo de C√≥digo:**
```python
import pickle
from deepface import DeepFace
from models import Funcionario

def gerar_cache():
    funcionarios = Funcionario.query.filter(Funcionario.foto_base64.isnot(None)).all()
    cache = {}

    for func in funcionarios:
        embedding = DeepFace.represent(img_path=func.foto_base64, model_name=\'VGG-Face\', enforce_detection=False)
        cache[func.id] = embedding

    with open(\'cache_facial.pkl\', \'wb\') as f:
        pickle.dump(cache, f)

if __name__ == \'__main__\':
    gerar_cache()
```

### Fase 2: Modificar a API de Identifica√ß√£o

1.  **Carregue o cache** no in√≠cio da aplica√ß√£o.
2.  **Modifique a API** `/ponto/api/identificar-e-registrar`:
    -   Calcule o embedding da foto capturada.
    -   Compare com os embeddings em cache para encontrar o funcion√°rio.

**Exemplo de C√≥digo:**
```python
import pickle
from deepface import DeepFace
import numpy as np

# Carregar cache na inicializa√ß√£o
with open(\'cache_facial.pkl\', \'rb\') as f:
    cache_facial = pickle.load(f)

@ponto_bp.route(\'/api/identificar-e-registrar\', methods=[\'POST
```
