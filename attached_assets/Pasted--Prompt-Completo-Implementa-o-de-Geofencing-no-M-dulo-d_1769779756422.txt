# Prompt Completo: Implementa칞칚o de Geofencing no M칩dulo de Ponto

## 游꿢 Objetivo

Implementar um sistema completo de Cerca Virtual (Geofencing) para garantir que os funcion치rios estejam fisicamente na obra ao registrar o ponto.

---

## 游늶 Fase 1: Modificar o Modelo `Obra`

**Tarefa:** Adicione os campos de geolocaliza칞칚o no modelo `Obra` em `models.py`.

**Campos a adicionar:**
```python
latitude = db.Column(db.Float, nullable=True)
longitude = db.Column(db.Float, nullable=True)
raio_geofence_metros = db.Column(db.Integer, default=100)
```

**Migra칞칚o do banco de dados:**
- Execute a migra칞칚o para adicionar os novos campos na tabela `obra`.

---

## 游늶 Fase 2: Criar Fun칞칚o de C치lculo de Dist칙ncia

**Tarefa:** Crie uma fun칞칚o utilit치ria para calcular a dist칙ncia entre duas coordenadas GPS usando a f칩rmula de Haversine.

**Arquivo:** `utils_geofencing.py` (novo arquivo)

**C칩digo:**
```python
from math import radians, sin, cos, sqrt, atan2

def calcular_distancia_metros(lat1, lon1, lat2, lon2):
    """
    Calcula a dist칙ncia em metros entre duas coordenadas GPS.
    Usa a f칩rmula de Haversine.
    """
    R = 6371000  # Raio da Terra em metros
    
    lat1_rad = radians(lat1)
    lon1_rad = radians(lon1)
    lat2_rad = radians(lat2)
    lon2_rad = radians(lon2)
    
    dlon = lon2_rad - lon1_rad
    dlat = lat2_rad - lat1_rad
    
    a = sin(dlat / 2)**2 + cos(lat1_rad) * cos(lat2_rad) * sin(dlon / 2)**2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))
    
    distancia = R * c
    return distancia

def validar_localizacao_na_obra(lat_funcionario, lon_funcionario, obra):
    """
    Valida se o funcion치rio est치 dentro do raio da obra.
    Retorna (bool, distancia_metros, mensagem).
    """
    if not obra.latitude or not obra.longitude:
        return (True, None, "Obra sem geofencing configurado")
    
    distancia = calcular_distancia_metros(
        lat_funcionario, lon_funcionario,
        obra.latitude, obra.longitude
    )
    
    if distancia <= obra.raio_geofence_metros:
        return (True, distancia, f"Dentro do raio ({distancia:.0f}m)")
    else:
        return (False, distancia, f"Fora do raio ({distancia:.0f}m de {obra.raio_geofence_metros}m)")
```

---

## 游늶 Fase 3: Modificar a API de Registro de Ponto

**Tarefa:** Modifique a rota `/ponto/api/identificar-e-registrar` para validar a localiza칞칚o.

**Modifica칞칫es:**

1. **Receber latitude e longitude** no JSON da requisi칞칚o:
```python
data = request.get_json()
foto_capturada = data['foto_base64']
latitude = data.get('latitude')
longitude = data.get('longitude')
```

2. **Validar a localiza칞칚o** antes de registrar o ponto:
```python
from utils_geofencing import validar_localizacao_na_obra

# Buscar a obra do funcion치rio (se houver)
obra = Obra.query.filter_by(id=funcionario.obra_id_atual).first()

if obra:
    valido, distancia, mensagem = validar_localizacao_na_obra(latitude, longitude, obra)
    
    if not valido:
        return jsonify({
            'success': False,
            'message': f'Voc칡 est치 fora da 치rea da obra. {mensagem}'
        }), 403

# Continuar com o registro do ponto...
```

3. **Salvar a localiza칞칚o** no registro de ponto:
```python
novo_registro = RegistroPonto(
    funcionario_id=funcionario.id,
    # ... outros campos ...
    latitude=latitude,
    longitude=longitude,
    distancia_obra_metros=distancia
)
```

---

## 游늶 Fase 4: Modificar o Frontend - Captura de GPS

**Tarefa:** Modifique o JavaScript da tela de ponto para capturar a localiza칞칚o do usu치rio.

**Arquivo:** `ponto_facial_automatico.html` (ou similar)

**C칩digo JavaScript:**
```javascript
function registrarPontoComGPS() {
    // Verificar se o navegador suporta geolocaliza칞칚o
    if (!navigator.geolocation) {
        alert('Seu navegador n칚o suporta geolocaliza칞칚o');
        return;
    }

    // Capturar localiza칞칚o
    navigator.geolocation.getCurrentPosition(
        position => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Capturar foto e enviar para a API
            capturarFotoEEnviar(latitude, longitude);
        },
        error => {
            let mensagem = 'Erro ao obter localiza칞칚o';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    mensagem = 'Voc칡 precisa permitir o acesso  localiza칞칚o para registrar o ponto';
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensagem = 'Localiza칞칚o indispon칤vel';
                    break;
                case error.TIMEOUT:
                    mensagem = 'Tempo esgotado ao obter localiza칞칚o';
                    break;
            }
            
            alert(mensagem);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function capturarFotoEEnviar(latitude, longitude) {
    // Capturar foto da c칙mera
    const canvas = document.getElementById('canvas');
    const fotoBase64 = canvas.toDataURL('image/jpeg');

    // Enviar para a API
    fetch('/ponto/api/identificar-e-registrar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            foto_base64: fotoBase64,
            latitude: latitude,
            longitude: longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ponto registrado com sucesso!');
        } else {
            alert('Erro: ' + data.message);
        }
    });
}
```

---

## 游늶 Fase 5: Modificar o Formul치rio de Cadastro de Obra

**Tarefa:** Adicione os campos de geolocaliza칞칚o no formul치rio de cadastro/edi칞칚o de obra.

**Template:** `obra_form.html`

**Campos a adicionar:**
```html
<div class="form-group">
    <label for="latitude">Latitude</label>
    <input type="number" step="0.000001" class="form-control" id="latitude" name="latitude" value="{{ obra.latitude or '' }}">
    <small class="form-text text-muted">Ex: -23.550520</small>
</div>

<div class="form-group">
    <label for="longitude">Longitude</label>
    <input type="number" step="0.000001" class="form-control" id="longitude" name="longitude" value="{{ obra.longitude or '' }}">
    <small class="form-text text-muted">Ex: -46.633308</small>
</div>

<div class="form-group">
    <label for="raio_geofence_metros">Raio de Geofencing (metros)</label>
    <input type="number" class="form-control" id="raio_geofence_metros" name="raio_geofence_metros" value="{{ obra.raio_geofence_metros or 100 }}">
    <small class="form-text text-muted">Dist칙ncia m치xima permitida para registrar ponto (padr칚o: 100m)</small>
</div>
```

**Opcional:** Adicione um bot칚o "Obter Localiza칞칚o Atual" para facilitar o cadastro:
```html
<button type="button" class="btn btn-secondary" onclick="obterLocalizacaoAtual()">
    <i class="fas fa-map-marker-alt"></i> Obter Localiza칞칚o Atual
</button>

<script>
function obterLocalizacaoAtual() {
    navigator.geolocation.getCurrentPosition(position => {
        document.getElementById('latitude').value = position.coords.latitude;
        document.getElementById('longitude').value = position.coords.longitude;
    });
}
</script>
```

---

## 游늶 Fase 6: Adicionar Campos no Modelo `RegistroPonto`

**Tarefa:** Adicione os campos de localiza칞칚o no modelo `RegistroPonto` para salvar onde o ponto foi registrado.

**Campos a adicionar:**
```python
latitude = db.Column(db.Float, nullable=True)
longitude = db.Column(db.Float, nullable=True)
distancia_obra_metros = db.Column(db.Float, nullable=True)
```

---

## 游 Pr칩ximos Passos para o Usu치rio

1. **Execute as migra칞칫es** do banco de dados.
2. **Cadastre as coordenadas** das obras existentes.
3. **Teste** o registro de ponto:
   - Dentro do raio da obra (deve funcionar)
   - Fora do raio da obra (deve bloquear)
4. **Ajuste o raio** conforme necess치rio para cada obra.

## 游눠 Dicas

- Use o Google Maps para obter as coordenadas das obras (clique com bot칚o direito no mapa).
- Raio recomendado: 50-200 metros (dependendo do tamanho da obra).
- Em obras muito grandes, aumente o raio para 300-500 metros.

O sistema estar치 pronto para controle de localiza칞칚o! 游꿢
