# üö® PROMPT: Corrigir Faltas Justificadas no Dashboard

## CONTEXTO DO PROBLEMA

**AMBIENTE:** Produ√ß√£o (Docker/Easypanel + PostgreSQL)  
**STATUS:** üî¥ CR√çTICO - Faltas justificadas n√£o aparecem no dashboard  

**COMPORTAMENTO ATUAL:**
- ‚úÖ P√°gina `/funcionarios`: Mostra **27 dias** de faltas justificadas (R$ 2.576,51)
- ‚ùå Dashboard `/`: Mostra **0 dias** de faltas justificadas (R$ 0.00)

**ERRO NOS LOGS:**
```
‚ùå ERRO:views:Erro em opera√ß√£o de banco de dados: cannot access free variable 'calendar' where it is not associated with a value in enclosing scope
DEBUG Faltas Justificadas: 0 faltas, R$ 0.00
```

---

## CAUSA RAIZ IDENTIFICADA

O erro ocorre porque `calendar` √© importado **DENTRO** da fun√ß√£o `dashboard()` na linha 520:

```python
# Linha 520 - REIMPORTA√á√ÉO LOCAL (CAUSA DO PROBLEMA)
import calendar
ultimo_dia = calendar.monthrange(data_inicio.year, data_inicio.month)[1]
```

Mas na linha 972, **DENTRO de uma fun√ß√£o aninhada**, `calendar` √© usado:

```python
# Linha 972 - DENTRO de calcular_faltas_justificadas()
dias_uteis = sum(1 for dia in range(1, calendar.monthrange(ano, mes)[1] + 1) 
                if date(ano, mes, dia).weekday() < 5)
```

**Problema:** Python n√£o permite acessar vari√°veis do escopo externo quando h√° reimporta√ß√£o local!

---

## POR QUE FUNCIONA EM DEV E N√ÉO EM PRODU√á√ÉO?

| Ambiente | Comportamento |
|----------|---------------|
| **DEV (Replit/SQLite)** | Escopo mais permissivo, ignora o problema |
| **PROD (Easypanel/PostgreSQL)** | **Escopo rigoroso**, detecta o erro |

---

## SOLU√á√ÉO COMPLETA

### MODIFICA√á√ÉO 1: Remover Reimporta√ß√£o de `calendar`

**Arquivo:** `views.py`  
**Localiza√ß√£o:** Linha 520

**DELETAR:**

```python
# Linha 520 - DELETAR ESTA LINHA
import calendar  # ‚ùå REMOVER
```

**JUSTIFICATIVA:**  
`calendar` j√° est√° importado no topo do arquivo (linha 11), n√£o precisa reimportar.

---

### MODIFICA√á√ÉO 2: Usar Import Global

**Arquivo:** `views.py`  
**Localiza√ß√£o:** Linha 11 (topo do arquivo)

**VERIFICAR SE EXISTE:**

```python
# Linha 11 - DEVE EXISTIR
import calendar  # ‚úÖ Import global
```

**Se N√ÉO existir, adicionar:**

```python
from datetime import datetime, date, timedelta
import calendar  # ‚úÖ ADICIONAR
from sqlalchemy import func, desc, or_, and_, text
```

---

### MODIFICA√á√ÉO 3: Remover Outras Reimporta√ß√µes (Opcional)

**Arquivo:** `views.py`  
**Localiza√ß√µes:** Linhas 5267

**DELETAR:**

```python
# Linha 5267 - DELETAR
import calendar  # ‚ùå REMOVER
```

**JUSTIFICATIVA:**  
Mesma raz√£o - evitar conflitos de escopo.

---

## VALIDA√á√ÉO

### Teste 1: Verificar Imports

```bash
# No Replit, executar:
grep -n "^import calendar" views.py
```

**Resultado Esperado:**
```
11:import calendar
```

**N√£o deve aparecer:**
- Linha 520
- Linha 5267

### Teste 2: Testar Dashboard em DEV

```bash
# No Replit, acessar:
http://localhost:5000/
```

**Resultado Esperado:**
- ‚úÖ Faltas Justificadas: 27 dias (R$ 2.576,51)
- ‚úÖ Sem erros no console

### Teste 3: Verificar Logs em Produ√ß√£o

Ap√≥s deploy, verificar logs:

```bash
docker logs <container_name> --tail 50 | grep "Faltas"
```

**Resultado Esperado:**
```
DEBUG Faltas Justificadas: 27 faltas, R$ 2576.51
```

---

## DEPLOY EM PRODU√á√ÉO

### Passo 1: Commit e Push

```bash
git add views.py
git commit -m "fix: Remove calendar reimport causing scope error in dashboard

- Remove calendar reimport on line 520
- Use global calendar import from line 11
- Fixes 'cannot access free variable calendar' error in production
- Fixes Faltas Justificadas showing 0 instead of 27 days"

git push origin main
```

### Passo 2: Deploy no Easypanel

O Easypanel vai:
1. ‚úÖ Build da imagem Docker
2. ‚úÖ Deploy autom√°tico
3. ‚úÖ Reiniciar container

### Passo 3: Verificar Dashboard

Acessar: `https://seu-dominio.com/`

**Verificar:**
- ‚úÖ Faltas Justificadas: 27 dias (R$ 2.576,51)
- ‚úÖ Sem erros nos logs
- ‚úÖ Todos os outros KPIs funcionando

---

## TROUBLESHOOTING

### Problema 1: Ainda mostra 0 dias

**Causa:** Cache do navegador  
**Solu√ß√£o:**
1. Fazer logout
2. Limpar cache (Ctrl+Shift+Del)
3. Fazer login novamente

### Problema 2: Erro persiste

**Causa:** Outras reimporta√ß√µes de `calendar`  
**Solu√ß√£o:**

```bash
# Buscar TODAS as reimporta√ß√µes
grep -n "import calendar" views.py
```

Remover todas exceto a linha 11.

### Problema 3: Per√≠odo diferente

**Causa:** Dashboard usa per√≠odo diferente de /funcionarios  
**Solu√ß√£o:** Ajustar filtro de data no dashboard para mesmo per√≠odo

---

## CHECKLIST DE IMPLEMENTA√á√ÉO

- [ ] Remover `import calendar` da linha 520
- [ ] Verificar que linha 11 tem `import calendar`
- [ ] Remover outras reimporta√ß√µes (linha 5267 se existir)
- [ ] Testar em desenvolvimento
- [ ] Verificar logs n√£o mostram erro de 'calendar'
- [ ] Commit e push
- [ ] Deploy em produ√ß√£o
- [ ] Verificar dashboard mostra 27 dias
- [ ] Confirmar valor R$ 2.576,51

---

## IMPACTO ESPERADO

### ANTES:
```
Dashboard:
  Faltas Justificadas: 0 dias ‚ùå
  Valor: R$ 0.00 ‚ùå
  
Logs:
  ‚ùå cannot access free variable 'calendar'
  DEBUG Faltas Justificadas: 0 faltas
```

### DEPOIS:
```
Dashboard:
  Faltas Justificadas: 27 dias ‚úÖ
  Valor: R$ 2.576,51 ‚úÖ
  
Logs:
  ‚úÖ Sem erros
  DEBUG Faltas Justificadas: 27 faltas, R$ 2576.51
```

---

## PRIORIDADE

üî¥ **ALTA** - KPI importante n√£o funciona em produ√ß√£o

**Tempo Estimado:** 15 minutos (implementa√ß√£o + deploy + valida√ß√£o)

---

## OBSERVA√á√ÉO IMPORTANTE

Este √© o **mesmo tipo de problema** que j√° corrigimos com `datetime` (linha 939). O Python em produ√ß√£o (Gunicorn) faz an√°lise de escopo mais rigorosa e detecta esses conflitos de reimporta√ß√£o.

**Regra Geral:** NUNCA reimportar m√≥dulos dentro de fun√ß√µes. Sempre usar imports globais no topo do arquivo.

Ap√≥s esta corre√ß√£o, as faltas justificadas devem aparecer corretamente no dashboard! üéØ

