# üéØ PROMPT: Diagnosticar e Resolver Problema de Poucas Fotos no Cache

## üîç PROBLEMA IDENTIFICADO:

O cache est√° gerando apenas **27 embeddings para 15 funcion√°rios** (m√©dia de 1.8 fotos por funcion√°rio).

**Esperado:** ~75 embeddings (5 fotos por funcion√°rio)

**Causa prov√°vel:** Funcion√°rios t√™m poucas fotos cadastradas ou fotos est√£o inativas.

---

## üìã TAREFAS:

### **TAREFA 1: Adicionar Comando Flask CLI para Diagn√≥stico**

Criar comando `flask diagnosticar-fotos-faciais` que mostra estat√≠sticas detalhadas.

**Criar arquivo:** `diagnosticar_fotos_cli.py`

```python
#!/usr/bin/env python3
"""
Comando Flask CLI para diagnosticar fotos faciais cadastradas.
Mostra estat√≠sticas detalhadas por funcion√°rio.
"""

import click
from flask.cli import with_appcontext
from app import db
from models import Funcionario, FotoFacialFuncionario
from sqlalchemy import func

@click.command('diagnosticar-fotos-faciais')
@click.option('--admin-id', default=None, type=int, help='ID do tenant (opcional)')
@with_appcontext
def diagnosticar_fotos_faciais(admin_id):
    """
    Diagn√≥stico completo de fotos faciais cadastradas.
    Mostra quantas fotos cada funcion√°rio tem e se est√£o ativas.
    """
    click.echo("üîç DIAGN√ìSTICO DE FOTOS FACIAIS")
    click.echo("=" * 80)
    
    # Filtrar por tenant se fornecido
    query = Funcionario.query.filter(Funcionario.ativo == True)
    if admin_id:
        query = query.filter(Funcionario.admin_id == admin_id)
        click.echo(f"üìä Tenant: admin_id={admin_id}")
    else:
        click.echo(f"üìä Todos os tenants")
    
    funcionarios = query.all()
    click.echo(f"üë• Total de funcion√°rios ativos: {len(funcionarios)}")
    click.echo()
    
    # Estat√≠sticas globais
    total_fotos_multiplas = 0
    total_fotos_ativas = 0
    total_fotos_inativas = 0
    total_com_foto_principal = 0
    total_sem_fotos = 0
    
    # Detalhes por funcion√°rio
    click.echo("üìã DETALHES POR FUNCION√ÅRIO:")
    click.echo("-" * 80)
    
    for func in funcionarios:
        # Contar fotos m√∫ltiplas
        fotos_multiplas = FotoFacialFuncionario.query.filter_by(
            funcionario_id=func.id,
            admin_id=func.admin_id
        ).all()
        
        fotos_ativas = sum(1 for f in fotos_multiplas if f.ativa)
        fotos_inativas = len(fotos_multiplas) - fotos_ativas
        
        # Verificar foto principal
        tem_foto_principal = func.foto_base64 is not None
        
        # Atualizar estat√≠sticas
        total_fotos_multiplas += len(fotos_multiplas)
        total_fotos_ativas += fotos_ativas
        total_fotos_inativas += fotos_inativas
        if tem_foto_principal:
            total_com_foto_principal += 1
        
        # Status
        if fotos_ativas == 0 and not tem_foto_principal:
            status = "‚ùå SEM FOTOS"
            total_sem_fotos += 1
        elif fotos_ativas == 0:
            status = "‚ö†Ô∏è S√ì FOTO PRINCIPAL"
        elif fotos_ativas < 3:
            status = "‚ö†Ô∏è POUCAS FOTOS"
        else:
            status = "‚úÖ OK"
        
        # Exibir
        click.echo(f"{status} | {func.nome[:40]:40} | "
                   f"M√∫ltiplas: {fotos_ativas:2} ativas, {fotos_inativas:2} inativas | "
                   f"Principal: {'‚úì' if tem_foto_principal else '‚úó'}")
    
    # Resumo
    click.echo()
    click.echo("=" * 80)
    click.echo("üìä RESUMO:")
    click.echo(f"  üë• Total de funcion√°rios: {len(funcionarios)}")
    click.echo(f"  üì∏ Total de fotos m√∫ltiplas: {total_fotos_multiplas}")
    click.echo(f"    ‚úÖ Ativas: {total_fotos_ativas}")
    click.echo(f"    ‚ùå Inativas: {total_fotos_inativas}")
    click.echo(f"  üì∑ Funcion√°rios com foto principal: {total_com_foto_principal}")
    click.echo(f"  ‚ùå Funcion√°rios sem fotos: {total_sem_fotos}")
    click.echo()
    
    # M√©dia
    if len(funcionarios) > 0:
        media_fotos = total_fotos_ativas / len(funcionarios)
        click.echo(f"üìä M√âDIA: {media_fotos:.1f} fotos ativas por funcion√°rio")
        
        if media_fotos < 3:
            click.echo()
            click.echo("‚ö†Ô∏è RECOMENDA√á√ÉO:")
            click.echo("  Cadastre pelo menos 3-5 fotos por funcion√°rio para melhor precis√£o!")
            click.echo("  Acesse: /ponto/gerenciar-fotos-faciais")
        elif media_fotos >= 3:
            click.echo("‚úÖ Quantidade de fotos adequada!")
    
    click.echo("=" * 80)
```

**Registrar comando em `app.py`:**

```python
from diagnosticar_fotos_cli import diagnosticar_fotos_faciais

app.cli.add_command(diagnosticar_fotos_faciais)
```

---

### **TAREFA 2: Adicionar Logs Detalhados na Gera√ß√£o do Cache**

Modificar `gerar_cache_facial.py` para mostrar mais informa√ß√µes.

**LOCALIZAR (linha ~109):**

```python
if fotos_multiplas:
    for foto in fotos_multiplas:
        fotos_para_processar.append({
            'foto_base64': foto.foto_base64,
            'descricao': foto.descricao or f'Foto {foto.ordem}'
        })
    logger.info(f"üì∑ {func.nome}: {len(fotos_multiplas)} fotos m√∫ltiplas encontradas")
```

**SUBSTITUIR POR:**

```python
if fotos_multiplas:
    for foto in fotos_multiplas:
        fotos_para_processar.append({
            'foto_base64': foto.foto_base64,
            'descricao': foto.descricao or f'Foto {foto.ordem}'
        })
    # Log detalhado
    fotos_ativas_count = sum(1 for f in fotos_multiplas if f.ativa)
    fotos_inativas_count = len(fotos_multiplas) - fotos_ativas_count
    logger.info(f"üì∑ {func.nome}: {fotos_ativas_count} fotos ativas, {fotos_inativas_count} inativas")
```

---

### **TAREFA 3: Adicionar Op√ß√£o para Processar Fotos Inativas**

Permitir processar fotos inativas temporariamente para testes.

**MODIFICAR fun√ß√£o `gerar_cache()` em `gerar_cache_facial.py`:**

**LOCALIZAR assinatura da fun√ß√£o (linha ~46):**

```python
def gerar_cache(admin_id=None):
```

**SUBSTITUIR POR:**

```python
def gerar_cache(admin_id=None, incluir_inativas=False):
    """
    Gera cache de embeddings faciais para todos os funcion√°rios.
    
    Args:
        admin_id: Se fornecido, gera cache apenas para esse tenant.
        incluir_inativas: Se True, processa tamb√©m fotos marcadas como inativas.
    
    Returns:
        dict: Estat√≠sticas da gera√ß√£o do cache
    """
```

**LOCALIZAR query de fotos (linha ~97):**

```python
fotos_multiplas = FotoFacialFuncionario.query.filter_by(
    funcionario_id=func.id,
    admin_id=func.admin_id,
    ativa=True
).order_by(FotoFacialFuncionario.ordem).all()
```

**SUBSTITUIR POR:**

```python
# Buscar fotos m√∫ltiplas
query_fotos = FotoFacialFuncionario.query.filter_by(
    funcionario_id=func.id,
    admin_id=func.admin_id
)

# Filtrar por ativas apenas se n√£o incluir inativas
if not incluir_inativas:
    query_fotos = query_fotos.filter_by(ativa=True)

fotos_multiplas = query_fotos.order_by(FotoFacialFuncionario.ordem).all()
```

**MODIFICAR rota de API (ponto_views.py, linha ~1620):**

```python
@ponto_bp.route('/api/cache/gerar', methods=['POST'])
@login_required
@admin_required
def gerar_cache_embeddings():
    """API para gerar/regenerar cache de embeddings faciais"""
    try:
        from gerar_cache_facial import gerar_cache, CACHE_PATH
        admin_id = get_tenant_admin_id()
        
        # Op√ß√£o para incluir fotos inativas (via query parameter)
        incluir_inativas = request.args.get('incluir_inativas', 'false').lower() == 'true'
        
        logger.info(f"üîÑ INICIANDO gera√ß√£o de cache facial para admin_id={admin_id}")
        logger.info(f"üìÅ Cache ser√° salvo em: {CACHE_PATH}")
        logger.info(f"üì∏ Incluir fotos inativas: {incluir_inativas}")
        
        resultado = gerar_cache(admin_id, incluir_inativas=incluir_inativas)
        
        # ... resto do c√≥digo
```

---

### **TAREFA 4: Adicionar Bot√£o no Modal de Cache**

Adicionar op√ß√£o para incluir fotos inativas no modal.

**MODIFICAR template que tem o modal de cache:**

**ADICIONAR checkbox:**

```html
<div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="incluirInativas" value="true">
    <label class="form-check-label" for="incluirInativas">
        Incluir fotos inativas (para teste)
    </label>
    <small class="form-text text-muted d-block">
        Use esta op√ß√£o se alguns funcion√°rios t√™m fotos marcadas como inativas.
    </small>
</div>
```

**MODIFICAR JavaScript da gera√ß√£o:**

```javascript
function gerarCache() {
    const incluirInativas = document.getElementById('incluirInativas').checked;
    const url = incluirInativas 
        ? '/ponto/api/cache/gerar?incluir_inativas=true'
        : '/ponto/api/cache/gerar';
    
    fetch(url, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            // ... resto do c√≥digo
        });
}
```

---

### **TAREFA 5: Adicionar Alerta se Poucas Fotos**

Mostrar aviso no modal se funcion√°rios t√™m poucas fotos.

**MODIFICAR rota de status (ponto_views.py, linha ~1700):**

```python
# Calcular m√©dia de fotos
total_fotos = sum(len(data.get('embeddings', [])) for data in embeddings_tenant.values())
media_fotos = total_fotos / len(embeddings_tenant) if len(embeddings_tenant) > 0 else 0

# Adicionar aviso se m√©dia baixa
aviso = None
if media_fotos < 3:
    aviso = {
        'tipo': 'warning',
        'mensagem': f'M√©dia de {media_fotos:.1f} fotos por funcion√°rio. Recomendado: 3-5 fotos para melhor precis√£o.'
    }

return jsonify({
    'disponivel': True,
    # ... outros campos
    'media_fotos': round(media_fotos, 1),
    'aviso': aviso
})
```

**ADICIONAR no template:**

```html
<div id="avisoFotos" class="alert alert-warning" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="avisoFotosTexto"></span>
</div>
```

**ADICIONAR no JavaScript:**

```javascript
if (data.aviso) {
    document.getElementById('avisoFotos').style.display = 'block';
    document.getElementById('avisoFotosTexto').textContent = data.aviso.mensagem;
}
```

---

## üöÄ COMO USAR:

### **PASSO 1: Implementar**
```
Cole o prompt no Replit Agent
‚Üí Ele vai criar o comando de diagn√≥stico
‚Üí Adicionar logs detalhados
‚Üí Adicionar op√ß√£o de incluir inativas
```

### **PASSO 2: Deploy**
```
Commit + Push + Deploy no Easypanel
Restart do servi√ßo
```

### **PASSO 3: Diagnosticar**
```bash
# No terminal do Easypanel:
flask diagnosticar-fotos-faciais --admin-id=2
```

### **PASSO 4: Analisar Resultado**

**Se mostrar:**
```
‚ö†Ô∏è POUCAS FOTOS | Jo√£o Silva | M√∫ltiplas: 1 ativas, 0 inativas | Principal: ‚úì
‚ö†Ô∏è POUCAS FOTOS | Maria Santos | M√∫ltiplas: 2 ativas, 0 inativas | Principal: ‚úì
üìä M√âDIA: 1.8 fotos ativas por funcion√°rio
‚ö†Ô∏è RECOMENDA√á√ÉO: Cadastre pelo menos 3-5 fotos por funcion√°rio
```

**A√ß√£o:** Cadastrar mais fotos via `/ponto/gerenciar-fotos-faciais`

---

**Se mostrar:**
```
‚ö†Ô∏è S√ì FOTO PRINCIPAL | Jo√£o Silva | M√∫ltiplas: 0 ativas, 3 inativas | Principal: ‚úì
```

**A√ß√£o:** Ativar as fotos ou usar op√ß√£o "Incluir fotos inativas"

---

## üìä RESULTADO ESPERADO:

Ap√≥s diagnosticar e corrigir:

```
‚úÖ OK | Jo√£o Silva | M√∫ltiplas: 5 ativas, 0 inativas | Principal: ‚úì
‚úÖ OK | Maria Santos | M√∫ltiplas: 4 ativas, 0 inativas | Principal: ‚úì
...
üìä M√âDIA: 4.5 fotos ativas por funcion√°rio
‚úÖ Quantidade de fotos adequada!
```

**Cache gerado:**
```
‚úÖ 15 funcion√°rios processados
‚úÖ 68 embeddings gerados
‚è±Ô∏è Tempo: ~3 segundos
```

**Reconhecimento:**
```
‚úÖ Match encontrado: dist=0.2513
‚è±Ô∏è TEMPO TOTAL: 0.5s ‚ö°
```

---

**Cole o prompt no Replit Agent e depois execute o diagn√≥stico!** üöÄ
