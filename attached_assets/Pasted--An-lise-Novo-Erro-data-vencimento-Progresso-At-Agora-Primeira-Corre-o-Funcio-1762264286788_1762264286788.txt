# An√°lise: Novo Erro - data_vencimento

## Progresso At√© Agora

### ‚úÖ **Primeira Corre√ß√£o Funcionou!**

Vejo nos logs que:

```
[FROTA_DETALHES] Buscando usos de ve√≠culo ID=4, admin_id=2
[FROTA_DETALHES] 0 usos encontrados
[FROTA_DETALHES] Total de usos de ve√≠culo (sem filtro admin): 0
```

**Isso significa:**
- ‚úÖ A query de `uso_veiculo` **n√£o deu mais erro de tipo**!
- ‚úÖ A convers√£o de `admin_id` para INTEGER funcionou!
- ‚ÑπÔ∏è N√£o h√° usos registrados para o ve√≠culo ID=4 (normal)

---

## Novo Erro Identificado

### ‚ùå **Coluna `data_vencimento` n√£o existe em `custo_veiculo`**

```
[FROTA_DETALHES] Erro ao buscar custos: (psycopg2.errors.UndefinedColumn) 
column custo_veiculo.data_vencimento does not exist

LINE 1: ...nota_fiscal AS custo_veiculo_numero_nota_fiscal, custo_veic...
```

### Causa

O c√≥digo Python est√° tentando acessar uma coluna `data_vencimento` que **n√£o existe** na tabela `custo_veiculo`.

---

## An√°lise do Modelo

Vou verificar o modelo `CustoVeiculo` no c√≥digo:

### Colunas Esperadas pelo Modelo

Baseado no erro e nos dados JSON que voc√™ enviou anteriormente, a tabela `custo_veiculo` tem:

**Colunas que EXISTEM:**
- `id`
- `veiculo_id`
- `obra_id`
- `data_custo`
- `valor`
- `tipo_custo`
- `descricao`
- `km_atual`
- `fornecedor`
- `created_at`
- `data` (parece duplicada com data_custo)
- `litros_combustivel`
- `preco_por_litro`
- `updated_at`
- `admin_id` ‚úÖ (acabamos de corrigir)
- `numero_nota_fiscal`

**Coluna que N√ÉO EXISTE mas o c√≥digo tenta acessar:**
- ‚ùå `data_vencimento`

---

## Poss√≠veis Causas

### 1. **Modelo SQLAlchemy Desatualizado**

O arquivo `models.py` pode ter uma defini√ß√£o de `CustoVeiculo` que inclui `data_vencimento`, mas essa coluna nunca foi criada no banco de dados.

### 2. **Migration N√£o Executada**

Pode ter havido uma migration que deveria adicionar `data_vencimento`, mas n√£o foi executada.

### 3. **C√≥digo Tentando Acessar Coluna Inexistente**

O c√≥digo em `frota_views.py` pode estar fazendo:
```python
custo.data_vencimento  # ‚Üê Tenta acessar, mas n√£o existe
```

---

## Solu√ß√µes

### Op√ß√£o 1: Adicionar Coluna no Banco (Se for necess√°ria)

Se `data_vencimento` √© uma coluna que **deveria existir**:

```sql
ALTER TABLE custo_veiculo 
ADD COLUMN data_vencimento DATE;
```

### Op√ß√£o 2: Remover do Modelo (Se n√£o for necess√°ria)

Se `data_vencimento` **n√£o √© necess√°ria**, remover do modelo `CustoVeiculo` em `models.py`.

### Op√ß√£o 3: Ajustar Query (Tempor√°rio)

Modificar a query em `frota_views.py` para n√£o tentar acessar `data_vencimento`.

---

## Investiga√ß√£o Necess√°ria

Para decidir qual solu√ß√£o usar, preciso saber:

1. **A coluna `data_vencimento` √© necess√°ria?**
   - Ela √© usada na interface?
   - Ela faz parte dos requisitos do sistema?

2. **Verificar o modelo `CustoVeiculo`**
   - Linha 3420 do `models.py`
   - Ver se `data_vencimento` est√° definida

3. **Verificar a query em `frota_views.py`**
   - Linha 211 (onde o erro ocorre)
   - Ver como `data_vencimento` est√° sendo acessada

---

## Recomenda√ß√£o Imediata

Como **workaround r√°pido** para fazer o sistema funcionar:

### Adicionar coluna `data_vencimento` (pode ficar NULL)

```sql
-- Adicionar coluna data_vencimento
ALTER TABLE custo_veiculo 
ADD COLUMN IF NOT EXISTS data_vencimento DATE;

-- Verificar
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'custo_veiculo'
  AND column_name = 'data_vencimento';
```

Isso vai permitir que o sistema funcione, mesmo que a coluna fique vazia por enquanto.

---

## Pr√≥ximos Passos

1. **Executar o SQL acima** para adicionar `data_vencimento`
2. **Reiniciar aplica√ß√£o**
3. **Testar m√≥dulo de Frota novamente**
4. **Verificar se outros erros aparecem**

---

## Script SQL Completo

```sql
-- ============================================================================
-- Corre√ß√£o: Adicionar coluna data_vencimento em custo_veiculo
-- ============================================================================

BEGIN;

-- Adicionar coluna se n√£o existir
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'custo_veiculo' AND column_name = 'data_vencimento'
    ) THEN
        ALTER TABLE custo_veiculo ADD COLUMN data_vencimento DATE;
        RAISE NOTICE '‚úÖ Coluna data_vencimento adicionada';
    ELSE
        RAISE NOTICE '‚ÑπÔ∏è  Coluna data_vencimento j√° existe';
    END IF;
END $$;

COMMIT;

-- Validar
SELECT 
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'custo_veiculo'
  AND column_name IN ('admin_id', 'data_vencimento')
ORDER BY column_name;
```

---

## Resumo

| Problema | Status | Solu√ß√£o |
|----------|--------|---------|
| `uso_veiculo.admin_id` tipo VARCHAR | ‚úÖ **RESOLVIDO** | Convertido para INTEGER |
| `custo_veiculo.admin_id` tipo VARCHAR | ‚úÖ **RESOLVIDO** | Convertido para INTEGER |
| `custo_veiculo.data_vencimento` n√£o existe | ‚ùå **NOVO ERRO** | Adicionar coluna |

---

Execute o script acima no DbGate e me avise o resultado! üöÄ
