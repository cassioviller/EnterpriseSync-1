## Overview
SIGE (Sistema de Gest√£o Empresarial) is a multi-tenant business management system designed for Small and Medium-sized Businesses (SMBs). Its primary purpose is to streamline and automate core business operations including commercial proposal generation, employee management, construction project control (Daily Work Reports - RDO), and automated payroll processing. SIGE aims to enhance efficiency and provide comprehensive operational oversight across the entire business workflow, from sales to on-site project management and financial calculations.

## User Preferences
- Priorizar solu√ß√µes autom√°ticas que funcionem no deploy
- Evitar interven√ß√£o manual no banco de produ√ß√£o
- Implementar logs detalhados para debugging
- Sistema deve ser resiliente a diferen√ßas entre ambientes
- Interface moderna com cards elegantes em vez de listas simples
- Design limpo e profissional com gradientes e anima√ß√µes suaves
- Template unificado em todas as p√°ginas do sistema
- Contraste adequado de texto (valores em preto) para melhor legibilidade
- Prote√ß√£o robusta contra erros de transa√ß√£o de banco de dados
- Scripts automatizados para deploy de corre√ß√µes cr√≠ticas em produ√ß√£o
- C√≥digo de produ√ß√£o limpo, separado de testes para performance otimizada
- Testes dedicados estruturados para valida√ß√£o cont√≠nua dos m√≥dulos consolidados
- Links RDO devem apontar para rota moderna `/funcionario/rdo/consolidado` com funcionalidades completas
- Ambiente de produ√ß√£o com 80 tabelas deve ser preservado durante migra√ß√µes
- Opera√ß√µes destrutivas (exclus√£o) devem usar POST via formul√°rios JavaScript
- Evitar auto-fill de campos que possam interferir em filtros de busca

## System Architecture
The system employs a Flask backend, SQLAlchemy ORM, and a PostgreSQL database. Jinja2 is used for server-side templating and Bootstrap for responsive frontend styling. Docker facilitates deployment. A unified `base_completo.html` template ensures UI/UX consistency.

**Key Architectural Decisions & Features:**
-   **Multi-tenant Architecture:** Data isolation per `admin_id` with robust role-based access control.
-   **Event-Driven Integration System:** Utilizes an `EventManager` (Observer Pattern) for automated cross-module data flow (e.g., material movements impacting costs, payroll triggering accounting).
-   **UI/UX Design:** Modern, responsive layouts with modular components, a cohesive color palette, hierarchical typography, consistent spacing, WCAG accessibility, and Mobile-First Design principles, particularly for modules like RDO.
-   **Automated Database Migrations:** `migrations.py` manages schema updates during application initialization, including critical migrations for multi-tenancy and data integrity:
    -   **Migration 48:** Backfills `admin_id` into 20 core models with tenant-aware strategies and comprehensive post-backfill validations to prevent data leakage and ensure isolation.
    -   **Migration 49:** Adds alert/expiration fields (`data_vencimento_ipva`, `data_vencimento_seguro`) to the `frota_veiculo` table for vehicle maintenance tracking.
    -   **Migration 50:** Ensures complete schema synchronization for `uso_veiculo` table, adding all columns defined in the Python model including passenger tracking and responsibility fields.
    -   **Migration 51:** Ensures complete schema synchronization for `custo_veiculo` table, guaranteeing all payment tracking fields (`data_vencimento`, `status_pagamento`, `forma_pagamento`, `km_veiculo`, `observacoes`) exist with proper foreign keys and indexed queries for performance.
-   **Atomic Transactions:** Critical operations are protected by `safe_db_operation` to ensure data integrity.
-   **Dynamic PDF Generation:** Supports custom headers, dynamic content, and multi-category proposal displays.
-   **Company Customization:** Allows dynamic branding via logo uploads and custom color schemes.
-   **Core Modules:**
    -   **Proposal Management:** Reusable templates, automated calculations, PDF generation, and history tracking.
    -   **Employee Management:** Registration, automated time clocking, and overtime calculations.
    -   **Construction Project Management (RDO):** Daily Work Reports and dynamic service progress. **Route Consolidation (v9.0):** Sistema utiliza blueprint √∫nico `rdo_editar_bp` (rdo_editar_sistema.py) para edi√ß√£o de RDOs, eliminando conflitos de rotas. Rotas legadas em `crud_rdo_completo.py` e `views.py` redirecionam automaticamente para o blueprint oficial, garantindo consist√™ncia. Template: `rdo/editar_rdo.html`. Apenas RDOs em status 'Rascunho' podem ser editados, com valida√ß√£o multi-tenant via admin_id. **Photo Upload System (v9.0):** Sistema completo de upload e gest√£o de fotos para RDOs com interface mobile-first drag-and-drop, otimiza√ß√£o autom√°tica WebP (70% quality, max 1920px), gera√ß√£o de thumbnails 200x200px, storage multi-tenant em `static/uploads/rdo/<admin_id>/<rdo_id>/`, valida√ß√£o robusta (tipos, tamanho 5MB max, 20 fotos/RDO), galeria responsiva com lightbox Bootstrap, edi√ß√£o inline de descri√ß√µes via AJAX, e dele√ß√£o com confirma√ß√£o. Service layer dedicado (`services/rdo_foto_service.py`) orquestra valida√ß√£o, processamento Pillow, e armazenamento. Migration #52 adiciona campos otimizados (arquivo_otimizado, thumbnail, tamanho_bytes, ordem) mantendo backward compatibility. Isolamento multi-tenant garantido via `admin_id` em todas rotas. Corre√ß√µes cr√≠ticas aplicadas: (1) Duplica√ß√£o de relationship `fotos` removida do modelo RDO; (2) Fun√ß√£o `get_admin_id()` corrigida em `rdo_editar_sistema.py` e `crud_rdo_completo.py` para detectar usu√°rios tipo ADMIN (retorna `current_user.id` quando `admin_id` √© NULL); (3) Valida√ß√£o de imagem relaxada para aceitar PNGs sint√©ticos v√°lidos (removido `verify()` rigoroso).
    -   **Payroll (Folha de Pagamento):** Automated calculations including CLT-compliant overtime differentiation (50% and 100% rates) and late deduction processing. PDF holerite generation uses dynamic company data from ConfiguracaoEmpresa (nome_empresa, cnpj, endereco, telefone, email) with conditional rendering for optional fields. Integrates with accounting.
    -   **Costs Management (Custos):** CRUD for construction costs with multi-tenant security, real-time statistics, and a dashboard with KPIs.
    -   **Accounting (Contabilidade):** Double-entry bookkeeping, automatic journal entries from payroll, a chart of accounts, trial balance, and DRE with competency selection. **Automated Payroll Integration (v9.0):** Fully automated accounting entry generation when payroll is processed via event-driven architecture. Event `folha_processada` triggers `criar_lancamento_folha_pagamento` handler that creates journal entries with proper multi-tenant isolation. Structure: DEBIT 5.1.01.001 (Sal√°rios) for total_proventos + fgts, CREDITS to 2.1.02.001 (Sal√°rios a Pagar) for net salary, 2.1.02.002 (INSS a Recolher), 2.1.03.001 (IRRF a Recolher), and 2.1.02.003 (FGTS a Recolher). Chart of accounts includes complete tax structure (2.1.03 IMPOSTOS E TAXAS) with all required accounts seeded automatically.
    -   **Fleet Management System:** Manages vehicles, expenses, and provides TCO dashboards with critical alert notifications. Sistema de sele√ß√£o de passageiros implementado com **modal interativo mobile-friendly**: campos compactos exibem "X selecionados" e abrem modal com checkboxes ao clicar, otimizado para dispositivos m√≥veis com toques simples. Dele√ß√£o em cascata de registros legados (`passageiro_veiculo`) implementada via raw SQL antes da exclus√£o do uso (TODO: migrar para ORM-level cascade quando refatorar modelos). Atualiza√ß√£o autom√°tica de `km_atual` ao criar, editar ou deletar usos.
    -   **Food Management System:** Manages restaurant and food entries, integrates with the financial module to generate accounts payable. Utilizes abordagem h√≠brida para suportar dois modelos (RegistroAlimentacao legado e AlimentacaoLancamento novo) com agrega√ß√£o autom√°tica de dados de ambas as fontes em dashboards, KPIs e gr√°ficos.
    -   **Warehouse Management (Almoxarifado):** Manages materials, tools, and PPE with traceability.
    -   **Shared Device Time Clock System (Ponto Eletr√¥nico):** Mobile-first time clock with GPS tracking. **Sistema de importa√ß√£o via Excel** permite importar registros de ponto em lote com planilha modelo gerada automaticamente (uma aba por funcion√°rio ativo), valida√ß√£o robusta de formatos de data/hora, tratamento de duplicatas (atualiza registros existentes), importa√ß√£o parcial com relat√≥rio detalhado de erros, e interface drag-and-drop moderna. **Seletor de compet√™ncia** permite escolher m√™s/ano espec√≠fico ao baixar o modelo (input type="month" mobile-friendly), com valida√ß√£o autom√°tica que impede sele√ß√£o de meses futuros e nome de arquivo din√¢mico refletindo a compet√™ncia escolhida (ex: modelo_ponto_202410.xlsx). **Planilha Excel aprimorada v4.0** inclui: (1) Aba de Legenda/Dicion√°rio com 11 tipos de registro (TRAB, FALTA, SAB_TRAB, DOM_TRAB, etc) e instru√ß√µes detalhadas; (2) Se√ß√£o "üèóÔ∏è OBRAS DISPON√çVEIS" na legenda listando todas as obras ativas (ID, Nome, Cliente) para refer√™ncia; (3) **Exibi√ß√£o do hor√°rio padr√£o do funcion√°rio** (entrada e sa√≠da) buscado de `HorarioTrabalho`; (4) Dropdown de valida√ß√£o de dados na coluna "Tipo" para sele√ß√£o facilitada; (5) Coluna "Obra ID" com dropdown vinculado √†s obras ativas, permitindo associar registros de ponto a projetos espec√≠ficos; (6) **Colunas calculadas automaticamente**: "Min. Atraso" (coluna H) calcula minutos de atraso quando entrada > hor√°rio padr√£o, e "Min. HE" (coluna I) calcula minutos de horas extras quando sa√≠da > hor√°rio padr√£o, usando f√≥rmulas Excel com valores de tempo reais armazenados em c√©lulas ocultas (Z1/Z2); (7) Se√ß√£o de KPIs autom√°ticos com 10 indicadores calculados por f√≥rmulas Excel: dias trabalhados, faltas, faltas justificadas, horas extras 50%, horas extras 100%, f√©rias, **total minutos de atraso**, **total minutos de horas extras**, **horas extras (HH:MM)**, e **atrasos (HH:MM)** que atualizam em tempo real; (8) Suporte a tipos especiais sem hor√°rios (faltas, folgas, f√©rias, atestados); (9) Importa√ß√£o salva obra_id no banco (campo nullable) para rastreamento de trabalho por projeto.
-   **Automated Database Error Diagnostics:** Includes a `DatabaseDiagnostics` system (`utils/database_diagnostics.py`) to analyze SQLAlchemy errors, report missing columns, and generate diagnostic reports. This system is integrated into views with `@capture_db_errors` decorators to provide user-friendly error messages and fallback mechanisms, particularly crucial for ensuring system functionality even when core migrations (like Migration 48) are pending in production. This diagnostic system includes a dedicated admin panel and pre/post-migration scripts for robust deployment.
-   **H√≠brido Data Model Support:** Sistema de alimenta√ß√£o utiliza l√≥gica h√≠brida para ler dados de dois modelos simultaneamente (RegistroAlimentacao legado com campo `valor` e AlimentacaoLancamento novo com campo `valor_total`), permitindo coexist√™ncia de dados hist√≥ricos e novos lan√ßamentos. Implementado em `alimentacao_views.py` com agrega√ß√£o em Python de queries separadas, mantendo filtros multi-tenant e preservando formato compat√≠vel com templates existentes.
-   **Transaction Isolation for Deletions:** Opera√ß√µes de exclus√£o cr√≠ticas (ex: obras com 38 depend√™ncias) utilizam conex√µes RAW com `isolation_level="AUTOCOMMIT"` para prevenir erros "InFailedSqlTransaction" ao executar m√∫ltiplos DELETEs consecutivos. Schema √© introspectado via `information_schema.columns` para determinar quais tabelas dependentes possuem `admin_id` antes de aplicar filtros multi-tenant.

## External Dependencies
-   **Flask:** Web framework.
-   **SQLAlchemy:** Object Relational Mapper (ORM).
-   **PostgreSQL:** Relational database management system.
-   **Bootstrap:** Frontend framework for responsive design.
-   **Jinja2:** Python templating language.
-   **Docker:** Platform for developing, shipping, and running applications in containers.
-   **Sortable.js:** JavaScript library for drag-and-drop functionality.
-   **python-dateutil:** Provides extensions to the standard datetime module.